<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.14" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.49" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://hanekawa.top/document/node-doc/Web%20Streams%20API.html"><meta property="og:site_name" content="hanekawa-shiki"><meta property="og:title" content="Web Streams API"><meta property="og:description" content="Web Streams API Node.js çš„ Web Streams API æ˜¯ä¸€ç§ç”¨äºå¤„ç†æµå¼æ•°æ®çš„ç¼–ç¨‹æ¥å£ã€‚è¿™æ„å‘³ç€æ•°æ®å¯ä»¥ä¸€å—ä¸€å—åœ°å‘é€å’Œæ¥æ”¶ï¼Œè€Œä¸å¿…ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å¯ç”¨ã€‚è¿™å¯¹äºå¤„ç†å¤§é‡æ•°æ®æˆ–å®æ—¶æ•°æ®éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå…è®¸åº”ç”¨ç¨‹åºå¼€å§‹å¤„ç†æ•°æ®ç‰‡æ®µï¼Œè€Œä¸æ˜¯ç­‰å¾…æ•´ä¸ªæ•°æ®é›†ã€‚ åœ¨è¯¦ç»†è§£é‡Šä¹‹å‰ï¼Œå…ˆäº†è§£å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š Streamï¼ˆæµï¼‰ï¼šæ•°æ®çš„ä¸€ä¸ªè¿ç»­åº..."><meta property="og:type" content="website"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-06-21T09:46:17.000Z"><meta property="article:author" content="hanekawa-shiki"><meta property="article:modified_time" content="2024-06-21T09:46:17.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"WebPage","name":"Web Streams API","description":"Web Streams API Node.js çš„ Web Streams API æ˜¯ä¸€ç§ç”¨äºå¤„ç†æµå¼æ•°æ®çš„ç¼–ç¨‹æ¥å£ã€‚è¿™æ„å‘³ç€æ•°æ®å¯ä»¥ä¸€å—ä¸€å—åœ°å‘é€å’Œæ¥æ”¶ï¼Œè€Œä¸å¿…ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å¯ç”¨ã€‚è¿™å¯¹äºå¤„ç†å¤§é‡æ•°æ®æˆ–å®æ—¶æ•°æ®éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå…è®¸åº”ç”¨ç¨‹åºå¼€å§‹å¤„ç†æ•°æ®ç‰‡æ®µï¼Œè€Œä¸æ˜¯ç­‰å¾…æ•´ä¸ªæ•°æ®é›†ã€‚ åœ¨è¯¦ç»†è§£é‡Šä¹‹å‰ï¼Œå…ˆäº†è§£å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š Streamï¼ˆæµï¼‰ï¼šæ•°æ®çš„ä¸€ä¸ªè¿ç»­åº..."}</script><meta name="keywords" content="JavaScript,HTML,CSS"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/assets/icons/chrome-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/assets/icons/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icons/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/assets/icons/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#5c92d1"><link rel="apple-touch-icon" href="/assets/icons/apple-touch-icon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="white"><meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><title>Web Streams API | hanekawa-shiki</title><meta name="description" content="Web Streams API Node.js çš„ Web Streams API æ˜¯ä¸€ç§ç”¨äºå¤„ç†æµå¼æ•°æ®çš„ç¼–ç¨‹æ¥å£ã€‚è¿™æ„å‘³ç€æ•°æ®å¯ä»¥ä¸€å—ä¸€å—åœ°å‘é€å’Œæ¥æ”¶ï¼Œè€Œä¸å¿…ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å¯ç”¨ã€‚è¿™å¯¹äºå¤„ç†å¤§é‡æ•°æ®æˆ–å®æ—¶æ•°æ®éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå…è®¸åº”ç”¨ç¨‹åºå¼€å§‹å¤„ç†æ•°æ®ç‰‡æ®µï¼Œè€Œä¸æ˜¯ç­‰å¾…æ•´ä¸ªæ•°æ®é›†ã€‚ åœ¨è¯¦ç»†è§£é‡Šä¹‹å‰ï¼Œå…ˆäº†è§£å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š Streamï¼ˆæµï¼‰ï¼šæ•°æ®çš„ä¸€ä¸ªè¿ç»­åº...">
    <link rel="stylesheet" href="/assets/css/styles.a84c0532.css">
    <link rel="preload" href="/assets/js/runtime~app.b7c0d7f2.js" as="script"><link rel="preload" href="/assets/css/styles.a84c0532.css" as="style"><link rel="preload" href="/assets/js/4485.d2710361.js" as="script"><link rel="preload" href="/assets/js/app.ed12edd2.js" as="script">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo light" src="/assets/svg/logo.svg" alt><img class="vp-nav-logo dark" src="/assets/svg/logo.svg" alt><span class="vp-site-name hide-in-pad">hanekawa-shiki</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="åšå®¢ä¸»é¡µ"><!--[--><span class="font-icon icon home" style=""></span><!--]-->åšå®¢ä¸»é¡µ<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="å­¦ä¹ ç¬”è®°"><!--[--><span class="font-icon icon framework" style=""></span>å­¦ä¹ ç¬”è®°<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">å‰ç«¯æ¡†æ¶</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/framework_front/vue3/" aria-label="Vue3ç¬”è®°"><!--[--><span class="font-icon icon vue" style=""></span><!--]-->Vue3ç¬”è®°<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/framework_front/react/" aria-label="Reactç¬”è®°"><!--[--><span class="font-icon icon react" style=""></span><!--]-->Reactç¬”è®°<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="æ–‡æ¡£"><!--[--><span class="font-icon icon framework" style=""></span>æ–‡æ¡£<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">æ¬è¿</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link route-link-active auto-link" href="/document/node-doc/" aria-label="Node.jsæ–‡æ¡£"><!--[--><span class="font-icon icon circle-info" style=""></span><!--]-->Node.jsæ–‡æ¡£<!----></a></li></ul></li></ul></button></div></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/hanekawa-shiki/hanekawa-shiki.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/" aria-label="Node.jsæ–‡æ¡£"><!--[--><span class="font-icon icon circle-info" style=""></span><!--]-->Node.jsæ–‡æ¡£<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Assert.html" aria-label="Assert"><!---->Assert<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Async%20hooks.html" aria-label="Async hooks"><!---->Async hooks<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Asynchronous%20context%20tracking.html" aria-label="Asynchronous context tracking"><!---->Asynchronous context tracking<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Buffer.html" aria-label="Buffer"><!---->Buffer<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/C__%20addons.html" aria-label="C++ addons"><!---->C++ addons<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/C__%20embedder%20API.html" aria-label="C++ embedder API"><!---->C++ embedder API<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Child%20process.html" aria-label="Child process"><!---->Child process<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Cluster.html" aria-label="Cluster"><!---->Cluster<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Command-line%20API.html" aria-label="Command-line API"><!---->Command-line API<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Console.html" aria-label="Console"><!---->Console<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Corepack.html" aria-label="Corepack"><!---->Corepack<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Crypto.html" aria-label="Crypto"><!---->Crypto<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Debugger.html" aria-label="Debugger"><!---->Debugger<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Deprecated%20APIs.html" aria-label="Deprecated APIs"><!---->Deprecated APIs<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Diagnostic%20report.html" aria-label="Diagnostic report"><!---->Diagnostic report<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Diagnostics%20Channel.html" aria-label="Diagnostics Channel"><!---->Diagnostics Channel<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/DNS.html" aria-label="DNS"><!---->DNS<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Domain.html" aria-label="Domain"><!---->Domain<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Errors.html" aria-label="Errors"><!---->Errors<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Events.html" aria-label="Events"><!---->Events<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/File%20system.html" aria-label="File system"><!---->File system<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Global%20objects.html" aria-label="Global objects"><!---->Global objects<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/HTTP.html" aria-label="HTTP"><!---->HTTP<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/HTTPS.html" aria-label="HTTPS"><!---->HTTPS<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Inspector.html" aria-label="Inspector"><!---->Inspector<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Internationalization%20support.html" aria-label="Internationalization support"><!---->Internationalization support<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Modules_%20CommonJS%20modules.html" aria-label="Modules: CommonJS modules"><!---->Modules: CommonJS modules<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Modules_%20ECMAScript%20modules.html" aria-label="Modules: ECMAScript modules"><!---->Modules: ECMAScript modules<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Modules_%20node_module%20API.html" aria-label="Modules: node:module API"><!---->Modules: node:module API<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Modules_%20Packages.html" aria-label="Modules: Packages"><!---->Modules: Packages<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Net.html" aria-label="Net"><!---->Net<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Node-API.html" aria-label="Node-API"><!---->Node-API<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/OS.html" aria-label="OS"><!---->OS<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Path.html" aria-label="Path"><!---->Path<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Performance%20measurement%20APIs.html" aria-label="Performance measurement APIs"><!---->Performance measurement APIs<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Permissions.html" aria-label="Permissions"><!---->Permissions<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Process.html" aria-label="Process"><!---->Process<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Punycode.html" aria-label="Punycode"><!---->Punycode<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Query%20string.html" aria-label="Query string"><!---->Query string<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Readline.html" aria-label="Readline"><!---->Readline<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/REPL.html" aria-label="REPL"><!---->REPL<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Stream.html" aria-label="Stream"><!---->Stream<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/String%20decoder.html" aria-label="String decoder"><!---->String decoder<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Test%20runner.html" aria-label="Test runner"><!---->Test runner<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Timers.html" aria-label="Timers"><!---->Timers<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/TLS%20(SSL).html" aria-label="TLS (SSL)"><!---->TLS (SSL)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Trace%20events.html" aria-label="Trace events"><!---->Trace events<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/TTY.html" aria-label="TTY"><!---->TTY<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/URL.html" aria-label="URL"><!---->URL<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Util.html" aria-label="Util"><!---->Util<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/V8.html" aria-label="V8"><!---->V8<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/VM%20(executing%20JavaScript).html" aria-label="VM (executing JavaScript)"><!---->VM (executing JavaScript)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Web%20Crypto%20API.html" aria-label="Web Crypto API"><!---->Web Crypto API<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/document/node-doc/Web%20Streams%20API.html" aria-label="Web Streams API"><!---->Web Streams API<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/WebAssembly%20System%20Interface%20(WASI).html" aria-label="WebAssembly System Interface (WASI)"><!---->WebAssembly System Interface (WASI)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Worker%20threads.html" aria-label="Worker threads"><!---->Worker threads<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Zlib.html" aria-label="Zlib"><!---->Zlib<!----></a></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Web Streams API</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://hanekawa.top" target="_blank" rel="noopener noreferrer">hanekawa-shiki</a></span><span property="author" content="hanekawa-shiki"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-06-21T09:46:17.000Z"></span><!----><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 250 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT250M"></span><span class="page-word-info" aria-label="å­—æ•°ğŸ” " data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon" name="word"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>çº¦ 75068 å­—</span><meta property="wordCount" content="75068"></span><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#overview">Overview</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestream-å¯è¯»æµ">ReadableStreamï¼ˆå¯è¯»æµï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#writablestream-å¯å†™æµ">WritableStreamï¼ˆå¯å†™æµï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#transformstream-è½¬æ¢æµ">TransformStreamï¼ˆè½¬æ¢æµï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#example-readablestream">Example ReadableStream</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#api">API</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#web-streams-api-çš„å®é™…åº”ç”¨ä¾‹å­">Web Streams API çš„å®é™…åº”ç”¨ä¾‹å­ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-readablestream">Class: ReadableStream</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯æµ-stream">ä»€ä¹ˆæ˜¯æµï¼ˆStreamï¼‰ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestream-åŸºæœ¬æ¦‚å¿µ">ReadableStream åŸºæœ¬æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-1">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ„é€ å‡½æ•°-new-readablestream-underlyingsource-strategy">æ„é€ å‡½æ•°ï¼šnew ReadableStream([underlyingSource [, strategy]])</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-1">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€æ¦‚å¿µ">åŸºç¡€æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestream-locked-1">readableStream.locked</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­">å®é™…ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‚æ•°">å‚æ•°</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è¿”å›å€¼">è¿”å›å€¼</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ä¾‹å­">å®é™…åº”ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æµ-streams-æ˜¯ä»€ä¹ˆ">æµï¼ˆStreamsï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestream-getreader-options-1">readableStream.getReader([options])</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹åº”ç”¨åœºæ™¯">ç¤ºä¾‹åº”ç”¨åœºæ™¯</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€æ¦‚å¿µ-1">åŸºç¡€æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestream-pipethrough-transform-options-1">readableStream.pipeThrough(transform[, options])</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®šä¹‰">å®šä¹‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‚æ•°-3">å‚æ•°</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹">ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestream-tee-1">readableStream.tee()</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åº”ç”¨åœºæ™¯å’Œä¾‹å­">åº”ç”¨åœºæ™¯å’Œä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹ä»£ç -1">ç¤ºä¾‹ä»£ç </a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#streams-ç®€ä»‹">Streams ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestream-values-options-1">readableStream.values([options])</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¼‚æ­¥è¿­ä»£åŸºç¡€">å¼‚æ­¥è¿­ä»£åŸºç¡€</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯æµ-streams">ä»€ä¹ˆæ˜¯æµï¼ˆStreamsï¼‰ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#async-iteration-å¦‚ä½•å·¥ä½œ">Async Iteration å¦‚ä½•å·¥ä½œï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-2">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-1">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ç¤ºä¾‹">å®é™…åº”ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»£ç ç¤ºä¾‹-1">ä»£ç ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestream-from-iterable">ReadableStream.from(iterable)</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­">å®é™…è¿ç”¨çš„ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-readablestreamdefaultreader">Class: ReadableStreamDefaultReader</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestreamdefaultreader-ç®€ä»‹">ReadableStreamDefaultReader ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åˆ›å»º-readablestreamdefaultreader">åˆ›å»º ReadableStreamDefaultReader</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨-readablestreamdefaultreader">ä½¿ç”¨ ReadableStreamDefaultReader</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-3">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯-readablestreamdefaultreader">ä»€ä¹ˆæ˜¯ ReadableStreamDefaultReaderï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¦‚ä½•ä½¿ç”¨-new-readablestreamdefaultreader-stream">å¦‚ä½•ä½¿ç”¨ new ReadableStreamDefaultReader(stream)?</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-1">å®é™…è¿ç”¨çš„ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-2">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¯è¯»æµ-readable-streams-çš„æ¯”å–»">å¯è¯»æµï¼ˆReadable Streamsï¼‰çš„æ¯”å–»</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestreamdefaultreader-cancel-reason-è¯¦è§£">readableStreamDefaultReader.cancel([reason])è¯¦è§£</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ç¤ºä¾‹-1">å®é™…åº”ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å°ç»“">å°ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯æµ-stream-1">ä»€ä¹ˆæ˜¯æµï¼ˆStreamï¼‰ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestream-å’Œ-readablestreamdefaultreader">ReadableStream å’Œ ReadableStreamDefaultReader</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestreamdefaultreader-closed-1">readableStreamDefaultReader.closed</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­-1">å®é™…ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºæœ¬æ¦‚å¿µ-1">åŸºæœ¬æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestreamdefaultreader-read-1">readableStreamDefaultReader.read()</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¾‹å­-1">ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-3">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestreamdefaultreader-releaselock-1">readableStreamDefaultReader.releaseLock()</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-readablestreambyobreader">Class: ReadableStreamBYOBReader</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€æ¦‚å¿µ-2">åŸºç¡€æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestreambyobreader-è¯¦è§£">ReadableStreamBYOBReader è¯¦è§£</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­-2">å®é™…ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€çŸ¥è¯†">åŸºç¡€çŸ¥è¯†</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestreambyobreader-è¯¦è§£-1">ReadableStreamBYOBReader è¯¦è§£</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºæœ¬æ¦‚å¿µ-2">åŸºæœ¬æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestreambyobreader-cancel-reason-1">readableStreamBYOBReader.cancel([reason])</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-4">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#streams-æµ">Streamsï¼ˆæµï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#buffer">Buffer</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#byobreader-bring-your-own-buffer-reader">BYOBReader - Bring Your Own Buffer Reader</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestreambyobreader-closed-1">readableStreamBYOBReader.closed</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å…³é”®æ¦‚å¿µ">å…³é”®æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestreambyobreader-read-view-options-è¯¦è§£">readableStreamBYOBReader.read(view[, options])è¯¦è§£</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-4">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ç¤ºä¾‹-2">å®é™…åº”ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-readablestreamdefaultcontroller">Class: ReadableStreamDefaultController</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ ¸å¿ƒåŠŸèƒ½">æ ¸å¿ƒåŠŸèƒ½</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-5">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestreamdefaultcontroller-close-1">readableStreamDefaultController.close()</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»£ç ç¤ºä¾‹-3">ä»£ç ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æµ-streams">æµï¼ˆStreamsï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¯è¯»æµ-readable-streams">å¯è¯»æµï¼ˆReadable Streamsï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æµæ§åˆ¶å™¨-stream-controllers">æµæ§åˆ¶å™¨ï¼ˆStream Controllersï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestreamdefaultcontroller-desiredsize-1">readableStreamDefaultController.desiredSize</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æµ-streams-ç®€ä»‹">æµ(Streams)ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestream-ä¸-readablestreamdefaultcontroller">ReadableStream ä¸ ReadableStreamDefaultController</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestreamdefaultcontroller-enqueue-chunk-1">readableStreamDefaultController.enqueue([chunk])</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-6">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç»“è®º">ç»“è®º</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-readablebytestreamcontroller">Class: ReadableByteStreamController</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯-web-streams-api">ä»€ä¹ˆæ˜¯ Web Streams APIï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablebytestreamcontroller-æ˜¯ä»€ä¹ˆ">ReadableByteStreamController æ˜¯ä»€ä¹ˆï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-6">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¦‚ä½•ä½¿ç”¨">å¦‚ä½•ä½¿ç”¨ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#streams-æµ-1">Streamsï¼ˆæµï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#byob-bring-your-own-buffer">BYOBï¼ˆBring Your Own Bufferï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablebytestreamcontroller">ReadableByteStreamController</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablebytestreamcontroller-byobrequest-1">readableByteStreamController.byobRequest</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-8">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯readablebytestreamcontroller">ä»€ä¹ˆæ˜¯readableByteStreamControllerï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#desiredsizeçš„ä½œç”¨">desiredSizeçš„ä½œç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-9">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€æ¦‚å¿µ-3">åŸºç¡€æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablebytestreamcontroller-enqueue-chunk-1">readableByteStreamController.enqueue(chunk)</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åº”ç”¨ä¾‹å­">åº”ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨åœºæ™¯åŠç¤ºä¾‹">ä½¿ç”¨åœºæ™¯åŠç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-readablestreambyobrequest">Class: ReadableStreamBYOBRequest</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#readablestreambyobrequest">ReadableStreamBYOBRequest</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç»“è®º-1">ç»“è®º</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-10">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯-readablestreambyobrequest-respondwithnewview-view">ä»€ä¹ˆæ˜¯ ReadableStreamBYOBRequest.respondWithNewView(view)?</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‚æ•°è§£é‡Š-1">å‚æ•°è§£é‡Š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-11">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-writablestream">Class: WritableStream</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯-writablestream">ä»€ä¹ˆæ˜¯ WritableStreamï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¦‚ä½•ä½¿ç”¨-writablestream">å¦‚ä½•ä½¿ç”¨ WritableStreamï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ä¾‹å­-2">å®é™…åº”ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-5">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€æ¦‚å¿µ-4">åŸºç¡€æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å…³äº-writablestream-close">å…³äº writableStream.close()</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-2">å®é™…è¿ç”¨çš„ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-6">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æµ-streams-1">æµ (Streams)</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#writable-streams">Writable Streams</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#getwriter-æ–¹æ³•">getWriter() æ–¹æ³•</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€æ¦‚å¿µ-5">åŸºç¡€æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#writablestream-locked-1">writableStream.locked</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­-5">å®é™…ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-7">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-13">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-writablestreamdefaultwriter">Class: WritableStreamDefaultWriter</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æµ-stream">æµï¼ˆStreamï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#web-streams-api-1">Web Streams API</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#writablestreamdefaultwriter-ç±»">WritableStreamDefaultWriter ç±»</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºæœ¬æ¦‚å¿µ-3">åŸºæœ¬æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#writablestreamdefaultwriterç®€ä»‹">WritableStreamDefaultWriterç®€ä»‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨å®ä¾‹">ä½¿ç”¨å®ä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åº”ç”¨åœºæ™¯">åº”ç”¨åœºæ™¯</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ¦‚å¿µç†è§£">æ¦‚å¿µç†è§£</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­-6">å®é™…ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-8">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#writablestreamdefaultwriter-close-1">writableStreamDefaultWriter.close()</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#writablestreamdefaultwriter-closed-1">writableStreamDefaultWriter.closed</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-8">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è§£é‡Š-desiredsize">è§£é‡Š desiredSize</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-9">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€æ¦‚å¿µ-6">åŸºç¡€æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#writablestreamdefaultwriter-ready-1">writableStreamDefaultWriter.ready</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-9">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-10">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#node-js-ç®€ä»‹">Node.js ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#streams-ä»‹ç»">Streams ä»‹ç»</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#writablestreamdefaultwriter-ç®€ä»‹">WritableStreamDefaultWriter ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#write-chunk-æ–¹æ³•">write([chunk]) æ–¹æ³•</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-11">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-writablestreamdefaultcontroller">Class: WritableStreamDefaultController</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æµ-streams-å’Œ-web-streams-api">æµ(Streams) å’Œ Web Streams API</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#writable-streams-2">Writable Streams</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#writablestreamdefaultcontroller">WritableStreamDefaultController</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-16">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æµ-stream-1">æµï¼ˆStreamï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ§åˆ¶å™¨-controller">æ§åˆ¶å™¨ï¼ˆControllerï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¯å†™æµ-writable-stream">å¯å†™æµï¼ˆWritable Streamï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-3">å®é™…è¿ç”¨çš„ä¾‹å­ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_1-streams-æµ">1. Streamsï¼ˆæµï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-writable-streams-å¯å†™æµ">2. Writable Streamsï¼ˆå¯å†™æµï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-abortsignal">3. AbortSignal</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-controllers-æ§åˆ¶å™¨-å’Œ-writablestreamdefaultcontroller-signal">4. Controllersï¼ˆæ§åˆ¶å™¨ï¼‰ å’Œ writableStreamDefaultController.signal</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­-7">å®é™…ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-transformstream">Class: TransformStream</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯æµ-stream-2">ä»€ä¹ˆæ˜¯æµï¼ˆStreamï¼‰ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#transformstream-åŸºæœ¬æ¦‚å¿µ">TransformStream åŸºæœ¬æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åˆ›å»º-transformstream">åˆ›å»º TransformStream</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-17">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#transformstream-ç®€ä»‹">TransformStream ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‚æ•°è§£é‡Š-2">å‚æ•°è§£é‡Š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-12">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æµ-streams-åŸºæœ¬æ¦‚å¿µ">æµ(Streams)åŸºæœ¬æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#transformstream">TransformStream</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#transformstream-readable-1">transformStream.readable</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-13">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€çŸ¥è¯†-1">åŸºç¡€çŸ¥è¯†</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#transformstream-writable-1">TransformStream.writable</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ä¾‹å­-3">å®é™…åº”ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç»“è®º-2">ç»“è®º</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#postmessage-åœ¨-web-streams-ä¸­çš„åº”ç”¨">postMessage() åœ¨ Web Streams ä¸­çš„åº”ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-transformstreamdefaultcontroller">Class: TransformStreamDefaultController</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºæœ¬æ¦‚å¿µ-4">åŸºæœ¬æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#transformstreamdefaultcontroller">TransformStreamDefaultController</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºæœ¬æ¦‚å¿µ-5">åŸºæœ¬æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#transformstreamdefaultcontroller-desiredsize-1">transformStreamDefaultController.desiredSize</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-14">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºæœ¬æ¦‚å¿µ-6">åŸºæœ¬æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#transformstreamdefaultcontroller-enqueue-chunk-1">transformStreamDefaultController.enqueue([chunk])</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€æ¦‚å¿µ-7">åŸºç¡€æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#transformstreamdefaultcontroller-error-reason-1">transformStreamDefaultController.error([reason])</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ä¾‹å­-4">å®é™…åº”ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-10">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#node-js-ç®€ä»‹-1">Node.js ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#streams-ç®€ä»‹-1">Streams ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#transform-streams">Transform Streams</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#transformstreamdefaultcontroller-terminate-1">transformStreamDefaultController.terminate()</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-bytelengthqueuingstrategy">Class: ByteLengthQueuingStrategy</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æµ-streams-çš„æ¦‚å¿µ">æµï¼ˆStreamsï¼‰çš„æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¸ºä»€ä¹ˆéœ€è¦-bytelengthqueuingstrategy">ä¸ºä»€ä¹ˆéœ€è¦ ByteLengthQueuingStrategy</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¦‚ä½•å·¥ä½œ">å¦‚ä½•å·¥ä½œ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-4">å®é™…è¿ç”¨çš„ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»£ç ç¤ºä¾‹-4">ä»£ç ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç†è§£-bytelengthqueuingstrategy">ç†è§£ ByteLengthQueuingStrategy</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹-1">ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¦‚ä½•ä½¿ç”¨-1">å¦‚ä½•ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å°ç»“-1">å°ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€æ¦‚å¿µ-8">åŸºç¡€æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#bytelengthqueuingstrategy-highwatermark-1">byteLengthQueuingStrategy.highWaterMark</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-5">å®é™…è¿ç”¨çš„ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯-stream">ä»€ä¹ˆæ˜¯ Streamï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#queuing-strategy-é˜Ÿåˆ—ç­–ç•¥">Queuing Strategyï¼ˆé˜Ÿåˆ—ç­–ç•¥ï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#bytelengthqueuingstrategy">byteLengthQueuingStrategy</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#bytelengthqueuingstrategy-size-1">byteLengthQueuingStrategy.size</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-18">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-countqueuingstrategy">Class: CountQueuingStrategy</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æµ-streams-ä¸èƒŒå‹-backpressure">æµ(Streams)ä¸èƒŒå‹(Backpressure)</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#countqueuingstrategy">CountQueuingStrategy</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ„å»º-countqueuingstrategy">æ„å»º CountQueuingStrategy</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ä¾‹å­-5">å®é™…åº”ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-11">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æµä¸èƒŒå‹">æµä¸èƒŒå‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#countqueuingstrategy-1">CountQueuingStrategy</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#web-streams-å’Œ-countqueuingstrategy-size">Web Streams å’Œ CountQueuingStrategy.size</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-19">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-12">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-textencoderstream">Class: TextEncoderStream</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€æ¦‚å¿µ-9">åŸºç¡€æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#textencoderstream">TextEncoderStream</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹ä»£ç -3">ç¤ºä¾‹ä»£ç </a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ç¤ºä¾‹-3">å®é™…åº”ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#textencoderstream-1">TextEncoderStream</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#encoding">encoding</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-20">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºæœ¬æ¦‚å¿µ-7">åŸºæœ¬æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#textencoderstream-readable-1">TextEncoderStream.readable</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ç¤ºä¾‹-4">å®é™…åº”ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€æ¦‚å¿µ-10">åŸºç¡€æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#textencoderstream-writable-1">textEncoderStream.writable</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ä¾‹å­-6">å®é™…åº”ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-textdecoderstream">Class: TextDecoderStream</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€æ¦‚å¿µ-11">åŸºç¡€æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#textdecoderstream-è¯¦è§£">TextDecoderStream è¯¦è§£</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ä¸¾ä¾‹">å®é™…åº”ç”¨ä¸¾ä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-13">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€æ¦‚å¿µ-12">åŸºç¡€æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#textdecoderstream-ä»‹ç»">TextDecoderStream ä»‹ç»</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#textdecoderstream-encoding-1">TextDecoderStream.encoding</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-6">å®é™…è¿ç”¨çš„ä¾‹å­ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å°ç»“-2">å°ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-16">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è§£é‡Š-textdecoderstream-readable">è§£é‡Š textDecoderStream.readable</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ç¤ºä¾‹-5">å®é™…åº”ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç»“è®º-3">ç»“è®º</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€æ¦‚å¿µ-13">åŸºç¡€æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#textdecoderstream-writable-1">textDecoderStream.writable</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-22">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-compressionstream">Class: CompressionStream</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºæœ¬æ¦‚å¿µ-8">åŸºæœ¬æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨-2">å®é™…è¿ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-15">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯new-compressionstream-format">ä»€ä¹ˆæ˜¯new CompressionStream(format)?</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-17">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-16">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#compressionstream-readable-1">CompressionStream.readable</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¸¾ä¾‹è¯´æ˜">ä¸¾ä¾‹è¯´æ˜</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€çŸ¥è¯†-2">åŸºç¡€çŸ¥è¯†</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#compressionstream-writable-1">CompressionStream.writable</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-23">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#class-decompressionstream">Class: DecompressionStream</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ä¾‹å­-7">å®é™…åº”ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-17">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯æµ-streams-2">ä»€ä¹ˆæ˜¯æµï¼ˆStreamsï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#decompressionstream-ä»‹ç»">DecompressionStream ä»‹ç»</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-7">å®é™…è¿ç”¨çš„ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-18">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æµ-streams-2">æµ(Streams)</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‹ç¼©ä¸è§£å‹ç¼©">å‹ç¼©ä¸è§£å‹ç¼©</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è§£å‹ç¼©æµ-decompressionstream">è§£å‹ç¼©æµ(DecompressionStream)</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#decompressionstream-readable-1">decompressionStream.readable</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#web-streams-api-2">Web Streams API</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#decompression-stream">Decompression Stream</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#decompressionstream-writable-1">decompressionStream.writable</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ç¤ºä¾‹-6">å®é™…åº”ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#utility-consumers">Utility Consumers</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#utility-consumers-çš„ç§ç±»">Utility Consumers çš„ç§ç±»</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-19">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€æ¦‚å¿µ-14">åŸºç¡€æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#streamconsumers-arraybuffer-stream-1">streamConsumers.arrayBuffer(stream)</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨åœºæ™¯">å®é™…åº”ç”¨åœºæ™¯</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-18">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯-stream-1">ä»€ä¹ˆæ˜¯ Streamï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#streamconsumers-buffer-stream-1">streamConsumers.buffer(stream)</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ç¤ºä¾‹-7">å®é™…åº”ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-20">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºç¡€æ¦‚å¿µ-15">åŸºç¡€æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#streamconsumers-json-stream-1">streamConsumers.json(stream)</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-19">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å°ç»“-3">å°ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#node-js-ç®€ä»‹-2">Node.js ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æµ-streams-ç®€ä»‹-1">æµï¼ˆStreamsï¼‰ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#web-streams-api-3">Web Streams API</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#streamconsumers-text-stream-1">streamConsumers.text(stream)</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h1 id="web-streams-api" tabindex="-1"><a class="header-anchor" href="#web-streams-api"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#web-streams-api" target="_blank" rel="noopener noreferrer">Web Streams API</a></span></a></h1><p>Node.js çš„ Web Streams API æ˜¯ä¸€ç§ç”¨äºå¤„ç†æµå¼æ•°æ®çš„ç¼–ç¨‹æ¥å£ã€‚è¿™æ„å‘³ç€æ•°æ®å¯ä»¥ä¸€å—ä¸€å—åœ°å‘é€å’Œæ¥æ”¶ï¼Œè€Œä¸å¿…ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å¯ç”¨ã€‚è¿™å¯¹äºå¤„ç†å¤§é‡æ•°æ®æˆ–å®æ—¶æ•°æ®éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå…è®¸åº”ç”¨ç¨‹åºå¼€å§‹å¤„ç†æ•°æ®ç‰‡æ®µï¼Œè€Œä¸æ˜¯ç­‰å¾…æ•´ä¸ªæ•°æ®é›†ã€‚</p><p>åœ¨è¯¦ç»†è§£é‡Šä¹‹å‰ï¼Œå…ˆäº†è§£å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š</p><ol><li><strong>Streamï¼ˆæµï¼‰</strong>ï¼šæ•°æ®çš„ä¸€ä¸ªè¿ç»­åºåˆ—ã€‚æƒ³è±¡æˆæ°´æµï¼Œæ•°æ®å¦‚åŒæ°´åˆ†å­ï¼Œè¿ç»­ä¸æ–­åœ°æµåŠ¨ã€‚</li><li><strong>Readable Streamï¼ˆå¯è¯»æµï¼‰</strong>ï¼šåº”ç”¨ç¨‹åºå¯ä»¥ä»ä¸­è¯»å–æ•°æ®çš„æµã€‚æ¯”å¦‚ä»æ–‡ä»¶ç³»ç»Ÿè¯»å–æ–‡ä»¶å†…å®¹å°±æ˜¯é€šè¿‡å¯è¯»æµã€‚</li><li><strong>Writable Streamï¼ˆå¯å†™æµï¼‰</strong>ï¼šåº”ç”¨ç¨‹åºå¯ä»¥å†™å…¥æ•°æ®çš„æµã€‚ä¾‹å¦‚ï¼Œå°†æ•°æ®å†™å…¥æ–‡ä»¶ç³»ç»Ÿå°±æ˜¯é€šè¿‡å¯å†™æµã€‚</li><li><strong>Pipeï¼ˆç®¡é“ï¼‰</strong>ï¼šæ˜¯ä¸€ç§å°†å¯è¯»æµçš„è¾“å‡ºç›´æ¥è¿æ¥åˆ°å¯å†™æµçš„è¾“å…¥çš„æŠ€æœ¯ï¼Œç±»ä¼¼äºç°å®ç”Ÿæ´»ä¸­çš„ç®¡é“å°†æ°´ä»ä¸€å¤„ä¼ è¾“åˆ°å¦ä¸€å¤„ã€‚</li></ol><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><h4 id="_1-æ–‡ä»¶è¯»å†™" tabindex="-1"><a class="header-anchor" href="#_1-æ–‡ä»¶è¯»å†™"><span>1. æ–‡ä»¶è¯»å†™</span></a></h4><p>Node.js ä¸­æœ€å¸¸è§çš„ä½¿ç”¨åœºæ™¯ä¹‹ä¸€æ˜¯è¯»å–å’Œå†™å…¥æ–‡ä»¶ã€‚ä½¿ç”¨ Web Streams APIï¼Œæˆ‘ä»¬å¯ä»¥é€å—è¯»å–æ–‡ä»¶å†…å®¹ï¼Œå¹¶ä¸”åŒæ ·é€å—åœ°å†™å…¥åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ã€‚è¿™æ¯”ä¸€æ¬¡æ€§è¯»å–æ•´ä¸ªæ–‡ä»¶æ›´é«˜æ•ˆï¼Œå°¤å…¶æ˜¯å¤„ç†å¤§æ–‡ä»¶æ—¶ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯è¯»æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">source.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯å†™æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">destination.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°†å¯è¯»æµçš„æ•°æ®å†™å…¥å¯å†™æµï¼Œå³å¤åˆ¶æ–‡ä»¶</span></span>
<span class="line"><span style="color:#D8DEE9;">readableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">writableStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-ç½‘ç»œè¯·æ±‚" tabindex="-1"><a class="header-anchor" href="#_2-ç½‘ç»œè¯·æ±‚"><span>2. ç½‘ç»œè¯·æ±‚</span></a></h4><p>å½“å¤„ç† HTTP è¯·æ±‚æ—¶ï¼Œè¯·æ±‚å’Œå“åº”ä½“ä¹Ÿå¯ä»¥è¢«è§†ä½œæµã€‚Node.js å…è®¸ä½ é€å—å¤„ç†è¿™äº›æ•°æ®ï¼Œä¾‹å¦‚ï¼Œæ¥æ”¶ä¸Šä¼ çš„æ–‡ä»¶æˆ–è€…å¤§å‹ JSON å¯¹è±¡ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> http</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">http</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">http</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">createServer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">req</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> res</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å‡è®¾æˆ‘ä»¬åªå…³å¿ƒPOSTè¯·æ±‚</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">req</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">method</span><span style="color:#81A1C1;"> ===</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">POST</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">      let</span><span style="color:#D8DEE9;"> body</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">      // æ¥æ”¶æ•°æ®å—å¹¶æ‹¼æ¥</span></span>
<span class="line"><span style="color:#D8DEE9;">      req</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        body</span><span style="color:#81A1C1;"> +=</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">      // æ•°æ®æ¥æ”¶å®Œæ¯•</span></span>
<span class="line"><span style="color:#D8DEE9;">      req</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">end</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">body</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æ•°æ®æ¥æ”¶å®Œæ¯•</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">listen</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">8080</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-å®æ—¶æ•°æ®å¤„ç†" tabindex="-1"><a class="header-anchor" href="#_3-å®æ—¶æ•°æ®å¤„ç†"><span>3. å®æ—¶æ•°æ®å¤„ç†</span></a></h4><p>åœ¨å¤„ç†ä¾‹å¦‚è‚¡ç¥¨å¸‚åœºæ•°æ®ã€æ¸¸æˆæ•°æ®æµæˆ–è€…ç¤¾äº¤åª’ä½“å®æ—¶æ›´æ–°æ—¶ï¼ŒWeb Streams API èƒ½å¤Ÿå‘æŒ¥å·¨å¤§ä½œç”¨ã€‚ä»¥ç›‘å¬ Twitter å®æ—¶æ¨æ–‡ä¸ºä¾‹ï¼Œå‡è®¾æœ‰ä¸€ä¸ªæœåŠ¡æä¾›äº†å®æ—¶æ¨æ–‡çš„æµå¼ APIï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Node.js æ¥ä¾æ¬¡å¤„ç†æ¯æ¡æ¨æ–‡ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾twitterStreamæ˜¯ä¸€ä¸ªè¿æ¥åˆ°Twitterå®æ—¶APIçš„å¯è¯»æµ</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">twitterStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">tweet</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">tweet</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å¤„ç†æ¯æ¡æ¨æ–‡</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Web Streams API é€šè¿‡æä¾›è¿™ç§æµå¼å¤„ç†æ•°æ®çš„èƒ½åŠ›ï¼Œä½¿å¾— Node.js æˆä¸ºå¼€å‘éœ€è¦é«˜æ•ˆå¤„ç†å¤§é‡æ•°æ®æˆ–å®æ—¶æ•°æ®çš„åº”ç”¨ç¨‹åºçš„ç†æƒ³é€‰æ‹©ã€‚</p><h2 id="overview" tabindex="-1"><a class="header-anchor" href="#overview"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#overview" target="_blank" rel="noopener noreferrer">Overview</a></span></a></h2><p>Node.js v21.7.1 ä¸­çš„ Web Streams API æä¾›äº†ä¸€ç§å¤„ç†æµæ•°æ®ï¼ˆå¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œé€šä¿¡ç­‰ï¼‰çš„æ ‡å‡†æ–¹æ³•ã€‚è¿™æ„å‘³ç€ï¼Œæ— è®ºæ•°æ®æºæ˜¯ä»€ä¹ˆï¼Œä½ éƒ½å¯ä»¥ç”¨ç»Ÿä¸€çš„æ–¹å¼æ¥æ“ä½œå®ƒä»¬ã€‚Web Streams API åŒ…å«ä¸‰ä¸ªä¸»è¦æ¦‚å¿µï¼šReadableStreamï¼ˆå¯è¯»æµï¼‰ï¼ŒWritableStreamï¼ˆå¯å†™æµï¼‰ï¼Œä»¥åŠ TransformStreamï¼ˆè½¬æ¢æµï¼‰ã€‚</p><h3 id="readablestream-å¯è¯»æµ" tabindex="-1"><a class="header-anchor" href="#readablestream-å¯è¯»æµ"><span>ReadableStreamï¼ˆå¯è¯»æµï¼‰</span></a></h3><p><code>ReadableStream</code> ä»£è¡¨ä¸€ä¸ªæ•°æ®æºï¼Œä»ä¸­ä½ å¯ä»¥è¯»å–æ•°æ®ã€‚æ¯”å¦‚ï¼Œå¦‚æœä½ æƒ³ä»ä¸€ä¸ªæ–‡ä»¶é€å—åœ°è¯»å–æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>ReadableStream</code>ã€‚</p><p><strong>å®é™…åº”ç”¨ç¤ºä¾‹</strong>ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªç½‘ç«™ï¼Œéœ€è¦ä»æœåŠ¡å™¨åŠ è½½ä¸€ä¸ªå¤§è§†é¢‘æ–‡ä»¶å¹¶å±•ç¤ºç»™ç”¨æˆ·ã€‚ä½¿ç”¨ <code>ReadableStream</code>ï¼Œä½ å¯ä»¥é€æ­¥åœ°è¯»å–è§†é¢‘æ–‡ä»¶ï¼Œå¹¶éšç€æ•°æ®çš„åˆ°æ¥é€æ­¥æ˜¾ç¤ºè§†é¢‘å†…å®¹ï¼Œè€Œä¸éœ€è¦ç­‰å¾…æ•´ä¸ªæ–‡ä»¶å…¨éƒ¨ä¸‹è½½å®Œæˆã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæŒ‡å‘è§†é¢‘æ–‡ä»¶çš„URL</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> videoURL</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">path/to/your/video/file</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨fetch APIè·å–å†…å®¹ï¼Œå®ƒè¿”å›çš„å“åº”ä½“å°±æ˜¯ä¸€ä¸ªReadableStream</span></span>
<span class="line"><span style="color:#88C0D0;">fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">videoURL</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">response</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // è¯»å–æ•°æ®...</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="writablestream-å¯å†™æµ" tabindex="-1"><a class="header-anchor" href="#writablestream-å¯å†™æµ"><span>WritableStreamï¼ˆå¯å†™æµï¼‰</span></a></h3><p><code>WritableStream</code> ä»£è¡¨ä¸€ä¸ªå¯ä»¥å†™å…¥æ•°æ®çš„ç›®çš„åœ°ã€‚è¿™å¯¹äºéœ€è¦å°†æ•°æ®åˆ†æ‰¹æ¬¡å†™å…¥çš„æƒ…æ™¯éå¸¸æœ‰ç”¨ï¼Œä¾‹å¦‚ä¿å­˜å¤§æ–‡ä»¶æˆ–é€šè¿‡ç½‘ç»œå‘é€æ•°æ®ã€‚</p><p><strong>å®é™…åº”ç”¨ç¤ºä¾‹</strong>:</p><p>å¦‚æœä½ æ­£å¼€å‘ä¸€ä¸ªå…è®¸ç”¨æˆ·ä¸Šä¼ è§†é¢‘åˆ°æœåŠ¡å™¨çš„åº”ç”¨ç¨‹åºï¼Œä½ å¯èƒ½å¸Œæœ›åœ¨æ¥æ”¶åˆ°æ•°æ®çš„åŒæ—¶å¼€å§‹å¤„ç†å®ƒï¼Œè€Œä¸æ˜¯ç­‰åˆ°å…¨éƒ¨æ¥æ”¶å®Œæ¯•ã€‚è¿™æ ·èƒ½æ›´æœ‰æ•ˆç‡åœ°åˆ©ç”¨èµ„æºï¼Œç‰¹åˆ«æ˜¯å¤„ç†å¤§å‹æ–‡ä»¶æ—¶ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾æœ‰ä¸€ä¸ªå‡½æ•°ç”¨äºå¤„ç†ä¸Šä¼ çš„æ•°æ®å—</span></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> processDataChunk</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // å¤„ç†æ•°æ®...</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> WritableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  write</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">    processDataChunk</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ç°åœ¨å¯ä»¥å°†æ•°æ®å†™å…¥writableStreamä¸­</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="transformstream-è½¬æ¢æµ" tabindex="-1"><a class="header-anchor" href="#transformstream-è½¬æ¢æµ"><span>TransformStreamï¼ˆè½¬æ¢æµï¼‰</span></a></h3><p><code>TransformStream</code> å°† <code>ReadableStream</code> å’Œ <code>WritableStream</code> ç»“åˆèµ·æ¥ï¼Œå…è®¸ä½ åœ¨æ•°æ®è¢«è¯»å‡ºå’Œå†™å…¥ä¹‹é—´å¯¹å…¶è¿›è¡Œè½¬æ¢ã€‚è¿™éå¸¸é€‚ç”¨äºéœ€è¦æ•°æ®è½¬æ¢çš„åœºæ™¯ï¼Œæ¯”å¦‚å‹ç¼©ã€åŠ å¯†æˆ–æ ¼å¼åŒ–æ•°æ®ã€‚</p><p><strong>å®é™…åº”ç”¨ç¤ºä¾‹</strong>:</p><p>æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªéœ€è¦æ¥æ”¶æ–‡æœ¬æ–‡ä»¶ã€è½¬æ¢æ–‡ä»¶å†…å®¹ï¼ˆæ¯”å¦‚åŠ å¯†æˆ–æ ¼å¼è½¬æ¢ï¼‰ï¼Œç„¶åå†ä¿å­˜çš„æœåŠ¡ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>TransformStream</code> å¯ä»¥å¸®åŠ©ä½ åˆ›å»ºä¸€ä¸ªæµæ°´çº¿ï¼Œæ•°æ®å¯ä»¥æµè¿‡è¿™ä¸ªæµæ°´çº¿è¢«è¿ç»­åœ°å˜æ¢ï¼Œæœ€åè¾“å‡ºã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªTransformStreamï¼Œå°†æ–‡æœ¬è½¬æ¢ä¸ºå¤§å†™</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> upperCaseTransformer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TransformStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  transform</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toUpperCase</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ç°åœ¨ï¼Œå½“æ•°æ®é€šè¿‡upperCaseTransformeræ—¶ï¼Œå®ƒä¼šè¢«è½¬æ¢æˆå¤§å†™å½¢å¼</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ€»çš„æ¥è¯´ï¼ŒNode.js ä¸­çš„ Web Streams API æä¾›äº†ä¸€å¥—å¼ºå¤§çš„å·¥å…·ï¼Œä½¿å¾—å¤„ç†å„ç§æµæ•°æ®å˜å¾—ç®€å•è€Œç»Ÿä¸€ã€‚æ— è®ºä½ æ˜¯åœ¨å¤„ç†æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚è¿˜æ˜¯å…¶ä»–ä»»ä½•å½¢å¼çš„æ•°æ®æµï¼Œä½¿ç”¨è¿™äº› API å¯ä»¥è®©ä½ çš„ä»£ç æ—¢é«˜æ•ˆåˆæ˜“äºç®¡ç†ã€‚</p><h3 id="example-readablestream" tabindex="-1"><a class="header-anchor" href="#example-readablestream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#example-readablestream" target="_blank" rel="noopener noreferrer">Example ReadableStream</a></span></a></h3><p>Node.js çš„ç‰ˆæœ¬ 21.7.1 åŒ…å«äº†å¯¹ Web Streams API çš„æ”¯æŒï¼Œè¿™æ˜¯ä¸€ä¸ªå¤„ç†æµæ•°æ®çš„æ ‡å‡†æ¥å£ã€‚åœ¨è®¸å¤šç½‘ç»œå’Œæ–‡ä»¶æ“ä½œä¸­ï¼Œä½ ä¼šå‘ç°ä½¿ç”¨æµéå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒä»¬å…è®¸ä½ å¤„ç†æ•°æ®ç‰‡æ®µï¼Œè€Œä¸æ˜¯ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å¯ç”¨ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥å¼€å§‹å¤„ç†æ•°æ®çš„ä¸€ä¸ªéƒ¨åˆ†ï¼Œè€Œå…¶ä»–éƒ¨åˆ†è¿˜åœ¨è·¯ä¸Šï¼Œä»è€Œæé«˜äº†æ•ˆç‡ã€‚</p><p>ä¸€ä¸ª<code>ReadableStream</code>æ˜¯ä¸€ç§ Web Streams API çš„ç»„æˆéƒ¨åˆ†ï¼Œä»£è¡¨ä¸€ä¸ªæºè‡ªå“ªé‡Œå¯ä»¥è¯»å–æ•°æ®çš„åºåˆ—ã€‚å¦‚æœæˆ‘ä»¬å°†å…¶ä¸ä¼ ç»Ÿçš„æ•´å—æ•°æ®å¤„ç†æ–¹å¼ç›¸æ¯”è¾ƒï¼Œä½¿ç”¨<code>ReadableStream</code>å¯ä»¥æ›´å¿«åœ°å¼€å§‹å¤„ç†æ•°æ®ï¼Œå› ä¸ºä½ ä¸éœ€è¦ç­‰å¾…æ‰€æœ‰æ•°æ®ä¸‹è½½å®Œæ¯•ã€‚</p><h3 id="å®é™…è¿ç”¨ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><p>ä¸ºäº†è¯´æ˜<code>ReadableStream</code>çš„ç”¨æ³•ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚å‡è®¾æˆ‘ä»¬æ­£åœ¨æ„å»ºä¸€ä¸ª Web åº”ç”¨ç¨‹åºï¼Œéœ€è¦ä»è¿œç¨‹æœåŠ¡å™¨è·å–ä¸€äº›æ•°æ®ï¼Œå¹¶ä¸”å¸Œæœ›èƒ½å¤Ÿåœ¨æ•°æ®åˆ°è¾¾æ—¶ç«‹å³å¼€å§‹å¤„ç†å®ƒä»¬ï¼š</p><h4 id="ä»æœåŠ¡å™¨è·å–æ–‡æœ¬æ•°æ®" tabindex="-1"><a class="header-anchor" href="#ä»æœåŠ¡å™¨è·å–æ–‡æœ¬æ•°æ®"><span>ä»æœåŠ¡å™¨è·å–æ–‡æœ¬æ•°æ®</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾ fetchSomeData æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œç”¨äºä»æœåŠ¡å™¨è·å–æ•°æ®ã€‚</span></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> fetchData</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> response</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#88C0D0;"> fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://example.com/data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // ä½¿ç”¨ fetch API è·å–æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è·å– ReadableStream çš„ reader</span></span>
<span class="line"><span style="color:#81A1C1;">  let</span><span style="color:#D8DEE9;"> chunks</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;&quot;</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // ç”¨äºå­˜æ”¾ä»æµä¸­è¯»å–çš„æ•°æ®</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å¼‚æ­¥è¯»å–æ•°æ®å—</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">      break;</span><span style="color:#616E88;"> // å¦‚æœæ²¡æœ‰æ›´å¤šæ•°æ®ï¼Œè·³å‡ºå¾ªç¯</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#D8DEE9;">    chunks</span><span style="color:#81A1C1;"> +=</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextDecoder</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">decode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å°†æ•°æ®å—è½¬æ¢ä¸ºæ–‡æœ¬å¹¶ç´¯åŠ </span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunks</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºç´¯åŠ åçš„æ–‡æœ¬æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">fetchData</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå¼‚æ­¥å‡½æ•°<code>fetchData</code>ï¼Œå®ƒé€šè¿‡<code>fetch</code>API ä»æŸä¸ª URL è·å–æ•°æ®ã€‚<code>fetch</code>è¿”å›çš„<code>Response</code>å¯¹è±¡åŒ…å«ä¸€ä¸ª<code>body</code>å±æ€§ï¼Œè¿™æ˜¯ä¸€ä¸ª<code>ReadableStream</code>ï¼Œå…è®¸æˆ‘ä»¬æŒ‰å—è¯»å–æ•°æ®ã€‚é€šè¿‡è°ƒç”¨<code>getReader()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬è·å¾—äº†ä¸€ä¸ªèƒ½å¤Ÿé€å—è¯»å–æ•°æ®çš„è¯»å–å™¨ï¼ˆreaderï¼‰ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼Œä¸æ–­åœ°è°ƒç”¨<code>reader.read()</code>æ–¹æ³•è¯»å–æ•°æ®å—ã€‚æ¯æ¬¡è°ƒç”¨è¿”å›ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå±æ€§çš„å¯¹è±¡ï¼š<code>done</code>å’Œ<code>value</code>ã€‚<code>done</code>æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºæ˜¯å¦å·²ç»è¯»å–äº†æ‰€æœ‰æ•°æ®ï¼›<code>value</code>æ˜¯ä¸€ä¸ª<code>Uint8Array</code>ï¼Œè¡¨ç¤ºè¯»å–åˆ°çš„æ•°æ®å—ã€‚æˆ‘ä»¬ä½¿ç”¨<code>TextDecoder</code>å°†æ¯ä¸ªæ•°æ®å—è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶å°†å®ƒä»¬ç´¯åŠ åˆ°<code>chunks</code>å˜é‡ä¸­ã€‚</p><p>å½“<code>done</code>ä¸º<code>true</code>æ—¶ï¼Œè¡¨ç¤ºæ²¡æœ‰æ›´å¤šæ•°æ®å¯ä»¥è¯»å–ï¼Œæˆ‘ä»¬é€€å‡ºå¾ªç¯ï¼Œå¹¶è¾“å‡ºç´¯åŠ åçš„æ–‡æœ¬æ•°æ®ã€‚</p><p>è¿™ä¸ªä¾‹å­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨<code>ReadableStream</code>æ¥æŒ‰éœ€å¤„ç†æ•°æ®ï¼Œè€Œæ— éœ€ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½è¢«ä¸‹è½½ã€‚è¿™ç§æ–¹å¼å°¤å…¶é€‚åˆå¤„ç†å¤§é‡æ•°æ®æˆ–è€…åœ¨æ€§èƒ½æ•æ„Ÿçš„åº”ç”¨åœºæ™¯ä¸­ã€‚</p><h2 id="api" tabindex="-1"><a class="header-anchor" href="#api"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#api" target="_blank" rel="noopener noreferrer">API</a></span></a></h2><p>å½“ä½ å¬è¯´ Node.jsï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªåœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ JavaScript ä»£ç çš„å¹³å°ã€‚Node.js æ˜¯éå¸¸å¼ºå¤§çš„ï¼Œå› ä¸ºå®ƒå…è®¸ä½ ä½¿ç”¨ JavaScript æ¥åšå¾ˆå¤šåç«¯å¼€å‘çš„å·¥ä½œï¼Œæ¯”å¦‚å¤„ç†æ–‡ä»¶ã€æ•°æ®åº“äº¤äº’ã€ç½‘ç»œé€šä¿¡ç­‰ã€‚è€Œ Node.js çš„ç‰ˆæœ¬ 21.7.1ï¼Œæ˜¯ Node.js å‘å±•è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªç‰¹å®šç‰ˆæœ¬ã€‚</p><p>åœ¨ Node.js ä¸­ï¼Œ&quot;API&quot; æŒ‡çš„æ˜¯åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£(Application Programming Interfaces)ã€‚ç®€å•æ¥è¯´ï¼ŒAPI å°±æ˜¯ä¸€å¥—è§„åˆ™å’Œå®šä¹‰ï¼Œå…è®¸ä¸åŒçš„è½¯ä»¶é—´è¿›è¡Œäº¤äº’ã€‚æ¯”å¦‚ï¼Œå¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªå¤©æ°”åº”ç”¨ï¼Œä½ å¯èƒ½ä¼šä½¿ç”¨ä¸€ä¸ªæä¾›å¤©æ°”æ•°æ®çš„ç¬¬ä¸‰æ–¹æœåŠ¡çš„ API æ¥è·å–å®æ—¶å¤©æ°”ä¿¡æ¯ã€‚</p><p>ç‰¹åˆ«åœ°ï¼Œä½ æåˆ°çš„ web streams APIï¼Œæ˜¯ Web æµ (Streams) çš„ä¸€ä¸ªå®ç°ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿä»¥é«˜æ•ˆçš„æ–¹å¼å¤„ç†æµå¼æ•°æ®ã€‚æµå¼æ•°æ®æŒ‡çš„æ˜¯é‚£äº›é€ç‰‡æ®µåˆ°è¾¾çš„æ•°æ®ï¼Œæ¯”å¦‚è§†é¢‘ä¸‹è½½ã€å¤§å‹æ–‡ä»¶ä¸Šä¼ æˆ–å®æ—¶æ•°æ®ä¼ è¾“ç­‰åœºæ™¯ã€‚åœ¨ Node.js ä¸­å¤„ç†è¿™ç§ç±»å‹çš„æ•°æ®éå¸¸é‡è¦ï¼Œå› ä¸ºå®ƒå¯ä»¥è®©æˆ‘ä»¬æ§åˆ¶å†…å­˜ä½¿ç”¨ï¼Œæé«˜æ€§èƒ½ï¼ŒåŒæ—¶æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚</p><h3 id="web-streams-api-çš„å®é™…åº”ç”¨ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#web-streams-api-çš„å®é™…åº”ç”¨ä¾‹å­"><span>Web Streams API çš„å®é™…åº”ç”¨ä¾‹å­ï¼š</span></a></h3><ol><li><strong>æ–‡ä»¶å¤„ç†ï¼š</strong> å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦ç”¨æˆ·ä¸Šä¼ å¤§å‹è§†é¢‘æ–‡ä»¶ã€‚ä½¿ç”¨ Web Streams APIï¼Œä½ å¯ä»¥é€å—åœ°æ¥æ”¶å’Œå¤„ç†è¿™äº›æ•°æ®ï¼Œè€Œä¸æ˜¯ç­‰å¾…æ•´ä¸ªæ–‡ä»¶ä¸Šä¼ å®Œæ¯•ã€‚è¿™æ„å‘³ç€ä½ çš„æœåŠ¡å™¨ä¸éœ€è¦æœ‰è¶³å¤Ÿçš„å†…å­˜æ¥ä¸€æ¬¡æ€§å­˜æ”¾æ•´ä¸ªæ–‡ä»¶ï¼Œä»è€ŒèŠ‚çœèµ„æºã€‚</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/large/video.mp4</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/destination.mp4</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">readableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">writableStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong>å®æ—¶æ•°æ®å¤„ç†ï¼š</strong> å¦‚æœä½ çš„åº”ç”¨éœ€è¦å¤„ç†æ¥è‡ª IoT è®¾å¤‡ï¼ˆå¦‚æ¸©åº¦ä¼ æ„Ÿå™¨ï¼‰çš„å®æ—¶æ•°æ®æµï¼Œä½¿ç”¨ Web Streams API å¯ä»¥å¸®åŠ©ä½ æœ‰æ•ˆåœ°å¤„ç†è¿™äº›è¿ç»­çš„æ•°æ®ç‚¹ã€‚ä½ å¯ä»¥åœ¨æ•°æ®åˆ°è¾¾æ—¶ç«‹å³å¤„ç†å®ƒä»¬ï¼Œè€Œä¸æ˜¯ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½åˆ°é½åå†å¼€å§‹å¤„ç†ã€‚</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾æŸä¸ªå‡½æ•° continuouslyReceiveData() æŒç»­æ¥æ”¶æ¥è‡ª IoT è®¾å¤‡çš„æ•°æ®</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> Readable</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> dataStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Readable</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  read</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {},</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">dataStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">Received data: </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">chunk</span><span style="color:#81A1C1;">}</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">  // åœ¨è¿™é‡Œå¤„ç†æ¯ä¸ªæ•°æ®ç‰‡æ®µ</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">continuouslyReceiveData</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">dataChunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  dataStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">push</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">dataChunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><strong>ç½‘ç»œè¯·æ±‚å¤„ç†ï¼š</strong> å½“ä½ çš„ Node.js åº”ç”¨éœ€è¦ä»å¦ä¸€ä¸ªæœåŠ¡è·å–å¤§é‡æ•°æ®æ—¶ï¼ˆä¾‹å¦‚ï¼Œä»ç¤¾äº¤åª’ä½“ API è·å–æ•°æ®ï¼‰ï¼Œä½ å¯ä»¥åˆ©ç”¨ Web Streams API ä»¥æµå¼æ–¹å¼å¤„ç†å“åº”æ•°æ®ï¼Œè¿™æ ·ä½ å°±å¯ä»¥åœ¨å…¨éƒ¨æ•°æ®åˆ°è¾¾ä¹‹å‰å¼€å§‹å¤„ç†éƒ¨åˆ†æ•°æ®ï¼Œæé«˜æ•ˆç‡ã€‚</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> https</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">https</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://api.example.com/large-data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">resp</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  let</span><span style="color:#D8DEE9;"> dataChunks</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> []</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">  resp</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    dataChunks</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">push</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // å¤„ç†æ¯ä¸€ä¸ªæ•°æ®å—</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">  resp</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">end</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Received all chunks</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> completeData</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Buffer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">concat</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">dataChunks</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // åœ¨è¿™é‡Œå¤„ç†å®Œæ•´çš„æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ€»ç»“ä¸€ä¸‹ï¼ŒWeb Streams API åœ¨ Node.js ä¸­çš„åº”ç”¨éå¸¸å¹¿æ³›ï¼Œå®ƒä¸ºå¤„ç†æµå¼æ•°æ®æä¾›äº†å¼ºå¤§çš„å·¥å…·ï¼Œæ— è®ºæ˜¯å¤„ç†æ–‡ä»¶ã€å®æ—¶æ•°æ®è¿˜æ˜¯ç½‘ç»œè¯·æ±‚ï¼Œéƒ½èƒ½è®©å¼€å‘å˜å¾—æ›´åŠ é«˜æ•ˆå’Œçµæ´»ã€‚</p><h3 id="class-readablestream" tabindex="-1"><a class="header-anchor" href="#class-readablestream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-readablestream" target="_blank" rel="noopener noreferrer">Class: ReadableStream</a></span></a></h3><p>Node.js ä¸­çš„ <code>ReadableStream</code> æ˜¯åŸºäº Web æ ‡å‡†çš„æµï¼ˆstreamï¼‰API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯å¤„ç†å¼‚æ­¥æ•°æ®æµçš„ä¸€ä¸ªå¼ºå¤§å·¥å…·ã€‚ç®€å•æ¥è¯´ï¼Œ<code>ReadableStream</code> å…è®¸ä½ ä»¥ä¸€ç§æ§åˆ¶å’Œé«˜æ•ˆçš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯”å¦‚ä»æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚æˆ–ä»»ä½•å…¶ä»–æ•°æ®æºã€‚</p><h3 id="ä»€ä¹ˆæ˜¯æµ-stream" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯æµ-stream"><span>ä»€ä¹ˆæ˜¯æµï¼ˆStreamï¼‰ï¼Ÿ</span></a></h3><p>åœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯ä¸€ç³»åˆ—è¿ç»­çš„æ•°æ®ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆæ°´æµï¼šæ•°æ®åƒæ°´ä¸€æ ·ä»ä¸€ä¸ªåœ°æ–¹æµå‘å¦ä¸€ä¸ªåœ°æ–¹ã€‚æµä½¿æˆ‘ä»¬èƒ½å¤Ÿé«˜æ•ˆåœ°å¤„ç†å¤§é‡æ•°æ®ï¼Œå› ä¸ºä½ ä¸éœ€è¦ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å¯ç”¨æ‰å¼€å§‹å¤„ç†å®ƒä»¬ã€‚</p><h3 id="readablestream-åŸºæœ¬æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#readablestream-åŸºæœ¬æ¦‚å¿µ"><span>ReadableStream åŸºæœ¬æ¦‚å¿µ</span></a></h3><ul><li><strong>å¯è¯»æµ</strong> (<code>ReadableStream</code>)ï¼šè¿™ç±»æµå…è®¸ä½ è¯»å–æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå½“ä½ ä»æ–‡ä»¶ç³»ç»Ÿè¯»å–ä¸€ä¸ªå¤§æ–‡ä»¶æ—¶ï¼Œä½¿ç”¨å¯è¯»æµå¯ä»¥é€å—è¯»å–æ–‡ä»¶å†…å®¹ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</li></ul><h3 id="å®é™…è¿ç”¨ä¾‹å­-1" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-1"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><ol><li><p><strong>ä»æ–‡ä»¶è¯»å–æ•°æ®</strong></p><p>å½“ä½ å¤„ç†å¤§å‹æ–‡ä»¶æ—¶ï¼Œæ¯”å¦‚æ—¥å¿—æ–‡ä»¶æˆ–å¤§å‹æ–‡æœ¬æ–‡ä»¶ï¼Œä¸€æ¬¡æ€§å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜å¯èƒ½ä¼šå¯¼è‡´å†…å­˜ä¸è¶³ã€‚è¿™æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>ReadableStream</code> é€å—è¯»å–æ–‡ä»¶ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯è¯»æµï¼Œé€å—è¯»å–æ–‡ä»¶å†…å®¹</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/large/file.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">  encoding</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">utf8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">readableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">Received </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">length</span><span style="color:#81A1C1;">}</span><span style="color:#A3BE8C;"> bytes of data.</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">readableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">end</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">No more data to read.</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>å¤„ç† HTTP å“åº”</strong></p><p>å½“ä½ å‘èµ·ä¸€ä¸ª HTTP è¯·æ±‚å¹¶æ¥æ”¶å“åº”æ—¶ï¼Œå“åº”ä½“å¯èƒ½éå¸¸å¤§ã€‚ä½¿ç”¨ <code>ReadableStream</code> å¯ä»¥å¸®åŠ©ä½ æ›´æœ‰æ•ˆåœ°å¤„ç†è¿™äº›æ•°æ®ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> https</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">https</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://example.com</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">res</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  let</span><span style="color:#D8DEE9;"> data</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // res is a ReadableStream</span></span>
<span class="line"><span style="color:#D8DEE9;">  res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    data</span><span style="color:#81A1C1;"> +=</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">  res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">end</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“"><span>æ€»ç»“</span></a></h3><p><code>ReadableStream</code> æä¾›äº†ä¸€ç§é«˜æ•ˆä¸”æ˜“äºæ§åˆ¶çš„æ–¹å¼æ¥å¤„ç†å¼‚æ­¥æ•°æ®æµã€‚æ— è®ºæ˜¯ä»æ–‡ä»¶è¯»å–æ•°æ®ï¼Œå¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œè¿˜æ˜¯å…¶ä»–å½¢å¼çš„æ•°æ®æµï¼Œå®ƒéƒ½èƒ½è®©ä½ ä»¥ä¸€ç§å†…å­˜é«˜æ•ˆå’Œå“åº”é€Ÿåº¦å¿«çš„æ–¹å¼å¤„ç†å¤§é‡æ•°æ®ã€‚é€šè¿‡ç›‘å¬ä¸åŒçš„äº‹ä»¶æ¯”å¦‚ <code>data</code> å’Œ <code>end</code>ï¼Œä½ å¯ä»¥è½»æ¾åœ°æ§åˆ¶æ•°æ®çš„è¯»å–è¿‡ç¨‹ï¼Œå¹¶åœ¨æ•°æ®å¤„ç†å®Œæˆåæ‰§è¡Œç›¸å…³æ“ä½œã€‚</p><h4 id="new-readablestream-underlyingsource-strategy" tabindex="-1"><a class="header-anchor" href="#new-readablestream-underlyingsource-strategy"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#new-readablestreamunderlyingsource--strategy" target="_blank" rel="noopener noreferrer">new ReadableStream([underlyingSource [, strategy]])</a></span></a></h4><p>å½“æˆ‘ä»¬è°ˆè®º Node.js ä¸­çš„ <code>ReadableStream</code>ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šæ˜¯åœ¨è®¨è®ºä¸€ç§å¯ä»¥æŒ‰é¡ºåºè¯»å–æ•°æ®çš„æµã€‚æƒ³è±¡ä¸€ä¸‹ä½ å®¶çš„æ°´é¾™å¤´ï¼Œæ‰“å¼€åæ°´å°±ä»ä¸­æµå‡ºï¼Œè€Œ <code>ReadableStream</code> å°±åƒæ˜¯æ•°æ®çš„æ°´é¾™å¤´ã€‚ä½ å¯ä»¥æ§åˆ¶ä»€ä¹ˆæ—¶å€™å¼€å§‹æ¥æ”¶æ•°æ®ï¼Œä»¥åŠå¦‚ä½•å¤„ç†è¿™äº›æ•°æ®ã€‚</p><p>åœ¨ Node.js v21.7.1 ä¸­ï¼Œ<code>ReadableStream</code> å¯¹è±¡æ˜¯éµå¾ª <a href="https://streams.spec.whatwg.org/" target="_blank" rel="noopener noreferrer">WHATWG Streams API</a> çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä¸»è¦ç”¨äº web åº”ç”¨å¼€å‘é¢†åŸŸï¼Œç‰¹åˆ«æ˜¯ä¸ HTTP/2 å’Œ HTTP/3 åè®®çš„äº¤äº’ä¸­éå¸¸æœ‰ç”¨ã€‚è¿™æ„å‘³ç€é€šè¿‡ä½¿ç”¨è¿™äº›æµï¼ŒNode.js åº”ç”¨ç¨‹åºèƒ½å¤Ÿé«˜æ•ˆåœ°å¤„ç†å¤§é‡æ•°æ®ï¼Œæ¯”å¦‚æ–‡ä»¶ä¼ è¾“ã€è§†é¢‘æµæˆ–å®æ—¶æ•°æ®é€šä¿¡ï¼Œè€Œä¸ä¼šå ç”¨è¿‡å¤šå†…å­˜ã€‚</p><h3 id="æ„é€ å‡½æ•°-new-readablestream-underlyingsource-strategy" tabindex="-1"><a class="header-anchor" href="#æ„é€ å‡½æ•°-new-readablestream-underlyingsource-strategy"><span>æ„é€ å‡½æ•°ï¼šnew ReadableStream([underlyingSource [, strategy]])</span></a></h3><p>åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>ReadableStream</code> å¯¹è±¡æ—¶ï¼Œä½ å¯ä»¥æä¾›ä¸¤ä¸ªå¯é€‰å‚æ•°ï¼š<code>underlyingSource</code> å’Œ <code>strategy</code>ã€‚</p><ul><li><p><strong><code>underlyingSource</code></strong> å¯¹è±¡åŒ…å«äº†å‡ ä¸ªå±æ€§å’Œå‡½æ•°ï¼Œå…è®¸ä½ å®šåˆ¶æµçš„è¡Œä¸ºã€‚æœ€é‡è¦çš„æ˜¯ <code>start</code>ã€<code>pull</code> å’Œ <code>cancel</code> å‡½æ•°ï¼š</p><ul><li><code>start(controller)</code>ï¼šå½“æµè¢«åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œè®¾ç½®ä¸€äº›ä¸œè¥¿ã€‚</li><li><code>pull(controller)</code>ï¼šæ¯æ¬¡æ¶ˆè´¹è€…è¯»å–æµæ—¶è°ƒç”¨ï¼Œä½ å¯ä»¥é€šè¿‡å®ƒæ§åˆ¶æ•°æ®çš„ä¾›åº”ã€‚</li><li><code>cancel(reason)</code>ï¼šå¦‚æœæµè¢«å–æ¶ˆï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œä½ å¯ä»¥åœ¨æ­¤æ¸…ç†èµ„æºã€‚</li></ul></li><li><p><strong><code>strategy</code></strong> å¯¹è±¡å®šä¹‰äº†ä¸¤ä¸ªå…³é”®ç­–ç•¥ï¼š<code>highWaterMark</code> å’Œ <code>size</code> å‡½æ•°ï¼Œå®ƒä»¬ç”¨äºæ§åˆ¶æµçš„èƒŒå‹ï¼ˆbackpressureï¼‰æœºåˆ¶ï¼Œå³æ§åˆ¶æµä¸­æ•°æ®çš„é€Ÿç‡å’Œæ•°é‡ï¼Œä»¥é¿å…æ¶ˆè´¹è€…æ— æ³•è·Ÿä¸Šç”Ÿäº§è€…çš„é€Ÿåº¦å¯¼è‡´å†…å­˜ä½¿ç”¨è¿‡é«˜ã€‚</p><ul><li><code>highWaterMark</code>ï¼šè¿™æ˜¯æµå¯ä»¥ç¼“å†²çš„æ•°æ®å—çš„æœ€å¤§æ•°é‡ã€‚</li><li><code>size(chunk)</code>ï¼šè¿™æ˜¯ä¸€ä¸ªå¯é€‰çš„å‡½æ•°ï¼Œç”¨æ¥è®¡ç®—æ¯ä¸ªæ•°æ®å—çš„å¤§å°ï¼Œå¸®åŠ© <code>highWaterMark</code> æ§åˆ¶æµã€‚</li></ul></li></ul><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-1" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-1"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><h4 id="æ–‡ä»¶è¯»å–" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶è¯»å–"><span>æ–‡ä»¶è¯»å–</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨æ„å»ºä¸€ä¸ªç½‘ç«™ï¼Œéœ€è¦å°†æœåŠ¡å™¨ä¸Šçš„ä¸€ä¸ªå¤§è§†é¢‘æ–‡ä»¶å‘é€ç»™æµè§ˆå™¨ã€‚ä½¿ç”¨ <code>ReadableStream</code>ï¼Œä½ å¯ä»¥é€å—åœ°è¯»å–å¹¶å‘é€æ–‡ä»¶ï¼Œè€Œä¸å¿…ä¸€æ¬¡æ€§å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯è¯»æµæ¥é€å—è¯»å–æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/large-video.mp4</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°† Node.js çš„ stream è½¬æ¢ä¸º WHATWG ReadableStream</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> webStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipeTo</span><span style="color:#D8DEE9FF;">(</span></span>
<span class="line"><span style="color:#81A1C1;">  new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">    start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // æµåˆå§‹åŒ–æ—¶çš„æ“ä½œï¼Œä¾‹å¦‚æ—¥å¿—è®°å½•</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Stream started</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#88C0D0;">    pull</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // æ¯æ¬¡è¯·æ±‚æ•°æ®æ—¶çš„æ“ä½œï¼Œå¯ä»¥åŸºäºéœ€æ±‚åŠ¨æ€è°ƒæ•´</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#88C0D0;">    cancel</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // æ¸…ç†ä»£ç ï¼Œä¾‹å¦‚å…³é—­æ–‡ä»¶å¥æŸ„</span></span>
<span class="line"><span style="color:#D8DEE9;">      fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ•°æ®ç”Ÿæˆ" tabindex="-1"><a class="header-anchor" href="#æ•°æ®ç”Ÿæˆ"><span>æ•°æ®ç”Ÿæˆ</span></a></h4><p>æƒ³è±¡ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªè‚¡ç¥¨å¸‚åœºåº”ç”¨ï¼Œéœ€è¦å®æ—¶æ¨é€æœ€æ–°çš„è‚¡ç¥¨ä»·æ ¼ç»™å®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>ReadableStream</code> æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œæ ¹æ®å®æ—¶æ•°æ®ç”Ÿæˆæµã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> stockPriceStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // åˆå§‹åŒ–è¿æ¥åˆ°è‚¡ç¥¨ä»·æ ¼æ›´æ–°æœåŠ¡</span></span>
<span class="line"><span style="color:#88C0D0;">    connectToStockUpdateService</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">priceUpdate</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // æ¯å½“æ–°çš„ä»·æ ¼æ›´æ–°åˆ°æ¥æ—¶ï¼Œå°†å…¶åŠ å…¥åˆ°æµä¸­</span></span>
<span class="line"><span style="color:#D8DEE9;">      controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">priceUpdate</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#88C0D0;">  pull</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å¯ä»¥æ ¹æ®æ¶ˆè´¹é€Ÿåº¦è¯·æ±‚æ›´å¤šæˆ–å‡å°‘æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#88C0D0;">  cancel</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // æ–­å¼€ä¸è‚¡ç¥¨ä»·æ ¼æ›´æ–°æœåŠ¡çš„è¿æ¥</span></span>
<span class="line"><span style="color:#88C0D0;">    disconnectFromStockUpdateService</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡è¿™äº›ä¾‹å­ï¼Œä½ åº”è¯¥å¯¹å¦‚ä½•ä½¿ç”¨ Node.js ä¸­çš„ <code>ReadableStream</code> æœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„äº†è§£ã€‚è®°ä½ï¼Œæµæ˜¯å¤„ç†å¤§é‡æ•°æ®æˆ–å®æ—¶æ•°æ®çš„å¼ºå¤§å·¥å…·ï¼Œèƒ½å¤Ÿä½¿ä½ çš„åº”ç”¨æ›´åŠ é«˜æ•ˆå’Œå“åº”è¿…é€Ÿã€‚</p><h4 id="readablestream-locked" tabindex="-1"><a class="header-anchor" href="#readablestream-locked"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreamlocked" target="_blank" rel="noopener noreferrer">readableStream.locked</a></span></a></h4><p>åœ¨è§£é‡Š Node.js ä¸­çš„<code>readableStream.locked</code>å±æ€§ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£ä¸€äº›å…³é”®æ¦‚å¿µã€‚</p><h3 id="åŸºç¡€æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ"><span>åŸºç¡€æ¦‚å¿µ</span></a></h3><ol><li><p><strong>Streams</strong>: åœ¨ç¼–ç¨‹ä¸­ï¼Œæµ(Stream)æ˜¯ä¸€ç³»åˆ—æ•°æ®å…ƒç´ ï¼Œè¿™äº›æ•°æ®å…ƒç´ å¯ä»¥ä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«å¤„ç†ã€‚æƒ³è±¡ä¸€ä¸‹æ°´æµï¼Œä½ å¯ä»¥ä»ä¸­ä¸€æ¬¡å–å‡ºä¸€æ¯æ°´ï¼ˆä¸€éƒ¨åˆ†æ•°æ®ï¼‰ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§æ¶ˆè€—æ•´ä¸ªæ²³æµï¼ˆå…¨éƒ¨æ•°æ®ï¼‰ã€‚</p></li><li><p><strong>Readable Streams</strong>: è¿™æ˜¯ Node.js ä¸­çš„ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œç”¨äºä»£è¡¨å¯è¯»å–çš„æ•°æ®ã€‚æ¯”å¦‚ï¼Œå½“ä½ ä»æ–‡ä»¶è¯»å–æ•°æ®æˆ–æ¥æ”¶ç½‘ç»œè¯·æ±‚æ—¶ï¼Œè¿™äº›æ“ä½œäº§ç”Ÿçš„æ•°æ®å¯ä»¥é€šè¿‡å¯è¯»æµæ¥å¤„ç†ã€‚</p></li><li><p><strong>Web Streams API</strong>: è¿™æ˜¯æä¾›æ„å»ºå’Œæ“ä½œæµï¼ˆå¦‚æ–‡ä»¶æµã€ç½‘ç»œè¯·æ±‚ç­‰ï¼‰çš„æ ‡å‡† APIï¼Œæ—¨åœ¨ä½¿æµæ•°æ®çš„å¤„ç†æ›´åŠ é«˜æ•ˆå’Œç®€å•ã€‚Node.js ä¹Ÿå®ç°äº†è¿™å¥— APIï¼Œä»¥ä¾¿äºå¤„ç†æ•°æ®æµã€‚</p></li></ol><h3 id="readablestream-locked-1" tabindex="-1"><a class="header-anchor" href="#readablestream-locked-1"><span><code>readableStream.locked</code></span></a></h3><p>ç°åœ¨ï¼Œè°ˆåˆ°<code>readableStream.locked</code>ï¼š</p><ul><li><p><strong>æ„ä¹‰</strong>: <code>readableStream.locked</code>æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼ˆBooleanï¼‰å±æ€§ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ª<code>ReadableStream</code>å¯¹è±¡æ˜¯å¦è¢«é”å®šã€‚å¦‚æœä¸€ä¸ªæµè¢«é”å®šï¼Œæ„å‘³ç€å½“å‰æœ‰ä¸€äº›æ“ä½œæ­£åœ¨ä½¿ç”¨è¿™ä¸ªæµï¼Œå› æ­¤ä½ ä¸èƒ½ç›´æ¥å¯¹å…¶è¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚è¯»å–æˆ–å–æ¶ˆã€‚</p></li><li><p><strong>ä½•æ—¶ä½¿ç”¨</strong>: å½“ä½ åœ¨æ“ä½œä¸€ä¸ªæµæ—¶ï¼Œå¯èƒ½éœ€è¦åˆ¤æ–­è¿™ä¸ªæµæ˜¯å¦å·²ç»è¢«å…¶ä»–æ“ä½œé”å®šã€‚ä½¿ç”¨<code>readableStream.locked</code>å¯ä»¥å¸®åŠ©ä½ é¿å…å†²çªï¼Œç¡®ä¿æ•°æ®çš„é¡ºåºå’Œå®Œæ•´æ€§ã€‚</p></li></ul><h3 id="å®é™…ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­"><span>å®é™…ä¾‹å­</span></a></h3><ol><li><p><strong>è¯»å–æ–‡ä»¶</strong>: å‡è®¾ä½ æœ‰ä¸€ä¸ªå¤§å‹æ—¥å¿—æ–‡ä»¶ï¼Œä½ æƒ³é€è¡Œè¯»å–è¿™ä¸ªæ–‡ä»¶è¿›è¡Œåˆ†æã€‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª<code>ReadableStream</code>æ¥è¯»å–è¿™ä¸ªæ–‡ä»¶ï¼Œç„¶åé€šè¿‡æ£€æŸ¥<code>readableStream.locked</code>å±æ€§æ¥ç¡®ä¿æµåœ¨å¼€å§‹è¯»å–æ—¶æ²¡æœ‰è¢«å…¶ä»–æ“ä½œé”å®šã€‚</p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> readFile</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">filePath</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">filePath</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">Stream locked: </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">readable</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">locked</span><span style="color:#81A1C1;">}</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºæµçš„é”å®šçŠ¶æ€</span></span>
<span class="line"><span style="color:#616E88;">  // æ¥ä¸‹æ¥å¯ä»¥å®‰å…¨åœ°è¯»å–æµ</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">readFile</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./path/to/your/logfile.log</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>ç½‘ç»œè¯·æ±‚å¤„ç†</strong>: å½“å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„ HTTP è¯·æ±‚æ—¶ï¼Œè¯·æ±‚ä½“å¯ä»¥è¢«è§†ä¸ºä¸€ä¸ª<code>ReadableStream</code>ã€‚æ£€æŸ¥<code>readableStream.locked</code>å¯ä»¥å¸®åŠ©ç¡®å®šè¯·æ±‚ä½“æ˜¯å¦æ­£åœ¨è¢«è¯»å–æˆ–è€…æ˜¯å¦å¯ä»¥å®‰å…¨åœ°å¼€å§‹è¯»å–ã€‚</p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> http</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">http</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">http</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">createServer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">req</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> res</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">req</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">readable</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">locked</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">      // è¯·æ±‚ä½“æœªé”å®šï¼Œå¯ä»¥å®‰å…¨è¯»å–</span></span>
<span class="line"><span style="color:#81A1C1;">      let</span><span style="color:#D8DEE9;"> requestBody</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">      req</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        requestBody</span><span style="color:#81A1C1;"> +=</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">      req</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">end</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">requestBody</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Received</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // è¯·æ±‚ä½“å·²é”å®šï¼Œå¯èƒ½æ­£åœ¨è¢«å…¶ä»–æ“ä½œå¤„ç†</span></span>
<span class="line"><span style="color:#D8DEE9;">      res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Request body is locked</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">listen</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">3000</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°<code>readableStream.locked</code>å¦‚ä½•åœ¨å¤„ç†æ–‡ä»¶å’Œç½‘ç»œè¯·æ±‚æ—¶æä¾›é‡è¦ä¿¡æ¯ï¼Œä»¥ç¡®ä¿æµçš„æ“ä½œä¸ä¼šäº’ç›¸å¹²æ‰°ï¼Œæé«˜ä»£ç çš„å¥å£®æ€§ä¸å®‰å…¨æ€§ã€‚</p><h4 id="readablestream-cancel-reason" tabindex="-1"><a class="header-anchor" href="#readablestream-cancel-reason"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreamcancelreason" target="_blank" rel="noopener noreferrer">readableStream.cancel([reason])</a></span></a></h4><p>Node.js ä¸­çš„<code>readableStream.cancel([reason])</code>æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºå–æ¶ˆä¸€ä¸ªå¯è¯»æµï¼ˆReadableStreamï¼‰çš„è¯»å–æ“ä½œã€‚è¿™æ„å‘³ç€å¦‚æœä½ å·²ç»å¼€å§‹ä»æŸä¸ªæ¥æºï¼ˆæ¯”å¦‚æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚ç­‰ï¼‰è¯»å–æ•°æ®ï¼Œä½†å‡ºäºæŸç§åŸå› éœ€è¦åœæ­¢ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•æ¥å®ç°ã€‚</p><p>åœ¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€é‡Œï¼Œä½ å¯ä»¥æŠŠ<code>ReadableStream</code>æƒ³è±¡æˆä¸€æœ¬ä¹¦ï¼Œè€Œ<code>readableStream.cancel([reason])</code>å°±åƒæ˜¯ä½ å†³å®šä¸å†ç»§ç»­é˜…è¯»è¿™æœ¬ä¹¦ï¼Œå¯èƒ½æ˜¯å› ä¸ºä½ æ‰¾åˆ°äº†æ›´æ„Ÿå…´è¶£çš„ä¹¦ï¼Œæˆ–è€…æ˜¯å› ä¸ºä½ æ²¡æœ‰æ—¶é—´ç»§ç»­é˜…è¯»äº†ã€‚</p><h3 id="å‚æ•°" tabindex="-1"><a class="header-anchor" href="#å‚æ•°"><span>å‚æ•°</span></a></h3><ul><li><code>reason</code> (å¯é€‰): è¿™æ˜¯ä¸€ä¸ªè¯´æ˜å–æ¶ˆåŸå› çš„å‚æ•°ï¼Œå®ƒå¯ä»¥å¸®åŠ©æ¥æ”¶æ–¹ç†è§£ä¸ºä»€ä¹ˆæµè¢«å–æ¶ˆäº†ã€‚</li></ul><h3 id="è¿”å›å€¼" tabindex="-1"><a class="header-anchor" href="#è¿”å›å€¼"><span>è¿”å›å€¼</span></a></h3><p>è°ƒç”¨<code>cancel</code>æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œè¿™ä¸ª Promise å¯¹è±¡åœ¨æµæˆåŠŸå–æ¶ˆæ—¶è§£æã€‚</p><h3 id="å®é™…åº”ç”¨ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ä¾‹å­"><span>å®é™…åº”ç”¨ä¾‹å­</span></a></h3><h4 id="_1-å–æ¶ˆæ–‡ä»¶è¯»å–" tabindex="-1"><a class="header-anchor" href="#_1-å–æ¶ˆæ–‡ä»¶è¯»å–"><span>1. å–æ¶ˆæ–‡ä»¶è¯»å–</span></a></h4><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªé€šè¿‡ Node.js åˆ›å»ºçš„ç¨‹åºï¼Œè¿™ä¸ªç¨‹åºæ­£åœ¨ä»ä¸€ä¸ªå¤§æ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚çªç„¶ï¼Œç”¨æˆ·æƒ³è¦æ‰§è¡Œå¦ä¸€ä¸ªä»»åŠ¡ï¼Œä¸å†éœ€è¦ç»§ç»­è¯»å–æ–‡ä»¶ã€‚è¿™æ—¶ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨<code>readableStream.cancel()</code>æ–¹æ³•æ¥åœæ­¢è¯»å–æ–‡ä»¶ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯è¯»æµæ¥è¯»å–æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾å‡ºäºæŸç§åŸå› éœ€è¦å–æ¶ˆè¯»å–</span></span>
<span class="line"><span style="color:#D8DEE9;">readableStream</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">cancel</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">User requested to cancel the reading</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Reading has been successfully cancelled</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Failed to cancel reading</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-å–æ¶ˆç½‘ç»œè¯·æ±‚" tabindex="-1"><a class="header-anchor" href="#_2-å–æ¶ˆç½‘ç»œè¯·æ±‚"><span>2. å–æ¶ˆç½‘ç»œè¯·æ±‚</span></a></h4><p>å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ Node.js è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼Œå¹¶ä¸”ä»å“åº”ä¸­è¯»å–æ•°æ®ä½œä¸ºæµï¼Œä½†æ˜¯ç”¨æˆ·çªç„¶ä¸æƒ³è¦è¿™äº›æ•°æ®äº†ï¼Œæˆ–è€…ä½ æƒ³æ ¹æ®æŸç§é€»è¾‘æå‰ç»“æŸè¯»å–ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>readableStream.cancel()</code>æ¥å–æ¶ˆè¿™ä¸ªæ“ä½œã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾æˆ‘ä»¬ä½¿ç”¨fetch API (éœ€è¦å¤–éƒ¨åº“æ”¯æŒ)</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fetch</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node-fetch</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> fetchData</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> response</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#88C0D0;"> fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://example.com</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> bodyStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // å‡ºäºæŸç§åŸå› å–æ¶ˆè¯»å–</span></span>
<span class="line"><span style="color:#D8DEE9;">  bodyStream</span></span>
<span class="line"><span style="color:#ECEFF4;">    .</span><span style="color:#88C0D0;">cancel</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">No longer need the data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">    .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Successfully cancelled the stream</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">    .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Error cancelling the stream</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">fetchData</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸¤ä¸ªä¾‹å­å±•ç¤ºäº†æ€æ ·åœ¨ä¸åŒåœºæ™¯ä¸‹ä½¿ç”¨<code>readableStream.cancel([reason])</code>æ¥å–æ¶ˆè¯»å–æ“ä½œï¼Œæ— è®ºæ˜¯å¤„ç†æœ¬åœ°æ–‡ä»¶è¿˜æ˜¯å¤„ç†ç½‘ç»œè¯·æ±‚çš„å“åº”ã€‚è¿™åœ¨å¼€å‘ä¸­æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤§é‡æ•°æ®æˆ–è€…éœ€è¦å¿«é€Ÿå“åº”ç”¨æˆ·æ“ä½œçš„æ—¶å€™ã€‚</p><h4 id="readablestream-getreader-options" tabindex="-1"><a class="header-anchor" href="#readablestream-getreader-options"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreamgetreaderoptions" target="_blank" rel="noopener noreferrer">readableStream.getReader([options])</a></span></a></h4><p>Node.js ä¸­çš„<code>readableStream.getReader([options])</code>æ˜¯å¤„ç†æµæ•°æ®çš„ä¸€ä¸ªé‡è¦æ–¹æ³•ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½ éœ€è¦ä»æµä¸­è¯»å–æ•°æ®æ—¶ã€‚ä¸ºäº†è®©è§£é‡Šæ›´é€šä¿—æ˜“æ‡‚ï¼Œæˆ‘ä¼šå…ˆç®€å•ä»‹ç»ä»€ä¹ˆæ˜¯æµï¼ˆStreamsï¼‰ï¼Œç„¶åå†æ·±å…¥åˆ°<code>getReader</code>æ–¹æ³•åŠå…¶å®é™…åº”ç”¨ã€‚</p><h3 id="æµ-streams-æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#æµ-streams-æ˜¯ä»€ä¹ˆ"><span>æµï¼ˆStreamsï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ</span></a></h3><p>æƒ³è±¡ä¸€ä¸‹æ°´æµã€‚å¦‚æœä½ æœ‰ä¸€ä¸ªå¤§æ¡¶çš„æ°´ï¼Œè€Œä½ éœ€è¦æŠŠè¿™æ°´ç§»åŠ¨åˆ°å¦å¤–ä¸€ä¸ªåœ°æ–¹ï¼Œä½ å¯ä»¥é€‰æ‹©ä¸€æ¬¡æ€§å€’è¿‡å»ï¼Œæˆ–è€…ä½ å¯ä»¥é€‰æ‹©ç”¨ä¸€ä¸ªç®¡å­è®©æ°´æµè¿‡å»ã€‚åœ¨ç¼–ç¨‹ä¸­ï¼Œç‰¹åˆ«æ˜¯å¤„ç†å¤§é‡æ•°æ®æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿé‡‡ç”¨ç±»ä¼¼â€œç®¡å­â€çš„æ¦‚å¿µï¼Œè¿™å°±æ˜¯æ‰€è°“çš„æµã€‚é€šè¿‡æµï¼Œæ•°æ®å¯ä»¥ä»ä¸€ä¸ªåœ°æ–¹â€œæµå‘â€å¦ä¸€ä¸ªåœ°æ–¹ï¼Œè€Œä¸éœ€è¦ä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨æ•°æ®åˆ°å†…å­˜ä¸­ï¼Œè¿™å¯¹äºå¤„ç†æ–‡ä»¶è¯»å†™ã€ç½‘ç»œé€šä¿¡ç­‰å¤§æ•°æ®æ“ä½œéå¸¸æœ‰æ•ˆå’Œé«˜æ•ˆã€‚</p><h3 id="readablestream-getreader-options-1" tabindex="-1"><a class="header-anchor" href="#readablestream-getreader-options-1"><span><code>readableStream.getReader([options])</code></span></a></h3><p>è¿™ä¸ªæ–¹æ³•å…è®¸ä½ ä»¥å¼‚æ­¥çš„æ–¹å¼ä»ä¸€ä¸ªå¯è¯»æµä¸­è¯»å–æ•°æ®ã€‚å½“ä½ è°ƒç”¨<code>getReader</code>æ–¹æ³•æ—¶ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª<code>ReadableStreamDefaultReader</code>å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ªå¯¹è±¡ï¼Œä½ å¯ä»¥é€å—ï¼ˆchunkï¼‰åœ°è¯»å–æ•°æ®æµã€‚</p><h4 id="å‚æ•°-1" tabindex="-1"><a class="header-anchor" href="#å‚æ•°-1"><span>å‚æ•°</span></a></h4><ul><li><code>options</code>ï¼ˆå¯é€‰ï¼‰: æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­å¯ä»¥åŒ…å«ä¸€ä¸ªå±æ€§<code>mode</code>ã€‚å¦‚æœ<code>mode</code>è®¾ç½®ä¸º<code>&#39;byob&#39;</code>ï¼ˆBring Your Own Bufferï¼‰ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨è‡ªå·±æä¾›çš„ç¼“å†²åŒºæ¥è¯»å–æµï¼Œè¿™å¯¹äºæ§åˆ¶å†…å­˜ä½¿ç”¨éå¸¸æœ‰å¸®åŠ©ã€‚</li></ul><h4 id="è¿”å›å€¼-1" tabindex="-1"><a class="header-anchor" href="#è¿”å›å€¼-1"><span>è¿”å›å€¼</span></a></h4><ul><li>è¿”å›çš„æ˜¯<code>ReadableStreamDefaultReader</code>å¯¹è±¡ï¼Œé€šè¿‡å®ƒä½ å¯ä»¥é€æ­¥è¯»å–æµä¸­çš„æ•°æ®ã€‚</li></ul><h3 id="ç¤ºä¾‹åº”ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹åº”ç”¨åœºæ™¯"><span>ç¤ºä¾‹åº”ç”¨åœºæ™¯</span></a></h3><ol><li><p><strong>æ–‡ä»¶è¯»å–</strong>ï¼šå‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦ä»ä¸€ä¸ªå¤§æ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚ç›´æ¥ä¸€æ¬¡æ€§è¯»å–æ•´ä¸ªæ–‡ä»¶å¯èƒ½ä¼šæ¶ˆè€—å¤§é‡çš„å†…å­˜ã€‚ä½¿ç”¨<code>readableStream.getReader()</code>æ–¹æ³•ï¼Œä½ å¯ä»¥é€æ­¥è¯»å–æ–‡ä»¶ï¼Œå‡å°‘å†…å­˜å ç”¨ã€‚</p></li><li><p><strong>ç½‘ç»œè¯·æ±‚å“åº”</strong>ï¼šåœ¨è¿›è¡Œ HTTP è¯·æ±‚æ—¶ï¼Œç‰¹åˆ«æ˜¯è¯·æ±‚å¤§é‡æ•°æ®ï¼ˆå¦‚è§†é¢‘æµï¼‰æ—¶ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šä»¥æµçš„å½¢å¼å‘é€æ•°æ®ã€‚é€šè¿‡<code>getReader</code>æ–¹æ³•ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€æ¸æ¥æ”¶å¹¶å¤„ç†è¿™äº›æ•°æ®ï¼Œè€Œä¸æ˜¯ç­‰å¾…æ•´ä¸ªæ•°æ®ä¸‹è½½å®Œæˆã€‚</p></li></ol><h4 id="ä»£ç ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ä»£ç ç¤ºä¾‹"><span>ä»£ç ç¤ºä¾‹</span></a></h4><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨å¤„ç†ä¸€ä¸ªæ¥è‡ªç½‘ç»œè¯·æ±‚çš„å¯è¯»æµï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> fetchAndReadFromStream</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // å‘èµ·ç½‘ç»œè¯·æ±‚è·å–å“åº”æµ</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> response</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#88C0D0;"> fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">    // è¯»å–æ•°æ®æµçš„ä¸‹ä¸€ä¸ªç‰‡æ®µ</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æ•°æ®å·²å…¨éƒ¨è¯»å–å®Œæˆ</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">      break;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // å¤„ç†å½“å‰ç‰‡æ®µçš„æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> TextDecoder</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">utf-8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">decode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨å‡½æ•°ï¼Œå‚æ•°ä¸ºç›®æ ‡URL</span></span>
<span class="line"><span style="color:#88C0D0;">fetchAndReadFromStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://example.com/some-large-data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>getReader</code>è·å–äº†å“åº”ä½“çš„è¯»å–å™¨ï¼ˆ<code>reader</code>ï¼‰ï¼Œç„¶åä½¿ç”¨<code>while</code>å¾ªç¯å’Œ<code>await reader.read()</code>é€æ­¥è¯»å–æ•°æ®ã€‚æ¯æ¬¡å¾ªç¯æˆ‘ä»¬éƒ½æ£€æŸ¥<code>done</code>æ˜¯å¦ä¸ºçœŸï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¡¨ç¤ºæ‰€æœ‰æ•°æ®éƒ½å·²è¯»å–å®Œæ¯•ï¼Œå¾ªç¯ç»“æŸã€‚å¦åˆ™ï¼Œæˆ‘ä»¬å¤„ç†å½“å‰è¯»å–åˆ°çš„æ•°æ®ç‰‡æ®µã€‚</p><p>é€šè¿‡ä»¥ä¸Šä¾‹å­å’Œè§£é‡Šï¼Œå¸Œæœ›ä½ èƒ½å¯¹<code>readableStream.getReader([options])</code>æœ‰äº†æ›´æ¸…æ™°çš„ç†è§£ã€‚</p><h4 id="readablestream-pipethrough-transform-options" tabindex="-1"><a class="header-anchor" href="#readablestream-pipethrough-transform-options"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreampipethroughtransform-options" target="_blank" rel="noopener noreferrer">readableStream.pipeThrough(transform[, options])</a></span></a></h4><p>Node.js çš„ <code>readableStream.pipeThrough(transform[, options])</code> æ–¹æ³•æ˜¯ä¸€ä¸ªç”¨äºå¤„ç†æµæ•°æ®çš„å¼ºå¤§å·¥å…·ã€‚ä¸ºäº†è§£é‡Šè¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ç†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š<strong>æµï¼ˆStreamsï¼‰</strong>ã€<strong>å¯è¯»æµï¼ˆReadable Streamsï¼‰</strong>ã€å’Œ <strong>Transform æµï¼ˆTransform Streamsï¼‰</strong>ã€‚</p><h3 id="åŸºç¡€æ¦‚å¿µ-1" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ-1"><span>åŸºç¡€æ¦‚å¿µ</span></a></h3><ol><li><p><strong>æµï¼ˆStreamsï¼‰</strong>: åœ¨ç¼–ç¨‹ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨ Node.js ä¸­ï¼Œæµæ˜¯ä¸€ç³»åˆ—æ•°æ®å…ƒç´ ï¼Œå®ƒä»¬å¯ä»¥ä½œä¸ºä¸€ä¸ªè¿ç»­çš„åºåˆ—è¿›è¡Œå¤„ç†ã€‚æƒ³è±¡æˆæ°´æµï¼Œä½ å¯ä»¥ä»ä¸­é€æ¸æå‡ºæ°´ä¸­çš„ç‰©ä½“ï¼Œè€Œä¸æ˜¯ç­‰å¾…æ•´ä¸ªæ± å¡˜è¢«æŠ½å¹²åå†å»æ¡ã€‚</p></li><li><p><strong>å¯è¯»æµï¼ˆReadable Streamsï¼‰</strong>: è¿™æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œä½ å¯ä»¥ä»ä¸­è¯»å–æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå½“ä½ ä»æ–‡ä»¶è¯»å–æ•°æ®æ—¶ï¼Œå¯ä»¥å°†å…¶è§†ä¸ºä¸€ä¸ªå¯è¯»æµã€‚</p></li><li><p><strong>Transform æµï¼ˆTransform Streamsï¼‰</strong>: è¿™ç§æµæ—¢å¯ä»¥è¯»å–æ•°æ®ï¼ˆå¯è¯»éƒ¨åˆ†ï¼‰ï¼Œä¹Ÿå¯ä»¥å†™å…¥æ•°æ®ï¼ˆå¯å†™éƒ¨åˆ†ï¼‰ï¼Œå¹¶åœ¨å†™å…¥å’Œè¯»å–é—´è½¬æ¢æˆ–å¤„ç†æ•°æ®ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½æœ‰ä¸€ä¸ªå°†æ–‡æœ¬ä¸­çš„å°å†™å­—æ¯è½¬æ¢ä¸ºå¤§å†™å­—æ¯çš„ Transform æµã€‚</p></li></ol><h3 id="readablestream-pipethrough-transform-options-1" tabindex="-1"><a class="header-anchor" href="#readablestream-pipethrough-transform-options-1"><span><code>readableStream.pipeThrough(transform[, options])</code></span></a></h3><p>è¿™ä¸ªæ–¹æ³•å…è®¸ä½ å°†ä¸€ä¸ªå¯è¯»æµé€šè¿‡ä¸€ä¸ªæˆ–å¤šä¸ª transform æµè¿›è¡Œå¤„ç†ï¼Œå¹¶äº§ç”Ÿä¸€ä¸ªæ–°çš„å¯è¯»æµã€‚è¿™å¯¹äºæ•°æ®å¤„ç†æ¥è¯´éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºä½ å¯ä»¥å°†æ•°æ®é€šè¿‡ç®¡é“ä¼ é€åˆ°ä¸åŒçš„æ“ä½œä¸­ï¼Œæ¯ä¸ªæ“ä½œå¯¹æ•°æ®è¿›è¡Œä¿®æ”¹æˆ–è½¬æ¢ï¼Œç„¶åè¾“å‡ºç»™ä¸‹ä¸€ä¸ªæ“ä½œã€‚</p><h4 id="å‚æ•°-2" tabindex="-1"><a class="header-anchor" href="#å‚æ•°-2"><span>å‚æ•°</span></a></h4><ul><li><code>transform</code>: ä¸€ä¸ª TransformStream å¯¹è±¡ï¼Œæˆ–è€…ä»»ä½•æ‹¥æœ‰å¯è¯»å’Œå¯å†™éƒ¨åˆ†çš„å¯¹è±¡ã€‚</li><li><code>options</code>: é…ç½®å‚æ•°ï¼ˆå¯é€‰ï¼‰ï¼Œç”¨äºæ§åˆ¶æµçš„è¡Œä¸ºï¼Œæ¯”å¦‚é«˜æ°´ä½çº¿ï¼ˆæ§åˆ¶åå‹çš„æœºåˆ¶ï¼‰ã€‚</li></ul><h4 id="ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­"><span>ä¾‹å­</span></a></h4><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼ˆlog.txtï¼‰ï¼Œä½ æƒ³è¯»å–å®ƒçš„å†…å®¹ï¼Œå°†æ‰€æœ‰æ–‡æœ¬è½¬æ¢ä¸ºå¤§å†™ï¼Œç„¶åä¿å­˜åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚</p><ol><li><strong>åˆ›å»ºä¸€ä¸ªå¯è¯»æµ</strong> æ¥ä»åŸå§‹æ–‡ä»¶è¯»å–æ•°æ®ã€‚</li><li><strong>åˆ›å»ºä¸€ä¸ª Transform æµ</strong> æ¥è½¬æ¢æ•°æ®ï¼ˆå³ï¼ŒæŠŠå°å†™å­—æ¯å˜æˆå¤§å†™å­—æ¯ï¼‰ã€‚</li><li><strong>ä½¿ç”¨ pipeThrough()</strong> å°†å¯è¯»æµé€šè¿‡ Transform æµä¼ è¾“ï¼Œå¾—åˆ°è½¬æ¢åçš„æ•°æ®æµã€‚</li><li><strong>è¾“å‡ºæ•°æ®</strong> åˆ°æ–°æ–‡ä»¶ã€‚</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TransformStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ª Transform æµï¼Œç”¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºå¤§å†™</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> toUpperCaseTransform</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TransformStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  transform</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // è½¬æ¢ä¸ºå¤§å†™å¹¶ä¼ é€’ç»™ä¸‹ä¸€ä¸ªç¯èŠ‚</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toUpperCase</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯è¯»æµæ¥è¯»å–æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">log.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨ pipeThrough æ–¹æ³•å°†æ•°æ®é€šè¿‡ Transform æµè¿›è¡Œå¤„ç†</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> transformedStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipeThrough</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">toUpperCaseTransform</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è¾“å‡ºè½¬æ¢åçš„æ•°æ®åˆ°æ–°æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">log-uppercase.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">transformedStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipeTo</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">writableStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡ <code>fs.createReadStream</code> åˆ›å»ºäº†ä¸€ä¸ªå¯è¯»æµæ¥è¯»å– &#39;log.txt&#39; æ–‡ä»¶ã€‚ç„¶åå®šä¹‰äº†ä¸€ä¸ª Transform æµ <code>toUpperCaseTransform</code>ï¼Œå®ƒæŠŠè¾“å…¥æ–‡æœ¬è½¬æ¢æˆå¤§å†™ã€‚ä¹‹åï¼Œæˆ‘ä»¬åˆ©ç”¨ <code>pipeThrough()</code> æ–¹æ³•æŠŠå¯è¯»æµè¿æ¥è‡³ Transform æµï¼Œæœ€ç»ˆçš„è¾“å‡ºæ˜¯è½¬æ¢åçš„æ•°æ®æµã€‚è¿™ä¸ªè½¬æ¢åçš„æµè¢«å¯¼å…¥åˆ° &#39;log-uppercase.txt&#39; æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ <code>fs.createWriteStream</code>ã€‚</p><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥è½»æ¾åœ°ä¸ºæ•°æ®å¤„ç†åˆ›å»ºå¤æ‚çš„ç®¡é“æ“ä½œï¼Œæ¯ä¸€ä¸ªæ“ä½œéƒ½å¯ä»¥ç®€å•åœ°é€šè¿‡å¢åŠ æ›´å¤šçš„ <code>.pipeThrough()</code> è°ƒç”¨æ¥æ‰©å±•ã€‚</p><h4 id="readablestream-pipeto-destination-options" tabindex="-1"><a class="header-anchor" href="#readablestream-pipeto-destination-options"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreampipetodestination-options" target="_blank" rel="noopener noreferrer">readableStream.pipeTo(destination[, options])</a></span></a></h4><p>äº†è§£ <code>readableStream.pipeTo(destination[, options])</code> åŠŸèƒ½ä¹‹å‰ï¼Œä½ éœ€è¦å…ˆæ˜ç™½å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š</p><ol><li><p><strong>æµï¼ˆStreamsï¼‰</strong>ï¼šåœ¨ Node.js ä¸­ï¼Œæµæ˜¯ä¸€ç§å¤„ç†æ•°æ®çš„æ–¹å¼ï¼Œå°¤å…¶æ˜¯å½“ä½ ä¸éœ€è¦ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­æ—¶ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰ä¸€æ¡æ°´ç®¡ï¼Œæ°´ï¼ˆæ•°æ®ï¼‰å¯ä»¥ä»ä¸€ç«¯æµåˆ°å¦ä¸€ç«¯ã€‚</p></li><li><p><strong>å¯è¯»æµï¼ˆReadable Streamï¼‰</strong>ï¼šè¿™æ˜¯ä¸€ç§æ•°æ®çš„æ¥æºã€‚æ¯”å¦‚è¯´ï¼Œä»æ–‡ä»¶è¯»å–æ•°æ®æ—¶ï¼Œæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªå¯è¯»æµçš„æ¥æºã€‚</p></li><li><p><strong>å¯å†™æµï¼ˆWritable Streamï¼‰</strong>ï¼šè¿™æ˜¯æ•°æ®çš„ç»ˆç‚¹ã€‚æ¯”å¦‚è¯´ï¼ŒæŠŠæ•°æ®å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆè¯¥æ–‡ä»¶å°±æ˜¯ä¸€ä¸ªå¯å†™æµçš„æ¥æ”¶è€…ã€‚</p></li></ol><p>ç°åœ¨æ¥è°ˆè°ˆ <code>readableStream.pipeTo(destination[, options])</code> çš„å…·ä½“å†…å®¹ã€‚</p><h3 id="å®šä¹‰" tabindex="-1"><a class="header-anchor" href="#å®šä¹‰"><span>å®šä¹‰</span></a></h3><p>è¿™ä¸ªæ–¹æ³•å…è®¸ä½ å°†ä¸€ä¸ªå¯è¯»æµï¼ˆ<code>readableStream</code>ï¼‰ä¸­çš„æ•°æ®ç›´æ¥ä¼ è¾“åˆ°ä¸€ä¸ªå¯å†™æµï¼ˆ<code>destination</code>ï¼‰ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯è‡ªåŠ¨åŒ–çš„ï¼Œä½ ä¸éœ€è¦æ‰‹åŠ¨è¯»å–æ•°æ®ç„¶åå†å†™å…¥ï¼Œ<code>pipeTo</code> æ–¹æ³•ä¼šå¤„ç†å¥½ä¸€åˆ‡ã€‚</p><h3 id="å‚æ•°-3" tabindex="-1"><a class="header-anchor" href="#å‚æ•°-3"><span>å‚æ•°</span></a></h3><ul><li><code>destination</code>ï¼šè¿™æ˜¯ä½ æƒ³è¦æ•°æ®æµå‘çš„ç›®æ ‡å¯å†™æµã€‚</li><li><code>[options]</code>ï¼šè¿™æ˜¯ä¸€ä¸ªå¯é€‰å‚æ•°ï¼Œå…è®¸ä½ å®šåˆ¶æ“ä½œçš„è¡Œä¸ºï¼Œæ¯”å¦‚è®¾ç½®å¦‚ä½•å¤„ç†èƒŒå‹ï¼ˆbackpressureï¼Œå³å½“æ•°æ®ç”Ÿäº§é€Ÿåº¦è¶…è¿‡æ¶ˆè´¹é€Ÿåº¦æ—¶çš„æƒ…å†µï¼‰ç­‰ã€‚</li></ul><h3 id="ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹"><span>ç¤ºä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦ä»æŸä¸ª URL ä¸‹è½½å›¾ç‰‡ç„¶åä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ä¸­ã€‚è¿™é‡Œå°±å¯ä»¥ä½¿ç”¨ <code>readableStream.pipeTo(destination)</code>ã€‚</p><h4 id="ç¤ºä¾‹ä»£ç " tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹ä»£ç "><span>ç¤ºä¾‹ä»£ç ï¼š</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fetch</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node-fetch</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡è®¾ä½¿ç”¨ node-fetch æ¥å‘èµ·ç½‘ç»œè¯·æ±‚</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> downloadImage</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> outputPath</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> response</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#88C0D0;"> fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // ä»URLè·å–å“åº”æµ</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">outputPath</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // åˆ›å»ºæŒ‡å‘è¾“å‡ºæ–‡ä»¶çš„å¯å†™æµ</span></span>
<span class="line"><span style="color:#81A1C1;">  if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">pipeTo</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipeTo</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">fileStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // ä½¿ç”¨ pipeTo å°†å“åº”æµç›´æ¥å¯¼å…¥æ–‡ä»¶æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Image downloaded and saved to </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9;"> outputPath</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#A3BE8C;">The fetched resource does not support readableStream.pipeTo</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    )</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è°ƒç”¨å‡½æ•°ä¸‹è½½å›¾ç‰‡</span></span>
<span class="line"><span style="color:#88C0D0;">downloadImage</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://example.com/someimage.png</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">./downloaded_image.png</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šä¾‹å­ç®€æ´åœ°å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ <code>pipeTo</code> å°†ä¸€ä¸ªæ¥è‡ªäº’è”ç½‘çš„å¯è¯»æµç›´æ¥ä¼ è¾“åˆ°æœ¬åœ°æ–‡ä»¶çš„å¯å†™æµä¸­ï¼Œçœå»äº†æ‰‹åŠ¨å¤„ç†æ•°æ®æµè½¬çš„å¤æ‚æ€§ã€‚è¿™åªæ˜¯ <code>readableStream.pipeTo</code> æ–¹æ³•ä¼—å¤šåº”ç”¨åœºæ™¯ä¸­çš„ä¸€ç§ç¤ºä¾‹ã€‚</p><p>è®°ä½ï¼Œ<code>pipeTo</code> æ˜¯ä¸€ç§é«˜æ•ˆå¤„ç†æµæ•°æ®çš„æ–¹å¼ï¼Œç‰¹åˆ«é€‚åˆäºæ–‡ä»¶æ“ä½œã€ç½‘ç»œé€šä¿¡ç­‰åœºæ™¯ï¼Œåœ¨ Node.js åº”ç”¨ä¸­ç»å¸¸è¢«ç”¨åˆ°ã€‚</p><h4 id="readablestream-tee" tabindex="-1"><a class="header-anchor" href="#readablestream-tee"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreamtee" target="_blank" rel="noopener noreferrer">readableStream.tee()</a></span></a></h4><p>å½“ç„¶ï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£ä¸€ä¸‹ Node.js ä¸­çš„ <code>readableStream.tee()</code> æ–¹æ³•åŠå…¶åº”ç”¨ã€‚</p><h3 id="åŸºæœ¬æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ¦‚å¿µ"><span>åŸºæœ¬æ¦‚å¿µ</span></a></h3><p>åœ¨ç†è§£ <code>readableStream.tee()</code> ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦çŸ¥é“ä»€ä¹ˆæ˜¯æµï¼ˆStreamï¼‰ã€‚åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œæµæ˜¯æ•°æ®çš„ä¸€ä¸ªåºåˆ—ï¼Œå¯ä»¥åˆ†ä¸ºå¯è¯»æµã€å¯å†™æµç­‰ã€‚Node.js ä½¿ç”¨æµæ¥å¤„ç†å¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œé€šä¿¡ç­‰è¿‡ç¨‹ä¸­çš„æ•°æ®ä¼ è¾“ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥è¾ƒå°‘å†…å­˜çš„ä½¿ç”¨ï¼Œæé«˜ç¨‹åºçš„æ•ˆç‡ï¼Œå°¤å…¶æ˜¯å¤„ç†å¤§é‡æ•°æ®æ—¶ã€‚</p><p><code>readableStream</code> æ˜¯ Node.js ä¸­çš„å¯è¯»æµå¯¹è±¡ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªå°†è¦è¯»å–çš„æ•°æ®æºå¤´ã€‚</p><h3 id="readablestream-tee-1" tabindex="-1"><a class="header-anchor" href="#readablestream-tee-1"><span><code>readableStream.tee()</code></span></a></h3><p><code>readableStream.tee()</code> æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒèƒ½å¤ŸåŸºäºåŸæœ‰çš„å¯è¯»æµåˆ›å»ºä¸¤ä¸ªæ–°çš„ã€ç›¸åŒå†…å®¹çš„å¯è¯»æµã€‚è¿™ä¸ªæ–¹æ³•çš„çµæ„Ÿæ¥æºäºâ€œT å‹æ¥å¤´â€ï¼ˆtee junctionï¼‰åœ¨ç®¡é“ç³»ç»Ÿä¸­çš„åº”ç”¨ï¼Œå³ä»å•ä¸€æ¥æºåˆ†è£‚å‡ºä¸¤æ¡è·¯å¾„ï¼Œæµä½“å¯ä»¥åŒæ—¶æµå‘ä¸¤ä¸ªæ–¹å‘ã€‚åœ¨ Node.js çš„æ•°æ®æµä¸­ï¼Œ<code>tee</code> æ–¹æ³•æ­£æ˜¯ç”¨æ¥åšåŒæ ·çš„äº‹æƒ…ï¼šå°†æ•°æ®æµåˆ†å²”ï¼Œä»è€Œèƒ½å¤Ÿè®©æ•°æ®åŒæ—¶è¢«ä¸¤ä¸ªç‹¬ç«‹å¤„ç†æµç¨‹æ‰€å¤„ç†ï¼Œè€Œä¸ä¼šäº’ç›¸å¹²æ‰°ã€‚</p><h3 id="åº”ç”¨åœºæ™¯å’Œä¾‹å­" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨åœºæ™¯å’Œä¾‹å­"><span>åº”ç”¨åœºæ™¯å’Œä¾‹å­</span></a></h3><p>è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªå®é™…çš„åº”ç”¨åœºæ™¯ï¼š</p><ol><li><p><strong>æ—¥å¿—è®°å½•</strong>ï¼šå‡è®¾ä½ æ­£åœ¨ä»ä¸€ä¸ªæ–‡ä»¶æµä¸­è¯»å–æ•°æ®è¿›è¡Œå¤„ç†ï¼Œå¹¶ä¸”å¸Œæœ›åœ¨å¤„ç†çš„åŒæ—¶ï¼Œå°†æ¥æ”¶åˆ°çš„æ•°æ®åŸå°ä¸åŠ¨åœ°è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ä»¥ä¾¿è°ƒè¯•æˆ–å®¡è®¡ã€‚ä½¿ç”¨ <code>tee()</code> å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®ç°è¿™ä¸€éœ€æ±‚ï¼Œä¸€æ¡æµç»§ç»­è¿›è¡Œæ•°æ®å¤„ç†ï¼Œå¦ä¸€æ¡æµåˆ™è´Ÿè´£å†™å…¥æ—¥å¿—æ–‡ä»¶ã€‚</p></li><li><p><strong>æ•°æ®å¤‡ä»½</strong>ï¼šåœ¨å¤„ç†æ¥è‡ªç½‘ç»œè¯·æ±‚çš„æ•°æ®æ—¶ï¼Œä½ å¯èƒ½æƒ³å³æ—¶å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼ŒåŒæ—¶ä¿ç•™ä¸€ä»½åŸå§‹æ•°æ®ä½œä¸ºå¤‡ä»½ã€‚é€šè¿‡ <code>tee()</code>ï¼Œå¯ä»¥è½»æ˜“åœ°å°†æ•°æ®æµåˆ†ä¸ºä¸¤è·¯ï¼Œä¸€è·¯é€å¾€å¤„ç†é€»è¾‘ï¼Œå¦ä¸€è·¯å†™å…¥å¤‡ä»½æ–‡ä»¶ã€‚</p></li><li><p><strong>å†…å®¹é¢„è§ˆ</strong>ï¼šå¦‚æœä½ åœ¨å¼€å‘ä¸€ä¸ªç½‘ç«™ï¼Œè¯¥ç½‘ç«™å…è®¸ç”¨æˆ·ä¸Šä¼ è§†é¢‘å¹¶å¯¹å…¶è¿›è¡Œç¼–è¾‘ã€‚ä½¿ç”¨ <code>tee()</code> å¯ä»¥åœ¨ä¸Šä¼ çš„åŒæ—¶ï¼Œä¸€æ–¹é¢å¼€å§‹è§†é¢‘å¤„ç†ï¼ˆå¦‚è½¬ç ï¼‰ï¼Œå¦ä¸€æ–¹é¢æä¾›ä¸€ä¸ªå®æ—¶é¢„è§ˆç»™ç”¨æˆ·ã€‚</p></li></ol><h3 id="ç¤ºä¾‹ä»£ç -1" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹ä»£ç -1"><span>ç¤ºä¾‹ä»£ç </span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> Readable</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// æ¨¡æ‹Ÿä¸€ä¸ªå¯è¯»æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> originalStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Readable</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  read</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">size</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    this</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">push</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ç¤ºä¾‹æ•°æ®</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    this</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">push</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">null</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // æ•°æ®ç»“æŸæ ‡å¿—</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨ tee() åˆ†è£‚æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> [</span><span style="color:#D8DEE9;">stream1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> stream2</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> originalStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">tee</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// æ¶ˆè´¹ç¬¬ä¸€ä¸ªæµ</span></span>
<span class="line"><span style="color:#D8DEE9;">stream1</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Stream 1 æ¥æ”¶åˆ°æ•°æ®: </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// æ¶ˆè´¹ç¬¬äºŒä¸ªæµ</span></span>
<span class="line"><span style="color:#D8DEE9;">stream2</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Stream 2 æ¥æ”¶åˆ°æ•°æ®: </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç®€å•çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåŒ…å«â€œç¤ºä¾‹æ•°æ®â€çš„åŸå§‹å¯è¯»æµã€‚ä½¿ç”¨ <code>tee()</code> æ–¹æ³•ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªæµåˆ†æˆä¸¤ä¸ªæ–°çš„æµï¼Œç„¶ååˆ†åˆ«ç›‘å¬è¿™ä¸¤ä¸ªæµçš„ <code>data</code> äº‹ä»¶ä»¥æ‰“å°æ¥æ”¶åˆ°çš„æ•°æ®ã€‚è¿™æ ·ï¼Œæ— è®ºåŸå§‹æ•°æ®æºä¸­çš„æ•°æ®æ˜¯ä»€ä¹ˆï¼Œä¸¤ä¸ªæ–°çš„æµéƒ½å°†æ¥æ”¶å¹¶å¤„ç†ç›¸åŒçš„æ•°æ®ã€‚</p><p>æ€»ç»“æ¥è¯´ï¼Œ<code>readableStream.tee()</code> æä¾›äº†ä¸€ç§éå¸¸ä¾¿æ·çš„æ–¹å¼ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸åŒçš„å¤„ç†æµç¨‹ä¸­é‡å¤ä½¿ç”¨åŒä¸€ä»½æ•°æ®æºï¼Œä»è€Œå¤§å¤§å¢å¼ºäº† Node.js åœ¨æ•°æ®å¤„ç†æ–¹é¢çš„çµæ´»æ€§å’Œæ•ˆèƒ½ã€‚</p><h4 id="readablestream-values-options" tabindex="-1"><a class="header-anchor" href="#readablestream-values-options"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreamvaluesoptions" target="_blank" rel="noopener noreferrer">readableStream.values([options])</a></span></a></h4><p>Node.js ä¸­çš„ <code>readableStream.values([options])</code> æ˜¯ä¸€ä¸ªå¤„ç†æµ(Streams)æ•°æ®çš„å·¥å…·ã€‚åœ¨è§£é‡Šè¿™ä¸ªæ–¹æ³•ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ Node.js ä¸­çš„ Streams å’Œä¸ºä»€ä¹ˆå®ƒä»¬æ˜¯æœ‰ç”¨çš„ã€‚</p><h3 id="streams-ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#streams-ç®€ä»‹"><span>Streams ç®€ä»‹</span></a></h3><p>Streams æ˜¯å¤„ç†è¯»å–æˆ–å†™å…¥è¿ç»­æ•°æ®çš„ä¸€ç§æ–¹å¼ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªéå¸¸å¤§çš„æ–‡ä»¶ï¼Œæ¯”å¦‚ 10GB çš„è§†é¢‘æ–‡ä»¶ï¼Œä½ æƒ³å°†å®ƒä»ä¸€ä¸ªåœ°æ–¹ï¼ˆä¾‹å¦‚ç¡¬ç›˜ï¼‰ç§»åŠ¨åˆ°å¦ä¸€ä¸ªåœ°æ–¹ï¼ˆä¾‹å¦‚ç½‘ç»œï¼‰ã€‚å¦‚æœè¯•å›¾ä¸€æ¬¡æ€§è¯»å…¥æ•´ä¸ªæ–‡ä»¶åˆ°å†…å­˜ä¸­ï¼Œå¾ˆå¯èƒ½ä¼šå› ä¸ºæ–‡ä»¶è¿‡å¤§è€Œå¯¼è‡´å†…å­˜æº¢å‡ºã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Streams å¾ˆæœ‰ç”¨â€”â€”å®ƒä»¬å…è®¸ä½ åˆ†å—å¤„ç†æ–‡ä»¶ï¼Œä¸€æ¬¡åªå¤„ç†ä¸€å°éƒ¨åˆ†æ•°æ®ã€‚</p><h3 id="readablestream-values-options-1" tabindex="-1"><a class="header-anchor" href="#readablestream-values-options-1"><span>readableStream.values([options])</span></a></h3><p>åœ¨ Node.js v21.7.1 ç‰ˆæœ¬ä¸­ï¼Œ<code>readableStream.values([options])</code> æ˜¯ä¸€ä¸ªç”¨äºè¯»å–æµæ•°æ®çš„æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ª <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol/asyncIterator" target="_blank" rel="noopener noreferrer">AsyncIterator</a>ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥ä½¿ç”¨å¼‚æ­¥è¿­ä»£å™¨ï¼ˆä¾‹å¦‚ <code>for await...of</code> å¾ªç¯ï¼‰æ¥é€ä¸ªè¯»å–æµä¸­çš„æ•°æ®å—ã€‚</p><h4 id="å‚æ•°è§£é‡Š" tabindex="-1"><a class="header-anchor" href="#å‚æ•°è§£é‡Š"><span>å‚æ•°è§£é‡Š</span></a></h4><ul><li><code>options</code>: è¿™æ˜¯ä¸€ä¸ªå¯é€‰å‚æ•°ï¼Œå…è®¸ä½ å®šåˆ¶ä¸€äº›è¡Œä¸ºï¼Œæ¯”å¦‚å¦‚ä½•è§£ç æ–‡æœ¬æ•°æ®ã€‚</li></ul><h4 id="å®é™…è¿ç”¨ç¤ºä¾‹-2" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-2"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h4><h5 id="ç¤ºä¾‹-1-è¯»å–æ–‡æœ¬æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-1-è¯»å–æ–‡æœ¬æ–‡ä»¶"><span>ç¤ºä¾‹ 1ï¼šè¯»å–æ–‡æœ¬æ–‡ä»¶</span></a></h5><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ <code>example.txt</code> å¹¶ä¸”ä½ æƒ³é€è¡Œè¯»å–å®ƒã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> readFile</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">    encoding</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">utf8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  for</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;"> of</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">values</span><span style="color:#D8DEE9FF;">()) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">readFile</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Node.js çš„æ–‡ä»¶ç³»ç»Ÿæ¨¡å— (<code>fs</code>) åˆ›å»ºäº†ä¸€ä¸ªå¯è¯»æµæ¥è¯»å– <code>example.txt</code> æ–‡ä»¶ã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>for await...of</code> å¾ªç¯å’Œ <code>.values()</code> æ–¹æ³•éå†æ¯ä¸€å—æ•°æ®ï¼Œæ‰“å°å‡ºæ¥ã€‚</p><h5 id="ç¤ºä¾‹-2-å¤„ç†ç½‘ç»œè¯·æ±‚çš„å“åº”" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-2-å¤„ç†ç½‘ç»œè¯·æ±‚çš„å“åº”"><span>ç¤ºä¾‹ 2ï¼šå¤„ç†ç½‘ç»œè¯·æ±‚çš„å“åº”</span></a></h5><p>å½“ä½ å‘é€ HTTP è¯·æ±‚å¹¶æ¥æ”¶å“åº”æ—¶ï¼Œå“åº”ä½“æœ¬èº«å¯ä»¥è¢«è§†ä¸ºä¸€ä¸ª streamã€‚ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>.values()</code> æ–¹æ³•æ¥è¯»å–å“åº”ä½“ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> https</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> fetchUrl</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  https</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> async</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">response</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;"> of</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">values</span><span style="color:#D8DEE9FF;">()) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">Chunk: </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">chunk</span><span style="color:#81A1C1;">}</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">fetchUrl</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">http://example.com</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œï¼Œæˆ‘ä»¬å‘ <code>example.com</code> å‘é€äº†ä¸€ä¸ª GET è¯·æ±‚ï¼Œå¹¶ä½¿ç”¨ <code>.values()</code> æ¥é€å—è¯»å–å“åº”ä½“ã€‚</p><p>é€šè¿‡è¿™ä¸¤ä¸ªä¾‹å­ï¼Œä½ å¯ä»¥çœ‹åˆ° <code>readableStream.values([options])</code> è®©å¤„ç†æµæ•°æ®å˜å¾—æ›´åŠ ç®€æ´å’Œé«˜æ•ˆï¼Œç‰¹åˆ«æ˜¯å½“ä½ éœ€è¦æŒ‰é¡ºåºå¤„ç†æ•°æ®å—æ—¶ã€‚</p><h4 id="async-iteration" tabindex="-1"><a class="header-anchor" href="#async-iteration"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#async-iteration" target="_blank" rel="noopener noreferrer">Async Iteration</a></span></a></h4><p>å½“ç„¶ï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£ Node.js ä¸­çš„å¼‚æ­¥è¿­ä»£ï¼ˆAsync Iterationï¼‰æ¦‚å¿µã€‚</p><h3 id="å¼‚æ­¥è¿­ä»£åŸºç¡€" tabindex="-1"><a class="header-anchor" href="#å¼‚æ­¥è¿­ä»£åŸºç¡€"><span>å¼‚æ­¥è¿­ä»£åŸºç¡€</span></a></h3><p>é¦–å…ˆï¼Œå¼‚æ­¥è¿­ä»£æ˜¯ä¸€ç§å¤„ç†å¼‚æ­¥æ“ä½œåºåˆ—çš„æ–¹å¼ã€‚åœ¨ JavaScript (Node.js) ä¸­ï¼Œè¿™ç»å¸¸æ¶‰åŠå¤„ç†ä¸€ç³»åˆ—å¼‚æ­¥æ“ä½œï¼Œæ¯”å¦‚ä»æ–‡ä»¶ä¸­é€è¡Œè¯»å–æ•°æ®æˆ–è€…ä»æ•°æ®åº“é€æ¡è·å–è®°å½•ï¼Œè€Œæ¯ä¸ªæ“ä½œéƒ½å¯èƒ½éœ€è¦ç­‰å¾…å¤–éƒ¨èµ„æºã€‚</p><p>å¼‚æ­¥è¿­ä»£ç‰¹åˆ«é€‚ç”¨äºå¤„ç†æµï¼ˆStreamsï¼‰ï¼Œä¾‹å¦‚ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶æ“ä½œç­‰ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸æ˜¯åˆ†å—æ¥æ”¶æ•°æ®çš„ã€‚åœ¨ Node.js v21.7.1 æ–‡æ¡£ä¸­æåˆ°çš„ Async Iteration å°±æ˜¯æŒ‡è¿™æ ·ä¸€ç§æœºåˆ¶ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯æµ-streams" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯æµ-streams"><span>ä»€ä¹ˆæ˜¯æµï¼ˆStreamsï¼‰ï¼Ÿ</span></a></h3><p>ç®€å•æ¥è¯´ï¼Œæµæ˜¯ä¸€ç³»åˆ—æ•°æ®å…ƒç´ ï¼Œè¿™äº›å…ƒç´ ä½œä¸ºä¸€ä¸ªè¿ç»­åºåˆ—è¿‡æ—¶é—´ä¼ è¾“ã€‚æƒ³è±¡ä¸€ä¸‹æ°´æµï¼Œä½ ä¸èƒ½ä¸€æ¬¡æ€§çœ‹åˆ°æ‰€æœ‰çš„æ°´ï¼Œè€Œæ˜¯ä¸€ç‚¹ç‚¹åœ°çœ‹åˆ°éšç€æ—¶é—´æµåŠ¨çš„æ°´ã€‚</p><h3 id="async-iteration-å¦‚ä½•å·¥ä½œ" tabindex="-1"><a class="header-anchor" href="#async-iteration-å¦‚ä½•å·¥ä½œ"><span>Async Iteration å¦‚ä½•å·¥ä½œï¼Ÿ</span></a></h3><p>å¼‚æ­¥è¿­ä»£å…è®¸ä½ ä½¿ç”¨ <code>for-await-of</code> å¾ªç¯è¯­å¥æ¥éå†å¼‚æ­¥ç”Ÿæˆçš„æ•°æ®ã€‚å¯¹äºå¼‚æ­¥æ•°æ®æºï¼ˆä¾‹å¦‚è¯»å–å¤§å‹æ–‡ä»¶æ—¶ä¸å¯èƒ½ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰å†…å®¹åˆ°å†…å­˜ä¸­ï¼‰ï¼Œä½ å¯ä»¥ä¸€è¾¹è¯»å–ä¸€è¾¹å¤„ç†ï¼Œè€Œä¸æ˜¯ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å‡†å¤‡å¥½ã€‚</p><h3 id="å®é™…è¿ç”¨ä¾‹å­-2" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-2"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><h4 id="ä¾‹å­-1-è¯»å–å¤§å‹æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-è¯»å–å¤§å‹æ–‡ä»¶"><span>ä¾‹å­ 1ï¼šè¯»å–å¤§å‹æ–‡ä»¶</span></a></h4><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªå¤§å‹æ—¥å¿—æ–‡ä»¶ï¼Œä½ æƒ³é€è¡Œè¯»å–åˆ†æå…¶ä¸­çš„æ•°æ®ã€‚åˆ©ç”¨ Node.js ä¸­çš„å¼‚æ­¥è¿­ä»£ï¼Œä½ å¯ä»¥è¿™æ ·åšï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> path</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨ fs.createReadStream åˆ›å»ºä¸€ä¸ªå¯è¯»æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> logFileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span></span>
<span class="line"><span style="color:#D8DEE9;">  path</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">resolve</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">__dirname</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">large-log-file.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  {</span></span>
<span class="line"><span style="color:#88C0D0;">    encoding</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">utf-8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å¼‚æ­¥è¿­ä»£å™¨</span></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> processLogFile</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // è¿™é‡Œçš„å¼‚æ­¥è¿­ä»£å…è®¸æˆ‘ä»¬â€œç­‰å¾…â€æ¯ä¸€å—æ•°æ®çš„åˆ°æ¥</span></span>
<span class="line"><span style="color:#81A1C1;">  for</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;"> of</span><span style="color:#D8DEE9;"> stream</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // è¿™é‡Œå¯ä»¥æ˜¯é€è¡Œå¤„ç†é€»è¾‘</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">processLogFile</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">logFileStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¾‹å­-2-å¤„ç†æ¥è‡ªç½‘ç»œè¯·æ±‚çš„æ•°æ®æµ" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-å¤„ç†æ¥è‡ªç½‘ç»œè¯·æ±‚çš„æ•°æ®æµ"><span>ä¾‹å­ 2ï¼šå¤„ç†æ¥è‡ªç½‘ç»œè¯·æ±‚çš„æ•°æ®æµ</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨ä»ä¸€ä¸ª API è·å–å¤§é‡æ•°æ®ï¼Œæ•°æ®ä»¥æµçš„å½¢å¼è¿”å›ï¼Œä½ æƒ³è¦é€æ­¥å¤„ç†è¿™äº›æ•°æ®ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> https</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> fetchAndProcessData</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  return</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> Promise</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">resolve</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> reject</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    https</span></span>
<span class="line"><span style="color:#ECEFF4;">      .</span><span style="color:#88C0D0;">get</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">res</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">        // è¿™é‡Œæˆ‘ä»¬ç›´æ¥å°†å“åº”ä½“ res å½“ä½œå¼‚æ­¥è¿­ä»£å¯¹è±¡</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        (</span><span style="color:#81A1C1;">async</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">          for</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;"> of</span><span style="color:#D8DEE9;"> res</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">            console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">Received </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">length</span><span style="color:#81A1C1;">}</span><span style="color:#A3BE8C;"> bytes of data.</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">            // å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®å—</span></span>
<span class="line"><span style="color:#ECEFF4;">          }</span></span>
<span class="line"><span style="color:#88C0D0;">          resolve</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#D8DEE9FF;">)()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">      .</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">error</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> reject</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">fetchAndProcessData</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://example.com/data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸¤ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† <code>for-await-of</code> å¾ªç¯æ¥å¤„ç†å¼‚æ­¥äº§ç”Ÿçš„æ•°æ®å—ï¼Œæ— è®ºæ˜¯ä»æ–‡ä»¶ç³»ç»Ÿè¿˜æ˜¯é€šè¿‡ç½‘ç»œã€‚è¿™ç§æ–¹æ³•è®©æˆ‘ä»¬èƒ½å¤Ÿæœ‰æ•ˆç®¡ç†å†…å­˜ï¼Œå¹¶ä¸”åœ¨æ•°æ®åˆ°è¾¾æ—¶å³åˆ»å¤„ç†å®ƒä»¬ï¼Œè€Œä¸æ˜¯ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½åŠ è½½å®Œæ¯•ã€‚</p><h3 id="æ€»ç»“-1" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-1"><span>æ€»ç»“</span></a></h3><p>å¼‚æ­¥è¿­ä»£æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ¨¡å¼ï¼Œè®©ä½ å¯ä»¥ä¼˜é›…åœ°å¤„ç†æµå¼æ•°æ®å’Œå…¶ä»–å¼‚æ­¥æ•°æ®æºã€‚å®ƒç‰¹åˆ«é€‚ç”¨äºé‚£äº›æ•°æ®é‡å¤§æˆ–æ•°æ®ä»¥åˆ†å—æ–¹å¼é€è¾¾çš„åœºæ™¯ï¼Œä½¿å¾—æ•°æ®å¤„ç†æ—¢é«˜æ•ˆåˆæ˜“äºç®¡ç†ã€‚</p><h4 id="transferring-with-postmessage" tabindex="-1"><a class="header-anchor" href="#transferring-with-postmessage"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#transferring-with-postmessage" target="_blank" rel="noopener noreferrer">Transferring with postMessage()</a></span></a></h4><p>Node.js ä¸­çš„<code>postMessage()</code>æ–¹æ³•ç”¨äºåœ¨ä¸åŒçš„æ‰§è¡Œç¯å¢ƒï¼ˆå¦‚ Worker çº¿ç¨‹ï¼‰ä¹‹é—´ä¼ è¾“æ•°æ®ã€‚è¿™ä¸ªæ–¹æ³•ç‰¹åˆ«é‡è¦ï¼Œå› ä¸ºå®ƒå…è®¸æ•°æ®ä»¥é«˜æ•ˆä¸”å®‰å…¨çš„æ–¹å¼è¿›è¡Œä¼ è¾“ï¼Œè€Œä¸æ˜¯ç®€å•åœ°å¤åˆ¶æ•°æ®ï¼Œè¿™åœ¨å¤„ç†å¤§é‡æ•°æ®æˆ–éœ€è¦ä¿æŒæ€§èƒ½çš„åº”ç”¨ä¸­éå¸¸æœ‰ç”¨ã€‚</p><p>åœ¨ Node.js v21.7.1 ä¸­ï¼Œ<code>postMessage()</code>å¯ä»¥ä¸ Web Streams ç»“åˆä½¿ç”¨ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥å°†æµï¼ˆstreamsï¼‰çš„æ•°æ®ç›´æ¥ä»ä¸€ä¸ªç¯å¢ƒè½¬ç§»åˆ°å¦ä¸€ä¸ªç¯å¢ƒï¼Œè€Œæ— éœ€å°†æ•°æ®å®Œå…¨åŠ è½½åˆ°å†…å­˜ä¸­ã€‚è¿™å¯¹äºå¤„ç†å¤§å‹æ–‡ä»¶æˆ–æ•°æ®æµéå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå‡å°‘äº†å†…å­˜ä½¿ç”¨å¹¶æé«˜äº†å¤„ç†æ•ˆç‡ã€‚</p><h3 id="å®é™…åº”ç”¨ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ç¤ºä¾‹"><span>å®é™…åº”ç”¨ç¤ºä¾‹</span></a></h3><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨å¼€å‘ä¸€ä¸ªè§†é¢‘å¤„ç†åº”ç”¨ç¨‹åºï¼Œè¯¥ç¨‹åºéœ€è¦è¯»å–å¤§å‹è§†é¢‘æ–‡ä»¶ï¼Œè½¬æ¢æ ¼å¼ï¼Œç„¶åå°†å…¶ä¿å­˜åˆ°ç£ç›˜ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>postMessage()</code> å°†è§†é¢‘æµä»ä¸»åº”ç”¨ç¨‹åºä¼ è¾“ç»™å·¥ä½œçº¿ç¨‹ï¼Œå·¥ä½œçº¿ç¨‹å®Œæˆè§†é¢‘è½¬æ¢åï¼Œå†å°†ç»“æœä¼ å›ä¸»åº”ç”¨ç¨‹åºã€‚è¿™æ ·ï¼Œä¸»çº¿ç¨‹å¯ä»¥ç»§ç»­å¤„ç†å…¶ä»–ä»»åŠ¡ï¼Œæé«˜åº”ç”¨ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚</p><p>å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li><p><strong>åˆ›å»º Worker çº¿ç¨‹</strong>ï¼šé¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Worker çº¿ç¨‹æ¥å¤„ç†è§†é¢‘è½¬æ¢çš„ä»»åŠ¡ã€‚</p></li><li><p><strong>ä¼ è¾“è§†é¢‘æµ</strong>ï¼šç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>postMessage()</code> æ–¹æ³•å°†åŒ…å«è§†é¢‘æ•°æ®çš„æµä¼ è¾“ç»™è¿™ä¸ªå·¥ä½œçº¿ç¨‹ã€‚ç”±äºä½¿ç”¨äº†æµä¼ è¾“ï¼Œæ‰€ä»¥å³ä½¿è§†é¢‘æ–‡ä»¶å¾ˆå¤§ï¼Œä¹Ÿä¸ä¼šå ç”¨å¤ªå¤šå†…å­˜ã€‚</p></li><li><p><strong>åœ¨ Worker çº¿ç¨‹ä¸­å¤„ç†è§†é¢‘</strong>ï¼šå·¥ä½œçº¿ç¨‹æ¥æ”¶åˆ°è§†é¢‘æµåï¼Œå¯ä»¥å¯¹å…¶è¿›è¡Œå¿…è¦çš„å¤„ç†ï¼Œæ¯”å¦‚æ ¼å¼è½¬æ¢ã€‚</p></li><li><p><strong>è¿”å›å¤„ç†ç»“æœ</strong>ï¼šå¤„ç†å®Œæˆåï¼Œå·¥ä½œçº¿ç¨‹å¯ä»¥å°†è½¬æ¢åçš„è§†é¢‘æµé€šè¿‡ <code>postMessage()</code> æ–¹æ³•å‘é€å›ä¸»çº¿ç¨‹ã€‚</p></li><li><p><strong>ä¿å­˜æˆ–è¿›ä¸€æ­¥å¤„ç†</strong>ï¼šä¸»çº¿ç¨‹æ¥æ”¶åˆ°è½¬æ¢åçš„è§†é¢‘æµåï¼Œå¯ä»¥é€‰æ‹©ä¿å­˜åˆ°ç£ç›˜æˆ–è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚</p></li></ol><h3 id="ä»£ç ç¤ºä¾‹-1" tabindex="-1"><a class="header-anchor" href="#ä»£ç ç¤ºä¾‹-1"><span>ä»£ç ç¤ºä¾‹</span></a></h3><p>è¯·æ³¨æ„ï¼Œä»¥ä¸‹ä»£ç åªæ˜¯ä¸ºäº†è¯´æ˜æ¦‚å¿µï¼Œå¹¶éå¯ç›´æ¥è¿è¡Œçš„å®ä¾‹ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// ä¸»çº¿ç¨‹</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> Worker</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">worker_threads</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> worker</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Worker</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./video-worker.js</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾æœ‰ä¸€ä¸ªå‡½æ•°getVideoStream()ç”¨äºè·å–è§†é¢‘æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> videoStream</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> getVideoStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨postMessageå°†è§†é¢‘æµä¼ è¾“ç»™å·¥ä½œçº¿ç¨‹</span></span>
<span class="line"><span style="color:#D8DEE9;">worker</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">postMessage</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9;"> videoStream</span><span style="color:#ECEFF4;"> },</span><span style="color:#D8DEE9FF;"> [</span><span style="color:#D8DEE9;">videoStream</span><span style="color:#D8DEE9FF;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ç›‘å¬æ¥è‡ªå·¥ä½œçº¿ç¨‹çš„æ¶ˆæ¯</span></span>
<span class="line"><span style="color:#D8DEE9;">worker</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">message</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">processedVideoStream</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // æ¥æ”¶å¤„ç†åçš„è§†é¢‘æµï¼Œè¿›è¡Œä¿å­˜æˆ–è¿›ä¸€æ­¥å¤„ç†</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å·¥ä½œçº¿ç¨‹ (&#39;video-worker.js&#39;)</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> parentPort</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">worker_threads</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">parentPort</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">message</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ({</span><span style="color:#D8DEE9;"> videoStream</span><span style="color:#ECEFF4;"> })</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // åœ¨è¿™é‡Œå¤„ç†è§†é¢‘æµï¼Œæ¯”å¦‚è¿›è¡Œæ ¼å¼è½¬æ¢</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> processedVideoStream</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> processVideo</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">videoStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // å¤„ç†å®Œæˆåï¼Œå°†ç»“æœå‘é€å›ä¸»çº¿ç¨‹</span></span>
<span class="line"><span style="color:#D8DEE9;">  parentPort</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">postMessage</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">processedVideoStream</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> [</span><span style="color:#D8DEE9;">processedVideoStream</span><span style="color:#D8DEE9FF;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œ<code>postMessage()</code> ç»“åˆ Web Streams çš„ä½¿ç”¨ä½¿å¾—åœ¨ Node.js åº”ç”¨ä¸­å¤„ç†å¤§é‡æ•°æ®æ›´åŠ é«˜æ•ˆå’Œçµæ´»ã€‚</p><h3 id="readablestream-from-iterable" tabindex="-1"><a class="header-anchor" href="#readablestream-from-iterable"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreamfromiterable" target="_blank" rel="noopener noreferrer">ReadableStream.from(iterable)</a></span></a></h3><p>å½“æˆ‘ä»¬è°ˆè®º Node.js ä¸­çš„ <code>ReadableStream.from(iterable)</code>ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯åœ¨è®¨è®ºå¦‚ä½•å°†ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ï¼ˆæ¯”å¦‚æ•°ç»„ã€å­—ç¬¦ä¸²æˆ–è€…ä»»ä½•å…¶å®ƒå®ç°äº†è¿­ä»£å™¨æ¥å£çš„å¯¹è±¡ï¼‰è½¬æ¢æˆä¸€ä¸ªå¯è¯»æµã€‚æµï¼ˆStreamsï¼‰æ˜¯ Node.js ä¸­å¤„ç†æ•°æ®çš„ä¸€ç§æ–¹å¼ï¼Œç‰¹åˆ«é€‚åˆå¤„ç†å¤§é‡æ•°æ®ï¼Œæ¯”å¦‚æ–‡ä»¶æ“ä½œæˆ–ç½‘ç»œè¯·æ±‚ï¼Œå› ä¸ºå®ƒä»¬å…è®¸æ•°æ®è¢«åˆ†å—å¤„ç†ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><p>ç†è§£äº†è¿™ä¸ªå®šä¹‰åï¼Œé‚£ä¹ˆ <code>ReadableStream.from(iterable)</code> çš„ä½œç”¨å°±å¾ˆæ¸…æ™°äº†ï¼šå®ƒå…è®¸æˆ‘ä»¬ä»ç®€å•çš„å¯è¿­ä»£å¯¹è±¡åˆ›å»ºå‡ºä¸€ä¸ªæµå¼çš„æ•°æ®å¤„ç†æ¨¡å¼ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥ä»¥æµçš„å½¢å¼æ¥å¤„ç†å’Œè½¬æ¢è¿™äº›æ•°æ®ã€‚</p><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h3><h4 id="ä¾‹å­-1-ä»æ•°ç»„åˆ›å»ºå¯è¯»æµ" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-ä»æ•°ç»„åˆ›å»ºå¯è¯»æµ"><span>ä¾‹å­ 1: ä»æ•°ç»„åˆ›å»ºå¯è¯»æµ</span></a></h4><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåŒ…å«å¤§é‡æ•°æ®çš„æ•°ç»„ï¼Œè€Œæˆ‘ä»¬æƒ³è¦é€šè¿‡æµçš„æ–¹å¼æ¥é€ä¸ªå¤„ç†æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node:stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> processArrayData</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> dataArray</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> [</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 3</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 4</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 5</span><span style="color:#D8DEE9FF;">]</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡è®¾çš„æ•°æ®æº</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> readable</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">from</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">dataArray</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> readable</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">break;</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // é€ä¸ªè¾“å‡ºæ•°ç»„ä¸­çš„å€¼</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">processArrayData</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>ReadableStream.from</code> æ–¹æ³•å°†ä¸€ä¸ªæ•°ç»„è½¬æ¢æˆäº†ä¸€ä¸ªå¯è¯»æµï¼Œç„¶åæˆ‘ä»¬é€šè¿‡æµçš„è¯»å–å™¨ï¼ˆ<code>reader</code>ï¼‰é€ä¸ªå¤„ç†æ•°ç»„ä¸­çš„å…ƒç´ ã€‚</p><h4 id="ä¾‹å­-2-ä»å­—ç¬¦ä¸²åˆ›å»ºå¯è¯»æµ" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-ä»å­—ç¬¦ä¸²åˆ›å»ºå¯è¯»æµ"><span>ä¾‹å­ 2: ä»å­—ç¬¦ä¸²åˆ›å»ºå¯è¯»æµ</span></a></h4><p>è€ƒè™‘ä¸€ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªéå¸¸é•¿çš„å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬æƒ³è¦é€ä¸ªå­—ç¬¦åœ°å¤„ç†å®ƒã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node:stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> processStringData</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> longString</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Hello, Node.js</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡è®¾çš„é•¿å­—ç¬¦ä¸²æ•°æ®æº</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> readable</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">from</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">longString</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> readable</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">break;</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // é€ä¸ªè¾“å‡ºå­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">processStringData</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œï¼Œæˆ‘ä»¬æŠŠä¸€ä¸ªé•¿å­—ç¬¦ä¸²è½¬æ¢æˆäº†ä¸€ä¸ªå¯è¯»æµï¼Œå¹¶ä¸”ä½¿ç”¨æµçš„è¯»å–å™¨é€å­—ç¬¦å¤„ç†å­—ç¬¦ä¸²ã€‚</p><h4 id="ä¾‹å­-3-ç»“åˆå¼‚æ­¥è¿­ä»£å™¨å¤„ç†" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-3-ç»“åˆå¼‚æ­¥è¿­ä»£å™¨å¤„ç†"><span>ä¾‹å­ 3: ç»“åˆå¼‚æ­¥è¿­ä»£å™¨å¤„ç†</span></a></h4><p>å¦‚æœä½ è¦å¤„ç†çš„æ•°æ®æœ¬èº«å°±æ˜¯å¼‚æ­¥äº§ç”Ÿçš„ï¼Œä¾‹å¦‚æ¥è‡ªäºä¸€ä¸ªå¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°ï¼Œ<code>ReadableStream.from</code> ä¹ŸåŒæ ·èƒ½å¤Ÿå¤„ç†ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">node:stream/web</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function*</span><span style="color:#88C0D0;"> generateNumbers</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9;"> i</span><span style="color:#ECEFF4;"> `</span><span style="color:#A3BE8C;">&lt;</span><span style="color:#ECEFF4;">`</span><span style="color:#B48EAD;"> 5</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">        yield</span><span style="color:#8FBCBB;"> Promise</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">resolve</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // æ¨¡æ‹Ÿå¼‚æ­¥æ•°æ®æº</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> processAsyncIterableData</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> readable</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">from</span><span style="color:#D8DEE9FF;">(</span><span style="color:#88C0D0;">generateNumbers</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> readable</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">        const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">break;</span></span>
<span class="line"><span style="color:#D8DEE9;">        console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºç”Ÿæˆå™¨äº§ç”Ÿçš„å€¼</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">processAsyncIterableData</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•° <code>generateNumbers</code>ï¼Œå®ƒå¼‚æ­¥äº§ç”Ÿäº†ä¸€ç³»åˆ—çš„æ•°å­—ã€‚æˆ‘ä»¬é€šè¿‡ <code>ReadableStream.from</code> å°†è¿™ä¸ªå¼‚æ­¥ç”Ÿæˆå™¨è½¬æ¢æˆäº†ä¸€ä¸ªå¯è¯»æµï¼Œç„¶åé€ä¸ªå¤„ç†è¿™äº›å¼‚æ­¥äº§ç”Ÿçš„æ•°å­—ã€‚</p><p>é€šè¿‡è¿™äº›ä¾‹å­ï¼Œä½ åº”è¯¥èƒ½å¤Ÿçœ‹åˆ° <code>ReadableStream.from(iterable)</code> åœ¨ Node.js ä¸­çš„çµæ´»æ€§å’Œå¼ºå¤§åŠŸèƒ½ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤§é‡æ•°æ®æˆ–è€…éœ€è¦å°†æ•°æ®æµå¼ä¼ è¾“æ—¶ã€‚</p><h3 id="class-readablestreamdefaultreader" tabindex="-1"><a class="header-anchor" href="#class-readablestreamdefaultreader"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-readablestreamdefaultreader" target="_blank" rel="noopener noreferrer">Class: ReadableStreamDefaultReader</a></span></a></h3><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ·±å…¥äº†è§£ Node.js ä¸­çš„ <code>ReadableStreamDefaultReader</code> ç±»åŠå…¶åº”ç”¨ã€‚</p><h3 id="readablestreamdefaultreader-ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#readablestreamdefaultreader-ç®€ä»‹"><span>ReadableStreamDefaultReader ç®€ä»‹</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œ<code>ReadableStreamDefaultReader</code> æ˜¯å¤„ç†æµå¼æ•°æ®çš„ä¸€ç§æ–¹æ³•ã€‚æµï¼ˆStreamsï¼‰æ˜¯ä¸€ç§å¯ä»¥è¿ç»­è¯»å–æˆ–å†™å…¥æ•°æ®çš„æ–¹å¼ï¼Œè€Œä¸éœ€è¦ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚è¿™ä½¿å¾—å¤„ç†å¤§é‡æ•°æ®ï¼ˆå¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œé€šä¿¡ç­‰ï¼‰å˜å¾—é«˜æ•ˆå’Œç®€ä¾¿ã€‚</p><p><code>ReadableStreamDefaultReader</code> å¯¹è±¡å…è®¸ä½ ä»¥æ›´æ§åˆ¶çš„æ–¹å¼ä» <code>ReadableStream</code> ä¸­è¯»å–æ•°æ®ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒç»™ä½ æä¾›äº†ä¸€ä¸ªæ¥å£ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£ï¼Œä½ å¯ä»¥ä¸€æ­¥ä¸€æ­¥åœ°è¯»å–æµä¸­çš„æ•°æ®ï¼Œè€Œä¸æ˜¯è®©æµè‡ªå·±å†³å®šä½•æ—¶æŠŠæ•°æ®å‘é€ç»™ä½ ã€‚</p><h3 id="åˆ›å»º-readablestreamdefaultreader" tabindex="-1"><a class="header-anchor" href="#åˆ›å»º-readablestreamdefaultreader"><span>åˆ›å»º ReadableStreamDefaultReader</span></a></h3><p>è¦ä½¿ç”¨ <code>ReadableStreamDefaultReader</code>ï¼Œé¦–å…ˆä½ éœ€è¦æœ‰ä¸€ä¸ª <code>ReadableStream</code> å¯¹è±¡ã€‚ç„¶åï¼Œä½ å¯ä»¥é€šè¿‡è°ƒç”¨è¿™ä¸ªæµå¯¹è±¡çš„ <code>.getReader()</code> æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ª reader å¯¹è±¡ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // åˆå§‹åŒ–æµçš„ä»£ç </span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#88C0D0;">  pull</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å½“æ¶ˆè´¹è€…éœ€è¦æ›´å¤šæ•°æ®æ—¶å°†è°ƒç”¨æ­¤æ–¹æ³•</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#88C0D0;">  cancel</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å¦‚æœæ¶ˆè´¹è€…å–æ¶ˆäº†æµçš„è¯»å–ï¼Œåˆ™ä¼šè°ƒç”¨æ­¤æ–¹æ³•</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä½¿ç”¨-readablestreamdefaultreader" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-readablestreamdefaultreader"><span>ä½¿ç”¨ ReadableStreamDefaultReader</span></a></h3><p>ä¸€æ—¦ä½ æ‹¥æœ‰äº†ä¸€ä¸ª <code>ReadableStreamDefaultReader</code> å®ä¾‹ï¼Œå°±å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ä¹‹ä¸€æ¥è¯»å–æ•°æ®ï¼š</p><ul><li><code>read()</code>: å¼‚æ­¥è¯»å–æµä¸­çš„ä¸‹ä¸€æ®µæ•°æ®ã€‚</li><li><code>releaseLock()</code>: é‡Šæ”¾å¯¹æµçš„é”å®šï¼Œå…è®¸å…¶ä»– reader æ¥è¯»å–æ­¤æµã€‚</li></ul><h4 id="read-æ–¹æ³•ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#read-æ–¹æ³•ç¤ºä¾‹"><span>read() æ–¹æ³•ç¤ºä¾‹</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> readStream</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">      break;</span><span style="color:#616E88;"> // å½“æ²¡æœ‰æ›´å¤šæ•°æ®å¯è¯»æ—¶ï¼Œè·³å‡ºå¾ªç¯</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å¤„ç†æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">  reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">releaseLock</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¯»å–å®Œæˆåï¼Œé‡Šæ”¾é”å®š</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-3" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-3"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><p><strong>æ–‡ä»¶è¯»å–</strong>: å‡è®¾ä½ æ­£åœ¨æ„å»ºä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦ä»ä¸€ä¸ªå¤§æ–‡ä»¶ä¸­é€æ­¥è¯»å–æ•°æ®è¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯è¯»æµæ¥ä»æ–‡ä»¶è¯»å–æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/large/file.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°† Node.js çš„ stream è½¬æ¢ä¸º Web æ ‡å‡†çš„ ReadableStream</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> webStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toWeb</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨ ReadableStreamDefaultReader è¯»å–æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> webStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> readAndProcessFile</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æ–‡ä»¶è¯»å–å®Œæ¯•</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">      break;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">è¯»å–åˆ°çš„æ•°æ®:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // è¿™é‡Œå¯ä»¥åŠ å…¥æ•°æ®å¤„ç†é€»è¾‘</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#D8DEE9;">  reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">releaseLock</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">readAndProcessFile</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç½‘ç»œè¯·æ±‚</strong>: åœ¨è·å–æŸä¸ªå¤§å‹èµ„æºæ—¶ï¼Œæ¯”å¦‚å¤§å°ºå¯¸å›¾ç‰‡æˆ–è§†é¢‘ï¼Œä½ å¯èƒ½æƒ³è¾¹ä¸‹è½½è¾¹å¤„ç†æ•°æ®ã€‚</p><p>å‡è®¾ Node.js ç¯å¢ƒæ”¯æŒåŸç”Ÿ <code>fetch</code> APIï¼ˆæˆ–é€šè¿‡ polyfills å®ç°ï¼‰ï¼Œä½ å¯ä»¥è¿™æ ·åšï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> fetchAndProcessResource</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> response</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#88C0D0;"> fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">èµ„æºä¸‹è½½å®Œæ¯•</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">      break;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#616E88;">    // å¯¹ä¸‹è½½çš„æ•°æ®ç‰‡æ®µè¿›è¡Œå¤„ç†</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#D8DEE9;">  reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">releaseLock</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">fetchAndProcessResource</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://example.com/large-resource</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šç¤ºä¾‹å±•ç¤ºäº† <code>ReadableStreamDefaultReader</code> å¦‚ä½•åœ¨å®é™…åº”ç”¨ä¸­è¢«ç”¨äºæœ‰æ•ˆå¤„ç†å¤§é‡æ•°æ®ï¼Œæ— è®ºæ˜¯ä»æ–‡ä»¶ä¸­è¯»å–è¿˜æ˜¯è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼Œéƒ½èƒ½æé«˜åº”ç”¨æ€§èƒ½ï¼Œé¿å…å†…å­˜æº¢å‡ºçš„é£é™©ã€‚</p><h4 id="new-readablestreamdefaultreader-stream" tabindex="-1"><a class="header-anchor" href="#new-readablestreamdefaultreader-stream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#new-readablestreamdefaultreaderstream" target="_blank" rel="noopener noreferrer">new ReadableStreamDefaultReader(stream)</a></span></a></h4><p>å¥½çš„ï¼Œæˆ‘ä¼šç›´æ¥è¿›å…¥è§£é‡Šå’Œç¤ºä¾‹ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯-readablestreamdefaultreader" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯-readablestreamdefaultreader"><span>ä»€ä¹ˆæ˜¯ <code>ReadableStreamDefaultReader</code>ï¼Ÿ</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œ<code>ReadableStreamDefaultReader</code>æ˜¯ä¸€ä¸ªç”¨äºè¯»å–æ•°æ®æµï¼ˆstreamï¼‰å†…å®¹çš„å·¥å…·ã€‚å®ƒæä¾›äº†ä¸€ç§é€å—ï¼ˆchunk-by-chunkï¼‰å¤„ç†æµæ•°æ®çš„æ–¹å¼ï¼Œè¿™å¯¹äºå¤„ç†å¤§é‡æ•°æ®æˆ–è€…ä½ æ— æ³•ä¸€æ¬¡æ€§è·å–æ‰€æœ‰æ•°æ®çš„æƒ…å†µç‰¹åˆ«æœ‰ç”¨ã€‚</p><p>æ•°æ®æµå¯ä»¥æ˜¯æ–‡ä»¶å†…å®¹ã€ç½‘ç»œè¯·æ±‚å“åº”æˆ–å…¶ä»–ä»»ä½•å½¢å¼çš„è¿ç»­æ•°æ®ã€‚ä½¿ç”¨<code>ReadableStreamDefaultReader</code>ï¼Œä½ å¯ä»¥é€æ­¥è¯»å–è¿™äº›æ•°æ®ï¼Œè€Œä¸éœ€è¦ä¸€å¼€å§‹å°±åŠ è½½å…¨éƒ¨å†…å®¹åˆ°å†…å­˜ä¸­ã€‚</p><h3 id="å¦‚ä½•ä½¿ç”¨-new-readablestreamdefaultreader-stream" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ä½¿ç”¨-new-readablestreamdefaultreader-stream"><span>å¦‚ä½•ä½¿ç”¨ <code>new ReadableStreamDefaultReader(stream)</code>?</span></a></h3><p>é¦–å…ˆï¼Œä½ éœ€è¦æœ‰ä¸€ä¸ª<code>ReadableStream</code>å¯¹è±¡ã€‚ä¸€æ—¦ä½ æœ‰äº†è¿™ä¸ªå¯¹è±¡ï¼Œå°±å¯ä»¥ä½¿ç”¨<code>new ReadableStreamDefaultReader(stream)</code>æ¥åˆ›å»ºä¸€ä¸ªè¯»å–å™¨(reader)å®ä¾‹ã€‚è¿™ä¸ªå®ä¾‹å…è®¸ä½ æŒ‰é¡ºåºè¯»å–ä»æµä¸­ä¼ è¾“è¿‡æ¥çš„æ¯ä¸€å—æ•°æ®ã€‚</p><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-1" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-1"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h3><h4 id="_1-è¯»å–ç½‘ç»œå“åº”æ•°æ®" tabindex="-1"><a class="header-anchor" href="#_1-è¯»å–ç½‘ç»œå“åº”æ•°æ®"><span>1. è¯»å–ç½‘ç»œå“åº”æ•°æ®</span></a></h4><p>å‡è®¾ä½ åœ¨ Node.js åº”ç”¨ä¸­å‘å‡ºäº†ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œå¹¶ä¸”æƒ³é€æ­¥è¯»å–å“åº”æ•°æ®ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fetch</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node-fetch</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡å®šä½ ä½¿ç”¨äº†node-fetchåº“æ¥å‘é€è¯·æ±‚</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> readResponse</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> response</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#88C0D0;"> fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‘é€è¯·æ±‚</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStreamDefaultReader</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è·å–å“åº”ä½“ä½œä¸ºæµï¼Œå¹¶åˆ›å»ºè¯»å–å™¨</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // é€å—è¯»å–æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">break;</span><span style="color:#616E88;"> // å¦‚æœæ²¡æœ‰æ›´å¤šæ•°æ®ï¼Œé€€å‡ºå¾ªç¯</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å¤„ç†å½“å‰å—çš„æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">readResponse</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://example.com</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¾‹å­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨<code>ReadableStreamDefaultReader</code>é€å—è¯»å–æ¥è‡ªç½‘ç»œè¯·æ±‚çš„æ•°æ®ã€‚</p><h4 id="_2-å¤„ç†å¤§æ–‡ä»¶æ•°æ®" tabindex="-1"><a class="header-anchor" href="#_2-å¤„ç†å¤§æ–‡ä»¶æ•°æ®"><span>2. å¤„ç†å¤§æ–‡ä»¶æ•°æ®</span></a></h4><p>å¦‚æœä½ æ­£åœ¨å¤„ç†ä¸€ä¸ªéå¸¸å¤§çš„æ–‡ä»¶ï¼Œä¸€æ¬¡æ€§è¯»å–å¯èƒ½ä¼šå ç”¨å¤ªå¤šå†…å­˜ã€‚ä½¿ç”¨<code>ReadableStreamDefaultReader</code>å¯ä»¥æ›´é«˜æ•ˆåœ°å¤„ç†è¿™ç§æƒ…å†µï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> readFile</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">filePath</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">filePath</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // åˆ›å»ºä¸€ä¸ªå¯è¯»æµ</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStreamDefaultReader</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // ä½¿ç”¨å¯è¯»æµåˆ›å»ºè¯»å–å™¨</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> read</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">      const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // é€å—è¯»å–æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">      if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">break;</span><span style="color:#616E88;"> // å¦‚æœæ–‡ä»¶è¯»å–å®Œæ¯•ï¼Œé€€å‡ºå¾ªç¯</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // åœ¨è¿™é‡Œå¤„ç†æ–‡ä»¶çš„ä¸€éƒ¨åˆ†æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">  read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">readFile</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/path/to/large-file.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¾‹å­æ¼”ç¤ºäº†å¦‚ä½•é€å—è¯»å–å¤§æ–‡ä»¶çš„å†…å®¹ï¼Œé¿å…äº†ä¸€æ¬¡æ€§å°†æ•´ä¸ªæ–‡ä»¶è½½å…¥å†…å­˜çš„éœ€æ±‚ã€‚</p><h3 id="æ€»ç»“-2" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-2"><span>æ€»ç»“</span></a></h3><p><code>ReadableStreamDefaultReader</code>æä¾›äº†ä¸€ç§æœ‰æ•ˆçš„æ–¹å¼æ¥é€æ­¥å¤„ç†æµæ•°æ®ï¼Œæ— è®ºæ˜¯æ¥è‡ªç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶æ“ä½œè¿˜æ˜¯å…¶ä»–æµæ•°æ®æºã€‚é€šè¿‡é€å—è¯»å–æ•°æ®ï¼Œå®ƒå¸®åŠ©æˆ‘ä»¬ä¼˜åŒ–å†…å­˜ä½¿ç”¨ï¼Œå¹¶ä½¿å¾—å¤„ç†å¤§é‡æ•°æ®å˜å¾—æ›´åŠ å¯è¡Œã€‚</p><h4 id="readablestreamdefaultreader-cancel-reason" tabindex="-1"><a class="header-anchor" href="#readablestreamdefaultreader-cancel-reason"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreamdefaultreadercancelreason" target="_blank" rel="noopener noreferrer">readableStreamDefaultReader.cancel([reason])</a></span></a></h4><p>å½“ä½ å¼€å§‹ä½¿ç”¨ Node.js å¼€å‘åº”ç”¨ç¨‹åºæ—¶ï¼Œå¤„ç†æ•°æ®æµæ˜¯ä¸€ä¸ªå¸¸è§ä¸”é‡è¦çš„éœ€æ±‚ã€‚åœ¨ Node.js ä¸­æœ‰è®¸å¤šæ–¹å¼æ¥å¤„ç†æ•°æ®æµï¼Œè€Œ<code>readableStreamDefaultReader.cancel([reason])</code>æ˜¯ä¸å¯è¯»æµç›¸å…³çš„ä¸€ä¸ªæ–¹æ³•ã€‚ä¸ºäº†è§£é‡Šè¿™ä¸ªæ¦‚å¿µï¼Œæˆ‘ä¼šå°½é‡ä¿æŒç®€å•å¹¶æä¾›ä¸€äº›ç”Ÿæ´»ä¸­çš„æ¯”å–»å’Œå®é™…çš„ä»£ç ä¾‹å­ã€‚</p><h3 id="å¯è¯»æµ-readable-streams-çš„æ¯”å–»" tabindex="-1"><a class="header-anchor" href="#å¯è¯»æµ-readable-streams-çš„æ¯”å–»"><span>å¯è¯»æµï¼ˆReadable Streamsï¼‰çš„æ¯”å–»</span></a></h3><p>æƒ³è±¡ä½ åœ¨ä¸€å®¶é¤å…é‡Œç‚¹äº†ä¸€å£¶èŒ¶ã€‚èŒ¶å£¶å°±åƒæ˜¯ä¸€ä¸ªâ€œå¯è¯»æµâ€ï¼Œé‡Œé¢çš„èŒ¶å°±åƒæ˜¯æ•°æ®ã€‚ç°åœ¨ï¼Œå¦‚æœä½ çªç„¶ä¸æƒ³å†å–è¿™å£¶èŒ¶äº†ï¼Œå¯èƒ½æ˜¯å› ä¸ºèŒ¶å¤ªè‹¦æˆ–è€…ä½ æœ‰æ€¥äº‹è¦èµ°ï¼Œä½ éœ€è¦é€šçŸ¥æœåŠ¡å‘˜åœæ­¢å€’èŒ¶ã€‚åœ¨ Node.js ä¸­ï¼Œå–æ¶ˆè¯»å–æ•°æ®æµçš„è¿‡ç¨‹ï¼Œå°±ç›¸å½“äºå‘Šè¯‰æœåŠ¡å‘˜åœæ­¢å€’èŒ¶çš„è¡Œä¸ºã€‚</p><h3 id="readablestreamdefaultreader-cancel-reason-è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#readablestreamdefaultreader-cancel-reason-è¯¦è§£"><span><code>readableStreamDefaultReader.cancel([reason])</code>è¯¦è§£</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œ<code>readableStreamDefaultReader</code>æ˜¯ä¸€ä¸ªç”¨äºä»å¯è¯»æµï¼ˆ<code>ReadableStream</code>ï¼‰ä¸­æŒ‰åºè¯»å–æ•°æ®çš„å·¥å…·ã€‚<code>.cancel([reason])</code>æ–¹æ³•å…è®¸ä½ åœæ­¢è¯»å–æµï¼Œå¹¶ä¸”å¯ä»¥é€‰æ‹©æä¾›ä¸€ä¸ªåŸå› è¯´æ˜ä¸ºä»€ä¹ˆè¦åœæ­¢ã€‚</p><h4 id="å‚æ•°-reason" tabindex="-1"><a class="header-anchor" href="#å‚æ•°-reason"><span>å‚æ•°: <code>reason</code></span></a></h4><ul><li><strong>ç±»å‹</strong>: <code>Optional</code> (å¯é€‰)</li><li><strong>ç”¨é€”</strong>: ä½ å¯ä»¥æä¾›ä¸€ä¸ªå€¼ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªé”™è¯¯å¯¹è±¡ï¼‰ï¼Œæ¥è¯´æ˜ä¸ºä»€ä¹ˆå–æ¶ˆæµçš„è¯»å–ã€‚è¿™ä¸ªå€¼ä¼šè¢«ä¼ é€’ç»™æµæˆ–å…¶æ¶ˆè´¹è€…ä»¥ä¾¿è¿›è¡Œé”™è¯¯å¤„ç†ã€‚</li></ul><h4 id="è¿”å›å€¼-2" tabindex="-1"><a class="header-anchor" href="#è¿”å›å€¼-2"><span>è¿”å›å€¼:</span></a></h4><ul><li><strong>ç±»å‹</strong>: <code>Promise</code></li><li><strong>æè¿°</strong>: å½“è°ƒç”¨<code>.cancel()</code>æ–¹æ³•æ—¶ï¼Œå®ƒè¿”å›ä¸€ä¸ªæ‰¿è¯ºï¼ˆPromiseï¼‰ï¼Œè¡¨ç¤ºå°†å°½å¿«åœæ­¢è¯»å–æµçš„æ•°æ®ã€‚å½“æ“ä½œå®Œæˆï¼ˆæµæˆåŠŸå…³é—­æˆ–å‡ºé”™ï¼‰æ—¶ï¼ŒPromise ä¼šè§£å†³ï¼ˆresolveï¼‰ã€‚</li></ul><h3 id="å®é™…åº”ç”¨ç¤ºä¾‹-1" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ç¤ºä¾‹-1"><span>å®é™…åº”ç”¨ç¤ºä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åº”ç”¨ï¼Œè¯¥åº”ç”¨éœ€è¦ä»ä¸€ä¸ªæ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚ä½†æ˜¯ï¼Œåœ¨è¯»å–è¿‡ç¨‹ä¸­ï¼Œä½ å¸Œæœ›ç”¨æˆ·èƒ½å¤Ÿéšæ—¶å–æ¶ˆè¯»å–ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•å®ç°è¿™ä¸€åŠŸèƒ½çš„æ­¥éª¤ï¼š</p><ol><li><strong>åˆ›å»ºå¯è¯»æµå¹¶è·å–é˜…è¯»å™¨</strong>ï¼š<br> å…ˆå‡è®¾ä½ å·²ç»æœ‰äº†ä¸€ä¸ª<code>ReadableStream</code>å¯¹è±¡ï¼ˆä¾‹å¦‚ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®çš„æµï¼‰ã€‚ä½ ä¼šé¦–å…ˆè·å–è¿™ä¸ªæµçš„é˜…è¯»å™¨ï¼š</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="2"><li><p><strong>å¼€å§‹è¯»å–æ•°æ®</strong>ï¼š<br> é€šå¸¸ï¼Œä½ ä¼šå¼€å§‹ä½¿ç”¨é˜…è¯»å™¨æŒ‰åºè¯»å–æ•°æ®ã€‚ä½†ä¸ºäº†ç®€æ´ï¼Œæˆ‘ä»¬è·³è¿‡å…·ä½“çš„è¯»å–æ­¥éª¤ã€‚</p></li><li><p><strong>å–æ¶ˆè¯»å–</strong>ï¼š<br> åŸºäºæŸç§æ¡ä»¶ï¼Œæ¯”å¦‚ç”¨æˆ·çš„è¾“å…¥æˆ–å…¶ä»–ä¸šåŠ¡é€»è¾‘ï¼Œä½ å†³å®šå–æ¶ˆè¯»å–æµï¼š</p></li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">reader</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">cancel</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ç”¨æˆ·å–æ¶ˆæ“ä½œ</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">å·²æˆåŠŸå–æ¶ˆè¯»å–æµ</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">å–æ¶ˆè¯»å–æµæ—¶å‡ºé”™ï¼š</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>&#39;ç”¨æˆ·å–æ¶ˆæ“ä½œ&#39;</code>æ˜¯ä¼ é€’ç»™<code>.cancel()</code>æ–¹æ³•çš„ç†ç”±ã€‚è¿™ä¸ªç†ç”±ä¼šè¢«ç”¨æ¥é€šçŸ¥æµæˆ–å…¶æ¶ˆè´¹è€…å…³äºå–æ¶ˆæ“ä½œçš„è¯¦ç»†ä¿¡æ¯ï¼Œä»¥ä¾¿è¿›è¡Œé€‚å½“çš„é”™è¯¯å¤„ç†æˆ–æ¸…ç†å·¥ä½œã€‚</p><h3 id="å°ç»“" tabindex="-1"><a class="header-anchor" href="#å°ç»“"><span>å°ç»“</span></a></h3><p><code>readableStreamDefaultReader.cancel([reason])</code>æ–¹æ³•æ˜¯ Node.js ä¸­ç”¨äºåœæ­¢ä»å¯è¯»æµä¸­è¯»å–æ•°æ®çš„æœºåˆ¶ã€‚é€šè¿‡æä¾›å–æ¶ˆåŸå› ï¼Œå®ƒå…è®¸å¼€å‘è€…ä¼˜é›…åœ°å¤„ç†å–æ¶ˆæ“ä½œï¼Œå¹¶ç¡®ä¿èµ„æºå¾—åˆ°æ­£ç¡®çš„æ¸…ç†å’Œé”™è¯¯å¤„ç†ã€‚è¿™åœ¨å¤„ç†å¤§å‹æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚ç­‰åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨ã€‚</p><h4 id="readablestreamdefaultreader-closed" tabindex="-1"><a class="header-anchor" href="#readablestreamdefaultreader-closed"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreamdefaultreaderclosed" target="_blank" rel="noopener noreferrer">readableStreamDefaultReader.closed</a></span></a></h4><p>åœ¨ Node.js ä¸­ï¼Œ<code>readableStreamDefaultReader.closed</code> æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†æµï¼ˆstreamï¼‰æ•°æ®æ—¶ã€‚ä¸ºäº†ä½¿ä½ æ›´å¥½åœ°ç†è§£è¿™ä¸€æ¦‚å¿µï¼Œè®©æˆ‘ä»¬ä»åŸºç¡€å¼€å§‹è§£é‡Šï¼Œå¹¶é€æ­¥æ·±å…¥ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯æµ-stream-1" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯æµ-stream-1"><span>ä»€ä¹ˆæ˜¯æµï¼ˆStreamï¼‰ï¼Ÿ</span></a></h3><p>ç®€å•æ¥è¯´ï¼Œæµæ˜¯ä¸€ç³»åˆ—è¿ç»­çš„æ•°æ®ã€‚æƒ³è±¡ä¸€ä¸‹æ°´æµï¼Œæ°´ä¸æ–­åœ°ä»ä¸€å¤´æµå‘å¦ä¸€å¤´ï¼Œæµæ•°æ®ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œæ•°æ®åƒæ°´ä¸€æ ·ä»ä¸€ä¸ªæºå¤´æµå‘ç›®çš„åœ°ã€‚åœ¨ Node.js ä¸­ï¼Œæµè¢«ç”¨äºè¯»å–æˆ–å†™å…¥å¤§å‹æ–‡ä»¶ï¼Œæˆ–è€…ä¸ç½‘ç»œé€šä¿¡ç­‰ï¼Œå› ä¸ºå®ƒä»¬ä¸éœ€è¦ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè€Œæ˜¯å¯ä»¥é€æ¸å¤„ç†ï¼Œè¿™å¯¹äºå¤„ç†å¤§é‡æ•°æ®éå¸¸æœ‰æ•ˆã€‚</p><h3 id="readablestream-å’Œ-readablestreamdefaultreader" tabindex="-1"><a class="header-anchor" href="#readablestream-å’Œ-readablestreamdefaultreader"><span>ReadableStream å’Œ ReadableStreamDefaultReader</span></a></h3><p>åœ¨ Node.js çš„ Web Streams API ä¸­ï¼Œ<code>ReadableStream</code> è¡¨ç¤ºä¸€ä¸ªå¯è¯»æµçš„æ¥å£ã€‚è¿™æ„å‘³ç€ï¼Œå®ƒæ˜¯æ•°æ®ç”Ÿäº§è€…çš„æŠ½è±¡è¡¨ç¤ºï¼Œä½ å¯ä»¥ä»ä¸­è¯»å–æ•°æ®ã€‚</p><p>å½“ä½ æƒ³ä»¥æ›´ä½çº§åˆ«ã€æ›´ç²¾ç»†çš„æ§åˆ¶æ–¹å¼ä» <code>ReadableStream</code> è¯»å–æ•°æ®æ—¶ï¼Œå°±ä¼šä½¿ç”¨åˆ° <code>ReadableStreamDefaultReader</code>ã€‚åˆ›å»ºä¸€ä¸ª <code>ReadableStreamDefaultReader</code> å®ä¾‹å…è®¸ä½ æŒ‰ç…§éœ€æ±‚é€ä¸ªç‰‡æ®µåœ°è¯»å–æµä¸­çš„æ•°æ®ï¼Œæ¯”å¦‚ä¸€å—ä¸€å—åœ°è¯»å–æ–‡ä»¶å†…å®¹ï¼Œæˆ–ä¸€æ¡ä¸€æ¡åœ°å¤„ç†æ—¥å¿—ä¿¡æ¯ã€‚</p><h3 id="readablestreamdefaultreader-closed-1" tabindex="-1"><a class="header-anchor" href="#readablestreamdefaultreader-closed-1"><span>readableStreamDefaultReader.closed</span></a></h3><p>ç°åœ¨è®©æˆ‘ä»¬æ¥è°ˆè°ˆ <code>.closed</code> å±æ€§ã€‚è¿™æ˜¯ä¸€ä¸ª <code>Promise</code>ï¼Œå®ƒè¡¨ç¤ºé˜…è¯»å™¨ï¼ˆ<code>ReadableStreamDefaultReader</code>ï¼‰çš„çŠ¶æ€ã€‚ç®€å•æ¥è¯´ï¼Œ<code>.closed</code> ä¼šå‘Šè¯‰ä½ æµè¯»å–å™¨æ˜¯å¦å·²ç»å…³é—­ã€‚</p><ul><li><strong>å¦‚æœæµè¯»å–å™¨æ­£å¸¸å…³é—­</strong>ï¼ˆå³æˆåŠŸè¯»å–å®Œæ¯•ï¼‰ï¼Œè¿™ä¸ª promise ä¼šè¢«è§£å†³ï¼ˆresolveï¼‰ã€‚</li><li><strong>å¦‚æœæµè¯»å–å™¨ç”±äºé”™è¯¯è€Œå…³é—­</strong>ï¼ˆæ¯”å¦‚è¯»å–è¿‡ç¨‹ä¸­é‡åˆ°äº†é—®é¢˜ï¼‰ï¼Œè¿™ä¸ª promise ä¼šè¢«æ‹’ç»ï¼ˆrejectï¼‰ã€‚</li></ul><p>è¿™å¯¹äºç®¡ç†æµçš„å¼‚æ­¥æ“ä½œéå¸¸æœ‰ç”¨ã€‚é€šè¿‡ç›‘å¬ <code>.closed</code> çš„çŠ¶æ€ï¼Œä½ å¯ä»¥çŸ¥é“ä½•æ—¶æµæ•°æ®å·²ç»å…¨éƒ¨å¤„ç†å®Œæ¯•ï¼Œæˆ–è€…åœ¨å‡ºç°é”™è¯¯æ—¶é‡‡å–ç›¸åº”çš„æ“ä½œã€‚</p><h3 id="å®é™…ä¾‹å­-1" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-1"><span>å®é™…ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨æ„å»ºä¸€ä¸ªç½‘ç«™ï¼Œéœ€è¦ä»æœåŠ¡å™¨è¯»å–ä¸€ä¸ªå¾ˆå¤§çš„è§†é¢‘æ–‡ä»¶ï¼Œå¹¶å¸Œæœ›è¾¹ä¸‹è½½è¾¹æ’­æ”¾ã€‚</p><ol><li><p><strong>åˆ›å»º <code>ReadableStreamDefaultReader</code> è¯»å–æµæ•°æ®</strong>ï¼šé¦–å…ˆï¼Œä½ ä»æœåŠ¡å™¨è¯·æ±‚è§†é¢‘æ–‡ä»¶ï¼Œå¾—åˆ°ä¸€ä¸ª <code>ReadableStream</code> å¯¹è±¡ã€‚ç„¶åï¼Œä½ åˆ›å»ºä¸€ä¸ª <code>ReadableStreamDefaultReader</code> æ¥è¯»å–è¿™ä¸ªæµã€‚</p></li><li><p><strong>ç›‘æ§ <code>.closed</code> çŠ¶æ€</strong>ï¼šä½ åˆ©ç”¨ <code>.closed</code> å±æ€§æ¥è®¾ç½®å½“æ•´ä¸ªè§†é¢‘æµæˆåŠŸè¯»å–å®Œæ¯•æ—¶çš„æ“ä½œï¼Œä¾‹å¦‚ï¼Œæ˜¾ç¤ºä¸€ä¸ªæç¤ºå‘ŠçŸ¥ç”¨æˆ·è§†é¢‘åŠ è½½å®Œæˆã€‚åŒæ—¶ï¼Œä½ ä¹Ÿå¯ä»¥è®¾ç½®ä¸€ä¸ªé”™è¯¯å¤„ç†å™¨ï¼Œä»¥ä¾¿åœ¨è¯»å–è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶æé†’ç”¨æˆ·ã€‚</p></li><li><p><strong>æµå¼å¤„ç†æ•°æ®</strong>ï¼šé€šè¿‡ <code>ReadableStreamDefaultReader</code>ï¼Œä½ å¯ä»¥æ§åˆ¶æ•°æ®çš„æµå¼ä¼ è¾“ï¼Œå®ç°è¾¹ä¸‹è½½è¾¹æ’­æ”¾è§†é¢‘çš„æ•ˆæœã€‚</p></li></ol><p>ä»£ç ç¤ºä¾‹ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾ fetchVideoStream() å‡½æ•°è·å–è§†é¢‘çš„ ReadableStream</span></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> loadVideo</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#88C0D0;"> fetchVideoStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">      const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">      if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">break;</span></span>
<span class="line"><span style="color:#616E88;">      // å¤„ç†æ¯å—æ•°æ®ï¼Œä¾‹å¦‚ï¼Œæ·»åŠ åˆ°è§†é¢‘æ’­æ”¾å™¨ç¼“å†²åŒº</span></span>
<span class="line"><span style="color:#88C0D0;">      processVideoChunk</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> catch</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">error</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Stream reading failed:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> finally</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">releaseLock</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // ç›‘å¬æµå…³é—­çŠ¶æ€</span></span>
<span class="line"><span style="color:#D8DEE9;">  reader</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">closed</span></span>
<span class="line"><span style="color:#ECEFF4;">    .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Stream finished reading.</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">    .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Stream reading was interrupted</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">loadVideo</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¾‹å­å¤§è‡´å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>ReadableStreamDefaultReader</code> å’Œ <code>.closed</code> å±æ€§æ¥å¼‚æ­¥å¤„ç†è§†é¢‘æ•°æ®æµï¼Œæä¾›ä¸€ä¸ªæµç•…çš„ç”¨æˆ·ä½“éªŒã€‚å¸Œæœ›è¿™æœ‰åŠ©äºä½ ç†è§£ <code>readableStreamDefaultReader.closed</code> åœ¨å®é™…åº”ç”¨ä¸­çš„ä½œç”¨å’Œä»·å€¼ã€‚</p><h4 id="readablestreamdefaultreader-read" tabindex="-1"><a class="header-anchor" href="#readablestreamdefaultreader-read"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreamdefaultreaderread" target="_blank" rel="noopener noreferrer">readableStreamDefaultReader.read()</a></span></a></h4><p>å½“æˆ‘ä»¬åœ¨è°ˆè®º Node.js ä¸­çš„ <code>readableStreamDefaultReader.read()</code> æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯åœ¨è®¨è®ºå¦‚ä½•ä»ä¸€ä¸ªå¯è¯»æµï¼ˆReadable Streamï¼‰ä¸­å¼‚æ­¥åœ°è¯»å–æ•°æ®ã€‚ä¸ºäº†è®©è¿™ä¸ªæ¦‚å¿µæ›´æ˜“äºç†è§£ï¼Œæˆ‘å°†é€šè¿‡ä¸€äº›åŸºæœ¬æ¦‚å¿µå’Œå‡ ä¸ªå®é™…çš„ä¾‹å­æ¥è¿›è¡Œè§£é‡Šã€‚</p><h3 id="åŸºæœ¬æ¦‚å¿µ-1" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ¦‚å¿µ-1"><span>åŸºæœ¬æ¦‚å¿µ</span></a></h3><p>é¦–å…ˆï¼Œäº†è§£ä»€ä¹ˆæ˜¯æµï¼ˆStreamï¼‰éå¸¸é‡è¦ã€‚åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œ<strong>æµ</strong>æ˜¯æ•°æ®çš„åºåˆ—ï¼Œå®ƒä»¬å¯ä»¥æ˜¯è¿ç»­ä¼ è¾“çš„ï¼Œå…è®¸è¢«æ“ä½œçš„æ•°æ®ä¸€éƒ¨åˆ†ä¸€éƒ¨åˆ†åœ°è¿›è¡Œå¤„ç†ï¼Œè€Œä¸éœ€è¦ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰æ•°æ®éƒ½åŠ è½½åˆ°å†…å­˜ä¸­ã€‚è¿™ä½¿å¾—æµéå¸¸é€‚åˆå¤„ç†å¤§é‡æ•°æ®æˆ–è€…æ¥è‡ªå¤–éƒ¨æºï¼ˆæ¯”å¦‚æ–‡ä»¶æˆ–ç½‘ç»œï¼‰çš„æ•°æ®ã€‚</p><p>Node.js ä½¿ç”¨æµæ¥å¤„ç†ä¾‹å¦‚è¯»å†™æ–‡ä»¶ã€ç½‘ç»œé€šä¿¡ç­‰åœºæ™¯ã€‚åœ¨è¿™äº›åœºæ™¯ä¸­ï¼Œ<code>readableStreamDefaultReader.read()</code> æ–¹æ³•å…è®¸æˆ‘ä»¬ä»æµä¸­æŒ‰å—è¯»å–æ•°æ®ã€‚</p><h3 id="readablestreamdefaultreader-read-1" tabindex="-1"><a class="header-anchor" href="#readablestreamdefaultreader-read-1"><span><code>readableStreamDefaultReader.read()</code></span></a></h3><p><code>readableStreamDefaultReader.read()</code> æ–¹æ³•æ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œç”¨äºä»å¯è¯»æµä¸­è¯»å–æ•°æ®ã€‚å½“ä½ è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª Promiseï¼Œè¿™ä¸ª Promise æœ€ç»ˆä¼šè§£ææˆä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«ä¸¤ä¸ªå±æ€§ï¼š</p><ul><li><code>value</code>ï¼šè¯»å–çš„æ•°æ®å—ã€‚</li><li><code>done</code>ï¼šä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå¦‚æœæµä¸­æ²¡æœ‰æ›´å¤šæ•°æ®å¯è¯»ï¼Œåˆ™å€¼ä¸º <code>true</code>ï¼›å¦åˆ™ä¸º <code>false</code>ã€‚</li></ul><h3 id="ä¾‹å­-1" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1"><span>ä¾‹å­</span></a></h3><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªä»æ–‡ä»¶è¯»å–æ•°æ®çš„æµï¼Œå¹¶ä¸”æƒ³è¦é€å—å¤„ç†è¿™äº›æ•°æ®ã€‚</p><h4 id="æ­¥éª¤-1-åˆ›å»ºå¯è¯»æµ" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-1-åˆ›å»ºå¯è¯»æµ"><span>æ­¥éª¤ 1: åˆ›å»ºå¯è¯»æµ</span></a></h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå¯è¯»æµã€‚åœ¨ Node.js ä¸­ï¼Œè¿™å¯ä»¥é€šè¿‡ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿï¼ˆ<code>fs</code>ï¼‰æ¨¡å—æ¥å®ç°ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯è¯»æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ­¥éª¤-2-è·å–æµçš„é˜…è¯»å™¨" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-2-è·å–æµçš„é˜…è¯»å™¨"><span>æ­¥éª¤ 2: è·å–æµçš„é˜…è¯»å™¨</span></a></h4><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦è·å–è¿™ä¸ªæµçš„é˜…è¯»å™¨ï¼ˆreaderï¼‰ï¼Œè¿™ä¸ªé˜…è¯»å™¨å°†ç”¨äºè¯»å–æµä¸­çš„æ•°æ®ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æ³¨æ„ï¼šåœ¨ Node.js çš„æŸäº›ç‰ˆæœ¬ä¸­å¯èƒ½éœ€è¦ä¸åŒçš„æ–¹å¼æ¥è·å–é˜…è¯»å™¨æˆ–ç›´æ¥ä½¿ç”¨æµï¼Œå…·ä½“å–å†³äº API çš„å˜åŒ–ã€‚</p><h4 id="æ­¥éª¤-3-ä½¿ç”¨-read-æ–¹æ³•è¯»å–æ•°æ®" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-3-ä½¿ç”¨-read-æ–¹æ³•è¯»å–æ•°æ®"><span>æ­¥éª¤ 3: ä½¿ç”¨ <code>read()</code> æ–¹æ³•è¯»å–æ•°æ®</span></a></h4><p>æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>read()</code> æ–¹æ³•æ¥ä»æµä¸­è¯»å–æ•°æ®ã€‚æ¯æ¬¡è°ƒç”¨ <code>read()</code> æ–¹æ³•æ—¶ï¼Œå®ƒéƒ½ä¼šè¿”å›ä¸€ä¸ª Promiseï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code>async/await</code> æ¥å¤„ç†è¿™ä¸ª Promiseã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> readStream</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">      break;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#88C0D0;">readStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>readStream</code> å‡½æ•°ä¼šæŒç»­ä» <code>readableStream</code> ä¸­è¯»å–æ•°æ®ï¼Œç›´åˆ°æ²¡æœ‰æ›´å¤šæ•°æ®å¯è¯»ï¼ˆå³ <code>done</code> ä¸º <code>true</code>ï¼‰ã€‚æ¯æ¬¡è¯»å–åˆ°æ•°æ®æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡ <code>console.log</code> å°†å…¶è¾“å‡ºã€‚</p><h3 id="æ€»ç»“-3" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-3"><span>æ€»ç»“</span></a></h3><p>é€šè¿‡ä½¿ç”¨ <code>readableStreamDefaultReader.read()</code>ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥éå¸¸çµæ´»å’Œé«˜æ•ˆçš„æ–¹å¼å¤„ç†æµå¼æ•°æ®ã€‚è¿™å¯¹äºå¤„ç†å¤§æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚æˆ–ä»»ä½•ç±»å‹çš„å¤§è§„æ¨¡æ•°æ®éƒ½éå¸¸æœ‰ç”¨ã€‚å¸Œæœ›è¿™ä¸ªè§£é‡Šå’Œä¾‹å­èƒ½å¸®åŠ©ä½ ç†è§£ Node.js ä¸­å…³äºæµçš„å¤„ç†æ–¹å¼ï¼</p><h4 id="readablestreamdefaultreader-releaselock" tabindex="-1"><a class="header-anchor" href="#readablestreamdefaultreader-releaselock"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreamdefaultreaderreleaselock" target="_blank" rel="noopener noreferrer">readableStreamDefaultReader.releaseLock()</a></span></a></h4><p>ç†è§£ <code>readableStreamDefaultReader.releaseLock()</code> å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç®€å•äº†è§£å‡ ä¸ªæ¦‚å¿µï¼šNode.jsã€Streams å’Œ ReadableStreamDefaultReaderã€‚</p><ol><li><strong>Node.js</strong>ï¼šä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œè®©ä½ å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScriptã€‚</li><li><strong>Streamsï¼ˆæµï¼‰</strong>ï¼šåœ¨ Node.js ä¸­ï¼Œæµæ˜¯ä¸€ç§å¤„ç†æ•°æ®çš„æ–¹å¼ï¼Œå°¤å…¶æ˜¯å¤§é‡æ•°æ®ã€‚æ¯”å¦‚ï¼Œä»ä¸€ä¸ªæ–‡ä»¶è¯»å–æ•°æ®æˆ–å†™å…¥æ•°æ®æ—¶ï¼Œå¦‚æœæ–‡ä»¶éå¸¸å¤§ï¼Œä¸€æ¬¡æ€§è¯»å–å¯èƒ½ä¼šå ç”¨å¤ªå¤šå†…å­˜ã€‚ä½¿ç”¨æµï¼Œä½ å¯ä»¥ä¸€å°å—ä¸€å°å—åœ°å¤„ç†æ•°æ®ï¼Œæœ‰æ•ˆæ§åˆ¶å†…å­˜ä½¿ç”¨ã€‚</li><li><strong>ReadableStreamDefaultReader</strong>ï¼šè¿™æ˜¯ Web Streams API çš„ä¸€éƒ¨åˆ†ï¼Œæä¾›äº†ä¸€ä¸ªæ¥å£æ¥è¯»å–æµå¼æ•°æ®ã€‚å½“ä½ æœ‰ä¸€ä¸ªå¯è¯»æµæ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ¥å£ä»¥ä¸€ç§æ§åˆ¶çš„æ–¹å¼è¯»å–æ•°æ®ã€‚</li></ol><p>å¥½äº†ï¼Œç°åœ¨è®©æˆ‘ä»¬èšç„¦äº <code>readableStreamDefaultReader.releaseLock()</code>ã€‚</p><h3 id="readablestreamdefaultreader-releaselock-1" tabindex="-1"><a class="header-anchor" href="#readablestreamdefaultreader-releaselock-1"><span>readableStreamDefaultReader.releaseLock()</span></a></h3><p>è¿™ä¸ªæ–¹æ³•çš„ä¸»è¦ç›®çš„æ˜¯é‡Šæ”¾è¯»å–å™¨ï¼ˆ<code>reader</code>ï¼‰å¯¹æµçš„é”å®šã€‚å½“ä¸€ä¸ª <code>ReadableStream</code> è¢«é”å®šåˆ°ä¸€ä¸ª <code>reader</code> æ—¶ï¼Œåªæœ‰è¿™ä¸ª <code>reader</code> å¯ä»¥ä»æµä¸­è¯»å–æ•°æ®ã€‚å¦‚æœä½ æƒ³è¦ç”¨å¦ä¸€ä¸ª <code>reader</code> è¯»å–æ•°æ®ï¼Œæˆ–è€…è®©æµå›åˆ°åŸå§‹çŠ¶æ€ï¼Œå¯ä»¥è¢«ä»»ä½•æ“ä½œæ‰€æ¥è§¦ï¼Œå°±éœ€è¦å…ˆé‡Šæ”¾å½“å‰çš„é”ã€‚</p><h4 id="ä½¿ç”¨åœºæ™¯ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯ç¤ºä¾‹"><span>ä½¿ç”¨åœºæ™¯ç¤ºä¾‹</span></a></h4><p>å‡è®¾ä½ åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œè¿™ä¸ªåº”ç”¨éœ€è¦ä»ä¸€ä¸ªå¤§å‹æ—¥å¿—æ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚ä¸ºäº†ä¼˜åŒ–å†…å­˜ä½¿ç”¨ï¼Œä½ å†³å®šä½¿ç”¨æµæ¥é€æ­¥è¯»å–æ–‡ä»¶å†…å®¹ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStreamDefaultReader</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾ &#39;large-log.txt&#39; æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">large-log.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">async</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStreamDefaultReader</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">      // é€æ­¥è¯»å–æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">      const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">      if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">break;</span><span style="color:#616E88;"> // å¦‚æœæ²¡æœ‰æ›´å¤šæ•°æ®ï¼Œé€€å‡ºå¾ªç¯</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å¤„ç†æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> finally</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">releaseLock</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å³ä½¿åœ¨å‡ºç°é”™è¯¯çš„æƒ…å†µä¸‹ä¹Ÿç¡®ä¿é‡Šæ”¾é”</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼š</p><ul><li>æˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘ â€˜large-log.txtâ€™ æ–‡ä»¶çš„æµã€‚</li><li>ç„¶åæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª <code>ReadableStreamDefaultReader</code> å®ä¾‹æ¥è¯»å–è¿™ä¸ªæµã€‚</li><li>åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>reader.read()</code> é€æ­¥è¯»å–æµä¸­çš„æ•°æ®ã€‚</li><li>å½“æ‰€æœ‰æ•°æ®éƒ½è¯»å–å®Œæ¯•ï¼Œæˆ–è€…åœ¨å®Œæˆè¯»å–ä»»åŠ¡åï¼ˆæ— è®ºæˆåŠŸè¿˜æ˜¯å› ä¸ºé”™è¯¯ï¼‰ï¼Œæˆ‘ä»¬è°ƒç”¨ <code>reader.releaseLock()</code> æ¥é‡Šæ”¾å¯¹æµçš„é”å®šã€‚</li></ul><p>ä½¿ç”¨ <code>releaseLock()</code> æ–¹æ³•æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å®Œæ•°æ®ä¹‹åï¼Œå› ä¸ºå®ƒèƒ½ç¡®ä¿èµ„æºè¢«æ­£ç¡®æ¸…ç†ï¼Œè®©æµå¯ä»¥è¢«å…¶ä»– <code>reader</code> å®ä¾‹å†æ¬¡ä½¿ç”¨æˆ–è€…å…³é—­ã€‚</p><p>è¿™æ ·ï¼Œå°±ç®—ä½ é‡åˆ°äº†éœ€è¦ä¸­é€”æ›´æ¢è¯»å–ç­–ç•¥ï¼Œæˆ–è€…å‡ºäºæŸäº›åŸå› éœ€è¦åœæ­¢è¯»å–å¹¶å…è®¸å…¶ä»–æ“ä½œè®¿é—®æµçš„æƒ…å†µï¼Œä¹Ÿèƒ½çµæ´»åº”å¯¹ï¼Œç¡®ä¿åº”ç”¨çš„å¥å£®æ€§å’Œçµæ´»æ€§ã€‚</p><h3 id="class-readablestreambyobreader" tabindex="-1"><a class="header-anchor" href="#class-readablestreambyobreader"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-readablestreambyobreader" target="_blank" rel="noopener noreferrer">Class: ReadableStreamBYOBReader</a></span></a></h3><p>è®©æˆ‘ä»¬ä¸€æ­¥æ­¥è§£é‡Š <code>ReadableStreamBYOBReader</code> è¿™ä¸ªæ¦‚å¿µï¼Œå¹¶ä¸”é€šè¿‡ä¸€äº›å®é™…ä¾‹å­æ¥ç†è§£å®ƒåœ¨ Node.js ä¸­çš„åº”ç”¨ã€‚</p><h3 id="åŸºç¡€æ¦‚å¿µ-2" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ-2"><span>åŸºç¡€æ¦‚å¿µ</span></a></h3><p>é¦–å…ˆï¼Œäº†è§£ <code>ReadableStreamBYOBReader</code> éœ€è¦æŒæ¡å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š</p><ol><li><p><strong>Streamsï¼ˆæµï¼‰</strong>: åœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯ä¸€ç³»åˆ—è¿ç»­çš„æ•°æ®ã€‚æƒ³è±¡æˆæ°´æµï¼Œæ•°æ®åƒæ°´ä¸€æ ·ä»ä¸€ä¸ªåœ°æ–¹æµå‘å¦ä¸€ä¸ªåœ°æ–¹ã€‚åœ¨ Node.js ä¸­ï¼Œæµè¢«ç”¨æ¥é«˜æ•ˆå¤„ç†è¯»å†™æ“ä½œï¼Œæ¯”å¦‚è¯»å–æ–‡ä»¶æˆ–ç½‘ç»œé€šä¿¡ã€‚</p></li><li><p><strong>ReadableStreamï¼ˆå¯è¯»æµï¼‰</strong>: æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œä¸“æ³¨äºè¯»å–æ•°æ®ã€‚ä½ å¯ä»¥ä»ä¸­è·å–æ•°æ®ï¼Œå°±åƒä»æ–‡ä»¶æˆ–æœåŠ¡å™¨è¯·æ±‚ä¸­è¯»å–æ•°æ®ã€‚</p></li><li><p><strong>BYOB - Bring Your Own Bufferï¼ˆè‡ªå¸¦ç¼“å†²åŒºï¼‰</strong>: è¿™ä¸ªæ¦‚å¿µå…è®¸ä½ æ§åˆ¶æ•°æ®è¢«è¯»å–åˆ°å“ªé‡Œï¼Œå³ä½ æä¾›ä¸€ä¸ªç¼“å†²åŒºï¼ˆBufferï¼‰ï¼Œæ•°æ®å°†è¢«ç›´æ¥è¯»å–åˆ°è¿™ä¸ªç¼“å†²åŒºã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥å‡å°‘å†…å­˜ä½¿ç”¨å’Œæé«˜æ€§èƒ½ï¼Œå› ä¸ºå‡å°‘äº†ä¸å¿…è¦çš„æ‹·è´æ“ä½œã€‚</p></li></ol><h3 id="readablestreambyobreader-è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#readablestreambyobreader-è¯¦è§£"><span>ReadableStreamBYOBReader è¯¦è§£</span></a></h3><p><code>ReadableStreamBYOBReader</code> æ˜¯ Node.js ä¸­ç”¨äºè¯»å–æµæ•°æ®çš„ä¸€ä¸ªç±»ï¼Œä¸“é—¨ä¸ BYOB ç›¸å…³çš„æµï¼ˆé‚£äº›æ”¯æŒâ€œè‡ªå¸¦ç¼“å†²åŒºâ€æ¨¡å¼çš„æµï¼‰é…åˆä½¿ç”¨ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥é€šè¿‡è¿™ä¸ªæ¥å£æ›´ç»†ç²’åº¦åœ°æ§åˆ¶æ•°æ®çš„è¯»å–ï¼ŒåŒ…æ‹¬ç¼“å†²åŒºçš„åˆ†é…å’Œå¡«å……ã€‚</p><h3 id="ä½¿ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯"><span>ä½¿ç”¨åœºæ™¯</span></a></h3><p>ç†è§£äº†åŸºç¡€æ¦‚å¿µï¼Œæ¥ä¸‹æ¥çœ‹ä¸€äº›å…·ä½“çš„ä½¿ç”¨åœºæ™¯ï¼š</p><ol><li><p><strong>æ–‡ä»¶è¯»å–</strong>: å½“ä½ éœ€è¦ä»ä¸€ä¸ªå¤§æ–‡ä»¶ä¸­è¯»å–æ•°æ®æ—¶ï¼Œä½¿ç”¨ <code>ReadableStreamBYOBReader</code> å¯ä»¥è®©ä½ æ›´æœ‰æ•ˆåœ°ç®¡ç†å†…å­˜ã€‚ä½ å¯ä»¥ä¸ºæ¯æ¬¡è¯»å–åˆ†é…å›ºå®šå¤§å°çš„ç¼“å†²åŒºï¼Œè€Œä¸æ˜¯è®©ç³»ç»Ÿå†³å®šå¦‚ä½•åŠ è½½å…¨éƒ¨æˆ–éƒ¨åˆ†æ–‡ä»¶åˆ°å†…å­˜ä¸­ã€‚</p></li><li><p><strong>éŸ³è§†é¢‘æ•°æ®å¤„ç†</strong>: åœ¨å¤„ç†å¤§å‹åª’ä½“æ–‡ä»¶ï¼ˆå¦‚è§†é¢‘ç¼–è¾‘æˆ–éŸ³é¢‘å¤„ç†ï¼‰æ—¶ï¼Œ<code>ReadableStreamBYOBReader</code> å…è®¸ä½ åªåŠ è½½æ‰€éœ€çš„æ•°æ®éƒ¨åˆ†åˆ°å†…å­˜ä¸­ï¼Œæé«˜å¤„ç†é€Ÿåº¦å’Œæ•ˆç‡ã€‚</p></li><li><p><strong>ç½‘ç»œé€šä¿¡</strong>: åœ¨ä»ç½‘ç»œè¯·æ±‚è¯»å–æ•°æ®æ—¶ï¼Œä½¿ç”¨ <code>ReadableStreamBYOBReader</code> å¯ä»¥å¸®åŠ©ä½ æ›´å¥½åœ°æ§åˆ¶å†…å­˜ä½¿ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤§é‡å¹¶å‘è¯·æ±‚çš„æœåŠ¡å™¨ç¯å¢ƒä¸­ã€‚</p></li></ol><h3 id="å®é™…ä¾‹å­-2" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-2"><span>å®é™…ä¾‹å­</span></a></h3><p>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€åŒ–çš„ä»£ç ç¤ºä¾‹æ¥è¯´æ˜å¦‚ä½•ä½¿ç”¨ <code>ReadableStreamBYOBReader</code>ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾æœ‰ä¸€ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªæ”¯æŒBYOBçš„å¯è¯»æµ</span></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> getBYOBStream</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // è¿™é‡Œç®€åŒ–äº†çœŸå®æƒ…å†µï¼Œå®é™…ä¸Šè¿™ä¸ªæµåº”è¯¥æ˜¯æ”¯æŒBYOBè¯»å–çš„æ•°æ®æº</span></span>
<span class="line"><span style="color:#81A1C1;">  return</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">    pull</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // å¡«å……æ•°æ®åˆ°controller.byobRequest.view</span></span>
<span class="line"><span style="color:#616E88;">      // controller.byobRequest.respond(bytesWritten); æ ‡è®°å¡«å……å®Œæˆ</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#88C0D0;">    type</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">bytes</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#616E88;"> // è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ”¯æŒBYOBçš„æµ</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> readDataFromStream</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> getBYOBStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> mode</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">byob</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> Uint8Array</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">1024</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // åˆ†é…ä¸€ä¸ª1024å­—èŠ‚çš„ç¼“å†²åŒº</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">      break;</span><span style="color:#616E88;"> // å¦‚æœæ²¡æœ‰æ›´å¤šæ•°æ®ï¼Œé€€å‡ºå¾ªç¯</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å¤„ç†è¯»å–åˆ°çš„æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">  reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">releaseLock</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // é‡Šæ”¾é”ï¼Œå…è®¸å…¶ä»–readerè¯»å–</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">readDataFromStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªæ”¯æŒ BYOB çš„ <code>ReadableStream</code>ï¼Œç„¶åé€šè¿‡ <code>ReadableStreamBYOBReader</code> è¯»å–æ•°æ®åˆ°ä¸€ä¸ªæŒ‡å®šå¤§å°çš„ç¼“å†²åŒºã€‚è¯·æ³¨æ„ï¼Œå®é™…ä½¿ç”¨ä¸­ï¼Œæµçš„æ¥æºå¯èƒ½æ˜¯æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚ç­‰ï¼Œè¿™é‡Œä»…å±•ç¤ºäº†æ¦‚å¿µå’Œè¯»å–è¿‡ç¨‹ã€‚</p><p>æ€»ç»“æ¥è¯´ï¼Œ<code>ReadableStreamBYOBReader</code> æä¾›äº†ä¸€ç§æ›´çµæ´»ã€é«˜æ•ˆçš„æ•°æ®è¯»å–æ–¹å¼ï¼Œç‰¹åˆ«é€‚ç”¨äºå¤„ç†å¤§å‹æ•°æ®é›†å’Œéœ€è¦ç²¾ç»†å†…å­˜ç®¡ç†çš„åœºåˆã€‚</p><h4 id="new-readablestreambyobreader-stream" tabindex="-1"><a class="header-anchor" href="#new-readablestreambyobreader-stream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#new-readablestreambyobreaderstream" target="_blank" rel="noopener noreferrer">new ReadableStreamBYOBReader(stream)</a></span></a></h4><p>Node.js ä¸­çš„<code>ReadableStreamBYOBReader(stream)</code>æ˜¯ä¸€ä¸ªæ¯”è¾ƒå…ˆè¿›ä¸”ç‰¹å®šç”¨é€”çš„åŠŸèƒ½ï¼Œå±äº Web Streams API çš„ä¸€éƒ¨åˆ†ã€‚è¿™é‡Œï¼Œâ€œBYOBâ€ä»£è¡¨â€œBring Your Own Bufferâ€ï¼Œæ„å³â€œè‡ªå¸¦ç¼“å†²åŒºâ€ã€‚åœ¨è§£é‡Šè¿™ä¸ªæ¦‚å¿µä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£å‡ ä¸ªåŸºç¡€çŸ¥è¯†ç‚¹ã€‚</p><h3 id="åŸºç¡€çŸ¥è¯†" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€çŸ¥è¯†"><span>åŸºç¡€çŸ¥è¯†</span></a></h3><ol><li><p><strong>æµï¼ˆStreamsï¼‰</strong>: åœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯ä¸€ç³»åˆ—çš„æ•°æ®å…ƒç´ ï¼Œå¯ä»¥é€ä¸ªå¤„ç†ï¼Œè€Œä¸å¿…ä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨æ•°æ®ã€‚æµè¢«å¹¿æ³›ç”¨äºå¤„ç†æ–‡ä»¶ã€ç½‘ç»œé€šä¿¡ç­‰åœºæ™¯ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤§é‡æ•°æ®æ—¶ï¼Œæµå¯ä»¥æœ‰æ•ˆå‡å°‘å†…å­˜å ç”¨ï¼Œå¹¶æé«˜åº”ç”¨æ€§èƒ½ã€‚</p></li><li><p><strong>ç¼“å†²åŒºï¼ˆBufferï¼‰</strong>: ç¼“å†²åŒºæ˜¯æš‚æ—¶å­˜å‚¨æ•°æ®çš„å†…å­˜åŒºåŸŸã€‚åœ¨æ•°æ®ä»ä¸€ä¸ªåœ°æ–¹ä¼ è¾“åˆ°å¦ä¸€ä¸ªåœ°æ–¹çš„è¿‡ç¨‹ä¸­ï¼Œç¼“å†²åŒºå……å½“ä¸­ä»‹ï¼Œç¡®ä¿æ•°æ®å¯ä»¥å¹³æ»‘ã€é«˜æ•ˆåœ°ä¼ è¾“ã€‚</p></li></ol><h3 id="readablestreambyobreader-è¯¦è§£-1" tabindex="-1"><a class="header-anchor" href="#readablestreambyobreader-è¯¦è§£-1"><span><code>ReadableStreamBYOBReader</code> è¯¦è§£</span></a></h3><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·±å…¥ç†è§£<code>ReadableStreamBYOBReader</code>ã€‚</p><p>åœ¨ Node.js çš„ Web Streams API ä¸­ï¼Œ<code>ReadableStreamBYOBReader</code>æ˜¯ä¸€ä¸ªç”¨äºè¯»å–æµæ•°æ®çš„æ¥å£ï¼Œå®ƒå…è®¸ä½ æä¾›ä¸€ä¸ªè‡ªå·±çš„ç¼“å†²åŒºï¼ˆbufferï¼‰ï¼Œç”¨æ¥æ¥æ”¶ä»æµä¸­è¯»å–çš„æ•°æ®ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥æ§åˆ¶æ•°æ®å­˜å‚¨çš„ä½ç½®å’Œæ–¹å¼ï¼Œæ›´çµæ´»åœ°ç®¡ç†å†…å­˜ä½¿ç”¨ã€‚</p><h4 id="å¦‚ä½•è¿ä½œ" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•è¿ä½œ"><span>å¦‚ä½•è¿ä½œï¼Ÿ</span></a></h4><p>å½“ä½ åˆ›å»ºä¸€ä¸ª<code>ReadableStreamBYOBReader</code>å®ä¾‹å¹¶å…³è”åˆ°ä¸€ä¸ªå¯è¯»æµä¸Šæ—¶ï¼Œä½ éœ€è¦æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªè‡ªå®šä¹‰çš„ç¼“å†²åŒºã€‚éšåï¼Œå½“æµä¸­çš„æ•°æ®è¢«è¯»å–æ—¶ï¼Œè¿™äº›æ•°æ®å°†ç›´æ¥å†™å…¥ä½ æä¾›çš„ç¼“å†²åŒºä¸­ï¼Œè€Œä¸æ˜¯æµè‡ªåŠ¨ç”Ÿæˆçš„ç¼“å†²åŒºã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å‡å°‘äº†å†…å­˜å¤åˆ¶æ“ä½œï¼Œå¯ä»¥æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§å‹æ•°æ®é›†æ—¶ã€‚</p><h4 id="å®é™…è¿ç”¨ç¤ºä¾‹-4" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-4"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œè¯¥åº”ç”¨éœ€è¦ä»ç½‘ç»œä¸‹è½½ä¸€ä¸ªéå¸¸å¤§çš„æ–‡ä»¶ï¼Œå¹¶ä¸”ä½ æƒ³è¦å°½å¯èƒ½é«˜æ•ˆåœ°å¤„ç†è¿™ä¸ªæ–‡ä»¶çš„æ•°æ®ã€‚</p><ol><li><p><strong>ä¸ä½¿ç”¨<code>ReadableStreamBYOBReader</code>çš„æƒ…å†µ</strong>:</p><p>é€šå¸¸ï¼Œä½ åªéœ€ä½¿ç”¨é»˜è®¤çš„æµ API æ¥è¯»å–æ•°æ®ï¼Œè¿™ç§æƒ…å†µä¸‹ Node.js ä¼šä¸ºä½ ç®¡ç†ç¼“å†²åŒºã€‚ä½†å¦‚æœæ–‡ä»¶éå¸¸å¤§ï¼Œè¿™å¯èƒ½ä¼šå¼•èµ·é¢‘ç¹çš„å†…å­˜åˆ†é…å’Œå›æ”¶ï¼Œå½±å“æ€§èƒ½ã€‚</p></li><li><p><strong>ä½¿ç”¨<code>ReadableStreamBYOBReader</code>çš„æƒ…å†µ</strong>:</p><p>é€šè¿‡åˆ›å»ºä¸€ä¸ª<code>ReadableStreamBYOBReader</code>ï¼Œä½ å¯ä»¥æå‰åˆ†é…ä¸€ä¸ªæˆ–å¤šä¸ªå¤§çš„ç¼“å†²åŒºï¼Œä¸“é—¨ç”¨äºæ¥æ”¶æ–‡ä»¶æ•°æ®ã€‚è¿™æ ·ï¼Œå½“æ•°æ®è¢«è¯»å–æ—¶ï¼Œå®ƒä»¬ä¼šç›´æ¥è¿›å…¥ä½ é¢„å…ˆå‡†å¤‡çš„ç¼“å†²åŒºï¼Œé¿å…äº†é¢å¤–çš„å†…å­˜åˆ†é…å’Œé‡Šæ”¾æ“ä½œï¼Œä½¿å¾—æ•°æ®å¤„ç†æ›´åŠ é«˜æ•ˆã€‚</p></li></ol><h4 id="ä»£ç ç¤ºä¾‹-2" tabindex="-1"><a class="header-anchor" href="#ä»£ç ç¤ºä¾‹-2"><span>ä»£ç ç¤ºä¾‹</span></a></h4><p>æ³¨æ„ï¼šä»¥ä¸‹ä»£ç ä»…ä¸ºæ¦‚å¿µæ¼”ç¤ºï¼Œå¹¶éå¯ç›´æ¥è¿è¡Œçš„å®ä¾‹ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStreamBYOBReader</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node:stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> readWithBYOBReader</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStreamBYOBReader</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // åˆ†é…ä¸€ä¸ª10MBçš„ç¼“å†²åŒº</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ArrayBuffer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">10</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // åˆ›å»ºä¸€ä¸ªè§†å›¾ä»¥ä¾¿äºæ“ä½œæ­¤ç¼“å†²åŒº</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> view</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Uint8Array</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">buffer</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // è¯»å–æ•°æ®åˆ°è‡ªå¸¦çš„ç¼“å†²åŒº</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">view</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æµå·²ç»“æŸ</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">è¯»å–çš„æ•°æ®é•¿åº¦:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">length)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">      // å¤„ç†valueä¸­çš„æ•°æ®...</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> catch</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">è¯»å–å¤±è´¥:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> finally</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">releaseLock</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª 10MB çš„<code>ArrayBuffer</code>ä½œä¸ºç¼“å†²åŒºï¼Œå¹¶é€šè¿‡<code>Uint8Array</code>è§†å›¾ä¸ä¹‹äº¤äº’ã€‚ç„¶åä½¿ç”¨è¿™ä¸ªç¼“å†²åŒºåˆå§‹åŒ–<code>ReadableStreamBYOBReader</code>æ¥è¯»å–æ•°æ®ã€‚</p><p>æ€»ç»“æ¥è¯´ï¼Œ<code>ReadableStreamBYOBReader</code>æä¾›äº†ä¸€ç§é«˜æ•ˆå¤„ç†å¤§é‡æ•°æ®çš„æ–¹æ³•ï¼Œé€šè¿‡å…è®¸å¼€å‘è€…è‡ªå®šä¹‰ç¼“å†²åŒºæ¥å‡å°‘å†…å­˜æ“ä½œï¼Œå¯¹äºéœ€è¦å¤„ç†å¤§å‹æ•°æ®é›†çš„åº”ç”¨éå¸¸æœ‰ç”¨ã€‚</p><h4 id="readablestreambyobreader-cancel-reason" tabindex="-1"><a class="header-anchor" href="#readablestreambyobreader-cancel-reason"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreambyobreadercancelreason" target="_blank" rel="noopener noreferrer">readableStreamBYOBReader.cancel([reason])</a></span></a></h4><p>Node.js v21.7.1 ä¸­çš„ <code>readableStreamBYOBReader.cancel([reason])</code> æ˜¯ä¸æµï¼ˆStreamsï¼‰ç›¸å…³çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå±äº Web Streams API çš„ä¸€éƒ¨åˆ†ã€‚è¿™ä¸ªæ–¹æ³•å…è®¸ä½ å–æ¶ˆè¯»å–æ“ä½œï¼Œå¹¶ä¸”å¯ä»¥æŒ‡å®šå–æ¶ˆçš„åŸå› ã€‚åœ¨æˆ‘ä»¬æ·±å…¥è§£é‡Šä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆç†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µã€‚</p><h3 id="åŸºæœ¬æ¦‚å¿µ-2" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ¦‚å¿µ-2"><span>åŸºæœ¬æ¦‚å¿µ</span></a></h3><ul><li><strong>Streams</strong>: åœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯ä¸€ç³»åˆ—è¿ç»­çš„æ•°æ®å…ƒç´ ï¼Œè¿™äº›æ•°æ®å…ƒç´ å¯ä»¥ä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«å¤„ç†ã€‚æµä½¿å¾—æˆ‘ä»¬å¯ä»¥å¤„ç†å¤§é‡æ•°æ®è€Œä¸å¿…ä¸€æ¬¡æ€§å°†å®ƒä»¬å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</li><li><strong>ReadableStream</strong>: è¿™æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œä¸“é—¨ç”¨äºè¯»å–æ•°æ®ã€‚æ¯”å¦‚ï¼Œä»æ–‡ä»¶è¯»å–æ•°æ®æˆ–è€…ä»ç½‘ç»œæ¥æ”¶æ•°æ®ç­‰ã€‚</li><li><strong>BYOB (Bring Your Own Buffer)</strong> Reader: BYOB è¯»å–å™¨å…è®¸æ›´åŠ çµæ´»åœ°æ§åˆ¶å¦‚ä½•è¯»å–æµä¸­çš„æ•°æ®ã€‚ä½¿ç”¨è¿™ç§è¯»å–å™¨ï¼Œå¼€å‘è€…å¯ä»¥æä¾›è‡ªå·±çš„ç¼“å†²åŒºï¼ˆå³å†…å­˜ç‰‡æ®µï¼‰ï¼Œç›´æ¥å‘å…¶ä¸­è¯»å–æ•°æ®ï¼Œè¿™æœ‰åŠ©äºå‡å°‘å†…å­˜å¤åˆ¶ï¼Œæé«˜æ•ˆç‡ã€‚</li></ul><h3 id="readablestreambyobreader-cancel-reason-1" tabindex="-1"><a class="header-anchor" href="#readablestreambyobreader-cancel-reason-1"><span><code>readableStreamBYOBReader.cancel([reason])</code></span></a></h3><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬é›†ä¸­è®¨è®º <code>readableStreamBYOBReader.cancel([reason])</code> æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•è®©ä½ èƒ½å¤Ÿå–æ¶ˆè¯»å–æµçš„æ“ä½œã€‚å½“ä½ è°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼š</p><ul><li>å¦‚æœä½ æ­£åœ¨è¿›è¡Œè¯»å–æ“ä½œï¼Œè¯¥æ“ä½œä¼šè¢«å–æ¶ˆã€‚</li><li>æµå°†å…³é—­ï¼Œä¸å†å¯è¯»å–ã€‚</li><li>å¯ä»¥é€‰æ‹©æ€§åœ°æä¾›ä¸€ä¸ª <code>reason</code> å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æè¿°äº†å–æ¶ˆæ“ä½œçš„åŸå› ã€‚</li></ul><h4 id="å®é™…è¿ç”¨ä¾‹å­-3" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-3"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åº”ç”¨ç¨‹åºï¼Œè¯¥ç¨‹åºéœ€è¦ä»ç½‘ç»œä¸‹è½½æŸä¸ªè¾ƒå¤§æ–‡ä»¶ï¼Œä½†åŸºäºç”¨æˆ·çš„æŸäº›äº¤äº’ï¼ˆæ¯”å¦‚ç”¨æˆ·æŒ‰ä¸‹äº†â€œå–æ¶ˆâ€æŒ‰é’®ï¼‰ï¼Œä½ å¯èƒ½éœ€è¦åœæ­¢ä¸‹è½½æ“ä½œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœä½ ä½¿ç”¨ BYOB è¯»å–å™¨æ¥å¤„ç†æ•°æ®æµï¼Œä½ å¯ä»¥è°ƒç”¨ <code>cancel()</code> æ–¹æ³•æ¥åœæ­¢è¿›ä¸€æ­¥çš„æ•°æ®è¯»å–å¹¶å…³é—­æµã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸€ä¸ª readableStream å¹¶ä¸”è·å–äº†ä¸€ä¸ª associated BYOB reader</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> someReadableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> mode</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">byob</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ç”¨æˆ·è¯·æ±‚å–æ¶ˆä¸‹è½½</span></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> onCancelRequested</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // ä½¿ç”¨ä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²æ¥æŒ‡ç¤ºå–æ¶ˆçš„åŸå› </span></span>
<span class="line"><span style="color:#D8DEE9;">  reader</span></span>
<span class="line"><span style="color:#ECEFF4;">    .</span><span style="color:#88C0D0;">cancel</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">User cancelled the download operation</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">    .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">The read operation has been successfully cancelled</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">    .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">There was an error cancelling the read operation</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ç„¶ååœ¨é€‚å½“çš„æ—¶æœºè°ƒç”¨ onCancelRequested å‡½æ•°</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡è°ƒç”¨å«æœ‰ <code>{ mode: &quot;byob&quot; }</code> å‚æ•°çš„ <code>.getReader()</code> æ–¹æ³•è·å–äº†ä¸€ä¸ª BYOB è¯»å–å™¨ã€‚å½“éœ€è¦å–æ¶ˆæ“ä½œæ—¶ï¼Œæˆ‘ä»¬è°ƒç”¨ <code>reader.cancel(&quot;reason&quot;)</code> æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå–æ¶ˆåŸå› ã€‚è¿™ä¸ªæ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡ <code>.then()</code> å’Œ <code>.catch()</code> æ¥å¤„ç†æˆåŠŸå’Œå¤±è´¥çš„æƒ…å†µã€‚</p><h3 id="æ€»ç»“-4" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-4"><span>æ€»ç»“</span></a></h3><p>æ€»çš„æ¥è¯´ï¼Œ<code>readableStreamBYOBReader.cancel([reason])</code> æä¾›äº†ä¸€ç§ä¼˜é›…çš„æ–¹å¼æ¥å–æ¶ˆæµçš„è¯»å–æ“ä½œï¼Œå¹¶å…è®¸ä¼ é€’ä¸€ä¸ªåŸå› ã€‚åœ¨å¤„ç†å¤§å‹æ•°æ®æˆ–å“åº”ç”¨æˆ·äº¤äº’æ—¶ï¼Œè¿™ä¸ªåŠŸèƒ½éå¸¸æœ‰ç”¨ã€‚</p><h4 id="readablestreambyobreader-closed" tabindex="-1"><a class="header-anchor" href="#readablestreambyobreader-closed"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreambyobreaderclosed" target="_blank" rel="noopener noreferrer">readableStreamBYOBReader.closed</a></span></a></h4><p>Node.js ä¸­çš„<code>readableStreamBYOBReader.closed</code>æ˜¯ä¸€ä¸ªä¸ Web Streams API ç›¸å…³çš„å±æ€§ã€‚ç†è§£è¿™ä¸ªæ¦‚å¿µä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç®€å•äº†è§£ä¸€ä¸‹å‡ ä¸ªå…³é”®ç‚¹ï¼šStreamsã€Buffer å’Œ BYOBReaderã€‚è¿™ä¼šå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£<code>readableStreamBYOBReader.closed</code>çš„ç”¨é€”å’Œå·¥ä½œåŸç†ã€‚</p><h3 id="streams-æµ" tabindex="-1"><a class="header-anchor" href="#streams-æµ"><span>Streamsï¼ˆæµï¼‰</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œæµæ˜¯ä¸€ç§æŠ½è±¡çš„æ•°æ®ç»“æ„ï¼Œç”¨äºå¤„ç†æ•°æ®çš„è¿ç»­ä¼ è¾“ã€‚æƒ³è±¡ä¸€ä¸‹æ°´æµä»æ°´é¾™å¤´æµå‡ºæ¥ï¼Œä¸æ–­åœ°æµï¼Œç›´åˆ°ä½ å…³é—­å®ƒã€‚åœ¨ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¤„ç†çš„æ•°æ®ä¹Ÿå¯ä»¥åƒæ°´æµä¸€æ ·ï¼Œä»ä¸€ä¸ªæºå¤´ä¸æ–­åœ°æµå‘ç›®æ ‡åœ°ç‚¹ã€‚æµæ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§é‡æ•°æ®å’Œå®æ—¶æ•°æ®çš„æ—¶å€™ï¼Œå› ä¸ºå®ƒä»¬å…è®¸æ•°æ®åˆ†å—å¤„ç†ï¼Œè€Œä¸æ˜¯ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å¯ç”¨åå†ä¸€æ¬¡æ€§å¤„ç†ã€‚</p><h3 id="buffer" tabindex="-1"><a class="header-anchor" href="#buffer"><span>Buffer</span></a></h3><p>åœ¨ Node.js ä¸­ï¼ŒBuffer æ˜¯ä¸€ç§ç”¨äºå¤„ç†äºŒè¿›åˆ¶æ•°æ®çš„æœºåˆ¶ã€‚å½“ä½ ä¸æ–‡ä»¶ç³»ç»Ÿå·¥ä½œæˆ–ä»ç½‘ç»œæ¥æ”¶æ•°æ®æ—¶ï¼Œä½¿ç”¨ Buffer å¯ä»¥æœ‰æ•ˆåœ°å¤„ç†æ•°æ®ã€‚Buffer å¯ä»¥è¢«çœ‹ä½œæ˜¯ä¸´æ—¶å­˜å‚¨åŒºï¼Œç”¨äºå­˜æ”¾æµæ•°æ®çš„ç‰‡æ®µï¼Œç›´åˆ°è¶³å¤Ÿçš„æ•°æ®è¢«æ”¶é›†å¹¶å¯ä»¥è¢«ç¨‹åºå¤„ç†ã€‚</p><h3 id="byobreader-bring-your-own-buffer-reader" tabindex="-1"><a class="header-anchor" href="#byobreader-bring-your-own-buffer-reader"><span>BYOBReader - Bring Your Own Buffer Reader</span></a></h3><p>BYOBReader æ˜¯â€œBring Your Own Buffer Readerâ€çš„ç¼©å†™ï¼Œè¿™æ˜¯ä¸€ä¸ªé«˜çº§åŠŸèƒ½ï¼Œå…è®¸å¼€å‘è€…æä¾›è‡ªå·±çš„ Bufferï¼ˆç¼“å†²åŒºï¼‰ç»™æµæ¥å¡«å……æ•°æ®ã€‚è¿™æœ‰å‡ ä¸ªå¥½å¤„ï¼Œæ¯”å¦‚å¯ä»¥æ›´å¥½åœ°æ§åˆ¶å†…å­˜ä½¿ç”¨ï¼Œé€šè¿‡é‡ç”¨ Buffer æ¥å‡å°‘å†…å­˜åˆ†é…å’Œåƒåœ¾å›æ”¶ã€‚</p><h3 id="readablestreambyobreader-closed-1" tabindex="-1"><a class="header-anchor" href="#readablestreambyobreader-closed-1"><span>readableStreamBYOBReader.closed</span></a></h3><p>ç°åœ¨æˆ‘ä»¬æ¥è°ˆè°ˆ<code>readableStreamBYOBReader.closed</code>ã€‚è¿™ä¸ªå±æ€§æ˜¯ä¸€ä¸ª Promiseï¼Œå½“ BYOBReader å…³è”çš„æµæ­£å¸¸å…³é—­æ—¶ï¼Œè¿™ä¸ª Promise ä¼šè¢«è§£å†³(resolve)ï¼›å¦‚æœæµç”±äºé”™è¯¯è€Œå…³é—­ï¼Œè¿™ä¸ª Promise å°†ä¼šè¢«æ‹’ç»(reject)ã€‚å› æ­¤ï¼Œå®ƒæä¾›äº†ä¸€ç§æœºåˆ¶æ¥å¼‚æ­¥åœ°é€šçŸ¥ä½ æµçš„ç»“æŸçŠ¶æ€ã€‚</p><h4 id="å®é™…åº”ç”¨ä¾‹å­-1" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ä¾‹å­-1"><span>å®é™…åº”ç”¨ä¾‹å­</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªç½‘ç»œåº”ç”¨ï¼Œéœ€è¦ä»æœåŠ¡å™¨ä¸‹è½½å¤§é‡æ•°æ®ã€‚ä¸ºäº†é«˜æ•ˆå¤„ç†è¿™äº›æ•°æ®ï¼Œä½ å†³å®šä½¿ç”¨æµï¼Œå¹¶é‡‡ç”¨ BYOBReader æ¥æ›´å¥½åœ°æ§åˆ¶å†…å­˜ä½¿ç”¨ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStreamBYOBReader</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾`fetchSomeData`æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºè·å–æ•°æ®æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> fetchSomeData</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStreamBYOBReader</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">async</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // åˆ†é…ä¸€ä¸ªBuffer</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ArrayBuffer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">1024</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // ç¤ºä¾‹å¤§å°ä¸º1024å­—èŠ‚</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">      // ä½¿ç”¨æ‚¨è‡ªå·±çš„bufferæ¥è¯»å–æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">      const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> Uint8Array</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">buffer</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">      if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">break;</span><span style="color:#616E88;"> // å¦‚æœæµç»“æŸï¼Œé€€å‡ºå¾ªç¯</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">      // å¤„ç†valueä¸­çš„æ•°æ®...</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">closed</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æµæˆåŠŸå…³é—­ï¼Œæ²¡æœ‰é”™è¯¯ã€‚</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> catch</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">error</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æµå¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¾‹å­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ BYOBReader æ¥ä»æµä¸­è¯»å–æ•°æ®åˆ°ä½ æä¾›çš„ Buffer ä¸­ã€‚é€šè¿‡æ£€æŸ¥<code>reader.closed</code>ï¼Œä½ å¯ä»¥ç¡®å®šæµæ˜¯å¦æˆåŠŸå…³é—­æˆ–æ˜¯å¦é‡åˆ°äº†é”™è¯¯ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼Œ<code>readableStreamBYOBReader.closed</code>æ˜¯ä¸€ä¸ªéå¸¸å®ç”¨çš„å±æ€§ï¼Œå®ƒä¸ºå¤„ç†æµæä¾›äº†é¢å¤–çš„çµæ´»æ€§å’Œå¯¹é”™è¯¯å¤„ç†çš„æ”¯æŒã€‚</p><h4 id="readablestreambyobreader-read-view-options" tabindex="-1"><a class="header-anchor" href="#readablestreambyobreader-read-view-options"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreambyobreaderreadview-options" target="_blank" rel="noopener noreferrer">readableStreamBYOBReader.read(view[, options])</a></span></a></h4><p>Node.js ä¸­çš„<code>readableStreamBYOBReader.read(view[, options])</code>æ–¹æ³•æ˜¯ä¸ Web Streams API ç›¸å…³çš„ä¸€ä¸ªé«˜çº§åŠŸèƒ½ï¼Œç”¨äºä»æµä¸­è¯»å–æ•°æ®ã€‚è¿™ä¸ªæ–¹æ³•çš„ç‰¹ç‚¹åœ¨äºå®ƒå…è®¸ä½ æ›´ç²¾ç¡®åœ°æ§åˆ¶å¦‚ä½•ä»¥åŠå­˜æ”¾åˆ°å“ªé‡Œè¯»å–æ•°æ®ã€‚åœ¨æ·±å…¥è§£é‡Šä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£å‡ ä¸ªå…³é”®æ¦‚å¿µã€‚</p><h3 id="å…³é”®æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#å…³é”®æ¦‚å¿µ"><span>å…³é”®æ¦‚å¿µ</span></a></h3><ul><li><strong>Streamsï¼ˆæµï¼‰</strong>: åœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯ä¸€ç³»åˆ—è¿ç»­çš„æ•°æ®ã€‚æƒ³è±¡æˆæ°´æµï¼Œæ•°æ®å°±åƒæ˜¯æ²³æµä¸­çš„æ°´ä¸€æ ·ï¼Œä»æºå¤´ä¸æ–­æµå‘ç›®çš„åœ°ã€‚</li><li><strong>ReadableStream</strong>: è¿™æ˜¯ä¸€ç§å¯ä»¥ä»ä¸­è¯»å–æ•°æ®çš„æµã€‚æ¯”å¦‚ï¼Œæ–‡ä»¶è¯»å–ã€ç½‘ç»œè¯·æ±‚çš„å“åº”ç­‰éƒ½å¯ä»¥è¢«è§†ä¸º<code>ReadableStream</code>ã€‚</li><li><strong>BYOB (Bring Your Own Buffer)</strong>: è¿™æ˜¯ä¸€ç§èŠ‚çœå†…å­˜çš„æŠ€æœ¯ï¼Œç®€è€Œè¨€ä¹‹ï¼Œå…è®¸ä½ æä¾›è‡ªå·±çš„ Bufferï¼ˆç¼“å†²åŒºï¼‰æ¥å­˜å‚¨ä»æµä¸­è¯»å–çš„æ•°æ®ï¼Œè€Œä¸æ˜¯ç”±ç³»ç»Ÿè‡ªåŠ¨åˆ†é…ã€‚</li></ul><h3 id="readablestreambyobreader-read-view-options-è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#readablestreambyobreader-read-view-options-è¯¦è§£"><span><code>readableStreamBYOBReader.read(view[, options])</code>è¯¦è§£</span></a></h3><p><code>readableStreamBYOBReader.read(view[, options])</code>æ–¹æ³•æ˜¯è®¾è®¡æ¥é…åˆ BYOB ä½¿ç”¨çš„ï¼Œå®ƒå…è®¸ä½ ä»<code>ReadableStream</code>ä¸­è¯»å–æ•°æ®ï¼Œå°†æ•°æ®ç›´æ¥å­˜å…¥ä½ æä¾›çš„ Buffer ä¸­ã€‚</p><p>å‚æ•°è§£é‡Šï¼š</p><ul><li><strong>view</strong>: è¿™æ˜¯ä½ æä¾›çš„ Buffer è§†å›¾ï¼Œä¾‹å¦‚<code>Uint8Array</code>æˆ–å…¶ä»–ç±»å‹çš„<code>TypedArray</code>ã€‚è¿™ç›¸å½“äºå‘Šè¯‰æ–¹æ³•ï¼šè¯·æŠŠæ•°æ®æ”¾åœ¨è¿™ä¸ªå®¹å™¨é‡Œã€‚</li><li><strong>options</strong>: ä¸€ä¸ªå¯é€‰çš„å¯¹è±¡ï¼Œç”¨äºæä¾›é¢å¤–çš„è®¾ç½®ã€‚ä¸è¿‡ï¼Œåœ¨ Node.js v21.7.1 çš„æ–‡æ¡£ä¸­ï¼Œå¹¶æ²¡æœ‰è¯¦ç»†è¯´æ˜è¿™ä¸ªå‚æ•°çš„å…·ä½“ä½œç”¨ï¼Œé€šå¸¸è¿™æ„å‘³ç€è¯¥å‚æ•°å¯èƒ½ä¿ç•™ç»™æœªæ¥çš„æ‰©å±•ä½¿ç”¨æˆ–è€…æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹çš„å®šåˆ¶éœ€æ±‚ã€‚</li></ul><h3 id="å®é™…è¿ç”¨ä¾‹å­-4" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-4"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><h4 id="ä¾‹å­-1-ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®"><span>ä¾‹å­ 1ï¼šä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®</span></a></h4><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œä½ æƒ³è¦é«˜æ•ˆåœ°è¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®ï¼ŒåŒæ—¶å°½é‡å‡å°‘å†…å­˜çš„ä½¿ç”¨ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStreamBYOBReader</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯è¯»æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./large-file.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è·å–ReadableStreamæ¥å£</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStreamBYOBReader</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">async</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // åˆ›å»ºä¸€ä¸ªBufferæ¥å­˜å‚¨æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Uint8Array</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">1024</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡å®šæˆ‘ä»¬æ¯æ¬¡æƒ³è¯»å–1024å­—èŠ‚</span></span>
<span class="line"><span style="color:#81A1C1;">  let</span><span style="color:#D8DEE9;"> bytesRead</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  do</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // ä½¿ç”¨BYOBæ¨¡å¼è¯»å–æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    (</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> value</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9;"> bytesRead</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">buffer</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Read chunk of size:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> bytesRead</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">byteLength</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">      // å¤„ç†bufferä¸­çš„æ•°æ®...</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Finished reading the file.</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ‰‹åŠ¨ç®¡ç†äº†ç”¨äºå­˜å‚¨æ•°æ®çš„ Bufferï¼Œå¹¶ä¸”èƒ½å¤Ÿé«˜æ•ˆåœ°æ§åˆ¶å†…å­˜ä½¿ç”¨ï¼Œåªåˆ›å»ºäº†å¿…è¦çš„ Buffer å¯¹è±¡ã€‚è¿™å¯¹äºå¤„ç†å¤§é‡æ•°æ®éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå‡å°‘äº†åƒåœ¾æ”¶é›†çš„å‹åŠ›å¹¶æé«˜äº†åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚</p><p>æ€»ç»“æ¥è¯´ï¼Œ<code>readableStreamBYOBReader.read(view[, options])</code>æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ APIï¼Œç‰¹åˆ«é€‚ç”¨äºéœ€è¦ç²¾ç»†æ§åˆ¶å†…å­˜ä½¿ç”¨å’Œæ•°æ®è¯»å–è¿‡ç¨‹çš„åœºæ™¯ã€‚é€šè¿‡æä¾›è‡ªå·±çš„ Bufferï¼Œå¼€å‘è€…å¯ä»¥è¾¾åˆ°æ›´é«˜çš„æ•°æ®å¤„ç†æ•ˆç‡å’Œæ€§èƒ½ã€‚</p><h4 id="readablestreambyobreader-releaselock" tabindex="-1"><a class="header-anchor" href="#readablestreambyobreader-releaselock"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreambyobreaderreleaselock" target="_blank" rel="noopener noreferrer">readableStreamBYOBReader.releaseLock()</a></span></a></h4><p>äº†è§£ <code>readableStreamBYOBReader.releaseLock()</code> å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•äº†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µã€‚</p><ol><li><p><strong>Streamsï¼ˆæµï¼‰</strong>ï¼šåœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯ä¸€ç³»åˆ—æ•°æ®çš„ä¼ è¾“æ–¹å¼ã€‚æƒ³è±¡å®ƒå°±åƒæ˜¯ä¸€æ¡æ²³æµï¼Œæ•°æ®å°±åƒæ˜¯æ²³æµä¸­çš„æ°´ï¼Œå¯ä»¥ä»æºå¤´æµå‘ç›®æ ‡åœ°ç‚¹ã€‚è¿™ç§æ–¹å¼éå¸¸é«˜æ•ˆï¼Œå› ä¸ºå®ƒå…è®¸æ•°æ®è¾¹ç”Ÿæˆè¾¹å¤„ç†ï¼Œè€Œä¸éœ€è¦ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å‡†å¤‡å¥½ã€‚</p></li><li><p><strong>Readable Streamsï¼ˆå¯è¯»æµï¼‰</strong>ï¼šç‰¹åˆ«æŒ‡é‚£äº›ç”¨æ¥è¯»å–æ•°æ®çš„æµã€‚æ¯”å¦‚è¯´ï¼Œä»æ–‡ä»¶è¯»å–æ•°æ®æˆ–è€…ç½‘ç»œè¯·æ±‚è¿‡ç¨‹ä¸­æ¥æ”¶æ•°æ®ã€‚</p></li><li><p><strong>BYOBï¼ˆBring Your Own Bufferï¼‰</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªé«˜çº§ä¼˜åŒ–æ‰‹æ®µï¼Œå…è®¸å¼€å‘è€…æä¾›è‡ªå·±çš„ç¼“å†²åŒºï¼ˆBufferï¼‰æ¥å­˜å‚¨æ¥æ”¶åˆ°çš„æ•°æ®ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥å‡å°‘å†…å­˜ä½¿ç”¨å’Œæå‡æ€§èƒ½ï¼Œå› ä¸ºå‡å°‘äº†ä¸å¿…è¦çš„å†…å­˜åˆ†é…å’Œå¤åˆ¶æ“ä½œã€‚</p></li><li><p><strong>ReadableStreamBYOBReader</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºå¤„ç† BYOB è¯»å–åœºæ™¯è®¾è®¡çš„æ¥å£ã€‚é€šè¿‡è¿™ä¸ªæ¥å£ï¼Œå¼€å‘è€…å¯ä»¥æ›´ç»†è‡´åœ°æ§åˆ¶æ•°æ®çš„è¯»å–è¿‡ç¨‹ï¼Œæ¯”å¦‚è¯´ï¼Œå¯ä»¥ç²¾ç¡®åœ°æ§åˆ¶è¯»å–æ•°æ®çš„æ•°é‡å’Œå­˜å‚¨ä½ç½®ã€‚</p></li></ol><p>ç°åœ¨ï¼Œè®²åˆ° <code>readableStreamBYOBReader.releaseLock()</code> æ–¹æ³•ï¼š</p><ul><li>å½“ä½ ä½¿ç”¨ <code>ReadableStreamBYOBReader</code> æ¥ä»æµä¸­è¯»å–æ•°æ®æ—¶ï¼Œå®é™…ä¸Šæ˜¯å¯¹æµåŠ äº†ä¸€ä¸ªâ€œé”â€ã€‚åœ¨è¿™ä¸ªé”å®šçŠ¶æ€ä¸‹ï¼Œå…¶ä»–è¯»å–å™¨ä¸èƒ½è¯»å–è¿™ä¸ªæµä¸­çš„æ•°æ®ã€‚</li><li><code>releaseLock()</code> æ–¹æ³•çš„ä½œç”¨å°±æ˜¯é‡Šæ”¾è¿™ä¸ªé”ã€‚å½“ä½ å®Œæˆæ•°æ®è¯»å–å·¥ä½œåï¼Œåº”å½“è°ƒç”¨æ­¤æ–¹æ³•ï¼Œè¿™æ ·å…¶ä»–è¯»å–å™¨å°±å¯ä»¥å¼€å§‹ä»è¿™ä¸ªæµä¸­è¯»å–æ•°æ®äº†ã€‚</li></ul><h3 id="å®é™…åº”ç”¨ç¤ºä¾‹-2" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ç¤ºä¾‹-2"><span>å®é™…åº”ç”¨ç¤ºä¾‹</span></a></h3><p>å‡è®¾æœ‰ä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œæˆ‘ä»¬å¸Œæœ›ä»¥æœ€ä¼˜åŒ–çš„æ–¹å¼è¯»å–å®ƒçš„æ•°æ®ï¼ŒåŒæ—¶éœ€è¦ç¡®ä¿ç³»ç»Ÿèµ„æºè¢«åˆç†åˆ©ç”¨ã€‚</p><ol><li><p><strong>åˆ›å»ºä¸€ä¸ªæµæ¥è¯»å–æ–‡ä»¶</strong>ï¼šé¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæµç”¨äºè¯»å–è¿™ä¸ªå¤§æ–‡ä»¶ã€‚</p></li><li><p><strong>ä½¿ç”¨ BYOB Reader è¯»å–æ•°æ®</strong>ï¼šä¸ºäº†æ›´å¥½åœ°æ§åˆ¶å†…å­˜ä½¿ç”¨ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ BYOB è¯»å–æ–¹å¼ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª <code>ReadableStreamBYOBReader</code> å¯¹è±¡æ¥è¯»å–æ•°æ®ã€‚</p></li><li><p><strong>è¯»å–æ•°æ®</strong>ï¼šæ ¹æ®éœ€è¦è¯»å–æ•°æ®ï¼Œå¯èƒ½ä¼šæ¶‰åŠåˆ°é‡å¤çš„è¯»å–æ“ä½œï¼Œæ¯æ¬¡è¯»å–æŒ‡å®šæ•°é‡çš„æ•°æ®åˆ°æˆ‘ä»¬æä¾›çš„ Buffer ä¸­ã€‚</p></li><li><p><strong>å®Œæˆæ“ä½œé‡Šæ”¾é”</strong>ï¼šå®Œæˆæ‰€æœ‰è¯»å–æ“ä½œåï¼Œé€šè¿‡è°ƒç”¨ <code>releaseLock()</code> æ–¹æ³•æ¥é‡Šæ”¾è¯»å–å™¨å¯¹æµçš„é”å®šï¼Œä½¿å¾—æµå¯ä»¥è¢«å…¶ä»–è¯»å–å™¨ä½¿ç”¨ã€‚</p></li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ª readableStream æ¥ä»£è¡¨è¦è¯»å–çš„æ–‡ä»¶æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> mode</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">byob</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">async</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // åˆ›å»ºä¸€ä¸ªç”¨äºå­˜å‚¨æ•°æ®çš„ Buffer</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ArrayBuffer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">1024</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡è®¾æˆ‘ä»¬æ¯æ¬¡æƒ³è¯»å– 1024 å­—èŠ‚</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> view</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Uint8Array</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">buffer</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">      // ä½¿ç”¨ BYOB reader è¯»å–æ•°æ®åˆ°æˆ‘ä»¬çš„ buffer ä¸­</span></span>
<span class="line"><span style="color:#81A1C1;">      const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">view</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">      if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">        console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æ•°æ®è¯»å–å®Œæ¯•</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        break;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#616E88;">      // å¤„ç†è·å–åˆ°çš„æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">è¯»å–äº† </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">value</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">byteLength</span><span style="color:#81A1C1;">}</span><span style="color:#A3BE8C;"> å­—èŠ‚çš„æ•°æ®</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> finally</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // ä¸è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œæœ€ç»ˆéƒ½é‡Šæ”¾é”</span></span>
<span class="line"><span style="color:#D8DEE9;">    reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">releaseLock</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>ReadableStreamBYOBReader</code> å’Œ <code>releaseLock()</code> æ–¹æ³•æ¥é«˜æ•ˆã€å®‰å…¨åœ°è¯»å–æ•°æ®ã€‚è®°ä½ï¼Œåœ¨ä½¿ç”¨ BYOB æ–¹å¼è¯»å–æ•°æ®æ—¶ï¼Œæ­£ç¡®ç®¡ç†â€œé”â€çš„çŠ¶æ€æ˜¯è‡³å…³é‡è¦çš„ï¼Œä»¥ç¡®ä¿èµ„æºçš„åˆç†åˆ©ç”¨å’Œé¿å…æ½œåœ¨çš„ç«äº‰æ¡ä»¶ã€‚</p><h3 id="class-readablestreamdefaultcontroller" tabindex="-1"><a class="header-anchor" href="#class-readablestreamdefaultcontroller"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-readablestreamdefaultcontroller" target="_blank" rel="noopener noreferrer">Class: ReadableStreamDefaultController</a></span></a></h3><p>åœ¨è§£é‡Š<code>ReadableStreamDefaultController</code>ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹æµï¼ˆStreamsï¼‰çš„æ¦‚å¿µã€‚åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œæµæ˜¯ä¸€ç³»åˆ—çš„æ•°æ®å…ƒç´ ï¼Œå¯ä»¥æŒ‰é¡ºåºå¤„ç†ã€‚è¿™æ„å‘³ç€ä½ ä¸éœ€è¦ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å¯ç”¨æ‰å¼€å§‹å¤„ç†å®ƒä»¬ï¼Œè¿™å¯¹äºå¤§æ–‡ä»¶æˆ–å®æ—¶æ•°æ®ä¼ è¾“ç‰¹åˆ«æœ‰ç”¨ã€‚</p><p>Node.js ä¸­çš„<code>ReadableStreamDefaultController</code>æ˜¯ä¸ Web Streams API ç›¸å…³çš„ä¸€ä¸ªç±»ï¼Œä¸“é—¨ç”¨äºæ§åˆ¶å¯è¯»æµï¼ˆReadable Streamsï¼‰çš„çŠ¶æ€å’Œè¡Œä¸ºã€‚å®ƒå…è®¸å¼€å‘è€…ç²¾ç»†åœ°æ§åˆ¶æ•°æ®çš„æµåŠ¨ï¼Œä¾‹å¦‚ä½•æ—¶å¼€å§‹æ¨é€æ•°æ®ã€ä½•æ—¶åœæ­¢ã€ä»¥åŠå¦‚ä½•åº”å¯¹å‹åŠ›ï¼ˆbackpressureï¼Œå³æ¥æ”¶æ–¹å¤„ç†æ•°æ®çš„é€Ÿåº¦èµ¶ä¸ä¸Šå‘é€æ–¹å‘é€æ•°æ®çš„é€Ÿåº¦çš„æƒ…å†µï¼‰ç­‰ã€‚</p><h3 id="æ ¸å¿ƒåŠŸèƒ½" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒåŠŸèƒ½"><span>æ ¸å¿ƒåŠŸèƒ½</span></a></h3><p><code>ReadableStreamDefaultController</code>æä¾›ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š</p><ul><li><strong>æ§åˆ¶æ•°æ®çš„æ¨é€ï¼ˆenqueueï¼‰</strong>ï¼šé€šè¿‡<code>controller.enqueue(chunk)</code>æ–¹æ³•ï¼Œå¯ä»¥å‘æµä¸­æ·»åŠ æ•°æ®å—ã€‚è¿™ä½¿å¾—æ•°æ®çš„ç”Ÿäº§è€…å¯ä»¥é€æ­¥å°†æ•°æ®å‘é€åˆ°æµä¸­ã€‚</li><li><strong>ç»“æŸæµï¼ˆclose the streamï¼‰</strong>ï¼šä½¿ç”¨<code>controller.close()</code>æ–¹æ³•å¯ä»¥å…³é—­æµã€‚è¿™è¡¨ç¤ºå·²ç»æ²¡æœ‰æ›´å¤šçš„æ•°æ®ä¼šè¢«åŠ å…¥åˆ°æµä¸­ã€‚</li><li><strong>å¤„ç†èƒŒå‹ï¼ˆdeal with backpressureï¼‰</strong>ï¼šå¦‚æœæµä¸­çš„æ¶ˆè´¹è€…ï¼ˆæ¥æ”¶æ•°æ®çš„ä¸€æ–¹ï¼‰ä¸èƒ½è¿…é€Ÿå¤„ç†ä¼ å…¥çš„æ•°æ®ï¼Œ<code>ReadableStreamDefaultController</code>å¯ä»¥é€šè¿‡å…¶å†…éƒ¨æœºåˆ¶æ¥æš‚åœæ•°æ®çš„æ¨é€ï¼Œç›´åˆ°æ¶ˆè´¹è€…å‡†å¤‡å¥½æ¥æ”¶æ›´å¤šæ•°æ®ã€‚</li></ul><h3 id="å®é™…è¿ç”¨ä¾‹å­-5" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-5"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><h4 id="ä¾‹å­-1-ä»æ–‡ä»¶è¯»å–æ•°æ®" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-ä»æ–‡ä»¶è¯»å–æ•°æ®"><span>ä¾‹å­ 1ï¼šä»æ–‡ä»¶è¯»å–æ•°æ®</span></a></h4><p>å‡è®¾æ‚¨æ­£åœ¨æ„å»ºä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦ä»ä¸€ä¸ªå¤§æ–‡ä»¶ä¸­é€è¡Œè¯»å–æ•°æ®è¿›è¡Œå¤„ç†ã€‚æ‚¨å¯ä»¥ä½¿ç”¨<code>ReadableStream</code>å’Œ<code>ReadableStreamDefaultController</code>æ¥å®ç°è¿™ä¸ªè¿‡ç¨‹ï¼Œå…¶ä¸­åˆ©ç”¨<code>controller.enqueue()</code>é€ä¸ªå°†æ–‡ä»¶çš„è¡Œæ¨é€è‡³æµä¸­ï¼Œç„¶åé€è¡Œè¿›è¡Œå¤„ç†ï¼Œè€Œä¸å¿…ä¸€æ¬¡æ€§å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½è¿›å†…å­˜ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./largeFile.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span><span style="color:#88C0D0;"> encoding</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">utf8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">      // æš‚åœæˆ–å‡æ…¢æ•°æ®çš„è¯»å–å¦‚æœéœ€è¦</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">end</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨readableStreamè¿›è¡Œè¿›ä¸€æ­¥æ“ä½œï¼Œä¾‹å¦‚é€è¡Œå¤„ç†æ•°æ®</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¾‹å­-2-å®æ—¶æ•°æ®ä¼ è¾“" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-å®æ—¶æ•°æ®ä¼ è¾“"><span>ä¾‹å­ 2ï¼šå®æ—¶æ•°æ®ä¼ è¾“</span></a></h4><p>è®¾æƒ³æ‚¨æ­£åœ¨å¼€å‘ä¸€ä¸ªå®æ—¶è‚¡ç¥¨æŠ¥ä»·åº”ç”¨ï¼ŒæœåŠ¡å™¨éœ€è¦ä¸æ–­åœ°å°†æœ€æ–°çš„è‚¡ç¥¨ä»·æ ¼æ¨é€ç»™å®¢æˆ·ç«¯ã€‚æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªå¯è¯»æµï¼Œå¹¶åˆ©ç”¨<code>ReadableStreamDefaultController</code>å°†æœ€æ–°çš„è‚¡ç¥¨ä»·æ ¼ä½œä¸ºæ•°æ®å—æ¨é€åˆ°æµä¸­ï¼Œå®¢æˆ·ç«¯åˆ™å®æ—¶æ¥æ”¶å¹¶æ˜¾ç¤ºè¿™äº›ä»·æ ¼ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> stockPriceStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å‡è®¾getLatestStockPriceæ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œç”¨äºè·å–æœ€æ–°çš„è‚¡ç¥¨ä»·æ ¼</span></span>
<span class="line"><span style="color:#88C0D0;">    setInterval</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">async</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">      const</span><span style="color:#D8DEE9;"> latestPrice</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#88C0D0;"> getLatestStockPrice</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">      controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">latestPrice</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span><span style="color:#B48EAD;"> 1000</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // æ¯ç§’æ›´æ–°ä¸€æ¬¡</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨stockPriceStreamåœ¨å®¢æˆ·ç«¯æ˜¾ç¤ºå®æ—¶è‚¡ç¥¨ä»·æ ¼</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ€»ç»“èµ·æ¥ï¼Œ<code>ReadableStreamDefaultController</code>æä¾›äº†ä¸€ç§çµæ´»ä¸”å¼ºå¤§çš„æ–¹å¼æ¥æ§åˆ¶æ•°æ®çš„æµåŠ¨ï¼Œæ— è®ºæ˜¯ä»æ–‡ä»¶ä¸­é€æ­¥è¯»å–æ•°æ®ï¼Œè¿˜æ˜¯å®ç°å®æ—¶æ•°æ®æ¨é€ï¼Œå®ƒéƒ½èƒ½æä¾›æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚</p><h4 id="readablestreamdefaultcontroller-close" tabindex="-1"><a class="header-anchor" href="#readablestreamdefaultcontroller-close"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreamdefaultcontrollerclose" target="_blank" rel="noopener noreferrer">readableStreamDefaultController.close()</a></span></a></h4><p>å½“æˆ‘ä»¬è°ˆè®º Node.js ä¸­çš„ <code>readableStreamDefaultController.close()</code> æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å®é™…ä¸Šåœ¨è®¨è®ºçš„æ˜¯ä¸æµï¼ˆStreamsï¼‰ç›¸å…³çš„ä¸€ä¸ªæ“ä½œã€‚åœ¨ Node.js ä¸­ï¼Œæµæ˜¯ä¸€ç§ç”¨äºå¤„ç†æ•°æ®ï¼ˆå¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œé€šä¿¡ç­‰ï¼‰çš„æ–¹å¼ï¼Œå®ƒå…è®¸ä½ ä»¥æ›´é«˜æ•ˆçš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œå› ä¸ºä½ å¯ä»¥åœ¨å…¨éƒ¨æ•°æ®å¯ç”¨ä¹‹å‰å°±å¼€å§‹å¤„ç†æ•°æ®ï¼Œè¿™å¯¹äºå¤„ç†å¤§é‡æ•°æ®ç‰¹åˆ«æœ‰ç”¨ã€‚</p><h3 id="readablestreamdefaultcontroller-close-1" tabindex="-1"><a class="header-anchor" href="#readablestreamdefaultcontroller-close-1"><span>readableStreamDefaultController.close()</span></a></h3><p>è¿™ä¸ªæ–¹æ³•å±äº Web Streams API çš„ä¸€éƒ¨åˆ†ï¼Œè¯¥ API è¢«è®¾è®¡æ¥æä¾›ä¸€ç§ç®€å•ä¸”ç»Ÿä¸€çš„æ–¹å¼æ¥å¤„ç†æ•°æ®æµã€‚<code>readableStreamDefaultController.close()</code> æ˜¯ä¸€ä¸ªéå¸¸å…·ä½“çš„æ–¹æ³•ï¼Œå®ƒç”¨äºå…³é—­ä¸€ä¸ªå¯è¯»æµçš„æ§åˆ¶å™¨ã€‚å½“è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šæ ‡è®°æµçš„æœ«å°¾ï¼Œæ„å‘³ç€æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯ä»¥è¢«æ¶ˆè´¹äº†ã€‚æ¢å¥è¯è¯´ï¼Œæµå·²ç»å®Œæˆäº†å®ƒçš„ä½¿å‘½ï¼Œä¸ä¼šå†æœ‰æ–°çš„æ•°æ®åˆ°æ¥ã€‚</p><h4 id="ä½¿ç”¨åœºæ™¯-1" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯-1"><span>ä½¿ç”¨åœºæ™¯</span></a></h4><p>æƒ³è±¡ä½ æ­£åœ¨ä»ä¸€ä¸ªæ–‡ä»¶ä¸­è¯»å–æ•°æ®æˆ–è€…ç›‘å¬æ¥è‡ªç½‘ç»œè¯·æ±‚çš„æ•°æ®ã€‚åœ¨æŸä¸€ç‚¹ï¼Œä½ å®Œæˆäº†æ•°æ®çš„æ¥æ”¶å’Œå¤„ç†ï¼Œæˆ–è€…æºå¤´ï¼ˆæ¯”å¦‚æ–‡ä»¶æˆ–æœåŠ¡å™¨ï¼‰è¡¨æ˜æ²¡æœ‰æ›´å¤šçš„æ•°æ®è¦å‘é€ã€‚è¿™æ—¶ï¼Œä½ å°±ä¼šè°ƒç”¨ <code>readableStreamDefaultController.close()</code> æ¥å…³é—­æµï¼Œè¿™æ ·æ¶ˆè´¹è€…å°±çŸ¥é“æ‰€æœ‰æ•°æ®éƒ½å·²æ¥æ”¶å®Œæ¯•ï¼Œå¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œäº†ã€‚</p><h4 id="å®é™…ä¾‹å­-3" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-3"><span>å®é™…ä¾‹å­</span></a></h4><ol><li><p><strong>æ–‡ä»¶è¯»å–</strong>ï¼š</p><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œä½ æƒ³é€æ­¥è¯»å–å¹¶å¤„ç†æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚ä½ å¯ä»¥ä½¿ç”¨ Node.js çš„ Streams API æ¥åˆ›å»ºä¸€ä¸ªå¯è¯»æµï¼Œç„¶åé€æ­¥å¤„ç†æ•°æ®ã€‚ä¸€æ—¦ä½ è¯»å–åˆ°æ–‡ä»¶æœ«å°¾ï¼Œå°±å¯ä»¥è°ƒç”¨ <code>readableStreamDefaultController.close()</code> æ–¹æ³•æ¥å…³é—­æµã€‚</p></li><li><p><strong>ç½‘ç»œè¯·æ±‚</strong>ï¼š</p><p>å½“ä½ é€šè¿‡ HTTP è¯·æ±‚è·å–æ•°æ®æ—¶ï¼Œæ•°æ®ä¼šåˆ†æ‰¹æ¬¡è¿‡æ¥ã€‚ä½ å¯ä»¥ä½¿ç”¨æµæ¥å¤„ç†è¿™äº›æ•°æ®ã€‚ä¸€æ—¦æ‰€æœ‰æ•°æ®éƒ½æ¥æ”¶å®Œæ¯•ï¼Œæˆ–è€…å¦‚æœå‡ºç°é”™è¯¯éœ€è¦æå‰ç»“æŸæ•°æ®æ¥æ”¶ï¼Œä½ å¯ä»¥è°ƒç”¨ <code>readableStreamDefaultController.close()</code> æ–¹æ³•æ¥å…³é—­æµï¼Œé˜²æ­¢è¿›ä¸€æ­¥çš„æ•°æ®å¤„ç†ã€‚</p></li></ol><h3 id="ä»£ç ç¤ºä¾‹-3" tabindex="-1"><a class="header-anchor" href="#ä»£ç ç¤ºä¾‹-3"><span>ä»£ç ç¤ºä¾‹</span></a></h3><p>ä¸‹é¢çš„ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åœ¨ä¸€ä¸ªå‡è®¾çš„æƒ…å†µä¸‹ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œæ³¨æ„ï¼Œè¿™åªæ˜¯ä¸€ä¸ªæ¦‚å¿µæ€§çš„ç¤ºä¾‹ï¼Œå®é™…æƒ…å†µå¯èƒ½éœ€è¦æ›´å¤æ‚çš„é”™è¯¯å¤„ç†å’Œé€»è¾‘ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå¯è¯»æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯è¯»æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // æ¨¡æ‹Ÿå¼‚æ­¥åœ°æ”¾å…¥æ•°æ®</span></span>
<span class="line"><span style="color:#88C0D0;">    setTimeout</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, World!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">      // åœ¨æ•°æ®å‘é€å®Œæ¯•åå…³é—­æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">      controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span><span style="color:#B48EAD;"> 1000</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// æ¶ˆè´¹æµä¸­çš„æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">async</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">break;</span><span style="color:#616E88;"> // å¦‚æœæµå·²ç»å…³é—­ï¼Œè·³å‡ºå¾ªç¯</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å¤„ç†æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æµå·²ç»å…³é—­ï¼Œæ²¡æœ‰æ›´å¤šæ•°æ®ã€‚</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¾‹å­ç®€å•åœ°å±•ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªå¯è¯»æµï¼Œå‘å…¶ä¸­å¼‚æ­¥åœ°æ·»åŠ æ•°æ®ï¼Œç„¶åå…³é—­æµã€‚æ¶ˆè´¹è¿™ä¸ªæµçš„ä»£ç éƒ¨åˆ†åˆ™è¯»å–æ•°æ®ï¼Œç›´åˆ°æµè¢«å…³é—­ä¸ºæ­¢ã€‚</p><p>å¸Œæœ›è¿™èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£ <code>readableStreamDefaultController.close()</code> æ–¹æ³•åŠå…¶åœ¨ Node.js ä¸­çš„åº”ç”¨ã€‚</p><h4 id="readablestreamdefaultcontroller-desiredsize" tabindex="-1"><a class="header-anchor" href="#readablestreamdefaultcontroller-desiredsize"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreamdefaultcontrollerdesiredsize" target="_blank" rel="noopener noreferrer">readableStreamDefaultController.desiredSize</a></span></a></h4><p>å½“æˆ‘ä»¬è°ˆè®º Node.js ä¸­çš„<code>readableStreamDefaultController.desiredSize</code>ï¼Œæˆ‘ä»¬å®é™…ä¸Šåœ¨æ¢è®¨çš„æ˜¯ Web Streams API çš„ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„ç‰¹æ€§ã€‚ä¸ºäº†å½»åº•ç†è§£å®ƒï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦åŸºæœ¬äº†è§£å‡ ä¸ªæ¦‚å¿µï¼šæµï¼ˆStreamsï¼‰ã€å¯è¯»æµï¼ˆReadable Streamsï¼‰ã€å’Œæµæ§åˆ¶å™¨ï¼ˆStream Controllersï¼‰ã€‚</p><h3 id="æµ-streams" tabindex="-1"><a class="header-anchor" href="#æµ-streams"><span>æµï¼ˆStreamsï¼‰</span></a></h3><p>åœ¨ç¼–ç¨‹ä¸­ï¼Œ&quot;æµ&quot;æ˜¯ä¸€ç§æŠ½è±¡æ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯æ•°æ®çš„è¿ç»­ä¼ è¾“ã€‚æƒ³è±¡ä¸€ä¸‹æ°´æµï¼Œæ•°æ®å°±åƒæ°´ä¸€æ ·ä»ä¸€ä¸ªåœ°æ–¹ï¼ˆæºå¤´ï¼‰æµå‘å¦ä¸€ä¸ªåœ°æ–¹ï¼ˆç›®çš„åœ°ï¼‰ã€‚åœ¨ Node.js ä¸­ï¼Œæµè¢«å¹¿æ³›ç”¨äºå¤„ç†ä¾‹å¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œé€šä¿¡ç­‰åœºæ™¯ï¼Œå› ä¸ºå®ƒä»¬å…è®¸æ•°æ®è¢«é€å—å¤„ç†ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ•°æ®é›†åˆåˆ°å†…å­˜ä¸­ã€‚</p><h3 id="å¯è¯»æµ-readable-streams" tabindex="-1"><a class="header-anchor" href="#å¯è¯»æµ-readable-streams"><span>å¯è¯»æµï¼ˆReadable Streamsï¼‰</span></a></h3><p>å¯è¯»æµæ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œä¸“é—¨ç”¨äºæ•°æ®è¯»å–æ“ä½œã€‚å®ƒä»¬æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥æŒ‰éœ€è¯»å–æ•°æ®å—ï¼ŒåŒæ—¶ä¿æŒå†…å­˜ä½¿ç”¨åœ¨å¯æ§èŒƒå›´å†…ã€‚è¿™å¯¹äºå¤„ç†å¤§æ–‡ä»¶æˆ–æŒç»­çš„æ•°æ®æºï¼ˆä¾‹å¦‚å®æ—¶è§†é¢‘æµï¼‰å°¤å…¶é‡è¦ã€‚</p><h3 id="æµæ§åˆ¶å™¨-stream-controllers" tabindex="-1"><a class="header-anchor" href="#æµæ§åˆ¶å™¨-stream-controllers"><span>æµæ§åˆ¶å™¨ï¼ˆStream Controllersï¼‰</span></a></h3><p>æ¯ä¸ªå¯è¯»æµèƒŒåéƒ½æœ‰ä¸€ä¸ªæ§åˆ¶å™¨â€”â€”<code>ReadableStreamDefaultController</code>ï¼Œè´Ÿè´£ç®¡ç†æµçš„çŠ¶æ€å’Œè¡Œä¸ºã€‚å…¶ä¸­ï¼Œ<code>.desiredSize</code>å±æ€§æ‰®æ¼”ç€å…³é”®è§’è‰²ã€‚</p><h3 id="readablestreamdefaultcontroller-desiredsize-1" tabindex="-1"><a class="header-anchor" href="#readablestreamdefaultcontroller-desiredsize-1"><span><code>readableStreamDefaultController.desiredSize</code></span></a></h3><p>è¯¥å±æ€§è¡¨ç¤ºæ§åˆ¶å™¨å¸Œæœ›ç¼“å†²åŒºè¾¾åˆ°çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œç®€è€Œè¨€ä¹‹ï¼Œå®ƒåæ˜ äº†æµåœ¨è¯»å–æ›´å¤šæ•°æ®å‰èƒ½å¤Ÿæ¥æ”¶çš„æ•°æ®é‡ã€‚è¿™ä¸ªå€¼å¯èƒ½ä¼šå› ä¸ºå¤šç§åŸå› è€Œå˜åŒ–ï¼ˆå¦‚ç¼“å†²åŒºå·²æ»¡ã€æ•°æ®è¢«æ¶ˆè´¹ç­‰ï¼‰ï¼Œä½†å…¶æ ¸å¿ƒç›®çš„æ˜¯ä¸ºäº†å¹³è¡¡æ•°æ®ç”Ÿäº§å’Œæ¶ˆè´¹çš„é€Ÿåº¦ï¼Œä»è€Œé¿å…å†…å­˜æº¢å‡ºã€‚</p><h4 id="å®é™…è¿ç”¨ç¤ºä¾‹-5" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-5"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªç½‘ç«™ï¼Œè¯¥ç½‘ç«™æœ‰ä¸€ä¸ªåŠŸèƒ½æ˜¯è®©ç”¨æˆ·ä¸Šä¼ è§†é¢‘ï¼Œç„¶åè½¬ç ï¼ˆæ”¹å˜è§†é¢‘æ ¼å¼æˆ–è´¨é‡ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½ä¼šä½¿ç”¨åˆ° Node.js çš„å¯è¯»æµæ¥å¤„ç†ä¸Šä¼ çš„è§†é¢‘æ–‡ä»¶ã€‚</p><ol><li><strong>è§†é¢‘ä¸Šä¼ </strong>ï¼šç”¨æˆ·ä¸Šä¼ çš„è§†é¢‘æ–‡ä»¶ä½œä¸ºä¸€ä¸ªå¯è¯»æµè¢«æœåŠ¡å™¨æ¥æ”¶ã€‚</li><li><strong>æ§åˆ¶å™¨ç›‘è§†</strong>ï¼šé€šè¿‡æ£€æŸ¥<code>readableStreamDefaultController.desiredSize</code>ï¼Œä½ çš„åº”ç”¨å¯ä»¥å®æ—¶ç›‘æµ‹åˆ°å½“å‰æµæ˜¯å¦å‡†å¤‡å¥½æ¥æ”¶æ›´å¤šçš„æ•°æ®ï¼Œæˆ–è€…æ˜¯å¦åº”è¯¥æš‚åœæ¥æ”¶ï¼Œç›´åˆ°ç°æœ‰çš„æ•°æ®è¢«å¤„ç†ã€‚</li><li><strong>æ•°æ®å¤„ç†</strong>ï¼šå¦‚æœ<code>desiredSize</code>æ˜¾ç¤ºè¿˜æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼ŒæœåŠ¡å™¨ç»§ç»­ä»ä¸Šä¼ çš„æµä¸­è¯»å–æ›´å¤šæ•°æ®ã€‚ä¸€æ—¦æ•°æ®å—è¢«è¯»å–ï¼Œå®ƒå¯ä»¥è¢«é€å»è½¬ç ã€‚</li><li><strong>æµé‡æ§åˆ¶</strong>ï¼šå¦‚æœ<code>desiredSize</code>å˜æˆ<code>null</code>æˆ–è´Ÿæ•°ï¼Œè¡¨æ˜ç¼“å†²åŒºå·²æ»¡æˆ–æ¥è¿‘æº¢å‡ºï¼Œæ­¤æ—¶ï¼ŒæœåŠ¡å™¨å¯ä»¥æš‚åœä»åŸå§‹æµä¸­è¯»å–ï¼Œç›´åˆ°å½“å‰ç¼“å†²çš„æ•°æ®å¾—åˆ°å¤„ç†ã€‚</li></ol><p>é€šè¿‡è¿™æ ·çš„æœºåˆ¶ï¼ŒNode.js åº”ç”¨èƒ½å¤Ÿæœ‰æ•ˆç®¡ç†èµ„æºï¼Œé˜²æ­¢å†…å­˜æº¢å‡ºï¼Œå¹¶ç¡®ä¿å³ä¾¿æ˜¯å¤„ç†å¤§å‹æ–‡ä»¶æˆ–æ•°æ®æµæ—¶ä¹Ÿèƒ½ä¿æŒé«˜æ•ˆç‡å’Œå“åº”æ€§ã€‚</p><h4 id="readablestreamdefaultcontroller-enqueue-chunk" tabindex="-1"><a class="header-anchor" href="#readablestreamdefaultcontroller-enqueue-chunk"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreamdefaultcontrollerenqueuechunk" target="_blank" rel="noopener noreferrer">readableStreamDefaultController.enqueue([chunk])</a></span></a></h4><p>è¦ç†è§£<code>readableStreamDefaultController.enqueue([chunk])</code>ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦æ˜ç™½å‡ ä¸ªæ¦‚å¿µï¼š<code>ReadableStream</code>ã€<code>ReadableStreamDefaultController</code>å’Œæµï¼ˆstreamï¼‰çš„åŸºç¡€çŸ¥è¯†ã€‚</p><h3 id="æµ-streams-ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#æµ-streams-ç®€ä»‹"><span>æµ(Streams)ç®€ä»‹</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œæµæ˜¯æ•°æ®çš„é›†åˆï¼Œåƒæ˜¯ä¸€ä¸ªæ°´æµä¸€æ ·ï¼Œæ•°æ®å¯ä»¥ä»ä¸€ä¸ªåœ°æ–¹æµåˆ°å¦ä¸€ä¸ªåœ°æ–¹ã€‚æµå¯ä»¥è®©ä½ é«˜æ•ˆåœ°å¤„ç†å¤§é‡æ•°æ®ï¼Œå› ä¸ºä½ ä¸éœ€è¦ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å¯ç”¨æ‰å¼€å§‹å¤„ç†å®ƒä»¬ã€‚Node.js ä¸­æœ‰å››ç§åŸºæœ¬ç±»å‹çš„æµï¼š</p><ul><li><strong>Readable</strong>ï¼ˆå¯è¯»çš„ï¼‰</li><li><strong>Writable</strong>ï¼ˆå¯å†™çš„ï¼‰</li><li><strong>Duplex</strong>ï¼ˆå¯è¯»å†™çš„ï¼‰</li><li><strong>Transform</strong>ï¼ˆåœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹æˆ–è½¬æ¢æ•°æ®çš„ï¼‰</li></ul><h3 id="readablestream-ä¸-readablestreamdefaultcontroller" tabindex="-1"><a class="header-anchor" href="#readablestream-ä¸-readablestreamdefaultcontroller"><span>ReadableStream ä¸ ReadableStreamDefaultController</span></a></h3><p>åœ¨ Web Streams APIï¼ˆä¹Ÿè¢« Node.js é‡‡çº³ï¼‰ä¸­ï¼Œ<code>ReadableStream</code>ä»£è¡¨ä¸€ä¸ªæºè‡ªæŸå¤„çš„æ•°æ®åºåˆ—ã€‚æ¯”å¦‚ï¼Œå®ƒå¯ä»¥æ˜¯æ¥è‡ªæ–‡ä»¶çš„æ•°æ®ã€ç½‘ç»œè¯·æ±‚çš„æ•°æ®æˆ–è€…ä»»ä½•æ•°æ®çš„åŠ¨æ€ç”Ÿæˆã€‚</p><p><code>ReadableStreamDefaultController</code>æ˜¯æ§åˆ¶<code>ReadableStream</code>çš„é»˜è®¤æ§åˆ¶å™¨ã€‚å½“ä½ åˆ›å»ºä¸€ä¸ª<code>ReadableStream</code>æ—¶ï¼Œä½ å¯ä»¥ä¼ é€’ä¸€ä¸ªå«åš<code>underlying source</code>çš„å¯¹è±¡ç»™å®ƒï¼Œè¿™ä¸ªå¯¹è±¡å¯ä»¥å®šä¹‰å¦‚ä½•è·å–å’Œå¤„ç†æµçš„æ•°æ®ã€‚<code>ReadableStreamDefaultController</code>å°±æ˜¯<code>underlying source</code>å¯ä»¥ä½¿ç”¨çš„æ¥å£ä¹‹ä¸€ï¼Œç”¨äºå‘æµä¸­æ·»åŠ æ•°æ®(chunk)ã€‚</p><h3 id="readablestreamdefaultcontroller-enqueue-chunk-1" tabindex="-1"><a class="header-anchor" href="#readablestreamdefaultcontroller-enqueue-chunk-1"><span>readableStreamDefaultController.enqueue([chunk])</span></a></h3><p><code>enqueue([chunk])</code>æ˜¯<code>ReadableStreamDefaultController</code>çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒå…è®¸ä½ å¾€æµä¸­æ·»åŠ ä¸€æ®µæ•°æ®ï¼ˆç§°ä¸ºâ€œå—â€(chunk)ï¼‰ã€‚è¿™ä¸ªæ–¹æ³•ä¸»è¦åœ¨<code>underlying source</code>çš„<code>pull()</code>å‡½æ•°ä¸­ä½¿ç”¨ï¼Œ<code>pull()</code>å‡½æ•°æ˜¯åœ¨æµéœ€è¦æ›´å¤šæ•°æ®æ—¶è¢«è°ƒç”¨çš„ã€‚</p><h4 id="å‚æ•°-4" tabindex="-1"><a class="header-anchor" href="#å‚æ•°-4"><span>å‚æ•°</span></a></h4><ul><li><code>chunk</code>ï¼šè¦æ·»åŠ åˆ°æµä¸­çš„æ•°æ®å—ã€‚è¿™ä¸ªå‚æ•°æ˜¯å¯é€‰çš„ï¼Œå¦‚æœä¸æä¾›ï¼Œåˆ™ä»£è¡¨å‘æµä¸­æ·»åŠ ä¸€ä¸ªç©ºå—ã€‚</li></ul><h4 id="ä½¿ç”¨åœºæ™¯ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯ä¾‹å­"><span>ä½¿ç”¨åœºæ™¯ä¾‹å­</span></a></h4><ol><li><p><strong>åŠ¨æ€ç”Ÿæˆæ•°æ®å¹¶å‘é€ç»™å®¢æˆ·ç«¯</strong></p><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªç½‘ç«™ï¼Œéœ€è¦åŠ¨æ€ç”Ÿæˆä¸€äº›æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œå½“å‰æ—¶é—´çš„æ¯ç§’æ›´æ–°ï¼‰ï¼Œç„¶åå®æ—¶å‘é€ç»™æµè§ˆå™¨æ˜¾ç¤ºã€‚ä½ å¯ä»¥ä½¿ç”¨<code>ReadableStream</code>æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œé€šè¿‡å®šæ—¶è°ƒç”¨<code>enqueue()</code>æ–¹æ³•å‘æµä¸­æ·»åŠ å½“å‰æ—¶é—´ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">    setInterval</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // å‘æµä¸­æ·»åŠ å½“å‰æ—¶é—´</span></span>
<span class="line"><span style="color:#D8DEE9;">      controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> Date</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span><span style="color:#B48EAD;"> 1000</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // æ¯ç§’æ‰§è¡Œä¸€æ¬¡</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾è¿™æ˜¯åœ¨æœåŠ¡ç«¯ä»£ç ä¸­ï¼Œstreamå¯ä»¥ç›´æ¥å‘é€ç»™å®¢æˆ·ç«¯</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>ä»æ–‡ä»¶æŒ‰è¡Œè¯»å–æ–‡æœ¬</strong></p><p>å¦‚æœä½ æœ‰ä¸€ä¸ªå¤§æ–‡æœ¬æ–‡ä»¶ï¼Œæƒ³è¦æŒ‰è¡Œè¯»å–ï¼Œå¹¶ä¸”æ¯è¯»å–ä¸€è¡Œå°±å¤„ç†ä¸€è¡Œï¼Œå¯ä»¥ä½¿ç”¨<code>enqueue</code>ç»“åˆæ–‡ä»¶è¯»å–æµå®ç°ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readline</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">readline</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/your/file.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> rl</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> readline</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createInterface</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  input</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#88C0D0;">  crlfDelay</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> Infinity</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">  async</span><span style="color:#88C0D0;"> start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> line</span><span style="color:#81A1C1;"> of</span><span style="color:#D8DEE9;"> rl</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">      // å¯¹æ¯ä¸€è¡Œè¿›è¡Œå¤„ç†ï¼Œç„¶åå°†å…¶ä½œä¸ºå—åŠ å…¥æµä¸­</span></span>
<span class="line"><span style="color:#D8DEE9;">      controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#88C0D0;">processLine</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">line</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // æ–‡ä»¶ç»“æŸï¼Œå…³é—­æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> processLine</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">line</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // å¯¹è¡Œè¿›è¡ŒæŸäº›æ“ä½œ...</span></span>
<span class="line"><span style="color:#81A1C1;">  return</span><span style="color:#D8DEE9;"> modifiedLine</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>åœ¨è¿™ä¸¤ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>enqueue</code>æ–¹æ³•ä½¿å¾—æ•°æ®å¯ä»¥ä»¥æµçš„å½¢å¼è¢«é€æ­¥å¤„ç†å’Œå‘é€ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å¤„ç†æ•´ä¸ªæ•°æ®é›†ï¼Œä»è€Œæé«˜äº†ç¨‹åºçš„æ•ˆç‡å’Œå“åº”æ€§ã€‚</p><h4 id="readablestreamdefaultcontroller-error-error" tabindex="-1"><a class="header-anchor" href="#readablestreamdefaultcontroller-error-error"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreamdefaultcontrollererrorerror" target="_blank" rel="noopener noreferrer">readableStreamDefaultController.error([error])</a></span></a></h4><p>å½“ä½ å¼€å§‹å­¦ä¹ ç¼–ç¨‹ï¼Œå°¤å…¶æ˜¯ Web å¼€å‘æ—¶ï¼Œä½ ä¼šé‡åˆ°å„ç§å¤„ç†æ•°æ®æµï¼ˆstreamsï¼‰çš„åœºæ™¯ã€‚åœ¨è¿™äº›åœºæ™¯ä¸­ï¼ŒNode.js æä¾›äº†ä¸€ä¸ªéå¸¸å¼ºå¤§çš„åŠŸèƒ½é›†åˆæ¥å¤„ç†è¿™äº›æ•°æ®æµï¼Œå…¶ä¸­ä¹‹ä¸€å°±æ˜¯å¯è¯»æµï¼ˆReadable Streamï¼‰ã€‚ç†è§£å¯è¯»æµå¯¹äºé«˜æ•ˆåœ°å¤„ç†åƒæ–‡ä»¶è¯»å–ã€ç½‘ç»œè¯·æ±‚ç­‰æ“ä½œå¾ˆé‡è¦ã€‚</p><p>åœ¨ Node.js ä¸­ï¼Œ<code>readableStreamDefaultController.error([error])</code>æ–¹æ³•æ˜¯ä¸å¯è¯»æµç›¸å…³çš„ä¸€ä¸ªå…·ä½“åŠŸèƒ½ã€‚è¿™ä¸ªæ–¹æ³•å…è®¸ä½ æ‰‹åŠ¨åœ°å‘æµä¸­æ·»åŠ ä¸€ä¸ªé”™è¯¯ï¼Œè¿™åœ¨å¤„ç†æµæ•°æ®æ—¶éå¸¸æœ‰ç”¨ã€‚ä½†ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦å‘æµä¸­æ·»åŠ é”™è¯¯å‘¢ï¼Ÿåœ¨å®é™…åº”ç”¨ä¸­ï¼Œé€šå¸¸å½“æ•°æ®æµè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸æˆ–è€…ä¸ç¬¦åˆé¢„æœŸçš„æƒ…å†µæ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤ŸåŠæ—¶åœ°åœæ­¢æµï¼Œå¹¶ä¸”é€šçŸ¥æµçš„æ¶ˆè´¹è€…ï¼ˆå³é‚£äº›æ­£åœ¨ä»æµä¸­è¯»å–æ•°æ®çš„éƒ¨åˆ†ï¼‰ï¼Œè®©å®ƒä»¬çŸ¥é“å‘ç”Ÿäº†é”™è¯¯ã€‚</p><h3 id="å®é™…è¿ç”¨ä¾‹å­-6" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-6"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><p>è®©æˆ‘ä»¬é€šè¿‡å‡ ä¸ªä¾‹å­æ¥æ›´å…·ä½“åœ°ç†è§£è¿™ä¸ªæ–¹æ³•çš„ç”¨æ³•ï¼š</p><h4 id="ä¾‹å­-1-æ–‡ä»¶è¯»å–ç¨‹åº" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-æ–‡ä»¶è¯»å–ç¨‹åº"><span>ä¾‹å­ 1ï¼šæ–‡ä»¶è¯»å–ç¨‹åº</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨å†™ä¸€ä¸ªç¨‹åºï¼Œè¿™ä¸ªç¨‹åºéœ€è¦ä»ä¸€ä¸ªæ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚ä½¿ç”¨ Node.jsï¼Œä½ å¯èƒ½ä¼šåˆ›å»ºä¸€ä¸ªå¯è¯»æµæ¥é€å—è¯»å–æ–‡ä»¶å†…å®¹ï¼Œä»¥ä¾¿äºå¤„ç†å¤§æ–‡ä»¶è€Œä¸å¿…ä¸€æ¬¡æ€§å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚å¦‚æœåœ¨è¯»å–è¿‡ç¨‹ä¸­æ–‡ä»¶çªç„¶å˜å¾—ä¸å¯è®¿é—®ï¼ˆæ¯”å¦‚è¢«åˆ é™¤äº†ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>readableStreamDefaultController.error(new Error(&#39;File not accessible&#39;))</code>æ¥å‘æµä¸­æ·»åŠ ä¸€ä¸ªé”™è¯¯ï¼Œç„¶åè¿™ä¸ªé”™è¯¯ä¼šè¢«æµçš„æ¶ˆè´¹è€…æ•è·å¹¶å¤„ç†ï¼Œæ¯”å¦‚é€šè¿‡æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·ã€‚</p><h4 id="ä¾‹å­-2-ç½‘ç»œè¯·æ±‚å¤„ç†" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-ç½‘ç»œè¯·æ±‚å¤„ç†"><span>ä¾‹å­ 2ï¼šç½‘ç»œè¯·æ±‚å¤„ç†</span></a></h4><p>è€ƒè™‘å¦å¤–ä¸€ä¸ªä¾‹å­ï¼Œä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªæœåŠ¡ï¼Œè¯¥æœåŠ¡ä»è¿œç¨‹ API è·å–æ•°æ®ã€‚ä½ åˆ›å»ºäº†ä¸€ä¸ªå¯è¯»æµæ¥å¤„ç†ä» API æ¥æ”¶åˆ°çš„æ•°æ®ã€‚å¦‚æœ API è¿”å›äº†ä¸æ­£ç¡®çš„å“åº”æˆ–è€…è¿æ¥ä¸­æ–­äº†ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>readableStreamDefaultController.error(new Error(&#39;Failed to fetch data&#39;))</code>æ¥å‘Šè¯‰æµæ¶ˆè´¹è€…å‘ç”Ÿäº†é”™è¯¯ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥æ ¹æ®é”™è¯¯ä¿¡æ¯å†³å®šæ˜¯å¦é‡è¯•è¯·æ±‚æˆ–è€…è¿”å›å¤‡ç”¨æ•°æ®ã€‚</p><h4 id="ä¾‹å­-3-æ•°æ®è½¬æ¢ç¨‹åº" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-3-æ•°æ®è½¬æ¢ç¨‹åº"><span>ä¾‹å­ 3ï¼šæ•°æ®è½¬æ¢ç¨‹åº</span></a></h4><p>æœ€åï¼Œå‡è®¾ä½ åœ¨å¼€å‘ä¸€ä¸ªéœ€è¦è¯»å–æ•°æ®æµå¹¶è½¬æ¢æ•°æ®æ ¼å¼çš„åº”ç”¨ï¼Œæ¯”å¦‚ä¸€ä¸ªå°† CSV æ–‡ä»¶è½¬æ¢ä¸º JSON å¯¹è±¡çš„ç¨‹åºã€‚åœ¨è½¬æ¢è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ°æ ¼å¼é”™è¯¯çš„æ•°æ®ï¼Œä½ å¯èƒ½å¸Œæœ›åœæ­¢è¿›ä¸€æ­¥çš„å¤„ç†å¹¶é€šçŸ¥ç”¨æˆ·ã€‚æ­¤æ—¶ï¼Œä½¿ç”¨<code>readableStreamDefaultController.error(new Error(&#39;Invalid CSV format&#39;))</code>èƒ½å¤Ÿæœ‰æ•ˆåœ°ä¸­æ–­æµå¹¶æé†’ç”¨æˆ·é—®é¢˜æ‰€åœ¨ã€‚</p><h3 id="ç»“è®º" tabindex="-1"><a class="header-anchor" href="#ç»“è®º"><span>ç»“è®º</span></a></h3><p>ç®€è€Œè¨€ä¹‹ï¼Œ<code>readableStreamDefaultController.error([error])</code>æ–¹æ³•åœ¨ Node.js ä¸­æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œå®ƒå…è®¸å¼€å‘è€…åœ¨å¤„ç†å¯è¯»æµæ—¶åŠæ—¶å“åº”é”™è¯¯æƒ…å†µã€‚é€šè¿‡å‘æµä¸­æ·»åŠ é”™è¯¯ï¼Œå¼€å‘è€…å¯ä»¥ä¼˜é›…åœ°å¤„ç†å¼‚å¸¸ï¼Œç¡®ä¿åº”ç”¨çš„å¥å£®æ€§å’Œç”¨æˆ·çš„è‰¯å¥½ä½“éªŒã€‚</p><h3 id="class-readablebytestreamcontroller" tabindex="-1"><a class="header-anchor" href="#class-readablebytestreamcontroller"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-readablebytestreamcontroller" target="_blank" rel="noopener noreferrer">Class: ReadableByteStreamController</a></span></a></h3><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥äº†è§£ <code>ReadableByteStreamController</code> è¿™ä¸ªæ¦‚å¿µã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å®ƒæ˜¯ Node.js ä¸­ä¸ Web Streams API ç›¸å…³çš„ä¸€ä¸ªéƒ¨åˆ†ã€‚è¿™å¬èµ·æ¥å¯èƒ½æœ‰äº›å¤æ‚ï¼Œä½†æˆ‘ä¼šå°½é‡é€šä¿—åœ°è§£é‡Šã€‚</p><h3 id="ä»€ä¹ˆæ˜¯-web-streams-api" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯-web-streams-api"><span>ä»€ä¹ˆæ˜¯ Web Streams APIï¼Ÿ</span></a></h3><p>ç®€å•æ¥è¯´ï¼ŒWeb Streams API å…è®¸ä½ ä»¥æµï¼ˆstreamï¼‰çš„å½¢å¼å¤„ç†æ•°æ®ã€‚æƒ³è±¡ä¸€ä¸‹æ°´æµï¼Œæ•°æ®å°±åƒæ˜¯ä»ä¸€ä¸ªåœ°æ–¹â€œæµâ€å‘å¦ä¸€ä¸ªåœ°æ–¹ã€‚è¿™ç§æ–¹æ³•ç‰¹åˆ«é€‚åˆå¤„ç†å¤§é‡æ•°æ®ï¼Œæ¯”å¦‚æ–‡ä»¶ä¼ è¾“ã€è§†é¢‘æ’­æ”¾ç­‰ï¼Œå› ä¸ºä½ ä¸éœ€è¦ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å‡†å¤‡å¥½æ‰å¼€å§‹å¤„ç†ï¼Œè€Œæ˜¯å¯ä»¥è¾¹æ¥æ”¶è¾¹å¤„ç†ï¼Œè¿™æ ·æ•ˆç‡æ›´é«˜ã€‚</p><h3 id="readablebytestreamcontroller-æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#readablebytestreamcontroller-æ˜¯ä»€ä¹ˆ"><span>ReadableByteStreamController æ˜¯ä»€ä¹ˆï¼Ÿ</span></a></h3><p><code>ReadableByteStreamController</code> æ˜¯ Node.js ä¸­å®ç° Web Streams API çš„ä¸€ä¸ªç±»ã€‚å®ƒç”¨äºæ§åˆ¶ä¸€ä¸ªå¯è¯»å­—èŠ‚æµï¼ˆReadable Byte Streamï¼‰çš„çŠ¶æ€å’Œè¡Œä¸ºã€‚è¿™é‡Œçš„â€œå­—èŠ‚â€æŒ‡çš„æ˜¯æ•°æ®çš„åŸºæœ¬å•ä½ï¼Œè€Œâ€œå¯è¯»â€æ„å‘³ç€è¿™ä¸ªæµå¯ä»¥è¢«è¯»å–ã€‚</p><p>åœ¨å†…éƒ¨ï¼Œå½“ä½ åˆ›å»ºä¸€ä¸ªå¯è¯»æµæ—¶ï¼Œ<code>ReadableByteStreamController</code> è¢«ç”¨æ¥è®¾ç½®æµçš„ç­–ç•¥ï¼ˆæ¯”å¦‚ï¼Œç¼“å†²åŒºå¤§å°ï¼‰ã€å“åº”æµçš„è¯·æ±‚ï¼Œä»¥åŠç®¡ç†æµçš„çŠ¶æ€ï¼ˆæ¯”å¦‚ï¼Œå¼€å§‹ã€æš‚åœã€æ¢å¤ã€ç»“æŸï¼‰ã€‚</p><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-6" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-6"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><ol><li><p><strong>æ–‡ä»¶è¯»å–</strong>ï¼šå‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªåº”ç”¨ï¼Œéœ€è¦ä»å¤§å‹æ—¥å¿—æ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚ä½¿ç”¨ <code>ReadableByteStreamController</code> å¯ä»¥å¸®åŠ©ä½ æœ‰æ•ˆåœ°ä¸€å°å—ä¸€å°å—åœ°è¯»å–æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p></li><li><p><strong>è§†é¢‘æµä¼ è¾“</strong>ï¼šå¦‚æœä½ æ­£åœ¨åˆ¶ä½œä¸€ä¸ªåœ¨çº¿è§†é¢‘æ’­æ”¾æœåŠ¡ï¼Œå®¢æˆ·ç«¯å¯èƒ½ä¸éœ€è¦ç«‹å³ä¸‹è½½æ•´ä¸ªè§†é¢‘å°±å¼€å§‹æ’­æ”¾ã€‚é€šè¿‡æµå¼ä¼ è¾“ï¼Œä½ å¯ä»¥åˆ©ç”¨ <code>ReadableByteStreamController</code> æ§åˆ¶è§†é¢‘æ•°æ®çš„ä¼ è¾“ï¼Œè®©ç”¨æˆ·è¾¹ä¸‹è½½è¾¹è§‚çœ‹ã€‚</p></li><li><p><strong>æ•°æ®å‹ç¼©å’Œè½¬æ¢</strong>ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½éœ€è¦å¯¹æµå¼ä¼ è¾“çš„æ•°æ®è¿›è¡Œå‹ç¼©æˆ–æ ¼å¼è½¬æ¢ã€‚ä¾‹å¦‚ï¼ŒæœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€ç»è¿‡å‹ç¼©çš„æ•°æ®ä»¥èŠ‚çœå¸¦å®½ã€‚<code>ReadableByteStreamController</code> å¯ä»¥å¸®åŠ©ç®¡ç†è¿™ä¸ªå‹ç¼©è¿‡ç¨‹ï¼Œç¡®ä¿æ•°æ®æµæ˜¯è¿ç»­å’Œé«˜æ•ˆçš„ã€‚</p></li></ol><h3 id="å¦‚ä½•ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ä½¿ç”¨"><span>å¦‚ä½•ä½¿ç”¨ï¼Ÿ</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾æˆ‘ä»¬åœ¨ Node.js ç¯å¢ƒä¸­</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªç®€å•çš„å¯è¯»æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // ä½¿ç”¨controller.enqueue()å‘æµä¸­æ·»åŠ æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, world!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Another piece of data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // å½“æ‰€æœ‰æ•°æ®æ·»åŠ å®Œæ¯•åï¼Œè°ƒç”¨controller.close()å…³é—­æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è¯»å–æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> readStream</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">break;</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºæµä¸­çš„æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">readStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„å¯è¯»æµï¼Œå‘å…¶ä¸­æ·»åŠ äº†ä¸€äº›æ•°æ®ï¼Œç„¶ååˆè¯»å–å‡ºæ¥ã€‚è™½ç„¶è¿™æ˜¯ä¸€ä¸ªéå¸¸åŸºç¡€çš„ä¾‹å­ï¼Œä½†å®ƒå±•ç¤ºäº†å¦‚ä½•é€šè¿‡ <code>ReadableByteStreamController</code> æ¥æ§åˆ¶æ•°æ®çš„æµåŠ¨ã€‚</p><p>æ€»ä¹‹ï¼Œ<code>ReadableByteStreamController</code> æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©ä½ ä»¥é«˜æ•ˆã€çµæ´»çš„æ–¹å¼å¤„ç†æ•°æ®æµã€‚éšç€ä½ å¯¹ Node.js å’Œç¼–ç¨‹çš„æ·±å…¥å­¦ä¹ ï¼Œä½ ä¼šå‘ç°è¶Šæ¥è¶Šå¤šçš„åœºæ™¯å¯ä»¥åˆ©ç”¨åˆ°å®ƒã€‚</p><h4 id="readablebytestreamcontroller-byobrequest" tabindex="-1"><a class="header-anchor" href="#readablebytestreamcontroller-byobrequest"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablebytestreamcontrollerbyobrequest" target="_blank" rel="noopener noreferrer">readableByteStreamController.byobRequest</a></span></a></h4><p>ç†è§£<code>readableByteStreamController.byobRequest</code>ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£å‡ ä¸ªæ¦‚å¿µï¼š<strong>Streamsï¼ˆæµï¼‰</strong>ã€<strong>BYOBï¼ˆBring Your Own Bufferï¼Œè‡ªå¸¦ç¼“å†²åŒºï¼‰<strong>ä»¥åŠ</strong>ReadableByteStreamController</strong>ã€‚</p><h3 id="streams-æµ-1" tabindex="-1"><a class="header-anchor" href="#streams-æµ-1"><span>Streamsï¼ˆæµï¼‰</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œæµæ˜¯ä¸€ç§å¤„ç†è¯»å–æˆ–å†™å…¥æ•°æ®çš„æ–¹å¼ã€‚æƒ³è±¡ä¸€ä¸‹ä½ æ­£åœ¨ç”¨ä¸€æ ¹æ°´ç®¡çŒæº‰èŠ±å›­ï¼Œæ•°æ®å°±åƒæ°´ä¸€æ ·é€šè¿‡è¿™æ ¹ç®¡å­ï¼ˆæµï¼‰ä»ä¸€ä¸ªåœ°æ–¹ï¼ˆå¦‚æ–‡ä»¶ï¼‰æµå‘å¦ä¸€ä¸ªåœ°æ–¹ï¼ˆå¦‚ç½‘ç»œè¿æ¥ï¼‰ã€‚æµå¯ä»¥ä½¿ä½ ä¸å¿…ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè€Œæ˜¯å¯ä»¥é€å—å¤„ç†æ•°æ®ï¼Œè¿™å¯¹äºå¤„ç†å¤§é‡æ•°æ®éå¸¸æœ‰ç”¨ã€‚</p><h3 id="byob-bring-your-own-buffer" tabindex="-1"><a class="header-anchor" href="#byob-bring-your-own-buffer"><span>BYOBï¼ˆBring Your Own Bufferï¼‰</span></a></h3><p>BYOB æ˜¯ Web Streams API ä¸­çš„ä¸€ä¸ªé«˜çº§ç‰¹æ€§ï¼Œå…è®¸æ›´ç»†ç²’åº¦æ§åˆ¶å¦‚ä½•è¯»å–æµä¸­çš„æ•°æ®ã€‚æ™®é€šçš„æµä¼šä¸ºä½ åˆ›å»ºç¼“å†²åŒºå¹¶ç®¡ç†æ•°æ®çš„è¯»å–è¿‡ç¨‹ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½å¸Œæœ›è‡ªå·±æ§åˆ¶ç¼“å†²åŒºã€‚è¿™å°±æ˜¯ BYOB å‡ºåœºçš„æ—¶åˆ»â€”â€”å®ƒå…è®¸ä½ æä¾›è‡ªå·±çš„ Bufferï¼ˆç¼“å†²åŒºå¯¹è±¡ï¼‰ï¼Œç›´æ¥å¾€é‡Œé¢è¯»æ•°æ®ã€‚</p><h3 id="readablebytestreamcontroller" tabindex="-1"><a class="header-anchor" href="#readablebytestreamcontroller"><span>ReadableByteStreamController</span></a></h3><p><code>ReadableByteStreamController</code>æ˜¯ä¸€ä¸ªç”¨äºç®¡ç†å­—èŠ‚æµï¼ˆæ¯”å¦‚æ–‡ä»¶çš„äºŒè¿›åˆ¶æ•°æ®ï¼‰è¯»å–çš„æ§åˆ¶å™¨ã€‚å®ƒåœ¨åº•å±‚è´Ÿè´£ä¼ è¾“æ•°æ®åˆ°ç”±å¼€å‘è€…æä¾›çš„ç¼“å†²åŒºï¼Œå¹¶ç®¡ç†æµçš„çŠ¶æ€ï¼ˆå¦‚å¼€å§‹ã€æš‚åœå’Œç»“æŸè¯»å–æ“ä½œï¼‰ã€‚</p><h3 id="readablebytestreamcontroller-byobrequest-1" tabindex="-1"><a class="header-anchor" href="#readablebytestreamcontroller-byobrequest-1"><span>readableByteStreamController.byobRequest</span></a></h3><p>ç°åœ¨è¯´åˆ°<code>readableByteStreamController.byobRequest</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªå±æ€§ï¼ŒæŒ‡å‘å½“å‰å¦‚æœå­˜åœ¨çš„è¯ï¼Œç”±æµæ¶ˆè´¹è€…è¿›è¡Œçš„ BYOB è¯·æ±‚ã€‚è¿™ä¸ªå±æ€§ä¸»è¦ç”¨äºå®ç°è‡ªå®šä¹‰çš„ Reader æ¥æ§åˆ¶å¦‚ä½•è¯»å–æµä¸­çš„æ•°æ®åˆ°ä¸€ä¸ª Buffer ä¸­ã€‚</p><p>å½“æµçš„æ¶ˆè´¹è€…å¸Œæœ›ä½¿ç”¨è‡ªå·±çš„ Bufferï¼ˆä¾‹å¦‚ï¼Œä¸ºäº†å¤ç”¨æˆ–è€…æ§åˆ¶å†…å­˜åˆ†é…ï¼‰æ—¶ï¼Œå®ƒä»¬ä¼šåˆ›å»ºä¸€ä¸ª BYOB è¯·æ±‚ã€‚è¿™ä¸ªè¯·æ±‚åŒ…å«äº†ç›®æ ‡ Buffer å’Œå¸Œæœ›ä»æµä¸­è¯»å–çš„å­—èŠ‚æ•°ã€‚</p><h4 id="å®é™…è¿ç”¨ä¾‹å­-7" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-7"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js ç¨‹åºï¼Œè¯¥ç¨‹åºéœ€è¦ä»ä¸€ä¸ªå¤§æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œå¹¶ä¸”ä½ æƒ³æœ€å°åŒ–å†…å­˜å ç”¨å¹¶æé«˜æ€§èƒ½ã€‚ä½ å¯ä»¥ä½¿ç”¨ BYOB ç‰¹æ€§æ¥å¤ç”¨åŒä¸€ä¸ª Bufferï¼Œè€Œä¸æ˜¯æ¯æ¬¡è¯»å–æ—¶éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/large-file</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">  highWaterMark</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1024</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾ä½ å·²ç»æœ‰äº†ä¸€ä¸ªé¢„å…ˆåˆ†é…çš„Buffer</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> myBuffer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Uint8Array</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">1024</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">readable</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">null</span><span style="color:#81A1C1;"> !==</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">readInto</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">myBuffer</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">    // å¤„ç†myBufferä¸­çš„æ•°æ®...</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">å¤„ç†äº† </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">myBuffer</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">length</span><span style="color:#81A1C1;">}</span><span style="color:#A3BE8C;"> å­—èŠ‚çš„æ•°æ®...</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // å¯èƒ½åœ¨å¤„ç†å®Œåé‡ç½®æˆ–è€…é‡æ–°åˆ†é…myBuffer</span></span>
<span class="line"><span style="color:#616E88;">    // myBuffer = ...</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">end</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æ•°æ®è¯»å–å®Œæˆã€‚</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·æ³¨æ„ï¼Œæ­¤ä»£ç ç¤ºä¾‹ç”¨äºè¯´æ˜æ¦‚å¿µï¼Œå®é™…ä¸Š<code>readInto</code>æ–¹æ³•å¹¶ä¸æ˜¯ Node.js æ ‡å‡† API çš„ä¸€éƒ¨åˆ†ã€‚BYOB æ¨¡å¼åœ¨ä½¿ç”¨åŸç”Ÿ<code>ReadableStream</code>åŠå…¶æ§åˆ¶å™¨å¦‚<code>ReadableByteStreamController</code>æ—¶æ›´ä¸ºå¸¸è§ï¼Œè¿™äº›é€šå¸¸åœ¨ä½¿ç”¨<code>web streams</code> API æˆ–å®ç°è‡ªå®šä¹‰æµæ—¶é‡åˆ°ï¼Œå¹¶ä¸”éœ€è¦é€šè¿‡ç‰¹å®šçš„æ–¹æ³•å¦‚<code>reader.read(view)</code>æ¥å®ç°ï¼Œå…¶ä¸­<code>view</code>æ˜¯ä½ çš„ BYOB buffer è§†å›¾ã€‚</p><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ èƒ½æ›´ç²¾ç¡®åœ°æ§åˆ¶æ•°æ®æ˜¯å¦‚ä½•ä»æºæµå‘ä½ çš„åº”ç”¨ç¨‹åºçš„ï¼Œè¿™åœ¨å¤„ç†å¤§é‡æ•°æ®æˆ–éœ€è¦æœ€ä¼˜æ€§èƒ½æ—¶éå¸¸æœ‰ç”¨ã€‚</p><h4 id="readablebytestreamcontroller-close" tabindex="-1"><a class="header-anchor" href="#readablebytestreamcontroller-close"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablebytestreamcontrollerclose" target="_blank" rel="noopener noreferrer">readableByteStreamController.close()</a></span></a></h4><p>äº†è§£ <code>readableByteStreamController.close()</code> å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ˜ç™½å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼šNode.jsã€Streamsï¼ˆæµï¼‰ã€ä»¥åŠ Web Streams API åœ¨ Node.js ä¸­çš„åº”ç”¨ã€‚</p><p><strong>Node.js</strong> æ˜¯ä¸€ä¸ªå¼€æºå’Œè·¨å¹³å°çš„ JavaScript è¿è¡Œæ—¶ç¯å¢ƒï¼Œå®ƒå…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚Node.js éå¸¸é€‚åˆå¤„ç† I/O å¯†é›†å‹ä»»åŠ¡ï¼Œå¦‚ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶æ“ä½œç­‰ã€‚</p><p><strong>Streamsï¼ˆæµï¼‰</strong> æ˜¯ä¸€ç§å¤„ç†æ•°æ®çš„æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯å½“ä½ ä¸éœ€è¦ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä½ è¦å–ä¸€æ¯æ°´ï¼Œä½ å¯ä»¥é€‰æ‹©ä¸€å£æ°”æŠŠæ•´æ¯æ°´å–å®Œï¼ˆç±»ä¼¼äºä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜ï¼‰ï¼Œæˆ–è€…é€‰æ‹©ç”¨å¸ç®¡æ…¢æ…¢å–ï¼ˆç±»ä¼¼äºä½¿ç”¨æµï¼‰ã€‚ä½¿ç”¨æµçš„å¥½å¤„æ˜¯ï¼Œå®ƒå¯ä»¥å¸®åŠ©ä½ æ›´æœ‰æ•ˆåœ°ç®¡ç†å†…å­˜å’Œå¤„ç†å¤§é‡æ•°æ®ã€‚</p><p><strong>Web Streams API</strong> æä¾›äº†ä¸€å¥—æ ‡å‡†çš„ API æ¥åˆ›å»ºã€ç»„åˆå’Œæ¶ˆè´¹æµå¼æ•°æ®ã€‚åœ¨ Node.js ä¸­ï¼Œè¿™ä¸ª API å…è®¸ä½ ä»¥æµçš„æ–¹å¼å¤„ç†å„ç§æ•°æ®ï¼Œæ¯”å¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œè¯·æ±‚ç­‰ã€‚</p><p><code>readableByteStreamController.close()</code> æ˜¯ Web Streams API ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºå…³é—­ä¸€ä¸ªå¯è¯»å­—èŠ‚æµæ§åˆ¶å™¨ã€‚ç®€å•æ¥è¯´ï¼Œå½“ä½ å†³å®šä¸å†ä»ä¸€ä¸ªæ•°æ®æºï¼ˆå¦‚æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚ç­‰ï¼‰æ¥æ”¶æ•°æ®ï¼Œå¹¶ä¸”å·²ç»å¤„ç†å®Œå½“å‰ç¼“å†²åŒºå†…çš„æ‰€æœ‰æ•°æ®æ—¶ï¼Œä½ å¯ä»¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥å…³é—­æµã€‚</p><h3 id="å®é™…è¿ç”¨ä¾‹å­-8" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-8"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ä»ä¸€ä¸ªæ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œå¹¶ä¸”ä½ æƒ³æŒ‰ç…§ä¸€å®šçš„æ¡ä»¶ç»“æŸè¯»å–è¿‡ç¨‹ï¼Œæ¯”å¦‚ä½ æ‰¾åˆ°äº†ä½ å…³å¿ƒçš„ä¿¡æ¯æˆ–è€…è¾¾åˆ°äº†ç‰¹å®šçš„æ•°æ®é‡é™åˆ¶ï¼Œè¿™æ—¶ä½ å°±å¯ä»¥ä½¿ç”¨ <code>readableByteStreamController.close()</code> æ¥åœæ­¢è¯»å–è¿›ç¨‹ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> processFile</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">filename</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> condition</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">filename</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipeTo</span><span style="color:#D8DEE9FF;">(</span></span>
<span class="line"><span style="color:#81A1C1;">    new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">      start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">        // å½“å¼€å§‹è¯»å–æ–‡ä»¶æ—¶ï¼Œæ‰§è¡Œçš„ä»£ç </span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#88C0D0;">      pull</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">        // æ¯æ¬¡ä»æ–‡ä»¶ä¸­æ‹‰å–æ•°æ®æ—¶ï¼Œæ‰§è¡Œçš„ä»£ç </span></span>
<span class="line"><span style="color:#81A1C1;">        if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">condition</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">          // å¦‚æœæ»¡è¶³æŸä¸ªæ¡ä»¶ï¼Œæ¯”å¦‚å·²ç»è¯»å–åˆ°äº†æœŸæœ›çš„æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9;">          controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // åˆ™å…³é—­æµ</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#88C0D0;">      close</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">        // å½“æµè¢«å…³é—­æ—¶ï¼Œæ‰§è¡Œçš„ä»£ç </span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#88C0D0;">      cancel</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">        // å½“è¯»å–æ“ä½œè¢«å–æ¶ˆæ—¶ï¼Œæ‰§è¡Œçš„ä»£ç </span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  )</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  for</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;"> of</span><span style="color:#D8DEE9;"> reader</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">    // å¤„ç†æ¯ä¸€å—æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">processFile</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#616E88;"> /* ä½ çš„æ¡ä»¶ */</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡æ£€æŸ¥æŸä¸ªæ¡ä»¶ï¼ˆè¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œç”¨ <code>condition</code> è¡¨ç¤ºï¼‰æ¥å†³å®šæ˜¯å¦ç»§ç»­è¯»å–æ–‡ä»¶ã€‚å¦‚æœä¸å†éœ€è¦è¯»å–æ›´å¤šæ•°æ®ï¼Œæˆ‘ä»¬å°±è°ƒç”¨ <code>controller.close()</code> æ¥å…³é—­æµã€‚</p><p>è¿™ä¸ªæ–¹æ³•çš„ä¸€ä¸ªå¸¸è§ç”¨é€”æ˜¯å¤„ç† HTTP è¯·æ±‚ã€‚å½“ä½ ä»ç½‘ç»œè¯·æ±‚ä¸­è¯»å–æ•°æ®ï¼Œå¹¶ä¸”å·²ç»è·å–äº†ä½ éœ€è¦çš„å…¨éƒ¨æ•°æ®æ—¶ï¼Œå¯ä»¥è°ƒç”¨æ­¤æ–¹æ³•æ¥å…³é—­è¯·æ±‚çš„æ•°æ®æµï¼Œé¿å…ä¸å¿…è¦çš„èµ„æºæ¶ˆè€—ã€‚</p><p>å¸Œæœ›è¿™èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£ <code>readableByteStreamController.close()</code> å’Œå®ƒçš„åº”ç”¨åœºæ™¯ï¼</p><h4 id="readablebytestreamcontroller-desiredsize" tabindex="-1"><a class="header-anchor" href="#readablebytestreamcontroller-desiredsize"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablebytestreamcontrollerdesiredsize" target="_blank" rel="noopener noreferrer">readableByteStreamController.desiredSize</a></span></a></h4><p>Node.js ä¸­çš„<code>readableByteStreamController.desiredSize</code>æ˜¯ä¸€ä¸ªä¸ Web Streams API ç›¸å…³çš„æ¦‚å¿µï¼Œä¸»è¦ç”¨äºç®¡ç†æ•°æ®æµï¼ˆStreamï¼‰çš„è¯»å–ã€‚ä¸ºäº†è®©è¿™ä¸ªæ¦‚å¿µæ›´å®¹æ˜“ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒæ¯”ä½œä¸€ä¸ªæ°´æ¡¶é‡Œçš„æ°´æµæ§åˆ¶ç³»ç»Ÿã€‚æƒ³è±¡ä¸€ä¸‹ä½ æœ‰ä¸€ä¸ªæ°´æ¡¶ï¼ˆStreamï¼‰ï¼Œè€Œè¿™ä¸ªâ€œdesiredSizeâ€å°±åƒæ˜¯ä½ å¸Œæœ›ä¿æŒåœ¨æ°´æ¡¶é‡Œçš„æ°´ä½ã€‚å¦‚æœæ°´å°‘äº†ï¼Œå°±æ„å‘³ç€å¯ä»¥åŠ æ›´å¤šçš„æ°´è¿›å»ï¼›å¦‚æœæ°´è¾¾åˆ°æˆ–è¶…è¿‡äº†è¿™ä¸ªæ°´ä½ï¼Œé‚£å°±æ„å‘³ç€ä¸éœ€è¦å†å¾€é‡Œé¢åŠ æ°´äº†ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯readablebytestreamcontroller" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯readablebytestreamcontroller"><span>ä»€ä¹ˆæ˜¯<code>readableByteStreamController</code>ï¼Ÿ</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œå½“æˆ‘ä»¬è°ˆè®º Web Streams API æ—¶ï¼Œé€šå¸¸æ˜¯æŒ‡å¤„ç†æ•°æ®æµçš„ä¸€ç§æ–¹å¼ã€‚æ•°æ®æµå¯ä»¥æ˜¯æ–‡ä»¶çš„å†…å®¹ã€ç½‘ç»œè¯·æ±‚çš„å“åº”ä½“ç­‰ã€‚<code>readableByteStreamController</code>æ˜¯ç”¨äºç®¡ç†å­—èŠ‚æµï¼ˆbyte streamï¼‰ç±»å‹çš„ ReadableStreamï¼ˆå¯è¯»æµï¼‰çš„ä¸€ä¸ªå¯¹è±¡ã€‚å®ƒæä¾›äº†å‡ ç§æ–¹æ³•å’Œå±æ€§æ¥æ§åˆ¶æµçš„çŠ¶æ€å’Œè¡Œä¸ºã€‚</p><h3 id="desiredsizeçš„ä½œç”¨" tabindex="-1"><a class="header-anchor" href="#desiredsizeçš„ä½œç”¨"><span><code>desiredSize</code>çš„ä½œç”¨</span></a></h3><p><code>desiredSize</code>æ˜¯<code>readableByteStreamController</code>çš„ä¸€ä¸ªå±æ€§ï¼Œå®ƒè¡¨ç¤ºå½“å‰æµä¸­è¿˜èƒ½æ¥å—å¤šå°‘å­—èŠ‚çš„æ•°æ®ï¼Œä»¥è¾¾åˆ°å…¶ç†æƒ³çš„ç¼“å†²å¤§å°ï¼ˆæ°´ä½ï¼‰ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒå°±æ˜¯å‘Šè¯‰ä½ è¿˜èƒ½å¾€è¿™ä¸ªæµé‡Œâ€œæ·»åŠ â€å¤šå°‘æ•°æ®è€Œä¸ä¼šå¯¼è‡´â€œæº¢å‡ºâ€ã€‚</p><ul><li><strong>å¦‚æœ<code>desiredSize</code>æ˜¯æ­£æ•°</strong>ï¼šè¡¨ç¤ºè¿˜å¯ä»¥ç»§ç»­å¾€æµä¸­æ·»åŠ æ•°æ®ï¼Œå…·ä½“çš„æ•°å­—ä»£è¡¨äº†å¯ä»¥æ·»åŠ çš„æœ€å¤§å­—èŠ‚æ•°ã€‚</li><li><strong>å¦‚æœ<code>desiredSize</code>æ˜¯ null</strong>ï¼šè¡¨ç¤ºæµå·²ç»å…³é—­äº†ï¼Œä¸èƒ½å†å‘å…¶ä¸­æ·»åŠ æ•°æ®ã€‚</li><li><strong>å¦‚æœ<code>desiredSize</code>æ˜¯è´Ÿæ•°</strong>ï¼šè¿™ç§æƒ…å†µé€šå¸¸æ„å‘³ç€æµä¸­çš„æ•°æ®ç§¯ç´¯å¾—æ¯”æœŸæœ›çš„å¤šï¼Œæ¶ˆè´¹è€…ï¼ˆè¯»å–æ•°æ®çš„ä»£ç éƒ¨åˆ†ï¼‰å¯èƒ½éœ€è¦åŠ é€Ÿå¤„ç†æµä¸­çš„æ•°æ®ã€‚</li></ul><h3 id="å®é™…è¿ç”¨ä¾‹å­-9" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-9"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><ol><li><p><strong>æ–‡ä»¶è¯»å–</strong>ï¼šå‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js ç¨‹åºæ¥è¯»å–ä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œå¹¶é€æ­¥å¤„ç†æ–‡ä»¶å†…å®¹ã€‚ä½¿ç”¨ Streams API å¯ä»¥æœ‰æ•ˆåœ°åšåˆ°è¿™ä¸€ç‚¹ã€‚é€šè¿‡æ£€æŸ¥<code>desiredSize</code>ï¼Œä½ å¯ä»¥æ™ºèƒ½åœ°æ§åˆ¶ä½•æ—¶åœæ­¢ä»æ–‡ä»¶ä¸­è¯»å–æ›´å¤šå†…å®¹ï¼Œä»¥é¿å…å†…å­˜ä½¿ç”¨è¿‡å¤šã€‚</p></li><li><p><strong>ç½‘ç»œè¯·æ±‚å¤„ç†</strong>ï¼šå½“ä½ çš„æœåŠ¡å™¨æ¥æ”¶åˆ°ä¸€ä¸ªå¤§çš„ä¸Šä¼ è¯·æ±‚æ—¶ï¼ˆä¾‹å¦‚ä¸Šä¼ è§†é¢‘ï¼‰ï¼Œä½¿ç”¨ Streams API æ¥å¤„ç†ä¸Šä¼ çš„æ•°æ®å¯ä»¥è®©ä½ æ›´é«˜æ•ˆåœ°ç®¡ç†å†…å­˜ä½¿ç”¨ã€‚é€šè¿‡<code>desiredSize</code>ï¼Œä½ çš„ç¨‹åºå¯ä»¥æ ¹æ®å½“å‰æµçš„æ‰¿è½½èƒ½åŠ›æ¥è°ƒæ•´æ¥æ”¶æ•°æ®çš„é€Ÿåº¦ï¼Œé¿å…æœåŠ¡å™¨å› ä¸ºä¸€æ¬¡æ€§å¤„ç†å¤ªå¤šæ•°æ®è€Œå˜å¾—ä¸ç¨³å®šã€‚</p></li><li><p><strong>å®æ—¶æ•°æ®å¤„ç†</strong>ï¼šä¾‹å¦‚ï¼Œåœ¨å¤„ç†å®æ—¶è§†é¢‘æµæˆ–æ•°æ®åˆ†æçš„åœºæ™¯ä¸­ï¼Œ<code>desiredSize</code>å¯ä»¥å¸®åŠ©ä½ çš„ç¨‹åºåŠ¨æ€è°ƒæ•´æ•°æ®å¤„ç†çš„é€Ÿç‡ï¼Œç¡®ä¿æ—¢ä¸ä¼šä¸¢å¤±é‡è¦æ•°æ®ï¼Œä¹Ÿä¸ä¼šå› ä¸ºå¤„ç†è¿‡è½½è€Œé€ æˆå»¶è¿Ÿã€‚</p></li></ol><p>é€šè¿‡è¿™äº›ä¾‹å­ï¼Œä½ å¯ä»¥çœ‹åˆ°<code>readableByteStreamController.desiredSize</code>æ˜¯å¦‚ä½•åœ¨å„ç§æ•°æ®æµç®¡ç†åœºæ™¯ä¸­å‘æŒ¥ä½œç”¨çš„ã€‚å®ƒåŸºæœ¬ä¸Šå¸®åŠ©å¼€å‘è€…æ§åˆ¶æ•°æ®æµçš„é€Ÿç‡å’Œå¤§å°ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ•ˆç‡å’Œæ€§èƒ½ã€‚</p><h4 id="readablebytestreamcontroller-enqueue-chunk" tabindex="-1"><a class="header-anchor" href="#readablebytestreamcontroller-enqueue-chunk"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablebytestreamcontrollerenqueuechunk" target="_blank" rel="noopener noreferrer">readableByteStreamController.enqueue(chunk)</a></span></a></h4><p><code>readableByteStreamController.enqueue(chunk)</code> æ˜¯åœ¨ Node.js ä¸­å¤„ç†æµ(Streams)æ—¶ä½¿ç”¨çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½ ä¸ Web Streams API æ‰“äº¤é“æ—¶ã€‚ç†è§£è¿™ä¸ªæ¦‚å¿µä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ˜ç™½å‡ ä¸ªå…³é”®ç‚¹ï¼šStreamsã€ReadableStreamã€ä»¥åŠ ReadableByteStreamControllerã€‚</p><h3 id="åŸºç¡€æ¦‚å¿µ-3" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ-3"><span>åŸºç¡€æ¦‚å¿µ</span></a></h3><ul><li><p><strong>Streamsï¼ˆæµï¼‰</strong>ï¼šåœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯ä¸€ç§æŠ½è±¡çš„æ•°æ®ç»“æ„ï¼Œç”¨äºæŒ‰é¡ºåºè¯»å–æˆ–å†™å…¥æ•°æ®ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆæ°´æµï¼Œæ•°æ®å°±åƒæ°´ä¸€æ ·ä»ä¸€ä¸ªåœ°æ–¹æµå‘å¦ä¸€ä¸ªåœ°æ–¹ã€‚</p></li><li><p><strong>ReadableStream</strong>ï¼šè¿™æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œä¸“é—¨ç”¨äºè¯»å–æ•°æ®ã€‚å®ƒå¯ä»¥ç”¨æ¥è¡¨ç¤ºå„ç§æ•°æ®æºï¼Œæ¯”å¦‚æ–‡ä»¶å†…å®¹ã€ç½‘ç»œå“åº”ç­‰ã€‚</p></li><li><p><strong>ReadableByteStreamController</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªæ§åˆ¶å™¨å¯¹è±¡ï¼Œç”¨äºç®¡ç†å’Œæ§åˆ¶ä¸€ä¸ªå¯è¯»å­—èŠ‚æµ(ReadableStream)çš„çŠ¶æ€å’Œå†…å®¹ã€‚é€šè¿‡è¿™ä¸ªæ§åˆ¶å™¨ï¼Œä½ å¯ä»¥å‘æµä¸­æ·»åŠ æ•°æ®å—(chunk)ï¼Œæˆ–è€…æ ‡è®°æµçš„ç»“æŸã€‚</p></li></ul><h3 id="readablebytestreamcontroller-enqueue-chunk-1" tabindex="-1"><a class="header-anchor" href="#readablebytestreamcontroller-enqueue-chunk-1"><span><code>readableByteStreamController.enqueue(chunk)</code></span></a></h3><p>å½“ä½ åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ ReadableStream æ—¶ï¼Œä½ ä¼šæä¾›ä¸€ä¸ª startã€pull å’Œ cancel å‡½æ•°ã€‚åœ¨è¿™äº›å‡½æ•°é‡Œï¼Œä½ å¯èƒ½ä¼šéœ€è¦å‘æµä¸­æ·»åŠ ä¸€äº›æ•°æ®ã€‚è¿™å°±æ˜¯ <code>enqueue()</code> æ–¹æ³•å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚</p><ul><li><strong>å‚æ•°</strong>ï¼š <ul><li><code>chunk</code>ï¼šè¿™æ˜¯ä½ æƒ³è¦æ·»åŠ åˆ°æµä¸­çš„æ•°æ®å—ã€‚åœ¨ä¸€ä¸ªå­—èŠ‚æµä¸­ï¼Œè¿™é€šå¸¸æ˜¯ä¸€ä¸ª <code>Uint8Array</code>ï¼Œå³ä¸€ä¸ª 8 ä½æ— ç¬¦å·æ•´å‹æ•°ç»„ï¼Œç”¨äºè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ã€‚</li></ul></li></ul><h3 id="åº”ç”¨ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨ä¾‹å­"><span>åº”ç”¨ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨æ„å»ºä¸€ä¸ªæœåŠ¡ï¼Œéœ€è¦å°†ä¸€ä¸ªå¤§æ–‡ä»¶åˆ†æ‰¹æ¬¡åœ°å‘é€åˆ°å®¢æˆ·ç«¯ã€‚è€Œä¸æ˜¯ä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ–‡ä»¶åˆ°å†…å­˜ä¸­ï¼ˆè¿™å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨ ReadableStream åˆ†æ®µè¯»å–å¹¶å‘é€æ–‡ä»¶ã€‚</p><ol><li><p><strong>åˆ›å»ºè‡ªå®šä¹‰æµ</strong> - ä½ é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ª <code>ReadableStream</code>ï¼Œä½¿ç”¨ <code>ReadableByteStreamController</code> æ§åˆ¶æ•°æ®çš„æµåŠ¨ã€‚</p></li><li><p><strong>åˆ†æ‰¹è¯»å–æ–‡ä»¶</strong> - åœ¨æ¯æ¬¡ <code>pull</code> è°ƒç”¨æ—¶ï¼ˆè¿™æ„å‘³ç€æ¶ˆè´¹è€…ç«¯å‡†å¤‡å¥½æ¥æ”¶æ›´å¤šæ•°æ®äº†ï¼‰ï¼Œä½ å¯ä»¥ä»æ–‡ä»¶ä¸­è¯»å–ä¸€å—æ•°æ®ï¼Œå¹¶ä½¿ç”¨ <code>enqueue(chunk)</code> å°†è¿™å—æ•°æ®åŠ å…¥åˆ°æµä¸­ã€‚</p></li><li><p><strong>ç»“æŸæµ</strong> - å½“æ–‡ä»¶å·²å®Œå…¨è¯»å–æ—¶ï¼Œä½ å¯ä»¥è°ƒç”¨ <code>controller.close()</code> æ¥æ ‡è®°æµçš„ç»“æŸã€‚</p></li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> streamFile</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">filePath</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">filePath</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    async</span><span style="color:#88C0D0;"> start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">      for</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;"> of</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">        // å½“æœ‰æ–°çš„æ•°æ®å—å¯ç”¨æ—¶ï¼Œå°†å…¶åŠ å…¥åˆ°æµä¸­</span></span>
<span class="line"><span style="color:#D8DEE9;">        controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> Uint8Array</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#616E88;">      // æ–‡ä»¶è¯»å–å®Œæˆï¼Œå…³é—­æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">      controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  return</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ç°åœ¨ä½ å¯ä»¥ä½¿ç”¨ streamFile æ¥å¤„ç†æ–‡ä»¶ï¼Œ</span></span>
<span class="line"><span style="color:#616E88;">// ä¾‹å¦‚ streaming å®ƒåˆ° HTTP å“åº”ä¸­ã€‚</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¾‹å­ç®€å•å±•ç¤ºäº†å¦‚ä½•å°†æ–‡ä»¶çš„å†…å®¹ä»¥æµçš„å½¢å¼å¤„ç†ï¼Œå…è®¸ä½ é«˜æ•ˆä¸”çµæ´»åœ°ç®¡ç†æ•°æ®ä¼ è¾“ã€‚</p><h4 id="readablebytestreamcontroller-error-error" tabindex="-1"><a class="header-anchor" href="#readablebytestreamcontroller-error-error"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablebytestreamcontrollererrorerror" target="_blank" rel="noopener noreferrer">readableByteStreamController.error([error])</a></span></a></h4><p>é¦–å…ˆï¼Œä¸ºäº†ç†è§£<code>readableByteStreamController.error([error])</code>ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š</p><ol><li><strong>Node.js</strong>: ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œæ—¶ï¼Œå¯ä»¥è®©ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚</li><li><strong>Streams in Node.js</strong>: åœ¨ Node.js ä¸­ï¼Œæµ(Streams)æ˜¯å¤„ç†è¯»å†™æ–‡ä»¶ã€ç½‘ç»œé€šä¿¡ç­‰ I/O æ“ä½œçš„ä¸€ç§æ–¹å¼ã€‚å®ƒå…è®¸æ•°æ®è¢«é€å—å¤„ç†ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ•°æ®åˆ°å†…å­˜ä¸­ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœå†…å­˜ï¼Œæé«˜åº”ç”¨æ€§èƒ½ã€‚</li><li><strong>ReadableByteStreamController</strong>: æ˜¯ Web Streams API çš„ä¸€éƒ¨åˆ†, å®ƒä¸»è¦ç”¨äºæ§åˆ¶ä¸€ä¸ª<code>ReadableStream</code>(å¯è¯»æµ)çš„çŠ¶æ€å’Œè¡Œä¸ºã€‚å…·ä½“åˆ°å­—èŠ‚æµï¼ˆbyte streamsï¼‰ï¼Œå®ƒå¸®åŠ©ç®¡ç†ä¼ è¾“å­—èŠ‚æ•°æ®çš„è¿‡ç¨‹ã€‚</li></ol><p>å½“æˆ‘ä»¬è°ˆè®º<code>readableByteStreamController.error([error])</code>æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯åœ¨è®¨è®ºå¦‚ä½•é€šè¿‡æ­¤æ–¹æ³•æ¥å¤„ç†æŸä¸ªæ•°æ®æµä¸­å‡ºç°çš„é”™è¯¯ã€‚è¯¥æ–¹æ³•å…è®¸ä½ æ‰‹åŠ¨åœ°æ ‡è®°æµçŠ¶æ€ä¸º&quot;é”™è¯¯&quot;ï¼Œå¹¶å¯é€‰åœ°ä¼ é€’ä¸€ä¸ªé”™è¯¯å¯¹è±¡ä½œä¸ºå‚æ•°ã€‚</p><h3 id="ä½¿ç”¨åœºæ™¯åŠç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯åŠç¤ºä¾‹"><span>ä½¿ç”¨åœºæ™¯åŠç¤ºä¾‹</span></a></h3><p>æƒ³è±¡ä½ æ­£åœ¨ä»ä¸€ä¸ªæ–‡ä»¶ä¸­è¯»å–æ•°æ®æˆ–è€…ä»ç½‘ç»œè¯·æ±‚æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªæµæ¥è¿›è¡Œçš„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœåœ¨æ•°æ®å¤„ç†è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼ˆæ¯”å¦‚æ–‡ä»¶æŸåæˆ–ç½‘ç»œé—®é¢˜ï¼‰ï¼Œä½ å¯èƒ½ä¼šæƒ³è¦ç«‹å³åœæ­¢è¯»å–æµï¼Œå¹¶å‘ŠçŸ¥æµçš„æ¶ˆè´¹è€…ï¼ˆä¹Ÿå°±æ˜¯æ¥æ”¶æ•°æ®çš„é‚£éƒ¨åˆ†ä»£ç ï¼‰å‘ç”Ÿäº†é”™è¯¯ã€‚</p><p>è¿™é‡Œä¸¾ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­æ¥è¯´æ˜å¦‚ä½•ä½¿ç”¨<code>readableByteStreamController.error([error])</code>ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå‡½æ•°æ¥è·å–ä¸€äº›æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> fetchData</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">    start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">      fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">response</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">          if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">ok</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">            // å½“ç½‘ç»œè¯·æ±‚å¤±è´¥æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†é”™è¯¯ä¼ é€’ç»™æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">            controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> Error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ç½‘ç»œè¯·æ±‚å¤±è´¥</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            return;</span></span>
<span class="line"><span style="color:#ECEFF4;">          }</span></span>
<span class="line"><span style="color:#D8DEE9;">          response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span></span>
<span class="line"><span style="color:#ECEFF4;">            .</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span></span>
<span class="line"><span style="color:#ECEFF4;">            .</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span></span>
<span class="line"><span style="color:#ECEFF4;">            .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">({</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> })</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">              if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">                controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">              }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">                controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">              }</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">            .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">              // å¤„ç†è¯»å–è¿‡ç¨‹ä¸­çš„é”™è¯¯</span></span>
<span class="line"><span style="color:#D8DEE9;">              controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">          // å¤„ç†fetchè¿‡ç¨‹ä¸­çš„é”™è¯¯</span></span>
<span class="line"><span style="color:#D8DEE9;">          controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  return</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥è·å–æ•°æ®</span></span>
<span class="line"><span style="color:#88C0D0;">fetchData</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://example.com/data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // è¿™é‡Œå¤„ç†æµæ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æµå¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">message</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°è¯•ä»ä¸€ä¸ª URL è·å–æ•°æ®ï¼Œå¹¶é€šè¿‡æµçš„å½¢å¼å¤„ç†è¿™äº›æ•°æ®ã€‚å¦‚æœåœ¨è¯·æ±‚è¿‡ç¨‹ä¸­å‘ç°äº†é—®é¢˜ï¼ˆå¦‚ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼‰ï¼Œæˆ‘ä»¬å°±è°ƒç”¨<code>controller.error()</code>æ¥é€šçŸ¥æµçš„æ¶ˆè´¹è€…å‡ºç°äº†é”™è¯¯ã€‚åŒæ ·çš„ï¼Œå¦‚æœåœ¨æ•°æ®çš„è¯»å–è¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯ï¼Œæˆ‘ä»¬ä¹Ÿä½¿ç”¨ç›¸åŒçš„æ–¹æ³•æ¥æ ‡è®°é”™è¯¯ã€‚</p><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬èƒ½å¤Ÿä¼˜é›…åœ°å¤„ç†å¼‚æ­¥æ•°æ®æµä¸­å¯èƒ½å‡ºç°çš„å„ç§é—®é¢˜ï¼Œå¹¶ä¿è¯æˆ‘ä»¬çš„åº”ç”¨åœ¨é¢å¯¹å¼‚å¸¸æƒ…å†µæ—¶èƒ½å¤Ÿåšå‡ºæ­£ç¡®çš„å“åº”ã€‚</p><h3 id="class-readablestreambyobrequest" tabindex="-1"><a class="header-anchor" href="#class-readablestreambyobrequest"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-readablestreambyobrequest" target="_blank" rel="noopener noreferrer">Class: ReadableStreamBYOBRequest</a></span></a></h3><p>ç†è§£ <code>ReadableStreamBYOBRequest</code> ï¼ˆBring Your Own Bufferï¼‰é¦–å…ˆéœ€è¦äº†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š</p><ol><li><strong>Stream</strong>ï¼šåœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯ä¸€ç³»åˆ—çš„æ•°æ®å…ƒç´ ï¼Œè¿™äº›å…ƒç´ å¯ä»¥ä½œä¸ºä¸€ä¸ªè¿ç»­åºåˆ—è®¿é—®ã€‚æƒ³è±¡æˆæ°´æµï¼Œæ•°æ®åƒæ°´ä¸€æ ·ä»ä¸€ç‚¹æµå‘å¦ä¸€ç‚¹ã€‚</li><li><strong>Readable Stream</strong>ï¼šç‰¹æŒ‡é‚£ç§ç”¨äºè¯»å–æ•°æ®çš„æµã€‚æ¯”å¦‚ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œæˆ–è€…ä»ç½‘ç»œæ¥æ”¶æ•°æ®ã€‚</li></ol><p>ç°åœ¨ï¼Œå½“æˆ‘ä»¬æ·±å…¥åˆ° Node.js çš„ <code>ReadableStreamBYOBRequest</code> çš„è¯é¢˜æ—¶ï¼Œæˆ‘ä»¬æ­£åœ¨æ¢è®¨ä¸€ä¸ªæ›´é«˜çº§å’Œç‰¹å®šåœºæ™¯ä¸‹çš„åŠŸèƒ½ã€‚</p><h3 id="readablestreambyobrequest" tabindex="-1"><a class="header-anchor" href="#readablestreambyobrequest"><span>ReadableStreamBYOBRequest</span></a></h3><p><code>ReadableStreamBYOBRequest</code> æ˜¯å…³è”äº Web Streams API çš„ä¸€ä¸ªç±»ï¼Œç”¨äºæ”¯æŒâ€œå¸¦ä½ è‡ªå·±çš„ç¼“å†²åŒºï¼ˆBring Your Own Bufferï¼‰â€çš„è¯»å–æ“ä½œã€‚è¿™åŸºæœ¬ä¸Šæ„å‘³ç€ï¼Œä½ å¯ä»¥æä¾›ä¸€ä¸ªè‡ªå·±çš„ Buffer (ä¸€ä¸ªå­˜å‚¨äºŒè¿›åˆ¶æ•°æ®çš„å®¹å™¨)ç»™æµï¼Œè®©æ•°æ®ç›´æ¥è¢«å¡«å……è‡³è¯¥ç¼“å†²åŒºä¸­ï¼Œè€Œä¸æ˜¯ç”±æµè‡ªåŠ¨åˆ›å»ºæ–°çš„ç¼“å†²åŒºã€‚è¿™ç§æ–¹å¼å¯ä»¥å‡å°‘å†…å­˜ä½¿ç”¨ï¼Œå¹¶ä¸”æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒå‡å°‘äº†ä¸å¿…è¦çš„å†…å­˜åˆ†é…å’Œå¤åˆ¶æ“ä½œã€‚</p><h4 id="ä¸ºä»€ä¹ˆéœ€è¦-byob" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆéœ€è¦-byob"><span>ä¸ºä»€ä¹ˆéœ€è¦ BYOB?</span></a></h4><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œåº”ç”¨å¯èƒ½å·²ç»æœ‰äº†ä¸€å—ç”¨äºå…¶ä»–ç›®çš„çš„å†…å­˜ç©ºé—´ï¼Œæˆ–è€…å‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œæƒ³è¦æ§åˆ¶å†…å­˜çš„åˆ†é…ã€‚é€šè¿‡å…è®¸å¼€å‘è€…æä¾›è‡ªå·±çš„ç¼“å†²åŒºï¼ˆbufferï¼‰ï¼ŒNode.js å¯ä»¥å°†æ•°æ®ç›´æ¥å†™å…¥è¿™ä¸ªé¢„å…ˆå­˜åœ¨çš„ç¼“å†²åŒºé‡Œï¼Œè€Œé¿å…é¢å¤–çš„å†…å­˜åˆ†é…å’Œæ•°æ®å¤åˆ¶æ“ä½œï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚</p><h4 id="å®é™…ä¾‹å­-4" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-4"><span>å®é™…ä¾‹å­</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨å®ç°ä¸€ä¸ªç½‘ç»œæœåŠ¡å™¨ï¼Œéœ€è¦å¤„ç†å¤§é‡çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œæ¯”å¦‚å›¾ç‰‡æˆ–è§†é¢‘æµã€‚å¯¹äºæ¯ä¸ªä¼ å…¥çš„è¯·æ±‚ï¼Œå¦‚æœä½ èƒ½å¤Ÿé‡å¤ä½¿ç”¨åŒä¸€å—ç¼“å†²åŒºæ¥æ¥æ”¶æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªè¯·æ±‚éƒ½åˆ›å»ºæ–°çš„ç¼“å†²åŒºï¼Œé‚£ä¹ˆå°±èƒ½æ˜¾è‘—å‡å°‘æœåŠ¡å™¨çš„å†…å­˜å ç”¨å’Œæé«˜å¤„ç†é€Ÿåº¦ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> processVideo</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">request</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> request</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡è®¾è¿™æ˜¯ä¸€ä¸ªå¯è¯»çš„æµï¼ŒåŒ…å«è§†é¢‘æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> mode</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">byob</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">    // ä¸ºè§†é¢‘å¤„ç†é¢„ç•™ä¸€å—ç¼“å†²åŒº</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> Uint8Array</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 1MB çš„ buffer</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">break;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // å¤„ç† &#39;value&#39; ä¸­çš„è§†é¢‘æ•°æ®...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // å‡è®¾è¿™é‡Œæˆ‘ä»¬ç®€å•åœ°æŠŠæ•°æ®å‘é€ç»™å®¢æˆ·ç«¯</span></span>
<span class="line"><span style="color:#D8DEE9;">    response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">  response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå¤„ç†è§†é¢‘æµçš„å‡½æ•°ã€‚æˆ‘ä»¬åˆ©ç”¨ <code>reader.read()</code> æ–¹æ³•å¹¶ä¼ å…¥ä¸€ä¸ªè‡ªå·±çš„ <code>Uint8Array</code> ç¼“å†²åŒºã€‚è¿™æ ·ï¼Œæ¯æ¬¡è¯»å–æ“ä½œéƒ½ä¼šå°†æ•°æ®å¡«å……åˆ°è¿™ä¸ªç¼“å†²åŒºä¸­ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„ç¼“å†²åŒºã€‚è¿™ä¸ªæ¨¡å¼ï¼ˆBYOBï¼‰æœ‰æ•ˆåœ°å‡å°äº†å†…å­˜è´Ÿæ‹…ï¼Œå¹¶æé«˜äº†å¤„ç†é€Ÿåº¦ã€‚</p><h3 id="ç»“è®º-1" tabindex="-1"><a class="header-anchor" href="#ç»“è®º-1"><span>ç»“è®º</span></a></h3><p><code>ReadableStreamBYOBRequest</code> ä»£è¡¨äº†ä¸€ä¸ªå…ˆè¿›çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œé€šè¿‡å…è®¸å¼€å‘è€…ä¸ºæ•°æ®è¯»å–æ“ä½œæä¾›è‡ªå·±çš„ç¼“å†²åŒºï¼Œå®ƒæœ‰åŠ©äºæé«˜åº”ç”¨ç¨‹åºå¤„ç†å¤§é‡æ•°æ®æ—¶çš„æ•ˆç‡å’Œæ€§èƒ½ã€‚å°½ç®¡è¿™å¯èƒ½åœ¨åˆå­¦é˜¶æ®µçœ‹èµ·æ¥æœ‰äº›å¤æ‚ï¼Œä½†æŒæ¡äº†è¿™ä¸ªæ¦‚å¿µä¹‹åï¼Œä½ å°†èƒ½å¤Ÿæ„å»ºæ›´åŠ é«˜æ•ˆå’Œå“åº”è¿…é€Ÿçš„ Node.js åº”ç”¨ã€‚</p><h4 id="readablestreambyobrequest-respond-byteswritten" tabindex="-1"><a class="header-anchor" href="#readablestreambyobrequest-respond-byteswritten"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreambyobrequestrespondbyteswritten" target="_blank" rel="noopener noreferrer">readableStreamBYOBRequest.respond(bytesWritten)</a></span></a></h4><p>å½“ç„¶ï¼Œæˆ‘æ¥è§£é‡Šä¸€ä¸‹ <code>readableStreamBYOBRequest.respond(bytesWritten)</code> è¿™ä¸ªæ–¹æ³•åœ¨ Node.js ä¸­çš„ä½œç”¨å’Œåº”ç”¨åœºæ™¯ï¼Œå°½é‡ç”¨é€šä¿—æ˜“æ‡‚çš„æ–¹å¼ã€‚</p><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬åˆ†è§£è¿™ä¸ªè¡¨è¾¾å¼æ¥æ›´å¥½åœ°ç†è§£å®ƒï¼š</p><ul><li><p><strong><code>readableStream</code></strong>ï¼šåœ¨ Node.js å’Œç°ä»£ Web å¼€å‘ä¸­ï¼Œæµ(stream)æ˜¯ä¸€ç§å¤„ç†æ•°æ®çš„æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯å½“ä½ ä¸éœ€è¦æˆ–ä¸èƒ½ä¸€æ¬¡æ€§å¤„ç†å…¨éƒ¨æ•°æ®æ—¶ã€‚æƒ³è±¡ä¸€ä¸‹æ°´æµé€šè¿‡ç®¡é“ï¼Œè€Œä½ å¯ä»¥é€æ¸åœ°æ¥æ”¶å’Œå¤„ç†è¿™äº›â€œæ•°æ®â€çš„æ°´æµã€‚ä¸€ä¸ªå¯è¯»æµï¼ˆ<code>readableStream</code>ï¼‰å°±æ˜¯è¿™æ ·ä¸€ç§æ•°æ®æºï¼Œä½ å¯ä»¥ä»ä¸­è¯»å–æ•°æ®ã€‚</p></li><li><p><strong><code>BYOBRequest</code></strong>ï¼šè¿™ä¸ªåå­—æ¥è‡ªâ€œBring Your Own Bufferâ€çš„ç¼©å†™ï¼Œæ„æ€æ˜¯â€œæä¾›ä½ è‡ªå·±çš„ç¼“å†²åŒºâ€ã€‚è¿™é‡Œçš„ç¼“å†²åŒºæŒ‡çš„æ˜¯ä¸€å—å†…å­˜ï¼Œç”¨äºä¸´æ—¶å­˜å‚¨ä»æµä¸­è¯»å–çš„æ•°æ®ã€‚</p></li><li><p><strong><code>respond(bytesWritten)</code></strong>ï¼šè¿™ä¸ªæ–¹æ³•å…è®¸ä½ å“åº”æµï¼Œå‘Šè¯‰æµâ€œæˆ‘å·²ç»å¤„ç†äº†å¤šå°‘å­—èŠ‚çš„æ•°æ®â€ã€‚</p></li></ul><p>ç»“åˆèµ·æ¥ï¼Œ<code>readableStreamBYOBRequest.respond(bytesWritten)</code> æ˜¯å½“ä½ ä½¿ç”¨è‡ªå·±æä¾›çš„ç¼“å†²åŒºï¼ˆbufferï¼‰ä»å¯è¯»æµä¸­è¯»å–æ•°æ®ï¼Œå¹¶å¤„ç†å®Œè¿™éƒ¨åˆ†æ•°æ®åï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ³•å‘Šè¯‰æµä½ å¤„ç†äº†å¤šå°‘å­—èŠ‚çš„æ•°æ®ã€‚è¿™å¯¹äºæ§åˆ¶å†…å­˜ä½¿ç”¨éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒè®©æµçŸ¥é“å¯ä»¥å›æ”¶æˆ–é‡ç”¨å·²ç»è¢«è¯»å–å¹¶å¤„ç†çš„ç¼“å†²åŒºéƒ¨åˆ†ã€‚</p><h3 id="å®é™…è¿ç”¨ä¾‹å­-10" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-10"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><p>æƒ³è±¡ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ç¨‹åºï¼Œè¿™ä¸ªåº”ç”¨éœ€è¦ä»ä¸€ä¸ªå¤§æ–‡ä»¶ï¼ˆæ¯”å¦‚ä¸€ä¸ªè§†é¢‘æ–‡ä»¶æˆ–å¤§å‹æ•°æ®é›†ï¼‰ä¸­è¯»å–æ•°æ®ã€‚ç”±äºæ–‡ä»¶å¾ˆå¤§ï¼Œä¸€æ¬¡æ€§è¯»å–æ•´ä¸ªæ–‡ä»¶åˆ°å†…å­˜ä¸­å¯èƒ½ä¼šè€—å°½ç³»ç»Ÿèµ„æºã€‚æ‰€ä»¥ï¼Œä½ å†³å®šä½¿ç”¨æµå’Œ BYOB çš„æ–¹å¼æ¥é«˜æ•ˆåœ°å¤„ç†æ–‡ä»¶ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯è¯»æµæ¥è¯»å–ä¸€ä¸ªå¤§æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/large/file</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">  highWaterMark</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#ECEFF4;">,</span><span style="color:#616E88;"> // æ¯æ¬¡è¯»1MB</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªBYOBRequestçš„å®ä¾‹ï¼Œç°åœ¨æˆ‘ä»¬è¦è¯»å–å¹¶å¤„ç†æ•°æ®</span></span>
<span class="line"><span style="color:#616E88;">// æ³¨æ„ï¼šè¿™é‡Œä»…ä¸ºå±•ç¤ºç›®çš„ï¼Œå®é™…ä»£ç ä¸­BYOBRequestçš„è·å–å¯èƒ½ä¸åŒ</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Buffer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">alloc</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // åˆ†é…ä¸€ä¸ª1MBçš„Bufferä½œä¸ºBYOB</span></span>
<span class="line"><span style="color:#D8DEE9;">readableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">readable</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  let</span><span style="color:#D8DEE9;"> bytesRead</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // å°è¯•è¯»å–æ•°æ®åˆ°æˆ‘ä»¬æä¾›çš„bufferä¸­</span></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">null</span><span style="color:#81A1C1;"> !==</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">bytesRead</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">buffer</span><span style="color:#D8DEE9FF;">))) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">    // å¤„ç†æ•°æ®...</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">å¤„ç†äº† </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">bytesRead</span><span style="color:#81A1C1;">}</span><span style="color:#A3BE8C;"> å­—èŠ‚çš„æ•°æ®</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // å‘Šè¯‰æµæˆ‘ä»¬å·²ç»å¤„ç†äº†å¤šå°‘å­—èŠ‚çš„æ•°æ®ï¼Œå…è®¸å®ƒé‡Šæ”¾æˆ–é‡ç”¨ç¼“å†²åŒº</span></span>
<span class="line"><span style="color:#616E88;">    // åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰ç›´æ¥æ“ä½œBYOBRequestå¯¹è±¡ï¼Œ</span></span>
<span class="line"><span style="color:#616E88;">    // ä½†åœ¨ä½¿ç”¨BYOBæ¨¡å¼è¿›è¡Œæµæ•°æ®è¯»å–æ—¶ï¼Œè°ƒç”¨respondæ–¹æ³•æ˜¯å¿…é¡»çš„æ­¥éª¤ã€‚</span></span>
<span class="line"><span style="color:#616E88;">    // myBYOBRequest.respond(bytesRead);</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå¯è¯»æµæ¥è¯»å–ä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªå›ºå®šå¤§å°çš„ç¼“å†²åŒºæ¥é€å—å¤„ç†æ–‡ä»¶ã€‚æ¯å¤„ç†å®Œä¸€å—æ•°æ®ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨ä¸€ä¸ªè™šæ„çš„ <code>myBYOBRequest.respond</code> æ–¹æ³•ï¼ˆåœ¨å®é™…æƒ…å†µä¸­ï¼Œä½ ä¼šæœ‰ä¸€ä¸ªå®é™…çš„ <code>BYOBRequest</code> å¯¹è±¡ï¼‰æ¥å‘Šè¯‰æµæˆ‘ä»¬å·²å¤„ç†äº†å¤šå°‘æ•°æ®ã€‚è¿™æ ·å¯ä»¥æœ‰æ•ˆç®¡ç†å†…å­˜ä½¿ç”¨ï¼ŒåŒæ—¶æé«˜åº”ç”¨çš„æ€§èƒ½ã€‚</p><p>å¸Œæœ›è¿™ä¸ªè§£é‡Šå’Œä¾‹å­èƒ½å¸®åŠ©ä½ ç†è§£ <code>readableStreamBYOBRequest.respond(bytesWritten)</code> åœ¨ Node.js ä¸­çš„ä½œç”¨ï¼</p><h4 id="readablestreambyobrequest-respondwithnewview-view" tabindex="-1"><a class="header-anchor" href="#readablestreambyobrequest-respondwithnewview-view"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreambyobrequestrespondwithnewviewview" target="_blank" rel="noopener noreferrer">readableStreamBYOBRequest.respondWithNewView(view)</a></span></a></h4><p>å½“ä½ æ·±å…¥ Node.js çš„ä¸–ç•Œï¼Œå°¤å…¶æ˜¯æ¶‰åŠåˆ°å¤„ç†æµæ•°æ®æ—¶ï¼ˆå¦‚è¯»å–æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚ç­‰ï¼‰ï¼Œä½ ä¼šé‡åˆ°ä¸€ä¸ªåä¸º<code>ReadableStreamBYOBRequest</code>çš„æ¦‚å¿µã€‚åœ¨ Node.js v21.7.1 ä¸­ï¼Œæœ‰ä¸€ä¸ªéå¸¸å…·ä½“è€Œåˆå¼ºå¤§çš„æ–¹æ³•ï¼š<code>respondWithNewView(view)</code>ã€‚æˆ‘ä»¬å°†ä¸€æ­¥ä¸€æ­¥è§£å¼€å®ƒçš„ç¥ç§˜é¢çº±ï¼Œå¹¶é€šè¿‡å®é™…ä¾‹å­åŠ ä»¥è¯´æ˜ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯-readablestreambyobrequest-respondwithnewview-view" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯-readablestreambyobrequest-respondwithnewview-view"><span>ä»€ä¹ˆæ˜¯ <code>ReadableStreamBYOBRequest.respondWithNewView(view)</code>?</span></a></h3><p>é¦–å…ˆï¼Œäº†è§£<code>ReadableStreamBYOBRequest</code>æ˜¯ä»€ä¹ˆå¾ˆé‡è¦ã€‚åœ¨å¤„ç†æµæ•°æ®æ—¶ï¼Œ<code>ReadableStream</code>ä»£è¡¨ä¸€ä¸ªå¯ä»¥æŒ‰é¡ºåºè¯»å–çš„æ•°æ®æºã€‚è€Œ&quot;BYOB&quot;åœ¨è¿™é‡ŒæŒ‡çš„æ˜¯â€œBring Your Own Bufferâ€ï¼Œæ„æ€æ˜¯è®©ä½ æä¾›è‡ªå·±çš„ç¼“å†²åŒº(buffer)æ¥æ¥æ”¶æ•°æ®ã€‚</p><p>åœ¨è¿™ä¸ªèƒŒæ™¯ä¸‹ï¼Œ<code>respondWithNewView(view)</code>æ–¹æ³•å°±æ˜¯ç”¨äºå“åº”ä¸€ä¸ªæ•°æ®è¯·æ±‚ï¼Œé€šè¿‡æŒ‡å®šä¸€ä¸ªæ–°çš„ TypedArray è§†å›¾(view)æ¥å¡«å……æ•°æ®ã€‚è¿™ä¸ªè§†å›¾ç›´æ¥æ˜ å°„åˆ°ä½ æä¾›çš„ Buffer ä¸Šï¼Œä½¿å¾—æ•°æ®å¯ä»¥è¢«é«˜æ•ˆåœ°è¯»å–å¹¶å¤„ç†ã€‚</p><h3 id="å‚æ•°è§£é‡Š-1" tabindex="-1"><a class="header-anchor" href="#å‚æ•°è§£é‡Š-1"><span>å‚æ•°è§£é‡Š</span></a></h3><ul><li><code>view</code>: è¿™æ˜¯ä¸€ä¸ª TypedArrayï¼ˆå¦‚ Uint8Array, Float32Array ç­‰ï¼‰çš„å®ä¾‹ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªè§†å›¾æ¥æ“ä½œåº•å±‚çš„äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒº(Buffer)ã€‚</li></ul><h3 id="å®é™…è¿ç”¨ä¾‹å­-11" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-11"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js ç¨‹åºï¼Œè¯¥ç¨‹åºéœ€è¦ä»æ–‡ä»¶ç³»ç»Ÿè¯»å–ä¸€ä¸ªå¤§å‹äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶å¯¹å…¶å†…å®¹è¿›è¡Œä¸€äº›è½¬æ¢å¤„ç†ï¼Œç„¶åå†å°†ç»“æœä¼ è¾“å‡ºå»ã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨<code>ReadableStreamBYOBRequest.respondWithNewView(view)</code>æ–¹æ³•çš„ç®€åŒ–ç¤ºä¾‹ï¼š</p><h4 id="æ­¥éª¤-1-åˆ›å»ºå¯è¯»æµ-1" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-1-åˆ›å»ºå¯è¯»æµ-1"><span>æ­¥éª¤ 1: åˆ›å»ºå¯è¯»æµ</span></a></h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå¯è¯»æµæ¥ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/your/large/file.bin</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ­¥éª¤-2-å¤„ç†æµæ•°æ®" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-2-å¤„ç†æµæ•°æ®"><span>æ­¥éª¤ 2: å¤„ç†æµæ•°æ®</span></a></h4><p>å½“æˆ‘ä»¬è¯»å–æµæ•°æ®æ—¶ï¼Œä½¿ç”¨<code>respondWithNewView(view)</code>æ–¹æ³•æ¥å¤„ç†è¿™äº›æ•°æ®ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">readable</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  let</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">  // å‡è®¾æˆ‘ä»¬æœŸæœ›æ¯æ¬¡è¯»å–1024å­—èŠ‚</span></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">null</span><span style="color:#81A1C1;"> !==</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">1024</span><span style="color:#D8DEE9FF;">))) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">    // å‡è®¾æˆ‘ä»¬å¤„ç†è¿™ä¸ªchunkï¼Œæ¯”å¦‚è¿›è¡ŒæŸç§è½¬æ¢</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> processedChunk</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> processChunk</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // æ¥ä¸‹æ¥ï¼Œå‡è®¾è¿™é‡Œæœ‰ä¸€ä¸ªæ–¹å¼å»å“åº”è¿™ä¸ªå¤„ç†è¿‡çš„å—ï¼Œå¦‚å‘é€ç»™å®¢æˆ·ç«¯æˆ–å†™å…¥å¦ä¸€ä¸ªæµ</span></span>
<span class="line"><span style="color:#88C0D0;">    respondToStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">processedChunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> processChunk</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // å¤„ç†æ•°æ®å—çš„é€»è¾‘ï¼Œå¯èƒ½æ¶‰åŠåˆ°è§†å›¾çš„è½¬æ¢ã€‚</span></span>
<span class="line"><span style="color:#616E88;">  // ä¾‹å¦‚ï¼Œå°†ä¸€ä¸ªUInt8Arrayè½¬æ¢æˆå¦ä¸€ä¸ªç±»å‹çš„è§†å›¾</span></span>
<span class="line"><span style="color:#81A1C1;">  return</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Uint8Array</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">map</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">byte</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#D8DEE9;"> byte</span><span style="color:#81A1C1;"> ^</span><span style="color:#B48EAD;"> 0xff</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // ç¤ºä¾‹ï¼šå¯¹æ¯ä¸ªå­—èŠ‚è¿›è¡Œç®€å•çš„ä½åè½¬æ“ä½œ</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> respondToStream</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">processedChunk</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // å‡è®¾è¿™é‡Œæœ‰é€»è¾‘æ¥å¤„ç†æˆ–å“åº”å¤„ç†è¿‡çš„æ•°æ®å—</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·æ³¨æ„ï¼Œè¿™ä¸ªä¾‹å­ä¸»è¦æ˜¯ä¸ºäº†å±•ç¤ºå¦‚ä½•ä½¿ç”¨ç±»ä¼¼<code>respondWithNewView(view)</code>çš„æ–¹æ³•æ¥å¤„ç†å’Œå“åº”æµæ•°æ®ã€‚å®é™…ä¸Šï¼Œ<code>respondWithNewView(view)</code>é€šå¸¸ç”¨åœ¨æ›´ä½çº§åˆ«çš„ API æˆ–è€…ä¸ Web Streams API ç›¸å…³çš„åœºæ™¯ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½ è‡ªå®šä¹‰æµå¤„ç†é€»è¾‘æ—¶ã€‚åœ¨ Node.js æ ‡å‡‘åº“æä¾›çš„<code>fs</code>æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¸ç›´æ¥è°ƒç”¨<code>respondWithNewView(view)</code>ï¼Œè€Œæ˜¯ä¾èµ–äºæµè‡ªèº«çš„æ–¹æ³•æ¥ç®¡ç†æ•°æ®ã€‚</p><p>å¸Œæœ›è¿™ä¸ªè§£é‡Šå’Œç¤ºä¾‹èƒ½å¤Ÿå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£<code>ReadableStreamBYOBRequest.respondWithNewView(view)</code>çš„ä½œç”¨å’Œç”¨æ³•ï¼</p><h4 id="readablestreambyobrequest-view" tabindex="-1"><a class="header-anchor" href="#readablestreambyobrequest-view"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#readablestreambyobrequestview" target="_blank" rel="noopener noreferrer">readableStreamBYOBRequest.view</a></span></a></h4><p>ç†è§£ <code>readableStreamBYOBRequest.view</code> è¿™ä¸ªæ¦‚å¿µä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£å‡ ä¸ªåŸºç¡€ç‚¹ï¼š<code>ReadableStream</code>ã€BYOBï¼ˆBring Your Own Bufferï¼‰æ¨¡å¼å’Œ<code>ArrayBuffer</code>ã€‚è¿™æ ·å¯ä»¥å¸®åŠ©ä½ æ›´å¥½åœ°æŒæ¡è¿™ä¸ªç‰¹æ€§ä»¥åŠå®ƒçš„åº”ç”¨åœºæ™¯ã€‚</p><ol><li><p><strong>åŸºç¡€ç†è§£</strong>:</p><ul><li><strong>ReadableStream</strong>: åœ¨ Node.js ä¸­ï¼Œæµï¼ˆStreamï¼‰æ˜¯å¤„ç†æ•°æ®çš„ä¸€ç§æ–¹å¼ï¼Œå°¤å…¶æ˜¯å½“æ•°æ®é‡å¤§æˆ–è€…æ•°æ®ä»¥å¼‚æ­¥æ–¹å¼æ¥è‡ªå¤šä¸ªæ¥æºæ—¶ã€‚æµå¯ä»¥å¸®åŠ©ä½ é«˜æ•ˆåœ°å¤„ç†æ•°æ®ï¼Œå› ä¸ºä½ ä¸éœ€è¦ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å¯ç”¨æ‰å¼€å§‹å¤„ç†ã€‚<code>ReadableStream</code>æ˜¯å…¶ä¸­ä¸€ç§ç±»å‹ï¼Œä¸“é—¨ç”¨äºè¯»å–æ•°æ®ã€‚</li><li><strong>BYOBï¼ˆBring Your Own Bufferï¼‰</strong>: è¿™æ˜¯ä¸€ä¸ªé«˜çº§æ¦‚å¿µï¼Œå…è®¸æ›´ç»†ç²’åº¦åœ°æ§åˆ¶å†…å­˜ä½¿ç”¨ï¼Œå³å…è®¸ç”¨æˆ·æä¾›è‡ªå·±çš„ buffer æ¥æ¥æ”¶æ•°æ®ã€‚è¿™å¯¹äºæƒ³è¦ç²¾ç¡®æ§åˆ¶å†…å­˜å¼€é”€çš„åº”ç”¨ç¨‹åºæ¥è¯´éå¸¸æœ‰ç”¨ã€‚</li><li><strong>ArrayBuffer</strong>: æ˜¯ JavaScript çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºè¡¨ç¤ºé€šç”¨çš„ã€å›ºå®šé•¿åº¦çš„åŸå§‹äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºã€‚ä½ å¯ä»¥é€šè¿‡è§†å›¾ï¼ˆå¦‚ Uint8Arrayï¼‰æ¥æ“ä½œè¿™äº›æ•°æ®ã€‚</li></ul></li><li><p><strong><code>readableStreamBYOBRequest.view</code> è§£é‡Š</strong>:<br> å½“ä½ åœ¨ Node.js ä½¿ç”¨å¯è¯»æµï¼ˆ<code>ReadableStream</code>ï¼‰å¹¶é€‰æ‹© BYOB æ¨¡å¼è¿›è¡Œæ•°æ®è¯»å–æ—¶ï¼Œ<code>readableStreamBYOBRequest.view</code>æä¾›äº†ä¸€ä¸ªè§†å›¾ï¼Œä½¿ä½ èƒ½å¤Ÿç›´æ¥å†™å…¥åˆ°ä¸€ä¸ªé¢„å…ˆåˆ†é…çš„<code>ArrayBuffer</code>ä¸­ã€‚è¿™é‡Œï¼Œâ€œè§†å›¾â€æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä¸<code>ArrayBuffer</code>ç»‘å®šçš„æ•°ç»„è§†å›¾ï¼ˆæ¯”å¦‚<code>Uint8Array</code>ï¼‰ï¼Œå®ƒå®šä¹‰äº†å¦‚ä½•ä»å†…å­˜ä¸­è¯»å–å’Œå†™å…¥æ•°æ®ã€‚</p></li><li><p><strong>å®é™…è¿ç”¨ä¾‹å­</strong>:</p><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦ä»æ–‡ä»¶ä¸­è¯»å–å¤§é‡æ•°æ®ï¼Œå¹¶ä¸”ä½ å¸Œæœ›å°½å¯èƒ½åœ°å‡å°‘å†…å­˜å ç”¨ã€‚åˆ©ç”¨ BYOB æ¨¡å¼ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªæµï¼Œå¹¶æä¾›è‡ªå·±çš„ bufferï¼Œç„¶åä½¿ç”¨<code>readableStreamBYOBRequest.view</code>å°†æ•°æ®ç›´æ¥è¯»å…¥è¯¥ bufferã€‚</p></li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾ä½ æœ‰ä¸€ä¸ªå¾ˆå¤§çš„æ–‡ä»¶ï¼Œä½ æƒ³é€å—è¯»å–</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/your/large/file</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">  highWaterMark</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è®¾ç½®æ¯æ¬¡è¯»å–çš„å¤§å°ä¸º1MB</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">readable</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  let</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">  // å°è¯•è¯»å–ä¸€å—æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">null</span><span style="color:#81A1C1;"> !==</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">())) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">    // å¤„ç†è¿™å—æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">Received </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">length</span><span style="color:#81A1C1;">}</span><span style="color:#A3BE8C;"> bytes of data.</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰ç›´æ¥ä½¿ç”¨<code>readableStreamBYOBRequest.view</code>ï¼ˆå› ä¸ºè¿™æ›´å¤šåœ°æ¶‰åŠåº•å±‚ API çš„ä½¿ç”¨ï¼‰ï¼Œä½†æ˜¯æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡æµçš„<code>read</code>æ–¹æ³•æ¥é€æ­¥è¯»å–æ•°æ®ï¼Œå°†å…¶æ”¾å…¥ buffer ä¸­ã€‚å¦‚æœä½ ä½¿ç”¨ Web Streams API æˆ–è€…åœ¨æŸäº›ç‰¹å®šåœºæ™¯ä¸‹éœ€è¦æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œé‚£ä¹ˆç›´æ¥æ“ä½œ<code>readableStreamBYOBRequest.view</code>æ¥å¡«å……ä½ çš„ buffer å°†ä¼šéå¸¸æœ‰ç”¨ã€‚</p><p>ç»¼ä¸Šæ‰€è¿°ï¼Œ<code>readableStreamBYOBRequest.view</code>æ˜¯ä¸€ä¸ªé«˜çº§åŠŸèƒ½ï¼Œè®©ä½ èƒ½å¤Ÿæœ‰æ•ˆåœ°æ§åˆ¶æ•°æ®å¦‚ä½•è¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§é‡æ•°æ®æˆ–è€…éœ€è¦ç²¾ç»†å†…å­˜ç®¡ç†çš„åº”ç”¨ä¸­ã€‚</p><h3 id="class-writablestream" tabindex="-1"><a class="header-anchor" href="#class-writablestream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-writablestream" target="_blank" rel="noopener noreferrer">Class: WritableStream</a></span></a></h3><p>å¥½çš„ï¼Œè®©æˆ‘æ¥å¸®ä½ ç†è§£ Node.js ä¸­çš„ <code>WritableStream</code> ç±»ï¼Œç‰¹åˆ«æ˜¯åœ¨ v21.7.1 ç‰ˆæœ¬ä¸­çš„åº”ç”¨å’Œé‡è¦æ€§ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯-writablestream" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯-writablestream"><span>ä»€ä¹ˆæ˜¯ WritableStreamï¼Ÿ</span></a></h3><p>é¦–å…ˆï¼Œ&quot;æµ&quot;ï¼ˆStreamï¼‰æ˜¯ Node.js ä¸­å¤„ç†æ•°æ®çš„ä¸€ç§æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯å½“ä½ å¤„ç†å¤§é‡æ•°æ®æˆ–è€…ä½ ä¸æƒ³ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®è£…è½½åˆ°å†…å­˜ä¸­æ—¶ã€‚Node.js çš„ Stream åˆ†ä¸ºå‡ ç§ç±»å‹ï¼Œå…¶ä¸­ <code>WritableStream</code> æ˜¯ä¸€ç§å…è®¸ä½ å†™å…¥æ•°æ®çš„æµã€‚</p><p>ç®€å•æ¥è¯´ï¼Œ<code>WritableStream</code> è®©ä½ å¯ä»¥ä¸€å—ä¸€å—åœ°å†™æ•°æ®ï¼Œè¿™å¯¹äºå¤„ç†å¤§æ–‡ä»¶æˆ–å®æ—¶æ•°æ®éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå¯ä»¥è¾¹è¯»è¾¹å†™ï¼Œå‡å°‘äº†å†…å­˜çš„ä½¿ç”¨ã€‚</p><h3 id="å¦‚ä½•ä½¿ç”¨-writablestream" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ä½¿ç”¨-writablestream"><span>å¦‚ä½•ä½¿ç”¨ WritableStreamï¼Ÿ</span></a></h3><p>ä½¿ç”¨ <code>WritableStream</code> ä¹‹å‰ï¼Œä½ é€šå¸¸éœ€è¦å¯¼å…¥æˆ–è·å–ä¸€ä¸ªå¯å†™æµã€‚åœ¨ Web Streams APIï¼ˆä¹Ÿå°±æ˜¯åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­çš„æµï¼‰ä¸­ï¼Œ<code>WritableStream</code> ä¹Ÿå­˜åœ¨ï¼Œå¹¶ä¸”åœ¨ Node.js ä¸­è¢«æ¨¡æ‹Ÿï¼Œæ‰€ä»¥ç”¨æ³•éå¸¸ç›¸ä¼¼ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªåŸºç¡€çš„ä¾‹å­ï¼Œå±•ç¤ºå¦‚ä½•åˆ›å»ºä¸€ä¸ªç®€å•çš„å¯å†™æµï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> Writable</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªç®€å•çš„ WritableStream</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> myWritable</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Writable</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  write</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> encoding</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> callback</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // è¿™é‡Œæ˜¯å†™æ•°æ®çš„é€»è¾‘</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#88C0D0;">    callback</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨ writable.write() æ–¹æ³•å†™æ•°æ®åˆ°æµä¸­</span></span>
<span class="line"><span style="color:#D8DEE9;">myWritable</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, World!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">utf8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">å†™å…¥å®Œæˆ</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª <code>WritableStream</code> å®ä¾‹ <code>myWritable</code>ï¼Œå¹¶å®šä¹‰äº†å®ƒå¦‚ä½•å¤„ç†å†™å…¥çš„æ•°æ®ã€‚æ¯æ¬¡è°ƒç”¨ <code>.write()</code> æ–¹æ³•æ—¶ï¼Œå°±ä¼šè§¦å‘å®šä¹‰çš„ <code>write</code> å‡½æ•°ã€‚</p><h3 id="å®é™…åº”ç”¨ä¾‹å­-2" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ä¾‹å­-2"><span>å®é™…åº”ç”¨ä¾‹å­</span></a></h3><h4 id="æ–‡ä»¶å†™å…¥" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶å†™å…¥"><span>æ–‡ä»¶å†™å…¥</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨æ„å»ºä¸€ä¸ªç½‘ç«™ï¼Œéœ€è¦ç”Ÿæˆå¤§å‹æ—¥å¿—æ–‡ä»¶ã€‚ä½¿ç”¨ <code>fs.createWriteStream</code> å¯ä»¥åˆ›å»ºä¸€ä¸ªæŒ‡å‘æ–‡ä»¶çš„ <code>WritableStream</code>ï¼Œç„¶åé€è¡Œæˆ–é€å—å†™å…¥æ•°æ®ï¼Œè€Œä¸å¿…ä¸€æ¬¡æ€§å°†æ‰€æœ‰å†…å®¹åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> file</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">./bigfile.log</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">for</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9;"> i</span><span style="color:#ECEFF4;"> `</span><span style="color:#A3BE8C;">&lt;</span><span style="color:#ECEFF4;">`</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 1e6</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">  file</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">è¿™æ˜¯ç¬¬ </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">i</span><span style="color:#81A1C1;">}</span><span style="color:#A3BE8C;"> è¡Œæ—¥å¿—</span><span style="color:#EBCB8B;">\n</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">file</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">æ–‡ä»¶ç»“æŸ</span><span style="color:#EBCB8B;">\n</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="http-å“åº”" tabindex="-1"><a class="header-anchor" href="#http-å“åº”"><span>HTTP å“åº”</span></a></h4><p>åœ¨ Node.js HTTP æœåŠ¡å™¨ä¸­ï¼Œå“åº” (<code>response</code>) å¯¹è±¡å®é™…ä¸Šæ˜¯ä¸€ä¸ª <code>WritableStream</code>ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ç›´æ¥å‘å…¶å†™å…¥å“åº”æ•°æ®ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> http</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">http</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> server</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> http</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createServer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">req</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> res</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">writeHead</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">200</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Content-Type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">text/plain</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">  res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, World!</span><span style="color:#EBCB8B;">\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">  res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ç»“æŸå“åº”</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">server</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">listen</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">3000</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¾‹å­åˆ›å»ºäº†ä¸€ä¸ªç®€æ˜“çš„ HTTP æœåŠ¡å™¨ï¼Œå®ƒå‘æ¯ä¸ªè¯·æ±‚å‘é€ &quot;Hello, World!&quot;ï¼Œç„¶åç»“æŸå“åº”ã€‚è¿™é‡Œçš„ <code>res</code>ï¼ˆå“åº”å¯¹è±¡ï¼‰å°±æ˜¯ä¸€ä¸ª <code>WritableStream</code>ã€‚</p><h3 id="æ€»ç»“-5" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-5"><span>æ€»ç»“</span></a></h3><p><code>WritableStream</code> åœ¨ Node.js ä¸­æ˜¯å¤„ç†å†™å…¥æ“ä½œçš„åŸºç¡€ç±»ï¼Œéå¸¸é€‚åˆäºå¤„ç†å¤§é‡æ•°æ®ã€æ–‡ä»¶æ“ä½œå’Œç½‘ç»œé€šä¿¡ç­‰åœºæ™¯ã€‚é€šè¿‡å°†æ•°æ®åˆ†å—å†™å…¥ï¼Œå®ƒå¯ä»¥æœ‰æ•ˆåœ°å‡å°‘å†…å­˜ä½¿ç”¨ï¼Œæé«˜åº”ç”¨æ€§èƒ½ã€‚å¸Œæœ›è¿™è§£é‡Šæ¸…æ¥šäº† <code>WritableStream</code> çš„æ¦‚å¿µåŠå…¶åœ¨ Node.js ä¸­çš„åº”ç”¨ï¼</p><h4 id="new-writablestream-underlyingsink-strategy" tabindex="-1"><a class="header-anchor" href="#new-writablestream-underlyingsink-strategy"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#new-writablestreamunderlyingsink-strategy" target="_blank" rel="noopener noreferrer">new WritableStream([underlyingSink[, strategy]])</a></span></a></h4><p>å½“æˆ‘ä»¬è°ˆè®º Node.js ä¸­çš„<code>WritableStream</code>ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯åœ¨è®¨è®ºä¸€ç§å¯ä»¥å‘å…¶å†™å…¥æ•°æ®çš„æµã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰ä¸€ä¸ªæ°´æ¡¶ï¼ˆè¿™é‡ŒæŒ‡çš„å°±æ˜¯<code>WritableStream</code>ï¼‰ï¼Œä½ å¯ä»¥å¾€é‡Œé¢ä¸æ–­åœ°åŠ æ°´ï¼ˆåœ¨è¿™ä¸ªæ¯”å–»ä¸­ï¼Œæ°´å°±ç›¸å½“äºæ•°æ®ï¼‰ã€‚<code>WritableStream</code>ç”¨äºå¤„ç†å¦‚æ–‡ä»¶å†™å…¥ã€ç½‘ç»œé€šä¿¡ç­‰åœºæ™¯ï¼Œåœ¨ Node.js v21.7.1 ç‰ˆæœ¬ä¸­ï¼Œæ„é€ å‡½æ•°<code>new WritableStream()</code>å…è®¸ä½ åˆ›å»ºä¸€ä¸ªæ–°çš„å¯å†™æµã€‚</p><p>é¦–å…ˆï¼Œæ¥çœ‹çœ‹æ„é€ å‡½æ•°çš„ç»“æ„ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> WritableStream</span><span style="color:#D8DEE9FF;">([</span><span style="color:#D8DEE9;">underlyingSink</span><span style="color:#D8DEE9FF;">[</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> strategy</span><span style="color:#D8DEE9FF;">]])</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>underlyingSink</code> æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæä¾›äº†å‡ ä¸ªç”¨äºè‡ªå®šä¹‰æµè¡Œä¸ºçš„æ–¹æ³•ï¼Œä¾‹å¦‚ä½•æ—¶å¯åŠ¨æµã€å†™å…¥æ•°æ®ã€å…³é—­æµç­‰ã€‚</li><li><code>strategy</code> ç”¨äºæ§åˆ¶æµçš„ç¼“å†²ç­–ç•¥ï¼Œæ¯”å¦‚æ§åˆ¶ä½•æ—¶ä¼ è¾“æ•°æ®å¯ä»¥è¢«è§†ä¸ºè¿‡å¤šï¼ˆæˆ–å‹åŠ›è¿‡å¤§ï¼‰ã€‚</li></ul><h4 id="å®é™…è¿ç”¨ä¾‹å­-12" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-12"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h4><h5 id="_1-æ–‡ä»¶å†™å…¥" tabindex="-1"><a class="header-anchor" href="#_1-æ–‡ä»¶å†™å…¥"><span>1. æ–‡ä»¶å†™å…¥</span></a></h5><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªåº”ç”¨ï¼Œéœ€è¦å°†ç”Ÿæˆçš„æ—¥å¿—ä¿¡æ¯å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚è¿™æ—¶å€™ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>WritableStream</code>æ¥å®Œæˆè¿™é¡¹å·¥ä½œï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> WritableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªWritableStreamç”¨äºå†™å…¥æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.log</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> WritableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  write</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å½“å‘streamå†™å…¥æ•°æ®æ—¶è°ƒç”¨</span></span>
<span class="line"><span style="color:#D8DEE9;">    fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#88C0D0;">  close</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å½“streamå…³é—­æ—¶è°ƒç”¨</span></span>
<span class="line"><span style="color:#D8DEE9;">    fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#88C0D0;">  abort</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">reason</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å¦‚æœå‡ºç°é”™è¯¯å¯¼è‡´streamç»ˆæ­¢æ—¶è°ƒç”¨</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">reason</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">destroy</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> Error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Stream aborted</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨WritableStream</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> encoder</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextEncoder</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">encode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, World!</span><span style="color:#EBCB8B;">\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-ç½‘ç»œè¯·æ±‚å“åº”ä½“" tabindex="-1"><a class="header-anchor" href="#_2-ç½‘ç»œè¯·æ±‚å“åº”ä½“"><span>2. ç½‘ç»œè¯·æ±‚å“åº”ä½“</span></a></h5><p>å‡è®¾ä½ æ­£åœ¨åˆ›å»ºä¸€ä¸ª Web æœåŠ¡å™¨ï¼Œå½“æ¥æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œä½ æƒ³è¦é€æ­¥æ„å»ºå“åº”ä½“å¹¶å‘é€ç»™å®¢æˆ·ç«¯ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§åœ°å‘é€æ•´ä¸ªå“åº”ã€‚è¿™æ ·å¯ä»¥æé«˜æ•ˆç‡ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§é‡æ•°æ®æ—¶ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> http</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">http</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> WritableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">http</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">createServer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">req</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> res</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> WritableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">      write</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">        // å‘HTTPå“åº”ä¸­å†™å…¥æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9;">        res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#88C0D0;">      close</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">        // ç»“æŸHTTPå“åº”</span></span>
<span class="line"><span style="color:#D8DEE9;">        res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> writer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> encoder</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextEncoder</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // å‡è®¾æˆ‘ä»¬è¦åˆ†å‡ æ¬¡å‘é€æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9;">    writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">encode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Part 1 of the response</span><span style="color:#EBCB8B;">\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">encode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Part 2 of the response</span><span style="color:#EBCB8B;">\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // å®Œæˆå†™å…¥æ“ä½œ</span></span>
<span class="line"><span style="color:#D8DEE9;">    writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">listen</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">8080</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä»¥ä¸Šä¸¤ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡åˆ›å»º<code>WritableStream</code>å®ä¾‹ï¼Œå¹¶åˆ©ç”¨å…¶æä¾›çš„<code>write()</code>å’Œ<code>close()</code>æ–¹æ³•ï¼Œæœ‰æ•ˆåœ°ç®¡ç†äº†æ•°æ®å†™å…¥è¿‡ç¨‹ã€‚æ— è®ºæ˜¯å†™å…¥æ–‡ä»¶è¿˜æ˜¯ç½‘ç»œå“åº”ï¼Œ<code>WritableStream</code>éƒ½èƒ½ä¸ºæˆ‘ä»¬æä¾›çµæ´»çš„æ•°æ®å¤„ç†æ–¹å¼ã€‚</p><h4 id="writablestream-abort-reason" tabindex="-1"><a class="header-anchor" href="#writablestream-abort-reason"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#writablestreamabortreason" target="_blank" rel="noopener noreferrer">writableStream.abort([reason])</a></span></a></h4><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬ä»¥ç®€å•çš„æ–¹å¼æ¥è§£é‡Š Node.js ä¸­ <code>writableStream.abort([reason])</code> çš„æ¦‚å¿µå’Œå®ƒåœ¨å®é™…ä¸­çš„åº”ç”¨ã€‚</p><p>é¦–å…ˆï¼Œ<strong>ä»€ä¹ˆæ˜¯ Streamï¼Ÿ</strong></p><p>åœ¨ç¼–ç¨‹ä¸­ï¼Œ<strong>æµï¼ˆStreamï¼‰</strong> æ˜¯ä¸€ç§å¤„ç†æ•°æ®çš„æ–¹å¼ã€‚æƒ³è±¡ä¸€ä¸ªæ°´æµï¼Œæ•°æ®å°±åƒæ°´æµä¸­çš„æ°´ä¸€æ ·ï¼Œå¯ä»¥ä»ä¸€ä¸ªåœ°æ–¹æµå‘å¦ä¸€ä¸ªåœ°æ–¹ã€‚åœ¨ Node.js ä¸­ï¼Œæµè¢«ç”¨æ¥é«˜æ•ˆå¤„ç†å¤§é‡æ•°æ®ï¼Œæ¯”å¦‚è¯»å–å¤§æ–‡ä»¶æˆ–ç½‘ç»œè¯·æ±‚çš„å“åº”æ•°æ®ã€‚</p><p><strong>é‚£ä¹ˆï¼ŒWritable Stream æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</strong></p><p><strong>Writable Stream</strong> æ˜¯ Node.js ä¸­ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œå®ƒå…è®¸ä½ å°†æ•°æ®å†™å…¥åˆ°ç›®æ ‡ã€‚è¿™ä¸ªç›®æ ‡å¯ä»¥æ˜¯æ–‡ä»¶ã€ç»ˆç«¯æˆ–è€…ç½‘ç»œè¿æ¥ç­‰ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬èšç„¦äº <code>writableStream.abort([reason])</code>ã€‚</p><p><strong>writableStream.abort([reason]) è§£é‡Šï¼š</strong></p><p>å½“ä½ ä½¿ç”¨ Writable Stream å†™æ•°æ®æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°éœ€è¦ç«‹å³åœæ­¢å†™å…¥å¹¶å–æ¶ˆæ“ä½œçš„æƒ…å½¢ã€‚è¿™æ­£æ˜¯ <code>abort()</code> æ–¹æ³•çš„ç”¨é€”ã€‚è°ƒç”¨ <code>abort()</code> å¯ä»¥ç«‹å³ç»“æŸå†™å…¥è¿‡ç¨‹ï¼Œå¹¶ä¸”å¯é€‰åœ°ä¼ é€’ä¸€ä¸ªåŸå› è¯´æ˜ä¸ºä»€ä¹ˆè¦ä¸­æ–­ã€‚</p><p>å‚æ•°ï¼š</p><ul><li><strong>reason</strong>ï¼ˆå¯é€‰ï¼‰: æä¾›ä¸€ä¸ªé”™è¯¯å¯¹è±¡æˆ–å…¶ä»–å€¼æ¥è¯´æ˜ä¸ºä½•ä¸­æ–­ã€‚</li></ul><p><strong>å®é™…è¿ç”¨çš„ä¾‹å­ï¼š</strong></p><ol><li><p><strong>å†™å…¥æ–‡ä»¶æ—¶å–æ¶ˆæ“ä½œï¼š</strong></p><p>å‡è®¾ä½ åœ¨å†™ä¸€ä¸ªç¨‹åºï¼Œè¯¥ç¨‹åºè´Ÿè´£å°†ä»äº’è”ç½‘ä¸‹è½½çš„æ•°æ®ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ã€‚å¦‚æœç”¨æˆ·çªç„¶æƒ³è¦å–æ¶ˆä¸‹è½½ï¼ˆå¯èƒ½ç”±äºæ–‡ä»¶å¤ªå¤§æˆ–è€…æ”¹å˜äº†ä¸»æ„ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>writableStream.abort()</code> æ¥åœæ­¢å†™å…¥æ–‡ä»¶ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> WritableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> dataStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> WritableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  write</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å‡è®¾æ­¤å‡½æ•°ç”¨äºå†™å…¥æ–‡ä»¶</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Writing chunk:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#88C0D0;">  close</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Stream finished.</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// æ¨¡æ‹Ÿæ•°æ®å†™å…¥</span></span>
<span class="line"><span style="color:#D8DEE9;">dataStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, World!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ç”¨æˆ·å–æ¶ˆæ“ä½œ</span></span>
<span class="line"><span style="color:#88C0D0;">setTimeout</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  dataStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">abort</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">User cancelled the operation</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Stream aborted due to:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">},</span><span style="color:#B48EAD;"> 1000</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>ç½‘ç»œè¯·æ±‚ä¸­æ–­ï¼š</strong></p><p>å½“ä½ æ­£åœ¨ä¸Šä¼ æ•°æ®åˆ°æœåŠ¡å™¨ï¼Œå¦‚æœç”¨æˆ·çªç„¶æ–­å¼€è¿æ¥ï¼Œæˆ–è€…ä½ æ£€æµ‹åˆ°ç½‘ç»œè´¨é‡ä¸ä½³ï¼Œä½ å¯èƒ½ä¼šå†³å®šå–æ¶ˆä¸Šä¼ ã€‚é€šè¿‡è°ƒç”¨ <code>abort()</code>ï¼Œä½ å¯ä»¥ç«‹å³ç»ˆæ­¢ä¸Šä¼ è¿‡ç¨‹ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾æœ‰ä¸€ä¸ª writableStream å¯¹åº”ç€ä¸€ä¸ªç½‘ç»œä¸Šä¼ çš„è¿‡ç¨‹</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> uploadStream</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> getUploadStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡å®šè¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªç”¨äºä¸Šä¼ çš„ writableStream</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">uploadStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">abort</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Network issue or user disconnected</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Upload aborted due to:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>åœ¨ä»¥ä¸Šä¾‹å­ä¸­ï¼Œè°ƒç”¨ <code>abort()</code> åï¼Œç³»ç»Ÿä¼šå°è¯•ç«‹å³åœæ­¢å½“å‰æ“ä½œï¼Œå¹¶é€šè¿‡ Promise æ•è·ä»»ä½•å¯èƒ½å‘ç”Ÿçš„é”™è¯¯ã€‚è¿™å¯¹äºèµ„æºç®¡ç†å’Œç”¨æˆ·ä½“éªŒéƒ½éå¸¸é‡è¦ï¼Œä½¿å¾—åº”ç”¨èƒ½å¤ŸåŠæ—¶å“åº”å¤–éƒ¨äº‹ä»¶å’Œå†…éƒ¨çŠ¶æ€çš„å˜åŒ–ã€‚</p><h4 id="writablestream-close" tabindex="-1"><a class="header-anchor" href="#writablestream-close"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#writablestreamclose" target="_blank" rel="noopener noreferrer">writableStream.close()</a></span></a></h4><p>Node.js çš„ <code>writableStream.close()</code> æ˜¯ä¸€ä¸ªä¸ Web Streams API ç›¸å…³çš„æ–¹æ³•ï¼Œç”¨äºå…³é—­ä¸€ä¸ªå¯å†™æµï¼ˆWritableStreamï¼‰ã€‚åœ¨æˆ‘ä»¬æ·±å…¥è§£é‡Šä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆç†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µã€‚</p><h3 id="åŸºç¡€æ¦‚å¿µ-4" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ-4"><span>åŸºç¡€æ¦‚å¿µ</span></a></h3><ol><li><strong>Streamï¼ˆæµï¼‰</strong>ï¼šåœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯ä¸€ç³»åˆ—è¿ç»­çš„æ•°æ®ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆæ°´æµï¼Œæ•°æ®åƒæ°´ä¸€æ ·ä»ä¸€ä¸ªåœ°æ–¹â€œæµâ€åˆ°å¦ä¸€ä¸ªåœ°æ–¹ã€‚</li><li><strong>WritableStreamï¼ˆå¯å†™æµï¼‰</strong>ï¼šæ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œä¸»è¦ç”¨äºå‘æŸå¤„å†™å…¥æ•°æ®ã€‚æ¯”å¦‚ï¼Œä½ å¯èƒ½ä¼šå°†æ–‡ä»¶å†…å®¹å†™å…¥ç£ç›˜ï¼Œæˆ–è€…å°†æ•°æ®å‘é€ç»™å®¢æˆ·ç«¯ã€‚</li></ol><h3 id="å…³äº-writablestream-close" tabindex="-1"><a class="header-anchor" href="#å…³äº-writablestream-close"><span>å…³äº writableStream.close()</span></a></h3><p><code>writableStream.close()</code> æ–¹æ³•ç”¨äºä¼˜é›…åœ°å…³é—­ä¸€ä¸ªå¯å†™æµã€‚å½“ä½ è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œå®ƒå®é™…ä¸Šæ ‡è®°äº†æµçš„æœ«å°¾ï¼Œæ„å‘³ç€æ²¡æœ‰æ›´å¤šçš„æ•°æ®å°†ä¼šè¢«å†™å…¥ã€‚å®ƒæ˜¯å¼‚æ­¥æ“ä½œï¼Œè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œè¡¨ç¤ºä½•æ—¶æµå®é™…ä¸Šè¢«å…³é—­ã€‚</p><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-2" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-2"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h3><h4 id="ä¾‹å­-1-å°†æ–‡æœ¬å†™å…¥æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-å°†æ–‡æœ¬å†™å…¥æ–‡ä»¶"><span>ä¾‹å­ 1: å°†æ–‡æœ¬å†™å…¥æ–‡ä»¶</span></a></h4><p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£åœ¨æ„å»ºä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦å°†æ—¥å¿—ä¿¡æ¯å†™å…¥ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ä¸­ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>WritableStream</code> æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œå¹¶åœ¨å†™å®Œæ‰€æœ‰æ—¥å¿—åå…³é—­æµã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯å†™æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">log.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å†™å…¥æ•°æ®åˆ°æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">è¿™æ˜¯ç¬¬ä¸€è¡Œæ—¥å¿—</span><span style="color:#EBCB8B;">\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">è¿™æ˜¯ç¬¬äºŒè¡Œæ—¥å¿—</span><span style="color:#EBCB8B;">\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å®Œæˆå†™å…¥æ“ä½œåå…³é—­æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æœ€åä¸€è¡Œæ—¥å¿—</span><span style="color:#EBCB8B;">\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // end æ–¹æ³•å®é™…ä¸Šä¹Ÿä¼šå…³é—­æµï¼Œä½†æ˜¯ä»¥æ›´ä¸€èˆ¬çš„æ–¹å¼å¤„ç†æµçš„ç»“æŸ</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å¦‚æœä½¿ç”¨ web streams API æˆ–åœ¨å…¶ä»–æƒ…å†µä¸‹éœ€è¦æ˜¾å¼å…³é—­æµï¼Œå¯ä»¥è¿™æ ·åšï¼š</span></span>
<span class="line"><span style="color:#616E88;">// await writableStream.close();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Node.js çš„ <code>fs</code> æ¨¡å—æ¥åˆ›å»ºä¸€ä¸ªå¯å†™æµï¼Œç”¨äºå°†æ–‡æœ¬å†™å…¥åä¸º <code>log.txt</code> çš„æ–‡ä»¶ä¸­ã€‚<code>end</code> æ–¹æ³•åœ¨è¿™é‡Œç”¨äºæ·»åŠ æœ€åä¸€è¡Œæ—¥å¿—å¹¶å…³é—­æµã€‚</p><h4 id="ä¾‹å­-2-æœåŠ¡å™¨å“åº”" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-æœåŠ¡å™¨å“åº”"><span>ä¾‹å­ 2: æœåŠ¡å™¨å“åº”</span></a></h4><p>å½“ä½ ä½¿ç”¨ Node.js æ„å»ºä¸€ä¸ª web æœåŠ¡å™¨æ—¶ï¼Œå®¢æˆ·ç«¯è¯·æ±‚çš„å“åº”å¯ä»¥é€šè¿‡å¯å†™æµæ¥ç®¡ç†ã€‚ä¾‹å¦‚ï¼Œåœ¨å®¢æˆ·ç«¯è¯·æ±‚æŸäº›æ•°æ®æ—¶ï¼Œä½ å¯ä»¥é€æ­¥å°†æ•°æ®å†™å…¥å“åº”æµï¼Œå¹¶åœ¨å®Œæˆåå…³é—­æµã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> http</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">http</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">http</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">createServer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">req</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> res</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">writeHead</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">200</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Content-Type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">text/plain</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, World!</span><span style="color:#EBCB8B;">\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // å½“æ‰€æœ‰å“åº”æ•°æ®éƒ½å·²å‘é€ï¼Œå…³é—­å“åº”æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">    res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Goodbye!</span><span style="color:#EBCB8B;">\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">listen</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">8080</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Server running at http://localhost:8080/</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è™½ç„¶è¿™ä¸ªä¾‹å­ä¸­ç›´æ¥ä½¿ç”¨äº† <code>res.end()</code> æ¥ç»“æŸå’Œå…³é—­å“åº”æµï¼Œä½†å®ƒæœ‰æ•ˆåœ°å±•ç¤ºäº†å¦‚ä½•åœ¨ Web æœåŠ¡ä¸­ä½¿ç”¨æµã€‚</p><h3 id="æ€»ç»“-6" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-6"><span>æ€»ç»“</span></a></h3><p><code>writableStream.close()</code> æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹æ³•ï¼Œç‰¹åˆ«æ˜¯å½“ä½ éœ€è¦ä¼˜é›…åœ°ç»“æŸæ•°æ®å†™å…¥æ“ä½œæ—¶ã€‚é€šè¿‡è°ƒç”¨æ­¤æ–¹æ³•ï¼Œä½ å¯ä»¥ç¡®ä¿æ‰€æœ‰æ•°æ®éƒ½å·²æ­£ç¡®å¤„ç†ï¼Œå¹¶ä¸”èµ„æºå¾—åˆ°é€‚å½“çš„æ¸…ç†å’Œé‡Šæ”¾ï¼Œè¿™å¯¹äºå†…å­˜ç®¡ç†å’Œé˜²æ­¢æ½œåœ¨çš„ I/O é—®é¢˜è‡³å…³é‡è¦ã€‚</p><h4 id="writablestream-getwriter" tabindex="-1"><a class="header-anchor" href="#writablestream-getwriter"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#writablestreamgetwriter" target="_blank" rel="noopener noreferrer">writableStream.getWriter()</a></span></a></h4><p>Node.js ä¸­çš„ <code>writableStream.getWriter()</code> æ–¹æ³•æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œç‰¹åˆ«æ˜¯å½“ä½ ä¸æµï¼ˆstreamsï¼‰æ‰“äº¤é“æ—¶ã€‚åœ¨æ·±å…¥è§£é‡Šè¿™ä¸ªæ–¹æ³•ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆç†è§£å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š</p><h3 id="æµ-streams-1" tabindex="-1"><a class="header-anchor" href="#æµ-streams-1"><span>æµ (Streams)</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œæµæ˜¯ä¸€ç§å¤„ç†æ•°æ®çš„æ–¹å¼ï¼Œå°¤å…¶æ˜¯å½“æ•°æ®é‡å¤§æˆ–è€…æ•°æ®æ˜¯é€æ­¥äº§ç”Ÿæ—¶ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–è€…å³å¯è¯»åˆå¯å†™ã€‚ä½¿ç”¨æµçš„ä¸€ä¸ªå¥½å¤„æ˜¯å®ƒå¯ä»¥å‡å°‘å†…å­˜å ç”¨ï¼Œå› ä¸ºä½ ä¸éœ€è¦ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><h3 id="writable-streams" tabindex="-1"><a class="header-anchor" href="#writable-streams"><span>Writable Streams</span></a></h3><p>Writable streams æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œå…è®¸ä½ å‘æŸä¸ªç›®çš„åœ°å†™å…¥æ•°æ®ã€‚æ¯”å¦‚ï¼Œè¿™ä¸ªç›®çš„åœ°å¯ä»¥æ˜¯æ–‡ä»¶ã€HTTP å“åº”ä½“æˆ–è€…ç”šè‡³æ˜¯æ§åˆ¶å°ã€‚</p><h3 id="getwriter-æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#getwriter-æ–¹æ³•"><span><code>getWriter()</code> æ–¹æ³•</span></a></h3><p><code>getWriter()</code> æ–¹æ³•æ˜¯ <code>WritableStream</code> çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒè¿”å›ä¸€ä¸ª <code>writer</code> å¯¹è±¡ï¼Œç”¨äºå‘æµä¸­å†™å…¥æ•°æ®ã€‚ä¸€æ—¦ä½ è·å¾—äº†è¿™ä¸ª <code>writer</code>ï¼Œä½ å°±å¯ä»¥ç”¨å®ƒæ¥å‘é€æ•°æ®ï¼Œå¹¶ä¸”å½“ä¸å†éœ€è¦å†™å…¥æ—¶å…³é—­æµã€‚</p><p>è¿™å¬èµ·æ¥å¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬é€šè¿‡ä¸€äº›ä¾‹å­æ¥å…·ä½“è¯´æ˜ã€‚</p><h4 id="å®é™…è¿ç”¨ç¤ºä¾‹-7" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-7"><span>å®é™…è¿ç”¨ç¤ºä¾‹ï¼š</span></a></h4><h5 id="ç¤ºä¾‹-1-å‘æ–‡ä»¶ä¸­å†™å…¥æ•°æ®" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-1-å‘æ–‡ä»¶ä¸­å†™å…¥æ•°æ®"><span>ç¤ºä¾‹ 1ï¼šå‘æ–‡ä»¶ä¸­å†™å…¥æ•°æ®</span></a></h5><p>å‡è®¾ä½ æƒ³æŠŠä¸€äº›æ–‡æœ¬æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚åœ¨ Node.js ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>fs.createWriteStream</code> æ¥åˆ›å»ºä¸€ä¸ªæŒ‡å‘è¯¥æ–‡ä»¶çš„ writable streamã€‚ç„¶åï¼Œä½¿ç”¨ <code>getWriter()</code> è·å–ä¸€ä¸ª writerï¼Œè¿›è€Œä½¿ç”¨å®ƒæ¥å†™å…¥æ•°æ®ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> WritableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªæŒ‡å‘file.txtçš„writable stream</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">file.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// æ–°çš„ Web Streams API è½¬æ¥</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> WritableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  write</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#88C0D0;">  close</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è·å–writer</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨writerå†™å…¥æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9;">writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, World!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼šä¸Šè¿°ä»£ç æ¼”ç¤ºäº†å¦‚ä½•å°† Node.js çš„ä¼ ç»Ÿæµé€‚é…åˆ° Web Streams APIã€‚</p><h5 id="ç¤ºä¾‹-2-http-å“åº”" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-2-http-å“åº”"><span>ç¤ºä¾‹ 2ï¼šHTTP å“åº”</span></a></h5><p>åœ¨ä¸€ä¸ª Node.js æœåŠ¡å™¨ä¸­ï¼ŒHTTP å“åº”å¯¹è±¡ (<code>response</code>) ä¹Ÿæ˜¯ä¸€ä¸ª writable streamã€‚å› æ­¤ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>getWriter()</code> è·å–ä¸€ä¸ª writer æ¥å‘å®¢æˆ·ç«¯å‘é€æ•°æ®ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> http</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">http</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">http</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">createServer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">request</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å‡è®¾è¿™é‡Œæˆ‘ä»¬ç›´æ¥æ“ä½œresponseä½œä¸ºstreamï¼ˆåœ¨å®è·µä¸­å¯èƒ½éœ€æ›´å¤æ‚ï¼‰</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> writable</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> response</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // ç”±äºHTTPå“åº”ä¸ç›´æ¥æ”¯æŒgetWriterï¼Œæˆ‘ä»¬ä¸ä¼šç›´æ¥ç”¨getWriter()åœ¨è¿™é‡Œã€‚</span></span>
<span class="line"><span style="color:#616E88;">    // ä½†æ˜¯ï¼Œå¦‚æœresponseè¢«åŒ…è£…ä¸ºæ”¯æŒWeb Streams APIçš„writableStreamï¼Œåˆ™å¯ä»¥ä½¿ç”¨ã€‚</span></span>
<span class="line"><span style="color:#616E88;">    // è¿™ä¸ªä¾‹å­ä¸»è¦æ˜¯ä¸ºäº†è¯´æ˜åŸç†ã€‚</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">    response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">writeHead</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">200</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Content-Type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">text/plain</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, World!</span><span style="color:#EBCB8B;">\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">listen</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">8080</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Server running at http://127.0.0.1:8080/</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ç¬¬äºŒä¸ªä¾‹å­è™½ç„¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨<code>getWriter()</code>ï¼Œä½†æ˜¯å¸Œæœ›ä½ èƒ½ç†è§£åœ¨ HTTP å“åº”ä¸­æµçš„æ¦‚å¿µã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>writableStream.getWriter()</code> æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œå®ƒå…è®¸ä½ ä»¥ä¸€ç§æµå¼çš„æ–¹å¼æ¥å¤„ç†æ•°æ®è¾“å‡ºã€‚æ— è®ºæ˜¯å†™å…¥æ–‡ä»¶è¿˜æ˜¯å‘é€ HTTP å“åº”ï¼Œç†è§£å’Œåˆ©ç”¨å¥½è¿™ä¸ªæ–¹æ³•éƒ½èƒ½è®©ä½ çš„ Node.js åº”ç”¨æ›´åŠ é«˜æ•ˆã€‚</p><h4 id="writablestream-locked" tabindex="-1"><a class="header-anchor" href="#writablestream-locked"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#writablestreamlocked" target="_blank" rel="noopener noreferrer">writableStream.locked</a></span></a></h4><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬ä»¥ç®€å•æ˜äº†çš„æ–¹å¼æ¥è§£é‡Š <code>writableStream.locked</code> å±æ€§ï¼Œå¹¶é€šè¿‡ä¸€äº›å®é™…ä¾‹å­åŠ æ·±ç†è§£ã€‚</p><h3 id="åŸºç¡€æ¦‚å¿µ-5" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ-5"><span>åŸºç¡€æ¦‚å¿µ</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œ<code>Stream</code>ï¼ˆæµï¼‰æ˜¯å¤„ç†æ•°æ®çš„ä¸€ç§æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯å½“ä½ ä¸éœ€è¦ä¸€æ¬¡æ€§è·å–æ‰€æœ‰æ•°æ®æ—¶ã€‚æµå¯ä»¥åˆ†ä¸ºå¯è¯»æµã€å¯å†™æµå’ŒåŒå‘æµç­‰ç±»å‹ã€‚å®ƒä»¬åˆ†åˆ«ç”¨äºè¯»å–æ•°æ®ã€å†™å…¥æ•°æ®å’ŒåŒæ—¶è¿›è¡Œè¯»å†™æ“ä½œã€‚</p><p>å½“æˆ‘ä»¬è°ˆåˆ° <code>WritableStream</code>ï¼Œæˆ‘ä»¬æŒ‡çš„æ˜¯ä¸€ä¸ªå¯å†™æµï¼Œå³æ•°æ®å¯ä»¥è¢«å†™å…¥çš„ç›®æ ‡ã€‚è¿™ç§æµéå¸¸é€‚ç”¨äºå¤„ç†å¤§é‡æ•°æ®ï¼Œæ¯”å¦‚æ–‡ä»¶å†™å…¥ã€ç½‘ç»œè¯·æ±‚ç­‰ã€‚</p><h3 id="writablestream-locked-1" tabindex="-1"><a class="header-anchor" href="#writablestream-locked-1"><span>writableStream.locked</span></a></h3><p><code>writableStream.locked</code> æ˜¯ä¸€ä¸ªå±æ€§ï¼Œå®ƒè¡¨æ˜æµæ˜¯å¦è¢«é”å®šã€‚å¦‚æœè¯¥å€¼ä¸º <code>true</code>ï¼Œåˆ™è¡¨ç¤ºæµå½“å‰å¤„äºé”å®šçŠ¶æ€ï¼Œæ— æ³•è¢«å†æ¬¡å†™å…¥ï¼›å¦‚æœä¸º <code>false</code>ï¼Œåˆ™è¡¨ç¤ºæµæœªè¢«é”å®šï¼Œå¯ä»¥æ­£å¸¸å†™å…¥æ•°æ®ã€‚</p><p>æµè¢«é”å®šé€šå¸¸æ˜¯å› ä¸ºæ­£åœ¨è¿›è¡Œå†™å…¥æ“ä½œï¼Œæˆ–è€…å·²ç»è°ƒç”¨äº†æŸäº›æ§åˆ¶æµçš„æ–¹æ³•ï¼ˆå¦‚è·å–å†™å…¥å™¨å¹¶å¼€å§‹ä½¿ç”¨å®ƒï¼‰ã€‚</p><h3 id="å®é™…ä¾‹å­-5" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-5"><span>å®é™…ä¾‹å­</span></a></h3><p>è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªåœºæ™¯ï¼Œå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£ <code>writableStream.locked</code> çš„ä½œç”¨ï¼š</p><h4 id="ä¾‹å­-1-åŸºç¡€æ–‡ä»¶å†™å…¥" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-åŸºç¡€æ–‡ä»¶å†™å…¥"><span>ä¾‹å­ 1ï¼šåŸºç¡€æ–‡ä»¶å†™å…¥</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦æŠŠæ—¥å¿—ä¿¡æ¯å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯å†™æµå†™å…¥log.txtæ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">log.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">locked</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // falseï¼Œæœ€åˆå§‹çš„çŠ¶æ€ï¼Œæµæœªè¢«é”å®š</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å†™å…¥æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">è¿™æ˜¯ä¸€æ¡æ—¥å¿—è®°å½•</span><span style="color:#EBCB8B;">\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">throw</span><span style="color:#D8DEE9;"> err</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æ—¥å¿—å·²å†™å…¥</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å…³é—­æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¾‹å­-2-æ£€æŸ¥æµæ˜¯å¦è¢«é”å®š" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-æ£€æŸ¥æµæ˜¯å¦è¢«é”å®š"><span>ä¾‹å­ 2ï¼šæ£€æŸ¥æµæ˜¯å¦è¢«é”å®š</span></a></h4><p>æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼Œä½ æœ‰ä¸€ä¸ªæœåŠ¡ï¼Œå®ƒæ¥å—ç”¨æˆ·ä¸Šä¼ çš„æ•°æ®å¹¶å°†å…¶ä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ä¸ºäº†ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§ï¼Œä½ å¯èƒ½ä¼šæƒ³åœ¨æ¯æ¬¡å†™å…¥ä¹‹å‰æ£€æŸ¥æµæ˜¯å¦è¢«é”å®šã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯å†™æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">userdata.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> writeData</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">locked</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">    // æ£€æŸ¥æµæ˜¯å¦è¢«é”å®š</span></span>
<span class="line"><span style="color:#D8DEE9;">    stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">      if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">        console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">å†™å…¥å¤±è´¥:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">å†™å…¥æˆåŠŸ</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æµå½“å‰è¢«é”å®šï¼Œç¨åå†è¯•</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°è¯•å†™å…¥æ•°æ®</span></span>
<span class="line"><span style="color:#88C0D0;">writeData</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ç”¨æˆ·æ•°æ®...</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™äº›ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰ç›´æ¥ä½¿ç”¨ <code>writableStream.locked</code>ï¼Œå› ä¸ºåŸç”Ÿçš„ <code>fs.createWriteStream</code> å¹¶ä¸ç›´æ¥æä¾› <code>.locked</code> å±æ€§ï¼Œä½†æ¦‚å¿µä¸Šçš„ç±»ä¼¼æ“ä½œæ˜¯ç›¸åŒçš„ã€‚åœ¨å®é™…çš„ <code>Web Streams API</code>ï¼ˆé€šå¸¸ç”¨äºæµè§ˆå™¨ç¯å¢ƒï¼‰ä¸­ï¼Œ<code>.locked</code> å±æ€§ä¼šæ›´ç›´æ¥åœ°è¢«ä½¿ç”¨ã€‚</p><h3 id="æ€»ç»“-7" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-7"><span>æ€»ç»“</span></a></h3><p>ç†è§£æµçš„é”å®šçŠ¶æ€å¯¹äºæ§åˆ¶æ•°æ®çš„å†™å…¥æµç¨‹éå¸¸é‡è¦ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†é«˜å¹¶å‘å†™å…¥æˆ–éœ€è¦ç¡®ä¿æ•°æ®å®Œæ•´æ€§çš„åœºæ™¯ä¸‹ã€‚é€šè¿‡æ£€æŸ¥ <code>writableStream.locked</code> å±æ€§ï¼Œå¼€å‘è€…å¯ä»¥é¿å…æ•°æ®å†™å…¥å†²çªï¼Œç¡®ä¿åº”ç”¨ç¨‹åºçš„å¥å£®æ€§å’Œæ•°æ®çš„ä¸€è‡´æ€§ã€‚</p><h4 id="transferring-with-postmessage-1" tabindex="-1"><a class="header-anchor" href="#transferring-with-postmessage-1"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#transferring-with-postmessage_1" target="_blank" rel="noopener noreferrer">Transferring with postMessage()</a></span></a></h4><p>ç†è§£ Node.js ä¸­<code>postMessage()</code>æ–¹æ³•å’Œæ•°æ®ä¼ è¾“çš„æ¦‚å¿µï¼Œé¦–å…ˆå¾—çŸ¥é“ä¸€äº›åŸºæœ¬çš„èƒŒæ™¯ä¿¡æ¯ã€‚åœ¨ Web å¼€å‘ä¸­ï¼Œç»å¸¸éœ€è¦åœ¨ä¸åŒçš„ç¯å¢ƒæˆ–ä¸Šä¸‹æ–‡ä¹‹é—´ä¼ é€’æ•°æ®ï¼Œæ¯”å¦‚ä»ä¸€ä¸ª Web Worker åˆ°ä¸»çº¿ç¨‹ï¼Œæˆ–è€…åœ¨æœåŠ¡å™¨ç«¯çš„ä¸åŒç»„ä»¶ä¹‹é—´ã€‚ä¸ºäº†æœ‰æ•ˆåœ°ä¼ è¾“å¤§é‡æ•°æ®æˆ–å¤æ‚å¯¹è±¡ï¼Œ<code>postMessage()</code>æ–¹æ³•æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå®ƒå¯ä»¥è®©æˆ‘ä»¬åœ¨ä¸åŒçš„æ‰§è¡Œç¯å¢ƒä¹‹é—´å¼‚æ­¥ä¼ é€’æ•°æ®ã€‚</p><p>åœ¨ Node.js v21.7.1 ç‰ˆæœ¬ä¸­ï¼Œä¸ Web Streams ç›¸å…³çš„<code>postMessage()</code>æ–¹æ³•å…è®¸ä½ åœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ï¼ˆå¦‚ Worker çº¿ç¨‹ï¼‰ä¹‹é—´ä¼ è¾“æµï¼ˆStreamsï¼‰å¯¹è±¡ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªæ•°æ®æµï¼Œåœ¨ä¸€ä¸ªç¯å¢ƒä¸­å¼€å§‹äº§ç”Ÿæ•°æ®ï¼Œå¹¶å°†è¿™ä¸ªæµä¼ è¾“åˆ°å¦ä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­å»ï¼Œè€Œä¸éœ€è¦å°†æ•°æ®å…¨éƒ¨ç¼“å­˜èµ·æ¥å†è¿›è¡Œä¼ è¾“ã€‚</p><h3 id="å®é™…è¿ç”¨ä¾‹å­-13" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-13"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£åœ¨æ„å»ºä¸€ä¸ª Node.js åº”ç”¨ï¼Œè¯¥åº”ç”¨éœ€è¦å¤„ç†å¤§é‡çš„æ—¥å¿—æ–‡ä»¶å¹¶åˆ†æå®ƒä»¬ã€‚è¿™ä¸ªè¿‡ç¨‹å¯èƒ½éå¸¸æ¶ˆè€— CPU èµ„æºï¼Œå› æ­¤ä½ å†³å®šä½¿ç”¨ Worker Threadsï¼ˆå·¥ä½œçº¿ç¨‹ï¼‰æ¥å¹¶è¡Œå¤„ç†æ—¥å¿—æ–‡ä»¶ï¼Œä»¥é¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚è¿™é‡Œå°±å¯ä»¥ä½¿ç”¨<code>postMessage()</code>æ¥ä¼ è¾“æµå¯¹è±¡ã€‚</p><p><strong>ä¸»çº¿ç¨‹ä»£ç ç¤ºä¾‹:</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> Worker</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">worker_threads</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> createReadStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> path</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªWorker</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> worker</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Worker</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./worker.js</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªè¯»å–æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">path</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">resolve</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">__dirname</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">log.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨postMessageæ–¹æ³•å°†æµå¯¹è±¡ä¼ è¾“ç»™Worker</span></span>
<span class="line"><span style="color:#D8DEE9;">worker</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">postMessage</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> [</span><span style="color:#D8DEE9;">stream</span><span style="color:#D8DEE9FF;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">worker</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">message</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">result</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">å¤„ç†ç»“æœ: </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">result</span><span style="color:#81A1C1;">}</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Worker çº¿ç¨‹ä»£ç ç¤ºä¾‹ (<code>worker.js</code>):</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> parentPort</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">worker_threads</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ç›‘å¬æ¥è‡ªä¸»çº¿ç¨‹çš„æ¶ˆæ¯</span></span>
<span class="line"><span style="color:#D8DEE9;">parentPort</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">once</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">message</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> async</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  let</span><span style="color:#D8DEE9;"> data</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // æ¥æ”¶æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">  for</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;"> of</span><span style="color:#D8DEE9;"> stream</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">    data</span><span style="color:#81A1C1;"> +=</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // å‡è®¾è¿™é‡Œè¿›è¡Œä¸€äº›æ•°æ®å¤„ç†</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> result</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> processData</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // å°†å¤„ç†åçš„ç»“æœå‘é€å›ä¸»çº¿ç¨‹</span></span>
<span class="line"><span style="color:#D8DEE9;">  parentPort</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">postMessage</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">result</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> processData</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // è¿™é‡Œæ˜¯æ•°æ®å¤„ç†çš„é€»è¾‘</span></span>
<span class="line"><span style="color:#81A1C1;">  return</span><span style="color:#ECEFF4;"> `</span><span style="color:#A3BE8C;">å¤„ç†åçš„æ•°æ®é•¿åº¦: </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">data</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">length</span><span style="color:#81A1C1;">}</span><span style="color:#ECEFF4;">`</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä»ä¸»çº¿ç¨‹åˆ›å»ºäº†ä¸€ä¸ªè¯»å–æµ(<code>createReadStream</code>)æ¥è¯»å–æ—¥å¿—æ–‡ä»¶ï¼Œç„¶åé€šè¿‡<code>postMessage()</code>æ–¹æ³•å°†è¿™ä¸ªæµä¼ è¾“ç»™äº†ä¸€ä¸ª Worker çº¿ç¨‹ã€‚åœ¨ Worker çº¿ç¨‹å†…éƒ¨ï¼Œæˆ‘ä»¬æ¥æ”¶åˆ°è¿™ä¸ªæµå¹¶å¯¹å…¶è¿›è¡Œè¿­ä»£ï¼Œå°±å¥½åƒç›´æ¥åœ¨ Worker çº¿ç¨‹ä¸­æ‰“å¼€æ–‡ä»¶ä¸€æ ·ã€‚è¿™æ ·åšçš„ä¼˜ç‚¹æ˜¯ï¼ŒåŸå§‹æ•°æ®æµä¸å¿…å®Œå…¨è¯»å…¥å†…å­˜å°±å¯ä»¥è¿›è¡Œå¤„ç†ï¼Œå‡å°‘äº†èµ„æºæ¶ˆè€—ï¼Œå¹¶å…è®¸åœ¨ä¸»çº¿ç¨‹å’Œ Worker çº¿ç¨‹ä¹‹é—´é«˜æ•ˆåœ°ä¼ é€’å¤§é‡æ•°æ®ã€‚</p><p>æ€»ç»“èµ·æ¥ï¼Œ<code>postMessage()</code>æ–¹æ³•åŠæµçš„ä¼ è¾“åŠŸèƒ½ï¼Œè®© Node.js åº”ç”¨èƒ½å¤Ÿæ›´é«˜æ•ˆã€æ›´çµæ´»åœ°å¤„ç†å¤§é‡æ•°æ®å’Œè´Ÿè½½ï¼Œç‰¹åˆ«æ˜¯åœ¨æ¶‰åŠåˆ°å¤šçº¿ç¨‹å¤„ç†æ—¶ã€‚</p><h3 id="class-writablestreamdefaultwriter" tabindex="-1"><a class="header-anchor" href="#class-writablestreamdefaultwriter"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-writablestreamdefaultwriter" target="_blank" rel="noopener noreferrer">Class: WritableStreamDefaultWriter</a></span></a></h3><p>äº†è§£<code>WritableStreamDefaultWriter</code>ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸¤ä¸ªæ¦‚å¿µï¼š<strong>æµ(Stream)<strong>å’Œ</strong>Node.js ä¸­çš„ Web Streams API</strong>ã€‚</p><h3 id="æµ-stream" tabindex="-1"><a class="header-anchor" href="#æµ-stream"><span>æµï¼ˆStreamï¼‰</span></a></h3><p>åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œæµæ˜¯ä¸€ç³»åˆ—æ•°æ®å…ƒç´ ï¼Œè¿™äº›æ•°æ®å…ƒç´ å¯ä»¥ä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«è®¿é—®ã€‚å®ƒä»¬é€šå¸¸ç”¨äºå¤„ç†åƒæ–‡ä»¶æˆ–ç½‘ç»œä¼ è¾“è¿™æ ·çš„å¤§å‹æ•°æ®ï¼Œå› ä¸ºä½ å¯ä»¥é€å—è¯»å–æˆ–å†™å…¥æ•°æ®ï¼Œè€Œä¸å¿…ä¸€æ¬¡æ€§å°†å…¨éƒ¨å†…å®¹åŠ è½½åˆ°å†…å­˜ä¸­ã€‚è¿™å¯¹äºå¤„ç†å¤§é‡æ•°æ®éå¸¸æœ‰ç”¨ï¼Œæ—¢èƒ½æé«˜æ•ˆç‡ä¹Ÿèƒ½èŠ‚çœèµ„æºã€‚</p><h3 id="web-streams-api-1" tabindex="-1"><a class="header-anchor" href="#web-streams-api-1"><span>Web Streams API</span></a></h3><p>Web Streams API æä¾›äº†æ„å»ºæµå¼æ•°æ®å¤„ç†çš„æ ‡å‡†æ¥å£ï¼Œå…è®¸æ•°æ®ä»¥å¯æ§é€Ÿåº¦ç‰‡æ®µåœ°ä¼ è¾“ã€‚åœ¨ Node.js ä¸­ï¼Œè¿™å¥— API è¿˜åŒ…æ‹¬äº†ç‰¹å®šçš„ç±»å’Œæ–¹æ³•ï¼Œç”¨äºå¤„ç†æ•°æ®çš„è¯»å†™æ“ä½œã€‚</p><h3 id="writablestreamdefaultwriter-ç±»" tabindex="-1"><a class="header-anchor" href="#writablestreamdefaultwriter-ç±»"><span>WritableStreamDefaultWriter ç±»</span></a></h3><p><code>WritableStreamDefaultWriter</code> æ˜¯ Web Streams API çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå‘å¯å†™æµï¼ˆWritable Streamï¼‰å†™å…¥æ•°æ®ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒæä¾›äº†ä¸€ç§æ–¹æ³•ï¼Œå…è®¸ä½ ä»¥æµå¼çš„æ–¹å¼å†™å…¥æ•°æ®ï¼Œæ¯”å¦‚åˆ°ä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç½‘ç»œè¯·æ±‚ç­‰ã€‚</p><h4 id="ä¸»è¦æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#ä¸»è¦æ–¹æ³•"><span>ä¸»è¦æ–¹æ³•ï¼š</span></a></h4><ul><li><code>write(data)</code>: å°†æ•°æ®å†™å…¥æµä¸­ã€‚</li><li><code>close()</code>: å…³é—­æµï¼Œå®Œæˆå†™æ“ä½œã€‚</li><li><code>abort(reason)</code>: å–æ¶ˆå†™æ“ä½œå¹¶å…³é—­æµï¼Œå¯é€‰åœ°æŒ‡æ˜åŸå› ã€‚</li></ul><h4 id="å®é™…è¿ç”¨ä¾‹å­-14" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-14"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h4><ol><li><p><strong>å‘æ–‡ä»¶å†™å…¥æ•°æ®</strong></p><p>å‡è®¾æˆ‘ä»¬æƒ³æŠŠä¸€äº›æ•°æ®æµå¼å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ä½¿ç”¨<code>WritableStreamDefaultWriter</code>ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªæµå†™å…¥å™¨ï¼Œç„¶åä½¿ç”¨å®ƒæ¥é€æ­¥å°†æ•°æ®å†™å…¥æ–‡ä»¶ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> WritableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> writeToFile</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> filePath</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // åˆ›å»ºæ–‡ä»¶æµ</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">filePath</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">  // é€šè¿‡æ–‡ä»¶æµåˆ›å»º WritableStreamDefaultWriter</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> writer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å†™å…¥æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9;"> writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // å®Œæˆåå…³é—­æµ</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9;"> writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> catch</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">error</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">Failed to write: </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">error</span><span style="color:#81A1C1;">}</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // å‡ºé”™æ—¶å–æ¶ˆæ“ä½œ</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9;"> writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">abort</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨å‡½æ•°å†™å…¥æ•°æ®åˆ° &#39;example.txt&#39;</span></span>
<span class="line"><span style="color:#88C0D0;">writeToFile</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, World!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">example.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>åœ¨ HTTP è¯·æ±‚ä¸­ä½¿ç”¨</strong></p><p>å½“ä½ éœ€è¦ä¸Šä¼ å¤§é‡æ•°æ®ï¼Œæ¯”å¦‚ä¸€ä¸ªå¤§æ–‡ä»¶åˆ°æœåŠ¡å™¨ï¼Œå¯ä»¥ä½¿ç”¨<code>WritableStreamDefaultWriter</code>æŒ‰å—å†™å…¥æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾è¿™æ˜¯åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­è¿è¡Œçš„ä»£ç ç¤ºä¾‹</span></span>
<span class="line"><span style="color:#88C0D0;">fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">http://example.com/upload</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">  method</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">POST</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#88C0D0;">  body</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    async</span><span style="color:#88C0D0;"> start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">      const</span><span style="color:#D8DEE9;"> writer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">      for</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9;"> i</span><span style="color:#ECEFF4;"> `</span><span style="color:#A3BE8C;">&lt;</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9;"> largeDataBlocks</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">length</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">        await</span><span style="color:#D8DEE9;"> writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">largeDataBlocks</span><span style="color:#D8DEE9FF;">[</span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#D8DEE9;">      writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>åœ¨ä»¥ä¸Šä¾‹å­ä¸­ï¼Œä½¿ç”¨<code>WritableStreamDefaultWriter</code>ä½¿å¾—æ•°æ®å¯ä»¥ä»¥æµçš„å½¢å¼è¢«å‘é€æˆ–å­˜å‚¨ï¼Œä»è€Œæ›´æœ‰æ•ˆåœ°å¤„ç†å¤§é‡æ•°æ®ã€‚</p><h4 id="new-writablestreamdefaultwriter-stream" tabindex="-1"><a class="header-anchor" href="#new-writablestreamdefaultwriter-stream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#new-writablestreamdefaultwriterstream" target="_blank" rel="noopener noreferrer">new WritableStreamDefaultWriter(stream)</a></span></a></h4><p>Node.js v21.7.1 å¼•å…¥çš„<code>WritableStreamDefaultWriter</code>æ˜¯ä¸€ä¸ªä¸ Web Streams API ç›¸å…³çš„å¯¹è±¡ï¼Œå®ƒæä¾›äº†ä¸€ç§æ§åˆ¶<code>WritableStream</code>ï¼ˆå¯å†™æµï¼‰çš„æ–¹æ³•å’Œæœºåˆ¶ã€‚åœ¨ Node.js ä¸­ï¼Œè¿™ä¸ªç‰¹æ€§å…è®¸æ‚¨ä»¥æ›´ç²¾ç»†çš„æ§åˆ¶å’Œé«˜æ•ˆçš„æ–¹å¼å¤„ç†æ•°æ®æµï¼Œæ¯”å¦‚æ–‡ä»¶å†™å…¥ã€ç½‘ç»œé€šä¿¡ç­‰ã€‚</p><h3 id="åŸºæœ¬æ¦‚å¿µ-3" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ¦‚å¿µ-3"><span>åŸºæœ¬æ¦‚å¿µ</span></a></h3><p>åœ¨æ·±å…¥è§£é‡Šä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š</p><ul><li><strong>æµ (Stream)</strong>ï¼šåœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯ä¸€ç³»åˆ—è¿ç»­çš„æ•°æ®ã€‚æƒ³è±¡ä¸€ä¸‹æ°´æµï¼Œæ•°æ®å°±åƒæ˜¯ä»ä¸€ä¸ªåœ°æ–¹â€œæµâ€åˆ°å¦ä¸€ä¸ªåœ°æ–¹ã€‚</li><li><strong>å¯å†™æµ (WritableStream)</strong>ï¼šè¿™æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œå…è®¸æ•°æ®è¢«å†™å…¥ã€‚ä¾‹å¦‚ï¼Œå½“ä½ æŠŠæ•°æ®å†™å…¥æ–‡ä»¶æˆ–è€…é€šè¿‡ç½‘ç»œå‘é€æ•°æ®æ—¶ï¼Œä½ å°±æ˜¯åœ¨ä½¿ç”¨å¯å†™æµã€‚</li></ul><h3 id="writablestreamdefaultwriterç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#writablestreamdefaultwriterç®€ä»‹"><span><code>WritableStreamDefaultWriter</code>ç®€ä»‹</span></a></h3><p><code>WritableStreamDefaultWriter</code>æ˜¯ä¸€ä¸ªç”¨äºæ“ä½œ<code>WritableStream</code>çš„å·¥å…·ï¼Œå®ƒæä¾›äº†å¤šç§æ–¹æ³•æ¥å†™å…¥æ•°æ®ã€å…³é—­æµç­‰ã€‚é€šè¿‡ä½¿ç”¨<code>WritableStreamDefaultWriter</code>ï¼Œå¼€å‘è€…å¯ä»¥è·å¾—å¯¹æµçš„æ›´ç›´æ¥æ§åˆ¶ï¼ŒåŒ…æ‹¬æµçš„å›å‹ç®¡ç†ï¼ˆå½“æµä¸èƒ½å¿«é€Ÿå¤„ç†æ•°æ®æ—¶çš„ç¼“å†²æœºåˆ¶ï¼‰ï¼Œä»¥åŠæ›´çµæ´»çš„é”™è¯¯å¤„ç†ã€‚</p><h3 id="ä½¿ç”¨å®ä¾‹" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨å®ä¾‹"><span>ä½¿ç”¨å®ä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦å°†å¤§é‡æ•°æ®å†™å…¥æ–‡ä»¶ã€‚ä½ å¯ä»¥åˆ©ç”¨<code>WritableStream</code>å’Œ<code>WritableStreamDefaultWriter</code>æ¥å®ç°è¿™ä¸€è¿‡ç¨‹ï¼Œä»£ç ç¤ºä¾‹å¯èƒ½å¦‚ä¸‹ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> WritableStreamDefaultWriter</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯å†™æµåˆ°æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> WritableStreamDefaultWriter</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">writableStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> writeData</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // å†™å…¥æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">  await</span><span style="color:#D8DEE9;"> writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, World!</span><span style="color:#EBCB8B;">\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  await</span><span style="color:#D8DEE9;"> writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Node.js streams are awesome!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // å…³é—­æµ</span></span>
<span class="line"><span style="color:#81A1C1;">  await</span><span style="color:#D8DEE9;"> writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">writeData</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡ Node.js çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆ<code>fs</code>æ¨¡å—ï¼‰åˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘æ–‡ä»¶<code>example.txt</code>çš„å¯å†™æµã€‚éšåï¼Œæˆ‘ä»¬å®ä¾‹åŒ–äº†ä¸€ä¸ª<code>WritableStreamDefaultWriter</code>å¯¹è±¡ï¼Œé€šè¿‡å®ƒä¸æµè¿›è¡Œäº¤äº’ã€‚æˆ‘ä»¬è°ƒç”¨<code>.write()</code>æ–¹æ³•å†™å…¥æ•°æ®ï¼Œå¹¶æœ€ç»ˆè°ƒç”¨<code>.close()</code>æ–¹æ³•ç»“æŸå†™å…¥å¹¶å…³é—­æµã€‚</p><h3 id="åº”ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨åœºæ™¯"><span>åº”ç”¨åœºæ™¯</span></a></h3><p><code>WritableStreamDefaultWriter</code>çš„åº”ç”¨åœºæ™¯éå¸¸å¹¿æ³›ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li><p><strong>æ–‡ä»¶å¤„ç†</strong>ï¼šå½“å¤„ç†æ–‡ä»¶å†™å…¥æ“ä½œæ—¶ï¼Œå°¤å…¶æ˜¯å¤§æ–‡ä»¶ï¼Œä½¿ç”¨æµå¯ä»¥é¿å…ä¸€æ¬¡æ€§åŠ è½½å¤ªå¤šæ•°æ®åˆ°å†…å­˜ä¸­ï¼Œé™ä½å†…å­˜å‹åŠ›ã€‚</p></li><li><p><strong>ç½‘ç»œé€šä¿¡</strong>ï¼šåœ¨å®ç° HTTP è¯·æ±‚æˆ– WebSocket é€šä¿¡æ—¶ï¼Œå‘é€å¤§é‡æ•°æ®æˆ–åˆ†å—æ•°æ®å¯ä»¥é€šè¿‡æµæ¥ä¼˜åŒ–ã€‚</p></li><li><p><strong>æ—¥å¿—è®°å½•</strong>ï¼šåœ¨åº”ç”¨ä¸­å®ç°æ—¥å¿—è®°å½•åŠŸèƒ½æ—¶ï¼Œå°†æ—¥å¿—æ¶ˆæ¯å†™å…¥åˆ°æ–‡ä»¶æˆ–è¿œç¨‹ç³»ç»Ÿï¼Œæµæä¾›äº†ä¸€ç§é«˜æ•ˆçš„æ–¹å¼ã€‚</p></li></ul><p>æ€»ä¹‹ï¼Œ<code>WritableStreamDefaultWriter</code>åœ¨ Node.js ä¸­ä¸ºå¤„ç†å„ç§æ•°æ®æµæä¾›äº†å¼ºå¤§ä¸”çµæ´»çš„å·¥å…·ï¼Œä½¿å¾—ç®¡ç†å¤§é‡æ•°æ®æˆ–å¤æ‚çš„ IO æ“ä½œå˜å¾—æ›´åŠ ç®€å•å’Œé«˜æ•ˆã€‚</p><h4 id="writablestreamdefaultwriter-abort-reason" tabindex="-1"><a class="header-anchor" href="#writablestreamdefaultwriter-abort-reason"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#writablestreamdefaultwriterabortreason" target="_blank" rel="noopener noreferrer">writableStreamDefaultWriter.abort([reason])</a></span></a></h4><p>å¥½çš„ï¼Œæˆ‘ä»¬æ¥èŠä¸€ä¸‹ Node.js ä¸­çš„ <code>WritableStreamDefaultWriter.abort([reason])</code> æ–¹æ³•ï¼Œä»¥åŠå®ƒåœ¨å®é™…åº”ç”¨ä¸­çš„ä½œç”¨ã€‚æˆ‘ä¼šå°½é‡è®©è§£é‡Šç®€å•æ˜“æ‡‚ã€‚</p><h3 id="æ¦‚å¿µç†è§£" tabindex="-1"><a class="header-anchor" href="#æ¦‚å¿µç†è§£"><span>æ¦‚å¿µç†è§£</span></a></h3><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬äº†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š</p><ol><li><p><strong>Streamsï¼ˆæµï¼‰</strong>ï¼šåœ¨ Node.js ä¸­ï¼Œ&quot;æµ&quot; æ˜¯å¤„ç†è¯»å†™æ•°æ®çš„ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µã€‚æƒ³è±¡ä¸€ä¸‹æ°´æµï¼Œæ•°æ®å°±åƒæ˜¯æµæ°´ä¸€æ ·ï¼Œå¯ä»¥ä»ä¸€ä¸ªåœ°æ–¹æµå‘å¦ä¸€ä¸ªåœ°æ–¹ã€‚è¿™å¯¹äºå¤„ç†å¤§é‡æ•°æ®æˆ–è€…ä½ éœ€è¦è¾¹æ¥æ”¶è¾¹å¤„ç†æ•°æ®çš„æƒ…å†µç‰¹åˆ«æœ‰ç”¨ã€‚</p></li><li><p><strong>Writable Streamï¼ˆå¯å†™æµï¼‰</strong>ï¼šå°±æ˜¯æ•°æ®å¯ä»¥æµå…¥çš„é‚£ä¸€ç«¯ã€‚æ¯”å¦‚ï¼Œå½“ä½ è¦æŠŠæ•°æ®å†™å…¥æ–‡ä»¶æ—¶ï¼Œé‚£ä¸ªæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªå¯å†™æµã€‚</p></li><li><p><strong>WritableStreamDefaultWriter</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªç”¨äºå‘å¯å†™æµä¸­å†™æ•°æ®çš„å·¥å…·ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªç¬”ï¼Œç”¨æ¥å¾€æˆ‘ä»¬çš„&quot;çº¸&quot;ï¼ˆå¯å†™æµï¼‰ä¸Šå†™å­—ã€‚</p></li></ol><p>ç°åœ¨ï¼Œ<code>WritableStreamDefaultWriter.abort([reason])</code> æ–¹æ³•å…è®¸ä½ ä¸­æ­¢å†™æ“ä½œï¼Œå¹¶ä¸”å¯ä»¥é€‰æ‹©æä¾›ä¸€ä¸ªåŸå› è¯´æ˜ä¸ºä»€ä¹ˆä¸­æ­¢ã€‚</p><h3 id="å®é™…ä¾‹å­-6" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-6"><span>å®é™…ä¾‹å­</span></a></h3><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªå°†è§†é¢‘ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„ç¨‹åºã€‚è§†é¢‘ä½œä¸ºæ•°æ®æµæ­£åœ¨è¢«ä¸Šä¼ ï¼ˆå†™å…¥ï¼‰ï¼Œä½†ç”±äºæŸç§åŸå› ï¼ˆæ¯”å¦‚ç”¨æˆ·å–æ¶ˆä¸Šä¼ æˆ–ç½‘ç»œé—®é¢˜ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦åœæ­¢ä¸Šä¼ è¿‡ç¨‹ã€‚</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>abort()</code> æ–¹æ³•æ¥ä¸­æ­¢æµçš„å†™å…¥æ“ä½œã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¸…ç†å·²ç»å ç”¨çš„èµ„æºï¼Œå¹¶ä¸”æ ¹æ®æä¾›çš„åŸå› ï¼Œæ¥æ‰§è¡Œå¿…è¦çš„é”™è¯¯å¤„ç†é€»è¾‘ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> WritableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸€ä¸ª writableStream</span></span>
<span class="line"><span style="color:#616E88;">// ä»£è¡¨æˆ‘ä»¬çš„æœåŠ¡å™¨æ¥æ”¶ä¸Šä¼ æ–‡ä»¶çš„åœ°æ–¹</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // å‡è®¾è¿™é‡Œæ˜¯æˆ‘ä»¬ä¸Šä¼ æ•°æ®çš„é€»è¾‘</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;"> catch</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">error</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">  // å¦‚æœå‘ç”Ÿé”™è¯¯æˆ–ç”¨æˆ·å–æ¶ˆä¸Šä¼ ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ä¸­æ­¢å†™æ“ä½œ</span></span>
<span class="line"><span style="color:#D8DEE9;">  writer</span></span>
<span class="line"><span style="color:#ECEFF4;">    .</span><span style="color:#88C0D0;">abort</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Upload cancelled or network issue</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">    .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Write operation aborted successfully.</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">    .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Aborting write operation failed:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ€»ç»“-8" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-8"><span>æ€»ç»“</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œ<code>WritableStreamDefaultWriter.abort([reason])</code> æä¾›äº†ä¸€ç§ä¼˜é›…çš„æ–¹å¼æ¥ä¸­æ­¢æµçš„å†™å…¥æ“ä½œã€‚è¿™å¯¹äºå¤„ç†è¯¸å¦‚ç”¨æˆ·å–æ¶ˆæ“ä½œã€å‘ç°é”™è¯¯ç­‰æƒ…å†µéå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå…è®¸å¼€å‘è€…åŠæ—¶åœæ­¢æ“ä½œå¹¶è¿›è¡Œå¿…è¦çš„æ¸…ç†å·¥ä½œã€‚</p><p>é€šè¿‡æä¾›ä¸€ä¸ªåŸå› ï¼Œè¿™è¿˜å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°äº†è§£æ“ä½œä¸ºä½•è¢«ä¸­æ­¢ï¼Œä»è€Œèƒ½å¤Ÿé’ˆå¯¹æ€§åœ°å¤„ç†åç»­é€»è¾‘ï¼Œæ¯”å¦‚é€šçŸ¥ç”¨æˆ·ã€è®°å½•æ—¥å¿—ç­‰ã€‚</p><h4 id="writablestreamdefaultwriter-close" tabindex="-1"><a class="header-anchor" href="#writablestreamdefaultwriter-close"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#writablestreamdefaultwriterclose" target="_blank" rel="noopener noreferrer">writableStreamDefaultWriter.close()</a></span></a></h4><p>å¥½çš„ï¼Œæˆ‘å°†å°½é‡é€šä¿—æ˜“æ‡‚åœ°è§£é‡Šç»™ä½ ã€‚</p><p>é¦–å…ˆï¼Œä¸ºäº†ç†è§£ <code>writableStreamDefaultWriter.close()</code>ï¼Œå’±ä»¬å¾—å…ˆäº†è§£å‡ ä¸ªæ¦‚å¿µï¼šæµï¼ˆStreamsï¼‰ã€å¯å†™æµï¼ˆWritable Streamsï¼‰å’Œæµçš„å†™å…¥å™¨ï¼ˆWriterï¼‰ã€‚</p><p>**æµï¼ˆStreamsï¼‰**å°±åƒæ˜¯æ•°æ®çš„ç®¡é“ï¼Œå¯ä»¥æŠŠæ•°æ®ä»ä¸€ä¸ªåœ°æ–¹ä¼ è¾“åˆ°å¦ä¸€ä¸ªåœ°æ–¹ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰ä¸€ä¸ªæ°´æ¡¶ï¼ˆæ•°æ®æºï¼‰å’Œä¸€ä¸ªèŠ±å›­ï¼ˆç›®çš„åœ°ï¼‰ï¼Œè€Œä½ éœ€è¦ä¸€æ ¹è½¯ç®¡ï¼ˆæµï¼‰æ¥æŠŠæ°´ï¼ˆæ•°æ®ï¼‰ä»æ¡¶é‡Œè¾“é€åˆ°èŠ±å›­ä¸­ã€‚</p><p>åœ¨ Node.js ä¸­ï¼Œ**å¯å†™æµï¼ˆWritable Streamsï¼‰**å°±æ˜¯è¿™æ ·ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œå®ƒå…è®¸ä½ å¾€æŸä¸ªç›®çš„åœ°å†™å…¥æ•°æ®ã€‚è¿™ä¸ªâ€œç›®çš„åœ°â€å¯ä»¥æ˜¯æ–‡ä»¶ã€ç»ˆç«¯ï¼ˆæ§åˆ¶å°ï¼‰æˆ–è€…ç½‘ç»œè¿æ¥ç­‰ã€‚</p><p>è€Œ**æµçš„å†™å…¥å™¨ï¼ˆWriterï¼‰**åˆ™æ˜¯ç”¨äºå‘è¿™äº›å¯å†™æµä¸­å†™å…¥æ•°æ®çš„å·¥å…·ã€‚<code>writableStreamDefaultWriter</code>å°±æ˜¯è¿™æ ·ä¸€ä¸ªå†™å…¥å™¨çš„å®ä¾‹ï¼Œå®ƒæä¾›äº†å¤šç§æ–¹æ³•æ¥æ‰§è¡Œæ•°æ®å†™å…¥æ“ä½œï¼Œå…¶ä¸­<code>.close()</code>æ–¹æ³•ä¾¿æ˜¯æˆ‘ä»¬ä»Šå¤©è¦é‡ç‚¹è®²è§£çš„ã€‚</p><h3 id="writablestreamdefaultwriter-close-1" tabindex="-1"><a class="header-anchor" href="#writablestreamdefaultwriter-close-1"><span>writableStreamDefaultWriter.close()</span></a></h3><p>å½“ä½ è°ƒç”¨<code>writableStreamDefaultWriter.close()</code>æ–¹æ³•æ—¶ï¼Œä½ å®é™…ä¸Šæ˜¯åœ¨å‘Šè¯‰æµï¼šâ€œå¥½äº†ï¼Œæˆ‘å®Œæˆäº†æ•°æ®å†™å…¥ï¼Œä¸ä¼šå†å‘é€ä»»ä½•æ•°æ®äº†â€ã€‚è¿™ç›¸å½“äºä½ å‘Šè¯‰è½¯ç®¡ï¼šâ€œåœæ­¢ä¾›æ°´â€ï¼Œé‚£ä¹ˆèŠ±å›­ï¼ˆç›®çš„åœ°ï¼‰å°±çŸ¥é“ç°åœ¨æ”¶åˆ°çš„æ°´å·²ç»æ˜¯å…¨éƒ¨äº†ï¼Œä¸ä¼šå†æœ‰æ›´å¤šæ°´è¿‡æ¥ã€‚</p><h4 id="å®é™…è¿ç”¨ä¾‹å­-15" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-15"><span>å®é™…è¿ç”¨ä¾‹å­ï¼š</span></a></h4><ol><li><p><strong>æ–‡ä»¶å†™å…¥</strong>ï¼šå‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œæ­¤åº”ç”¨éœ€è¦å°†æ—¥å¿—ä¿¡æ¯å†™å…¥åˆ°ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ä¸­ã€‚ä½¿ç”¨<code>writableStreamDefaultWriter.close()</code>èƒ½å¤Ÿç¡®ä¿åœ¨æ‰€æœ‰æ—¥å¿—ä¿¡æ¯å†™å…¥å®Œæ¯•åï¼Œæ–‡ä»¶è¢«æ­£ç¡®å…³é—­ï¼Œè¿™æ ·å°±ä¸ä¼šé€ æˆèµ„æºæ³„éœ²æˆ–è€…æ•°æ®ä¸¢å¤±ã€‚</p></li><li><p><strong>ç½‘ç»œè¯·æ±‚å¤„ç†</strong>ï¼šå¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªæœåŠ¡å™¨åº”ç”¨ï¼Œè¯¥åº”ç”¨éœ€è¦å‘å®¢æˆ·ç«¯å‘é€æ•°æ®ã€‚ä¸€æ—¦æœåŠ¡å™¨å®Œæˆäº†æ•°æ®çš„å‘é€ï¼Œä½¿ç”¨<code>.close()</code>æ–¹æ³•èƒ½å¤Ÿä¼˜é›…åœ°ç»“æŸè¿™ä¸ªæ•°æ®ä¼ è¾“è¿‡ç¨‹ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯æ‰€æœ‰çš„æ•°æ®å·²ç»å‘é€å®Œæ¯•ã€‚</p></li><li><p><strong>æ§åˆ¶å°æ—¥å¿—</strong>ï¼šè™½ç„¶æ§åˆ¶å°è¾“å‡ºï¼ˆå¦‚<code>console.log</code>ï¼‰ä¸å¸¸ç”¨æµçš„å½¢å¼ï¼Œä½†å¦‚æœæ¶‰åŠåˆ°é«˜çº§æ—¥å¿—ç®¡ç†ï¼Œå¯èƒ½ä¼šä½¿ç”¨åˆ°æµã€‚å®Œæˆæ—¥å¿—çš„è®°å½•åä½¿ç”¨<code>.close()</code>ç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œåº”ç”¨çš„æ€§èƒ½ã€‚</p></li></ol><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>writableStreamDefaultWriter.close()</code>åœ¨ Node.js ä¸­çš„è¿ç”¨åœºæ™¯éå¸¸å¹¿æ³›ï¼Œæ— è®ºæ˜¯æ–‡ä»¶æ“ä½œã€ç½‘ç»œé€šä¿¡è¿˜æ˜¯æ—¥å¿—ç®¡ç†ï¼Œå®ƒéƒ½æ‰®æ¼”ç€â€œå®Œæˆå†™å…¥ï¼Œå®‰å…¨å…³é—­â€çš„è§’è‰²ã€‚è¿™ä¿è¯äº†æ•°æ®çš„å®Œæ•´æ€§å’Œåº”ç”¨çš„ç¨³å®šæ€§ã€‚</p><h4 id="writablestreamdefaultwriter-closed" tabindex="-1"><a class="header-anchor" href="#writablestreamdefaultwriter-closed"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#writablestreamdefaultwriterclosed" target="_blank" rel="noopener noreferrer">writableStreamDefaultWriter.closed</a></span></a></h4><p>Node.js ä¸­çš„ <code>writableStreamDefaultWriter.closed</code> æ˜¯ä¸ Web Streams API ç›¸å…³çš„ä¸€ä¸ªæ¦‚å¿µã€‚ä¸ºäº†æ›´å¥½åœ°ç†è§£è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•è§£é‡Šå‡ ä¸ªç›¸å…³çš„æ¦‚å¿µï¼š</p><ol><li><p><strong>Streamsï¼ˆæµï¼‰</strong>ï¼šåœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯ä¸€ç§æŠ½è±¡æ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯æ•°æ®çš„è¿ç»­ä¼ é€’ã€‚æƒ³è±¡ä¸€ä¸‹æ°´æµï¼Œæ•°æ®å°±åƒæ°´ä¸€æ ·ä»ä¸€ä¸ªåœ°æ–¹æµå‘å¦ä¸€ä¸ªåœ°æ–¹ã€‚</p></li><li><p><strong>Writable Streamsï¼ˆå¯å†™æµï¼‰</strong>ï¼šè¿™æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œå…è®¸æ•°æ®è¢«å†™å…¥ã€‚ä¾‹å¦‚ï¼Œå½“ä½ å‘æ–‡ä»¶å†™å…¥æ•°æ®æ—¶ï¼Œå°±å¯ä»¥ç”¨åˆ°å¯å†™æµã€‚</p></li><li><p><strong>WritableStreamDefaultWriter</strong>ï¼šè¿™æ˜¯ç”¨äºå‘å¯å†™æµå†™å…¥æ•°æ®çš„å·¥å…·æˆ–æ¥å£ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å‘æŸä¸ªæµå†™å…¥æ•°æ®ã€‚</p></li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä¸“æ³¨äºä½ é—®çš„ <code>WritableStreamDefaultWriter.closed</code> å±æ€§ã€‚</p><h3 id="writablestreamdefaultwriter-closed-1" tabindex="-1"><a class="header-anchor" href="#writablestreamdefaultwriter-closed-1"><span>writableStreamDefaultWriter.closed</span></a></h3><ul><li><p><strong>å®šä¹‰</strong>ï¼š<code>closed</code> æ˜¯ <code>WritableStreamDefaultWriter</code> çš„ä¸€ä¸ªå±æ€§ï¼Œå®ƒè¿”å›ä¸€ä¸ª Promiseã€‚è¿™ä¸ª Promise ä¼šåœ¨æµæˆåŠŸå…³é—­æˆ–è€…å› é”™è¯¯è¢«å…³é—­æ—¶è¢«è§£å†³ï¼ˆresolveï¼‰æˆ–æ‹’ç»ï¼ˆrejectï¼‰ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒè®©ä½ çŸ¥é“æµæ˜¯å¦å·²ç»å®Œæˆæ‰€æœ‰æ“ä½œå¹¶ä¸”å…³é—­äº†ã€‚</p></li><li><p><strong>ç”¨é€”</strong>ï¼šç›‘æ§æµçš„çŠ¶æ€ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>.closed</code> å±æ€§æ¥æ£€æŸ¥æµæ˜¯å¦å·²ç»å®Œå…¨å…³é—­ï¼Œè¿™å¯¹äºç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œå¤„ç†å¯èƒ½å‡ºç°çš„é”™è¯¯å¾ˆæœ‰å¸®åŠ©ã€‚</p></li></ul><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-8" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-8"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><p>æƒ³è±¡ä½ æ­£åœ¨æ„å»ºä¸€ä¸ªç½‘ç«™ï¼Œå¹¶ä¸”ä½ éœ€è¦å°†ç”¨æˆ·ä¸Šä¼ çš„å¤§å‹æ–‡ä»¶ä¿å­˜åˆ°æœåŠ¡å™¨ä¸­ã€‚ä½¿ç”¨ Node.js çš„ <code>WritableStream</code> å¯ä»¥éå¸¸é«˜æ•ˆåœ°å¤„ç†è¿™ç§æƒ…å†µï¼Œå› ä¸ºå®ƒå…è®¸ä½ è¾¹æ¥æ”¶æ•°æ®è¾¹å¤„ç†æ•°æ®ï¼Œè€Œä¸æ˜¯ç­‰å¾…æ•´ä¸ªæ–‡ä»¶éƒ½ä¸Šä¼ å®Œæ¯•ã€‚</p><h4 id="ç¤ºä¾‹ä»£ç ç‰‡æ®µ" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹ä»£ç ç‰‡æ®µ"><span>ç¤ºä¾‹ä»£ç ç‰‡æ®µ</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªç”¨äºå†™å…¥çš„æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fileWriter</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è·å– writer å¯¹è±¡</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fileWriter</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ç›‘å¬æµæ˜¯å¦å…³é—­</span></span>
<span class="line"><span style="color:#D8DEE9;">writer</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">closed</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æ–‡ä»¶å†™å…¥å®Œæ¯•ï¼Œæµå·²å…³é—­ï¼</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æµå…³é—­æ—¶å‘ç”Ÿé”™è¯¯ï¼š</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å†™å…¥æ•°æ®åˆ°æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">writer</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, Node.js!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æ•°æ®å†™å…¥æˆåŠŸï¼</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">å†™å…¥æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼š</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// æœ€åï¼Œå…³é—­æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º <code>example.txt</code> çš„æ–‡ä»¶ï¼Œå¹¶é€šè¿‡ <code>WritableStream</code> çš„ <code>getWriter</code> æ–¹æ³•è·å–äº†ä¸€ä¸ª <code>writer</code> å¯¹è±¡ã€‚ç„¶åï¼Œæˆ‘ä»¬åˆ©ç”¨è¿™ä¸ª <code>writer</code> å‘æ–‡ä»¶ä¸­å†™å…¥æ•°æ®ã€‚é€šè¿‡ç›‘å¬ <code>writer.closed</code> å±æ€§è¿”å›çš„ Promiseï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“æµä½•æ—¶æˆåŠŸå…³é—­æˆ–è€…æ˜¯å¦å› ä¸ºæŸäº›é”™è¯¯è€Œå…³é—­ã€‚</p><p>å¸Œæœ›è¿™èƒ½å¸®åŠ©ä½ ç†è§£ <code>WritableStreamDefaultWriter.closed</code> åœ¨ Node.js ä¸­çš„ä½œç”¨å’Œç”¨æ³•ï¼</p><h4 id="writablestreamdefaultwriter-desiredsize" tabindex="-1"><a class="header-anchor" href="#writablestreamdefaultwriter-desiredsize"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#writablestreamdefaultwriterdesiredsize" target="_blank" rel="noopener noreferrer">writableStreamDefaultWriter.desiredSize</a></span></a></h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥ç†è§£ Node.js ä¸­çš„<code>WritableStreamDefaultWriter.desiredSize</code>è¿™ä¸ªæ¦‚å¿µã€‚åœ¨ Node.js ä¸­ï¼Œæµï¼ˆStreamsï¼‰æ˜¯ä¸€ç§å¤„ç†è¯»å–å’Œå†™å…¥æ•°æ®çš„æœºåˆ¶ã€‚<code>WritableStreamDefaultWriter</code>æ˜¯ä¸€ä¸ªä¸å¯å†™æµï¼ˆWritable Streamï¼‰ç›¸å…³è”çš„å¯¹è±¡ï¼Œç”¨äºå‘æµä¸­å†™å…¥æ•°æ®ã€‚</p><h3 id="è§£é‡Š-desiredsize" tabindex="-1"><a class="header-anchor" href="#è§£é‡Š-desiredsize"><span>è§£é‡Š <code>desiredSize</code></span></a></h3><p><code>desiredSize</code>å±æ€§è¡¨ç¤ºäº†æµä¸­è¿˜èƒ½æ¥å—å¤šå°‘æ•°æ®ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œè€Œä¸ä¼šè¶…è¿‡å†…éƒ¨ç¼“å†²åŒºçš„å¤§å°é™åˆ¶ã€‚ç®€å•åœ°è¯´ï¼Œå®ƒå‘Šè¯‰ä½ å¯ä»¥å®‰å…¨åœ°å‘æµä¸­å†™å…¥å¤šå°‘é¢å¤–çš„æ•°æ®è€Œä¸å¼•èµ·é—®é¢˜ã€‚</p><p>å½“<code>desiredSize</code>ä¸ºæ­£æ•°æ—¶ï¼Œæ„å‘³ç€è¿˜æœ‰ç©ºé—´å¯ä»¥å†™å…¥æ•°æ®ï¼›å½“å…¶ä¸º 0 æ—¶ï¼Œæ„å‘³ç€ç¼“å†²åŒºå·²æ»¡ï¼›å¦‚æœä¸ºè´Ÿæ•°ï¼Œåˆ™è¡¨ç¤ºæ•°æ®å·²ç»è¶…å‡ºäº†æµçš„ç¼“å†²åŒºèƒ½åŠ›ï¼Œéœ€è¦ç­‰å¾…æµæ¶ˆè€—ä¸€äº›æ•°æ®åæ‰èƒ½ç»§ç»­å†™å…¥ã€‚</p><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-9" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-9"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><ol><li><p><strong>æ§åˆ¶æ•°æ®æµé‡</strong>ï¼šå½“ä½ æ­£åœ¨ä»ä¸€ä¸ªæ–‡ä»¶è¯»å–æ•°æ®å¹¶å°†å…¶å†™å…¥å¦ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œ<code>desiredSize</code>å¯ä»¥å¸®åŠ©ä½ æ§åˆ¶è¯»å–é€Ÿåº¦ï¼Œé¿å…å› ä¸ºå†™å…¥é€Ÿåº¦è·Ÿä¸ä¸Šè€Œå¯¼è‡´å¤§é‡æ•°æ®ç§¯ç´¯åœ¨å†…å­˜ä¸­ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ<code>desiredSize</code>å˜æˆé›¶æˆ–è´Ÿæ•°ï¼Œä½ å¯èƒ½æƒ³è¦æš‚åœè¯»å–ï¼Œç›´åˆ°<code>desiredSize</code>å†æ¬¡å˜ä¸ºæ­£å€¼ã€‚</p></li><li><p><strong>ç½‘ç»œè¯·æ±‚å¤„ç†</strong>ï¼šå‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js æœåŠ¡ï¼Œè¯¥æœåŠ¡æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„å¤§é‡æ•°æ®ï¼Œå¹¶å°†å…¶è½¬å‘åˆ°å¦ä¸€ä¸ªæœåŠ¡ã€‚ä½¿ç”¨<code>desiredSize</code>ï¼Œä½ å¯ä»¥ä¼˜åŒ–æ•°æ®ä¼ è¾“ï¼Œç¡®ä¿åœ¨ä¸è¶…è´Ÿè·æœ¬åœ°ç³»ç»Ÿæˆ–è¿œç«¯æœåŠ¡çš„æƒ…å†µä¸‹å¹³æ»‘åœ°è¿›è¡Œæ•°æ®è½¬å‘ã€‚</p></li><li><p><strong>å®æ—¶æ•°æ®å¤„ç†</strong>ï¼šå¦‚æœä½ åœ¨å¤„ç†å¦‚è§†é¢‘æµæˆ–å®æ—¶æ•°æ®åˆ†æçš„åº”ç”¨ç¨‹åºä¸­å·¥ä½œï¼Œ<code>desiredSize</code>å¯ä»¥å¸®åŠ©ä½ åŠ¨æ€è°ƒæ•´æ•°æ®çš„å¤„ç†é€Ÿç‡ï¼Œæ ¹æ®å½“å‰ç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›æ¥æ¥æ”¶æ–°æ•°æ®ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾æœ‰ä¸€ä¸ª writableStream</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> writeData</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">writer</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">desiredSize</span><span style="color:#81A1C1;"> &gt;</span><span style="color:#B48EAD;"> 0</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">    // æ£€æŸ¥æ˜¯å¦è¿˜èƒ½å†™å…¥æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9;">    writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å†™å…¥æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">The stream is full, waiting to drain</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    writer</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">ready</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#88C0D0;"> writeData</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // ç­‰å¾…å¯ä»¥å®‰å…¨å†™å…¥å†ç»§ç»­</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨writeDataå‡½æ•°æ¥å†™å…¥æ•°æ®</span></span>
<span class="line"><span style="color:#88C0D0;">writeData</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, Node.js Streams!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆè·å–æµçš„<code>writer</code>å¯¹è±¡ï¼Œç„¶åé€šè¿‡æ£€æŸ¥<code>desiredSize</code>æ¥åˆ¤æ–­æ˜¯å¦å¯ä»¥ç»§ç»­å®‰å…¨åœ°å†™å…¥æ•°æ®ã€‚å¦‚æœæµå·²æ»¡ï¼ˆ<code>desiredSize</code>å°äºæˆ–ç­‰äº 0ï¼‰ï¼Œæˆ‘ä»¬ç­‰å¾…<code>writer.ready</code> Promise è§£å†³ï¼Œè¿™æ„å‘³ç€æµå·²å‡†å¤‡å¥½æ¥æ”¶æ›´å¤šæ•°æ®ã€‚</p><p>æ€»ä¹‹ï¼Œ<code>WritableStreamDefaultWriter</code>çš„<code>desiredSize</code>å±æ€§æ˜¯æ§åˆ¶å’Œä¼˜åŒ–æ•°æ®æµçš„å¼ºå¤§å·¥å…·ï¼Œèƒ½è®©å¼€å‘è€…æ›´ç²¾ç»†åœ°ç®¡ç†æ•°æ®çš„å†™å…¥ï¼Œä»¥åŠå¦‚ä½•åŸºäºæµçš„å½“å‰çŠ¶æ€åŠ¨æ€è°ƒæ•´æ•°æ®å¤„ç†é€Ÿåº¦ã€‚</p><h4 id="writablestreamdefaultwriter-ready" tabindex="-1"><a class="header-anchor" href="#writablestreamdefaultwriter-ready"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#writablestreamdefaultwriterready" target="_blank" rel="noopener noreferrer">writableStreamDefaultWriter.ready</a></span></a></h4><p>åœ¨ Node.js ä¸­ï¼Œ<code>writableStreamDefaultWriter.ready</code>æ˜¯ä¸€ä¸ªå±æ€§ï¼Œå®ƒæ¶‰åŠåˆ°äº†æµï¼ˆStreamsï¼‰çš„æ¦‚å¿µã€‚ä¸ºäº†ç†è§£è¿™ä¸ªå±æ€§ï¼Œæˆ‘ä»¬å…ˆéœ€è¦æ˜ç™½ä¸€äº›åŸºç¡€ã€‚</p><h3 id="åŸºç¡€æ¦‚å¿µ-6" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ-6"><span>åŸºç¡€æ¦‚å¿µ</span></a></h3><h4 id="ä»€ä¹ˆæ˜¯æµ-streams-1" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯æµ-streams-1"><span>ä»€ä¹ˆæ˜¯æµï¼ˆStreamsï¼‰ï¼Ÿ</span></a></h4><p>åœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯ä¸€ç§æŠ½è±¡çš„æ•°æ®ç»“æ„ï¼Œç”¨æ¥è¯»å–æˆ–è€…å†™å…¥æ•°æ®ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œæ•°æ®å°±åƒæ°´æµä¸€æ ·ï¼Œä»ä¸€ä¸ªä½ç½®â€œæµåŠ¨â€åˆ°å¦ä¸€ä¸ªä½ç½®ã€‚æ¯”å¦‚ï¼Œä»æ–‡ä»¶è¯»å–æ•°æ®åˆ°å†…å­˜ä¸­ï¼Œæˆ–è€…å°†æ•°æ®ä»å†…å­˜å†™å…¥åˆ°æ–‡ä»¶ä¸­ã€‚</p><h4 id="writable-streams-1" tabindex="-1"><a class="header-anchor" href="#writable-streams-1"><span>Writable Streams</span></a></h4><p>Writable streams æ˜¯ä¸€ç§å¯ä»¥å‘å…¶ä¸­å†™å…¥æ•°æ®çš„æµã€‚ä¾‹å¦‚ï¼Œå½“ä½ æƒ³è¦å¾€æ–‡ä»¶é‡Œå†™å†…å®¹æˆ–è€…å‘ç½‘ç»œè¯·æ±‚ä½“å‘é€æ•°æ®æ—¶ï¼Œä½ ä¼šç”¨åˆ° writable streamsã€‚</p><h3 id="writablestreamdefaultwriter-ready-1" tabindex="-1"><a class="header-anchor" href="#writablestreamdefaultwriter-ready-1"><span><code>writableStreamDefaultWriter.ready</code></span></a></h3><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£ <code>writableStreamDefaultWriter.ready</code>ã€‚è¿™ä¸ªå±æ€§è¿”å›ä¸€ä¸ª Promiseï¼Œè¡¨ç¤ºå¯å†™æµï¼ˆwritable streamï¼‰å‡†å¤‡å¥½æ¥å—å’Œå¤„ç†æ–°çš„å†™æ“ä½œã€‚</p><p>æ¢å¥è¯è¯´ï¼Œ<code>ready</code> å±æ€§å‘Šè¯‰ä½ ä½•æ—¶å¯ä»¥å®‰å…¨åœ°å‘æµä¸­å†™å…¥æ–°çš„æ•°æ®å—ï¼Œè€Œä¸å¿…æ‹…å¿ƒè¶…å‡ºæµçš„å¤„ç†èƒ½åŠ›ã€‚</p><h4 id="å®ä¾‹åº”ç”¨" tabindex="-1"><a class="header-anchor" href="#å®ä¾‹åº”ç”¨"><span>å®ä¾‹åº”ç”¨</span></a></h4><h5 id="ä¾‹å­-1-å‘æ–‡ä»¶å†™å…¥æ•°æ®" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-å‘æ–‡ä»¶å†™å…¥æ•°æ®"><span>ä¾‹å­ 1ï¼šå‘æ–‡ä»¶å†™å…¥æ•°æ®</span></a></h5><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªåº”ç”¨ï¼Œéœ€è¦å°†å¤§é‡æ•°æ®å†™å…¥æ–‡ä»¶ã€‚å¦‚æœä¸€æ¬¡æ€§å†™å…¥è¿‡å¤šæ•°æ®ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¨‹åºç”¨å°½å†…å­˜æˆ–å½±å“æ€§èƒ½ã€‚ä½¿ç”¨ <code>ready</code> å±æ€§ï¼Œå¯ä»¥ç­‰å¾…æµå‡†å¤‡å¥½æ¥æ”¶æ–°æ•°æ®ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯å†™æµï¼ŒæŒ‡å‘è¾“å‡ºæ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">output.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> writeData</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // ç­‰å¾…æµå‡†å¤‡å¥½</span></span>
<span class="line"><span style="color:#81A1C1;">  await</span><span style="color:#D8DEE9;"> writer</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">ready</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">  // å†™å…¥æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9;">  writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">writeData</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, Node.js!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="ä¾‹å­-2-å‘å®¢æˆ·ç«¯å‘é€æ•°æ®" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-å‘å®¢æˆ·ç«¯å‘é€æ•°æ®"><span>ä¾‹å­ 2ï¼šå‘å®¢æˆ·ç«¯å‘é€æ•°æ®</span></a></h5><p>å¦‚æœä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Web æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯è¯·æ±‚æŸäº›èµ„æºæ—¶ï¼Œä½ å¯èƒ½éœ€è¦å°†æ•°æ®åˆ†æ‰¹å‘é€ç»™å®¢æˆ·ç«¯ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> http</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">http</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">http</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">createServer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">async</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">req</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> res</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> encoder</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextEncoder</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> writer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> chunks</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> [</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">World</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">]</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;"> of</span><span style="color:#D8DEE9;"> chunks</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">      await</span><span style="color:#D8DEE9;"> writer</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">ready</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">      writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">encode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">    writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">listen</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">8080</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ€»ç»“-9" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-9"><span>æ€»ç»“</span></a></h3><p><code>writableStreamDefaultWriter.ready</code>æ˜¯ä¸€ä¸ªé‡è¦çš„å±æ€§ï¼Œå®ƒé€šè¿‡è¿”å›ä¸€ä¸ª Promiseï¼Œå¸®åŠ©æˆ‘ä»¬æ§åˆ¶æ•°æ®å†™å…¥çš„æ—¶æœºï¼Œç¡®ä¿æµçš„é«˜æ•ˆå’Œç¨³å®šå¤„ç†ã€‚æ— è®ºæ˜¯å‘æ–‡ä»¶å†™å…¥æ•°æ®ï¼Œè¿˜æ˜¯åœ¨ç½‘ç»œåº”ç”¨ä¸­å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œ<code>ready</code> å±æ€§éƒ½æ˜¯å¤„ç†å¤§é‡æ•°æ®æ—¶çš„å…³é”®å·¥å…·ã€‚</p><h4 id="writablestreamdefaultwriter-releaselock" tabindex="-1"><a class="header-anchor" href="#writablestreamdefaultwriter-releaselock"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#writablestreamdefaultwriterreleaselock" target="_blank" rel="noopener noreferrer">writableStreamDefaultWriter.releaseLock()</a></span></a></h4><p>äº†è§£ <code>writableStreamDefaultWriter.releaseLock()</code> ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹å‡ ä¸ªæ¦‚å¿µï¼š</p><ol><li><p><strong>Streamsï¼ˆæµï¼‰</strong>: åœ¨ç¼–ç¨‹ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¦‚æ–‡ä»¶è¯»å†™æˆ–ç½‘ç»œé€šä¿¡ç­‰ IO æ“ä½œæ—¶ï¼Œâ€œæµâ€è¿™ä¸ªæ¦‚å¿µç»å¸¸å‡ºç°ã€‚ç®€å•åœ°è¯´ï¼Œæµå°±æ˜¯æ•°æ®çš„ä¸€ç³»åˆ—è¿ç»­å—ï¼Œè¿™äº›æ•°æ®å—å¯ä»¥ä¸€å—æ¥ä¸€å—åœ°è¿›è¡Œå¤„ç†ï¼Œè€Œä¸éœ€è¦ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p></li><li><p><strong>Writable Streamsï¼ˆå¯å†™æµï¼‰</strong>: æ˜¯ä¸€ç§å…è®¸ä½ å‘å…¶å‘é€æ•°æ®çš„æµã€‚ä¾‹å¦‚ï¼Œå½“ä½ å¾€æ–‡ä»¶ä¸­å†™å…¥æ•°æ®æˆ–é€šè¿‡ç½‘ç»œå‘é€æ•°æ®æ—¶ï¼Œä½ å°±æ˜¯åœ¨ä½¿ç”¨å¯å†™æµã€‚</p></li><li><p><strong>WritableStreamDefaultWriter</strong>: è¿™æ˜¯ç”¨äºå‘å¯å†™æµå†™å…¥æ•°æ®çš„å·¥å…·ã€‚æƒ³è±¡ä½ æœ‰ä¸€ä¸ªæ°´ç®¡ï¼ˆè¿™å°±æ˜¯ä½ çš„æµï¼‰ï¼ŒWritableStreamDefaultWriter ç›¸å½“äºè¿æ¥åˆ°æ°´ç®¡ä¸Šçš„æ°´é¾™å¤´ï¼Œæ§åˆ¶ç€æ•°æ®ï¼ˆæ°´ï¼‰çš„æµåŠ¨ã€‚</p></li></ol><p>å¥½çš„ï¼Œç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹ <code>writableStreamDefaultWriter.releaseLock()</code> æ˜¯åšä»€ä¹ˆçš„ï¼š</p><ul><li>å½“ä½ ç”¨ <code>WritableStreamDefaultWriter</code> å‘æµä¸­å†™å…¥æ•°æ®æ—¶ï¼Œå®ƒä¼šé”å®šè¿™ä¸ªæµï¼Œä»¥ç¡®ä¿åœ¨æ­¤æœŸé—´æ²¡æœ‰å…¶ä»–çš„ writer è¯•å›¾å†™å…¥æ•°æ®ï¼Œé˜²æ­¢æ•°æ®æ··ä¹±ã€‚</li><li>ä¸€æ—¦ä½ å®Œæˆäº†æ•°æ®å†™å…¥ï¼Œå¹¶ä¸”ç¡®å®šåé¢ä¸å†éœ€è¦å†ç”¨è¿™ä¸ª writer å‘æµä¸­å†™å…¥æ›´å¤šæ•°æ®ï¼Œä½ å¯ä»¥è°ƒç”¨ <code>releaseLock()</code> æ–¹æ³•ã€‚è¿™æ ·åšä¼šé‡Šæ”¾æ‰å¯¹æµçš„é”å®šï¼Œå…è®¸å…¶ä»– writer æœ‰æœºä¼šæ¥ç®¡æµå¹¶å†™å…¥æ•°æ®ã€‚</li></ul><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-10" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-10"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><p>è€ƒè™‘è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šå‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªç½‘ç«™ï¼Œè¿™ä¸ªç½‘ç«™å…è®¸ç”¨æˆ·ä¸Šä¼ è§†é¢‘ï¼Œç„¶åä½ çš„æœåŠ¡å™¨ä¼šå°†è¿™äº›è§†é¢‘è½¬æ¢æˆä¸åŒçš„æ ¼å¼ä»¥æ”¯æŒä¸åŒçš„è®¾å¤‡æ’­æ”¾ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä½ å¯èƒ½éœ€è¦å‘ä¸€ä¸ªæ–‡ä»¶ï¼ˆè§†é¢‘è½¬æ¢åçš„ç»“æœï¼‰å†™å…¥æ•°æ®ã€‚</p><ol><li><p><strong>åˆå§‹åŒ–æµå’Œ writer</strong>:</p><p>å‡è®¾ <code>outputStream</code> æ˜¯ä½ å·²ç»åˆ›å»ºå¥½çš„å¯å†™æµï¼ŒæŒ‡å‘æœ€ç»ˆè¦å†™å…¥è§†é¢‘æ•°æ®çš„æ–‡ä»¶ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> outputStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p><strong>å†™å…¥æ•°æ®</strong>:</p><p>æ¥ä¸‹æ¥ï¼Œä½ åˆ©ç”¨è¿™ä¸ª <code>writer</code> å‘ <code>outputStream</code> å†™å…¥æ•°æ®ï¼ˆå³è½¬æ¢åçš„è§†é¢‘æ•°æ®å—ï¼‰ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">await</span><span style="color:#D8DEE9;"> writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">dataChunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p><strong>é‡Šæ”¾é”å®š</strong>:</p><p>å½“æ‰€æœ‰çš„æ•°æ®å—éƒ½å†™å®Œåï¼Œå¦‚æœä½ ç¡®å®šåé¢ä¸ä¼šå†å‘è¿™ä¸ªæ–‡ä»¶å†™å…¥ä»»ä½•æ•°æ®ï¼Œå°±å¯ä»¥é‡Šæ”¾æµçš„é”å®šã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">releaseLock</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><p>é€šè¿‡è¿™ä¸ªä¾‹å­ï¼Œä½ å¯ä»¥çœ‹å‡º <code>releaseLock()</code> çš„é‡è¦æ€§ï¼šå®ƒç¡®ä¿èµ„æºï¼ˆæœ¬ä¾‹ä¸­çš„æ–‡ä»¶æµï¼‰å¾—åˆ°é€‚å½“ç®¡ç†ï¼Œä¸ä¼šå› ä¸ºé•¿æ—¶é—´é”å®šè€Œæ— æ³•è¢«å…¶ä»–ç¨‹åºæˆ–è¿›ç¨‹ä½¿ç”¨ã€‚ä½¿ç”¨ <code>releaseLock()</code> å¯ä»¥å¢åŠ ç¨‹åºçš„çµæ´»æ€§å’Œæ•ˆç‡ã€‚</p><h4 id="writablestreamdefaultwriter-write-chunk" tabindex="-1"><a class="header-anchor" href="#writablestreamdefaultwriter-write-chunk"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#writablestreamdefaultwriterwritechunk" target="_blank" rel="noopener noreferrer">writableStreamDefaultWriter.write([chunk])</a></span></a></h4><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬ä¸€æ­¥æ­¥è§£å¼€<code>writableStreamDefaultWriter.write([chunk])</code>è¿™ä¸ªæ–¹æ³•èƒŒåçš„æ¦‚å¿µï¼Œé¦–å…ˆä»å‡ ä¸ªå…³é”®è¯å¼€å§‹ï¼šNode.jsã€Streamsã€WritableStreamDefaultWriterã€ä»¥åŠ write æ–¹æ³•ã€‚</p><h3 id="node-js-ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#node-js-ç®€ä»‹"><span>Node.js ç®€ä»‹</span></a></h3><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒã€‚å®ƒä½¿å¾—å¼€å‘è€…å¯ä»¥ä½¿ç”¨ JavaScript æ¥ç¼–å†™æœåŠ¡å™¨ç«¯çš„è„šæœ¬ã€‚Node.js ç‰¹åˆ«æ“…é•¿å¤„ç† I/O å¯†é›†å‹ä»»åŠ¡ï¼Œæ¯”å¦‚ç½‘ç»œé€šä¿¡å’Œæ–‡ä»¶æ“ä½œï¼Œä¸»è¦å¾—ç›Šäºå…¶éé˜»å¡å¼çš„äº‹ä»¶é©±åŠ¨æ¶æ„ã€‚</p><h3 id="streams-ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#streams-ä»‹ç»"><span>Streams ä»‹ç»</span></a></h3><p>åœ¨ Node.js ä¸­ï¼ŒStreams æ˜¯ç”¨æ¥å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ã€‚ç®€å•åœ°è¯´ï¼Œæµæ˜¯ä¸€ä¸ªè¿ç»­çš„æ•°æ®åºåˆ—ï¼Œå¯ä»¥ä»ä¸€ä¸ªä½ç½®æµå‘å¦ä¸€ä¸ªä½ç½®ã€‚æµåœ¨å¤„ç†å¤§é‡æ•°æ®å’Œå®æ—¶æ•°æ®æ—¶å°¤å…¶æœ‰ç”¨ï¼Œå› ä¸ºä½ ä¸éœ€è¦ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å‡†å¤‡å¥½æ‰å¼€å§‹å¤„ç†ï¼Œè€Œæ˜¯å¯ä»¥è¾¹æ¥æ”¶è¾¹å¤„ç†ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§æé«˜æ•ˆç‡å’Œå“åº”é€Ÿåº¦ã€‚</p><p>Streams ä¸»è¦åˆ†ä¸ºå››ç§ç±»å‹ï¼š</p><ol><li><strong>Readable Streams</strong> - å¯è¯»å–æ•°æ®çš„æµï¼ˆä¾‹å¦‚ä»æ–‡ä»¶è¯»å–æ•°æ®ï¼‰ã€‚</li><li><strong>Writable Streams</strong> - å¯å†™å…¥æ•°æ®çš„æµï¼ˆä¾‹å¦‚å†™å…¥æ–‡ä»¶ï¼‰ã€‚</li><li><strong>Duplex Streams</strong> - æ—¢å¯è¯»åˆå¯å†™çš„æµï¼ˆä¾‹å¦‚ç½‘ç»œå¥—æ¥å­—ï¼‰ã€‚</li><li><strong>Transform Streams</strong> - å¯ä»¥ä¿®æ”¹æˆ–è½¬æ¢æ•°æ®çš„ Duplex æµï¼ˆä¾‹å¦‚å‹ç¼©æµï¼‰ã€‚</li></ol><h3 id="writablestreamdefaultwriter-ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#writablestreamdefaultwriter-ç®€ä»‹"><span>WritableStreamDefaultWriter ç®€ä»‹</span></a></h3><p><code>WritableStreamDefaultWriter</code>æ˜¯ Web Streams API çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå‘å¯å†™æµä¸­å†™å…¥æ•°æ®ã€‚è™½ç„¶è¿™ä¸ªåè¯æ¥æºäº Web æ ‡å‡†ï¼Œå¹¶åœ¨æµè§ˆå™¨ä¸­å¹¿æ³›æ”¯æŒï¼Œä½† Node.js ä¹Ÿå®ç°äº†è¿™ä¸€æ¥å£ï¼Œä½œä¸ºå…¶å¯¹ Web Streams API çš„æ”¯æŒçš„ä¸€éƒ¨åˆ†ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥åœ¨ Node.js ç¯å¢ƒä¸­ä½¿ç”¨ç±»ä¼¼äºåœ¨ Web å¼€å‘ä¸­çš„æµå¤„ç†æ–¹å¼ã€‚</p><h3 id="write-chunk-æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#write-chunk-æ–¹æ³•"><span>write([chunk]) æ–¹æ³•</span></a></h3><p>å½“ä½ æ‹¥æœ‰ä¸€ä¸ª<code>WritableStreamDefaultWriter</code>å®ä¾‹åï¼Œå¯ä»¥ä½¿ç”¨<code>write([chunk])</code>æ–¹æ³•å‘æµä¸­å†™å…¥æ•°æ®ã€‚<code>chunk</code>å‚æ•°ä»£è¡¨ä½ æƒ³è¦å†™å…¥æµçš„æ•°æ®å—ã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œæ„å‘³ç€<code>write()</code>è¿”å›ä¸€ä¸ª Promiseã€‚è¿™ä¸ª Promise åœ¨æ•°æ®å—æˆåŠŸå†™å…¥åè§£å†³ï¼Œå¦‚æœå†™å…¥è¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯ï¼Œåˆ™æ‹’ç»ã€‚</p><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-11" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-11"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œè¯¥åº”ç”¨éœ€è¦ä»æŸä¸ª API è·å–æ•°æ®å¹¶å°†å…¶ä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•åœ¨è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨<code>WritableStreamDefaultWriter.write([chunk])</code>çš„ç®€åŒ–ç¤ºä¾‹ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> WritableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> saveDataToFile</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> filePath</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">filePath</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> writer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#D8DEE9;"> writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Data has been written to file successfully.</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> catch</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">error</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Failed to write data:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> finally</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">releaseLock</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾è¿™é‡Œçš„dataæ˜¯ä»APIè·å–çš„æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> data</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Example data from API</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#88C0D0;">saveDataToFile</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">./output.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ©ç”¨ Node.js çš„<code>fs</code>æ¨¡å—åˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘æ–‡ä»¶çš„å¯å†™æµã€‚ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨<code>.getWriter()</code>æ–¹æ³•ä»è¿™ä¸ªå¯å†™æµä¸­è·å–ä¸€ä¸ª<code>WritableStreamDefaultWriter</code>çš„å®ä¾‹ã€‚ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨<code>writer.write(data)</code>å°†æ•°æ®å†™å…¥æ–‡ä»¶äº†ã€‚å®Œæˆå†™æ“ä½œåï¼Œé‡Šæ”¾ writer ä¸Šçš„é”æ˜¯ä¸ªå¥½ä¹ æƒ¯ï¼Œå³è°ƒç”¨<code>writer.releaseLock()</code>ã€‚</p><p>å¸Œæœ›è¿™ä¸ªè§£é‡Šèƒ½å¤Ÿå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£<code>WritableStreamDefaultWriter.write([chunk])</code>çš„å·¥ä½œåŸç†å’Œå¦‚ä½•åœ¨ Node.js ä¸­ä½¿ç”¨å®ƒï¼</p><h3 id="class-writablestreamdefaultcontroller" tabindex="-1"><a class="header-anchor" href="#class-writablestreamdefaultcontroller"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-writablestreamdefaultcontroller" target="_blank" rel="noopener noreferrer">Class: WritableStreamDefaultController</a></span></a></h3><p>åœ¨å¼€å§‹è§£é‡Š <code>WritableStreamDefaultController</code> ç±»ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆç†è§£å‡ ä¸ªåŸºç¡€æ¦‚å¿µã€‚</p><h3 id="æµ-streams-å’Œ-web-streams-api" tabindex="-1"><a class="header-anchor" href="#æµ-streams-å’Œ-web-streams-api"><span>æµ(Streams) å’Œ Web Streams API</span></a></h3><p>æµï¼ˆStreamsï¼‰æ˜¯ä¸€ç§è¿ç»­æ•°æ®çš„å¤„ç†æ–¹å¼ï¼Œå…è®¸ä½ å‘é€æˆ–æ¥æ”¶æ•°æ®ç‰‡æ®µï¼Œè€Œä¸éœ€è¦ä¸€æ¬¡å¤„ç†æ•´ä¸ªæ•°æ®é›†ã€‚è¿™åœ¨å¤„ç†å¤§æ–‡ä»¶æˆ–å®æ—¶æ•°æ®ä¼ è¾“æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚Node.js ä¸­çš„ Streams æ˜¯å®ç°è¿™ç§æ¨¡å¼çš„ä¸€ç§æ‰‹æ®µã€‚Web Streams API æ˜¯è¿™ä¸ªæ¦‚å¿µåœ¨ Web å¹³å°çš„å®ç°ï¼Œæä¾›äº†æ„å»ºå’Œæ“ä½œæµçš„æ ‡å‡†æ–¹æ³•ã€‚</p><h3 id="writable-streams-2" tabindex="-1"><a class="header-anchor" href="#writable-streams-2"><span>Writable Streams</span></a></h3><p>åœ¨ Web Streams API ä¸­ï¼Œ<code>WritableStream</code> æ˜¯ä¸€ç§å¯ä»¥å‘å…¶å†™å…¥æ•°æ®çš„æµã€‚å®ƒä½¿å¾—æ•°æ®å¯ä»¥ä¸€å—ä¸€å—åœ°å‘é€ï¼Œæ— éœ€ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚è¿™å¯¹äºæ–‡ä»¶å†™å…¥ã€ç½‘ç»œé€šä¿¡ç­‰åœºæ™¯éå¸¸æœ‰ç”¨ã€‚</p><h3 id="writablestreamdefaultcontroller" tabindex="-1"><a class="header-anchor" href="#writablestreamdefaultcontroller"><span>WritableStreamDefaultController</span></a></h3><p><code>WritableStreamDefaultController</code> æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç±»ï¼Œæ˜¯åœ¨åˆ›å»ºè‡ªå®šä¹‰å¯å†™æµæ—¶ä½¿ç”¨çš„ã€‚å½“ä½ éœ€è¦æ›´ç²¾ç»†åœ°æ§åˆ¶æµçš„è¡Œä¸ºï¼Œæ¯”å¦‚è°ƒæ•´èƒŒå‹æœºåˆ¶ï¼ˆè¿™æ˜¯ä¸€ç§æ§åˆ¶æµé€Ÿä»¥é¿å…ç”Ÿäº§æ•°æ®çš„é€Ÿåº¦å¤§äºæ¶ˆè´¹æ•°æ®çš„é€Ÿåº¦çš„æœºåˆ¶ï¼‰æˆ–è€…å®ç°è‡ªå®šä¹‰çš„å†™å…¥é€»è¾‘æ—¶ï¼Œå°±ä¼šç”¨åˆ°è¿™ä¸ªç±»ã€‚</p><h4 id="æ ¸å¿ƒåŠŸèƒ½-1" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒåŠŸèƒ½-1"><span>æ ¸å¿ƒåŠŸèƒ½ï¼š</span></a></h4><ul><li><strong>é”™è¯¯å¤„ç†</strong>ï¼šå…è®¸ä½ é€šè¿‡ <code>error()</code> æ–¹æ³•æ˜¾å¼åœ°æŠ›å‡ºæµé”™è¯¯ã€‚</li><li><strong>æµæ§åˆ¶</strong>ï¼šå¯ä»¥é€šè¿‡è¯¥æ§åˆ¶å™¨è°ƒç”¨çš„æ–¹æ³•ç®¡ç†æµçš„çŠ¶æ€ï¼Œä¾‹å¦‚å¼€å§‹æˆ–åœæ­¢æ•°æ®ä¼ è¾“ã€‚</li></ul><h3 id="å®é™…è¿ç”¨ä¾‹å­-16" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-16"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦ä»ä¸€ä¸ªæºï¼ˆæ¯”å¦‚ä¸€ä¸ªå¤§å‹æ–‡ä»¶æˆ–æ•°æ®æµï¼‰è¯»å–æ•°æ®ï¼Œå¹¶ä¸”ä»¥æŸç§åŠ å·¥åçš„å½¢å¼å†™å…¥åˆ°å¦ä¸€ä¸ªç›®çš„åœ°ï¼ˆæ¯”å¦‚å¦ä¸€ä¸ªæ–‡ä»¶ã€æ•°æ®åº“æˆ–ç½‘ç»œå“åº”ä¸­ï¼‰ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>WritableStream</code> ä¸ <code>WritableStreamDefaultController</code> æ¥å®ç°ï¼š</p><ol><li><p><strong>æ—¥å¿—è®°å½•ç³»ç»Ÿ</strong>ï¼šæƒ³è±¡ä¸€ä¸‹ä½ æ­£åœ¨ä¸ºä¸€ä¸ªé«˜æµé‡çš„ç½‘ç«™å¼€å‘æ—¥å¿—è®°å½•ç³»ç»Ÿã€‚ä½ å¯ä»¥ä½¿ç”¨å¯å†™æµæ¥æ¥æ”¶æ—¥å¿—æ¶ˆæ¯ï¼Œå¹¶æŒ‰ç…§æ—¶é—´é¡ºåºå¼‚æ­¥åœ°å†™å…¥åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ã€‚é€šè¿‡ <code>WritableStreamDefaultController</code>ï¼Œä½ å¯ä»¥åœ¨é‡åˆ°å†™å…¥é”™è¯¯æ—¶ç«‹å³ä½œå‡ºå“åº”ï¼Œå¹¶å®ç°è‡ªå®šä¹‰çš„é”™è¯¯å¤„ç†é€»è¾‘ã€‚</p></li><li><p><strong>æ•°æ®è½¬æ¢</strong>ï¼šå¦‚æœä½ çš„åº”ç”¨ç¨‹åºéœ€è¦è¯»å–å¤§é‡çš„è¾“å…¥æ•°æ®ï¼Œè¿›è¡Œå¤„ç†æˆ–è½¬æ¢ï¼Œç„¶åå†ä¿å­˜ç»“æœï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥é€šè¿‡æµæ¥æœ‰æ•ˆåœ°å®Œæˆã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªè§†é¢‘è½¬ç æœåŠ¡å¯èƒ½ä¼šè¯»å–åŸå§‹è§†é¢‘æ–‡ä»¶ï¼Œå°†å…¶è½¬ç ä¸ºä¸åŒçš„æ ¼å¼ï¼Œå¹¶å°†è¾“å‡ºå†™å…¥æ–°çš„æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œ<code>WritableStreamDefaultController</code> å¯ä»¥ç”¨æ¥ç²¾ç¡®æ§åˆ¶å†™å…¥è¿‡ç¨‹ï¼ŒåŒ…æ‹¬å¤„ç†å¯èƒ½å‡ºç°çš„é”™è¯¯ã€‚</p></li><li><p><strong>é«˜é€Ÿç¼“å­˜</strong>ï¼šåœ¨å¤„ç†éœ€è¦ç¼“å­˜æ•°æ®çš„åº”ç”¨æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨å¯å†™æµæ¥å¼‚æ­¥åœ°å°†æ•°æ®å†™å…¥ç¼“å­˜å­˜å‚¨ï¼Œæ¯”å¦‚ Redis æˆ– Memcachedã€‚åˆ©ç”¨ <code>WritableStreamDefaultController</code>ï¼Œå½“ç¼“å­˜å¤±è´¥æ—¶ï¼Œä½ å¯ä»¥çµæ´»åœ°å†³å®šæ˜¯å¦é‡è¯•å†™å…¥æˆ–è®°å½•é”™è¯¯ä¿¡æ¯ã€‚</p></li></ol><p>æ€»ç»“ï¼Œ<code>WritableStreamDefaultController</code> æä¾›äº†ä¸€ä¸ªå¼ºå¤§çš„ç•Œé¢ï¼Œç”¨äºç²¾ç»†åœ°æ§åˆ¶æ•°æ®çš„å†™å…¥è¿‡ç¨‹ï¼Œåœ¨å¤„ç†å¤§é‡æ•°æ®ã€å®ç°å¤æ‚çš„æ•°æ®ä¼ è¾“å’Œè½¬æ¢é€»è¾‘æ—¶å°¤å…¶æœ‰ç”¨ã€‚é€šè¿‡åˆç†åˆ©ç”¨è¿™ä¸ªå·¥å…·ï¼Œä½ å¯ä»¥æ„å»ºå‡ºæ—¢é«˜æ•ˆåˆå¯é çš„ Node.js åº”ç”¨ç¨‹åºã€‚</p><h4 id="writablestreamdefaultcontroller-error-error" tabindex="-1"><a class="header-anchor" href="#writablestreamdefaultcontroller-error-error"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#writablestreamdefaultcontrollererrorerror" target="_blank" rel="noopener noreferrer">writableStreamDefaultController.error([error])</a></span></a></h4><p>Node.js ä¸­çš„<code>writableStreamDefaultController.error([error])</code>æ–¹æ³•æ˜¯ Web Streams API çš„ä¸€éƒ¨åˆ†ï¼Œä¸“é—¨ç”¨äºå¤„ç†æµï¼ˆstreamï¼‰ä¸­çš„é”™è¯¯ã€‚åœ¨æ·±å…¥è§£é‡Šä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š<strong>æµï¼ˆStreamï¼‰</strong>ã€<strong>æ§åˆ¶å™¨ï¼ˆControllerï¼‰<strong>å’Œ</strong>å¯å†™æµï¼ˆWritable Streamï¼‰</strong>ã€‚</p><h3 id="æµ-stream-1" tabindex="-1"><a class="header-anchor" href="#æµ-stream-1"><span>æµï¼ˆStreamï¼‰</span></a></h3><p>åœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯æ•°æ®çš„åºåˆ—ï¼Œå¯ä»¥æ˜¯è¯»å–ï¼ˆè¾“å…¥ï¼‰æˆ–å†™å…¥ï¼ˆè¾“å‡ºï¼‰ã€‚æƒ³è±¡ä¸€ä¸ªæ°´ç®¡ï¼Œæ•°æ®åƒæ°´ä¸€æ ·ä»ä¸€ç«¯æµå‘å¦ä¸€ç«¯ã€‚</p><h3 id="æ§åˆ¶å™¨-controller" tabindex="-1"><a class="header-anchor" href="#æ§åˆ¶å™¨-controller"><span>æ§åˆ¶å™¨ï¼ˆControllerï¼‰</span></a></h3><p>æ§åˆ¶å™¨æ˜¯ç”¨æ¥ç®¡ç†æµçš„å·¥å…·ã€‚å®ƒå¯ä»¥æ§åˆ¶æ•°æ®çš„ä¼ è¾“ï¼Œæ¯”å¦‚å¼€å§‹æˆ–åœæ­¢æµåŠ¨ï¼Œæˆ–è€…åœ¨å‘ç”Ÿé”™è¯¯æ—¶è¿›è¡Œå¤„ç†ã€‚</p><h3 id="å¯å†™æµ-writable-stream" tabindex="-1"><a class="header-anchor" href="#å¯å†™æµ-writable-stream"><span>å¯å†™æµï¼ˆWritable Streamï¼‰</span></a></h3><p>å¯å†™æµæ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œå…è®¸æ•°æ®è¢«å†™å…¥ã€‚ä¾‹å¦‚ï¼Œå½“ä½ å°†æ–‡ä»¶ä¿å­˜åˆ°ç¡¬ç›˜ä¸Šæ—¶ï¼Œå°±æ˜¯åœ¨å‘ä¸€ä¸ªå¯å†™æµä¸­å†™å…¥æ•°æ®ã€‚</p><hr><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬èšç„¦äº<code>writableStreamDefaultController.error([error])</code>æ–¹æ³•ï¼š</p><p>è¿™ä¸ªæ–¹æ³•å…è®¸ä½ åœ¨å¯å†™æµä¸­æ ‡è®°ä¸€ä¸ªé”™è¯¯ã€‚ä¸€æ—¦ä½ è°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•å¹¶ä¼ é€’äº†ä¸€ä¸ªé”™è¯¯å¯¹è±¡ï¼Œè¿™ä¸ªæµå°±ä¼šå…³é—­ï¼Œå¹¶ä¸”ä¸å†æ¥å—ä»»ä½•æ•°æ®å†™å…¥ã€‚è¿™å¯¹äºé€šçŸ¥æµçš„æ¶ˆè´¹è€…ï¼ˆæ¥æ”¶æ•°æ®çš„ä»£ç éƒ¨åˆ†ï¼‰å‘ç”Ÿäº†é”™è¯¯éå¸¸æœ‰ç”¨ã€‚</p><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-3" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-3"><span>å®é™…è¿ç”¨çš„ä¾‹å­ï¼š</span></a></h3><h4 id="ä¾‹å­-1-å†™å…¥æ–‡ä»¶æ—¶å‡ºé”™" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-å†™å…¥æ–‡ä»¶æ—¶å‡ºé”™"><span>ä¾‹å­ 1ï¼šå†™å…¥æ–‡ä»¶æ—¶å‡ºé”™</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨å°†æ•°æ®å†™å…¥ä¸€ä¸ªæ–‡ä»¶ï¼Œä½†ç”±äºæŸäº›åŸå› ï¼ˆæ¯”å¦‚ç¡¬ç›˜ç©ºé—´ä¸è¶³ï¼‰ï¼Œå†™å…¥å¤±è´¥äº†ã€‚è¿™æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>error</code>æ–¹æ³•æ¥æ ‡è®°è¿™ä¸ªé”™è¯¯ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯å†™æµï¼Œå†™å…¥åä¸º &quot;example.txt&quot; çš„æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">error</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">å†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾åœ¨å†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯</span></span>
<span class="line"><span style="color:#D8DEE9;">writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">writableStreamDefaultController</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> Error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ç£ç›˜ç©ºé—´ä¸è¶³</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°è¯•ç»§ç»­å†™å…¥å°†ä¼šå¤±è´¥ï¼Œå› ä¸ºæµå·²ç»å› ä¸ºé”™è¯¯è€Œå…³é—­</span></span>
<span class="line"><span style="color:#D8DEE9;">writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, world!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // è¿™é‡Œå°†ä¼šæ”¶åˆ°é”™è¯¯ï¼Œå› ä¸ºæµå·²ç»å…³é—­</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¾‹å­-2-ç½‘ç»œè¯·æ±‚ä¸­æ–­" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-ç½‘ç»œè¯·æ±‚ä¸­æ–­"><span>ä¾‹å­ 2ï¼šç½‘ç»œè¯·æ±‚ä¸­æ–­</span></a></h4><p>å¦‚æœä½ æ­£åœ¨é€šè¿‡ HTTP è¯·æ±‚å‘é€æ•°æ®ï¼Œä½†è¿æ¥çªç„¶ä¸­æ–­äº†ï¼Œä½ å¯ä»¥æ ‡è®°è¿™ä¸ªæµä¸ºé”™è¯¯çŠ¶æ€ï¼Œä»¥é¿å…è¿›ä¸€æ­¥å°è¯•å†™å…¥æ— æ•ˆçš„è¿æ¥ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾ `httpRequestStream` æ˜¯ä¸€ä¸ªé€šè¿‡ HTTP è¯·æ±‚åˆ›å»ºçš„å¯å†™æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">httpRequestStream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">writableStreamDefaultController</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> Error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">è¿æ¥ä¸­æ–­</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è¿™æ ·ï¼Œä»»ä½•åç»­çš„å†™å…¥å°è¯•éƒ½å°†è¢«å¿½ç•¥æˆ–æŠ¥é”™ï¼Œå› ä¸ºæµå·²ç»å› ä¸ºé”™è¯¯è€Œå…³é—­</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ€»ç»“æ¥è¯´ï¼Œ<code>writableStreamDefaultController.error([error])</code>æ˜¯ä¸€ç§åœ¨æµä¸­æ‰‹åŠ¨æ ‡è®°é”™è¯¯çš„æ–¹æ³•ã€‚å®ƒç”¨äºé€šçŸ¥æµçš„æ¶ˆè´¹è€…å‡ºç°äº†é—®é¢˜ï¼Œé˜²æ­¢ç»§ç»­å†™å…¥å¯èƒ½å·²ç»æ— æ•ˆæˆ–æŸåçš„æµï¼Œä»è€Œç¡®ä¿ç¨‹åºçš„å¥å£®æ€§å’Œæ•°æ®çš„å®Œæ•´æ€§ã€‚</p><h4 id="writablestreamdefaultcontroller-signal" tabindex="-1"><a class="header-anchor" href="#writablestreamdefaultcontroller-signal"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#writablestreamdefaultcontrollersignal" target="_blank" rel="noopener noreferrer">writableStreamDefaultController.signal</a></span></a></h4><p>ç†è§£ <code>writableStreamDefaultController.signal</code> çš„æ¦‚å¿µï¼Œé¦–å…ˆéœ€è¦æ˜ç™½å‡ ä¸ªåŸºæœ¬ç‚¹ï¼š<strong>Streamsï¼ˆæµï¼‰</strong>ã€<strong>Writable Streamsï¼ˆå¯å†™æµï¼‰</strong>ã€<strong>AbortSignal</strong>ï¼Œä»¥åŠ<strong>Controllersï¼ˆæ§åˆ¶å™¨ï¼‰</strong>ã€‚è®©æˆ‘ä»¬ä¸€æ­¥æ­¥æ‹†è§£å¹¶é€šè¿‡å®é™…çš„ä¾‹å­æ¥æ¢ç´¢è¿™äº›æ¦‚å¿µã€‚</p><h3 id="_1-streams-æµ" tabindex="-1"><a class="header-anchor" href="#_1-streams-æµ"><span>1. Streamsï¼ˆæµï¼‰</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œæµæ˜¯å¤„ç†è¯»å†™æ•°æ®çš„ä¸€ç§æ–¹å¼ã€‚æƒ³è±¡ä½ æœ‰ä¸€æ¡¶æ°´ï¼ˆæ•°æ®ï¼‰ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å€’å‡ºæ¥ï¼Œä½ é€‰æ‹©ä½¿ç”¨ä¸€æ ¹ç®¡é“ï¼ˆæµï¼‰æ¥é€æ¸ç§»åŠ¨æ°´ã€‚è¿™æ ·å¯¹äºå¤„ç†å¤§é‡æ•°æ®éå¸¸æœ‰æ•ˆï¼Œå› ä¸ºä½ ä¸éœ€è¦ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å‡†å¤‡å¥½äº†æ‰å¼€å§‹å¤„ç†ï¼Œè€Œæ˜¯æ•°æ®ä¸€åˆ°å°±å¯ä»¥å¼€å§‹å¤„ç†ã€‚</p><h3 id="_2-writable-streams-å¯å†™æµ" tabindex="-1"><a class="header-anchor" href="#_2-writable-streams-å¯å†™æµ"><span>2. Writable Streamsï¼ˆå¯å†™æµï¼‰</span></a></h3><p><code>Writable streams</code>æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œä¸“é—¨ç”¨äºå†™å…¥æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå½“ä½ æƒ³è¦å°†æ•°æ®å†™å…¥æ–‡ä»¶æˆ–å‘é€åˆ°ç½‘ç»œæ—¶ï¼Œå°±ä¼šä½¿ç”¨å¯å†™æµã€‚</p><h3 id="_3-abortsignal" tabindex="-1"><a class="header-anchor" href="#_3-abortsignal"><span>3. AbortSignal</span></a></h3><p><code>AbortSignal</code>æ˜¯ Web æ ‡å‡†çš„ä¸€éƒ¨åˆ†ï¼Œä¸»è¦ç”¨äºå¯å–æ¶ˆçš„æ“ä½œï¼Œæ¯”å¦‚ fetch è¯·æ±‚ã€‚å½“ä¸€ä¸ªæ“ä½œè¢«<code>AbortSignal</code>å–æ¶ˆæ—¶ï¼Œç›¸å…³çš„æµä¹Ÿåº”è¯¥ç›¸åº”åœ°åœæ­¢è¯»å†™æ“ä½œã€‚</p><h3 id="_4-controllers-æ§åˆ¶å™¨-å’Œ-writablestreamdefaultcontroller-signal" tabindex="-1"><a class="header-anchor" href="#_4-controllers-æ§åˆ¶å™¨-å’Œ-writablestreamdefaultcontroller-signal"><span>4. Controllersï¼ˆæ§åˆ¶å™¨ï¼‰ å’Œ writableStreamDefaultController.signal</span></a></h3><p>åœ¨æµçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œæ§åˆ¶å™¨ï¼ˆåƒ<code>WritableStreamDefaultController</code>ï¼‰ç”¨äºæ§åˆ¶æµçš„çŠ¶æ€ï¼Œæ¯”å¦‚å¼€å§‹å’Œåœæ­¢ã€‚<code>writableStreamDefaultController.signal</code>åˆ™æ˜¯ä¸€ä¸ªå±æ€§ï¼Œå®ƒæä¾›äº†ä¸€ä¸ª<code>AbortSignal</code>ã€‚ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªä¿¡å·æ¥ç›‘å¬æµæ˜¯å¦è¢«å–æ¶ˆã€‚å¦‚æœæµè¢«è¯·æ±‚å–æ¶ˆï¼Œä½ å¯ä»¥æ®æ­¤åœæ­¢å‘æµä¸­å†™å…¥æ•°æ®ï¼Œé¿å…èµ„æºæµªè´¹æˆ–å¯èƒ½çš„é”™è¯¯ã€‚</p><h3 id="å®é™…ä¾‹å­-7" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-7"><span>å®é™…ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js ç¨‹åºï¼Œç”¨äºä»ä¸€ä¸ª API è·å–å¤§é‡æ•°æ®ï¼Œå¹¶å°†è¿™äº›æ•°æ®å†™å…¥ä¸€ä¸ªæ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œä½ æƒ³è¦æœ‰èƒ½åŠ›éšæ—¶å–æ¶ˆè¿™ä¸ªå†™å…¥æ“ä½œï¼Œå¯èƒ½æ˜¯å› ä¸ºç”¨æˆ·å–æ¶ˆäº†æ“ä½œï¼Œæˆ–è€…ä½ æ£€æµ‹åˆ°äº†æŸç§é”™è¯¯æƒ…å†µã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> WritableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> AbortController</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">abort-controller</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªAbortControllerå®ä¾‹</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> controller</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> AbortController</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> signal</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> controller</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">signal</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯å†™æµï¼Œè¿™é‡Œä»¥å†™å…¥æ–‡ä»¶ä¸ºä¾‹</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">output.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°†AbortSignalä¸å¯å†™æµå…³è”</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> WritableStream</span><span style="color:#D8DEE9FF;">(</span></span>
<span class="line"><span style="color:#ECEFF4;">  {</span></span>
<span class="line"><span style="color:#88C0D0;">    write</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#88C0D0;">    abort</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">å†™å…¥æ“ä½œè¢«å–æ¶ˆ</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">  {</span><span style="color:#D8DEE9;"> signal</span><span style="color:#ECEFF4;"> }</span></span>
<span class="line"><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// æ¨¡æ‹Ÿå¼‚æ­¥å†™å…¥æ“ä½œ</span></span>
<span class="line"><span style="color:#88C0D0;">setTimeout</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, World!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">},</span><span style="color:#B48EAD;"> 1000</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// æ¨¡æ‹Ÿç”¨æˆ·å–æ¶ˆæ“ä½œï¼Œ5ç§’åå–æ¶ˆå†™å…¥</span></span>
<span class="line"><span style="color:#88C0D0;">setTimeout</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">abort</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">},</span><span style="color:#B48EAD;"> 5000</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå†™å…¥æ–‡ä»¶çš„å¯å†™æµï¼Œå¹¶é€šè¿‡<code>AbortController</code>æä¾›çš„ä¿¡å·æ¥æ§åˆ¶è¿™ä¸ªæµã€‚å¦‚æœåœ¨æ•°æ®å†™å…¥è¿‡ç¨‹ä¸­ï¼Œç”±äºæŸç§åŸå› éœ€è¦å–æ¶ˆå†™å…¥ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åœ¨ 5 ç§’åæ¨¡æ‹Ÿäº†è¿™ç§æƒ…å†µï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨<code>controller.abort()</code>æ¥è§¦å‘å–æ¶ˆæ“ä½œã€‚è¿™æ—¶ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨åˆ›å»º<code>WritableStream</code>æ—¶é€šè¿‡é€‰é¡¹ä¼ å…¥äº†<code>signal</code>, æ‰€ä»¥<code>abort</code>æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨è¿™é‡Œæ¸…ç†èµ„æºï¼Œæ¯”å¦‚å…³é—­æ–‡ä»¶æµã€‚</p><p>ä»¥ä¸Šå°±æ˜¯<code>writableStreamDefaultController.signal</code>çš„ä¸€ä¸ªå®é™…è¿ç”¨åœºæ™¯ï¼Œå¸Œæœ›è¿™èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å®ƒçš„ç”¨æ³•å’Œé‡è¦æ€§ã€‚</p><h3 id="class-transformstream" tabindex="-1"><a class="header-anchor" href="#class-transformstream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-transformstream" target="_blank" rel="noopener noreferrer">Class: TransformStream</a></span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œ<code>TransformStream</code> æ˜¯ Web Streams API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªå¼ºå¤§çš„æœºåˆ¶æ¥å¤„ç†ã€è½¬æ¢æµæ•°æ®ã€‚ç®€è€Œè¨€ä¹‹ï¼Œä½ å¯ä»¥æŠŠ <code>TransformStream</code> æƒ³è±¡æˆä¸€ä¸ªåŠ å·¥å‚ï¼ŒåŸæ–™ï¼ˆè¾“å…¥æ•°æ®ï¼‰è¿›å…¥ï¼ŒåŠ å·¥åçš„äº§å“ï¼ˆè¾“å‡ºæ•°æ®ï¼‰å‡ºæ¥ã€‚è¿™å¯¹äºå¤„ç†æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚ç­‰æµå¼æ•°æ®éå¸¸æœ‰ç”¨ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯æµ-stream-2" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯æµ-stream-2"><span>ä»€ä¹ˆæ˜¯æµï¼ˆStreamï¼‰ï¼Ÿ</span></a></h3><p>åœ¨æ·±å…¥ç†è§£ <code>TransformStream</code> ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä»€ä¹ˆæ˜¯æµã€‚æµæ˜¯ä¸€ç§æ•°æ®çš„é›†åˆï¼Œåƒæ˜¯ä¸€æ¡æ²³æµï¼Œæ•°æ®åƒæ°´ä¸€æ ·ä»æºå¤´æµå‘ç›®çš„åœ°ã€‚åœ¨ç¼–ç¨‹ä¸­ï¼Œæµå…è®¸æˆ‘ä»¬é€æ­¥å¤„ç†å¤§é‡æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å°†æ•°æ®å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><h3 id="transformstream-åŸºæœ¬æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#transformstream-åŸºæœ¬æ¦‚å¿µ"><span>TransformStream åŸºæœ¬æ¦‚å¿µ</span></a></h3><p><code>TransformStream</code> å…·ä½“åšä»€ä¹ˆå‘¢ï¼Ÿå®ƒä¸»è¦ç”¨äºè¯»å–è¾“å…¥æµï¼ˆinput streamï¼‰ï¼Œè¿›è¡ŒæŸç§å½¢å¼çš„è½¬æ¢æˆ–å¤„ç†ï¼Œç„¶åç”Ÿæˆè¾“å‡ºæµï¼ˆoutput streamï¼‰ã€‚è¿™ä¸ªâ€œè½¬æ¢â€å¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„æ“ä½œï¼Œæ¯”å¦‚ä¿®æ”¹æ•°æ®ã€è¿‡æ»¤å†…å®¹ã€æ”¹å˜æ•°æ®æ ¼å¼ç­‰ã€‚</p><h3 id="åˆ›å»º-transformstream" tabindex="-1"><a class="header-anchor" href="#åˆ›å»º-transformstream"><span>åˆ›å»º TransformStream</span></a></h3><p>åœ¨ Node.js v21.7.1 ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼åˆ›å»ºä¸€ä¸ª <code>TransformStream</code>ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TransformStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> transformStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TransformStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">  // æ•°æ®è½¬æ¢çš„é€»è¾‘</span></span>
<span class="line"><span style="color:#88C0D0;">  transform</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å¯¹è¾“å…¥çš„chunkè¿›è¡Œå¤„ç†ï¼Œå¹¶é€šè¿‡controller.enqueue()å‘é€å¤„ç†åçš„æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> outputChunk</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> someTransformationFunction</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">outputChunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å®é™…è¿ç”¨ä¾‹å­-17" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-17"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><p>è®©æˆ‘ä»¬é€šè¿‡ä¸€äº›ä¾‹å­æ›´å¥½åœ°äº†è§£ <code>TransformStream</code> çš„å®ç”¨æ€§ã€‚</p><h4 id="ä¾‹å­-1-å°å†™è½¬å¤§å†™" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-å°å†™è½¬å¤§å†™"><span>ä¾‹å­ 1ï¼šå°å†™è½¬å¤§å†™</span></a></h4><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶æµï¼Œä½ æƒ³å°†æ–‡ä»¶ä¸­çš„æ‰€æœ‰æ–‡æœ¬ä»å°å†™è½¬ä¸ºå¤§å†™ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TransformStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ª TransformStreamï¼Œå°†æ–‡æœ¬ä»å°å†™è½¬ä¸ºå¤§å†™</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> uppercaseTransform</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TransformStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  transform</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å°†chunkè½¬ä¸ºå­—ç¬¦ä¸²ï¼Œç„¶åè½¬ä¸ºå¤§å†™</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> uppercasedChunk</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toUpperCase</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // å°†å¤„ç†åçš„æ•°æ®æ”¾å…¥è¾“å‡ºæµ</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">uppercasedChunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯è¯»æµï¼ˆè¾“å…¥æ•°æ®ï¼‰</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">input.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯å†™æµï¼ˆè¾“å‡ºæ•°æ®ï¼‰</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">output.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°†å¯è¯»æµé€šè¿‡uppercaseTransformè¿æ¥åˆ°å¯å†™æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">readableStream</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">pipeThrough</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">uppercaseTransform</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">pipeTo</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">writableStream</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#D8DEE9;"> console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">è½¬æ¢å®Œæˆï¼Œæ•°æ®å·²å†™å…¥ output.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¾‹å­-2-æ•°æ®åŠ å¯†" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-æ•°æ®åŠ å¯†"><span>ä¾‹å­ 2ï¼šæ•°æ®åŠ å¯†</span></a></h4><p>æƒ³è±¡ä½ æ­£åœ¨å¤„ç†ä¸€ä¸ªåŒ…å«æ•æ„Ÿä¿¡æ¯çš„æµï¼Œä½ éœ€è¦åœ¨å‘é€ä¹‹å‰å¯¹è¿™äº›æ•°æ®è¿›è¡ŒåŠ å¯†ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TransformStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> crypto</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">crypto</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ª TransformStream æ¥åŠ å¯†æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> encryptTransform</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TransformStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  transform</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // ä½¿ç”¨æŸç§åŠ å¯†ç®—æ³•å¯¹æ•°æ®chunkè¿›è¡ŒåŠ å¯†</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> encryptedChunk</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> encryptFunction</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡è®¾encryptFunctionæ˜¯åŠ å¯†å‡½æ•°</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">encryptedChunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾æœ‰ä¸€ä¸ªå‡½æ•°æ¥è¯»å–æ•æ„Ÿæ•°æ®çš„æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> sensitiveDataStream</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> getSensitiveDataStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // getSensitiveDataStream æ˜¯è·å–æ•°æ®çš„ç¤ºæ„å‡½æ•°</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾æœ‰ä¸€ä¸ªå‡½æ•°å°†æ•°æ®å‘é€åˆ°å®‰å…¨çš„ç›®çš„åœ°</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> secureDestinationStream</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> getSecureDestinationStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // getSecureDestinationStream æ˜¯è¾“å‡ºæ•°æ®çš„ç¤ºæ„å‡½æ•°</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨encryptTransformæ¥å¤„ç†æ•æ„Ÿæ•°æ®ï¼Œå¹¶å‘é€åˆ°å®‰å…¨çš„ä½ç½®</span></span>
<span class="line"><span style="color:#D8DEE9;">sensitiveDataStream</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">pipeThrough</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">encryptTransform</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">pipeTo</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">secureDestinationStream</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#D8DEE9;"> console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æ•æ„Ÿæ•°æ®å·²å®‰å…¨åŠ å¯†å¹¶å‘é€</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ä¸Šè¿°ä¾‹å­ï¼Œä½ å¯ä»¥çœ‹åˆ° <code>TransformStream</code> å¦‚ä½•ä½¿å¾—æ•°æ®çš„è½¬æ¢å’Œå¤„ç†å˜å¾—ç®€å•è€Œç›´æ¥ã€‚æ— è®ºæ˜¯å¤„ç†æ–‡æœ¬æ–‡ä»¶è¿˜æ˜¯åŠ å¯†æ•æ„Ÿä¿¡æ¯ï¼Œå®ƒéƒ½æä¾›äº†ä¸€ç§é«˜æ•ˆä¸”çµæ´»çš„æ–¹å¼æ¥å¤„ç†æµå¼æ•°æ®ã€‚</p><h4 id="new-transformstream-transformer-writablestrategy-readablestrategy" tabindex="-1"><a class="header-anchor" href="#new-transformstream-transformer-writablestrategy-readablestrategy"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#new-transformstreamtransformer-writablestrategy-readablestrategy" target="_blank" rel="noopener noreferrer">new TransformStream([transformer[, writableStrategy[, readableStrategy]]])</a></span></a></h4><p>å½“ä½ å¼€å§‹æ¶‰è¶³ç¼–ç¨‹ï¼Œå°¤å…¶æ˜¯ Web å¼€å‘ï¼Œä½ ä¼šé‡åˆ°å¾ˆå¤šæƒ…å†µï¼Œå…¶ä¸­ä¹‹ä¸€æ˜¯éœ€è¦å¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½ä»ä¸€ä¸ªæ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œç„¶åå¯¹è¿™äº›æ•°æ®è¿›è¡Œä¿®æ”¹ã€è½¬æ¢æˆ–åˆ†æï¼Œæœ€åå°†ç»“æœè¾“å‡ºåˆ°å¦ä¸€ä¸ªæ–‡ä»¶æˆ–å‘é€ç»™å®¢æˆ·ç«¯ã€‚åœ¨ Node.js ä¸­ï¼Œä¸ºäº†é«˜æ•ˆåœ°å¤„ç†è¿™ç§æ•°æ®æµåŠ¨ï¼Œå­˜åœ¨ä¸€ç§è¢«ç§°ä¸ºâ€œæµï¼ˆStreamsï¼‰â€çš„æ¦‚å¿µã€‚ç‰¹åˆ«åœ°ï¼Œ<code>TransformStream</code>æ˜¯å¤„ç†è¿™ç±»éœ€æ±‚çš„åˆ©å™¨ã€‚</p><h3 id="transformstream-ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#transformstream-ç®€ä»‹"><span>TransformStream ç®€ä»‹</span></a></h3><p><code>TransformStream</code>æ˜¯ Node.js ä¸­ç”¨äºåˆ›å»ºä¸€ä¸ªè½¬æ¢æµï¼ˆTransfom Streamï¼‰çš„æ„é€ å‡½æ•°ï¼Œå®ƒå…è®¸ä½ åœ¨æ•°æ®ä»æ¥æºæµå‘ç›®æ ‡æ—¶ï¼Œå¯¹æ•°æ®è¿›è¡Œå®æ—¶è½¬æ¢ã€‚å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªä¸­é—´åŠ å·¥å‚ï¼Œåœ¨æ•°æ®ä¼ è¾“çš„é€”ä¸­èƒ½å¤Ÿå¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ã€è¿‡æ»¤æˆ–è½¬æ¢ã€‚</p><h3 id="å‚æ•°è§£é‡Š-2" tabindex="-1"><a class="header-anchor" href="#å‚æ•°è§£é‡Š-2"><span>å‚æ•°è§£é‡Š</span></a></h3><p>å½“ä½ åˆ›å»ºä¸€ä¸ª<code>TransformStream</code>å¯¹è±¡æ—¶ï¼Œå¯ä»¥æä¾›ä¸‰ä¸ªå¯é€‰å‚æ•°ï¼š</p><ol><li><code>transformer</code>ï¼šåŒ…å«ç”¨äºå¤„ç†æ•°æ®çš„é’©å­ï¼ˆHooksï¼‰å‡½æ•°çš„å¯¹è±¡ã€‚ä¸»è¦çš„é’©å­æ˜¯<code>transform</code>å‡½æ•°ï¼Œç”¨äºå®šä¹‰å¦‚ä½•å¤„ç†æµç»çš„æ¯ä¸€å—æ•°æ®ã€‚</li><li><code>writableStrategy</code>ï¼šå®šä¹‰äº†å†™å…¥ï¼ˆè¾“å…¥ï¼‰ç«¯çš„ç­–ç•¥ï¼Œæ¯”å¦‚æ§åˆ¶å‹åŠ›å›é€€æœºåˆ¶ï¼ˆå³å½“æ•°æ®å†™å…¥é€Ÿåº¦è¶…è¿‡å¤„ç†é€Ÿåº¦æ—¶çš„è¡Œä¸ºç­–ç•¥ï¼‰ã€‚</li><li><code>readableStrategy</code>ï¼šå®šä¹‰äº†è¯»å–ï¼ˆè¾“å‡ºï¼‰ç«¯çš„ç­–ç•¥ï¼ŒåŒæ ·å¯ä»¥ç”¨æ¥æ§åˆ¶æµåŠ¨è¡Œä¸ºï¼Œä¾‹å¦‚ç¼“å­˜å¤§å°ç­‰ã€‚</li></ol><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-12" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-12"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåº”ç”¨åœºæ™¯ï¼šè¯»å–ä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œå°†æ–‡ä»¶ä¸­çš„æ–‡æœ¬å…¨éƒ¨è½¬æ¢ä¸ºå¤§å†™ï¼Œç„¶åå†™å…¥åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚</p><h4 id="ç¤ºä¾‹ä»£ç -2" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹ä»£ç -2"><span>ç¤ºä¾‹ä»£ç </span></a></h4><p>é¦–å…ˆï¼Œå¯¼å…¥å¿…éœ€çš„æ¨¡å—ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TransformStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ï¼Œåˆ›å»ºä¸€ä¸ª<code>TransformStream</code>å®ä¾‹å¹¶å®šä¹‰å®ƒå¦‚ä½•è½¬æ¢æ•°æ®ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> upperCaseTr</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TransformStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  transform</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // chunkæ˜¯åŸå§‹æ•°æ®ï¼Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶å¤§å†™</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toUpperCase</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è¯»å–æºæ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readable</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">source.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å†™å…¥ç›®æ ‡æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writable</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">destination.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è¿æ¥æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">readable</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">pipeThrough</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">upperCaseTr</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">pipeTo</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">writable</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#D8DEE9;"> console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">è½¬æ¢å®Œæˆå¹¶å†™å…¥ç›®æ ‡æ–‡ä»¶</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼š</p><ul><li>æˆ‘ä»¬é€šè¿‡<code>fs.createReadStream</code>è¯»å–åä¸º<code>source.txt</code>çš„æ–‡ä»¶ã€‚</li><li>åˆ©ç”¨<code>TransformStream</code>å®ä¾‹<code>upperCaseTr</code>å¯¹è¯»å–çš„æ•°æ®è¿›è¡Œè½¬æ¢ï¼Œè¿™é‡Œæ˜¯å°†æ–‡æœ¬è½¬æ¢ä¸ºå¤§å†™ã€‚</li><li>æœ€ç»ˆé€šè¿‡<code>fs.createWriteStream</code>å°†è½¬æ¢åçš„æ–‡æœ¬å†™å…¥åˆ°<code>destination.txt</code>ã€‚</li></ul><p>è¿™ä¸ªä¾‹å­ä»…ä»…å±•ç¤ºäº†<code>TransformStream</code>çš„åŸºæœ¬ç”¨æ³•ï¼Œå®é™…ä¸Šä½ å¯ä»¥å®ç°æ›´å¤æ‚çš„è½¬æ¢é€»è¾‘ï¼Œæ¯”å¦‚åŠ å¯†/è§£å¯†æ•°æ®ã€å‹ç¼©/è§£å‹æ•°æ®ç­‰ç­‰ã€‚é€šè¿‡ä½¿ç”¨<code>TransformStream</code>ï¼Œä½ å¯ä»¥åˆ›å»ºéå¸¸å¼ºå¤§ä¸”çµæ´»çš„æ•°æ®å¤„ç†ç®¡é“ï¼ˆPipelineï¼‰ï¼Œä»¥é«˜æ•ˆä¸”æµç•…çš„æ–¹å¼å¤„ç†å¤§é‡æ•°æ®ã€‚</p><h4 id="transformstream-readable" tabindex="-1"><a class="header-anchor" href="#transformstream-readable"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#transformstreamreadable" target="_blank" rel="noopener noreferrer">transformStream.readable</a></span></a></h4><p>Node.js ä¸­çš„ <code>transformStream.readable</code> æ˜¯ä¸ Web Streams API ç›¸å…³çš„ä¸€ä¸ªæ¦‚å¿µã€‚åœ¨è§£é‡Š <code>transformStream.readable</code> ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯ TransformStream å’Œæµï¼ˆStreamsï¼‰çš„åŸºæœ¬æ¦‚å¿µã€‚</p><h3 id="æµ-streams-åŸºæœ¬æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#æµ-streams-åŸºæœ¬æ¦‚å¿µ"><span>æµ(Streams)åŸºæœ¬æ¦‚å¿µ</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œæµæ˜¯å¤„ç†è¯»å†™æ•°æ®çš„ä¸€ç§æ–¹å¼ã€‚æƒ³è±¡ä½ æœ‰ä¸€ä¸ªæ°´æ¡¶è¦ç”¨ç»†å°çš„ç®¡é“æ…¢æ…¢å¡«æ»¡ï¼Œè¿™é‡Œçš„æ°´å°±æ˜¯æ•°æ®ï¼Œç®¡é“å°±æ˜¯æµã€‚æµå¯ä»¥è®©ä½ ä»¥è¾ƒå°çš„å†…å­˜å ç”¨é€æ­¥å¤„ç†å¤§é‡æ•°æ®ï¼Œå› ä¸ºä½ ä¸éœ€è¦ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><h3 id="transformstream" tabindex="-1"><a class="header-anchor" href="#transformstream"><span>TransformStream</span></a></h3><p><code>TransformStream</code> æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œå®ƒèƒ½å¤Ÿè¯»å–è¾“å…¥æ•°æ®ï¼Œå¯¹å…¶è¿›è¡Œå¤„ç†ï¼ˆè½¬æ¢ï¼‰ï¼Œç„¶åè¾“å‡ºæ–°çš„æ•°æ®ã€‚å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯ä¸€ä¸ªæ•°æ®åŠ å·¥å‚ï¼šåŸææ–™è¿›æ¥ï¼Œç»è¿‡åŠ å·¥ï¼Œæˆå“å‡ºå»ã€‚</p><h3 id="transformstream-readable-1" tabindex="-1"><a class="header-anchor" href="#transformstream-readable-1"><span><code>transformStream.readable</code></span></a></h3><p>å½“æˆ‘ä»¬è¯´ <code>transformStream.readable</code> æ—¶ï¼Œæˆ‘ä»¬æŒ‡çš„æ˜¯ä» <code>TransformStream</code> å¯¹è±¡ä¸­è·å–çš„å¯è¯»éƒ¨åˆ†ã€‚ç®€å•æ¥è¯´ï¼Œ<code>TransformStream</code> åŒ…å«ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼š</p><ol><li><strong>Writable</strong>ï¼ˆå¯å†™éƒ¨åˆ†ï¼‰: ä½ å¯ä»¥å°†æ•°æ®å†™å…¥æ­¤éƒ¨åˆ†ã€‚</li><li><strong>Readable</strong>ï¼ˆå¯è¯»éƒ¨åˆ†ï¼‰: ç»è¿‡è½¬æ¢åçš„æ•°æ®å¯ä»¥ä»æ­¤éƒ¨åˆ†è¯»å‡ºã€‚</li></ol><p><code>transformStream.readable</code> å°±æ˜¯è¿™ä¸ªç»è¿‡æ•°æ®è½¬æ¢åçš„å¯è¯»æµã€‚</p><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-13" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-13"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåº”ç”¨åœºæ™¯ï¼Œéœ€è¦è¯»å–ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå°†å…¶ä¸­çš„æ–‡æœ¬å…¨éƒ¨è½¬æ¢ä¸ºå¤§å†™ï¼Œç„¶åå†™å…¥åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ä½¿ç”¨ <code>TransformStream</code> å¯ä»¥éå¸¸é«˜æ•ˆåœ°å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> createReadStream</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> createWriteStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TransformStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ª TransformStreamï¼Œå…¶ä¸­çš„ transformer è´Ÿè´£å°†æ–‡æœ¬è½¬æ¢ä¸ºå¤§å†™</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> toUpperCaseTransformer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TransformStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  transform</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // chunk æ˜¯è¾“å…¥çš„æ•°æ®ç‰‡æ®µï¼Œè½¬æ¢ä¸ºå¤§å†™åé€šè¿‡ controller.enqueue() å‘é€å‡ºå»</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toUpperCase</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯è¯»æµï¼Œä»æºæ–‡ä»¶è¯»å–æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readable</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">source.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è·å– TransformStream çš„å¯è¯»éƒ¨åˆ†</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableTransformed</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> toUpperCaseTransformer</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">readable</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯å†™æµï¼Œç”¨äºå°†è½¬æ¢åçš„æ•°æ®å†™å…¥ç›®æ ‡æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writable</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">destination.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°†å¯è¯»æµè¿æ¥åˆ° TransformStream çš„å¯å†™éƒ¨åˆ†</span></span>
<span class="line"><span style="color:#D8DEE9;">readable</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipeTo</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">toUpperCaseTransformer</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">writable</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°†è½¬æ¢åçš„æ•°æ®ï¼ˆå³ readableTransformedï¼‰å†™å…¥ç›®æ ‡æ–‡ä»¶</span></span>
<span class="line"><span style="color:#D8DEE9;">readableTransformed</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipeTo</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">writable</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š</p><ul><li>æˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª <code>TransformStream</code>ï¼Œå®šä¹‰äº†å¦‚ä½•å°†æ•°æ®è½¬æ¢ï¼ˆåœ¨è¿™é‡Œæ˜¯è½¬æ¢ä¸ºå¤§å†™ï¼‰ã€‚</li><li>ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡ <code>.pipeTo()</code> æ–¹æ³•å°†ä¸€ä¸ªå¯è¯»æµï¼ˆ<code>readable</code>ï¼‰è¿æ¥åˆ° <code>TransformStream</code> çš„å¯å†™éƒ¨åˆ†ã€‚</li><li><code>TransformStream</code> å¤„ç†å®Œæ•°æ®åï¼Œè½¬æ¢åçš„æ•°æ®å°†ä¼šå‡ºç°åœ¨å®ƒçš„å¯è¯»éƒ¨åˆ†ï¼ˆ<code>transformStream.readable</code>ï¼‰ï¼Œç„¶åæˆ‘ä»¬å†å°†è¿™äº›æ•°æ®å†™å…¥åˆ°æœ€ç»ˆçš„ç›®æ ‡æ–‡ä»¶ä¸­ã€‚</li></ul><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥æä½çš„å†…å­˜å ç”¨å¤„ç†å¤§é‡æ•°æ®ï¼Œè€Œä¸”æ•´ä¸ªè¿‡ç¨‹æ˜¯æµå¼çš„ï¼Œéå¸¸é«˜æ•ˆã€‚</p><h4 id="transformstream-writable" tabindex="-1"><a class="header-anchor" href="#transformstream-writable"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#transformstreamwritable" target="_blank" rel="noopener noreferrer">transformStream.writable</a></span></a></h4><p>Node.js ä¸­çš„<code>transformStream.writable</code>æ˜¯ä¸€ä¸ªä¸<code>TransformStream</code>å¯¹è±¡ç›¸å…³è”çš„å¯å†™æµå±æ€§ã€‚åœ¨ç†è§£è¿™ä¸ªæ¦‚å¿µä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£å‡ ä¸ªåŸºæœ¬ç‚¹ï¼šæµï¼ˆStreamsï¼‰ã€å¯å†™æµï¼ˆWritable Streamsï¼‰å’Œå˜æ¢æµï¼ˆTransform Streamsï¼‰ã€‚</p><h3 id="åŸºç¡€çŸ¥è¯†-1" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€çŸ¥è¯†-1"><span>åŸºç¡€çŸ¥è¯†</span></a></h3><ol><li><p><strong>æµï¼ˆStreamsï¼‰</strong>: åœ¨ Node.js ä¸­ï¼Œæµæ˜¯å¤„ç†è¯»å†™æ•°æ®çš„ä¸€ç§æ–¹å¼ã€‚æƒ³è±¡æˆæ°´æµï¼Œæ•°æ®åƒæ°´ä¸€æ ·ä»ä¸€ä¸ªåœ°æ–¹æµå‘å¦ä¸€ä¸ªåœ°æ–¹ã€‚</p></li><li><p><strong>å¯å†™æµï¼ˆWritable Streamsï¼‰</strong>: è¿™æ˜¯ä¸€ç§å¯ä»¥å‘å…¶å†™å…¥æ•°æ®çš„æµã€‚æ¯”å¦‚ï¼Œå†™æ–‡ä»¶å°±å¯ä»¥ç”¨åˆ°å¯å†™æµã€‚</p></li><li><p><strong>å˜æ¢æµï¼ˆTransform Streamsï¼‰</strong>: è¿™ç§æµæ—¢æ˜¯å¯è¯»æµä¹Ÿæ˜¯å¯å†™æµï¼Œä½†å®ƒä»¬èƒ½åœ¨æ•°æ®å†™å…¥å’Œè¯»å–ä¹‹é—´ä¿®æ”¹æˆ–è½¬æ¢æ•°æ®ã€‚æƒ³è±¡ä½ æœ‰ä¸€æ¡ç®¡é“ï¼ŒåŸæ²¹ä»ä¸€ç«¯æµå…¥ï¼Œç»è¿‡è¿™æ¡ç®¡é“ï¼ˆå˜æ¢æµï¼‰çš„å¤„ç†ï¼Œæµå‡ºæ¥çš„æ˜¯æ±½æ²¹ã€‚</p></li></ol><h3 id="transformstream-writable-1" tabindex="-1"><a class="header-anchor" href="#transformstream-writable-1"><span>TransformStream.writable</span></a></h3><p>åœ¨ä¸Šè¿°èƒŒæ™¯ä¸‹ï¼Œ<code>TransformStream</code>æ˜¯ç‰¹æ®Šç±»å‹çš„æµï¼Œå…è®¸æˆ‘ä»¬åœ¨å†™å…¥æ•°æ®å’Œè¯»å–æ•°æ®ä¹‹é—´æ‰§è¡ŒæŸç§å½¢å¼çš„è½¬æ¢ã€‚å®ƒåŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šä¸€ä¸ªå¯å†™æµï¼ˆ<code>writable</code>ï¼‰å’Œä¸€ä¸ªå¯è¯»æµï¼ˆ<code>readable</code>ï¼‰ã€‚</p><ul><li><strong>å¯å†™æµ</strong>å…è®¸ä½ å¾€é‡Œé¢å†™å…¥åŸå§‹æ•°æ®ã€‚</li><li><strong>å¯è¯»æµ</strong>åˆ™å…è®¸ä½ è¯»å–è½¬æ¢åçš„æ•°æ®ã€‚</li></ul><p>å½“ä½ ä½¿ç”¨<code>transformStream.writable</code>æ—¶ï¼Œå®é™…ä¸Šä½ åœ¨æ“ä½œçš„æ˜¯<code>TransformStream</code>å¯¹è±¡çš„å¯å†™éƒ¨åˆ†ã€‚ç®€å•æ¥è¯´ï¼Œä½ é€šè¿‡è¿™ä¸ªå±æ€§å‘å˜æ¢æµå†™å…¥æ•°æ®ã€‚</p><h3 id="å®é™…åº”ç”¨ä¾‹å­-3" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ä¾‹å­-3"><span>å®é™…åº”ç”¨ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªç½‘ç«™ï¼Œéœ€è¦å°†ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶è½¬æ¢æˆä¸åŒçš„æ ¼å¼ï¼Œæˆ–è€…å¯¹å…¶å¤§å°è¿›è¡Œè°ƒæ•´ã€‚è¿™é‡Œï¼Œä½ å¯ä»¥ä½¿ç”¨<code>TransformStream</code>ï¼š</p><ol><li><p><strong>å›¾ç‰‡å‹ç¼©</strong>ï¼šç”¨æˆ·ä¸Šä¼ å›¾ç‰‡åï¼Œä½ å¯ä»¥å°†å›¾ç‰‡ä½œä¸ºæ•°æ®å†™å…¥<code>TransformStream</code>çš„<code>writable</code>ç«¯ã€‚ç„¶åï¼Œè®¾ç½®ä¸€ä¸ªè½¬æ¢æ“ä½œæ¥å‹ç¼©æˆ–æ”¹å˜å›¾ç‰‡æ ¼å¼ã€‚å‹ç¼©åçš„å›¾ç‰‡å¯ä»¥ä»<code>TransformStream</code>çš„<code>readable</code>ç«¯è¯»å‡ºå¹¶ä¿å­˜æˆ–å‘é€ç»™ç”¨æˆ·ã€‚</p></li><li><p><strong>æ—¥å¿—è½¬æ¢</strong>ï¼šå¦‚æœä½ çš„åº”ç”¨ç”Ÿæˆäº†å¤§é‡çš„æ—¥å¿—ä¿¡æ¯ï¼Œå¹¶ä¸”ä½ æƒ³åœ¨å­˜å‚¨ä¹‹å‰è½¬æ¢è¿™äº›æ—¥å¿—çš„æ ¼å¼ï¼ˆæ¯”å¦‚ï¼Œä» JSON è½¬æ¢ä¸º CSVï¼‰ï¼Œä½ å¯ä»¥å†™å…¥åŸå§‹æ—¥å¿—åˆ°<code>transformStream.writable</code>ï¼Œåœ¨å˜æ¢æµä¸­è®¾ç½®è½¬æ¢é€»è¾‘ï¼Œç„¶åä»<code>readable</code>ç«¯è¯»å‡ºè½¬æ¢åçš„æ—¥å¿—æ•°æ®è¿›è¡Œå­˜å‚¨ã€‚</p></li><li><p><strong>å®æ—¶æ•°æ®å¤„ç†</strong>ï¼šå‡è®¾ä½ çš„åº”ç”¨æ”¶é›†å®æ—¶æ•°æ®ï¼Œæ¯”å¦‚è‚¡ç¥¨ä»·æ ¼ï¼Œå¹¶å¸Œæœ›åœ¨å‘ç”¨æˆ·æ˜¾ç¤ºå‰è¿›è¡Œä¸€äº›è®¡ç®—æˆ–æ·»åŠ é¢å¤–ä¿¡æ¯ã€‚æ•°æ®å¯ä»¥å†™å…¥<code>TransformStream</code>ï¼Œåœ¨å…¶ä¸­åŠ å·¥å¤„ç†åï¼Œå†æä¾›ç»™å‰ç«¯å±•ç¤ºã€‚</p></li></ol><h3 id="ç»“è®º-2" tabindex="-1"><a class="header-anchor" href="#ç»“è®º-2"><span>ç»“è®º</span></a></h3><p><code>TransformStream.writable</code>å±•ç°äº† Node.js å¼ºå¤§çš„æµå¤„ç†èƒ½åŠ›ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦å¯¹æ•°æ®è¿›è¡Œé¢„å¤„ç†ã€æ ¼å¼è½¬æ¢ç­‰æ“ä½œæ—¶éå¸¸æœ‰ç”¨ã€‚ç†è§£äº†è¿™ä¸ªæ¦‚å¿µï¼Œä½ å°±èƒ½æ›´å¥½åœ°åˆ©ç”¨ Node.js å¤„ç†å¤æ‚çš„ I/O ä»»åŠ¡ï¼Œæ— è®ºæ˜¯åœ¨ Web å¼€å‘ã€æ•°æ®å¤„ç†è¿˜æ˜¯ä»»ä½•éœ€è¦æ•°æ®è½¬æ¢çš„åœºæ™¯ä¸­ã€‚</p><h4 id="transferring-with-postmessage-2" tabindex="-1"><a class="header-anchor" href="#transferring-with-postmessage-2"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#transferring-with-postmessage_2" target="_blank" rel="noopener noreferrer">Transferring with postMessage()</a></span></a></h4><p>äº†è§£ Node.js ä¸­çš„<code>postMessage()</code>æ–¹æ³•åŠå…¶åœ¨ Web Streams API ä¸­çš„åº”ç”¨ï¼Œé¦–å…ˆéœ€è¦æŒæ¡å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š</p><ol><li><strong>Node.js:</strong> æ˜¯ä¸€ä¸ªå¼€æºã€è·¨å¹³å°çš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œè®©ä½ å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚</li><li><strong>Web Streams API:</strong> æä¾›äº†ä¸€ç§å»ºç«‹ã€å¤„ç†å’Œæ¶ˆè´¹å¯è¯»ã€å¯å†™å’ŒåŒå‘æ•°æ®æµçš„æ ‡å‡†æ–¹å¼ã€‚è¿™å¯¹äºå¤„ç†å¤§é‡æ•°æ®æˆ–é€å—å¤„ç†æ•°æ®éå¸¸æœ‰ç”¨ã€‚</li><li><strong><code>postMessage()</code> æ–¹æ³•:</strong> é€šå¸¸ç”¨äºä¸åŒä¸Šä¸‹æ–‡ä¹‹é—´ï¼ˆä¾‹å¦‚ä»ä¸€ä¸ªæµè§ˆå™¨çª—å£åˆ°å¦ä¸€ä¸ªï¼Œæˆ–è€…ä»ä¸»é¡µé¢åˆ° web workerï¼‰å®‰å…¨åœ°ä¼ é€’æ¶ˆæ¯ã€‚</li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£å¦‚ä½•åœ¨ Node.js v21.7.1 ä¸­ä½¿ç”¨<code>postMessage()</code>æ¥ä¼ è¾“æ•°æ®ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç† Web Streams æ—¶ã€‚</p><h3 id="postmessage-åœ¨-web-streams-ä¸­çš„åº”ç”¨" tabindex="-1"><a class="header-anchor" href="#postmessage-åœ¨-web-streams-ä¸­çš„åº”ç”¨"><span><code>postMessage()</code> åœ¨ Web Streams ä¸­çš„åº”ç”¨</span></a></h3><p>åœ¨ Web Streams ä¸­ï¼Œ<code>postMessage()</code>èƒ½å¤Ÿä¼ è¾“æµå¼æ•°æ®ï¼Œæ¯”å¦‚æ–‡ä»¶ä¸Šä¼ æˆ–ä¸‹è½½ã€å®æ—¶éŸ³è§†é¢‘å¤„ç†ç­‰åœºæ™¯ä¸­çš„æ•°æ®æµã€‚Node.js é€šè¿‡å¼•å…¥<code>MessageChannel</code>å’Œ<code>MessagePort</code>ï¼Œæ”¯æŒåœ¨ä¸åŒçš„ç¯å¢ƒï¼ˆä¾‹å¦‚ä¸»çº¿ç¨‹å’Œå·¥ä½œçº¿ç¨‹ä¹‹é—´ï¼‰å®‰å…¨é«˜æ•ˆåœ°ä¼ é€’å¤æ‚ç±»å‹çš„æ•°æ®ï¼ŒåŒ…æ‹¬æµã€‚</p><h4 id="å®é™…ä¾‹å­-8" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-8"><span>å®é™…ä¾‹å­</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨æ„å»ºä¸€ä¸ªåº”ç”¨ï¼Œè¯¥åº”ç”¨éœ€è¦ä»ç”¨æˆ·ä¸Šä¼ çš„å¤§å‹æ–‡ä»¶ä¸­æå–æ•°æ®ï¼Œå¹¶è¿›è¡Œä¸€äº›å¤„ç†ã€‚ä¸ºäº†ä¸é˜»å¡ä¸»çº¿ç¨‹ï¼Œä½ å†³å®šå°†æ–‡ä»¶å¤„ç†é€»è¾‘æ”¾åˆ°ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ä¸­ã€‚è¿™é‡Œå°±å¯ä»¥ç”¨åˆ°<code>postMessage()</code>æ–¹æ³•æ¥ä¼ è¾“ Web Streamã€‚</p><p><strong>æ­¥éª¤ä¸€ï¼š</strong> åˆ›å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹(worker.js)ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// worker.js</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> parentPort</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">worker_threads</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">parentPort</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">message</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> async</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // è¿™é‡Œå¤„ç†æµæ•°æ®ï¼Œä¾‹å¦‚è®¡æ•°ã€è¿‡æ»¤ç­‰æ“ä½œ</span></span>
<span class="line"><span style="color:#81A1C1;">  let</span><span style="color:#D8DEE9;"> count</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  for</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;"> of</span><span style="color:#D8DEE9;"> stream</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">æ¥æ”¶åˆ°æ•°æ®å—: </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">chunk</span><span style="color:#81A1C1;">}</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    count</span><span style="color:#81A1C1;">++;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#D8DEE9;">  parentPort</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">postMessage</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">æ•°æ®å—æ€»æ•°: </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">count</span><span style="color:#81A1C1;">}</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ­¥éª¤äºŒ:</strong> åœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»ºå¹¶ä¼ è¾“æµåˆ°å·¥ä½œçº¿ç¨‹ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// main.js</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> Worker</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">worker_threads</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> MessageChannel</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> worker</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Worker</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./worker.js</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> port1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> port2</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> MessageChannel</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">worker</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">postMessage</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">port1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> [</span><span style="color:#D8DEE9;">port1</span><span style="color:#D8DEE9FF;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾æˆ‘ä»¬æ­£åœ¨è¯»å–ä¸€ä¸ªå¤§æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/large/file</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°†Node.jsæµè½¬æ¢ä¸ºWeb Stream</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">from</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">fileStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨postMessage()å‘é€æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">port2</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">postMessage</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">readableStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>MessageChannel</code>åˆ›å»ºäº†ä¸¤ä¸ªäº’ç›¸è¿æ¥çš„ç«¯å£ï¼š<code>port1</code>å’Œ<code>port2</code>ã€‚<code>port1</code>è¢«å‘é€åˆ°å·¥ä½œçº¿ç¨‹ï¼Œä»¥ä¾¿å®ƒå¯ä»¥ç›‘å¬å¹¶æ¥æ”¶æ¥è‡ªä¸»çº¿ç¨‹çš„æ¶ˆæ¯ã€‚ç„¶åï¼Œä¸»çº¿ç¨‹é€šè¿‡<code>port2</code>å‘é€ä¸€ä¸ªå¯è¯»æµï¼ˆ<code>readableStream</code>ï¼‰ï¼Œè¯¥æµæ˜¯ä»ä¸€ä¸ªå¤§æ–‡ä»¶åˆ›å»ºçš„ã€‚</p><p>å·¥ä½œçº¿ç¨‹æ¥æ”¶åˆ°è¿™ä¸ªæµåï¼Œå¯ä»¥å¼€å§‹å¯¹å…¶æ‰§è¡Œå¼‚æ­¥è¿­ä»£æ“ä½œï¼Œæ¯”å¦‚è®¡æ•°ã€è¿‡æ»¤æ•°æ®ç­‰ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯é¿å…äº†åœ¨å•ä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œå¯èƒ½å¯¼è‡´æ€§èƒ½ç“¶é¢ˆçš„é‡é‡çº§æ“ä½œï¼ŒåŒæ—¶åˆ©ç”¨äº† Node.js çš„éé˜»å¡ IO ç‰¹æ€§ã€‚</p><h3 id="class-transformstreamdefaultcontroller" tabindex="-1"><a class="header-anchor" href="#class-transformstreamdefaultcontroller"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-transformstreamdefaultcontroller" target="_blank" rel="noopener noreferrer">Class: TransformStreamDefaultController</a></span></a></h3><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬æ¥æ·±å…¥äº†è§£ Node.js ä¸­çš„ <code>TransformStreamDefaultController</code>ã€‚é¦–å…ˆï¼Œæˆ‘ä¼šç®€å•ä»‹ç»ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œç„¶åä¸¾ä¾‹è¯´æ˜è¿™ä¸ªç±»åœ¨å®é™…åº”ç”¨ä¸­çš„ç”¨æ³•ã€‚</p><h3 id="åŸºæœ¬æ¦‚å¿µ-4" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ¦‚å¿µ-4"><span>åŸºæœ¬æ¦‚å¿µ</span></a></h3><p><strong>Node.js</strong> æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨æœåŠ¡å™¨ç«¯çš„ JavaScript ç¯å¢ƒï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨ JavaScript æ¥ç¼–å†™æœåŠ¡å™¨ç«¯ä»£ç ã€‚Node.js å¼ºå¤§ä¹‹å¤„åœ¨äºå…¶éé˜»å¡ I/O å’Œäº‹ä»¶é©±åŠ¨çš„ç‰¹æ€§ï¼Œä½¿å¾—å®ƒåœ¨å¤„ç†é«˜å¹¶å‘çš„ç½‘ç»œåº”ç”¨æ—¶è¡¨ç°å‡ºè‰²ã€‚</p><p><strong>æµï¼ˆStreamsï¼‰</strong> åœ¨ Node.js ä¸­æ˜¯ä¸€ç§å¤„ç†æ•°æ®çš„æ–¹å¼ï¼Œå°¤å…¶æ˜¯å½“ä½ éœ€è¦å¤„ç†å¤§é‡æ•°æ®æˆ–è€…ä½ ä¸å¸Œæœ›ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­æ—¶ã€‚æµå¯ä»¥å°†æ•°æ®åˆ†æˆå°å—è¿›è¡Œå¤„ç†å’Œä¼ è¾“ï¼Œè¿™ç§æ–¹å¼æé«˜äº†æ•°æ®å¤„ç†çš„æ•ˆç‡å’Œç¨‹åºçš„æ€§èƒ½ã€‚</p><p><strong>Transform Streams</strong> æ˜¯ Node.js ä¸­çš„ä¸€ç§ç‰¹æ®Šæµï¼Œå®ƒèƒ½å¤Ÿè¯»å–è¾“å…¥æ•°æ®ï¼Œå¯¹æ•°æ®è¿›è¡ŒæŸç§è½¬æ¢ï¼Œå¹¶è¾“å‡ºæ–°çš„æ•°æ®ã€‚Transform æµæ—¢æ˜¯å¯è¯»æµï¼ˆReadable Streamï¼‰ä¹Ÿæ˜¯å¯å†™æµï¼ˆWritable Streamï¼‰ï¼Œå› æ­¤å®ƒä»¬ä½äºæ•°æ®å¤„ç†ç®¡é“çš„ä¸­é—´ï¼Œæ¥æ”¶è¾“å…¥ï¼Œå¤„ç†æ•°æ®ï¼Œç„¶åè¾“å‡ºæ•°æ®ã€‚</p><h3 id="transformstreamdefaultcontroller" tabindex="-1"><a class="header-anchor" href="#transformstreamdefaultcontroller"><span>TransformStreamDefaultController</span></a></h3><p><code>TransformStreamDefaultController</code> æ˜¯ä¸ Transform Streams ç›¸å…³çš„ä¸€ä¸ªç±»ï¼Œä¸»è¦ç”¨äºæ§åˆ¶ Transform Stream çš„è¡Œä¸ºã€‚å½“ä½ åˆ›å»ºè‡ªå®šä¹‰ Transform æµæ—¶ï¼ŒNode.js ä¼šæä¾›ä¸€ä¸ª <code>TransformStreamDefaultController</code> çš„å®ä¾‹ä½œä¸ºå‚æ•°ä¼ é€’ç»™ transform å‡½æ•°ï¼ˆè¿™æ˜¯ä¸€ä¸ªä½ å®šä¹‰çš„å‡½æ•°ï¼Œç”¨äºå¤„ç†æµç»è¯¥ Transform Stream çš„æ¯ä¸ªæ•°æ®å—ï¼‰ã€‚ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ§åˆ¶å™¨æ¥æ“ä½œæµï¼Œæ¯”å¦‚å‘ä¸‹æ¸¸å‘é€æ–°çš„æ•°æ®å—ã€ç»“æŸæµæˆ–è€…æŠ¥å‘Šé”™è¯¯ã€‚</p><h4 id="å®é™…è¿ç”¨" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨"><span>å®é™…è¿ç”¨</span></a></h4><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨å¼€å‘ä¸€ä¸ªç®€å•çš„ Node.js åº”ç”¨ï¼Œè¯¥åº”ç”¨éœ€è¦ä»ä¸€ä¸ªæ–‡ä»¶ä¸­è¯»å–æ–‡æœ¬ï¼Œå°†å…¶ä¸­çš„æ–‡æœ¬å…¨éƒ¨è½¬æ¢ä¸ºå¤§å†™ï¼Œç„¶åå†™å…¥å¦ä¸€ä¸ªæ–‡ä»¶ã€‚è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ä½¿ç”¨ Transform Stream çš„åœºæ™¯ã€‚</p><ol><li><strong>è¯»å–æ–‡ä»¶</strong>ï¼šä½¿ç”¨å¯è¯»æµè¯»å–æºæ–‡ä»¶ã€‚</li><li><strong>è½¬æ¢æ–‡æœ¬</strong>ï¼šé€šè¿‡è‡ªå®šä¹‰ Transform æµå°†æ–‡æœ¬è½¬æ¢ä¸ºå¤§å†™ã€‚</li><li><strong>å†™å…¥æ–‡ä»¶</strong>ï¼šä½¿ç”¨å¯å†™æµå°†è½¬æ¢åçš„æ–‡æœ¬å†™å…¥ç›®æ ‡æ–‡ä»¶ã€‚</li></ol><p>ä¸‹é¢æ˜¯å¦‚ä½•å®ç°è¿™ä¸ªè½¬æ¢æµçš„ç¤ºä¾‹ä»£ç ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> Transform</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºè‡ªå®šä¹‰ Transform æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> upperCaseTranform</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Transform</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">  // transform æ–¹æ³•è´Ÿè´£å¤„ç†æ•°æ®</span></span>
<span class="line"><span style="color:#88C0D0;">  transform</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> encoding</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> callback</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å°†è¾“å…¥æ•°æ®å—ï¼ˆchunkï¼‰è½¬æ¢ä¸ºå¤§å†™</span></span>
<span class="line"><span style="color:#81A1C1;">    this</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">push</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toUpperCase</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // è°ƒç”¨ callback è¡¨ç¤ºå¤„ç†å®Œæˆï¼Œå¯ä»¥æ¥æ”¶ä¸‹ä¸€ä¸ªæ•°æ®å—</span></span>
<span class="line"><span style="color:#88C0D0;">    callback</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºå¯è¯»æµï¼Œä»æºæ–‡ä»¶è¯»å–æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">input.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºå¯å†™æµï¼Œå°†æ•°æ®å†™å…¥ç›®æ ‡æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writeStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">output.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨ç®¡é“å°†è¯»å–æµã€è½¬æ¢æµå’Œå†™å…¥æµè¿æ¥èµ·æ¥</span></span>
<span class="line"><span style="color:#D8DEE9;">readStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">upperCaseTranform</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">writeStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>upperCaseTranform</code> çš„ Transform æµï¼Œå®ƒæ¥æ”¶è¾“å…¥çš„æ–‡æœ¬æ•°æ®å—ï¼Œå°†å…¶è½¬æ¢ä¸ºå¤§å†™ï¼Œç„¶åè¾“å‡ºã€‚è¿™é‡Œè™½ç„¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨ <code>TransformStreamDefaultController</code>ï¼Œä½†è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº† Transform æµçš„ä¸€èˆ¬ç”¨æ³•ã€‚åœ¨æ›´å¤æ‚çš„åœºæ™¯ä¸‹ï¼Œå¦‚æœä½ éœ€è¦æ›´ç»†è‡´åœ°æ§åˆ¶ Transform æµçš„è¡Œä¸ºï¼Œå¯èƒ½å°±éœ€è¦ç›´æ¥ä¸ <code>TransformStreamDefaultController</code> æ‰“äº¤é“äº†ã€‚</p><p>å¸Œæœ›è¿™ä¸ªè§£é‡Šå’Œä¾‹å­èƒ½å¸®åŠ©ä½ ç†è§£ <code>TransformStreamDefaultController</code> åœ¨ Node.js ä¸­çš„ä½œç”¨å’Œç”¨æ³•ï¼</p><h4 id="transformstreamdefaultcontroller-desiredsize" tabindex="-1"><a class="header-anchor" href="#transformstreamdefaultcontroller-desiredsize"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#transformstreamdefaultcontrollerdesiredsize" target="_blank" rel="noopener noreferrer">transformStreamDefaultController.desiredSize</a></span></a></h4><p>äº†è§£<code>transformStreamDefaultController.desiredSize</code>ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆææ¸…æ¥šå‡ ä¸ªæ¦‚å¿µï¼š<code>TransformStream</code>ã€<code>backpressure</code>ä»¥åŠ<code>controller</code>ã€‚æˆ‘ä¼šé€šè¿‡ä¸€ä¸ªå®é™…ä¾‹å­æ¥å¸®åŠ©ä½ ç†è§£è¿™äº›æ¦‚å¿µå’Œ<code>desiredSize</code>çš„ä½œç”¨ã€‚</p><h3 id="åŸºæœ¬æ¦‚å¿µ-5" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ¦‚å¿µ-5"><span>åŸºæœ¬æ¦‚å¿µ</span></a></h3><ol><li><p><strong>TransformStream</strong>:</p><ul><li>åœ¨ Node.js ä¸­ï¼Œ<code>TransformStream</code>æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼ˆstreamï¼‰ï¼Œå®ƒå¯ä»¥è¯»å–è¾“å…¥æ•°æ®ï¼Œå¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼ˆè½¬æ¢ï¼‰ï¼Œç„¶åè¾“å‡ºæ–°çš„æ•°æ®ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰ä¸€æ¡æ°´ç®¡ï¼ˆstreamï¼‰ï¼Œæ°´æµï¼ˆdataï¼‰ç»è¿‡è¿™æ¡ç®¡é“æ—¶ï¼Œä½ åœ¨ä¸­é—´åŠ äº†ä¸ªè¿‡æ»¤å™¨æˆ–å˜å½¢è£…ç½®ï¼Œå‡ºå£å¤„å¾—åˆ°çš„æ°´ï¼ˆdataï¼‰å·²ç»ä¸ä¸€æ ·äº†ã€‚</li></ul></li><li><p><strong>Backpressure</strong>:</p><ul><li><code>Backpressure</code>ï¼ˆèƒŒå‹ï¼‰æ˜¯æµæ§åˆ¶çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨äºå¤„ç†æµå…¥é€Ÿç‡é«˜äºæµå‡ºé€Ÿç‡çš„æƒ…å†µã€‚å¦‚æœæ²¡æœ‰é€‚å½“çš„èƒŒå‹å¤„ç†ï¼Œæ•°æ®å¯èƒ½ä¼šä¸¢å¤±æˆ–é€ æˆèµ„æºæµªè´¹ã€‚å°±åƒä½ ç”¨æ°´å£¶æ¥ç€å¼€å¾—å¤ªå¤§çš„æ°´é¾™å¤´ï¼Œæ°´å£¶æ¥ä¸è¿‡æ¥ï¼Œæ°´å°±æº¢å‡ºæ¥äº†ã€‚</li></ul></li><li><p><strong>Controller</strong>:</p><ul><li>åœ¨<code>TransformStream</code>çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œ<code>controller</code>å…è®¸ä½ ç®¡ç†æµçš„çŠ¶æ€ï¼ŒåŒ…æ‹¬å¼€å§‹ã€æš‚åœå¤„ç†æˆ–è°ƒæ•´æµé€Ÿç­‰ã€‚å°±å¥½æ¯”ä½ èƒ½æ§åˆ¶é‚£ä¸ªè¿‡æ»¤å™¨æˆ–å˜å½¢è£…ç½®çš„å·¥ä½œæ¨¡å¼ã€‚</li></ul></li></ol><h3 id="transformstreamdefaultcontroller-desiredsize-1" tabindex="-1"><a class="header-anchor" href="#transformstreamdefaultcontroller-desiredsize-1"><span>transformStreamDefaultController.desiredSize</span></a></h3><ul><li><code>transformStreamDefaultController.desiredSize</code>æŒ‡çš„æ˜¯æµæ§åˆ¶å™¨å½“å‰å¸Œæœ›æ¥æ”¶çš„æ•°æ®å—æ•°é‡ï¼Œå®ƒåŸºäºèƒŒå‹ï¼ˆbackpressureï¼‰æœºåˆ¶æ¥è®¡ç®—ã€‚è¿™ä¸ªå€¼è¡¨æ˜äº†æµï¼ˆstreamï¼‰èƒ½å¤Ÿæ¥å—å¤šå°‘æ›´å¤šçš„æ•°æ®è€Œä¸ä¼šå¯¼è‡´å†…å­˜ä½¿ç”¨è¿‡é«˜æˆ–æ•ˆç‡ä½ä¸‹ã€‚</li><li>å¦‚æœ<code>desiredSize</code>æ˜¯æ­£æ•°ï¼Œæ„å‘³ç€è¿˜å¯ä»¥å®‰å…¨åœ°å‘æµä¸­å‘é€æ›´å¤šçš„æ•°æ®ã€‚å¦‚æœæ˜¯ 0 æˆ–è´Ÿæ•°ï¼Œè¡¨ç¤ºæœ€å¥½ä¸è¦å†å‘é€æ•°æ®äº†ï¼Œç›´åˆ°è¿™ä¸ªå€¼å†æ¬¡å˜ä¸ºæ­£æ•°ã€‚</li></ul><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-14" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-14"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js ç¨‹åºï¼Œè¯¥ç¨‹åºä»ç½‘ä¸Šä¸‹è½½å›¾ç‰‡ï¼Œå°†å…¶è½¬æ¢ä¸ºé»‘ç™½ï¼Œç„¶åä¿å­˜ã€‚ä½ å¯ä»¥ä½¿ç”¨<code>TransformStream</code>æ¥å¤„ç†å›¾åƒè½¬æ¢ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TransformStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">node:stream/web</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªTransformStreamï¼Œç”¨äºå°†å½©è‰²å›¾ç‰‡è½¬æ¢ä¸ºé»‘ç™½</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> blackWhiteTransformer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TransformStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  transform</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> transformedChunk</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> convertToBlackAndWhite</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡è®¾è¿™æ˜¯è½¬æ¢å‡½æ•°</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">transformedChunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å°†è½¬æ¢åçš„æ•°æ®å—æ”¾å…¥é˜Ÿåˆ—</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // æ£€æŸ¥desiredSizeçœ‹æ˜¯å¦åº”è¯¥ç»§ç»­æ¥æ”¶å’Œå¤„ç†æ›´å¤šæ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">desiredSize</span><span style="color:#ECEFF4;"> `</span><span style="color:#A3BE8C;">&lt;</span><span style="color:#ECEFF4;">`</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">We should stop reading more data for now to avoid backpressure</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾çš„ä½¿ç”¨åœºæ™¯</span></span>
<span class="line"><span style="color:#616E88;">// readStream.pipeThrough(blackWhiteTransformer).pipeTo(writeStream);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª<code>TransformStream</code>ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ª<code>transform</code>æ–¹æ³•æ¥å¤„ç†æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œå°†å›¾ç‰‡è½¬æ¢ä¸ºé»‘ç™½ï¼‰ã€‚é€šè¿‡è®¿é—®<code>controller.desiredSize</code>ï¼Œæˆ‘ä»¬å¯ä»¥ç›‘æ§æµçš„çŠ¶æ€ï¼Œç¡®ä¿æˆ‘ä»¬ä¸ä¼šå› ä¸ºäº§ç”Ÿè¿‡å¤šçš„èƒŒå‹è€Œå¯¼è‡´ç¨‹åºè¿è¡Œä¸ä½³ã€‚</p><p>ç†è§£<code>desiredSize</code>æœ‰åŠ©äºæ›´å¥½åœ°æ§åˆ¶æ•°æ®æµå’Œä¼˜åŒ– Node.js åº”ç”¨çš„æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§é‡æ•°æ®æ—¶ã€‚</p><h4 id="transformstreamdefaultcontroller-enqueue-chunk" tabindex="-1"><a class="header-anchor" href="#transformstreamdefaultcontroller-enqueue-chunk"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#transformstreamdefaultcontrollerenqueuechunk" target="_blank" rel="noopener noreferrer">transformStreamDefaultController.enqueue([chunk])</a></span></a></h4><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥åœ°æ¥çœ‹ã€‚é¦–å…ˆï¼Œè¦ç†è§£ <code>transformStreamDefaultController.enqueue([chunk])</code> è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼šNode.jsã€Streamsã€Transform Streams å’Œ Controllerã€‚</p><h3 id="åŸºæœ¬æ¦‚å¿µ-6" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ¦‚å¿µ-6"><span>åŸºæœ¬æ¦‚å¿µ</span></a></h3><ol><li><strong>Node.js</strong>: ä¸€ä¸ªå¯ä»¥è®© JavaScript è¿è¡Œåœ¨æœåŠ¡å™¨ç«¯çš„å¹³å°ã€‚</li><li><strong>Streams</strong>: åœ¨ Node.js ä¸­ï¼ŒStreams æ˜¯ç”¨äºå¤„ç†æ•°æ®æµçš„å¯¹è±¡ã€‚æ•°æ®å¯ä»¥æ˜¯æ–‡ä»¶è¯»å†™ã€ç½‘ç»œé€šä¿¡ç­‰ã€‚Streams å…è®¸ä½ é«˜æ•ˆåœ°å¤„ç†å¤§é‡æ•°æ®ï¼Œå› ä¸ºä½ ä¸éœ€è¦ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè€Œæ˜¯å¯ä»¥é€å—å¤„ç†ã€‚</li><li><strong>Transform Streams</strong>: ä¸€ç§ç‰¹æ®Šç±»å‹çš„ Streamï¼Œå¯ä»¥è¯»å–è¾“å…¥æ•°æ®ï¼Œå¯¹å…¶è¿›è¡Œå¤„ç†ï¼ˆè½¬æ¢ï¼‰ï¼Œç„¶åè¾“å‡ºæ–°çš„æ•°æ®ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå®ƒå°±åƒä¸€ä¸ªå·¥å‚ç”Ÿäº§çº¿ï¼ŒåŸææ–™ï¼ˆè¾“å…¥æ•°æ®ï¼‰è¿›å…¥ï¼Œç»è¿‡åŠ å·¥ï¼ˆè½¬æ¢ï¼‰ï¼Œæˆå“ï¼ˆæ–°æ•°æ®ï¼‰è¾“å‡ºã€‚</li><li><strong>Controller</strong>: è¿™æ˜¯ä¸€ä¸ªç”¨äºæ§åˆ¶ Transform Stream è¡Œä¸ºçš„å¯¹è±¡ã€‚<code>transformStreamDefaultController.enqueue([chunk])</code>å°±æ˜¯å…¶ä¸­ä¸€ä¸ªæ–¹æ³•ï¼Œä½¿ä½ èƒ½å¤Ÿå°†å¤„ç†åçš„æ•°æ®å—æ·»åŠ åˆ°å¯è¯»æµé˜Ÿåˆ—ä¸­ã€‚</li></ol><h3 id="transformstreamdefaultcontroller-enqueue-chunk-1" tabindex="-1"><a class="header-anchor" href="#transformstreamdefaultcontroller-enqueue-chunk-1"><span>transformStreamDefaultController.enqueue([chunk])</span></a></h3><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨åœ¨ Transform Stream çš„è½¬æ¢è¿‡ç¨‹ä¸­ã€‚åœ¨è¯¥è¿‡ç¨‹ä¸­ï¼Œå½“ä½ è·å¾—äº†æƒ³è¦è¾“å‡ºçš„æ•°æ®å—ï¼ˆchunkï¼‰ï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ³•å¯ä»¥å°†å®ƒæ·»åŠ åˆ° Transform Stream çš„è¾“å‡ºé˜Ÿåˆ—ä¸­ã€‚è¿™æ„å‘³ç€æ­¤æ•°æ®å—ä¼šæˆä¸º Stream çš„ä¸‹ä¸€ä¸ªå¯è¯»å–çš„éƒ¨åˆ†ã€‚</p><h4 id="å‚æ•°-5" tabindex="-1"><a class="header-anchor" href="#å‚æ•°-5"><span>å‚æ•°</span></a></h4><ul><li><strong>chunk</strong> ï¼ˆå¯é€‰ï¼‰: è¿™æ˜¯ä½ æƒ³è¦æ·»åŠ åˆ°è¾“å‡ºé˜Ÿåˆ—çš„æ•°æ®å—ã€‚</li></ul><h4 id="ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹"><span>ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹</span></a></h4><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª Transform Streamï¼Œå®ƒçš„ä»»åŠ¡æ˜¯æ¥æ”¶æ–‡æœ¬æ•°æ®ï¼Œå°†å…¶ä¸­çš„å°å†™å­—æ¯è½¬æ¢ä¸ºå¤§å†™å­—æ¯ï¼Œç„¶åè¾“å‡ºã€‚</p><ol><li><strong>åˆ›å»º Transform Stream</strong>: é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Transform Streamï¼Œåœ¨å…¶ä¸­å®šä¹‰å¦‚ä½•å¤„ç†æ•°æ®ã€‚</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TransformStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> uppercaseTransformStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TransformStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  transform</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å°†æ¥æ”¶åˆ°çš„æ–‡æœ¬æ•°æ®ï¼ˆchunkï¼‰è½¬åŒ–ä¸ºå¤§å†™</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> uppercaseChunk</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toUpperCase</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // ä½¿ç”¨controller.enqueue()å°†è½¬æ¢åçš„æ•°æ®æ·»åŠ åˆ°è¾“å‡ºé˜Ÿåˆ—</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">uppercaseChunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong>ä½¿ç”¨ Transform Stream</strong>:</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯è¯»çš„Streamæ¥æ¨¡æ‹Ÿè¾“å…¥æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">hello</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">world</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨Transform Streamå¤„ç†æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> transformedStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipeThrough</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">uppercaseTransformStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è¯»å–å¹¶æ‰“å°è½¬æ¢åçš„æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> transformedStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> processText</span><span style="color:#ECEFF4;">({</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> })</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">return;</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: HELLO</span></span>
<span class="line"><span style="color:#D8DEE9;">  reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">processText</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„ Transform Streamï¼Œå®ƒæŠ“å–ä¼ å…¥çš„æ–‡æœ¬æ•°æ®ï¼Œå°†å…¶è½¬æ¢ä¸ºå¤§å†™ï¼Œç„¶åè¾“å‡ºã€‚<code>transformStreamDefaultController.enqueue([chunk])</code>æ­£æ˜¯è´Ÿè´£å°†è½¬æ¢åçš„æ•°æ®å—æ”¾å…¥è¾“å‡ºé˜Ÿåˆ—çš„å…³é”®æ–¹æ³•ã€‚</p><p>å¸Œæœ›è¿™ä¸ªè§£é‡Šå’Œç¤ºä¾‹èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£<code>transformStreamDefaultController.enqueue([chunk])</code>çš„ä½œç”¨å’Œæ€ä¹ˆä½¿ç”¨å®ƒï¼</p><h4 id="transformstreamdefaultcontroller-error-reason" tabindex="-1"><a class="header-anchor" href="#transformstreamdefaultcontroller-error-reason"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#transformstreamdefaultcontrollererrorreason" target="_blank" rel="noopener noreferrer">transformStreamDefaultController.error([reason])</a></span></a></h4><p>ç†è§£ <code>transformStreamDefaultController.error([reason])</code> åŠŸèƒ½ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š<strong>Streamsã€Transform Streams</strong>ï¼Œå’Œ<strong>Controllers</strong>åœ¨ Node.js ä¸­çš„ä½œç”¨ã€‚</p><h3 id="åŸºç¡€æ¦‚å¿µ-7" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ-7"><span>åŸºç¡€æ¦‚å¿µ</span></a></h3><ol><li><p><strong>Streams</strong>: åœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯ä¸€ç³»åˆ—è¿ç»­çš„æ•°æ®ã€‚æƒ³è±¡ä¸€æ¡æ°´æµï¼Œæ•°æ®å°±åƒæ°´æµä¸­çš„æ°´ä¸€æ ·ä¸æ–­æµåŠ¨ã€‚åœ¨ Node.js ä¸­ï¼Œæµè¢«ç”¨æ¥è¯»å–æˆ–å†™å…¥æ•°æ®ã€‚</p></li><li><p><strong>Transform Streams</strong>: è½¬æ¢æµæ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œå¯ä»¥åœ¨æ•°æ®ä»æºå¤´åˆ°ç›®çš„åœ°çš„è¿‡ç¨‹ä¸­å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥æœ‰ä¸€ä¸ªå°†æ–‡æœ¬æ–‡ä»¶ä¸­çš„å°å†™å­—æ¯è½¬æ¢ä¸ºå¤§å†™å­—æ¯çš„è½¬æ¢æµã€‚</p></li><li><p><strong>Controllers</strong>: æ§åˆ¶å™¨å…è®¸ä½ æ“ä½œæµçš„è¡Œä¸ºï¼Œæ¯”å¦‚å–æ¶ˆä¼ è¾“æˆ–æŠ¥å‘Šé”™è¯¯ç­‰ã€‚</p></li></ol><h3 id="transformstreamdefaultcontroller-error-reason-1" tabindex="-1"><a class="header-anchor" href="#transformstreamdefaultcontroller-error-reason-1"><span><code>transformStreamDefaultController.error([reason])</code></span></a></h3><p>è¿™æ˜¯ä¸€ä¸ªå…·ä½“çš„ API æ–¹æ³•ï¼Œç”¨äºåœ¨è½¬æ¢æµå¤„ç†è¿‡ç¨‹ä¸­å¼•å‘é”™è¯¯ã€‚å½“åœ¨è½¬æ¢æµä¸­é‡åˆ°æ— æ³•å¤„ç†çš„æ•°æ®æˆ–è€…æ‰§è¡Œä¸èƒ½æˆåŠŸå®Œæˆçš„æ“ä½œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•æŠ¥å‘Šé”™è¯¯ã€‚</p><ul><li><p><strong>å‚æ•°</strong>ï¼š</p><ul><li><code>[reason]</code>: å¯é€‰å‚æ•°ï¼Œæä¾›é”™è¯¯å‘ç”Ÿçš„åŸå› ã€‚</li></ul></li><li><p><strong>ä½œç”¨</strong>ï¼š</p><p>å½“æ­¤æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šç«‹å³åœæ­¢æ‰€æœ‰æµåŠ¨çš„æ•°æ®ï¼Œå¹¶å°†é”™è¯¯ä¼ æ’­ç»™æµçš„æ¶ˆè´¹è€…ã€‚è¿™å¯¹äºå¤„ç†å¼‚å¸¸æˆ–æ„å¤–æƒ…å†µéå¸¸æœ‰ç”¨ã€‚</p></li></ul><h3 id="å®é™…åº”ç”¨ä¾‹å­-4" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ä¾‹å­-4"><span>å®é™…åº”ç”¨ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨æ„å»ºä¸€ä¸ªç®€å•çš„ Node.js åº”ç”¨ï¼Œè¯¥åº”ç”¨é€šè¿‡è½¬æ¢æµè¯»å–ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå°†é‡Œé¢çš„æ¯ä¸€ä¸ªâ€œç¬‘è„¸ç¬¦å· ğŸ˜Šâ€æ›¿æ¢æˆâ€œå“­è„¸ç¬¦å· ğŸ˜¢â€ï¼Œç„¶åè¾“å‡ºåˆ°å¦ä¸€ä¸ªæ–‡ä»¶ã€‚</p><p><strong>æ­¥éª¤ 1:</strong> åˆ›å»ºè½¬æ¢æµã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TransformStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">//  //à¹€à¸­à¸à¸ªà¸²à¸£à¸™à¸µà¹‰à¸¡à¸²à¸ˆà¸²à¸ Cherrychat à¸«à¹‰à¸²à¸¡à¹ƒà¸Šà¹‰à¹€à¸à¸·à¹ˆà¸­à¸à¸²à¸£à¸à¸²à¸“à¸´à¸Šà¸¢à¹Œ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> smileToSadTransform</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TransformStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  transform</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // å°†chunkè½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶æ›¿æ¢è¡¨æƒ…ç¬¦å·</span></span>
<span class="line"><span style="color:#81A1C1;">      const</span><span style="color:#D8DEE9;"> transformedChunk</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">replace</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">/</span><span style="color:#EBCB8B;">ğŸ˜Š</span><span style="color:#ECEFF4;">/</span><span style="color:#81A1C1;">g</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">ğŸ˜¢</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">      // å°†å¤„ç†åçš„æ•°æ®æ¨é€åˆ°ä¸‹ä¸€ä¸ªç¯èŠ‚</span></span>
<span class="line"><span style="color:#D8DEE9;">      controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">transformedChunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;"> catch</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">error</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">      // å¦‚æœè½¬æ¢è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œåˆ™æŠ¥å‘Šé”™è¯¯</span></span>
<span class="line"><span style="color:#D8DEE9;">      controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">An error occurred during transformation.</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ­¥éª¤ 2:</strong> ä½¿ç”¨è¿™ä¸ªè½¬æ¢æµå¤„ç†æ•°æ®ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬çœç•¥äº†åˆ›å»ºè¯»å–æµå’Œå†™å…¥æµä»¥åŠå®é™…çš„æ›¿æ¢æ“ä½œçš„ä»£ç ï¼Œé‡ç‚¹å…³æ³¨æˆ‘ä»¬å¦‚ä½•åˆ©ç”¨ä¸Šè¿°å®šä¹‰çš„<code>smileToSadTransform</code>æ¥å¤„ç†æ•°æ®ã€‚</p><p>å¦‚æœåœ¨è½¬æ¢è¿‡ç¨‹ä¸­é‡åˆ°äº†æ— æ³•è½¬æ¢çš„æ•°æ®ï¼Œæˆ–è€…å› ä¸ºæŸäº›åŸå› è½¬æ¢å¤±è´¥ï¼Œ<code>controller.error(&#39;An error occurred during transformation.&#39;)</code>å°†è¢«è°ƒç”¨ï¼Œè¿™å°†åœæ­¢æµçš„å¤„ç†å¹¶å‘æµçš„æ¶ˆè´¹è€…æŠ¥å‘Šé”™è¯¯ã€‚</p><p>é€šè¿‡è¿™ä¸ªæœºåˆ¶ï¼Œä½ å¯ä»¥æ§åˆ¶æµçš„é”™è¯¯å¤„ç†é€»è¾‘ï¼Œä½¿å¾—æ•°æ®å¤„ç†æ›´åŠ å®‰å…¨å’Œå¯é ã€‚</p><h3 id="æ€»ç»“-10" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-10"><span>æ€»ç»“</span></a></h3><p><code>transformStreamDefaultController.error([reason])</code>æ–¹æ³•ä½¿å¼€å‘è€…èƒ½å¤Ÿåœ¨å¤„ç†è½¬æ¢æµä¸­çš„æ•°æ®æ—¶ï¼Œä¸€æ—¦é‡åˆ°é”™è¯¯æƒ…å†µï¼Œç«‹åˆ»ä¸­æ–­å¤„ç†è¿‡ç¨‹å¹¶é€šçŸ¥é”™è¯¯ï¼Œç¡®ä¿æ•°æ®å¤„ç†çš„å¥å£®æ€§å’Œå¯é æ€§ã€‚åœ¨ Node.js çš„å¼‚æ­¥å’Œäº‹ä»¶é©±åŠ¨çš„ç¯å¢ƒä¸­ï¼Œå¦¥å–„å¤„ç†é”™è¯¯æ˜¯ä¿è¯åº”ç”¨ç¨³å®šè¿è¡Œçš„å…³é”®ã€‚</p><h4 id="transformstreamdefaultcontroller-terminate" tabindex="-1"><a class="header-anchor" href="#transformstreamdefaultcontroller-terminate"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#transformstreamdefaultcontrollerterminate" target="_blank" rel="noopener noreferrer">transformStreamDefaultController.terminate()</a></span></a></h4><p>è¦ç†è§£ <code>transformStreamDefaultController.terminate()</code>ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£å‡ ä¸ªå…³é”®æ¦‚å¿µï¼šNode.jsã€Streamsã€Transform Streams å’Œ æ§åˆ¶å™¨ï¼ˆControllerï¼‰ã€‚è®©æˆ‘ä¸€æ­¥æ­¥å¸¦ä½ æ·±å…¥äº†è§£å®ƒä»¬ã€‚</p><h3 id="node-js-ç®€ä»‹-1" tabindex="-1"><a class="header-anchor" href="#node-js-ç®€ä»‹-1"><span>Node.js ç®€ä»‹</span></a></h3><p>Node.js æ˜¯ä¸€ä¸ªå¼€æºä¸”è·¨å¹³å°çš„ JavaScript è¿è¡Œæ—¶ç¯å¢ƒï¼Œå…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚å®ƒéå¸¸é€‚åˆå¼€å‘éœ€è¦å¤„ç†å¤§é‡å¹¶å‘è¿æ¥è€Œæ— éœ€å ç”¨å¤ªå¤šèµ„æºçš„ç½‘ç»œåº”ç”¨ç¨‹åºã€‚</p><h3 id="streams-ç®€ä»‹-1" tabindex="-1"><a class="header-anchor" href="#streams-ç®€ä»‹-1"><span>Streams ç®€ä»‹</span></a></h3><p>åœ¨ Node.js ä¸­ï¼ŒStreams æ˜¯å¤„ç†è¯»å–æ•°æ®ï¼ˆå¦‚ä»æ–‡ä»¶è¯»å–ï¼‰æˆ–å†™å…¥æ•°æ®ï¼ˆå¦‚å†™å…¥æ–‡ä»¶ï¼‰çš„ä¸€ç§æ–¹å¼ã€‚Streams å¯ä»¥é«˜æ•ˆåœ°å¤„ç†å¤§é‡æ•°æ®ï¼Œå› ä¸ºä½ ä¸éœ€è¦ä¸€æ¬¡å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚å®ƒä»¬å¯ä»¥åˆ†ä¸ºå››ç§ç±»å‹ï¼šReadableï¼ˆå¯è¯»çš„ï¼‰ã€Writableï¼ˆå¯å†™çš„ï¼‰ã€Duplexï¼ˆåŒå‘çš„ï¼Œå³å¯è¯»å¯å†™ï¼‰å’Œ Transformï¼ˆè½¬æ¢çš„ï¼‰ã€‚</p><h3 id="transform-streams" tabindex="-1"><a class="header-anchor" href="#transform-streams"><span>Transform Streams</span></a></h3><p>Transform Streams ç‰¹åˆ«åœ°ï¼Œæ—¢æ˜¯ Readable åˆæ˜¯ Writableã€‚è¿™æ„å‘³ç€å®ƒä»¬å¯ä»¥è¯»å–æ•°æ®ã€å¯¹æ•°æ®è¿›è¡ŒæŸç§å½¢å¼çš„è½¬æ¢ï¼Œç„¶åè¾“å‡ºæ•°æ®ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½æœ‰ä¸€ä¸ªå°†æ–‡æœ¬æ–‡ä»¶ä¸­çš„å°å†™å­—æ¯è½¬æ¢ä¸ºå¤§å†™å­—æ¯çš„ Transform Streamã€‚</p><h3 id="transformstreamdefaultcontroller-terminate-1" tabindex="-1"><a class="header-anchor" href="#transformstreamdefaultcontroller-terminate-1"><span>transformStreamDefaultController.terminate()</span></a></h3><p>ç°åœ¨ï¼Œå½“æˆ‘ä»¬è¯´åˆ° <code>transformStreamDefaultController.terminate()</code>ï¼Œæˆ‘ä»¬è°ˆè®ºçš„æ˜¯åœ¨ä¸€ä¸ª Transform Stream çš„ä¸Šä¸‹æ–‡ä¸­ä¸»åŠ¨ç»“æŸ Stream çš„èƒ½åŠ›ã€‚</p><p>åœ¨ Node.js v21.7.1 çš„æ–‡æ¡£ä¸­ï¼Œ<code>transformStreamDefaultController.terminate()</code> æ–¹æ³•ç”¨äºç»“æŸ Transform Stream çš„è¾“å‡ºé˜Ÿåˆ—ï¼Œä½¿å…¶ä¸å†æ¥å—æ–°çš„ chunksï¼ˆå—ï¼‰ï¼Œå¹¶å…³é—­ Streamã€‚ä¸€æ—¦è°ƒç”¨äº† <code>terminate()</code>ï¼ŒTransform Stream å°†æ— æ³•å†å†™å…¥æ›´å¤šçš„æ•°æ®ã€‚</p><h4 id="åº”ç”¨ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨ç¤ºä¾‹"><span>åº”ç”¨ç¤ºä¾‹</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åº”ç”¨ç¨‹åºï¼Œè¯¥ç¨‹åºé€šè¿‡ Transform Stream è¯»å–ä¸€ä¸ªå¾ˆå¤§çš„æ—¥å¿—æ–‡ä»¶ï¼ŒæŸ¥æ‰¾ç‰¹å®šç±»å‹çš„é”™è¯¯æ¶ˆæ¯ï¼Œå¹¶å°†è¿™äº›é”™è¯¯æ¶ˆæ¯è½¬å‘åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ã€‚å¦‚æœä½ åœ¨è¯»å–è¿‡ç¨‹ä¸­ç¡®å®šé”™è¯¯çš„ç±»å‹ä¸æ˜¯ä½ å¯»æ‰¾çš„é‚£ç§ï¼Œæˆ–è€…ä½ å·²ç»æ‰¾åˆ°è¶³å¤Ÿçš„ä¿¡æ¯ï¼Œå¹¶æƒ³åœæ­¢è¿›ä¸€æ­¥çš„å¤„ç†ï¼Œè¿™æ—¶ä½ å°±å¯ä»¥ä½¿ç”¨ <code>transformStreamDefaultController.terminate()</code> æ¥æå‰ç»“æŸæµçš„å¤„ç†ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TransformStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node:stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> createReadStream</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> createWriteStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> logStream</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/path/to/large/log/file.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> errorLogStream</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/path/to/output/errors.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ª Transform Stream æ¥å¤„ç†æ—¥å¿—æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> transformStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TransformStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  transform</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> encoding</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> logEntry</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">logEntry</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">includes</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ERROR</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">      // å¦‚æœæ‰¾åˆ°é”™è¯¯æ—¥å¿—ï¼Œå†™å…¥åˆ° errorLogStream</span></span>
<span class="line"><span style="color:#81A1C1;">      this</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">push</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">logEntry</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // å‡è®¾æˆ‘ä»¬æƒ³åœ¨æ‰¾åˆ°ç¬¬ä¸€ä¸ªé”™è¯¯åå°±ç»ˆæ­¢</span></span>
<span class="line"><span style="color:#D8DEE9;">    controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">terminate</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨ç®¡é“ï¼ˆpipeï¼‰è¿æ¥æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">logStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">transformStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">errorLogStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç®€åŒ–çš„ä¾‹å­ä¸­ï¼Œä¸€æ—¦æˆ‘ä»¬é€šè¿‡ <code>transform()</code> å‡½æ•°æ‰¾åˆ°äº†ä¸€ä¸ªé”™è¯¯æ—¥å¿—æ¡ç›®ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨ <code>controller.terminate()</code> ç»“æŸ Transform Streamï¼Œé˜²æ­¢è¿›ä¸€æ­¥çš„æ•°æ®å¤„ç†ã€‚</p><p>å¸Œæœ›è¿™ä¸ªè§£é‡Šå’Œç¤ºä¾‹æœ‰åŠ©äºä½ ç†è§£ <code>transformStreamDefaultController.terminate()</code> åœ¨ Node.js ä¸­çš„ä½¿ç”¨ï¼</p><h3 id="class-bytelengthqueuingstrategy" tabindex="-1"><a class="header-anchor" href="#class-bytelengthqueuingstrategy"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-bytelengthqueuingstrategy" target="_blank" rel="noopener noreferrer">Class: ByteLengthQueuingStrategy</a></span></a></h3><p>å½“æˆ‘ä»¬è°ˆåˆ° Node.js ä¸­çš„ <code>ByteLengthQueuingStrategy</code> ç±»ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯åœ¨è®¨è®ºä¸€ç§ç‰¹å®šçš„æ•°æ®æµç®¡ç†æ–¹å¼ã€‚ä¸ºäº†ä½¿å®ƒæ˜“äºç†è§£ï¼Œæˆ‘ä»¬å…ˆéœ€è¦ç®€å•åœ°å›é¡¾ä¸€ä¸‹ä»€ä¹ˆæ˜¯æµï¼ˆStreamsï¼‰ä»¥åŠå®ƒä»¬çš„ä½œç”¨ã€‚</p><h3 id="æµ-streams-çš„æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#æµ-streams-çš„æ¦‚å¿µ"><span>æµï¼ˆStreamsï¼‰çš„æ¦‚å¿µ</span></a></h3><p>åœ¨ç¼–ç¨‹ä¸­ï¼Œç‰¹åˆ«æ˜¯å¤„ç†æ–‡ä»¶æˆ–ç½‘ç»œé€šä¿¡æ—¶ï¼Œæ•°æ®å¾€å¾€ä¸æ˜¯ä¸€æ¬¡æ€§å…¨éƒ¨ä¼ è¾“çš„ã€‚ç›¸åï¼Œæ•°æ®ä»¥â€œæµâ€çš„å½¢å¼ä¸€éƒ¨åˆ†ä¸€éƒ¨åˆ†åœ°ç§»åŠ¨ã€‚è¿™ç§æ–¹å¼æœ‰åŠ©äºæœ‰æ•ˆç®¡ç†å†…å­˜å’Œæé«˜åº”ç”¨æ€§èƒ½ï¼Œå› ä¸ºä½ ä¸éœ€è¦ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å¯ç”¨æ‰å¼€å§‹å¤„ç†ã€‚</p><h3 id="ä¸ºä»€ä¹ˆéœ€è¦-bytelengthqueuingstrategy" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆéœ€è¦-bytelengthqueuingstrategy"><span>ä¸ºä»€ä¹ˆéœ€è¦ <code>ByteLengthQueuingStrategy</code></span></a></h3><p>å½“ä½¿ç”¨æµæ¥å¤„ç†æ•°æ®æ—¶ï¼Œæ§åˆ¶è¿›å‡ºæµçš„æ•°æ®é‡å˜å¾—éå¸¸é‡è¦ã€‚è¿™æ˜¯å› ä¸ºä½ å¸Œæœ›ä¿æŒæ•ˆç‡åŒæ—¶é˜²æ­¢ç¨‹åºè¿‡è½½ã€‚è¿™å°±æ˜¯<code>ByteLengthQueuingStrategy</code>ç±»å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚</p><p><code>ByteLengthQueuingStrategy</code>æ˜¯ä¸€ç§åŸºäºå­—èŠ‚é•¿åº¦çš„é˜Ÿåˆ—ç­–ç•¥ï¼Œç”¨äºæ§åˆ¶ä½•æ—¶åº”è¯¥ä»æºå¤´è¯»å–æ›´å¤šæ•°æ®ä»¥åŠä½•æ—¶å°†æ•°æ®æ¨é€ç»™æ¶ˆè´¹è€…ã€‚å®ƒå±äº Web Streams API çš„ä¸€éƒ¨åˆ†ï¼Œè¿™ä¸ª API æä¾›äº†æ„å»ºå’Œæ“ä½œæµæ•°æ®çš„å·¥å…·ã€‚</p><h3 id="å¦‚ä½•å·¥ä½œ" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•å·¥ä½œ"><span>å¦‚ä½•å·¥ä½œ</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œ<code>ByteLengthQueuingStrategy</code>é€šè¿‡ä¸€ä¸ªå«åš<code>highWaterMark</code>çš„å±æ€§æ¥å·¥ä½œã€‚è¿™ä¸ªå±æ€§è®¾å®šäº†ä¸€ä¸ªç•Œé™ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼ŒæŒ‡ç¤ºåœ¨è¾¾åˆ°æ­¤ç•Œé™ä¹‹å‰å¯ä»¥ç»§ç»­ä»æºè¯»å–æ•°æ®å¹¶å­˜å…¥å†…éƒ¨é˜Ÿåˆ—ã€‚ä¸€æ—¦é˜Ÿåˆ—ä¸­çš„æ•°æ®è¶…è¿‡è¿™ä¸ªç•Œé™ï¼Œå°±ä¼šåœæ­¢ä»æºè¯»å–æ•°æ®ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­çš„æ•°æ®è¢«æ¶ˆè´¹åˆ°è¶³å¤Ÿä½çš„æ°´å¹³ã€‚</p><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-4" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-4"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œè¯¥åº”ç”¨éœ€è¦ä»ä¸€ä¸ªå¤§æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œå¹¶ä¸”ä½ æƒ³è¦é€šè¿‡ç½‘ç»œå°†è¿™äº›æ•°æ®å‘é€ç»™å¤šä¸ªå®¢æˆ·ç«¯ã€‚</p><ol><li><p><strong>æ–‡ä»¶è¯»å–</strong>ï¼šä½ å¯ä»¥ä½¿ç”¨<code>ByteLengthQueuingStrategy</code>æ¥æ§åˆ¶ä»æ–‡ä»¶è¯»å–æ•°æ®çš„é€Ÿç‡ï¼Œç¡®ä¿ä¸ä¼šå› ä¸ºä¸€æ¬¡æ€§è¯»å–å¤ªå¤šæ•°æ®è€Œå ç”¨è¿‡å¤šå†…å­˜ã€‚</p></li><li><p><strong>æ•°æ®ä¼ è¾“</strong>ï¼šå½“æ•°æ®é€šè¿‡ç½‘ç»œå‘é€æ—¶ï¼Œæ ¹æ®ç½‘ç»œé€Ÿåº¦çš„å¿«æ…¢ï¼Œä½ å¯èƒ½å¸Œæœ›è°ƒæ•´å‘é€æ•°æ®çš„é€Ÿåº¦ã€‚<code>ByteLengthQueuingStrategy</code>å¯ä»¥å¸®åŠ©ä½ æ§åˆ¶æ•°æ®çš„æµåŠ¨ï¼Œç¡®ä¿ä¸ä¼šå› ä¸ºå‘é€æ•°æ®å¤ªå¿«è€Œå¯¼è‡´ç½‘ç»œæ‹¥å µæˆ–å®¢æˆ·ç«¯å¤„ç†ä¸è¿‡æ¥ã€‚</p></li></ol><h3 id="ä»£ç ç¤ºä¾‹-4" tabindex="-1"><a class="header-anchor" href="#ä»£ç ç¤ºä¾‹-4"><span>ä»£ç ç¤ºä¾‹</span></a></h3><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åœ¨åˆ›å»ºä¸€ä¸ªå¯è¯»æµæ—¶ä½¿ç”¨<code>ByteLengthQueuingStrategy</code>ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ByteLengthQueuingStrategy</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯è¯»æµï¼Œå…¶ä¸­ä½¿ç”¨äº†ByteLengthQueuingStrategy</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span></span>
<span class="line"><span style="color:#ECEFF4;">  {</span></span>
<span class="line"><span style="color:#88C0D0;">    start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // è¿™é‡Œæ˜¯ä¸€ä¸ªå‡è®¾çš„å‡½æ•°ï¼Œæ¨¡æ‹Ÿä»æŸå¤„å¼‚æ­¥è·å–æ•°æ®å—</span></span>
<span class="line"><span style="color:#81A1C1;">      async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> fetchData</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">        // è·å–æ•°æ®å—çš„é€»è¾‘...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        // å‡è®¾fetchDataè¿”å›çš„æ˜¯Uint8Arrayæ ¼å¼çš„æ•°æ®å—</span></span>
<span class="line"><span style="color:#81A1C1;">        const</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#88C0D0;"> fetchData</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        // ä½¿ç”¨controller.enqueueæ–¹æ³•å°†æ•°æ®å—åŠ å…¥æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">        controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        // å½“æ•°æ®å…¨éƒ¨å‘é€å®Œæ¯•ï¼Œè°ƒç”¨controller.close()å…³é—­æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">        controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">      fetchData</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#D8DEE9;"> controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#81A1C1;">  new</span><span style="color:#88C0D0;"> ByteLengthQueuingStrategy</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> highWaterMark</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1024</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº†<code>highWaterMark</code>ä¸º 1024 å­—èŠ‚ï¼Œæ„å‘³ç€å½“æµçš„å†…éƒ¨é˜Ÿåˆ—è¾¾åˆ°æˆ–è¶…è¿‡ 1024 å­—èŠ‚æ—¶ï¼Œæˆ‘ä»¬ä¼šæš‚åœä»æºè·å–æ•°æ®ï¼Œç›´è‡³é˜Ÿåˆ—ä¸­çš„æ•°æ®å‡å°‘ã€‚</p><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œ<code>ByteLengthQueuingStrategy</code>å¸®åŠ©æˆ‘ä»¬æ§åˆ¶æ•°æ®çš„æµåŠ¨ï¼Œä¿è¯åº”ç”¨çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚</p><h4 id="new-bytelengthqueuingstrategy-init" tabindex="-1"><a class="header-anchor" href="#new-bytelengthqueuingstrategy-init"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#new-bytelengthqueuingstrategyinit" target="_blank" rel="noopener noreferrer">new ByteLengthQueuingStrategy(init)</a></span></a></h4><p>å½“ä½ å¼€å§‹ç¼–ç¨‹ï¼Œç‰¹åˆ«æ˜¯æ¶‰åŠåˆ°ç½‘ç»œåº”ç”¨æˆ–æ•°æ®å¤„ç†çš„æ—¶å€™ï¼Œä¼šé‡åˆ°éœ€è¦é«˜æ•ˆåœ°å¤„ç†æ•°æ®æµçš„æƒ…å†µã€‚è¿™é‡Œçš„â€œæ•°æ®æµâ€å¯ä»¥ç®€å•ç†è§£ä¸ºä¸€è¿ä¸²çš„æ•°æ®ï¼Œå°±åƒæ°´æµä¸€æ ·ï¼Œæ•°æ®ä»ä¸€ä¸ªåœ°æ–¹â€œæµåŠ¨â€åˆ°å¦ä¸€ä¸ªåœ°æ–¹ã€‚Node.js é€šè¿‡æä¾›å„ç§å·¥å…·å’Œåº“æ¥å¸®åŠ©å¼€å‘è€…æ›´å¥½åœ°ç®¡ç†è¿™äº›æ•°æ®æµï¼Œè€Œ <code>ByteLengthQueuingStrategy</code> æ˜¯è¿™äº›å·¥å…·ä¹‹ä¸€ã€‚</p><h3 id="ç†è§£-bytelengthqueuingstrategy" tabindex="-1"><a class="header-anchor" href="#ç†è§£-bytelengthqueuingstrategy"><span>ç†è§£ ByteLengthQueuingStrategy</span></a></h3><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç†è§£ä»€ä¹ˆæ˜¯ <strong>Queuing Strategyï¼ˆé˜Ÿåˆ—ç­–ç•¥ï¼‰</strong>ï¼š</p><p>åœ¨å¤„ç†æ•°æ®æµçš„æ—¶å€™ï¼Œå°¤å…¶æ˜¯å¼‚æ­¥å¤„ç†ï¼ˆå³æ•°æ®ä»¥éè¿ç»­ã€ä¸å¯é¢„æµ‹çš„é€Ÿåº¦åˆ°è¾¾æ—¶ï¼‰ï¼Œå°±éœ€è¦æœ‰ä¸€ç§æœºåˆ¶æ¥æ§åˆ¶æ•°æ®çš„æ¥æ”¶ã€å¤„ç†å’Œå‘é€ã€‚è¿™å°±æ˜¯é˜Ÿåˆ—ç­–ç•¥çš„ä½œç”¨ â€”â€” å®ƒåŸºæœ¬ä¸Šå®šä¹‰äº†å¦‚ä½•ç®¡ç†å’Œè°ƒèŠ‚æ•°æ®æµï¼Œç¡®ä¿ç³»ç»Ÿæ—¢ä¸ä¼šå› ä¸ºæ•°æ®æ¥å¾—å¤ªå¿«è€Œæº¢å‡ºï¼ˆæƒ³è±¡ä¸€ä¸‹ä¸€ä¸ªå¤ªæ»¡çš„æ°´æ¯ï¼‰ï¼Œä¹Ÿä¸ä¼šå› ä¸ºæ•°æ®æ¥å¾—å¤ªæ…¢è€Œèµ„æºæµªè´¹ï¼ˆæƒ³è±¡ä¸€ä¸‹æ°´é¾™å¤´æ»´æ»´ç­”ç­”ä½†æ¯å­æ²¡åœ¨ä¸‹é¢ï¼‰ã€‚</p><p><code>ByteLengthQueuingStrategy</code> æ˜¯ä¸€ç§ç‰¹å®šçš„é˜Ÿåˆ—ç­–ç•¥ï¼Œå®ƒä¾æ®æ•°æ®å—ï¼ˆchunksï¼‰çš„å­—èŠ‚é•¿åº¦æ¥ç®¡ç†æµã€‚è¿™æ„å‘³ç€å®ƒä¼šæ ¹æ®æ¯ä¸ªæ•°æ®å—çš„å¤§å°ï¼ˆè€Œä¸æ˜¯æ•°é‡ï¼‰æ¥å†³å®šå¦‚ä½•å¤„ç†æµã€‚</p><h3 id="ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹-1" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹-1"><span>ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªè§†é¢‘æµåº”ç”¨ï¼Œç”¨æˆ·å¯ä»¥ä¸Šä¼ è§†é¢‘æ–‡ä»¶ã€‚è¿™äº›è§†é¢‘æ–‡ä»¶ä»¥æ•°æ®å—çš„å½¢å¼ä¸Šä¼ æœåŠ¡å™¨ã€‚å¦‚æœæœåŠ¡å™¨ä¸åŠ ä»¥æ§åˆ¶åœ°æ¥æ”¶æ•°æ®ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨å†…å­˜æº¢å‡ºï¼Œå°¤å…¶æ˜¯å½“å¤šä¸ªç”¨æˆ·åŒæ—¶ä¸Šä¼ å¤§æ–‡ä»¶æ—¶ã€‚è¿™æ—¶ï¼Œä½¿ç”¨ <code>ByteLengthQueuingStrategy</code> å¯ä»¥å¸®åŠ©æœåŠ¡å™¨æŒ‰ç…§æ¯ä¸ªæ•°æ®å—çš„å­—èŠ‚å¤§å°æ¥ç®¡ç†è¿™äº›æ•°æ®æµï¼Œç¡®ä¿æœåŠ¡å™¨èƒ½å¤Ÿå¹³ç¨³ã€é«˜æ•ˆåœ°å¤„ç†ä¸Šä¼ ã€‚</p><h3 id="å¦‚ä½•ä½¿ç”¨-1" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ä½¿ç”¨-1"><span>å¦‚ä½•ä½¿ç”¨</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œä½¿ç”¨ <code>ByteLengthQueuingStrategy</code> çš„ä»£ç ç¤ºä¾‹å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> ByteLengthQueuingStrategy</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªæ–°çš„ ByteLengthQueuingStrategy å®ä¾‹ï¼Œè®¾ç½® highWaterMarkã€‚</span></span>
<span class="line"><span style="color:#616E88;">// highWaterMark æ˜¯æŒ‡åœ¨å¼€å§‹åº”ç”¨èƒŒå‹ï¼ˆå‡ç¼“æ•°æ®æµé€Ÿåº¦ï¼‰ä¹‹å‰ï¼Œæµä¸­å¯ä»¥æœ‰çš„æœ€å¤§å­—èŠ‚æ•°ã€‚</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> queuingStrategy</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ByteLengthQueuingStrategy</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  highWaterMark</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 1MB</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªReadableStreamï¼ˆå¯è¯»æµï¼‰ï¼Œä½¿ç”¨æˆ‘ä»¬çš„é˜Ÿåˆ—ç­–ç•¥ã€‚</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span></span>
<span class="line"><span style="color:#ECEFF4;">  {</span></span>
<span class="line"><span style="color:#88C0D0;">    start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // å½“æµè¢«åˆ›å»ºæ—¶æ‰§è¡Œçš„æ“ä½œ...</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#88C0D0;">    pull</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // å½“æ¶ˆè´¹è€…éœ€è¦æ›´å¤šæ•°æ®æ—¶æ‰§è¡Œçš„æ“ä½œ...</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#88C0D0;">    cancel</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // å½“æµè¢«å–æ¶ˆæ—¶æ‰§è¡Œçš„æ“ä½œ...</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#D8DEE9;">  queuingStrategy</span></span>
<span class="line"><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š</p><ul><li>æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª <code>ByteLengthQueuingStrategy</code> å®ä¾‹ï¼Œè®¾ç½® <code>highWaterMark</code> ä¸º 1MBï¼Œæ„å‘³ç€åªæœ‰å½“æµä¸­ç§¯ç´¯çš„æ•°æ®è¶…è¿‡ 1MB æ—¶ï¼Œç³»ç»Ÿæ‰ä¼šå¼€å§‹è€ƒè™‘å‡ç¼“æ•°æ®æºçš„é€Ÿåº¦ã€‚</li><li>ç„¶åæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå¯è¯»æµï¼Œé‡‡ç”¨äº†æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„é˜Ÿåˆ—ç­–ç•¥ã€‚</li></ul><h3 id="å°ç»“-1" tabindex="-1"><a class="header-anchor" href="#å°ç»“-1"><span>å°ç»“</span></a></h3><p>é€šè¿‡ä½¿ç”¨ <code>ByteLengthQueuingStrategy</code>ï¼Œä½ å¯ä»¥æœ‰æ•ˆåœ°ç®¡ç†å’Œæ§åˆ¶æ•°æ®æµä¸­æ•°æ®å—çš„å¤„ç†ï¼Œè¿™å¯¹äºå¼€å‘é«˜æ€§èƒ½ç½‘ç»œåº”ç”¨éå¸¸é‡è¦ã€‚è¿™ç§ç­–ç•¥é€šè¿‡å…³æ³¨æ•°æ®çš„â€œé‡é‡â€ï¼ˆå³å­—èŠ‚é•¿åº¦ï¼‰ï¼Œè€Œä¸ä»…ä»…æ˜¯æ•°é‡ï¼Œå¸®åŠ©ç¡®ä¿åº”ç”¨å¯ä»¥æ›´åŠ å¹³æ»‘ã€é«˜æ•ˆåœ°è¿è¡Œã€‚</p><h4 id="bytelengthqueuingstrategy-highwatermark" tabindex="-1"><a class="header-anchor" href="#bytelengthqueuingstrategy-highwatermark"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#bytelengthqueuingstrategyhighwatermark" target="_blank" rel="noopener noreferrer">byteLengthQueuingStrategy.highWaterMark</a></span></a></h4><p>å½“æˆ‘ä»¬è°ˆåˆ° Node.js ä¸­çš„<code>byteLengthQueuingStrategy.highWaterMark</code>ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯åœ¨è®¨è®ºæµï¼ˆStreamsï¼‰å’ŒèƒŒå‹ï¼ˆbackpressureï¼‰ç®¡ç†çš„ä¸€ä¸ªæ¦‚å¿µã€‚ä¸ºäº†ä½¿è¿™ä¸ªè§£é‡Šæ›´é€šä¿—æ˜“æ‡‚ï¼Œæˆ‘ä¼šå…ˆä»‹ç»å‡ ä¸ªåŸºç¡€æ¦‚å¿µï¼Œç„¶åé€šè¿‡ä¾‹å­æ¥è§£é‡Š<code>byteLengthQueuingStrategy.highWaterMark</code>ã€‚</p><h3 id="åŸºç¡€æ¦‚å¿µ-8" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ-8"><span>åŸºç¡€æ¦‚å¿µ</span></a></h3><ol><li><p><strong>æµï¼ˆStreamsï¼‰</strong>: åœ¨ Node.js ä¸­ï¼Œæµæ˜¯ä¸€ç§å¤„ç†è¯»å†™æ•°æ®çš„æ–¹å¼ï¼Œå®ƒå¯ä»¥è®©ä½ é€å—åœ°å¤„ç†æ•°æ®ï¼Œè€Œä¸éœ€è¦ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£åœ¨ç”¨ä¸€æ ¹ç®¡å­æŠŠæ°´ä»ä¸€ä¸ªå¤§æ¡¶ç§»åŠ¨åˆ°å¦ä¸€ä¸ªå¤§æ¡¶ï¼Œæ°´é€šè¿‡ç®¡å­ä¸€ç‚¹ä¸€ç‚¹åœ°æµåŠ¨ï¼Œè¿™å°±å¾ˆåƒ Node.js ä¸­çš„æ•°æ®æµã€‚</p></li><li><p><strong>èƒŒå‹ï¼ˆBackpressureï¼‰</strong>: å½“æ•°æ®é€šè¿‡æµä¼ è¾“æ—¶ï¼Œå¦‚æœç”Ÿäº§æ•°æ®çš„é€Ÿåº¦è¶…è¿‡äº†æ¶ˆè´¹æ•°æ®çš„é€Ÿåº¦ï¼Œç³»ç»Ÿå¿…é¡»æœ‰ä¸€ç§æ–¹å¼æ¥å¤„ç†è¿™ç§ä¸å¹³è¡¡ã€‚è¿™ç§ä¸å¹³è¡¡å¯¼è‡´çš„å‹åŠ›æˆ‘ä»¬ç§°ä¹‹ä¸ºèƒŒå‹ã€‚ç»§ç»­ç”¨å‰é¢çš„æ°´çš„æ¯”å–»ï¼Œå¦‚æœæ°´æµå…¥çš„é€Ÿåº¦è¶…è¿‡äº†æµå‡ºçš„é€Ÿåº¦ï¼Œé‚£ä¹ˆç®¡ä¸­çš„æ°´å‹å°±ä¼šå¢åŠ ã€‚</p></li><li><p><strong>æ§åˆ¶ç­–ç•¥ï¼ˆQueuing Strategyï¼‰</strong>: è¿™æ˜¯ä¸€ç§ç®¡ç†æµä¸­æ•°æ®å¦‚ä½•è¢«æ¥æ”¶å’Œå¤„ç†çš„ç­–ç•¥ã€‚ç‰¹åˆ«åœ°ï¼Œå®ƒå¯ä»¥å¸®åŠ©ç®¡ç†èƒŒå‹ï¼Œç¡®ä¿ç³»ç»Ÿä¸ä¼šå› ä¸ºå¤„ç†ä¸è¿‡æ¥è€Œå´©æºƒã€‚</p></li></ol><h3 id="bytelengthqueuingstrategy-highwatermark-1" tabindex="-1"><a class="header-anchor" href="#bytelengthqueuingstrategy-highwatermark-1"><span><code>byteLengthQueuingStrategy.highWaterMark</code></span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œ<code>byteLengthQueuingStrategy</code>æ˜¯ä¸€ç§ç‰¹å®šçš„æ§åˆ¶ç­–ç•¥ï¼Œä¸“é—¨ç”¨äºå¤„ç†å­—èŠ‚æ•°æ®ã€‚å®ƒä¸»è¦ç”¨äºäºŒè¿›åˆ¶æ•°æ®çš„æµï¼Œå¦‚æ–‡ä»¶æµæˆ–ç½‘ç»œä¼ è¾“ã€‚</p><ul><li><strong>highWaterMark</strong>: è¿™æ˜¯<code>byteLengthQueuingStrategy</code>çš„ä¸€ä¸ªå±æ€§ï¼Œè¡¨ç¤ºâ€œé«˜æ°´ä½æ ‡â€ã€‚ç®€å•åœ°è¯´ï¼Œå®ƒå®šä¹‰äº†æµä¸­èƒ½å¤Ÿç¼“å­˜çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œåœ¨è¾¾åˆ°è¿™ä¸ªé˜ˆå€¼ä¹‹å‰ï¼Œæµä¼šå°½å¯èƒ½åœ°æ¥æ”¶æ•°æ®ã€‚ä¸€æ—¦è¾¾åˆ°æˆ–è¶…è¿‡è¿™ä¸ªé˜ˆå€¼ï¼Œæµå°†åœæ­¢æ¥æ”¶æ•°æ®ï¼Œç›´åˆ°ç¼“å­˜çš„æ•°æ®é‡ä¸‹é™åˆ°ä¸€ä¸ªå¯æ¥å—çš„æ°´å¹³ã€‚è¿™ä¸ªæœºåˆ¶å°±æ˜¯ç”¨æ¥æ§åˆ¶èƒŒå‹çš„ã€‚</li></ul><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-5" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-5"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œéœ€è¦ä»ä¸€ä¸ªå¤§æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œç„¶åé€šè¿‡ç½‘ç»œå‘é€è¿™äº›æ•°æ®ã€‚</p><ol><li><p><strong>æ–‡ä»¶æµè¯»å–</strong>: ä½ ä½¿ç”¨ Node.js åˆ›å»ºä¸€ä¸ªè¯»å–æµæ¥è¯»å–ä¸€ä¸ªéå¸¸å¤§çš„æ–‡ä»¶ã€‚ä¸ºäº†é¿å…ä¸€æ¬¡æ€§å°†æ•´ä¸ªæ–‡ä»¶è½½å…¥å†…å­˜ï¼Œä½ è®¾ç½®<code>highWaterMark</code>ä¸º<code>1024 * 1024</code>ï¼ˆå³ 1MBï¼‰ã€‚è¿™æ„å‘³ç€ï¼Œè¯»å–æµä¼šå°è¯•ç»´æŒå¤§çº¦ 1MB çš„æ•°æ®åœ¨å†…å­˜ä¸­ç­‰å¾…å¤„ç†ã€‚</p></li><li><p><strong>ç½‘ç»œä¼ è¾“</strong>: æ•°æ®é€šè¿‡ç½‘ç»œå‘é€ç»™æ¥æ”¶è€…ã€‚å¦‚æœç½‘ç»œè¿æ¥æ…¢ï¼Œå‘é€é€Ÿåº¦å¯èƒ½è·Ÿä¸ä¸Šè¯»å–é€Ÿåº¦ï¼Œè¿™æ—¶<code>highWaterMark</code>èµ·åˆ°äº†å…³é”®ä½œç”¨ã€‚ä¸€æ—¦ç¼“å†²åŒºå†…çš„æ•°æ®ç§¯ç´¯åˆ° 1MBï¼Œè¯»å–æ“ä½œä¼šæš‚åœï¼Œç›´åˆ°ç¼“å†²åŒºçš„æ•°æ®å‡å°‘ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢ç¨‹åºå› ä¸ºæ¶ˆè€—è¿‡å¤šå†…å­˜è€Œå´©æºƒã€‚</p></li></ol><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œ<code>byteLengthQueuingStrategy.highWaterMark</code>å¸®åŠ©ç®¡ç†äº†æ•°æ®æµå’ŒèƒŒå‹ï¼Œç¡®ä¿äº†æ•°æ®å¤„ç†çš„ç¨³å®šæ€§å’Œæ•ˆç‡ã€‚</p><h4 id="bytelengthqueuingstrategy-size" tabindex="-1"><a class="header-anchor" href="#bytelengthqueuingstrategy-size"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#bytelengthqueuingstrategysize" target="_blank" rel="noopener noreferrer">byteLengthQueuingStrategy.size</a></span></a></h4><p>å½“æˆ‘ä»¬è°ˆè®ºåˆ° Node.js ä¸­çš„<code>byteLengthQueuingStrategy.size</code>æ—¶ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯åœ¨è®¨è®ºæµï¼ˆStreamï¼‰æ§åˆ¶å’Œä¼˜åŒ–æ•°æ®å¤„ç†çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µã€‚ä¸ºäº†æ›´å¥½åœ°ç†è§£è¿™ä¸ªæ¦‚å¿µï¼Œå…ˆè®©æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥çœ‹ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯-stream" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯-stream"><span>ä»€ä¹ˆæ˜¯ Streamï¼Ÿ</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œæµæ˜¯ä¸€ç§å¤„ç†è¯»å†™æ•°æ®çš„æ–¹å¼ï¼šæ•°æ®ä¸éœ€è¦ä¸€æ¬¡æ€§å…¨éƒ¨åŠ è½½è¿›å†…å­˜ä¸­ï¼Œè€Œæ˜¯å¯ä»¥åˆ†æ‰¹æ¬¡é€æ¸å¤„ç†ã€‚è¿™å¯¹äºå¤„ç†å¤§æ–‡ä»¶æˆ–è€…å®æ—¶æ•°æ®ä¼ è¾“éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå‡å°‘äº†å†…å­˜çš„ä½¿ç”¨ï¼Œæé«˜äº†åº”ç”¨ç¨‹åºçš„æ•ˆç‡ã€‚</p><h3 id="queuing-strategy-é˜Ÿåˆ—ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#queuing-strategy-é˜Ÿåˆ—ç­–ç•¥"><span>Queuing Strategyï¼ˆé˜Ÿåˆ—ç­–ç•¥ï¼‰</span></a></h3><p>é˜Ÿåˆ—ç­–ç•¥å…è®¸ä½ æ§åˆ¶æ•°æ®åœ¨æµä¸­å¦‚ä½•è¢«ç¼“å†²ï¼ˆå³æš‚æ—¶å­˜å‚¨ï¼‰ã€‚è¿™æ˜¯é€šè¿‡è®¾ç½®ä¸€äº›æ¡ä»¶æ¥å®ç°çš„ï¼Œæ¯”å¦‚ä½•æ—¶å¼€å§‹è·å–æ›´å¤šæ•°æ®ï¼Œä»¥åŠä½•æ—¶åœæ­¢ã€‚</p><h3 id="bytelengthqueuingstrategy" tabindex="-1"><a class="header-anchor" href="#bytelengthqueuingstrategy"><span>byteLengthQueuingStrategy</span></a></h3><p><code>byteLengthQueuingStrategy</code> æ˜¯ä¸€ç§ç‰¹å®šçš„é˜Ÿåˆ—ç­–ç•¥ï¼Œå…¶æ ¸å¿ƒç”¨é€”æ˜¯å¸®åŠ©æ§åˆ¶åŸºäºå­—èŠ‚é•¿åº¦çš„æµçš„ç¼“å†²ã€‚ä½¿ç”¨è¿™ç§ç­–ç•¥æ—¶ï¼Œä½ å¯ä»¥æ ¹æ®æ•°æ®å—ï¼ˆchunkï¼‰çš„å­—èŠ‚å¤§å°æ¥è°ƒæ•´æµçš„è¡Œä¸ºã€‚</p><h3 id="bytelengthqueuingstrategy-size-1" tabindex="-1"><a class="header-anchor" href="#bytelengthqueuingstrategy-size-1"><span>byteLengthQueuingStrategy.size</span></a></h3><p>åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œ<code>.size</code>æ˜¯ä¸€ä¸ªå±æ€§ï¼Œç”¨äºæŒ‡å®šæ€æ ·è®¡ç®—å¾…ä¼ è¾“æ•°æ®å—çš„å¤§å°ã€‚å…·ä½“è€Œè¨€ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªæ•°æ®å—ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›è¯¥æ•°æ®å—çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</p><h3 id="å®é™…è¿ç”¨ä¾‹å­-18" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-18"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åº”ç”¨ç¨‹åºï¼Œéœ€è¦ä»ä¸€ä¸ªå¤§å‹æ—¥å¿—æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œç„¶åé€šè¿‡ç½‘ç»œå°†å…¶å‘é€åˆ°å¦ä¸€å°æœåŠ¡å™¨ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›ä¸€æ¬¡æ€§å°†æ•´ä¸ªæ–‡ä»¶éƒ½è¯»å…¥å†…å­˜ä¸­ï¼ˆå°¤å…¶æ˜¯å½“æ–‡ä»¶éå¸¸å¤§çš„æ—¶å€™ï¼‰ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿæƒ³é¿å…å› ä¸ºå‘é€é€Ÿåº¦è·Ÿä¸ä¸Šè¯»å–é€Ÿåº¦è€Œå¯¼è‡´å†…å­˜ä¸­ç§¯å‹å¤ªå¤šæœªå‘é€çš„æ•°æ®ã€‚</p><ol><li><p><strong>åˆ›å»ºå¯è¯»æµ</strong>ï¼šé¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡åˆ›å»ºä¸€ä¸ªå¯è¯»æµæ¥é€æ­¥è¯»å–æ–‡ä»¶ã€‚</p></li><li><p><strong>åº”ç”¨ byteLengthQueuingStrategy</strong>ï¼šä¸ºäº†æ§åˆ¶æ•°æ®çš„ä¼ è¾“æ•ˆç‡ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>byteLengthQueuingStrategy</code>æ¥ç®¡ç†æ•°æ®å—çš„ç¼“å†²ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä¼šåŸºäºæ•°æ®å—çš„å¤§å°ï¼ˆå­—èŠ‚é•¿åº¦ï¼‰æ¥å†³å®šä½•æ—¶æ·»åŠ æ›´å¤šæ•°æ®åˆ°ç¼“å†²åŒºï¼Œä»¥åŠä½•æ—¶ä»ç¼“å†²åŒºå‘é€æ•°æ®ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/large/log/file.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> totalBytesSent</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å½“æµå¼€å§‹è¯»å–æ•°æ®æ—¶æ‰§è¡Œçš„ä»£ç </span></span>
<span class="line"><span style="color:#D8DEE9;">    fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">      totalBytesSent</span><span style="color:#81A1C1;"> +=</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">length</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">Sent </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">totalBytesSent</span><span style="color:#81A1C1;">}</span><span style="color:#A3BE8C;"> bytes of data</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">    fileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">end</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#88C0D0;">  strategy</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ByteLengthQueuingStrategy</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> highWaterMark</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>ByteLengthQueuingStrategy</code>æ¥æ§åˆ¶æ•°æ®çš„ç¼“å†²ï¼Œå…¶ä¸­<code>highWaterMark</code>è®¾ç½®ä¸º 1MBï¼Œæ„å‘³ç€å½“ç¼“å†²çš„æ•°æ®è¾¾åˆ°æˆ–è¶…è¿‡ 1MB æ—¶ï¼Œç³»ç»Ÿä¼šå°½é‡å‡å°‘è¯»å–æ“ä½œï¼Œç›´åˆ°ç¼“å†²åŒºä¸­çš„æ•°æ®é‡å‡å°‘ã€‚</p><p>è¿™ç§æ–¹å¼ä½¿å¾—å†…å­˜çš„ä½¿ç”¨æ›´åŠ é«˜æ•ˆï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®æ•°æ®ä¼ è¾“çš„å®é™…æƒ…å†µåŠ¨æ€è°ƒæ•´æ•°æ®çš„å¤„ç†é€Ÿåº¦ï¼Œä»è€Œä¼˜åŒ–æ•´ä½“çš„æ•°æ®å¤„ç†æµç¨‹ã€‚</p><h3 id="class-countqueuingstrategy" tabindex="-1"><a class="header-anchor" href="#class-countqueuingstrategy"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-countqueuingstrategy" target="_blank" rel="noopener noreferrer">Class: CountQueuingStrategy</a></span></a></h3><p>ç†è§£ Node.js v21.7.1 ä¸­çš„ <code>CountQueuingStrategy</code> ç±»ï¼Œé¦–å…ˆéœ€è¦äº†è§£ä¸€äº›èƒŒæ™¯æ¦‚å¿µã€‚</p><h3 id="æµ-streams-ä¸èƒŒå‹-backpressure" tabindex="-1"><a class="header-anchor" href="#æµ-streams-ä¸èƒŒå‹-backpressure"><span>æµ(Streams)ä¸èƒŒå‹(Backpressure)</span></a></h3><p>åœ¨ Node.js å’Œè®¸å¤šç¼–ç¨‹ç¯å¢ƒä¸­ï¼Œ&quot;æµ&quot; æ˜¯ä¸€ç§å¤„ç†æ•°æ®çš„æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯å½“æ•°æ®é‡å¾ˆå¤§æˆ–è€…æ•°æ®æ˜¯é€æ¸äº§ç”Ÿçš„æ—¶å€™ã€‚æƒ³è±¡ä¸€ä¸‹ä½ ç”¨ä¸€æ ¹æ°´ç®¡æ¥æ°´ï¼Œä½†æ˜¯æ°´å¤ªå¤šäº†ï¼Œä½ çš„æ¡¶è£…ä¸ä¸‹ï¼Œè¿™é‡Œå°±äº§ç”Ÿäº†ä¸€ä¸ªé—®é¢˜ï¼Œå³â€œèƒŒå‹â€ã€‚</p><p>â€œèƒŒå‹â€å‘ç”Ÿåœ¨æ•°æ®ç”Ÿäº§é€Ÿåº¦è¶…è¿‡æ¶ˆè´¹é€Ÿåº¦æ—¶ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æœºåˆ¶æ¥æ§åˆ¶æ•°æ®çš„æµåŠ¨ï¼Œä»¥é˜²æ­¢ç¨‹åºè¢«è¿‡å¤šæœªå¤„ç†çš„æ•°æ®æ·¹æ²¡ã€‚è¿™æ­£æ˜¯ <code>CountQueuingStrategy</code> å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚</p><h3 id="countqueuingstrategy" tabindex="-1"><a class="header-anchor" href="#countqueuingstrategy"><span>CountQueuingStrategy</span></a></h3><p><code>CountQueuingStrategy</code> æ˜¯ Node.js ä¸­å®ç°æµæ§åˆ¶çš„ä¸€ç§ç­–ç•¥ï¼Œå®ƒå±äº Web Streams API çš„ä¸€éƒ¨åˆ†ã€‚æ­¤ç­–ç•¥ä¸»è¦åŸºäºé˜Ÿåˆ—ä¸­é¡¹çš„æ•°é‡æ¥å†³å®šä½•æ—¶åº”è¯¥æ–½åŠ èƒŒå‹ï¼Œç®€å•è¯´å°±æ˜¯åŸºäºé˜Ÿåˆ—é•¿åº¦æ¥æ§åˆ¶æµã€‚</p><h3 id="æ„å»º-countqueuingstrategy" tabindex="-1"><a class="header-anchor" href="#æ„å»º-countqueuingstrategy"><span>æ„å»º CountQueuingStrategy</span></a></h3><p>ä½ å¯ä»¥è¿™æ ·åˆ›å»ºä¸€ä¸ª <code>CountQueuingStrategy</code> å¯¹è±¡ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> CountQueuingStrategy</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> strategy</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> CountQueuingStrategy</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> highWaterMark</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œï¼Œ<code>highWaterMark</code> æ˜¯ä½ è®¾å®šçš„é˜Ÿåˆ—é¡¹ç›®æ•°ä¸Šé™ï¼Œåœ¨è¾¾åˆ°è¿™ä¸ªæ•°ç›®ä¹‹åï¼Œç³»ç»Ÿå°†å¼€å§‹æ–½åŠ èƒŒå‹ã€‚</p><h3 id="å®é™…åº”ç”¨ä¾‹å­-5" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ä¾‹å­-5"><span>å®é™…åº”ç”¨ä¾‹å­</span></a></h3><h4 id="ä¾‹å­-1-æ–‡ä»¶è¯»å†™" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-æ–‡ä»¶è¯»å†™"><span>ä¾‹å­ 1ï¼šæ–‡ä»¶è¯»å†™</span></a></h4><p>æƒ³è±¡ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦ä»ä¸€ä¸ªéå¸¸å¤§çš„æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œå¹¶ä¸”å¯¹æ¯è¡Œæ•°æ®è¿›è¡Œå¤„ç†åå†™å…¥å¦ä¸€ä¸ªæ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶éå¸¸å¤§ï¼Œä½ ä¸èƒ½ä¸€æ¬¡æ€§å°†å®ƒå…¨éƒ¨è¯»å…¥å†…å­˜ã€‚è¿™æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨æµå’Œ <code>CountQueuingStrategy</code> æ¥æ§åˆ¶æ•°æ®çš„å¤„ç†æµç¨‹ï¼Œç¡®ä¿åœ¨æ•°æ®å¤„ç†è·Ÿä¸ä¸Šæ•°æ®è¯»å–é€Ÿåº¦æ—¶ï¼Œæš‚åœä»æºæ–‡ä»¶è¯»å–æ•°æ®ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> Transform</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> pipeline</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> CountQueuingStrategy</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªè½¬æ¢æµï¼ˆtransform streamï¼‰ï¼Œç”¨äºå¤„ç†æ–‡ä»¶ä¸­çš„æ¯ä¸€è¡Œ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> processLine</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Transform</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  transform</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> encoding</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> callback</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å‡è®¾å¯¹æ•°æ®å—è¿›è¡ŒæŸç§å¤„ç†</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> processedChunk</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toUpperCase</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#88C0D0;">    callback</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">null</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> processedChunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ª CountQueuingStrategyï¼Œè®¾ç½®èƒŒå‹å¼€å§‹çš„é˜Ÿåˆ—é•¿åº¦ä¸º 10</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> strategy</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> CountQueuingStrategy</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> highWaterMark</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 10</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨ fs.createReadStream åˆ›å»ºä¸€ä¸ªå¯è¯»æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readable</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">source.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨ fs.createWriteStream åˆ›å»ºä¸€ä¸ªå¯å†™æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writable</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">destination.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨ pipeline æ–¹æ³•æ¥ç®¡é“åŒ–è¿™äº›æµï¼ŒåŒæ—¶æ’å…¥æˆ‘ä»¬çš„ç­–ç•¥</span></span>
<span class="line"><span style="color:#88C0D0;">pipeline</span><span style="color:#D8DEE9FF;">(</span></span>
<span class="line"><span style="color:#D8DEE9;">  readable</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9;">  processLine</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  {</span><span style="color:#88C0D0;"> writableStrategy</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9;"> strategy</span><span style="color:#ECEFF4;"> },</span></span>
<span class="line"><span style="color:#D8DEE9;">  writable</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  (</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Pipeline failed.</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Pipeline succeeded.</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰ç›´æ¥æ“ä½œ <code>CountQueuingStrategy</code>ï¼Œä½†é€šè¿‡è®¾ç½®ä¸€ä¸ªé«˜æ°´ä½æ ‡è®°ï¼ˆ<code>highWaterMark</code>ï¼‰ï¼Œæˆ‘ä»¬å‘Šè¯‰ Node.js çš„æµæ§åˆ¶æœºåˆ¶ï¼Œåœ¨â€œå¾…å¤„ç†â€çš„æ•°æ®å—æ•°é‡è¾¾åˆ° 10 ä¸ªæ—¶ï¼Œå¼€å§‹æ–½åŠ èƒŒå‹ï¼Œæš‚åœè¿›ä¸€æ­¥çš„æ•°æ®è¯»å–ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­çš„æ•°æ®æ•°é‡é™ä½ã€‚</p><p>è¿™æ ·ï¼Œå³ä½¿æ˜¯å¤„ç†å¤§æ–‡ä»¶ï¼Œä½ ä¹Ÿä¸ä¼šå› ä¸ºå†…å­˜ä½¿ç”¨è¿‡å¤šè€Œä½¿ç¨‹åºå´©æºƒï¼Œæ•°æ®æµçš„é€Ÿåº¦ä¹Ÿä¼šæ ¹æ®å¤„ç†èƒ½åŠ›è‡ªåŠ¨è°ƒèŠ‚ã€‚</p><h3 id="æ€»ç»“-11" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-11"><span>æ€»ç»“</span></a></h3><p><code>CountQueuingStrategy</code> æ˜¯ Web Streams API æä¾›çš„ä¸€ç§ç­–ç•¥ï¼Œç”¨äºåŸºäºé˜Ÿåˆ—ä¸­çš„é¡¹æ•°æ¥æ§åˆ¶èƒŒå‹ï¼Œå¸®åŠ©ä½ æ›´å¥½åœ°ç®¡ç†åœ¨ Node.js åº”ç”¨ä¸­çš„æ•°æ®æµåŠ¨ã€‚é€šè¿‡åˆç†è®¾ç½® <code>highWaterMark</code>ï¼Œä½ å¯ä»¥æ§åˆ¶æ•°æ®æµçš„é€Ÿåº¦ï¼Œç¡®ä¿åº”ç”¨çš„ç¨³å®šæ€§å’Œé«˜æ•ˆæ€§ã€‚</p><h4 id="new-countqueuingstrategy-init" tabindex="-1"><a class="header-anchor" href="#new-countqueuingstrategy-init"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#new-countqueuingstrategyinit" target="_blank" rel="noopener noreferrer">new CountQueuingStrategy(init)</a></span></a></h4><p>Node.js ä¸­çš„<code>CountQueuingStrategy</code>æ˜¯ä¸€ä¸ªä¸ Web Streams API äº¤äº’æ—¶ç”¨äºæ§åˆ¶æµé‡çš„ç­–ç•¥ä¹‹ä¸€ã€‚åœ¨ç†è§£è¿™ä¸ªæ¦‚å¿µå‰ï¼Œæˆ‘ä»¬å…ˆèŠä¸€ä¸‹â€œæµâ€å’Œâ€œèƒŒå‹ï¼ˆbackpressureï¼‰â€ã€‚</p><h3 id="æµä¸èƒŒå‹" tabindex="-1"><a class="header-anchor" href="#æµä¸èƒŒå‹"><span>æµä¸èƒŒå‹</span></a></h3><p>æƒ³è±¡ä½ æœ‰ä¸€ä¸ªæ°´æ¡¶ï¼ˆç”Ÿäº§è€…ï¼‰ï¼Œé€šè¿‡ä¸€æ ¹ç®¡é“å‘å¦ä¸€ä¸ªæ°´æ¡¶ï¼ˆæ¶ˆè´¹è€…ï¼‰ä¼ æ°´ã€‚å¦‚æœç”Ÿäº§è€…çš„æ°´å€’å¾—å¤ªå¿«ï¼Œè€Œæ¶ˆè´¹è€…çš„æ¡¶è£…æ°´çš„é€Ÿåº¦è·Ÿä¸ä¸Šï¼Œé‚£ä¹ˆç®¡é“å¯èƒ½ä¼šæº¢å‡ºã€‚åœ¨ç¼–ç¨‹ä¸­ï¼Œâ€œæµâ€å°±ç±»ä¼¼äºè¿™ç§ä»ä¸€ä¸ªåœ°æ–¹åˆ°å¦ä¸€ä¸ªåœ°æ–¹çš„æ•°æ®ä¼ è¾“è¿‡ç¨‹ã€‚è€Œâ€œèƒŒå‹â€åˆ™æ˜¯æŒ‡å½“æ•°æ®çš„æ¥æ”¶æ–¹ï¼ˆæ¶ˆè´¹è€…ï¼‰å¤„ç†ä¸è¿‡æ¥å‘é€æ–¹ï¼ˆç”Ÿäº§è€…ï¼‰é€Ÿåº¦æ—¶äº§ç”Ÿçš„å‹åŠ›ï¼Œéœ€è¦ä¸€ç§æœºåˆ¶æ¥é€šçŸ¥ç”Ÿäº§è€…å‡ç¼“æ•°æ®çš„å‘é€é€Ÿåº¦ã€‚</p><h3 id="countqueuingstrategy-1" tabindex="-1"><a class="header-anchor" href="#countqueuingstrategy-1"><span>CountQueuingStrategy</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œ<code>CountQueuingStrategy</code>å°±æ˜¯è¿™æ ·ä¸€ç§æœºåˆ¶ï¼Œå®ƒé€šè¿‡é™å®šé˜Ÿåˆ—ä¸­çš„â€œå—ï¼ˆchunkï¼‰â€æ•°é‡æ¥å®ç°èƒŒå‹çš„ç®¡ç†ã€‚è¿™é‡Œçš„â€œå—â€å¯ä»¥ç†è§£ä¸ºæ•°æ®çš„ä¸€ä¸ªå•ä½å—ï¼Œæ¯”å¦‚ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…æ–‡ä»¶çš„ä¸€éƒ¨åˆ†ã€‚</p><h4 id="åˆå§‹åŒ–-countqueuingstrategy" tabindex="-1"><a class="header-anchor" href="#åˆå§‹åŒ–-countqueuingstrategy"><span>åˆå§‹åŒ– CountQueuingStrategy</span></a></h4><p>å½“ä½ åˆ›å»ºä¸€ä¸ª<code>CountQueuingStrategy</code>å®ä¾‹æ—¶ï¼Œéœ€è¦æä¾›ä¸€ä¸ªåˆå§‹åŒ–å‚æ•°<code>init</code>ï¼Œè¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå±æ€§ï¼š</p><ul><li><code>highWaterMark</code>ï¼šè¿™æ˜¯é˜Ÿåˆ—ä¸­å…è®¸çš„æœ€å¤§å—æ•°ã€‚å½“é˜Ÿåˆ—é•¿åº¦è¾¾åˆ°è¿™ä¸ªæ•°å€¼æ—¶ï¼Œç³»ç»Ÿå°†å°è¯•å‡æ…¢æ•°æ®çš„å‘é€é€Ÿåº¦ä»¥é¿å…æº¢å‡ºã€‚</li></ul><h4 id="å®é™…è¿ç”¨ç¤ºä¾‹-15" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-15"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦ä»ä¸€ä¸ªæ–‡ä»¶ä¸­è¯»å–æ•°æ®å¹¶å¤„ç†ï¼Œä½†æ˜¯ä½ å¸Œæœ›èƒ½å¤Ÿæ§åˆ¶å†…å­˜ä½¿ç”¨ï¼Œé¿å…å› ä¸ºè¯»å–é€Ÿåº¦è¿‡å¿«è€Œå¯¼è‡´å†…å­˜æº¢å‡ºã€‚ä½ å¯ä»¥ä½¿ç”¨<code>CountQueuingStrategy</code>æ¥ç®¡ç†è¿™ä¸ªæµçš„èƒŒå‹ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> CountQueuingStrategy</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ¯æ¬¡åªå¤„ç†5ä¸ªå—çš„æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> countQueuingStrategy</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> CountQueuingStrategy</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> highWaterMark</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 5</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/your/file.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> webStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">from</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">readStream</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">  strategy</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9;"> countQueuingStrategy</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">async</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> webStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">break;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // åœ¨è¿™é‡Œå¤„ç†æ¯ä¸ªå—çš„æ•°æ®...</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>CountQueuingStrategy</code>é™å®šäº†æ–‡ä»¶è¯»å–æµä¸­é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ä¸º 5ã€‚è¿™æ„å‘³ç€å¦‚æœå¤„ç†ï¼ˆæ¶ˆè´¹ï¼‰é€Ÿåº¦è·Ÿä¸ä¸Šè¯»å–ï¼ˆç”Ÿäº§ï¼‰é€Ÿåº¦ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒæ•´æ¥é¿å…å†…å­˜è¢«è¿‡åº¦æ¶ˆè€—ã€‚è¿™å¯¹äºæå‡åº”ç”¨æ€§èƒ½ã€é˜²æ­¢å†…å­˜æº¢å‡ºå¼‚å¸¸éå¸¸æœ‰å¸®åŠ©ã€‚</p><p>æ€»ç»“èµ·æ¥ï¼Œ<code>CountQueuingStrategy</code>æä¾›äº†ä¸€ç§ç®€å•æœ‰æ•ˆçš„æ–¹å¼æ¥ç®¡ç† Node.js ä¸­æ•°æ®æµçš„èƒŒå‹ï¼Œé€šè¿‡é™åˆ¶é˜Ÿåˆ—ä¸­çš„æ•°æ®å—æ•°é‡æ¥å¹³è¡¡ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„é€Ÿåº¦å·®å¼‚ã€‚</p><h4 id="countqueuingstrategy-highwatermark" tabindex="-1"><a class="header-anchor" href="#countqueuingstrategy-highwatermark"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#countqueuingstrategyhighwatermark" target="_blank" rel="noopener noreferrer">countQueuingStrategy.highWaterMark</a></span></a></h4><p>åœ¨è§£é‡Š<code>countQueuingStrategy.highWaterMark</code>ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£ä¸€äº›èƒŒæ™¯çŸ¥è¯†ã€‚</p><p><strong>ä»€ä¹ˆæ˜¯ Streamsï¼Ÿ</strong></p><p>åœ¨ç¼–ç¨‹ä¸­ï¼ŒStreams æ˜¯å¤„ç†è¯»å†™æ•°æ®çš„ä¸€ç§æ–¹å¼ã€‚æƒ³è±¡ä¸€ä¸‹ä½ æœ‰ä¸€ä¸ªå¤§ç“¶å­ï¼ˆæ•°æ®æºï¼‰å’Œä¸€ä¸ªå°æ¯å­ï¼ˆç¨‹åºï¼‰ï¼Œä½ éœ€è¦æŠŠç“¶å­é‡Œçš„æ°´ï¼ˆæ•°æ®ï¼‰å€’å…¥æ¯å­ä¸­ã€‚ä½†ç”±äºæ¯å­å°ï¼Œä¸èƒ½ä¸€æ¬¡æ€§æ¥å—å…¨éƒ¨çš„æ°´ï¼Œæ‰€ä»¥ä½ éœ€è¦åˆ†æ‰¹æ¬¡è¿›è¡Œã€‚è¿™å°±åƒæ˜¯ Stream åœ¨å¤„ç†å¤§é‡æ•°æ®æ—¶çš„å·¥ä½œæ–¹å¼ã€‚</p><p><strong>ä¸ºä»€ä¹ˆéœ€è¦ Queuing Strategiesï¼Ÿ</strong></p><p>åœ¨ä¸Šè¿°æ¯”å–»ä¸­ï¼Œå¦‚æœä½ å€’æ°´å¤ªå¿«ï¼Œå°æ¯å­ä¼šæº¢å‡ºã€‚åœ¨ Streams ä¸­ï¼Œä¹Ÿå­˜åœ¨ç±»ä¼¼çš„é—®é¢˜ï¼šå½“æ•°æ®äº§ç”Ÿçš„é€Ÿåº¦è¶…è¿‡æ¶ˆè´¹çš„é€Ÿåº¦æ—¶ï¼Œå°±éœ€è¦æŸç§æœºåˆ¶æ¥æ§åˆ¶æµåŠ¨ï¼Œé˜²æ­¢&quot;æ•°æ®æº¢å‡º&quot;ã€‚è¿™å°±æ˜¯ Queuing Strategyï¼ˆé˜Ÿåˆ—ç­–ç•¥ï¼‰çš„ç”¨æ­¦ä¹‹åœ°ã€‚</p><p><strong>Queuing Strategies æœ‰ä¸¤ç§ç±»å‹ï¼š</strong></p><ol><li><strong>CountQueuingStrategy</strong>ï¼šé€šè¿‡è®¡æ•°æ¥æ§åˆ¶ï¼Œå³æ ¹æ®åœ¨é˜Ÿåˆ—ä¸­çš„é¡¹ç›®æ•°é‡æ¥å†³å®šä½•æ—¶åœæ­¢ä»æºè¯»å–æ›´å¤šçš„æ•°æ®ã€‚</li><li><strong>ByteLengthQueuingStrategy</strong>ï¼šé€šè¿‡æ•°æ®çš„å­—èŠ‚é•¿åº¦æ¥æ§åˆ¶ï¼Œé€‚ç”¨äºä½ éœ€è¦æ ¹æ®æ•°æ®å¤§å°è€Œéé¡¹ç›®æ•°é‡æ¥æ§åˆ¶æµçš„åœºåˆã€‚</li></ol><p><strong>countQueuingStrategy.highWaterMark çš„è§’è‰²</strong></p><p><code>highWaterMark</code> æ˜¯ä¸€ä¸ªè®¾ç½®åœ¨ <code>CountQueuingStrategy</code> ä¸­çš„å‚æ•°ï¼Œå®ƒå®šä¹‰äº†é˜Ÿåˆ—å¯ä»¥å®¹çº³çš„æœ€å¤§é¡¹ç›®æ•°ï¼Œåœ¨è¾¾åˆ°è¿™ä¸ªæ•°é‡ä¹‹å‰ï¼Œæµä¼šæŒç»­ä»æ•°æ®æºè¯»å–æ•°æ®ã€‚ä¸€æ—¦è¾¾åˆ°æˆ–è¶…è¿‡è¿™ä¸ªé™åˆ¶ï¼Œæµä¼šæš‚åœè¯»å–æ•°æ®ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­çš„ä¸€äº›æ•°æ®è¢«æ¶ˆè´¹ï¼ˆå³è¢«å¤„ç†ï¼‰ã€‚è¿™ä¸ªæœºåˆ¶æœ‰åŠ©äºé¿å…åœ¨å¤„ç†è¾ƒæ…¢æ—¶æ•°æ®çš„ç§¯å‹ã€‚</p><p><strong>ä¸¾ä¾‹è¯´æ˜</strong></p><p>å‡è®¾ä½ æ­£åœ¨æ„å»ºä¸€ä¸ªèŠå¤©åº”ç”¨ï¼Œåç«¯ä½¿ç”¨ Node.jsã€‚æ¯å½“æœ‰æ–°æ¶ˆæ¯æ—¶ï¼Œä½ çš„æœåŠ¡å™¨éƒ½ä¼šæ”¶åˆ°ä¸€ä¸ªåŒ…å«æ¶ˆæ¯çš„æ•°æ®æµã€‚å¦‚æœè¿™äº›æ¶ˆæ¯æ¥å¾—å¤ªå¿«ï¼Œè¶…å‡ºäº†æœåŠ¡å™¨å¤„ç†çš„é€Ÿåº¦ï¼Œä½¿ç”¨ <code>CountQueuingStrategy</code> å’Œåˆé€‚çš„ <code>highWaterMark</code> è®¾ç½®å¯ä»¥å¸®åŠ©ä½ æ§åˆ¶è¿™äº›æ¶ˆæ¯çš„æµåŠ¨é€Ÿåº¦ï¼Œé˜²æ­¢æœåŠ¡å™¨å› ä¸ºå¤„ç†ä¸è¿‡æ¥è€Œå´©æºƒã€‚</p><p>ä¾‹å¦‚ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> CountQueuingStrategy</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> messageStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span></span>
<span class="line"><span style="color:#ECEFF4;">  {</span></span>
<span class="line"><span style="color:#616E88;">    // å®šä¹‰å¦‚ä½•è¯»å–æ•°æ®çš„å‡½æ•°</span></span>
<span class="line"><span style="color:#88C0D0;">    pull</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // å‡è®¾ fetchNextMessage() æ–¹æ³•å¼‚æ­¥è·å–ä¸‹ä¸€æ¡æ¶ˆæ¯</span></span>
<span class="line"><span style="color:#88C0D0;">      fetchNextMessage</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">message</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">message</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å°†æ¶ˆæ¯åŠ å…¥æµ</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#81A1C1;">  new</span><span style="color:#88C0D0;"> CountQueuingStrategy</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> highWaterMark</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 5</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>highWaterMark</code> è¢«è®¾ç½®ä¸º 5ï¼Œæ„å‘³ç€å¦‚æœé˜Ÿåˆ—ä¸­å·²ç»æœ‰ 5 æ¡æ¶ˆæ¯ç­‰å¾…å¤„ç†ï¼Œæµå°†æš‚åœæ‹‰å–æ–°æ¶ˆæ¯ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­çš„ä¸€äº›æ¶ˆæ¯è¢«æ¶ˆè´¹ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>countQueuingStrategy.highWaterMark</code> åœ¨ Node.js ä¸­æ˜¯ç”¨æ¥æ§åˆ¶åŸºäºæ•°ç›®çš„æµé‡æ§åˆ¶çš„ä¸€ä¸ªé‡è¦å‚æ•°ï¼Œé€šè¿‡å®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç®¡ç†æ•°æ®çš„æµå…¥ï¼Œé¿å…å› ä¸ºå¤„ç†ä¸åŠæ—¶è€Œå¯¼è‡´çš„é—®é¢˜ã€‚</p><h4 id="countqueuingstrategy-size" tabindex="-1"><a class="header-anchor" href="#countqueuingstrategy-size"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#countqueuingstrategysize" target="_blank" rel="noopener noreferrer">countQueuingStrategy.size</a></span></a></h4><p>Node.js æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ JavaScript è¿è¡Œæ—¶ç¯å¢ƒï¼Œå…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯æ‰§è¡Œ JavaScript ä»£ç ã€‚å®ƒå…·æœ‰éé˜»å¡ I/O å’Œäº‹ä»¶é©±åŠ¨çš„ç‰¹æ€§ï¼Œä½¿å¾—å®ƒç‰¹åˆ«é€‚åˆå¤„ç†é«˜å¹¶å‘åœºæ™¯ï¼Œå¦‚ Web åº”ç”¨ã€API æœåŠ¡ç­‰ã€‚åœ¨ Node.js çš„ä¼—å¤šåŠŸèƒ½ä¸­ï¼ŒWeb Streams API æ˜¯ä¸€ä¸ªé‡è¦çš„ç»„æˆéƒ¨åˆ†ï¼Œå®ƒä¸ºå¤„ç†æµæ•°æ®æä¾›äº†ä¸€å¥—æ ‡å‡†çš„æ¥å£ã€‚</p><h3 id="web-streams-å’Œ-countqueuingstrategy-size" tabindex="-1"><a class="header-anchor" href="#web-streams-å’Œ-countqueuingstrategy-size"><span>Web Streams å’Œ CountQueuingStrategy.size</span></a></h3><p>Web Streams æ˜¯ä¸€ç§å¤„ç†æµå¼æ•°æ®çš„æ–¹å¼ï¼Œæ¯”å¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œé€šä¿¡ç­‰ã€‚åœ¨å¤„ç†è¿™ç±»æ•°æ®æ—¶ï¼Œæˆ‘ä»¬å¸¸å¸¸éœ€è¦ä»¥é«˜æ•ˆä¸”å†…å­˜å‹å¥½çš„æ–¹å¼æ¥è¿›è¡Œï¼Œè¿™æ­£æ˜¯ Web Streams æ“…é•¿çš„ã€‚</p><p><code>CountQueuingStrategy</code> æ˜¯ Web Streams ä¸­çš„ä¸€ç§ç­–ç•¥ï¼Œç”¨äºæ§åˆ¶æµçš„èƒŒå‹ï¼ˆbackpressureï¼‰â€”â€”å³å½“æµçš„æ¶ˆè´¹é€Ÿåº¦ä½äºç”Ÿäº§é€Ÿåº¦æ—¶ï¼Œå¦‚ä½•ç®¡ç†å’Œç¼“å†²è¿›æ¥çš„æ•°æ®ã€‚å…·ä½“åˆ° <code>CountQueuingStrategy.size</code>ï¼Œå®ƒæ˜¯è¿™ä¸ªç­–ç•¥ä¸­ç”¨æ¥è®¡ç®—é˜Ÿåˆ—ä¸­æ•°æ®å—å¤§å°çš„å‡½æ•°ï¼Œè€Œåœ¨ <code>CountQueuingStrategy</code> ä¸­ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨ç®€åŒ–åˆ°ä»…è¿”å› <code>1</code>ã€‚è¿™æ„å‘³ç€æ¯ä¸ªæ•°æ®å—æ— è®ºå¤§å°ï¼Œå…¶åœ¨é˜Ÿåˆ—ä¸­çš„æƒé‡éƒ½è§†ä¸º <code>1</code>ã€‚</p><h3 id="å®é™…è¿ç”¨ä¾‹å­-19" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-19"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><h4 id="æ–‡ä»¶å¤„ç†" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶å¤„ç†"><span>æ–‡ä»¶å¤„ç†</span></a></h4><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œéœ€è¦é€è¡Œè¯»å–ç„¶åå¤„ç†ã€‚ä½¿ç”¨ <code>ReadableStream</code> æ¥è¯»å–æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ <code>CountQueuingStrategy</code> æ¥æ§åˆ¶æµçš„èƒŒå‹ï¼Œå¯ä»¥æœ‰æ•ˆç®¡ç†å†…å­˜ä½¿ç”¨ï¼Œé¿å…å› ä¸ºç”Ÿäº§é€Ÿåº¦è¿œé«˜äºæ¶ˆè´¹é€Ÿåº¦è€Œå¯¼è‡´çš„å†…å­˜æ³„éœ²ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> ReadableStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> processLargeFile</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">filePath</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">filePath</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#81A1C1;">      async</span><span style="color:#88C0D0;"> start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;"> of</span><span style="color:#D8DEE9;"> fileStream</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">          controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#D8DEE9;">        controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#81A1C1;">    new</span><span style="color:#88C0D0;"> CountQueuingStrategy</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> highWaterMark</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1024</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  )</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // å‡è®¾æˆ‘ä»¬åªæ˜¯ç®€å•åœ°æ‰“å°æ¯ä¸ªæ•°æ®å—</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">break;</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>CountQueuingStrategy</code> è¢«é…ç½®äº†ä¸€ä¸ª <code>highWaterMark</code>ï¼ˆæœ€é«˜æ°´ä½çº¿ï¼‰ä¸º <code>1024</code>ï¼Œç†è§£å®ƒä½œä¸ºæµä¸­èƒ½å¤Ÿè¢«ç¼“å†²çš„æ•°æ®å—çš„æœ€å¤§æ•°é‡ã€‚ç”±äºæˆ‘ä»¬ç”¨çš„ <code>size</code> å‡½æ•°æ€»æ˜¯è¿”å› <code>1</code>ï¼Œè¿™å®é™…ä¸Šæ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨æµçš„å†…éƒ¨é˜Ÿåˆ—ä¸­ä¿æŒæœ€å¤š <code>1024</code> ä¸ªæ•°æ®å—ã€‚</p><h4 id="ç½‘ç»œè¯·æ±‚å¤„ç†" tabindex="-1"><a class="header-anchor" href="#ç½‘ç»œè¯·æ±‚å¤„ç†"><span>ç½‘ç»œè¯·æ±‚å¤„ç†</span></a></h4><p>å¦ä¸€ä¸ªå®é™…ä¾‹å­å¯èƒ½æ¶‰åŠåˆ°æµå¼å¤„ç†ç½‘ç»œè¯·æ±‚ã€‚ä¾‹å¦‚ï¼Œæ‚¨æ­£åœ¨æ„å»ºä¸€ä¸ªæœåŠ¡ï¼Œè¯¥æœåŠ¡ä»å®¢æˆ·ç«¯æ¥æ”¶ä¸Šä¼ çš„å¤§é‡æ•°æ®ï¼Œå¹¶ä¸”æ‚¨å¸Œæœ›åœ¨æ•°æ®åˆ°è¾¾æ—¶é€æ­¥å¤„ç†æ•°æ®ï¼ŒåŒæ—¶ä¿æŒå†…å­˜ä½¿ç”¨ç‡ä½ã€‚</p><p>ä½¿ç”¨ç±»ä¼¼çš„ <code>ReadableStream</code> å’Œ <code>CountQueuingStrategy</code> ç»„åˆï¼Œæ‚¨å¯ä»¥å®‰æ’æ•°æ®çš„é¡ºåºå¤„ç†ï¼Œç¡®ä¿å³ä½¿æ˜¯åœ¨é«˜è´Ÿè½½ä¸‹ï¼Œä¹Ÿä¸ä¼šå› ä¸ºç§¯ç´¯è¿‡å¤šæœªå¤„ç†çš„æ•°æ®è€Œè€—å°½æœåŠ¡å™¨èµ„æºã€‚</p><h3 id="æ€»ç»“-12" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-12"><span>æ€»ç»“</span></a></h3><p>é€šè¿‡ä»¥ä¸Šä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>CountQueuingStrategy.size</code> åœ¨ Node.js ä¸­çš„å®é™…åº”ç”¨ä¸»è¦å…³æ³¨äºå¦‚ä½•æœ‰æ•ˆåœ°æ§åˆ¶æµæ•°æ®çš„èƒŒå‹æœºåˆ¶ï¼Œä»¥ä¾¿åœ¨å¤„ç†å¤§é‡æ•°æ®æˆ–é«˜å¹¶å‘è¯·æ±‚æ—¶ä¿æŒåº”ç”¨çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚</p><h3 id="class-textencoderstream" tabindex="-1"><a class="header-anchor" href="#class-textencoderstream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-textencoderstream" target="_blank" rel="noopener noreferrer">Class: TextEncoderStream</a></span></a></h3><p>åœ¨è§£é‡Š<code>TextEncoderStream</code>ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£ä¸€ä¸‹èƒŒæ™¯çŸ¥è¯†ã€‚</p><h3 id="åŸºç¡€æ¦‚å¿µ-9" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ-9"><span>åŸºç¡€æ¦‚å¿µ</span></a></h3><ul><li><strong>ç¼–ç ï¼ˆEncodingï¼‰</strong>ï¼šæ˜¯æŒ‡å°†å­—ç¬¦ä¸²ï¼ˆå¦‚æ–‡æœ¬ä¿¡æ¯ï¼‰è½¬æ¢æˆæœºå™¨èƒ½å¤Ÿå­˜å‚¨æˆ–ä¼ è¾“çš„æ ¼å¼ï¼Œä¾‹å¦‚äºŒè¿›åˆ¶æ ¼å¼ã€‚æœ€å¸¸è§çš„ç¼–ç æ–¹å¼æœ‰ UTF-8ã€ASCII ç­‰ã€‚</li><li><strong>æµï¼ˆStreamï¼‰</strong>ï¼šåœ¨è®¡ç®—æœºä¸­ï¼Œæµæ˜¯ä¸€ç³»åˆ—çš„æ•°æ®å…ƒç´ ï¼Œè¿™äº›æ•°æ®å…ƒç´ å¯ä»¥ä½œä¸ºä¸€ä¸ªè¿ç»­çš„æµè¢«è®¿é—®ã€‚åœ¨ Node.js ä¸­ï¼Œæµè¢«ç”¨æ¥å¤„ç†å’Œä¼ è¾“å¤§é‡æ•°æ®ï¼Œä¾‹å¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œé€šä¿¡ç­‰ï¼Œè€Œä¸å¿…ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜ä¸­ã€‚</li></ul><h3 id="textencoderstream" tabindex="-1"><a class="header-anchor" href="#textencoderstream"><span>TextEncoderStream</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œ<code>TextEncoderStream</code>æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç±»ï¼Œå®ƒç”¨äºå°†æ¥æ”¶åˆ°çš„å­—ç¬¦ä¸²æ•°æ®ï¼ˆé€šå¸¸ä»¥ UTF-8 ç¼–ç ï¼‰è½¬æ¢æˆä¸€ä¸ªæµå¼çš„äºŒè¿›åˆ¶æ•°æ®æ ¼å¼ã€‚ç®€å•åœ°è¯´ï¼Œå®ƒå…è®¸ä½ æŠŠæ–‡æœ¬ä¿¡æ¯è½¬æ¢ä¸ºæµå¼çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡æµçš„æ–¹å¼å¤„ç†å¤§é‡æ–‡æœ¬æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å¤„ç†å®Œæ‰€æœ‰æ•°æ®ï¼Œä»è€Œæé«˜äº†ç¨‹åºçš„æ•ˆç‡å’Œæ€§èƒ½ã€‚</p><h4 id="å®é™…è¿ç”¨-1" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨-1"><span>å®é™…è¿ç”¨</span></a></h4><ol><li><p><strong>æ–‡ä»¶å†™å…¥</strong>ï¼šå‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦å°†å¤§é‡çš„æ–‡æœ¬æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ä½¿ç”¨<code>TextEncoderStream</code>å¯ä»¥å°†è¿™äº›æ–‡æœ¬æ•°æ®è½¬æ¢ä¸ºäºŒè¿›åˆ¶æµï¼Œå¹¶ä¸”é€šè¿‡æµçš„æ–¹å¼é€æ­¥å†™å…¥æ–‡ä»¶ï¼Œè¿™æ¯”ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ–‡æœ¬æ•°æ®è½¬æ¢å¹¶å†™å…¥æ›´åŠ é«˜æ•ˆã€‚</p></li><li><p><strong>ç½‘ç»œä¼ è¾“</strong>ï¼šå½“ä½ çš„ Node.js åº”ç”¨éœ€è¦é€šè¿‡ç½‘ç»œå‘é€å¤§é‡æ–‡æœ¬æ•°æ®æ—¶ï¼Œå¯ä»¥åˆ©ç”¨<code>TextEncoderStream</code>å°†æ–‡æœ¬æ•°æ®è½¬æ¢ä¸ºäºŒè¿›åˆ¶æµï¼Œç„¶åé€šè¿‡ç½‘ç»œæµå¼åœ°å‘é€å‡ºå»ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å†…å­˜çš„æ¶ˆè€—ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒé€æ­¥å‘é€æ•°æ®ï¼Œä¸å¿…ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å‡†å¤‡å¥½ã€‚</p></li></ol><h3 id="ç¤ºä¾‹ä»£ç -3" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹ä»£ç -3"><span>ç¤ºä¾‹ä»£ç </span></a></h3><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨<code>TextEncoderStream</code>æ¥å¤„ç†æ–‡æœ¬æ•°æ®ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> pipeline</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TextEncoderStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">util</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªTextEncoderStreamå®ä¾‹ï¼Œç”¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºUTF-8ç¼–ç çš„äºŒè¿›åˆ¶æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> encoder</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextEncoderStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯å†™æµï¼Œç”¨äºå†™å…¥æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> outputStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨pipelineè¿æ¥è¿™ä¸¤ä¸ªæµï¼Œè‡ªåŠ¨ç®¡ç†æ•°æ®ä¼ è¾“è¿‡ç¨‹</span></span>
<span class="line"><span style="color:#88C0D0;">pipeline</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">encoder</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> outputStream</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Pipeline failed.</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Pipeline succeeded.</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ç°åœ¨ï¼Œä½ å¯ä»¥å‘encoderå†™å…¥æ–‡æœ¬æ•°æ®ï¼Œå®ƒä¼šè¢«è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ•°æ®å¹¶å†™å…¥&#39;example.txt&#39;æ–‡ä»¶</span></span>
<span class="line"><span style="color:#D8DEE9;">encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, Node.js v21.7.1!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¡¨æ˜æ²¡æœ‰æ›´å¤šçš„æ•°æ®è¦å†™å…¥</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª<code>TextEncoderStream</code>å®ä¾‹ï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ªå¯å†™æµæŒ‡å‘æ–‡ä»¶<code>example.txt</code>ã€‚é€šè¿‡<code>pipeline</code>å‡½æ•°ï¼Œæˆ‘ä»¬è¿æ¥äº†è¿™ä¸¤ä¸ªæµï¼šå°†<code>encoder</code>æµä¸­çš„æ•°æ®ï¼ˆè½¬æ¢åçš„äºŒè¿›åˆ¶æ•°æ®ï¼‰ç›´æ¥ä¼ è¾“åˆ°<code>outputStream</code>ä¸­ï¼Œå³å†™å…¥åˆ°æ–‡ä»¶ä¸­ã€‚è¿™æ˜¯ä¸€ç§é«˜æ•ˆå¤„ç†å¤§é‡æ–‡æœ¬æ•°æ®çš„æ–¹å¼ï¼Œå°¤å…¶é€‚åˆéœ€è¦å¤„ç†æˆ–ä¼ è¾“å¤§å‹æ–‡æœ¬çš„åº”ç”¨åœºæ™¯ã€‚</p><h4 id="new-textencoderstream" tabindex="-1"><a class="header-anchor" href="#new-textencoderstream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#new-textencoderstream" target="_blank" rel="noopener noreferrer">new TextEncoderStream()</a></span></a></h4><p>å½“æˆ‘ä»¬è°ˆè®º<code>new TextEncoderStream()</code>è¿™ä¸ªåŠŸèƒ½æ—¶ï¼Œæˆ‘ä»¬å®é™…ä¸Šåœ¨è®¨è®º Node.js é‡Œå…³äºæ–‡æœ¬ç¼–ç è½¬æ¢çš„ä¸€ä¸ªç‰¹å®šå·¥å…·ã€‚è¦ç†è§£è¿™ä¸ªåŠŸèƒ½ï¼Œé¦–å…ˆéœ€è¦æ‡‚å¾—å‡ ä¸ªåŸºç¡€æ¦‚å¿µï¼š</p><ol><li><p><strong>æ–‡æœ¬ç¼–ç </strong>ï¼šç®€å•è¯´ï¼Œå°±æ˜¯æŠŠäººç±»å¯è¯»çš„æ–‡å­—è½¬æ¢æˆè®¡ç®—æœºå¯ä»¥ç†è§£å’Œå­˜å‚¨çš„ä¸€ç³»åˆ—æ•°å­—ç ã€‚æœ€å¸¸è§çš„ä¾‹å­æ˜¯å°†å­—ç¬¦ä¸²è½¬æ¢æˆ UTF-8 ç¼–ç ï¼Œå› ä¸º UTF-8 æ˜¯ç½‘ç»œä¸Šä½¿ç”¨æœ€å¹¿æ³›çš„å­—ç¬¦ç¼–ç ã€‚</p></li><li><p><strong>æµï¼ˆStreamsï¼‰</strong>ï¼šåœ¨ Node.js ä¸­ï¼Œæµæ˜¯ä¸€ç§å¤„ç†æ•°æ®çš„æ–¹å¼ï¼Œå°¤å…¶é€‚ç”¨äºå¤„ç†å¤§é‡æ•°æ®ã€‚æ¯”å¦‚ï¼Œå½“ä½ ä»æ–‡ä»¶è¯»å–æ•°æ®æˆ–è€…å‘æ–‡ä»¶å†™å…¥æ•°æ®æ—¶ï¼Œå¦‚æœä¸€æ¬¡æ€§è¯»å–æˆ–å†™å…¥æ•´ä¸ªæ–‡ä»¶å¯èƒ½ä¼šå¯¼è‡´å†…å­˜ä¸è¶³ï¼Œå½±å“æ€§èƒ½ã€‚ä½¿ç”¨æµï¼Œä½ å¯ä»¥ä¸€å°å—ä¸€å°å—åœ°å¤„ç†æ•°æ®ï¼Œè¿™æ ·å°±ä¸ä¼šå ç”¨å¤ªå¤šå†…å­˜ã€‚</p></li></ol><p>ç°åœ¨ï¼Œ<code>TextEncoderStream</code>æ˜¯ä¸€ç§ç‰¹æ®Šçš„æµï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†æ¥æ”¶åˆ°çš„å­—ç¬¦ä¸²æ•°æ®ï¼ˆæ¯”å¦‚äººç±»å¯ä»¥é˜…è¯»çš„æ–‡æœ¬ï¼‰è½¬æ¢æˆ UTF-8 æ ¼å¼çš„å­—èŠ‚æµã€‚è¿™æ ·åšæœ‰å‡ ä¸ªå¥½å¤„ï¼Œæ¯”å¦‚å¯ä»¥å‡†å¤‡æ•°æ®ä»¥ä¾¿åœ¨ç½‘ç»œä¸Šä¼ è¾“ï¼Œæˆ–è€…ä»¥æ­£ç¡®çš„æ ¼å¼ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</p><h3 id="å®é™…åº”ç”¨ç¤ºä¾‹-3" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ç¤ºä¾‹-3"><span>å®é™…åº”ç”¨ç¤ºä¾‹</span></a></h3><p>è®©æˆ‘ä»¬æ¥çœ‹å‡ ä¸ª<code>TextEncoderStream</code>çš„å®é™…è¿ç”¨åœºæ™¯ï¼š</p><h4 id="ç¤ºä¾‹-1-å‘æ–‡ä»¶å†™å…¥ç¼–ç åçš„æ–‡æœ¬" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-1-å‘æ–‡ä»¶å†™å…¥ç¼–ç åçš„æ–‡æœ¬"><span>ç¤ºä¾‹ 1ï¼šå‘æ–‡ä»¶å†™å…¥ç¼–ç åçš„æ–‡æœ¬</span></a></h4><p>å‡è®¾ä½ æƒ³å°†ä¸€äº›æ–‡æœ¬ä»¥ UTF-8 æ ¼å¼ä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ä½ å¯ä»¥ä½¿ç”¨<code>TextEncoderStream</code>æ¥å®ç°ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> pipeline</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TextEncoderStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">util</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªTextEncoderStreamå®ä¾‹</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> encoder</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextEncoderStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯å†™æµï¼ŒæŒ‡å‘æƒ³è¦å†™å…¥çš„æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> outputFileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">output.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨pipelineè¿æ¥ç¼–ç å™¨å’Œè¾“å‡ºæ–‡ä»¶æµï¼Œè‡ªåŠ¨ç®¡ç†æ•°æ®æµåŠ¨å’Œå…³é—­èµ„æº</span></span>
<span class="line"><span style="color:#88C0D0;">pipeline</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">encoder</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> outputFileStream</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æµå¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æ–‡æœ¬æˆåŠŸç¼–ç å¹¶å†™å…¥æ–‡ä»¶ï¼</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‘ç¼–ç å™¨å†™å…¥å­—ç¬¦ä¸²ï¼Œå®ƒä¼šè¢«è‡ªåŠ¨è½¬æ¢æˆUTF-8ç¼–ç å¹¶ä¼ è¾“åˆ°æ–‡ä»¶</span></span>
<span class="line"><span style="color:#D8DEE9;">encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, world! è¿™æ˜¯ä¸€æ®µæµ‹è¯•æ–‡æœ¬ã€‚</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è¡¨æ˜æˆ‘ä»¬å·²ç»å®Œæˆäº†æ•°æ®å†™å…¥</span></span>
<span class="line"><span style="color:#D8DEE9;">encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç åˆ›å»ºäº†ä¸€ä¸ª<code>TextEncoderStream</code>å®ä¾‹ï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘æ–‡ä»¶<code>output.txt</code>çš„å¯å†™æµã€‚é€šè¿‡<code>pipeline</code>å‡½æ•°å°†ç¼–ç å™¨ä¸æ–‡ä»¶è¾“å‡ºæµè¿æ¥èµ·æ¥ï¼Œä½¿å¾—å†™å…¥ç¼–ç å™¨çš„ä»»ä½•æ–‡æœ¬éƒ½ä¼šè‡ªåŠ¨è¢«è½¬æ¢ä¸º UTF-8 ç¼–ç ï¼Œå¹¶ä¸”å†™å…¥åˆ°<code>output.txt</code>æ–‡ä»¶ä¸­ã€‚</p><h4 id="ç¤ºä¾‹-2-ç½‘ç»œä¼ è¾“ç¼–ç æ–‡æœ¬" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-2-ç½‘ç»œä¼ è¾“ç¼–ç æ–‡æœ¬"><span>ç¤ºä¾‹ 2ï¼šç½‘ç»œä¼ è¾“ç¼–ç æ–‡æœ¬</span></a></h4><p>å½“ä½ åœ¨å¼€å‘ä¸€ä¸ª Web æœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯åº”ç”¨æ—¶ï¼Œä½ å¯èƒ½éœ€è¦å‘é€æ¥æ”¶æ–‡æœ¬æ•°æ®ã€‚ä½¿ç”¨<code>TextEncoderStream</code>å¯ä»¥ä¿è¯ä½ å‘é€çš„æ–‡æœ¬ç¬¦åˆç½‘ç»œä¼ è¾“çš„æ ‡å‡†ç¼–ç ï¼ˆUTF-8ï¼‰ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> http</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">http</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TextEncoderStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">util</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">http</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">createServer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">req</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> res</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">req</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">method</span><span style="color:#81A1C1;"> ===</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">POST</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">      // å‡è®¾POSTè¯·æ±‚ä½“æ˜¯æ–‡æœ¬ï¼Œæˆ‘ä»¬æƒ³è¦ä»¥UTF-8æ ¼å¼å›åº”</span></span>
<span class="line"><span style="color:#81A1C1;">      let</span><span style="color:#D8DEE9;"> encoder</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextEncoderStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">      encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">res</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å°†ç¼–ç å™¨è¾“å‡ºç›´æ¥è¿æ¥åˆ°å“åº”å¯¹è±¡</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">      encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æ¥æ”¶åˆ°POSTè¯·æ±‚ï¼Œè¿™æ˜¯å›åº”æ¶ˆæ¯ã€‚</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">      encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å…³é—­æµ</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      res</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">statusCode</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 405</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">      res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">listen</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">3000</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç å±•ç¤ºäº†å¦‚ä½•åœ¨ HTTP æœåŠ¡å™¨ä¸­ä½¿ç”¨<code>TextEncoderStream</code>ï¼Œç¡®ä¿å‘é€ç»™å®¢æˆ·ç«¯çš„æ–‡æœ¬æ•°æ®æ˜¯ UTF-8 ç¼–ç çš„ã€‚è¿™å¯¹äºæ„å»ºéµå¾ªæœ€ä½³å®è·µçš„ç½‘ç»œåº”ç”¨è‡³å…³é‡è¦ã€‚</p><p>æ€»ä¹‹ï¼Œ<code>TextEncoderStream</code>æ˜¯ Node.js ä¸­å¤„ç†æ–‡æœ¬æ•°æ®è½¬æ¢éå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œç‰¹åˆ«æ˜¯å½“æ¶‰åŠåˆ°ç¼–ç å’Œç½‘ç»œä¼ è¾“æ—¶ã€‚</p><h4 id="textencoderstream-encoding" tabindex="-1"><a class="header-anchor" href="#textencoderstream-encoding"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#textencoderstreamencoding" target="_blank" rel="noopener noreferrer">textEncoderStream.encoding</a></span></a></h4><p>å½“ä½ å¼€å§‹ä½¿ç”¨ Node.js, ç‰¹åˆ«æ˜¯ç‰ˆæœ¬ 21.7.1 æ—¶ï¼Œä½ ä¼šé‡åˆ°è®¸å¤šæœ‰è¶£ä¸”å®ç”¨çš„åŠŸèƒ½ã€‚å…¶ä¸­ä¹‹ä¸€å°±æ˜¯<code>TextEncoderStream.encoding</code>ã€‚è¿™å¯èƒ½å¬èµ·æ¥æœ‰ç‚¹æŠ€æœ¯æ€§ï¼Œä½†åˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬ä¼šç”¨æœ€ç®€å•çš„è¯­è¨€è§£é‡Šå®ƒï¼Œå¹¶é€šè¿‡ä¸€äº›å®é™…çš„ä¾‹å­æ¥å¸®åŠ©ä½ ç†è§£ã€‚</p><p>é¦–å…ˆï¼Œè¦ç†è§£<code>TextEncoderStream.encoding</code>ï¼Œæˆ‘ä»¬éœ€è¦åˆ†è§£å®ƒæ‰€æ¶‰åŠçš„å‡ ä¸ªæ¦‚å¿µï¼š<code>TextEncoderStream</code>å’Œ<code>encoding</code>ã€‚</p><h3 id="textencoderstream-1" tabindex="-1"><a class="header-anchor" href="#textencoderstream-1"><span>TextEncoderStream</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œâ€œæµâ€ï¼ˆStreamï¼‰æ˜¯å¤„ç†æ•°æ®çš„ä¸€ç§æ–¹å¼ï¼Œå°¤å…¶æ˜¯å½“æ•°æ®é‡å¾ˆå¤§æˆ–ä¸è¿ç»­æ—¶ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰ä¸€ä¸ªæ°´æ¡¶è¦è£…æ»¡æ°´ï¼Œä½†ä½ ä¸æ˜¯ä¸€æ¬¡æ€§å°†æ°´å€’è¿›å»ï¼Œè€Œæ˜¯ç”¨ä¸€ä¸ªç»†æ°´ç®¡æ…¢æ…¢åŠ æ°´ã€‚è¿™é‡Œï¼Œâ€œæµâ€å°±ç±»ä¼¼äºé‚£æ¡ç»†æ°´ç®¡ï¼Œå®ƒå…è®¸æ•°æ®åˆ†æ‰¹æ¬¡åœ°ç§»åŠ¨ã€‚</p><p>ç‰¹åˆ«åœ°ï¼Œ<code>TextEncoderStream</code>æ˜¯ç”¨æ¥å¤„ç†æ–‡æœ¬æ•°æ®çš„ã€‚â€œç¼–ç â€ï¼ˆEncodingï¼‰æ˜¯æŒ‡å¦‚ä½•å°†å­—ç¬¦ï¼ˆæ¯”å¦‚å­—æ¯å’Œæ•°å­—ï¼‰è½¬æ¢æˆè®¡ç®—æœºå¯ä»¥ç†è§£çš„æ ¼å¼ã€‚ç®€å•æ¥è¯´ï¼Œ<code>TextEncoderStream</code>å°±æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œèƒ½å¤ŸæŠŠä½ ç»™å®ƒçš„æ–‡æœ¬æ•°æ®ï¼Œè½¬æ¢æˆä¸€ç§ç‰¹å®šæ ¼å¼ï¼Œä»¥ä¾¿è®¡ç®—æœºèƒ½å¤Ÿå­˜å‚¨æˆ–å¤„ç†ã€‚</p><h3 id="encoding" tabindex="-1"><a class="header-anchor" href="#encoding"><span>encoding</span></a></h3><p><code>encoding</code>å±æ€§æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå‘Šè¯‰ä½ æ­£åœ¨ä½¿ç”¨å“ªç§ç‰¹å®šçš„ç¼–ç æ–¹å¼ã€‚å¯¹äº<code>TextEncoderStream</code>æ¥è¯´ï¼Œè¿™ä¸ªå±æ€§æ€»æ˜¯è¿”å›&quot;utf-8&quot;ã€‚UTF-8 æ˜¯ä¸€ç§éå¸¸æ™®éçš„ç¼–ç æ–¹å¼ï¼Œç”¨äºè¡¨ç¤ºå„ç§å­—ç¬¦ï¼Œå‡ ä¹æ”¯æŒå…¨ä¸–ç•Œæ‰€æœ‰çš„è¯­è¨€æ–‡å­—ã€‚</p><h3 id="å®é™…è¿ç”¨ä¾‹å­-20" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-20"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªç½‘ç«™ï¼Œå¹¶å¸Œæœ›ç”¨æˆ·ä¸Šä¼ ä¸€æ®µæ–‡å­—ï¼Œç„¶åä½ éœ€è¦å°†è¿™æ®µæ–‡å­—å‘é€åˆ°æœåŠ¡å™¨ã€‚åœ¨ Node.js ç¯å¢ƒä¸‹ï¼Œä½ å¯èƒ½ä¼šè¿™æ ·åšï¼š</p><ol><li>ç”¨æˆ·è¾“å…¥äº†ä¸€æ®µæ–‡å­—ã€‚</li><li>ä½¿ç”¨<code>TextEncoderStream</code>æ¥å¤„ç†è¿™æ®µæ–‡å­—ï¼Œç¡®ä¿å®ƒä»¥æ­£ç¡®çš„æ ¼å¼ï¼ˆUTF-8ï¼‰å‘é€ã€‚</li><li>å°†è½¬æ¢åçš„æ•°æ®æµå¼ä¼ è¾“åˆ°æœåŠ¡å™¨ã€‚</li></ol><p>ä»£ç ç¤ºä¾‹ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å¼•å…¥web streams API</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TextEncoderStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªTextEncoderStreamå®ä¾‹</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> encoder</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextEncoderStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// æŸ¥çœ‹ç¼–ç æ–¹å¼</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">encoding</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: utf-8</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾è¿™æ˜¯ä»ç”¨æˆ·é‚£è·å–çš„æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> userInput</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Hello, ä¸–ç•Œ!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°†encoderä¸å¯å†™æµè¿æ¥èµ·æ¥ï¼ˆä¾‹å¦‚ï¼Œå‘é€åˆ°æœåŠ¡å™¨çš„æµï¼‰</span></span>
<span class="line"><span style="color:#616E88;">// è¿™é‡Œä»…ä¸ºç¤ºä¾‹ï¼Œæ²¡æœ‰å®é™…è¿æ¥åˆ°æœåŠ¡å™¨çš„ä»£ç </span></span>
<span class="line"><span style="color:#D8DEE9;">userInput</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipeThrough</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">encoder</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ç°åœ¨ï¼ŒuserInputçš„å†…å®¹è¢«è½¬æ¢æˆUTF-8æ ¼å¼ï¼Œå¹¶å‡†å¤‡å¥½æµå¼ä¼ è¾“äº†</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¾‹å­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨<code>TextEncoderStream</code>å°†ç”¨æˆ·çš„è¾“å…¥è½¬æ¢ä¸º UTF-8 æ ¼å¼çš„æ•°æ®ã€‚é€šè¿‡æ£€æŸ¥<code>encoder.encoding</code>ï¼Œä½ å¯ä»¥ç¡®è®¤å½“å‰ä½¿ç”¨çš„ç¼–ç æ˜¯ UTF-8ï¼Œè¿™æ˜¯ä¸€ä¸ªåœ¨ç½‘ç»œä¼ è¾“ä¸­å¹¿æ³›ä½¿ç”¨çš„ç¼–ç æ ‡å‡†ã€‚</p><p>å¸Œæœ›è¿™ä¸ªè§£é‡Šå’Œä¾‹å­èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£<code>TextEncoderStream.encoding</code>åœ¨ Node.jsv21.7.1 ä¸­çš„ä½œç”¨å’Œåº”ç”¨ã€‚</p><h4 id="textencoderstream-readable" tabindex="-1"><a class="header-anchor" href="#textencoderstream-readable"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#textencoderstreamreadable" target="_blank" rel="noopener noreferrer">textEncoderStream.readable</a></span></a></h4><p>äº†è§£<code>textEncoderStream.readable</code>é¦–å…ˆéœ€è¦æ˜ç™½å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼šNode.jsã€TextEncoderStreamã€å’Œ Streamsã€‚</p><h3 id="åŸºæœ¬æ¦‚å¿µ-7" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ¦‚å¿µ-7"><span>åŸºæœ¬æ¦‚å¿µ</span></a></h3><ol><li><p><strong>Node.js</strong>ï¼šä¸€ä¸ªè®© JavaScript å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œçš„å¹³å°ã€‚å®ƒä½¿å¾—å¼€å‘è€…å¯ä»¥ä½¿ç”¨ JavaScript æ¥ç¼–å†™åç«¯ä»£ç ï¼Œä»¥æ­¤æ¥æ„å»ºç½‘ç«™åç«¯æœåŠ¡æˆ–ä¸æ•°æ®åº“äº¤äº‘ã€‚</p></li><li><p><strong>TextEncoderStream</strong>ï¼šè¿™æ˜¯ Web Streams API çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå°†æ¥æ”¶åˆ°çš„å­—ç¬¦ä¸²æ•°æ®è½¬æ¢æˆäºŒè¿›åˆ¶å½¢å¼çš„æ•°æ®æµã€‚ç®€å•æ¥è¯´ï¼Œå½“ä½ æœ‰æ–‡æœ¬æ•°æ®æƒ³è¦ä»¥æµ(stream)çš„æ–¹å¼è¿›è¡Œå¤„ç†æ—¶ï¼ŒTextEncoderStream ä¼šå°†è¿™äº›æ–‡æœ¬æ•°æ®è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ ¼å¼ï¼Œä»è€Œå¯ä»¥è¢«åç»­çš„å¤„ç†æµç¨‹ä»¥æµçš„æ–¹å¼å¤„ç†ã€‚</p></li><li><p><strong>Streams</strong>ï¼šåœ¨è®¡ç®—ä¸­ï¼Œæµæ˜¯ä¸€ç³»åˆ—çš„æ•°æ®å…ƒç´ ï¼Œè¿™äº›æ•°æ®å…ƒç´ å¯ä»¥ä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«å¤„ç†ã€‚åœ¨ Node.js é‡Œï¼Œæµä¸»è¦ç”¨äºå¤„ç†å¦‚æ–‡ä»¶è¯»å–/å†™å…¥ã€ç½‘ç»œé€šä¿¡ç­‰åœºæ™¯ï¼Œå…è®¸æ•°æ®è¢«é€æ­¥å¤„ç†ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p></li></ol><h3 id="textencoderstream-readable-1" tabindex="-1"><a class="header-anchor" href="#textencoderstream-readable-1"><span>TextEncoderStream.readable</span></a></h3><p>åœ¨ Node.js v21.7.1 ä¸­ï¼Œ<code>TextEncoderStream</code>å¯¹è±¡æä¾›ä¸€ä¸ªå±æ€§å«åš<code>.readable</code>ã€‚è¿™ä¸ªå±æ€§æ˜¯ä¸€ä¸ªåªè¯»å±æ€§ï¼Œä»£è¡¨äº†å¯è¯»æµï¼ˆReadable Streamï¼‰çš„ä¸€ç«¯ã€‚</p><p>å½“ä½ åˆ›å»ºä¸€ä¸ª<code>TextEncoderStream</code>å®ä¾‹å¹¶å¼€å§‹å‘å…¶ä¸­è¾“å…¥å­—ç¬¦ä¸²æ•°æ®æ—¶ï¼Œè¿™ä¸ªå®ä¾‹ä¼šå°†è¾“å…¥çš„å­—ç¬¦ä¸²è½¬æ¢ä¸º UTF-8 ç¼–ç çš„äºŒè¿›åˆ¶æ•°æ®ã€‚<code>.readable</code>å±æ€§å°±æ˜¯ç”¨æ¥è·å–è¿™ä¸ªè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç»è¿‡ç¼–ç çš„æ•°æ®æµã€‚</p><h3 id="å®é™…åº”ç”¨ç¤ºä¾‹-4" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ç¤ºä¾‹-4"><span>å®é™…åº”ç”¨ç¤ºä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œè¿™ä¸ªåº”ç”¨éœ€è¦å¤„ç†å¤§é‡çš„æ–‡æœ¬æ•°æ®ï¼Œå¹¶ä¸”éœ€è¦å°†è¿™äº›æ•°æ®å‘é€åˆ°å¦ä¸€ä¸ªæœåŠ¡å™¨ã€‚</p><ol><li><strong>æ—¥å¿—è®°å½•</strong>ï¼šä½ å¯ä»¥ä½¿ç”¨<code>TextEncoderStream</code>æ¥å°†ç”Ÿæˆçš„æ—¥å¿—æ–‡æœ¬è½¬æ¢ä¸ºäºŒè¿›åˆ¶æµï¼Œç„¶åé€šè¿‡ç½‘ç»œé«˜æ•ˆåœ°å‘é€è¿™äº›æ—¥å¿—åˆ°è¿œç¨‹æ—¥å¿—æ”¶é›†æœåŠ¡ã€‚</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TextEncoderStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node:util</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºTextEncoderStreamå®ä¾‹</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> encoder</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextEncoderStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">// è·å–å¯è¯»æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">readable</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">// æ¨¡æ‹Ÿçš„æ—¥å¿—å‘é€å‡½æ•°ï¼Œå®é™…ä¸­å¯èƒ½æ˜¯websocketæˆ–å…¶ä»–åè®®</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#88C0D0;"> sendLog</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">dataStream</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  /* å‘é€æ•°æ® */</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°†å¯è¯»æµè¿æ¥åˆ°å‘é€æ—¥å¿—çš„å‡½æ•°</span></span>
<span class="line"><span style="color:#88C0D0;">sendLog</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">readableStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‘encoderä¸­å†™å…¥å­—ç¬¦ä¸²æ•°æ®ï¼Œå®ƒå°†è‡ªåŠ¨è½¬æ¢å¹¶é€šè¿‡readableStreamå‘é€</span></span>
<span class="line"><span style="color:#D8DEE9;">encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">writable</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">è¿™é‡Œæ˜¯ä¸€æ¡æ—¥å¿—ä¿¡æ¯</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong>æ•°æ®å¤„ç†</strong>ï¼šå¦‚æœä½ çš„åº”ç”¨éœ€è¦å¯¹æ–‡æœ¬è¿›è¡Œé¢„å¤„ç†ï¼Œç„¶åå†å°†å…¶å‘é€å‡ºå»ï¼Œ<code>TextEncoderStream</code>åŒæ ·éå¸¸æœ‰ç”¨ã€‚æ¯”å¦‚ï¼Œé¢„å¤„ç†å¯èƒ½åŒ…æ‹¬å‹ç¼©ã€åŠ å¯†æˆ–æ ¼å¼åŒ–æ–‡æœ¬æ•°æ®ã€‚</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// è¿˜æ˜¯ä½¿ç”¨ä¸Šé¢çš„encoderå®ä¾‹å’ŒreadableStream</span></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾processDataæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºè¿›ä¸€æ­¥å¤„ç†æµä¸­çš„æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#88C0D0;"> processData</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  /* å¤„ç†æ•°æ® */</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å¯¹æµä¸­çš„æ•°æ®è¿›è¡Œå¤„ç†</span></span>
<span class="line"><span style="color:#88C0D0;">processData</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">readableStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å†™å…¥éœ€è¦å¤„ç†çš„æ–‡æœ¬æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9;">encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">writable</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">éœ€è¦å¤„ç†çš„æ–‡æœ¬æ•°æ®</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šç¤ºä¾‹å±•ç¤ºäº†<code>TextEncoderStream.readable</code>å¦‚ä½•åœ¨å®é™…åœºæ™¯ä¸­åº”ç”¨ã€‚é€šè¿‡å°†æ–‡æœ¬æ•°æ®è½¬æ¢ä¸ºæµï¼Œæˆ‘ä»¬å¯ä»¥æ›´çµæ´»ã€é«˜æ•ˆåœ°å¤„ç†å¤§é‡æ•°æ®ï¼Œç‰¹åˆ«æ˜¯åœ¨ç½‘ç»œé€šä¿¡å’Œæ–‡ä»¶æ“ä½œç­‰åœºæ™¯ä¸­ã€‚</p><h4 id="textencoderstream-writable" tabindex="-1"><a class="header-anchor" href="#textencoderstream-writable"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#textencoderstreamwritable" target="_blank" rel="noopener noreferrer">textEncoderStream.writable</a></span></a></h4><p><code>textEncoderStream.writable</code>æ˜¯ Node.jsï¼ˆä» v21.7.1 å¼€å§‹ï¼‰ä¸­ä¸€ä¸ªé‡è¦çš„å±æ€§ï¼Œå±äº<code>TextEncoderStream</code>æ¥å£ã€‚è¦ç†è§£è¿™ä¸ªå±æ€§ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦äº†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š<code>TextEncoderStream</code>ã€Streams API ä»¥åŠç¼–ç ã€‚</p><h3 id="åŸºç¡€æ¦‚å¿µ-10" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ-10"><span>åŸºç¡€æ¦‚å¿µ</span></a></h3><ol><li><p><strong>TextEncoderStream</strong>: è¿™æ˜¯ä¸€ä¸ªç”¨äºå°†å­—ç¬¦ä¸²ï¼ˆæ–‡æœ¬æ•°æ®ï¼‰è½¬æ¢ä¸ºå­—èŠ‚æµï¼ˆUint8Array å½¢å¼ï¼‰çš„æµå¼å¤„ç†å™¨ã€‚å®ƒåŸºäº Streams API å®ç°ï¼Œå…è®¸ä½ ä»¥æµçš„æ–¹å¼å¤„ç†æ–‡æœ¬è½¬æ¢æˆäºŒè¿›åˆ¶æ•°æ®ã€‚</p></li><li><p><strong>Streams API</strong>: æµæ˜¯ä¸€ç§æ•°æ®å¤„ç†æ–¹å¼ï¼Œå…è®¸æ•°æ®åœ¨æ¥æºå’Œç›®æ ‡ä¹‹é—´é€æ­¥ä¼ è¾“ï¼Œå°±åƒæ°´æµä¸€æ ·ã€‚åœ¨ Node.js ä¸­ï¼Œè¿™é€šå¸¸ç”¨äºå¤„ç†æ–‡ä»¶ã€ç½‘ç»œé€šä¿¡ç­‰åœºåˆï¼Œå¯ä»¥æé«˜æ€§èƒ½å’Œæ•ˆç‡ï¼Œå› ä¸ºä½ ä¸éœ€è¦ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½å‡†å¤‡å¥½æ‰å¼€å§‹å¤„ç†ã€‚</p></li><li><p><strong>ç¼–ç ï¼ˆEncodingï¼‰</strong>: åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œç¼–ç æ˜¯å°†äººç±»å¯è¯»çš„æ–‡æœ¬è½¬æ¢æˆæœºå™¨å¯å¤„ç†çš„æ ¼å¼ï¼ˆå¦‚äºŒè¿›åˆ¶æ ¼å¼ï¼‰ã€‚æœ€å¸¸è§çš„ç¼–ç æ–¹å¼æ˜¯ UTF-8ï¼Œå®ƒå¯ä»¥è¡¨ç¤ºä»»ä½•å­—ç¬¦ï¼Œå¹¶ä¸”æ˜¯ç½‘ç»œä¸Šçš„æ ‡å‡†ç¼–ç æ–¹å¼ã€‚</p></li></ol><h3 id="textencoderstream-writable-1" tabindex="-1"><a class="header-anchor" href="#textencoderstream-writable-1"><span>textEncoderStream.writable</span></a></h3><p><code>textEncoderStream.writable</code>å±æ€§æŒ‡çš„æ˜¯ä¸€ä¸ª Writable Streamï¼ˆå¯å†™æµï¼‰ï¼Œå®ƒæ˜¯<code>TextEncoderStream</code>çš„ä¸€éƒ¨åˆ†ã€‚é€šè¿‡è¿™ä¸ªå±æ€§ï¼Œä½ å¯ä»¥å‘æµä¸­å†™å…¥å­—ç¬¦ä¸²ï¼ˆå¦‚ UTF-8 æ–‡æœ¬ï¼‰ï¼Œç„¶å<code>TextEncoderStream</code>ä¼šè‡ªåŠ¨å°†è¿™äº›å­—ç¬¦ä¸²è½¬æ¢æˆäºŒè¿›åˆ¶æ ¼å¼ï¼ˆUint8Arrayï¼‰ï¼Œå¹¶é€šè¿‡æµçš„å½¢å¼è¾“å‡ºã€‚</p><h3 id="å®é™…åº”ç”¨ä¾‹å­-6" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ä¾‹å­-6"><span>å®é™…åº”ç”¨ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ç¨‹åºï¼Œéœ€è¦å°†å¤§é‡æ–‡æœ¬æ•°æ®å‘é€åˆ°ç½‘ç»œä¸Šçš„å¦ä¸€å°æœåŠ¡å™¨ã€‚è¿™é‡Œçš„æŒ‘æˆ˜æ˜¯ï¼Œç½‘ç»œä¼ è¾“æ˜¯åŸºäºäºŒè¿›åˆ¶æ•°æ®çš„ï¼Œè€Œä½ æ‰‹å¤´çš„æ•°æ®æ˜¯æ–‡æœ¬æ ¼å¼ã€‚è¿™æ—¶ï¼Œä½¿ç”¨<code>TextEncoderStream</code>å’Œ<code>textEncoderStream.writable</code>å°±æ˜¾å¾—éå¸¸æœ‰ç”¨ã€‚</p><h4 id="ç¤ºä¾‹ä»£ç -4" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹ä»£ç -4"><span>ç¤ºä¾‹ä»£ç ï¼š</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TextEncoderStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node:stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºTextEncoderStreamå®ä¾‹</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> encoder</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextEncoderStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è·å–writableæµï¼Œç”¨äºå†™å…¥æ–‡æœ¬æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">writable</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªwriterç”¨äºå†™å…¥æ•°æ®åˆ°writableæµä¸­</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> writer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> writableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å†™å…¥æ–‡æœ¬æ•°æ®åˆ°æµä¸­ï¼Œå®ƒä¼šè¢«è‡ªåŠ¨è½¬æ¢æˆäºŒè¿›åˆ¶æ ¼å¼</span></span>
<span class="line"><span style="color:#D8DEE9;">writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, world!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å½“å®Œæˆå†™å…¥æ—¶ï¼Œå…³é—­æµ</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// encoder.readableæ˜¯å¯¹åº”çš„å¯è¯»æµï¼ŒåŒ…å«äº†è½¬æ¢åçš„äºŒè¿›åˆ¶æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9;">encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">readable</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipeTo</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">process</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">stdout</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å°†è½¬æ¢åçš„æ•°æ®è¾“å‡ºåˆ°æ§åˆ¶å°</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª<code>TextEncoderStream</code>å®ä¾‹ï¼Œé€šè¿‡å®ƒçš„<code>writable</code>å±æ€§è·å¾—äº†ä¸€ä¸ªå¯å†™æµï¼Œç„¶åæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª writer æ¥å†™å…¥æ–‡æœ¬æ•°æ®ã€‚å†™å…¥çš„æ–‡æœ¬æ•°æ®ä¼šè‡ªåŠ¨è¢«è½¬æ¢æˆäºŒè¿›åˆ¶æ ¼å¼ï¼Œå¹¶å¯ä»¥é€šè¿‡<code>encoder.readable</code>è¯»å–å¹¶è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ï¼Œæ¯”å¦‚å‘é€åˆ°æœåŠ¡å™¨ã€‚</p><p>æ€»ç»“æ¥è¯´ï¼Œ<code>textEncoderStream.writable</code>æ˜¯ Node.js ä¸­å¤„ç†æ–‡æœ¬æ•°æ®è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ ¼å¼çš„å¼ºå¤§å·¥å…·ï¼Œç‰¹åˆ«é€‚åˆåœ¨éœ€è¦å¤„ç†å¤§é‡æ•°æ®å’Œç½‘ç»œé€šä¿¡çš„åœºæ™¯ä¸­ä½¿ç”¨ã€‚</p><h3 id="class-textdecoderstream" tabindex="-1"><a class="header-anchor" href="#class-textdecoderstream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-textdecoderstream" target="_blank" rel="noopener noreferrer">Class: TextDecoderStream</a></span></a></h3><p>Node.js çš„ <code>TextDecoderStream</code> ç±»æ˜¯ä¸€ä¸ªç”¨äºå°†å­—èŠ‚æµï¼ˆæ¯”å¦‚æ¥è‡ªæ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚ç­‰ï¼‰è½¬æ¢ä¸º UTF-8 æ–‡æœ¬æµçš„å·¥å…·ã€‚è¿™ä¸ªç±»å±äº Node.js ä¸­çš„ Web Streams APIï¼Œç‰¹åˆ«é€‚åˆå¤„ç†å¤§å‹æ–‡æœ¬æ•°æ®æˆ–è€…å®æ—¶æ•°æ®æµï¼Œå› ä¸ºå®ƒèƒ½å¤Ÿä»¥æµçš„å½¢å¼é€æ­¥å¤„ç†æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><h3 id="åŸºç¡€æ¦‚å¿µ-11" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ-11"><span>åŸºç¡€æ¦‚å¿µ</span></a></h3><p>åœ¨æ·±å…¥äº†è§£ <code>TextDecoderStream</code> ä¹‹å‰ï¼Œæœ‰å‡ ä¸ªåŸºç¡€æ¦‚å¿µéœ€è¦æ˜ç¡®ï¼š</p><ol><li><p><strong>æµ (Streams)</strong>ï¼šåœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯ä¸€ç³»åˆ—æ•°æ®å…ƒç´ ï¼Œå¯ä»¥é€ä¸ªåœ°è¢«ç¨‹åºå¤„ç†ã€‚æµå¯ä»¥æ˜¯è¾“å…¥æµï¼ˆæ¯”å¦‚è¯»å–æ–‡ä»¶çš„æ•°æ®ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯è¾“å‡ºæµï¼ˆæ¯”å¦‚å†™æ•°æ®åˆ°æ–‡ä»¶ï¼‰ã€‚</p></li><li><p><strong>å­—èŠ‚ (Bytes)</strong>ï¼šè®¡ç®—æœºä¸­æ•°æ®çš„åŸºæœ¬å•ä½ï¼Œé€šå¸¸ç”¨äºè¡¨ç¤ºæœªç»å¤„ç†çš„æ•°æ®æˆ–äºŒè¿›åˆ¶æ•°æ®ã€‚</p></li><li><p><strong>UTF-8</strong>ï¼šä¸€ç§å¹¿æ³›ä½¿ç”¨çš„å­—ç¬¦ç¼–ç æ ‡å‡†ï¼Œèƒ½å¤Ÿè¡¨ç¤ºä¸–ç•Œä¸Šç»å¤§å¤šæ•°çš„ä¹¦é¢è¯­è¨€ã€‚</p></li></ol><h3 id="textdecoderstream-è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#textdecoderstream-è¯¦è§£"><span>TextDecoderStream è¯¦è§£</span></a></h3><p><code>TextDecoderStream</code> æ˜¯ä¸€ä¸ªå°†å­—èŠ‚æµï¼ˆæ¯”å¦‚äºŒè¿›åˆ¶æ•°æ®ï¼‰è½¬æ¢ä¸º UTF-8 ç¼–ç çš„æ–‡æœ¬æµçš„è½¬æ¢æµï¼ˆTransform Streamï¼‰ã€‚å½“ä½ æœ‰ä¸€äº›åŸå§‹çš„å­—èŠ‚æ•°æ®ï¼ˆå¯èƒ½æ˜¯ä»æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚ç­‰è·å–çš„ï¼‰å¹¶å¸Œæœ›å°†å…¶è§£ç æˆå¯è¯»çš„æ–‡æœ¬æ—¶ï¼Œè¿™ä¸ªç±»å°±éå¸¸æœ‰ç”¨ã€‚</p><h3 id="å®é™…åº”ç”¨ä¸¾ä¾‹" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ä¸¾ä¾‹"><span>å®é™…åº”ç”¨ä¸¾ä¾‹</span></a></h3><h4 id="ä¾‹å­-1-è¯»å–ç½‘ç»œè¯·æ±‚çš„æ•°æ®" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-è¯»å–ç½‘ç»œè¯·æ±‚çš„æ•°æ®"><span>ä¾‹å­ 1ï¼šè¯»å–ç½‘ç»œè¯·æ±‚çš„æ•°æ®</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦ä»æŸä¸ª API è·å–æ•°æ®ï¼Œè¿™äº›æ•°æ®ä»¥å­—èŠ‚æµçš„å½¢å¼å‘é€è¿‡æ¥ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>TextDecoderStream</code> æ¥å¤„ç†è¿™äº›æ•°æ®ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fetch</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node-fetch</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡è®¾ä½¿ç”¨ node-fetch åº“æ¥å‘èµ·ç½‘ç»œè¯·æ±‚</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TextDecoderStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">util</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> fetchAndDecode</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> response</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#88C0D0;"> fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‘èµ·ç½‘ç»œè¯·æ±‚</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> TextDecoderStream</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å°†å“åº”ä½“é€šè¿‡ TextDecoderStream è½¬æ¢</span></span>
<span class="line"><span style="color:#81A1C1;">  let</span><span style="color:#D8DEE9;"> text</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // é€æ­¥è¯»å–è½¬æ¢åçš„æ–‡æœ¬æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">  reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    text</span><span style="color:#81A1C1;"> +=</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">  reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">end</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">text</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å½“å…¨éƒ¨æ•°æ®è¯»å–å®Œæ¯•ï¼Œæ‰“å°ç»“æœ</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨å‡½æ•°</span></span>
<span class="line"><span style="color:#88C0D0;">fetchAndDecode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://example.com/data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¾‹å­-2-å¤„ç†æ–‡ä»¶æ•°æ®" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-å¤„ç†æ–‡ä»¶æ•°æ®"><span>ä¾‹å­ 2ï¼šå¤„ç†æ–‡ä»¶æ•°æ®</span></a></h4><p>å¦‚æœä½ æœ‰ä¸€ä¸ªåŒ…å«äºŒè¿›åˆ¶æˆ–å…¶ä»–ç¼–ç æ ¼å¼æ•°æ®çš„æ–‡ä»¶ï¼Œå¹¶å¸Œæœ›å°†å…¶å†…å®¹è§£ç ä¸º UTF-8 æ ¼å¼çš„æ–‡æœ¬ï¼Œ<code>TextDecoderStream</code> ä¹Ÿå¯ä»¥æ´¾ä¸Šç”¨åœºï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TextDecoderStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">util</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªè¯»å–æµå’Œ TextDecoderStream çš„ç®¡é“</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/your/file</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> TextDecoderStream</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> data</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  data</span><span style="color:#81A1C1;"> +=</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // é€å—æ‹¼æ¥æ–‡æœ¬æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">end</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å¤„ç†å®Œæ¯•ï¼Œè¾“å‡ºç»“æœ</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ€»ç»“-13" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-13"><span>æ€»ç»“</span></a></h3><p><code>TextDecoderStream</code> ç±»åœ¨ Node.js ä¸­æä¾›äº†ä¸€ç§é«˜æ•ˆä¸”çµæ´»çš„æ–¹å¼æ¥å¤„ç†å’Œè½¬æ¢å­—èŠ‚æµä¸º UTF-8 æ–‡æœ¬æµã€‚æ— è®ºæ˜¯å¤„ç†ç½‘ç»œè¯·æ±‚ã€è¯»å–æ–‡ä»¶ï¼Œè¿˜æ˜¯å…¶ä»–éœ€è¦å¤§é‡æ–‡æœ¬æ•°æ®å®æ—¶å¤„ç†çš„åœºæ™¯ï¼Œå®ƒéƒ½èƒ½å¤§æ˜¾èº«æ‰‹ã€‚é€šè¿‡ç¤ºä¾‹çš„æ–¹å¼ï¼Œç›¸ä¿¡ä½ å·²ç»å¯¹å¦‚ä½•ä½¿ç”¨ <code>TextDecoderStream</code> æœ‰äº†åˆæ­¥çš„ç†è§£ã€‚</p><h4 id="new-textdecoderstream-encoding-options" tabindex="-1"><a class="header-anchor" href="#new-textdecoderstream-encoding-options"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#new-textdecoderstreamencoding-options" target="_blank" rel="noopener noreferrer">new TextDecoderStream([encoding[, options]])</a></span></a></h4><p>åœ¨è§£é‡Š <code>TextDecoderStream</code> ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£å‡ ä¸ªåŸºç¡€æ¦‚å¿µï¼š<strong>æ–‡æœ¬ç¼–ç </strong>ã€<strong>Node.js ä¸­çš„æµï¼ˆStreamsï¼‰</strong>ï¼Œä»¥åŠå®ƒä»¬ä¸ºä»€ä¹ˆé‡è¦ã€‚</p><h3 id="åŸºç¡€æ¦‚å¿µ-12" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ-12"><span>åŸºç¡€æ¦‚å¿µ</span></a></h3><ul><li><strong>æ–‡æœ¬ç¼–ç </strong>ï¼šè®¡ç®—æœºå†…éƒ¨ï¼Œæ‰€æœ‰ä¿¡æ¯æœ€ç»ˆéƒ½æ˜¯ä»¥äºŒè¿›åˆ¶å½¢å¼å­˜å‚¨çš„ã€‚å½“æˆ‘ä»¬å¤„ç†æ–‡æœ¬æ—¶ï¼Œè¿™äº›äºŒè¿›åˆ¶åºåˆ—å¿…é¡»ä»¥æŸç§æ–¹å¼è½¬æ¢æˆæˆ‘ä»¬èƒ½è¯†åˆ«çš„å­—ç¬¦ã€‚è¿™ä¸ªè½¬æ¢è§„åˆ™å°±æ˜¯æ–‡æœ¬ç¼–ç ï¼Œä¾‹å¦‚ UTF-8ã€‚</li><li><strong>Node.js ä¸­çš„æµï¼ˆStreamsï¼‰</strong>ï¼šåœ¨ Node.js ä¸­ï¼Œæµæ˜¯æ•°æ®çš„é›†åˆï¼Œå°±åƒæ•°ç»„æˆ–å­—ç¬¦ä¸²ï¼Œä½†å®ƒä»¬ä¸ä¸€å®šè¦ä¸€æ¬¡æ€§å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ã€‚è¿™ä½¿å¾—å¤„ç†å¤§é‡æ•°æ®å˜å¾—æ›´åŠ é«˜æ•ˆï¼Œå› ä¸ºä½ å¯ä»¥é€æ­¥å¤„ç†æ•°æ®ï¼Œè€Œä¸æ˜¯ç­‰å¾…å…¨éƒ¨æ•°æ®åŠ è½½å®Œæ¯•ã€‚</li></ul><h3 id="textdecoderstream-ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#textdecoderstream-ä»‹ç»"><span>TextDecoderStream ä»‹ç»</span></a></h3><p><code>TextDecoderStream</code> æ˜¯ Node.js v21.7.1 ä¸­å¼•å…¥çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒå±äº Web Streams API çš„ä¸€éƒ¨åˆ†ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒæ˜¯ç”¨æ¥å°†æ¥æ”¶åˆ°çš„äºŒè¿›åˆ¶æ•°æ®æµï¼ˆå¦‚ Buffer å¯¹è±¡æˆ– Uint8Arrayï¼‰å¼‚æ­¥è½¬æ¢æˆæ–‡æœ¬æµçš„ä¸€ä¸ªå·¥å…·ã€‚å…¶é‡è¦æ€§åœ¨äºï¼Œå®ƒæä¾›äº†ä¸€ç§å¤„ç†æ¥è‡ªæ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚ç­‰æ¥æºçš„ç¼–ç æ•°æ®çš„é«˜æ•ˆæ–¹å¼ã€‚</p><h4 id="å‚æ•°-6" tabindex="-1"><a class="header-anchor" href="#å‚æ•°-6"><span>å‚æ•°</span></a></h4><ul><li><strong>encoding</strong>ï¼šæŒ‡å®šæ–‡æœ¬ç¼–ç ç±»å‹ï¼Œé»˜è®¤æ˜¯ &quot;utf-8&quot;ï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ç±»å‹å¦‚ &quot;ascii&quot; æˆ– &quot;utf-16&quot; ç­‰ã€‚</li><li><strong>options</strong>ï¼šå¯é€‰å‚æ•°ï¼Œå…è®¸ä½ è®¾å®šä¸€äº›é¢å¤–çš„é…ç½®å¦‚ï¼š <ul><li><strong>fatal</strong>ï¼šå¦‚æœè®¾ç½®ä¸º trueï¼Œåœ¨é‡åˆ°æ— æ•ˆè¾“å…¥æ—¶ä¼šæŠ›å‡ºé”™è¯¯ï¼Œé»˜è®¤ä¸º falseã€‚</li><li><strong>ignoreBOM</strong>ï¼šæ˜¯å¦å¿½ç•¥å­—èŠ‚é¡ºåºæ ‡è®°(Byte Order Mark)ï¼Œé»˜è®¤ä¸º falseã€‚</li></ul></li></ul><h4 id="å®é™…è¿ç”¨ä¾‹å­-21" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-21"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h4><h5 id="ä¾‹å­-1-è¯»å–æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-è¯»å–æ–‡ä»¶"><span>ä¾‹å­ 1ï¼šè¯»å–æ–‡ä»¶</span></a></h5><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå¤§æ–‡æœ¬æ–‡ä»¶ï¼Œæˆ‘ä»¬å¸Œæœ›é€æ­¥åœ°è¯»å–å¹¶è½¬æ¢è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å°†å…¶å…¨éƒ¨è½½å…¥å†…å­˜ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>fs.createReadStream</code> æ¥åˆ›å»ºä¸€ä¸ªè¯»å–æµï¼Œå¹¶é€šè¿‡ <code>TextDecoderStream</code> æ¥é€æ­¥è½¬æ¢å’Œå¤„ç†æ–‡æœ¬ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TextDecoderStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">util</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªä»æ–‡ä»¶è¯»å–çš„æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ª TextDecoderStreamï¼Œç”¨äºå°† Buffer è½¬æ¢ä¸ºæ–‡æœ¬</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> decoderStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextDecoderStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">utf-8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è¿æ¥è¿™ä¸¤ä¸ªæµ</span></span>
<span class="line"><span style="color:#D8DEE9;">readStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">decoderStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// é€æ­¥è¯»å–å¹¶å¤„ç†è½¬æ¢åçš„æ–‡æœ¬æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9;">decoderStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="ä¾‹å­-2-ç½‘ç»œè¯·æ±‚" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-ç½‘ç»œè¯·æ±‚"><span>ä¾‹å­ 2ï¼šç½‘ç»œè¯·æ±‚</span></a></h5><p>è€ƒè™‘å¦ä¸€ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè·å–çš„å“åº”æ˜¯æµå¼çš„ï¼ˆæ¯”å¦‚ä¸‹è½½å¤§æ–‡ä»¶ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>TextDecoderStream</code> åœ¨æ¥æ”¶æ•°æ®æ—¶å®æ—¶å°†å…¶è½¬æ¢ä¸ºæ–‡æœ¬å½¢å¼ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> https</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TextDecoderStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">util</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">https</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">http://example.com/bigfile</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">res</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // å‡è®¾æœåŠ¡å™¨å“åº”æ˜¯äºŒè¿›åˆ¶æ•°æ®æµï¼Œæˆ‘ä»¬æƒ³è¦å°†å…¶è½¬æ¢ä¸ºæ–‡æœ¬</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> decoderStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextDecoderStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">utf-8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">  res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">decoderStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">  decoderStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºè½¬æ¢åçš„æ–‡æœ¬</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡è¿™äº›ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>TextDecoderStream</code> å¦‚ä½•å¸®åŠ©æˆ‘ä»¬åœ¨å¤„ç†å¤§æ•°æ®æµæ—¶ä¿æŒé«˜æ•ˆç‡ï¼ŒåŒæ—¶ç®€åŒ–å¯¹ä¸åŒç¼–ç çš„å¤„ç†ã€‚</p><h4 id="textdecoderstream-encoding" tabindex="-1"><a class="header-anchor" href="#textdecoderstream-encoding"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#textdecoderstreamencoding" target="_blank" rel="noopener noreferrer">textDecoderStream.encoding</a></span></a></h4><p>å¥½çš„ï¼Œæˆ‘ä¼šå°½åŠ›ä»¥é€šä¿—æ˜“æ‡‚çš„æ–¹å¼è§£é‡Šç»™ä½ ã€‚</p><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥ä½¿ç”¨ JavaScript æ¥ç¼–å†™æœåŠ¡å™¨ç«¯çš„ä»£ç ã€‚éšç€ Node.js çš„ä¸æ–­å‘å±•ï¼Œå®ƒå¼•å…¥äº†è®¸å¤šæ–°çš„ API å’ŒåŠŸèƒ½ï¼Œå…¶ä¸­åŒ…æ‹¬å¯¹ Web Streams API çš„æ”¯æŒã€‚<code>TextDecoderStream</code>å°±æ˜¯ Web Streams API ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒç”¨äºå°†æµå¼æ•°æ®ï¼ˆæ¯”å¦‚ä»æ–‡ä»¶è¯»å–æˆ–ç½‘ç»œæ¥æ”¶çš„æ•°æ®ï¼‰è½¬æ¢æˆæ–‡æœ¬ã€‚</p><h3 id="textdecoderstream-encoding-1" tabindex="-1"><a class="header-anchor" href="#textdecoderstream-encoding-1"><span><code>TextDecoderStream.encoding</code></span></a></h3><p><code>TextDecoderStream.encoding</code>å±æ€§å…è®¸ä½ æŸ¥çœ‹<code>TextDecoderStream</code>å¯¹è±¡ä½¿ç”¨å“ªç§å­—ç¬¦ç¼–ç æ¥è§£ç è¾“å…¥çš„æµå¼æ•°æ®ã€‚ç®€å•æ¥è¯´ï¼Œè¿™ä¸ªå±æ€§å‘Šè¯‰ä½ è¯¥<code>TextDecoderStream</code>å®ä¾‹æ˜¯å¦‚ä½•ç†è§£å’Œè½¬æ¢æˆæ–‡æœ¬çš„äºŒè¿›åˆ¶æ•°æ®çš„ã€‚</p><p>åœ¨ç¼–ç¨‹ä¸–ç•Œé‡Œï¼Œæ–‡æœ¬æ•°æ®åœ¨è®¡ç®—æœºå†…éƒ¨æ˜¯ä»¥äºŒè¿›åˆ¶å½¢å¼å­˜å‚¨çš„ã€‚è€Œä¸åŒçš„ç¼–ç æ ‡å‡†è§„å®šäº†å¦‚ä½•å°†è¿™äº›äºŒè¿›åˆ¶æ•°æ®è½¬æ¢æˆæˆ‘ä»¬èƒ½ç†è§£çš„æ–‡å­—ã€‚æœ€å¸¸è§çš„ç¼–ç æ ‡å‡†æœ‰ UTF-8ã€UTF-16 ç­‰ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>TextDecoderStream</code>ä½¿ç”¨çš„æ˜¯ UTF-8 ç¼–ç ï¼Œå› ä¸ºå®ƒæ˜¯ç›®å‰æœ€å¹¿æ³›ä½¿ç”¨çš„ Unicode å­—ç¬¦é›†ç¼–ç ã€‚</p><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-6" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-6"><span>å®é™…è¿ç”¨çš„ä¾‹å­ï¼š</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨åˆ›å»ºä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦ä»äº’è”ç½‘ä¸Šä¸‹è½½ä¸€äº›æ–‡æœ¬æ•°æ®ï¼ˆæ¯”å¦‚ JSON æˆ– HTMLï¼‰ï¼Œä½†è¿™äº›æ•°æ®æ˜¯é€šè¿‡æµçš„å½¢å¼å‘é€çš„ï¼Œå¹¶ä¸”ä½ çŸ¥é“è¿™äº›æ•°æ®æ˜¯ç”¨æŸç§ç‰¹å®šçš„ç¼–ç æ ¼å¼ç¼–å†™çš„ã€‚è¿™æ—¶ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨<code>TextDecoderStream</code>æ¥å¤„ç†è¿™äº›æ•°æ®æµï¼Œå¹¶åˆ©ç”¨<code>encoding</code>å±æ€§ç¡®ä¿ä½ æ­£ç¡®åœ°è§£ç è¿™äº›æ–‡æœ¬ã€‚</p><h4 id="ä¾‹å­-1-åŸºæœ¬ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-åŸºæœ¬ä½¿ç”¨"><span>ä¾‹å­ 1: åŸºæœ¬ä½¿ç”¨</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å¼•å…¥streamæ¨¡å—å’Œutilæ¨¡å—</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> pipeline</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TextDecoderStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">util</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªTextDecoderStreamå®ä¾‹ï¼Œé»˜è®¤ä½¿ç”¨UTF-8ç¼–ç </span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> decoder</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextDecoderStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">decoder</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">encoding</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: &#39;utf-8&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾æœ‰ä¸ªå‡½æ•°fetchDataStream()ç”¨äºè·å–æŸä¸ªæ–‡æœ¬æ•°æ®çš„æµï¼ˆè¿™é‡Œåªæ˜¯ç¤ºæ„ï¼‰</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> dataStream</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> fetchDataStream</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨pipelineæŠŠæ•°æ®æµé€šè¿‡decoderè½¬æ¢ï¼Œç„¶åè¾“å‡ºåˆ°æ§åˆ¶å°</span></span>
<span class="line"><span style="color:#88C0D0;">pipeline</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">dataStream</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> decoder</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> process</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">stdout</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æµå¤„ç†è¿‡ç¨‹ä¸­å‡ºé”™:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æµå¤„ç†å®Œæˆã€‚</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¾‹å­-2-æŒ‡å®šä¸åŒçš„ç¼–ç " tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-æŒ‡å®šä¸åŒçš„ç¼–ç "><span>ä¾‹å­ 2: æŒ‡å®šä¸åŒçš„ç¼–ç </span></a></h4><p>å¦‚æœä½ çŸ¥é“ä½ è¦å¤„ç†çš„æ–‡æœ¬æ•°æ®ä¸æ˜¯ä½¿ç”¨ UTF-8 ç¼–ç çš„ï¼Œæ¯”å¦‚æ˜¯ GBK ç¼–ç çš„ä¸­æ–‡æ–‡æœ¬ï¼Œä½ å¯ä»¥åœ¨åˆ›å»º<code>TextDecoderStream</code>å®ä¾‹æ—¶æŒ‡å®šç¼–ç ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾Node.jsç¯å¢ƒæ”¯æŒGBKç¼–ç ï¼ˆæ³¨æ„ï¼šé»˜è®¤æƒ…å†µä¸‹Node.jså¯èƒ½ä¸æ”¯æŒGBKç¼–ç ï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†æ¼”ç¤ºï¼‰</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> decoderGBK</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextDecoderStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">gbk</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">decoderGBK</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">encoding</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: &#39;gbk&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åŒæ ·çš„ï¼Œä½ ä¼šä½¿ç”¨decoderGBKæ¥å¤„ç†GBKç¼–ç çš„æ•°æ®æµ</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å°ç»“-2" tabindex="-1"><a class="header-anchor" href="#å°ç»“-2"><span>å°ç»“</span></a></h3><p>é€šè¿‡<code>TextDecoderStream</code>å’Œå…¶<code>encoding</code>å±æ€§ï¼ŒNode.js æä¾›äº†ä¸€ç§çµæ´»çš„æ–¹æ³•æ¥å¤„ç†ä¸åŒç¼–ç çš„æ–‡æœ¬æ•°æ®æµã€‚è¿™åœ¨å¤„ç†å„ç§æ¥æºçš„æ•°æ®æµæ—¶éå¸¸æœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨å…¨çƒåŒ–çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°å¤šç§ä¸åŒç¼–ç æ ‡å‡†çš„æ–‡æœ¬æ•°æ®ã€‚</p><h4 id="textdecoderstream-fatal" tabindex="-1"><a class="header-anchor" href="#textdecoderstream-fatal"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#textdecoderstreamfatal" target="_blank" rel="noopener noreferrer">textDecoderStream.fatal</a></span></a></h4><p>å½“æˆ‘ä»¬è°ˆè®º Node.js ä¸­çš„<code>textDecoderStream.fatal</code>å±æ€§æ—¶ï¼Œæˆ‘ä»¬å®é™…ä¸Šåœ¨è®¨è®ºå¤„ç†æ–‡æœ¬æ•°æ®æµæ—¶çš„ä¸€ä¸ªç‰¹å®šè¡Œä¸ºã€‚è¿™ä¸ªæ¦‚å¿µå¯èƒ½å¬èµ·æ¥æœ‰ç‚¹æŠ½è±¡ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä¸€æ­¥æ­¥æ·±å…¥äº†è§£ï¼Œå¹¶ä¸”é€šè¿‡ä¸€äº›ä¾‹å­æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p><p>é¦–å…ˆï¼Œç†è§£<code>TextDecoderStream</code>æ˜¯å¾ˆé‡è¦çš„ã€‚<code>TextDecoderStream</code>æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªå·¥å…·ï¼Œå®ƒç”¨äºå°†å­—èŠ‚æµï¼ˆä¾‹å¦‚ï¼Œä»æ–‡ä»¶è¯»å–çš„äºŒè¿›åˆ¶æ•°æ®ï¼‰è½¬æ¢æˆæ–‡æœ¬ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æŠŠä½ ç”µè„‘é‡Œé¢çœ‹ä¸æ‡‚çš„ä¸€ä¸²ä¸² 0 å’Œ 1 è½¬æ¢æˆå¯ä»¥é˜…è¯»çš„æ–‡å­—ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥åˆ°äº†<code>fatal</code>è¿™ä¸ªå±æ€§ã€‚<code>fatal</code>å±æ€§æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼ˆ<code>true</code>æˆ–<code>false</code>ï¼‰ï¼Œå®ƒå†³å®šäº†å½“é‡åˆ°æ— æ•ˆç¼–ç æ—¶<code>TextDecoderStream</code>åº”è¯¥å¦‚ä½•ååº”ï¼š</p><ul><li>å¦‚æœè®¾ç½®ä¸º<code>true</code>ï¼Œé‚£ä¹ˆä¸€æ—¦é‡åˆ°ä»»ä½•æ— æ³•è§£ç çš„æ•°æ®ï¼Œ<code>TextDecoderStream</code>ä¼šç«‹å³åœæ­¢å¹¶æŠ›å‡ºé”™è¯¯ã€‚</li><li>å¦‚æœè®¾ç½®ä¸º<code>false</code>ï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œé‡åˆ°æ— æ³•è§£ç çš„æ•°æ®æ—¶ï¼Œå®ƒä¼šå°è¯•è·³è¿‡é‚£éƒ¨åˆ†æ•°æ®ï¼Œç»§ç»­è¿›è¡Œï¼Œé€šå¸¸ä¼šæ’å…¥ä¸€ä¸ªæ›¿ä»£å­—ç¬¦ï¼ˆæ¯”å¦‚ ï¿½ï¼‰ï¼Œè¡¨ç¤ºè¿™é‡Œæœ‰ä¸€äº›æ•°æ®æ— æ³•æ­£ç¡®è§£ç ã€‚</li></ul><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-16" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-16"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js ç¨‹åºï¼Œéœ€è¦ä»ç½‘ç»œä¸‹è½½ä¸€äº›æ–‡æœ¬èµ„æºï¼Œä¾‹å¦‚æ—¥å¿—æ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶å¤§å¤šæ•°æ—¶é—´æ˜¯ UTF-8 ç¼–ç çš„ï¼Œä½†å¶å°”ä¹Ÿä¼šåŒ…å«ä¸€äº›é”™è¯¯æˆ–è€…éæ ‡å‡†çš„ç¼–ç å­—ç¬¦ã€‚</p><h4 id="ç¤ºä¾‹-1-å®¹é”™å¤„ç†-fatal-false" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-1-å®¹é”™å¤„ç†-fatal-false"><span>ç¤ºä¾‹ 1ï¼šå®¹é”™å¤„ç†ï¼ˆ<code>fatal: false</code>ï¼‰</span></a></h4><p>å¦‚æœä½ æƒ³ç¡®ä¿å³ä½¿é‡åˆ°ç¼–ç é”™è¯¯ï¼Œç¨‹åºä¹Ÿèƒ½ç»§ç»­è¿è¡Œï¼Œåªæ˜¯ç•™ä¸‹ä¸€äº›å ä½ç¬¦æ¥æŒ‡ç¤ºé—®é¢˜æ‰€åœ¨ï¼Œä½ å¯ä»¥è¿™æ ·åšï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TextDecoderStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node:util</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.log</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> TextDecoderStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">utf-8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span><span style="color:#88C0D0;"> fatal</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> false</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å³ä½¿å­˜åœ¨ç¼–ç é”™è¯¯ï¼Œä¹Ÿèƒ½æ‰“å°æ–‡æœ¬ï¼Œé”™è¯¯éƒ¨åˆ†ä¼šç”¨ï¿½ä»£æ›¿</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç¤ºä¾‹-2-ä¸¥æ ¼æ¨¡å¼-fatal-true" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-2-ä¸¥æ ¼æ¨¡å¼-fatal-true"><span>ç¤ºä¾‹ 2ï¼šä¸¥æ ¼æ¨¡å¼ï¼ˆ<code>fatal: true</code>ï¼‰</span></a></h4><p>å¦‚æœä½ çš„åº”ç”¨å¯¹æ•°æ®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§è¦æ±‚å¾ˆé«˜ï¼Œä½ å¸Œæœ›åœ¨å‘ç°ä»»ä½•ç¼–ç é”™è¯¯æ—¶ç«‹å³åœæ­¢å¤„ç†ï¼Œå¯ä»¥è®¾ç½®<code>fatal</code>ä¸º<code>true</code>ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TextDecoderStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node:util</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">important.log</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> TextDecoderStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">utf-8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span><span style="color:#88C0D0;"> fatal</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> true</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">error</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">é‡åˆ°ç¼–ç é”™è¯¯ï¼Œåœæ­¢å¤„ç†:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœ<code>important.log</code>æ–‡ä»¶ä¸­æœ‰ä»»ä½•æ— æ³•è§£ç çš„å†…å®¹ï¼Œæµä¼šç«‹å³è§¦å‘<code>error</code>äº‹ä»¶ï¼Œä½ å¯ä»¥æ•è·è¿™ä¸ªé”™è¯¯å¹¶ç›¸åº”åœ°å¤„ç†å®ƒï¼ˆæ¯”å¦‚è®°å½•æ—¥å¿—ã€è­¦å‘Šç”¨æˆ·ç­‰ï¼‰ã€‚</p><p>æ€»ç»“èµ·æ¥ï¼Œ<code>textDecoderStream.fatal</code>å±æ€§è®©ä½ æœ‰æ›´å¤šæ§åˆ¶æƒï¼Œå¯ä»¥æ ¹æ®ä½ çš„åº”ç”¨éœ€æ±‚é€‰æ‹©æ›´å®½æ¾æˆ–æ›´ä¸¥æ ¼çš„æ•°æ®å¤„ç†æ–¹å¼ã€‚</p><h4 id="textdecoderstream-ignorebom" tabindex="-1"><a class="header-anchor" href="#textdecoderstream-ignorebom"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#textdecoderstreamignorebom" target="_blank" rel="noopener noreferrer">textDecoderStream.ignoreBOM</a></span></a></h4><p>äº†è§£ <code>textDecoderStream.ignoreBOM</code> å‰ï¼Œæˆ‘ä»¬å…ˆç®€å•ä»‹ç»ä¸€ä¸‹å‡ ä¸ªç›¸å…³çš„æ¦‚å¿µï¼šNode.jsã€TextDecoderStream å’Œ BOMã€‚</p><ol><li><p><strong>Node.js</strong>ï¼šå®ƒæ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œè®© JavaScript å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œï¼Œå¹¿æ³›ç”¨äºåˆ›å»ºå„ç§ç½‘ç»œåº”ç”¨ã€‚</p></li><li><p><strong>TextDecoderStream</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªåœ¨ Node.js ä¸­å¯ç”¨çš„ Web Streams API çš„ä¸€éƒ¨åˆ†ã€‚å®ƒå…è®¸ä½ ä»¥æµçš„å½¢å¼å¼‚æ­¥å¤„ç†æ–‡æœ¬è§£ç ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥è¾¹è¯»å–æ•°æ®è¾¹è§£ç æ–‡æœ¬ï¼Œè€Œä¸éœ€è¦ç­‰åˆ°æ‰€æœ‰æ•°æ®éƒ½æ¥æ”¶å®Œæ¯•ã€‚</p></li><li><p><strong>BOM (Byte Order Mark)</strong>ï¼šæ˜¯æŒ‡å­—èŠ‚é¡ºåºæ ‡è®°ï¼Œå®ƒç”¨äºæ ‡è¯†æ–‡æœ¬æµä½¿ç”¨çš„æ˜¯å“ªç§ Unicode ç¼–ç ï¼ˆå¦‚ UTF-8, UTF-16 ç­‰ï¼‰ã€‚åœ¨ UTF-8 ç¼–ç ä¸­ï¼ŒBOM æ˜¯ä¸€ä¸ªå¯é€‰çš„ç‰¹æ®Šæ ‡è®°ï¼Œå¦‚æœå­˜åœ¨ï¼Œå®ƒæ˜¯ä¸‰ä¸ªå­—èŠ‚ï¼ˆEF BB BFï¼‰ã€‚</p></li></ol><p>ç°åœ¨æ¥èšç„¦äº <code>textDecoderStream.ignoreBOM</code>ï¼š</p><ul><li><p><strong>ä»€ä¹ˆæ˜¯ <code>ignoreBOM</code>ï¼Ÿ</strong></p><p><code>ignoreBOM</code> æ˜¯ <code>TextDecoderStream</code> çš„ä¸€ä¸ªå±æ€§ï¼Œç”¨äºæ§åˆ¶æ˜¯å¦å¿½ç•¥è¾“å…¥æµå¼€å¤´çš„ BOMã€‚å½“è®¾ç½®ä¸º <code>true</code> æ—¶ï¼Œå¦‚æœå­˜åœ¨ BOMï¼Œå®ƒä¼šè¢«è‡ªåŠ¨å¿½ç•¥ï¼Œä¸ä¼šå½±å“åç»­çš„æ–‡æœ¬è§£ç ï¼›å½“è®¾ç½®ä¸º <code>false</code>ï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œå¦‚æœå­˜åœ¨ BOMï¼Œåˆ™åœ¨è§£ç è¿‡ç¨‹ä¸­ä¼šè€ƒè™‘ BOMã€‚</p></li><li><p><strong>å®é™…è¿ç”¨ä¾‹å­</strong></p><p>å‡è®¾ä½ æ­£åœ¨æ„å»ºä¸€ä¸ª Node.js åº”ç”¨ï¼Œè¯¥åº”ç”¨éœ€è¦ä»å¤šä¸ªæ¥æºè¯»å–å’Œåˆå¹¶æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™äº›æ–‡æœ¬æ–‡ä»¶å¯èƒ½æ˜¯ UTF-8 ç¼–ç çš„ï¼Œæœ‰çš„æ–‡ä»¶å¼€å§‹å¯èƒ½åŒ…å« BOMã€‚å¦‚æœç›´æ¥åˆå¹¶è¿™äº›æ–‡ä»¶ï¼ŒåŒ…å« BOM çš„æ–‡ä»¶å¯èƒ½ä¼šå¯¼è‡´æ–‡æœ¬å‡ºç°å¥‡æ€ªçš„å­—ç¬¦ï¼Œå› ä¸º BOM è¢«é”™è¯¯åœ°è§£é‡Šä¸ºäº†æ–‡æœ¬å†…å®¹çš„ä¸€éƒ¨åˆ†ã€‚</p><p>è¿™æ—¶ï¼Œ<code>textDecoderStream.ignoreBOM</code> å°±æ˜¾å¾—éå¸¸æœ‰ç”¨ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TextDecoderStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">util</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªTextDecoderStreamå®ä¾‹ï¼Œè®¾ç½®ignoreBOMä¸ºtrueæ¥å¿½ç•¥BOMã€‚</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> decoderStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextDecoderStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> ignoreBOM</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> true</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾fsStreamæ˜¯ä¸€ä¸ªä»£è¡¨æ–‡ä»¶ç³»ç»Ÿä¸­æŸä¸ªæ–‡ä»¶çš„å¯è¯»æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fsStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/your/file.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ç°åœ¨ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªæ–‡ä»¶æµé€šè¿‡decoderStreamè¿›è¡Œè§£ç ã€‚</span></span>
<span class="line"><span style="color:#616E88;">// å› ä¸ºæˆ‘ä»¬è®¾ç½®äº†ignoreBOMä¸ºtrueï¼Œæ‰€ä»¥å³ä¾¿æ–‡ä»¶å¼€å§‹æœ‰BOMï¼Œå®ƒä¹Ÿä¼šè¢«å¿½ç•¥ã€‚</span></span>
<span class="line"><span style="color:#D8DEE9;">fsStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">decoderStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">process</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">stdout</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡è®¾æˆ‘ä»¬ç›´æ¥å°†è§£ç åçš„æ–‡æœ¬è¾“å‡ºåˆ°æ§åˆ¶å°</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¾‹å­é€šè¿‡<code>TextDecoderStream</code>è¯»å–å¹¶è§£ç ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼ŒåŒæ—¶å¿½ç•¥ä»»ä½• BOMã€‚è¿™å¯¹äºå¤„ç†æ¥æºå¤šæ ·åŒ–çš„æ–‡æœ¬æ•°æ®å°¤ä¸ºé‡è¦ï¼Œç¡®ä¿äº†æ— è®ºæºæ–‡ä»¶æ˜¯å¦åŒ…å« BOMï¼Œæœ€ç»ˆåˆå¹¶æˆ–å¤„ç†åçš„æ–‡æœ¬éƒ½æ˜¯å¹²å‡€ã€ä¸€è‡´çš„ã€‚</p></li></ul><p>é€šè¿‡ä¸Šè¿°ä¾‹å­ï¼Œå¯ä»¥çœ‹å‡º<code>ignoreBOM</code>å±æ€§åœ¨è§£ç æ¶‰åŠå¤šä¸ªä¸åŒæ¥æºçš„æ–‡æœ¬æ—¶çš„å®é™…åº”ç”¨ä»·å€¼ï¼Œå°¤å…¶æ˜¯åœ¨éœ€è¦è‡ªåŠ¨å¤„ç† BOM ä»¥é¿å…è§£ç å‡ºé”™æˆ–å‡ºç°ä¹±ç çš„åœºæ™¯ä¸­ã€‚</p><h4 id="textdecoderstream-readable" tabindex="-1"><a class="header-anchor" href="#textdecoderstream-readable"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#textdecoderstreamreadable" target="_blank" rel="noopener noreferrer">textDecoderStream.readable</a></span></a></h4><p>Node.js æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œå®ƒå…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ç”¨ JavaScript æ¥ç¼–å†™åå°é€»è¾‘ï¼Œå¤„ç†æ•°æ®åº“æ“ä½œï¼Œæ–‡ä»¶ç³»ç»Ÿäº¤äº’ç­‰ä»»åŠ¡ï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨æµè§ˆå™¨ä¸­è¿è¡Œè„šæœ¬æ¥æ§åˆ¶ç½‘é¡µå†…å®¹ã€‚</p><p>åœ¨ Node.js v21.7.1 çš„æ–‡æ¡£ä¸­æåˆ°çš„ <code>textDecoderStream.readable</code> æ˜¯ä¸ Web Streams API ç›¸å…³çš„éƒ¨åˆ†ã€‚Web Streams API æ˜¯ä¸€ç§å¤„ç†æµæ•°æ®çš„æ ‡å‡†æ–¹æ³•ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦ä»¥é«˜æ•ˆã€èŠ‚çœå†…å­˜çš„æ–¹å¼å¤„ç†å¤§é‡æ•°æ®æ—¶éå¸¸æœ‰ç”¨ã€‚æµæ•°æ®æŒ‡çš„æ˜¯æ•°æ®çš„ä¸€ç³»åˆ—ç‰‡æ®µï¼Œè¿™äº›ç‰‡æ®µå¯ä»¥ä¸€æ¬¡ä¸€ä¸ªåœ°å¤„ç†ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ•°æ®é›†åˆã€‚</p><h3 id="è§£é‡Š-textdecoderstream-readable" tabindex="-1"><a class="header-anchor" href="#è§£é‡Š-textdecoderstream-readable"><span>è§£é‡Š <code>textDecoderStream.readable</code></span></a></h3><p><code>TextDecoderStream</code> æ˜¯ä¸€ä¸ªå°†æµå¼è¾“å…¥çš„äºŒè¿›åˆ¶æ•°æ®ï¼ˆå¦‚ Buffer å¯¹è±¡ï¼‰è½¬æ¢ä¸ºæ–‡æœ¬çš„å·¥å…·ã€‚è¿™å¯¹äºè¯»å–å’Œå¤„ç†æ¥è‡ªæ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚æˆ–ä»»ä½•å…¶ä»–æ¥æºçš„äºŒè¿›åˆ¶æ•°æ®éå¸¸æœ‰ç”¨ã€‚å½“ä½ åˆ›å»ºäº†ä¸€ä¸ª <code>TextDecoderStream</code> å®ä¾‹åï¼Œ<code>.readable</code> å±æ€§å°±å¯ä»¥ç”¨æ¥å¼•ç”¨ä¸€ä¸ª<strong>å¯è¯»æµ</strong>ã€‚</p><p>è¿™ä¸ªå¯è¯»æµéµå¾ªäº†æµå¼æ•°æ®å¤„ç†çš„æ¨¡å¼ï¼Œä½¿å¾—æ•°æ®å¯ä»¥è¢«æŒ‰é¡ºåºè¯»å–å’Œæ¶ˆè´¹ã€‚åœ¨ Node.js ç¯å¢ƒä¸­ï¼Œè¿™æ ·çš„è®¾è®¡å…è®¸ä½ é«˜æ•ˆåœ°å¤„ç†å¤§å‹æ–‡ä»¶æˆ–æ•°æ®æµï¼Œå› ä¸ºä½ ä¸éœ€è¦ç­‰å¾…æ‰€æœ‰æ•°æ®éƒ½è¢«è½½å…¥å†…å­˜ä¸­ã€‚</p><h3 id="å®é™…åº”ç”¨ç¤ºä¾‹-5" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ç¤ºä¾‹-5"><span>å®é™…åº”ç”¨ç¤ºä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œè¯¥åº”ç”¨éœ€è¦ä»ç½‘ç»œä¸Šä¸‹è½½å¤§å‹æ–‡æœ¬æ—¥å¿—æ–‡ä»¶ï¼Œå¹¶å¯¹å…¶å†…å®¹è¿›è¡Œåˆ†ææˆ–è½¬æ¢ã€‚ä½¿ç”¨ <code>TextDecoderStream</code> ç»“åˆ <code>.readable</code> å¯ä»¥è®©è¿™ä¸ªè¿‡ç¨‹æ›´åŠ é«˜æ•ˆã€‚</p><h4 id="ç¤ºä¾‹ä»£ç -5" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹ä»£ç -5"><span>ç¤ºä¾‹ä»£ç ï¼š</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TextDecoderStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">util</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> pipeline</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fetch</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node-fetch</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡è®¾æˆ‘ä»¬ä»ç½‘ç»œè·å–æ•°æ®æµ</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> fetchAndProcessText</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> response</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#88C0D0;"> fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span></span>
<span class="line"><span style="color:#ECEFF4;">    .</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> TextDecoderStream</span><span style="color:#D8DEE9FF;">()) </span><span style="color:#616E88;">// å°†äºŒè¿›åˆ¶æ•°æ®æµè½¬æ¢ä¸ºæ–‡æœ¬æ•°æ®æµ</span></span>
<span class="line"><span style="color:#ECEFF4;">    .</span><span style="color:#D8DEE9;">readable</span><span style="color:#616E88;"> // è·å–å¯è¯»æµ</span></span>
<span class="line"><span style="color:#ECEFF4;">    .</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // åˆ›å»ºæµçš„é˜…è¯»å™¨æ¥å¼‚æ­¥è¯»å–æµæ•°æ®</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">break;</span><span style="color:#616E88;"> // å¦‚æœæ²¡æœ‰æ›´å¤šæ•°æ®ï¼Œé€€å‡ºå¾ªç¯</span></span>
<span class="line"><span style="color:#D8DEE9;">    process</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">stdout</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å¤„ç†å¹¶æ‰“å°æ¯ä¸ªæ•°æ®ç‰‡æ®µ</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨ç¤ºä¾‹ï¼š</span></span>
<span class="line"><span style="color:#88C0D0;">fetchAndProcessText</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">http://example.com/large-text-file.log</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¾‹å­é€šè¿‡ç½‘ç»œè¯·æ±‚è·å–ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨ <code>TextDecoderStream</code> å’Œ <code>.readable</code> æ¥é€æ­¥è¯»å–å’Œè¾“å‡ºæ–‡ä»¶å†…å®¹ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå³ä½¿æ–‡ä»¶éå¸¸åºå¤§ï¼Œç¨‹åºä¹Ÿèƒ½å¤Ÿä»¥é«˜æ•ˆä¸”å†…å­˜å‹å¥½çš„æ–¹å¼å¤„ç†å®ƒï¼Œå› ä¸ºå®ƒä¸€æ¬¡åªå¤„ç†æ–‡ä»¶çš„ä¸€å°éƒ¨åˆ†ã€‚</p><h3 id="ç»“è®º-3" tabindex="-1"><a class="header-anchor" href="#ç»“è®º-3"><span>ç»“è®º</span></a></h3><p><code>textDecoderStream.readable</code> åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµå¼æ–‡æœ¬æ•°æ®çš„æœ‰åŠ›å·¥å…·ï¼Œç‰¹åˆ«æ˜¯å½“é¢å¯¹éœ€è¦é«˜æ•ˆç‡å’Œä½å†…å­˜æ¶ˆè€—å¤„ç†å¤§é‡æ•°æ®çš„åœºæ™¯ã€‚é€šè¿‡å°†æ•°æ®æµè½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼å¹¶é€æ­¥è¯»å–ï¼Œå®ƒä¸ºå¼€å‘è€…æä¾›äº†æå¤§çš„çµæ´»æ€§å’Œæ€§èƒ½ä¼˜åŠ¿ã€‚</p><h4 id="textdecoderstream-writable" tabindex="-1"><a class="header-anchor" href="#textdecoderstream-writable"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#textdecoderstreamwritable" target="_blank" rel="noopener noreferrer">textDecoderStream.writable</a></span></a></h4><p>Node.js åœ¨å…¶ç‰ˆæœ¬ 21.7.1 ä¸­æä¾›äº†è®¸å¤šåŠŸèƒ½å’Œç‰¹æ€§ï¼Œå…¶ä¸­ä¸€ä¸ªå°±æ˜¯å¯¹ Web Streams API çš„æ”¯æŒï¼Œç‰¹åˆ«æ˜¯ <code>TextDecoderStream</code>ã€‚è¦ç†è§£ <code>textDecoderStream.writable</code> å±æ€§ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦äº†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼šWeb Streamsã€TextDecoderStreamã€ä»¥åŠ writable å±æ€§ã€‚</p><h3 id="åŸºç¡€æ¦‚å¿µ-13" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ-13"><span>åŸºç¡€æ¦‚å¿µ</span></a></h3><ol><li><p><strong>Web Streams</strong>: è¿™æ˜¯ä¸€å¥—å…è®¸ JavaScript å¤„ç†æµå¼æ•°æ®çš„æ ‡å‡†æ¥å£ã€‚æµå¼æ•°æ®æŒ‡çš„æ˜¯æ•°æ®åˆ†å—ä¼ è¾“ï¼Œæ¯ä¸€å—æ•°æ®å¯ä»¥å•ç‹¬å¤„ç†ï¼Œè€Œä¸éœ€è¦ç­‰åˆ°æ‰€æœ‰æ•°æ®éƒ½å¯ç”¨ã€‚è¿™åœ¨å¤„ç†å¤§é‡æ•°æ®æˆ–è€…å®æ—¶æ•°æ®æ—¶éå¸¸æœ‰ç”¨ã€‚</p></li><li><p><strong>TextDecoderStream</strong>: è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šç±»å‹çš„æµï¼Œå®ƒç”¨äºå°†å­—èŠ‚æµï¼ˆé€šå¸¸æ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼‰é€æ­¥è½¬æ¢ä¸ºæ–‡æœ¬ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒå…è®¸ä½ å°†æ¥æ”¶åˆ°çš„äºŒè¿›åˆ¶æ•°æ®ï¼ˆå¯èƒ½æ¥è‡ªæ–‡ä»¶è¯»å–ã€ç½‘ç»œè¯·æ±‚ç­‰ï¼‰æŒ‰ç…§æŒ‡å®šçš„å­—ç¬¦ç¼–ç ï¼ˆå¦‚ UTF-8ï¼‰è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚</p></li><li><p><strong>writable å±æ€§</strong>: åœ¨ Web Streams è§„èŒƒä¸­ï¼Œå¤§å¤šæ•° stream å¯¹è±¡éƒ½æœ‰ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼šä¸€ä¸ªç”¨äºè¯»å–æ•°æ®çš„ readable æµå’Œä¸€ä¸ªç”¨äºå†™å…¥æ•°æ®çš„ writable æµã€‚<code>writable</code> å±æ€§æ­£æ˜¯æŒ‡å‘åè€…ï¼Œå³å…è®¸ä½ å†™å…¥æ•°æ®çš„é‚£éƒ¨åˆ†æµã€‚</p></li></ol><h3 id="textdecoderstream-writable-1" tabindex="-1"><a class="header-anchor" href="#textdecoderstream-writable-1"><span><code>textDecoderStream.writable</code></span></a></h3><p>åœ¨ <code>TextDecoderStream</code> çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œ<code>writable</code> å±æ€§æä¾›äº†ä¸€ä¸ªæ¥å£ï¼Œå…è®¸ä½ å‘æµä¸­å†™å…¥åŸå§‹äºŒè¿›åˆ¶æ•°æ®ã€‚ä¹‹åï¼Œè¿™äº›æ•°æ®ä¼šè¢«è‡ªåŠ¨è½¬æ¢æˆæ–‡æœ¬ï¼Œå¹¶é€šè¿‡ <code>TextDecoderStream</code> å¯¹è±¡çš„å¦ä¸€ç«¯è¿›è¡Œè¾“å‡ºã€‚</p><h3 id="å®é™…è¿ç”¨ä¾‹å­-22" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-22"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œè¯¥åº”ç”¨éœ€è¦ä»æŸä¸ªæºï¼ˆæ¯”å¦‚è¯´ä¸€ä¸ªæ–‡ä»¶æˆ–ç½‘ç»œè¯·æ±‚ï¼‰è¯»å–äºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶ä¸”ä½ å¸Œæœ›ä»¥æ–‡æœ¬å½¢å¼å¤„ç†è¿™äº›æ•°æ®ã€‚</p><h4 id="ç¤ºä¾‹-1-æ–‡ä»¶å†…å®¹è½¬æ¢" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-1-æ–‡ä»¶å†…å®¹è½¬æ¢"><span>ç¤ºä¾‹ 1: æ–‡ä»¶å†…å®¹è½¬æ¢</span></a></h4><p>ä½ æœ‰ä¸€ä¸ªå­˜å‚¨äº†äºŒè¿›åˆ¶æ•°æ®çš„æ–‡ä»¶ï¼ˆä¾‹å¦‚ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œä½†æ˜¯è¢«é”™è¯¯åœ°å½“ä½œäºŒè¿›åˆ¶æ–‡ä»¶å¤„ç†å¹¶ä¿å­˜ï¼‰ï¼Œä½ æƒ³å°†æ–‡ä»¶å†…å®¹è¯»å–å‡ºæ¥ï¼Œå¹¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> TextDecoderStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ª TextDecoderStream å®ä¾‹ï¼Œå‡è®¾æˆ‘ä»¬çŸ¥é“æ–‡ä»¶æ˜¯ä½¿ç”¨ UTF-8 ç¼–ç çš„</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> decoderStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextDecoderStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">utf-8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå¯è¯»æµæ¥è¯»å–æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.bin</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°†å¯è¯»æµè¿æ¥åˆ° decoderStream çš„ writable ç«¯</span></span>
<span class="line"><span style="color:#D8DEE9;">readableStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">decoderStream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">writable</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä» decoderStream çš„ readable ç«¯è¯»å–å·²è½¬æ¢çš„æ–‡æœ¬</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> text</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">decoderStream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">readable</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  text</span><span style="color:#81A1C1;"> +=</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">decoderStream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">readable</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">end</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Converted text:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> text</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨ <code>TextDecoderStream</code> çš„ <code>writable</code> å±æ€§åˆ›å»ºäº†ä¸€ä¸ªç®¡é“ (<code>pipe</code>)ï¼Œå®ƒæ¥æ”¶æ¥è‡ªæ–‡ä»¶çš„äºŒè¿›åˆ¶æ•°æ®æµï¼Œå°†å…¶è½¬æ¢ä¸ºæ–‡æœ¬ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥å¤„ç†è¿™æ®µæ–‡æœ¬ã€‚</p><h4 id="æ€»ç»“-14" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-14"><span>æ€»ç»“</span></a></h4><p>é€šè¿‡ä»¥ä¸Šç¤ºä¾‹ï¼Œä½ å¯ä»¥çœ‹åˆ° <code>textDecoderStream.writable</code> çš„ä½œç”¨æ˜¯æä¾›ä¸€ä¸ªå…¥å£ç‚¹ï¼Œå…è®¸äºŒè¿›åˆ¶æ•°æ®æµå†™å…¥ï¼Œå¹¶é€šè¿‡ <code>TextDecoderStream</code> å¤„ç†åï¼Œä»¥æ–‡æœ¬å½¢å¼è¾“å‡ºã€‚è¿™æ ·çš„æœºåˆ¶æå¤§åœ°ç®€åŒ–äº†å¤„ç†å’Œè½¬æ¢æµæ•°æ®çš„å¤æ‚åº¦ï¼Œå°¤å…¶æ˜¯åœ¨éœ€è¦å°†äºŒè¿›åˆ¶æ•°æ®è½¬æ¢ä¸ºæ–‡æœ¬è¿›è¡Œå¤„ç†çš„åœºæ™¯ä¸‹ã€‚</p><h3 id="class-compressionstream" tabindex="-1"><a class="header-anchor" href="#class-compressionstream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-compressionstream" target="_blank" rel="noopener noreferrer">Class: CompressionStream</a></span></a></h3><p>Node.js ä¸­çš„ <code>CompressionStream</code> ç±»æ˜¯ä¸€ä¸ªç”¨äºè¡¨ç¤ºå‹ç¼©æµçš„å·¥å…·ï¼Œå®ƒå±äº Web Streams API çš„ä¸€éƒ¨åˆ†ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒå…è®¸ä½ åœ¨ Node.js åº”ç”¨ä¸­å¯¹æ•°æ®è¿›è¡Œå‹ç¼©å¤„ç†ï¼Œè¿™å¯¹äºèŠ‚çœå¸¦å®½ã€æé«˜æ•°æ®ä¼ è¾“æ•ˆç‡ç­‰æ–¹é¢éå¸¸æœ‰å¸®åŠ©ã€‚</p><h3 id="åŸºæœ¬æ¦‚å¿µ-8" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ¦‚å¿µ-8"><span>åŸºæœ¬æ¦‚å¿µ</span></a></h3><p>åœ¨æ·±å…¥äº†è§£ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š</p><ul><li><strong>æµï¼ˆStreamï¼‰</strong>ï¼šåœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯ä¸€ç§å¤„ç†è¯»å†™æ•°æ®çš„æ–¹å¼ï¼Œå¯ä»¥æŠŠå®ƒæƒ³è±¡æˆæ°´æµã€‚æ•°æ®åƒæ°´ä¸€æ ·ä»ä¸€ä¸ªåœ°æ–¹æµåŠ¨åˆ°å¦ä¸€ä¸ªåœ°æ–¹ï¼Œè€Œä¸éœ€è¦ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®ã€‚</li><li><strong>å‹ç¼©ï¼ˆCompressionï¼‰</strong>ï¼šå‹ç¼©æ˜¯æŒ‡é€šè¿‡æŸç§ç®—æ³•å‡å°æ•°æ®çš„ä½“ç§¯ï¼Œä½¿å…¶å ç”¨æ›´å°‘çš„ç©ºé—´æˆ–ä¼ è¾“æ—¶æ¶ˆè€—æ›´å°‘çš„å¸¦å®½ã€‚</li></ul><p><code>CompressionStream</code> æ­£æ˜¯åˆ©ç”¨ä»¥ä¸Šä¸¤ä¸ªæ¦‚å¿µï¼Œå®ƒé€šè¿‡æ¥æ”¶è¾“å…¥æµï¼ˆåŸå§‹æ•°æ®ï¼‰ï¼Œå¹¶åº”ç”¨å‹ç¼©ç®—æ³•ï¼ˆå¦‚ Gzip æˆ– Brotliï¼‰ï¼Œè¾“å‡ºä¸€ä¸ªå‹ç¼©åçš„æµã€‚</p><h3 id="å®é™…è¿ç”¨-2" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨-2"><span>å®é™…è¿ç”¨</span></a></h3><p>ä¸¾å‡ ä¸ªå®é™…è¿ç”¨çš„ä¾‹å­ï¼š</p><h4 id="_1-ç½‘ç»œä¼ è¾“ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_1-ç½‘ç»œä¼ è¾“ä¼˜åŒ–"><span>1. ç½‘ç»œä¼ è¾“ä¼˜åŒ–</span></a></h4><p>å½“æˆ‘ä»¬éœ€è¦é€šè¿‡ç½‘ç»œå‘é€å¤§é‡æ•°æ®æ—¶ï¼ˆæ¯”å¦‚ä¸€ä¸ªå¤§å‹çš„ JSON æ–‡ä»¶æˆ–å›¾åƒï¼‰ï¼Œç›´æ¥å‘é€åŸå§‹æ•°æ®ä¼šå ç”¨å¾ˆå¤šå¸¦å®½ï¼Œå¹¶ä¸”ä¼ è¾“é€Ÿåº¦å¯èƒ½å¾ˆæ…¢ã€‚ä½¿ç”¨ <code>CompressionStream</code> å¯ä»¥å…ˆå°†æ•°æ®å‹ç¼©ï¼Œç„¶åå†å‘é€å‹ç¼©åçš„æ•°æ®ï¼Œè¿™æ ·å¯ä»¥æ˜¾è‘—å‡å°‘ä¼ è¾“æ‰€éœ€æ—¶é—´å’Œå¸¦å®½æ¶ˆè€—ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#ECEFF4;"> {</span><span style="color:#8FBCBB;"> CompressionStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> from</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">node:stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">import</span><span style="color:#8FBCBB;"> fs</span><span style="color:#81A1C1;"> from</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªç”¨äºå‹ç¼©çš„æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> compressionStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> CompressionStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">gzip</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªè¯»å–æ–‡ä»¶çš„æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> inputStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.json</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå†™å…¥å‹ç¼©æ–‡ä»¶çš„æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> outputStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.json.gz</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°†è¾“å…¥æµè¿æ¥åˆ°å‹ç¼©æµï¼Œç„¶åè¿æ¥åˆ°è¾“å‡ºæµ</span></span>
<span class="line"><span style="color:#D8DEE9;">inputStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">compressionStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">outputStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-æ–‡ä»¶å­˜å‚¨ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_2-æ–‡ä»¶å­˜å‚¨ä¼˜åŒ–"><span>2. æ–‡ä»¶å­˜å‚¨ä¼˜åŒ–</span></a></h4><p>å½“æˆ‘ä»¬éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šå­˜å‚¨å¤§é‡æ–‡ä»¶æ—¶ï¼Œç£ç›˜ç©ºé—´å¯èƒ½æˆä¸ºé™åˆ¶å› ç´ ã€‚ä½¿ç”¨ <code>CompressionStream</code> å¯¹è¿™äº›æ–‡ä»¶è¿›è¡Œå‹ç¼©ä¿å­˜ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘æ‰€éœ€çš„å­˜å‚¨ç©ºé—´ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#ECEFF4;"> {</span><span style="color:#8FBCBB;"> CompressionStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> from</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">node:stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">import</span><span style="color:#8FBCBB;"> fs</span><span style="color:#81A1C1;"> from</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾æˆ‘ä»¬è¦å‹ç¼©ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> compressionStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> CompressionStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">gzip</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> inputStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">access.log</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> outputStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">access.log.gz</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è¿›è¡Œå‹ç¼©</span></span>
<span class="line"><span style="color:#D8DEE9;">inputStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">compressionStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">outputStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ€»ç»“-15" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-15"><span>æ€»ç»“</span></a></h3><p><code>CompressionStream</code> æ˜¯ Node.js ä¸­ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬ä¼˜åŒ–æ•°æ®ä¼ è¾“å’Œå­˜å‚¨ã€‚é€šè¿‡å¯¹æ•°æ®è¿›è¡Œå‹ç¼©ï¼Œæˆ‘ä»¬å¯ä»¥èŠ‚çœå¸¦å®½ã€åŠ å¿«ä¼ è¾“é€Ÿåº¦ï¼Œå¹¶å‡å°‘å­˜å‚¨ç©ºé—´çš„éœ€æ±‚ã€‚æ— è®ºæ˜¯åœ¨å¤„ç†ç½‘ç»œé€šä¿¡è¿˜æ˜¯æ–‡ä»¶å­˜å‚¨çš„åœºæ™¯ä¸­ï¼Œäº†è§£å’ŒæŒæ¡å¦‚ä½•ä½¿ç”¨ <code>CompressionStream</code> éƒ½æ˜¯éå¸¸æœ‰ä»·å€¼çš„ã€‚</p><h4 id="new-compressionstream-format" tabindex="-1"><a class="header-anchor" href="#new-compressionstream-format"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#new-compressionstreamformat" target="_blank" rel="noopener noreferrer">new CompressionStream(format)</a></span></a></h4><p>å½“ç„¶ï¼Œè®©æˆ‘æ¥å‘ä½ è§£é‡Š Node.js ä¸­<code>new CompressionStream(format)</code>çš„æ¦‚å¿µï¼Œå¹¶é€šè¿‡ä¸€äº›å®ä¾‹ä½¿ä¹‹æ›´åŠ æ˜“äºç†è§£ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯new-compressionstream-format" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯new-compressionstream-format"><span>ä»€ä¹ˆæ˜¯<code>new CompressionStream(format)</code>?</span></a></h3><p>åœ¨ Node.js v21.7.1 ä¸­å¼•å…¥çš„<code>new CompressionStream(format)</code>æ˜¯ä¸€ä¸ªç”¨äºæ•°æ®å‹ç¼©çš„æ¥å£ã€‚ç®€è€Œè¨€ä¹‹ï¼Œè¿™ä¸ªåŠŸèƒ½å¯ä»¥å¸®åŠ©ä½ å°†æ•°æ®ï¼ˆå¦‚æ–‡ä»¶ã€æ•°æ®æµç­‰ï¼‰è¿›è¡Œå‹ç¼©ï¼Œä»¥ä¾¿äºå­˜å‚¨æˆ–ä¼ è¾“ã€‚å®ƒåŸºäº Web æ ‡å‡†ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†ç½‘ç»œæµå’Œæ–‡ä»¶æ“ä½œæ—¶éå¸¸æœ‰ç”¨ã€‚</p><p>å‚æ•°<code>format</code>ä»£è¡¨å‹ç¼©æ ¼å¼ï¼Œç›®å‰æ”¯æŒçš„æ ¼å¼å¯èƒ½åŒ…æ‹¬<code>&#39;gzip&#39;</code>ã€<code>&#39;deflate&#39;</code>ç­‰ï¼ˆå…·ä½“æ”¯æŒå“ªäº›æ ¼å¼ï¼Œéœ€è¦æŸ¥çœ‹å½“æ—¶çš„ Node.js æ–‡æ¡£ï¼Œå› ä¸ºéšç€ç‰ˆæœ¬æ›´æ–°ï¼Œå¯èƒ½ä¼šå¢åŠ æ–°çš„æ ¼å¼æ”¯æŒï¼‰ã€‚</p><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-17" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-17"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><p>è®©æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªä½¿ç”¨<code>new CompressionStream(format)</code>çš„å®é™…ä¾‹å­ï¼š</p><h4 id="ç¤ºä¾‹-1-å‹ç¼©æ–‡æœ¬æ•°æ®" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-1-å‹ç¼©æ–‡æœ¬æ•°æ®"><span>ç¤ºä¾‹ 1: å‹ç¼©æ–‡æœ¬æ•°æ®</span></a></h4><p>å‡è®¾ä½ æƒ³å°†ä¸€æ®µæ–‡æœ¬æ•°æ®è¿›è¡Œ gzip å‹ç¼©ï¼Œä»¥ä¸‹æ˜¯å¦‚ä½•æ“ä½œçš„æ­¥éª¤ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å¼•å…¥æ‰€éœ€æ¨¡å—</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> CompressionStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> pipeline</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/promises</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºåŸå§‹æ–‡æœ¬æ•°æ®çš„å¯è¯»æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> originalTextStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºå‹ç¼©æµï¼ŒæŒ‡å®šgzipæ ¼å¼</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> compressionStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> CompressionStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">gzip</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºç›®æ ‡æ–‡ä»¶çš„å¯å†™æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> compressedFileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.txt.gz</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨pipelineä¸²è”è¿™äº›æµï¼šä»åŸå§‹æ–‡ä»¶æµ -&gt; å‹ç¼©æµ -&gt; ç›®æ ‡æ–‡ä»¶æµ</span></span>
<span class="line"><span style="color:#81A1C1;">await</span><span style="color:#88C0D0;"> pipeline</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">originalTextStream</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> compressionStream</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> compressedFileStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æ–‡ä»¶å‹ç¼©å®Œæˆ</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘è¦è¢«å‹ç¼©æ–‡ä»¶çš„å¯è¯»æµ<code>originalTextStream</code>ï¼Œç„¶åé€šè¿‡<code>CompressionStream</code>åˆ›å»ºäº†ä¸€ä¸ªå‹ç¼©æµï¼Œæœ€åå°†å‹ç¼©åçš„æ•°æ®å†™å…¥åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚</p><h4 id="ç¤ºä¾‹-2-åŠ¨æ€å†…å®¹å‹ç¼©" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-2-åŠ¨æ€å†…å®¹å‹ç¼©"><span>ç¤ºä¾‹ 2: åŠ¨æ€å†…å®¹å‹ç¼©</span></a></h4><p>å¦‚æœä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Web åº”ç”¨ï¼Œå¹¶ä¸”æƒ³åŠ¨æ€åœ°å‹ç¼©å‘é€ç»™ç”¨æˆ·çš„æ•°æ®ï¼Œå¯ä»¥è¿™æ ·åšï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> http</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">http</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> CompressionStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">http</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">createServer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">async</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">req</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> res</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦æ”¯æŒgzipå‹ç¼©</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> acceptEncoding</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> req</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">headers</span><span style="color:#D8DEE9FF;">[</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">accept-encoding</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">] </span><span style="color:#81A1C1;">||</span><span style="color:#ECEFF4;"> &quot;&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#ECEFF4;">/</span><span style="color:#81A1C1;">\b</span><span style="color:#EBCB8B;">gzip</span><span style="color:#81A1C1;">\b</span><span style="color:#ECEFF4;">/</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">test</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">acceptEncoding</span><span style="color:#D8DEE9FF;">)) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">      res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">writeHead</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">200</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Content-Type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">text/plain</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">      res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello World</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">      return;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // å®¢æˆ·ç«¯æ”¯æŒgzipï¼Œä½¿ç”¨CompressionStreamè¿›è¡Œå‹ç¼©</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> compressionStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> CompressionStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">gzip</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">    res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">writeHead</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">200</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#A3BE8C;">Content-Encoding</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">gzip</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#A3BE8C;">Content-Type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">text/plain</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // å°†å“åº”é€šè¿‡å‹ç¼©æµå‘é€</span></span>
<span class="line"><span style="color:#D8DEE9;">    compressionStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">res</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    compressionStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello World</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">listen</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">8080</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æœåŠ¡å™¨å¯åŠ¨ï¼Œåœ¨8080ç«¯å£ç›‘å¬...</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œå®ƒæ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦æ”¯æŒ gzip å‹ç¼©ã€‚å¦‚æœæ”¯æŒï¼ŒæœåŠ¡å™¨å°±ä½¿ç”¨<code>CompressionStream</code>å¯¹å“åº”æ•°æ®è¿›è¡Œå‹ç¼©ï¼Œç„¶åå‘é€ç»™å®¢æˆ·ç«¯ã€‚</p><h3 id="æ€»ç»“-16" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-16"><span>æ€»ç»“</span></a></h3><p>é€šè¿‡ä¸Šè¿°ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>new CompressionStream(format)</code>åœ¨ Node.js ä¸­çš„å¼ºå¤§ä¹‹å¤„ï¼Œå°¤å…¶æ˜¯åœ¨éœ€è¦ä¼˜åŒ–æ•°æ®å­˜å‚¨å’Œä¼ è¾“æ•ˆç‡çš„åœºæ™¯ä¸‹ã€‚æ— è®ºæ˜¯åœ¨æ–‡ä»¶å¤„ç†è¿˜æ˜¯ Web å¼€å‘ä¸­ï¼Œå®ƒéƒ½èƒ½æä¾›æœ‰æ•ˆçš„æ•°æ®å‹ç¼©è§£å†³æ–¹æ¡ˆã€‚</p><h4 id="compressionstream-readable" tabindex="-1"><a class="header-anchor" href="#compressionstream-readable"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#compressionstreamreadable" target="_blank" rel="noopener noreferrer">compressionStream.readable</a></span></a></h4><p>é¦–å…ˆï¼Œè®©æˆ‘è§£é‡Šä¸€ä¸‹ Node.js ä¸­çš„ <code>CompressionStream</code> æ˜¯ä»€ä¹ˆã€‚åœ¨ Node.jsï¼Œç‰¹åˆ«æ˜¯åœ¨ç‰ˆæœ¬ 21.7.1 åŠä»¥åï¼Œ<code>CompressionStream</code> æ˜¯ç”¨äºå¤„ç†æ•°æ®å‹ç¼©çš„ä¸€ä¸ªå·¥å…·ã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥å‡å°æ•°æ®çš„å¤§å°ï¼Œä½¿å…¶æ›´å®¹æ˜“å’Œå¿«é€Ÿåœ°åœ¨çº¿ä¼ è¾“ã€‚ä¾‹å¦‚ï¼Œå½“æ‚¨æƒ³è¦å°†ä¸€ä¸ªå¤§æ–‡ä»¶å‘é€åˆ°ç½‘ç»œä¸Šçš„å¦ä¸€å°è®¡ç®—æœºæ—¶ï¼Œä½¿ç”¨å‹ç¼©å¯ä»¥èŠ‚çœæ—¶é—´å’Œå¸¦å®½ã€‚</p><h3 id="compressionstream-readable-1" tabindex="-1"><a class="header-anchor" href="#compressionstream-readable-1"><span>CompressionStream.readable</span></a></h3><p>åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œ<code>compressionStream.readable</code> æ˜¯æŒ‡ <code>CompressionStream</code> å¯¹è±¡çš„ä¸€ä¸ªå±æ€§ï¼Œè¿™ä¸ªå±æ€§æä¾›äº†ä¸€ä¸ªå¯è¯»æµã€‚é€šè¿‡è¿™ä¸ªå¯è¯»æµï¼Œä½ å¯ä»¥è¯»å–ç»è¿‡å‹ç¼©çš„æ•°æ®ã€‚</p><p>è¿™æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿç®€å•åœ°è¯´ï¼Œå½“ä½ åˆ›å»ºä¸€ä¸ª <code>CompressionStream</code> å®ä¾‹å¹¶å‘å…¶æä¾›æ•°æ®æ—¶ï¼ˆæ¯”å¦‚ä¸€ä¸ªæ–‡æœ¬å­—ç¬¦ä¸²æˆ–æ–‡ä»¶å†…å®¹ï¼‰ï¼Œè¿™ä¸ªæ•°æ®å°±ä¼šè¢«å‹ç¼©ã€‚ç„¶åï¼Œé€šè¿‡ <code>compressionStream.readable</code> å±æ€§æä¾›çš„å¯è¯»æµï¼Œä½ å¯ä»¥è·å–å¹¶ä½¿ç”¨è¿™äº›å‹ç¼©åçš„æ•°æ®ã€‚</p><h3 id="ä¸¾ä¾‹è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#ä¸¾ä¾‹è¯´æ˜"><span>ä¸¾ä¾‹è¯´æ˜</span></a></h3><p>è€ƒè™‘ä»¥ä¸‹ä¸¤ä¸ªå®é™…åº”ç”¨åœºæ™¯ï¼š</p><h4 id="_1-å‹ç¼©æ–‡æœ¬æ•°æ®å¹¶ä¿å­˜åˆ°æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#_1-å‹ç¼©æ–‡æœ¬æ•°æ®å¹¶ä¿å­˜åˆ°æ–‡ä»¶"><span>1. å‹ç¼©æ–‡æœ¬æ•°æ®å¹¶ä¿å­˜åˆ°æ–‡ä»¶</span></a></h4><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªéå¸¸å¤§çš„æ–‡æœ¬æ—¥å¿—æ–‡ä»¶ï¼Œä½ æƒ³å°†å…¶å‹ç¼©åä¿å­˜ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> CompressionStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node:stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªå‹ç¼©æµï¼Œè¿™é‡Œä»¥gzipæ ¼å¼ä¸ºä¾‹</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> compressionStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> CompressionStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">gzip</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å®šä¹‰è¾“å…¥å’Œè¾“å‡ºæ–‡ä»¶è·¯å¾„</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> inputFile</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">path/to/large/log/file.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> outputFile</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">path/to/compressed/log/file.txt.gz</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæ¨¡å—åˆ›å»ºå¯è¯»å’Œå¯å†™æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> inputStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">inputFile</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> outputStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">outputFile</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°†è¾“å…¥æµè¿æ¥åˆ°å‹ç¼©æµï¼Œå†å°†å…¶è¿æ¥åˆ°è¾“å‡ºæµ</span></span>
<span class="line"><span style="color:#D8DEE9;">inputStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">compressionStream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">writable</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">compressionStream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">readable</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">outputStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-åœ¨çº¿ä¼ è¾“å‹ç¼©æ•°æ®" tabindex="-1"><a class="header-anchor" href="#_2-åœ¨çº¿ä¼ è¾“å‹ç¼©æ•°æ®"><span>2. åœ¨çº¿ä¼ è¾“å‹ç¼©æ•°æ®</span></a></h4><p>å½“ä½ æƒ³é€šè¿‡ç½‘ç»œå‘é€ä¸€äº›æ•°æ®ç»™æŸä¸ªæœåŠ¡æ—¶ï¼Œé¢„å…ˆå‹ç¼©æ•°æ®å¯ä»¥å‡å°‘ä¼ è¾“æ—¶é—´ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> CompressionStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node:stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fetch</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node-fetch</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡è®¾ä½¿ç”¨node-fetchæ¥å‘é€HTTPè¯·æ±‚</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> sendCompressedData</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> compressionStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> CompressionStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">gzip</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> compressionStream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">readable</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // è·å–åŸå§‹æ•°æ®çš„Uint8Arrayï¼Œå¹¶å†™å…¥å‹ç¼©æµ</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> encoder</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> TextEncoder</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> encoded</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">encode</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> writer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> compressionStream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">writable</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">  writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">write</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">encoded</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">  writer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // è¯»å–å‹ç¼©åçš„æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> chunks</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> []</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  let</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  while</span><span style="color:#D8DEE9FF;"> ((</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()) </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#81A1C1;"> !</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">    chunks</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">push</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // åˆå¹¶æ‰€æœ‰chunksæˆä¸€ä¸ªå•ä¸€çš„Uint8Array</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> compressedData</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Uint8Array</span><span style="color:#D8DEE9FF;">(</span></span>
<span class="line"><span style="color:#D8DEE9;">    chunks</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">reduce</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">acc</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> val</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#D8DEE9FF;"> [</span><span style="color:#81A1C1;">...</span><span style="color:#D8DEE9;">acc</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> ...</span><span style="color:#D8DEE9;">val</span><span style="color:#D8DEE9FF;">]</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> [])</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  )</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // ä½¿ç”¨fetchå‘é€å‹ç¼©æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">  await</span><span style="color:#88C0D0;"> fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://example.com/api/data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">    method</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">POST</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#88C0D0;">    headers</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#A3BE8C;">Content-Encoding</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">gzip</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#A3BE8C;">Content-Type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">application/octet-stream</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#88C0D0;">    body</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9;"> compressedData</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è°ƒç”¨å‡½æ•°ï¼Œå‘é€ä¸€äº›è¦è¢«å‹ç¼©çš„æ•°æ®</span></span>
<span class="line"><span style="color:#88C0D0;">sendCompressedData</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">è¿™æ˜¯ä¸€æ®µéœ€è¦è¢«å‹ç¼©å¹¶å‘é€çš„æ–‡æœ¬æ•°æ®ã€‚</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸¤ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬éƒ½åˆ©ç”¨äº† <code>CompressionStream</code> æ¥å‹ç¼©æ•°æ®ï¼Œä½¿å…¶å ç”¨æ›´å°‘çš„å­˜å‚¨ç©ºé—´æˆ–ç½‘ç»œå¸¦å®½ã€‚é€šè¿‡ <code>.readable</code> å±æ€§ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè®¿é—®å‹ç¼©åçš„æ•°æ®ï¼Œå¹¶æ ¹æ®éœ€è¦è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†æˆ–ä¼ è¾“ã€‚</p><h4 id="compressionstream-writable" tabindex="-1"><a class="header-anchor" href="#compressionstream-writable"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#compressionstreamwritable" target="_blank" rel="noopener noreferrer">compressionStream.writable</a></span></a></h4><p>äº†è§£ <code>compressionStream.writable</code>ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç®€å•æ¦‚è¿°ä¸€äº›å…³é”®ç‚¹ï¼Œä»¥ç¡®ä¿ä½ èƒ½å¤Ÿè½»æ¾æŒæ¡è¿™ä¸ªæ¦‚å¿µã€‚</p><h3 id="åŸºç¡€çŸ¥è¯†-2" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€çŸ¥è¯†-2"><span>åŸºç¡€çŸ¥è¯†</span></a></h3><ol><li><strong>Node.js</strong>: æ˜¯ä¸€ä¸ªå…è®¸å¼€å‘è€…ä½¿ç”¨ JavaScript æ¥ç¼–å†™æœåŠ¡å™¨ç«¯ç¨‹åºçš„è¿è¡Œæ—¶ç¯å¢ƒã€‚å®ƒéå¸¸é€‚åˆå¤„ç†é«˜å¹¶å‘ã€I/O å¯†é›†å‹çš„åº”ç”¨ã€‚</li><li><strong>Streamsï¼ˆæµï¼‰</strong>: åœ¨ Node.js ä¸­ï¼Œæµæ˜¯å¤„ç†è¯»å–æˆ–å†™å…¥æ•°æ®çš„æŠ½è±¡æ¥å£ã€‚æƒ³è±¡æˆä¸€ä¸ªæ°´ç®¡ï¼Œæ•°æ®åƒæ°´ä¸€æ ·ä»ä¸€ç«¯æµåˆ°å¦ä¸€ç«¯ã€‚æµå¯ä»¥ä½¿å†…å­˜ä½¿ç”¨æ›´æœ‰æ•ˆï¼Œå› ä¸ºä½ ä¸éœ€è¦ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®ã€‚</li><li><strong>Compressionï¼ˆå‹ç¼©ï¼‰</strong>: æ•°æ®å‹ç¼©æŒ‡çš„æ˜¯å‡å°‘æ•°æ®å¤§å°çš„è¿‡ç¨‹ï¼Œè¿™æ ·å¯ä»¥æå‡æ•°æ®ä¼ è¾“é€Ÿåº¦å¹¶å‡å°‘å­˜å‚¨ç©ºé—´éœ€æ±‚ã€‚</li></ol><h3 id="compressionstream-writable-1" tabindex="-1"><a class="header-anchor" href="#compressionstream-writable-1"><span>CompressionStream.writable</span></a></h3><ul><li>å½“è°ˆåˆ° <code>compressionStream.writable</code>ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯åœ¨è®¨è®º Web Streams API ä¸­çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå®ƒè¢«è®¾è®¡æ¥æ”¯æŒå¤„ç†è¿ç»­æ•°æ®æµï¼Œæ¯”å¦‚æ–‡ä»¶ä¼ è¾“ã€ç½‘ç»œè¯·æ±‚ç­‰ã€‚</li><li><code>CompressionStream</code> æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æµï¼Œç”¨äºå¯¹æ•°æ®è¿›è¡Œå‹ç¼©ã€‚å…¶ <code>.writable</code> å±æ€§å®é™…ä¸Šæ˜¯ä¸€ä¸ª <code>WritableStream</code>ï¼Œä½ å¯ä»¥å°†æ•°æ®å†™å…¥è¿™ä¸ªæµï¼Œç„¶åæ•°æ®å°±ä¼šè¢«è‡ªåŠ¨å‹ç¼©ã€‚</li></ul><h3 id="å®é™…è¿ç”¨ä¾‹å­-23" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-23"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><h4 id="ä½¿ç”¨åœºæ™¯-2" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯-2"><span>ä½¿ç”¨åœºæ™¯</span></a></h4><p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£åœ¨æ„å»ºä¸€ä¸ªç½‘ç«™ï¼Œç”¨æˆ·éœ€è¦ä¸Šä¼ å¾ˆå¤§çš„è§†é¢‘æ–‡ä»¶ã€‚ç›´æ¥ä¸Šä¼ åŸå§‹è§†é¢‘å¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œå°¤å…¶æ˜¯åœ¨ç½‘ç»œæ¡ä»¶ä¸ç†æƒ³çš„æƒ…å†µä¸‹ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>compressionStream.writable</code> æ¥å‹ç¼©è¿™äº›è§†é¢‘æ–‡ä»¶ï¼Œè¿™æ ·å¯ä»¥æ˜¾è‘—åŠ å¿«ä¸Šä¼ é€Ÿåº¦å¹¶å‡å°‘ç½‘ç»œæµé‡ã€‚</p><h4 id="æ­¥éª¤ç¤ºä¾‹-å‡è®¾ä»£ç " tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤ç¤ºä¾‹-å‡è®¾ä»£ç "><span>æ­¥éª¤ç¤ºä¾‹ï¼ˆå‡è®¾ä»£ç ï¼‰</span></a></h4><ol><li><p>é¦–å…ˆï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ª <code>CompressionStream</code> å®ä¾‹ã€‚å‡è®¾æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ gzip å‹ç¼©æ ¼å¼ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> compressionStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> CompressionStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">gzip</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>æ¥ç€ï¼Œä½ è·å– <code>compressionStream.writable</code> æµï¼Œå¹¶å°†æ•°æ®å†™å…¥è¯¥æµä»¥è¿›è¡Œå‹ç¼©ã€‚åŒæ—¶ï¼Œä¹Ÿéœ€è¦è®¾ç½®ä¸€ä¸ªè¯»å–å‹ç¼©æ•°æ®çš„æ–¹å¼ï¼Œé€šå¸¸æ˜¯é€šè¿‡å°† <code>compressionStream.readable</code> æµè¿æ¥åˆ°ç›®æ ‡ä½ç½®ï¼ˆæ¯”å¦‚å¦ä¸€ä¸ªæ–‡ä»¶ã€å†…å­˜ç­‰ï¼‰ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç”¨äºè¯»å–åŸå§‹è§†é¢‘æ–‡ä»¶çš„ReadableStream</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> inputVideoStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> ...;</span><span style="color:#616E88;"> // è·å–åŸå§‹è§†é¢‘æµçš„ä»£ç </span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> outputStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> ...;</span><span style="color:#616E88;"> // è¿™æ˜¯æˆ‘ä»¬æƒ³è¦å°†å‹ç¼©æ•°æ®å†™å…¥çš„ç›®æ ‡æµ</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨pipeThrough()è¿æ¥æµï¼Œä»è€Œå®ç°è¯»å–åŸå§‹æ•°æ®-&gt;å‹ç¼©-&gt;è¾“å‡º</span></span>
<span class="line"><span style="color:#D8DEE9;">inputVideoStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipeThrough</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">compressionStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipeTo</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">outputStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>è¿™ä¸ªä¾‹å­å±•ç¤ºäº†å¦‚ä½•åœ¨ Node.js ä¸­ä½¿ç”¨ <code>compressionStream.writable</code> æ¥å¤„ç†å’Œå‹ç¼©å¤§å‹æ–‡ä»¶ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥æœ‰æ•ˆå‡å°‘æ–‡ä»¶å¤§å°ï¼Œæé«˜æ•°æ®å¤„ç†æ•ˆç‡ã€‚è®°ä½ï¼Œè™½ç„¶è¿™ä¸ª API çš„æ¦‚å¿µèµ·æºäº Web å¹³å°ï¼Œä½† Node.js ä¹Ÿæä¾›äº†ç±»ä¼¼çš„åŠŸèƒ½å’Œæ¥å£ï¼Œä½¿å¾—åœ¨æœåŠ¡ç«¯åº”ç”¨ç¨‹åºä¸­å¤„ç†æµæ•°æ®å˜å¾—æ›´åŠ é«˜æ•ˆå’Œæ–¹ä¾¿ã€‚</p><h3 id="class-decompressionstream" tabindex="-1"><a class="header-anchor" href="#class-decompressionstream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#class-decompressionstream" target="_blank" rel="noopener noreferrer">Class: DecompressionStream</a></span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œ<code>DecompressionStream</code> æ˜¯ä¸€ä¸ªç”¨äºè§£å‹æ•°æ®æµçš„ç±»ã€‚è¿™æ„å‘³ç€å®ƒå¯ä»¥æ¥å—è¢«å‹ç¼©è¿‡çš„æ•°æ®ï¼Œå¹¶å°†å…¶è½¬æ¢å›åŸå§‹å½¢å¼ã€‚åœ¨è°ˆåˆ°ç½‘ç»œä¼ è¾“æˆ–å­˜å‚¨å¤§é‡æ•°æ®æ—¶ï¼Œé€šå¸¸ä¼šé‡åˆ°æ•°æ®å‹ç¼©çš„åœºæ™¯ï¼Œå› ä¸ºå‹ç¼©å¯ä»¥æ˜¾è‘—å‡å°‘æ•°æ®çš„å¤§å°ï¼Œä»è€ŒèŠ‚çœå¸¦å®½å’Œæé«˜åŠ è½½é€Ÿåº¦ã€‚é‚£ä¹ˆï¼Œ<code>DecompressionStream</code>å°±æ˜¯ç”¨æ¥åšåå‘æ“ä½œçš„å·¥å…·â€”â€”å°†æ•°æ®ä»å‹ç¼©æ ¼å¼è¿˜åŸã€‚</p><h3 id="å®é™…åº”ç”¨ä¾‹å­-7" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ä¾‹å­-7"><span>å®é™…åº”ç”¨ä¾‹å­</span></a></h3><p>è®©æˆ‘ä»¬é€šè¿‡ä¸€äº›å…·ä½“çš„ä¾‹å­æ¥äº†è§£<code>DecompressionStream</code>çš„å®é™…åº”ç”¨ã€‚</p><h4 id="ä¾‹å­-1-è§£å‹-web-è¯·æ±‚çš„å“åº”ä½“" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-è§£å‹-web-è¯·æ±‚çš„å“åº”ä½“"><span>ä¾‹å­ 1: è§£å‹ Web è¯·æ±‚çš„å“åº”ä½“</span></a></h4><p>å‡è®¾ä½ åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦è¯·æ±‚ä¸€ä¸ª API è·å–å¤§é‡æ•°æ®ã€‚è¿™ä¸ª API ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œè¿”å›çš„æ•°æ®æ˜¯ç»è¿‡ gzip å‹ç¼©çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>DecompressionStream</code>æ¥è§£å‹è¿™äº›æ•°æ®ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fetch</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node-fetch</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡å®šä½¿ç”¨node-fetchæ¥å‘é€HTTPè¯·æ±‚</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> DecompressionStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‘APIå‘é€è¯·æ±‚</span></span>
<span class="line"><span style="color:#88C0D0;">fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://example.com/data.gz</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">response</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#D8DEE9FF;">) </span><span style="color:#616E88;">// è·å–å“åº”ä½“çš„ReadableStream</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> decompressionStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> DecompressionStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">gzip</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> decompressedStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">decompressionStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // ç°åœ¨decompressedStreamæ˜¯è§£å‹åçš„æ•°æ®æµï¼Œå¯ä»¥è¿›ä¸€æ­¥å¤„ç†è¿™äº›æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¾‹å­-2-è§£å‹æœ¬åœ°çš„å‹ç¼©æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-è§£å‹æœ¬åœ°çš„å‹ç¼©æ–‡ä»¶"><span>ä¾‹å­ 2: è§£å‹æœ¬åœ°çš„å‹ç¼©æ–‡ä»¶</span></a></h4><p>å¦‚æœä½ æœ‰ä¸€ä¸ªæœ¬åœ°çš„ gzip å‹ç¼©æ–‡ä»¶ï¼Œæƒ³è¦åœ¨ Node.js ç¨‹åºä¸­è¯»å–å®ƒçš„å†…å®¹ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨<code>DecompressionStream</code>è¿›è¡Œè§£å‹ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> DecompressionStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºä¸€ä¸ªæŒ‡å‘å‹ç¼©æ–‡ä»¶çš„ReadableStream</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> compressedFileStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/your/file.gz</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»ºDecompressionStreamå®ä¾‹</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> decompressionStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> DecompressionStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">gzip</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°†å‹ç¼©æ–‡ä»¶æµé€šè¿‡DecompressionStreamè§£å‹</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> decompressedStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> compressedFileStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipe</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">decompressionStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å¤„ç†è§£å‹åçš„æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9;">decompressedStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡è®¾è¿™é‡Œæ˜¯æ–‡æœ¬æ•°æ®ï¼Œå°†å…¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ€»ç»“-17" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-17"><span>æ€»ç»“</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œ<code>DecompressionStream</code>ç±»æä¾›äº†ä¸€ç§ç®€ä¾¿çš„æ–¹å¼æ¥å¤„ç†å‹ç¼©æ•°æ®ã€‚æ— è®ºæ˜¯å¤„ç†ç½‘ç»œä¼ è¾“ä¸­çš„å‹ç¼©æ•°æ®ï¼Œè¿˜æ˜¯è§£å‹æœ¬åœ°çš„å‹ç¼©æ–‡ä»¶ï¼Œå®ƒéƒ½èƒ½å¤Ÿæœ‰æ•ˆåœ°å°†æ•°æ®æ¢å¤åˆ°å…¶åŸå§‹çŠ¶æ€ã€‚è¿™åœ¨å¤„ç†å¤§å‹æ•°æ®é›†ã€ä¼˜åŒ–ç½‘ç»œé€šä¿¡ç­‰æ–¹é¢éå¸¸æœ‰ç”¨ã€‚</p><h4 id="new-decompressionstream-format" tabindex="-1"><a class="header-anchor" href="#new-decompressionstream-format"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#new-decompressionstreamformat" target="_blank" rel="noopener noreferrer">new DecompressionStream(format)</a></span></a></h4><p>Node.js v21.7.1 å¼•å…¥çš„<code>new DecompressionStream(format)</code>æ˜¯ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„åŠŸèƒ½ï¼Œå®ƒå±äº Web Streams API çš„ä¸€éƒ¨åˆ†ã€‚è¿™ä¸ª API è®©å¤„ç†æµå¼æ•°æ®å˜å¾—æ›´ç®€å•ã€æ›´ç›´æ¥ã€‚åœ¨äº†è§£<code>new DecompressionStream(format)</code>ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆç®€å•åœ°äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯æµï¼ˆStreamsï¼‰ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯æµ-streams-2" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯æµ-streams-2"><span>ä»€ä¹ˆæ˜¯æµï¼ˆStreamsï¼‰</span></a></h3><p>æµæ˜¯ä¸€ç§å¤„ç†è¯»å–æˆ–å†™å…¥è¿ç»­æ•°æ®çš„æ–¹å¼ï¼Œè€Œä¸å¿…ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚æƒ³è±¡ä¸€ä¸‹ä½ æ­£åœ¨ç”¨æ°´ç®¡çŒæº‰èŠ±å›­â€”â€”æ°´é€šè¿‡æ°´ç®¡æµåŠ¨ï¼Œä»ä¸€ç«¯ç§»åŠ¨åˆ°å¦ä¸€ç«¯ã€‚åœ¨ç¼–ç¨‹ä¸­ï¼ŒæµåŒæ ·å…è®¸æ•°æ®ä»ä¸€ä¸ªç‚¹æµå‘å¦ä¸€ä¸ªç‚¹ï¼Œæ¯”å¦‚ä»æ–‡ä»¶è¯»å–æ•°æ®æˆ–å‘æ–‡ä»¶å†™å…¥æ•°æ®ã€‚</p><h3 id="decompressionstream-ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#decompressionstream-ä»‹ç»"><span>DecompressionStream ä»‹ç»</span></a></h3><p><code>DecompressionStream</code>æ˜¯ç”¨æ¥è§£å‹è¢«å‹ç¼©æ•°æ®çš„æµã€‚å½“ä½ æœ‰ä¸€äº›ä»¥ç‰¹å®šæ ¼å¼å‹ç¼©çš„æ•°æ®ï¼ˆä¾‹å¦‚ gzip æˆ– deflateï¼‰ï¼Œå¹¶ä¸”ä½ æƒ³è¦è§£å‹è¿™äº›æ•°æ®ä»¥ä¾¿è¿›ä¸€æ­¥å¤„ç†æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨<code>DecompressionStream</code>ã€‚</p><p>æ­¤ API æ¥å—ä¸€ä¸ªå‚æ•°<code>format</code>ï¼Œè¯¥å‚æ•°æŒ‡å®šäº†å‹ç¼©æ•°æ®ä½¿ç”¨çš„æ ¼å¼ã€‚å¸¸è§çš„æ ¼å¼æœ‰<code>&#39;gzip&#39;</code>å’Œ<code>&#39;deflate&#39;</code>ã€‚</p><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-7" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-7"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h3><h4 id="è§£å‹ç½‘ç»œå“åº”" tabindex="-1"><a class="header-anchor" href="#è§£å‹ç½‘ç»œå“åº”"><span>è§£å‹ç½‘ç»œå“åº”</span></a></h4><p>å‡è®¾ä½ ä»æŸä¸ª API è·å–äº†å‹ç¼©çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®é‡‡ç”¨ gzip æ ¼å¼è¿›è¡Œäº†å‹ç¼©ã€‚ä½ æƒ³è¦è§£å‹è¿™äº›æ•°æ®ï¼Œä»¥ä¾¿è¿›ä¸€æ­¥å¤„ç†ï¼Œæ¯”å¦‚è§£æ JSONã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> fetchAndDecompress</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // Fetchè¿”å›çš„responseå¯¹è±¡</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> response</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#88C0D0;"> fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // å‡è®¾æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ˜¯gzipå‹ç¼©çš„</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> decompressionStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> DecompressionStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">gzip</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // ä½¿ç”¨DecompressionStreamæ¥è§£å‹æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipeThrough</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">decompressionStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // å°†è§£å‹åçš„æ•°æ®è½¬æ¢ä¸ºæ–‡æœ¬</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> text</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Response</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">text</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // è¿›ä¸€æ­¥å¤„ç†è§£å‹åçš„æ–‡æœ¬ï¼Œæ¯”å¦‚è§£æJSON</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> data</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> JSON</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">parse</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">text</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">fetchAndDecompress</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://example.com/data.gz</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="è§£å‹æœ¬åœ°æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#è§£å‹æœ¬åœ°æ–‡ä»¶"><span>è§£å‹æœ¬åœ°æ–‡ä»¶</span></a></h4><p>å¦‚æœä½ æœ‰ä¸€ä¸ªæœ¬åœ°çš„ã€ä½¿ç”¨ gzip å‹ç¼©çš„æ–‡ä»¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨<code>DecompressionStream</code>æ¥è§£å‹è¿™ä¸ªæ–‡ä»¶ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> pipeline</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/promises</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> decompressFile</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">inputPath</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> outputPath</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // åˆ›å»ºä¸€ä¸ªè¯»å–å‹ç¼©æ–‡ä»¶çš„æµ</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> source</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">inputPath</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // åˆ›å»ºä¸€ä¸ªDecompressionStreamæ¥è§£å‹æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> decompressionStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> DecompressionStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">gzip</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // åˆ›å»ºä¸€ä¸ªå†™å…¥è§£å‹æ•°æ®çš„æµ</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> destination</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createWriteStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">outputPath</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // å°†è¿™äº›æµè¿æ¥èµ·æ¥ï¼Œè‡ªåŠ¨ç®¡ç†æ•°æ®ä¼ è¾“</span></span>
<span class="line"><span style="color:#81A1C1;">  await</span><span style="color:#88C0D0;"> pipeline</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">source</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> decompressionStream</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> destination</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">File decompressed successfully</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">decompressFile</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">input.gz</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">output.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ€»ç»“-18" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-18"><span>æ€»ç»“</span></a></h3><p><code>new DecompressionStream(format)</code>æä¾›äº†ä¸€ç§é«˜æ•ˆçš„æ–¹æ³•æ¥è§£å‹æ•°æ®æµï¼Œæ”¯æŒå¤šç§å‹ç¼©æ ¼å¼ã€‚é€šè¿‡ä½¿ç”¨æ­¤ APIï¼Œä½ å¯ä»¥è½»æ¾åœ°å¤„ç†é€šè¿‡ç½‘ç»œä¼ è¾“æˆ–å­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„å‹ç¼©æ•°æ®ã€‚å®ƒä½¿å¾—æ•°æ®å¤„ç†å˜å¾—æ›´ä¸ºé«˜æ•ˆå’Œçµæ´»ã€‚</p><h4 id="decompressionstream-readable" tabindex="-1"><a class="header-anchor" href="#decompressionstream-readable"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#decompressionstreamreadable" target="_blank" rel="noopener noreferrer">decompressionStream.readable</a></span></a></h4><p>Node.js ä¸­çš„<code>decompressionStream.readable</code>æ˜¯ä¸ Web Streams API ç›¸å…³çš„ç‰¹æ€§ï¼Œå®ƒä¸»è¦ç”¨äºå¤„ç†æ•°æ®è§£å‹ç¼©ã€‚åœ¨äº†è§£<code>decompressionStream.readable</code>ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å¼„æ¸…æ¥šå‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼šæµ(Streams)ã€å‹ç¼©å’Œè§£å‹ç¼©ã€‚</p><h3 id="æµ-streams-2" tabindex="-1"><a class="header-anchor" href="#æµ-streams-2"><span>æµ(Streams)</span></a></h3><p>åœ¨ç¼–ç¨‹ä¸­ï¼Œæµæ˜¯ä¸€ç§æŠ½è±¡çš„æ•°æ®ç»“æ„ï¼Œç”¨äºè¯»å–æˆ–å†™å…¥æ•°æ®åºåˆ—ã€‚æƒ³è±¡ä¸€ä¸‹æ°´æµï¼Œæ•°æ®å°±åƒæ°´æµä¸€æ ·ï¼Œå¯ä»¥ä»ä¸€ä¸ªåœ°æ–¹ï¼ˆæºå¤´ï¼‰æµåŠ¨åˆ°å¦ä¸€ä¸ªåœ°æ–¹ï¼ˆç›®çš„åœ°ï¼‰ã€‚åœ¨ Node.js ä¸­ï¼Œæµè¢«å¹¿æ³›ç”¨äºå¤„ç†å¤§é‡æ•°æ®ï¼Œæ¯”å¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œé€šä¿¡ç­‰ã€‚</p><h3 id="å‹ç¼©ä¸è§£å‹ç¼©" tabindex="-1"><a class="header-anchor" href="#å‹ç¼©ä¸è§£å‹ç¼©"><span>å‹ç¼©ä¸è§£å‹ç¼©</span></a></h3><p>å‹ç¼©æ˜¯æŒ‡å°†æ•°æ®çš„å¤§å°å‡å°‘ï¼Œä»¥ä¾¿äºå­˜å‚¨æˆ–ä¼ è¾“ã€‚ç›¸å¯¹åº”çš„ï¼Œè§£å‹ç¼©åˆ™æ˜¯å°†å‹ç¼©åçš„æ•°æ®æ¢å¤åˆ°åŸå§‹çŠ¶æ€ã€‚åœ¨ç½‘ç»œä¼ è¾“ä¸­ï¼Œæ•°æ®å‹ç¼©å¯ä»¥æ˜¾è‘—å‡å°‘ä¼ è¾“æ‰€éœ€æ—¶é—´ã€‚</p><h3 id="è§£å‹ç¼©æµ-decompressionstream" tabindex="-1"><a class="header-anchor" href="#è§£å‹ç¼©æµ-decompressionstream"><span>è§£å‹ç¼©æµ(<code>DecompressionStream</code>)</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œ<code>DecompressionStream</code>æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºæ•°æ®è§£å‹ç¼©çš„æµã€‚å®ƒå¯ä»¥è¯»å–ç»è¿‡å‹ç¼©çš„æ•°æ®ï¼Œå¹¶å°†å…¶è§£å‹ç¼©ä¸ºåŸå§‹æ•°æ®æ ¼å¼ã€‚</p><h3 id="decompressionstream-readable-1" tabindex="-1"><a class="header-anchor" href="#decompressionstream-readable-1"><span><code>decompressionStream.readable</code></span></a></h3><p>å½“ä½ åˆ›å»ºä¸€ä¸ª<code>DecompressionStream</code>å¯¹è±¡ç”¨äºè§£å‹ç¼©æ—¶ï¼Œ<code>.readable</code>å±æ€§ä¼šæä¾›ä¸€ä¸ªå¯è¯»æµã€‚è¿™ä¸ªå¯è¯»æµåŒ…å«ç€è§£å‹ç¼©åçš„æ•°æ®ã€‚åŸºæœ¬ä¸Šï¼Œä½ å¯ä»¥é€šè¿‡ç›‘å¬è¿™ä¸ªå¯è¯»æµæ¥è·å–è§£å‹ç¼©çš„æ•°æ®ï¼Œå¹¶è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚</p><h4 id="å®é™…è¿ç”¨çš„ä¾‹å­-8" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-8"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦ä»ç½‘ç»œä¸‹è½½ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ï¼ˆä¾‹å¦‚ ZIP æˆ– GZIPï¼‰ï¼Œç„¶åè¯»å–å†…å®¹è¿›è¡Œå¤„ç†ã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨<code>decompressionStream.readable</code>æ¥å¤„ç†è¿™ç§æƒ…å†µçš„æ­¥éª¤ï¼š</p><ol><li><strong>è·å–å‹ç¼©æ–‡ä»¶</strong>ï¼šé¦–å…ˆï¼Œä½ éœ€è¦ä½¿ç”¨æŸç§æ–¹å¼ï¼ˆæ¯”å¦‚ HTTP è¯·æ±‚ï¼‰æ¥è·å–å‹ç¼©æ–‡ä»¶çš„æ•°æ®æµã€‚</li><li><strong>åˆ›å»ºè§£å‹ç¼©æµ</strong>ï¼šæ ¹æ®å‹ç¼©æ–‡ä»¶çš„ç±»å‹ï¼ˆæ¯”å¦‚ GZIPï¼‰ï¼Œä½ åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„<code>DecompressionStream</code>å®ä¾‹ã€‚</li><li><strong>è¯»å–å¹¶å¤„ç†è§£å‹ç¼©æ•°æ®</strong>ï¼šé€šè¿‡<code>decompressionStream.readable</code>è·å–å¯è¯»æµï¼Œç„¶åä½ å¯ä»¥é€å—è¯»å–è§£å‹åçš„æ•°æ®ï¼Œè¿›è¡Œå¿…è¦çš„å¤„ç†ã€‚</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> createReadStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> createGunzip</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">zlib</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> pipeline</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/promises</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> decompressAndProcess</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">file</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> decompressionStream</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> createGunzip</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // åˆ›å»ºGZIPè§£å‹ç¼©æµ</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> source</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">file</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¯»å–å‹ç¼©æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> destination</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> decompressionStream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">readable</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è·å–è§£å‹åçš„æ•°æ®æµ</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    await</span><span style="color:#88C0D0;"> pipeline</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">source</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> decompressionStream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // å¤„ç†destinationï¼ˆå³è§£å‹åçš„æ•°æ®æµï¼‰</span></span>
<span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#81A1C1;"> of</span><span style="color:#D8DEE9;"> destination</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Decompressed chunk:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">      // è¿™é‡Œå¯ä»¥å¯¹è§£å‹ç¼©çš„æ•°æ®å—è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚è§£æJSONï¼Œä¿å­˜åˆ°æ–‡ä»¶ç­‰</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> catch</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">An error occurred:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨å‡½æ•°å¤„ç†æŒ‡å®šçš„å‹ç¼©æ–‡ä»¶</span></span>
<span class="line"><span style="color:#88C0D0;">decompressAndProcess</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/your/compressed/file.gz</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ©ç”¨<code>createReadStream</code>è¯»å–å‹ç¼©æ–‡ä»¶ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª GZIP è§£å‹ç¼©æµã€‚é€šè¿‡<code>pipeline</code>å‡½æ•°ï¼Œæˆ‘ä»¬å°†å‹ç¼©æ•°æ®æµè¿æ¥åˆ°è§£å‹ç¼©æµã€‚æœ€åï¼Œé€šè¿‡éå†<code>decompressionStream.readable</code>è·å–çš„è§£å‹åçš„æ•°æ®æµï¼Œå¯ä»¥è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ã€‚</p><h4 id="decompressionstream-writable" tabindex="-1"><a class="header-anchor" href="#decompressionstream-writable"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#decompressionstreamwritable" target="_blank" rel="noopener noreferrer">decompressionStream.writable</a></span></a></h4><p>åœ¨è§£é‡Š <code>decompressionStream.writable</code> ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ Node.js çš„åŸºæœ¬æ¦‚å¿µå’ŒèƒŒæ™¯ã€‚</p><p>Node.js æ˜¯ä¸€ä¸ªèƒ½å¤Ÿåœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript çš„å¹³å°ã€‚å®ƒä½¿å¾—å¼€å‘è€…å¯ä»¥ä½¿ç”¨ JavaScript æ¥ç¼–å†™æœåŠ¡ç«¯ä»£ç ï¼Œè¿™åœ¨ Node.js å‡ºç°ä¹‹å‰æ˜¯ä¸å¯èƒ½çš„ã€‚Node.js å¼ºå¤§çš„æ€§èƒ½éƒ¨åˆ†æ¥è‡ªäºå…¶éé˜»å¡ IO å’Œäº‹ä»¶é©±åŠ¨æœºåˆ¶ã€‚</p><p>åœ¨ Node.js ä¸­ï¼Œæµï¼ˆStreamsï¼‰æ˜¯å¤„ç†è¯»å†™æ•°æ®çš„ä¸€ç§æ–¹å¼ã€‚æ¯”å¦‚ï¼Œå½“ä½ ä»æ–‡ä»¶è¯»å–æ•°æ®æˆ–å°†æ•°æ®å†™å…¥æ–‡ä»¶æ—¶ï¼Œä½ å¯ä»¥ä¸€å°å—ä¸€å°å—åœ°å¤„ç†è¿™äº›æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å°†æ•´ä¸ªæ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚è¿™ç§æ–¹å¼åœ¨å¤„ç†å¤§é‡æ•°æ®æˆ–ä»ä¸€ä¸ªæ…¢é€Ÿç³»ç»Ÿï¼ˆå¦‚ç½‘ç»œï¼‰è¯»å†™æ—¶éå¸¸æœ‰æ•ˆã€‚</p><h3 id="web-streams-api-2" tabindex="-1"><a class="header-anchor" href="#web-streams-api-2"><span>Web Streams API</span></a></h3><p>Web Streams API æ˜¯ä¸€å¥—æ ‡å‡†çš„æµå¤„ç† APIï¼Œå®ƒæœ€åˆè¢«è®¾è®¡ç”¨äº Web æµè§ˆå™¨ï¼Œä½†åæ¥ä¹Ÿè¢« Node.js æ‰€é‡‡çº³ã€‚è¿™å¥— API åŒ…æ‹¬äº†ç”¨äºè¯»å–æ•°æ® (<code>ReadableStream</code>)ã€å†™å…¥æ•°æ® (<code>WritableStream</code>)ã€ä»¥åŠè½¬æ¢æ•°æ® (<code>TransformStream</code>) ç­‰æ¥å£ã€‚</p><h3 id="decompression-stream" tabindex="-1"><a class="header-anchor" href="#decompression-stream"><span>Decompression Stream</span></a></h3><p>åœ¨ Node.js v21.7.1 ä¸­å¼•å…¥çš„ <code>DecompressionStream</code> æ˜¯ Web Streams API çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºè§£å‹ç¼©æ•°æ®ã€‚ç®€å•æ¥è¯´ï¼Œå¦‚æœä½ æœ‰ä¸€ä»½è¢«å‹ç¼©çš„æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œæ¥è‡ªç½‘ç»œè¯·æ±‚çš„ gzip å‹ç¼©æ•°æ®ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>DecompressionStream</code> æ¥è§£å‹è¿™äº›æ•°æ®ã€‚</p><h3 id="decompressionstream-writable-1" tabindex="-1"><a class="header-anchor" href="#decompressionstream-writable-1"><span>decompressionStream.writable</span></a></h3><p>åœ¨ <code>DecompressionStream</code> å¯¹è±¡ä¸­ï¼Œ<code>.writable</code> å±æ€§æä¾›äº†ä¸€ä¸ª <code>WritableStream</code>ï¼Œä½ å¯ä»¥å‘è¿™ä¸ª <code>WritableStream</code> å†™å…¥å‹ç¼©è¿‡çš„æ•°æ®ã€‚ç„¶åï¼Œ<code>DecompressionStream</code> ä¼šå¤„ç†è¿™äº›æ•°æ®ï¼Œå¹¶é€šè¿‡å®ƒçš„ <code>readable</code> å±æ€§è¾“å‡ºè§£å‹ç¼©åçš„æ•°æ®ã€‚</p><h3 id="å®é™…åº”ç”¨ç¤ºä¾‹-6" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ç¤ºä¾‹-6"><span>å®é™…åº”ç”¨ç¤ºä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦ä»ä¸€ä¸ª API è·å–å‹ç¼©çš„æ•°æ®ï¼ˆå¦‚ gzipï¼‰ï¼Œç„¶åè§£å‹ç¼©è¿™äº›æ•°æ®è¿›è¡Œå¤„ç†ï¼š</p><ol><li><p><strong>è·å–å‹ç¼©æ•°æ®</strong>ï¼šé¦–å…ˆï¼Œä½ ä¼šä½¿ç”¨æŸç§æ–¹æ³•ï¼ˆå¦‚ <code>fetch</code> APIï¼‰ä»ç½‘ç»œä¸Šè·å–åˆ°å‹ç¼©çš„æ•°æ®æµã€‚</p></li><li><p><strong>åˆ›å»º DecompressionStream</strong>ï¼šç„¶åï¼Œä½ åˆ›å»ºä¸€ä¸ª <code>DecompressionStream</code> å®ä¾‹ï¼ŒæŒ‡å®šå‹ç¼©æ ¼å¼ï¼ˆå¦‚ <code>&#39;gzip&#39;</code>ï¼‰ä½œä¸ºå‚æ•°ã€‚</p></li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> decompressionStream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> DecompressionStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">gzip</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="3"><li><strong>å†™å…¥å‹ç¼©æ•°æ®åˆ° DecompressionStream</strong>ï¼šé€šè¿‡ <code>decompressionStream.writable</code> è·å–åˆ°å¯å†™æµï¼Œå¹¶å°†å‹ç¼©æ•°æ®å†™å…¥è¯¥æµã€‚</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> compressedDataStream</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> fetchSomeCompressedData</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡è®¾è¿™ä¸ªå‡½æ•°è·å–å‹ç¼©æ•°æ®æµ</span></span>
<span class="line"><span style="color:#D8DEE9;">compressedDataStream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pipeTo</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">decompressionStream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">writable</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li><strong>è¯»å–è§£å‹ç¼©åçš„æ•°æ®</strong>ï¼šæœ€åï¼Œä» <code>decompressionStream</code> çš„ <code>readable</code> å±æ€§è·å–è§£å‹åçš„æ•°æ®æµï¼Œå¹¶è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> readableStream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> decompressionStream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">readable</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨ readableStream è¿›è¡Œæ•°æ®è¯»å–å’Œå¤„ç†</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œä½ å¯ä»¥è½»æ¾åœ°å¯¹ç½‘ç»œä¸Šè·å–çš„å‹ç¼©æ•°æ®è¿›è¡Œè§£å‹ç¼©å¤„ç†ã€‚</p><p>æ€»ç»“ï¼š<code>decompressionStream.writable</code> æ˜¯ <code>DecompressionStream</code> ä¸­ç”¨äºæ¥æ”¶è¢«å‹ç¼©æ•°æ®çš„å¯å†™æµå±æ€§ã€‚é€šè¿‡å‘æ­¤å¯å†™æµå†™å…¥æ•°æ®ï¼Œç„¶åä»ç›¸åº”çš„å¯è¯»æµä¸­è¯»å–è§£å‹ç¼©åçš„æ•°æ®ï¼Œä½ å¯ä»¥åœ¨ Node.js åº”ç”¨ä¸­æ–¹ä¾¿åœ°å¤„ç†å‹ç¼©æ•°æ®ã€‚</p><h3 id="utility-consumers" tabindex="-1"><a class="header-anchor" href="#utility-consumers"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#utility-consumers" target="_blank" rel="noopener noreferrer">Utility Consumers</a></span></a></h3><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬æ¥æ¢è®¨ Node.js v21.7.1 ä¸­æåˆ°çš„ &quot;Utility Consumers&quot; éƒ¨åˆ†ã€‚åœ¨ Web Streams API ä¸­ï¼Œè¿™éƒ¨åˆ†ä¸»è¦æŒ‡çš„æ˜¯ä¸€äº›å®ç”¨å‡½æ•°ï¼Œå®ƒä»¬å¸®åŠ©ä½ ä»¥ç®€å•çš„æ–¹å¼å¤„ç†æµï¼ˆStreamsï¼‰ã€‚æµæ˜¯ä¸€ç³»åˆ—æ•°æ®çš„é›†åˆï¼Œæ¯”å¦‚æ–‡ä»¶å†…å®¹ã€ç½‘ç»œè¯·æ±‚å“åº”ç­‰ï¼Œå®ƒä»¬ä¸éœ€è¦ä¸€æ¬¡æ€§å®Œå…¨åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><h3 id="utility-consumers-çš„ç§ç±»" tabindex="-1"><a class="header-anchor" href="#utility-consumers-çš„ç§ç±»"><span>Utility Consumers çš„ç§ç±»</span></a></h3><ol><li><p><strong><code>stream/promises</code> æ¨¡å—</strong>: è¿™ä¸ªæ¨¡å—æä¾›äº†åŸºäº Promise çš„å·¥å…·ï¼Œä½¿å¾—ä¸æµç›¸å…³çš„å¼‚æ­¥æ“ä½œå˜å¾—æ›´åŠ å®¹æ˜“ã€‚</p></li><li><p><strong>ç‰¹å®šçš„æ¶ˆè´¹è€…æ–¹æ³•</strong>ï¼Œå¦‚ <code>Response.body</code> çš„ <code>.json()</code>, <code>.text()</code>, å’Œ <code>.blob()</code> æ–¹æ³•ï¼šè¿™äº›æ–¹æ³•é€šå¸¸è¢«ç”¨äºåœ¨ Web å¼€å‘ä¸­å¤„ç† HTTP å“åº”ä½“ã€‚</p></li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡ä¸€äº›å®é™…çš„ä¾‹å­æ¥æ·±å…¥ç†è§£ã€‚</p><h4 id="ä¾‹å­-1-ä½¿ç”¨-stream-promises-è¯»å–æ–‡ä»¶å†…å®¹" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-ä½¿ç”¨-stream-promises-è¯»å–æ–‡ä»¶å†…å®¹"><span>ä¾‹å­ 1: ä½¿ç”¨ <code>stream/promises</code> è¯»å–æ–‡ä»¶å†…å®¹</span></a></h4><p>å½“ä½ æƒ³è¦ä»æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å–ä¸€ä¸ªå¤§æ–‡ä»¶æ—¶ï¼Œç›´æ¥å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜å¯èƒ½ä¼šå¯¼è‡´å†…å­˜é—®é¢˜ï¼Œå°¤å…¶æ˜¯å½“æ–‡ä»¶éå¸¸å¤§çš„æ—¶å€™ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>stream/promises</code> æ¥è¯»å–æ–‡ä»¶å†…å®¹ï¼Œè¿™æ ·å¯ä»¥è¾¹è¯»è¾¹å¤„ç†ï¼Œé¿å…å†…å­˜æº¢å‡ºçš„é£é™©ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> pipeline</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/promises</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> readFileContents</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">path</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> source</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">path</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">  source</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">chunk</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">New data chunk:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> chunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  await</span><span style="color:#88C0D0;"> pipeline</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">source</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> process</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">stdout</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">readFileContents</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./example.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªè¯»å–æµ (<code>createReadStream</code>) æ¥é€æ­¥è¯»å–æ–‡ä»¶ã€‚ç„¶åé€šè¿‡ <code>pipeline</code> å‡½æ•°å°†è¿™ä¸ªæµè¿æ¥åˆ° <code>process.stdout</code>ï¼ˆæ ‡å‡†è¾“å‡ºï¼‰ï¼Œè¿™æ ·æ–‡ä»¶çš„æ¯ä¸ªéƒ¨åˆ†éƒ½ä¼šè¢«æ‰“å°å‡ºæ¥ï¼Œè€Œä¸éœ€è¦ä¸€æ¬¡æ€§å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ã€‚</p><h4 id="ä¾‹å­-2-å¤„ç†ç½‘ç»œè¯·æ±‚çš„å“åº”ä½“" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-å¤„ç†ç½‘ç»œè¯·æ±‚çš„å“åº”ä½“"><span>ä¾‹å­ 2: å¤„ç†ç½‘ç»œè¯·æ±‚çš„å“åº”ä½“</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨ä½¿ç”¨ Fetch API (æˆ–ç±»ä¼¼çš„åº“) å‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œå¹¶ä¸”æƒ³è¦å¤„ç†è¿”å›çš„ JSON æ•°æ®ã€‚ä½ é€šå¸¸éœ€è¦å°†å“åº”ä½“è½¬æ¢æˆ JSON æ ¼å¼ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#88C0D0;">fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://api.example.com/data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">response</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">json</span><span style="color:#D8DEE9FF;">())</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å¤„ç†æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#D8DEE9;"> console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Fetch error:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>.json()</code> æ–¹æ³•å°±æ˜¯ä¸€ä¸ª &quot;Utility Consumer&quot;ï¼Œå®ƒè‡ªåŠ¨å¤„ç†æµï¼Œå°†å…¶è½¬æ¢ä¸º JSON å¯¹è±¡ï¼Œä½¿ä½ èƒ½å¤Ÿè½»æ¾åœ°å¤„ç†æ•°æ®ï¼Œè€Œä¸å¿…æ‹…å¿ƒåº•å±‚çš„æµæ“ä½œã€‚</p><h3 id="æ€»ç»“-19" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-19"><span>æ€»ç»“</span></a></h3><p>&quot;Utility Consumers&quot; åœ¨ Node.js ä¸­æ˜¯æŒ‡é‚£äº›å¸®åŠ©ä½ ä»¥ç®€å•æ–¹å¼å¤„ç†æµçš„å‡½æ•°å’Œæ–¹æ³•ã€‚é€šè¿‡ä¸Šè¿°ä¾‹å­ï¼Œæˆ‘ä»¬çœ‹åˆ°å¦‚ä½•åœ¨æ–‡ä»¶è¯»å–å’Œç½‘ç»œè¯·æ±‚å¤„ç†ä¸­æœ‰æ•ˆåˆ©ç”¨è¿™äº›å·¥å…·ï¼Œä»¥é¿å…å†…å­˜é—®é¢˜å¹¶ç®€åŒ–ä»£ç ã€‚è¿™äº›åŠŸèƒ½å¼ºå¤§çš„å·¥å…·ä½¿å¾—åœ¨ Node.js ä¸­å¤„ç†æ•°æ®æµå˜å¾—æ›´åŠ æ–¹ä¾¿å’Œé«˜æ•ˆã€‚</p><h4 id="streamconsumers-arraybuffer-stream" tabindex="-1"><a class="header-anchor" href="#streamconsumers-arraybuffer-stream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#streamconsumersarraybufferstream" target="_blank" rel="noopener noreferrer">streamConsumers.arrayBuffer(stream)</a></span></a></h4><p>åœ¨è§£é‡Š <code>streamConsumers.arrayBuffer(stream)</code> è¿™ä¸ªåŠŸèƒ½ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£å‡ ä¸ªåŸºç¡€æ¦‚å¿µï¼šNode.jsã€Streamsï¼ˆæµï¼‰ã€ArrayBuffers å’Œ Web Streams APIã€‚è¿™ä¼šå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£æˆ‘ä»¬è¦è®¨è®ºçš„æ–¹æ³•ã€‚</p><h3 id="åŸºç¡€æ¦‚å¿µ-14" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ-14"><span>åŸºç¡€æ¦‚å¿µ</span></a></h3><ol><li><p><strong>Node.js:</strong><br> Node.js æ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç ã€è·¨å¹³å°çš„ JavaScript è¿è¡Œæ—¶ç¯å¢ƒï¼Œå®ƒå…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚</p></li><li><p><strong>Streamsï¼ˆæµï¼‰:</strong><br> åœ¨ Node.js ä¸­ï¼ŒStreams æ˜¯å¤„ç†è¯»å†™æ–‡ä»¶ã€ç½‘ç»œé€šä¿¡ç­‰ I/Oï¼ˆè¾“å…¥/è¾“å‡ºï¼‰æ“ä½œçš„ä¸€ç§æ–¹å¼ã€‚æµå¯ä»¥é«˜æ•ˆåœ°å¤„ç†å¤§é‡æ•°æ®ï¼Œå› ä¸ºå®ƒä»¬ä¸éœ€è¦ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚ç›¸åï¼Œæ•°æ®å¯ä»¥è¢«åˆ†æ‰¹å¤„ç†å’Œä¼ è¾“ã€‚</p></li><li><p><strong>ArrayBuffers:</strong><br> ArrayBuffer æ˜¯ JavaScript çš„ä¸€ç§æ•°æ®ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªå›ºå®šé•¿åº¦çš„åŸå§‹äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºã€‚å®ƒæ˜¯å¤„ç†äºŒè¿›åˆ¶æ•°æ®çš„ä½çº§æ¥å£ï¼Œå¸¸ç”¨äºä¸æ–‡ä»¶ã€ç½‘ç»œæ•°æ®ç­‰äº¤äº’ã€‚</p></li><li><p><strong>Web Streams API:</strong><br> è¿™æ˜¯ Web å¹³å°ä¸Šçš„ä¸€å¥—æ ‡å‡† APIï¼Œç”¨äºä»¥æµçš„æ–¹å¼å¤„ç†æ•°æ®ã€‚å®ƒæä¾›äº†ä¸€ç»„æ„å»ºå—ï¼Œä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿä»¥æµå¼çš„æ–¹å¼è¯»å–æˆ–å†™å…¥æ•°æ®ã€‚</p></li></ol><h3 id="streamconsumers-arraybuffer-stream-1" tabindex="-1"><a class="header-anchor" href="#streamconsumers-arraybuffer-stream-1"><span>streamConsumers.arrayBuffer(stream)</span></a></h3><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å…³æ³¨åˆ° <code>streamConsumers.arrayBuffer(stream)</code> è¿™ä¸ªæ–¹æ³•ã€‚è¿™æ˜¯ Node.js 21.7.1 ç‰ˆæœ¬ä¸­å¼•å…¥çš„ä¸€ä¸ªæ–°ç‰¹æ€§ï¼Œå±äº Web Streams API çš„ä¸€éƒ¨åˆ†ã€‚ç®€å•æ¥è¯´ï¼Œè¿™ä¸ªæ–¹æ³•å…è®¸ä½ å°†ä¸€ä¸ª Web Stream è½¬æ¢æˆä¸€ä¸ª ArrayBuffer å¯¹è±¡ã€‚</p><h3 id="å®é™…åº”ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨åœºæ™¯"><span>å®é™…åº”ç”¨åœºæ™¯</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦ä»ä¸€ä¸ªç½‘ç»œèµ„æºè¯»å–äºŒè¿›åˆ¶æ•°æ®ï¼Œæ¯”å¦‚ä¸‹è½½å›¾ç‰‡æˆ–è€…è§†é¢‘ã€‚ä½¿ç”¨ <code>streamConsumers.arrayBuffer(stream)</code> æ–¹æ³•ï¼Œä½ å¯ä»¥éå¸¸é«˜æ•ˆåœ°å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œå¹¶å°†è·å–çš„æ•°æ®ä½œä¸º ArrayBuffer å¯¹è±¡è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†æˆ–ä¿å­˜ã€‚</p><h4 id="ä¾‹å­-2" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2"><span>ä¾‹å­ï¼š</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> streamConsumers</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node:stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fetch</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node-fetch</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å‡å®šæˆ‘ä»¬ä½¿ç”¨ node-fetch æ¥è·å–ç½‘ç»œèµ„æº</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> downloadResourceAsArrayBuffer</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> response</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#88C0D0;"> fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> arrayBuffer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> streamConsumers</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">arrayBuffer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  return</span><span style="color:#D8DEE9;"> arrayBuffer</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨å‡½æ•°ä¸‹è½½æŸä¸ªå›¾ç‰‡æˆ–è§†é¢‘èµ„æº</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> imageUrl</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">https://example.com/some-image.png</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#88C0D0;">downloadResourceAsArrayBuffer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">imageUrl</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">arrayBuffer</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Downloaded Resource Size:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> arrayBuffer</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">byteLength</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // è¿™é‡Œä½ å¯ä»¥å°† arrayBuffer ä¿å­˜ä¸ºæ–‡ä»¶ï¼Œæˆ–è€…è¿›è¡Œå…¶ä»–å¤„ç†</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Error downloading resource:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ©ç”¨ <code>fetch</code> å‡½æ•°å»è¯·æ±‚ä¸€ä¸ªç½‘ç»œèµ„æºï¼Œ<code>response.body</code> æ˜¯ä¸€ä¸ª Web Stream å½¢å¼çš„å“åº”ä½“ã€‚ç„¶åï¼Œä½¿ç”¨ <code>streamConsumers.arrayBuffer(stream)</code> å°†è¿™ä¸ª Stream è½¬æ¢ä¸º ArrayBuffer å¯¹è±¡ã€‚æœ€åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®éœ€è¦å¤„ç†æˆ–ä¿å­˜è¿™ä¸ª ArrayBuffer äº†ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>streamConsumers.arrayBuffer(stream)</code> æä¾›äº†ä¸€ç§éå¸¸æ–¹ä¾¿çš„æ–¹å¼æ¥å¤„ç† Node.js ä¸­çš„ Web Streamsï¼Œå°¤å…¶æ˜¯å½“ä½ éœ€è¦å°†æ•°æ®è½¬æ¢ä¸º ArrayBuffer è¿›è¡Œå¤„ç†æ—¶ã€‚</p><h4 id="streamconsumers-blob-stream" tabindex="-1"><a class="header-anchor" href="#streamconsumers-blob-stream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#streamconsumersblobstream" target="_blank" rel="noopener noreferrer">streamConsumers.blob(stream)</a></span></a></h4><p>Node.js ä¸­çš„ <code>streamConsumers.blob(stream)</code> æ–¹æ³•æ˜¯ä¸€ä¸ªç›¸å¯¹è¾ƒæ–°å¼•å…¥çš„åŠŸèƒ½ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å°†ä¸€ä¸ªå¯è¯»æµ (readable stream) è½¬æ¢ä¸º Blob å¯¹è±¡ã€‚äº†è§£è¿™ä¸ªæ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç®€å•äº†è§£ä¸€ä¸‹å‡ ä¸ªæ¦‚å¿µï¼š</p><ol><li><p><strong>å¯è¯»æµ (Readable Stream)</strong>: åœ¨ Node.js ä¸­ï¼Œæµæ˜¯å¤„ç†æ•°æ®çš„ä¸€ç§æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯å½“ä½ ä¸éœ€è¦ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­æ—¶ã€‚ä¸€ä¸ªå¯è¯»æµå…è®¸ä½ æŒ‰é¡ºåºè¯»å–æ•°æ®å—ã€‚</p></li><li><p><strong>Blob</strong>: Blobï¼ˆBinary Large Objectï¼‰è¡¨ç¤ºä¸€ä¸ªä¸å¯å˜çš„ã€åŸå§‹æ•°æ®çš„ç±»æ–‡ä»¶å¯¹è±¡ã€‚åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ï¼ŒBlob å¸¸ç”¨äºå¤„ç†äºŒè¿›åˆ¶æ•°æ®ï¼Œæ¯”å¦‚æ–‡ä»¶æ“ä½œã€‚</p></li></ol><p><code>streamConsumers.blob(stream)</code> æ–¹æ³•çš„å¼•å…¥æä¾›äº†ä¸€ç§å°† Node.js ä¸­çš„æµæ•°æ®ç›´æ¥è½¬æ¢æˆ Blob å¯¹è±¡çš„ä¾¿æ·é€”å¾„ï¼Œè¿™åœ¨å¤„ç†æ–‡ä»¶æˆ–äºŒè¿›åˆ¶æ•°æ®æ—¶éå¸¸æœ‰ç”¨ã€‚</p><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-18" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-18"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><p>å‡å®šä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js ç¨‹åºï¼Œéœ€è¦ä»ç½‘ç»œä¸Šä¸‹è½½ä¸€å¼ å›¾ç‰‡ï¼Œç„¶åå°†å…¶ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€‚ä½¿ç”¨ <code>streamConsumers.blob(stream)</code> å¯ä»¥å¸®åŠ©ä½ æ›´æ–¹ä¾¿åœ°å¤„ç†è¿™ç§æƒ…å†µã€‚</p><h4 id="ç¤ºä¾‹ä»£ç -6" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹ä»£ç -6"><span>ç¤ºä¾‹ä»£ç </span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> streamConsumers</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node:stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fetch</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node-fetch</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> downloadImageAsBlob</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // ä½¿ç”¨ fetch API è·å–å›¾ç‰‡èµ„æº</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> response</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#88C0D0;"> fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> reader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReader</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // å°† ReadableStream è½¬æ¢ä¸º Node.js çš„ stream</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ReadableStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    async</span><span style="color:#88C0D0;"> start</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">controller</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">      while</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">        const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> done</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> value</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> reader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">done</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">break;</span></span>
<span class="line"><span style="color:#D8DEE9;">        controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enqueue</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#D8DEE9;">      controller</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // å°† stream è½¬æ¢ä¸º Blob</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> blob</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> streamConsumers</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">blob</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // å‡è®¾æˆ‘ä»¬ç°åœ¨æƒ³è¦å°†è¿™ä¸ª Blob ä¿å­˜ä¸ºæœ¬åœ°æ–‡ä»¶</span></span>
<span class="line"><span style="color:#616E88;">  // é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å°† Blob è½¬æ¢ä¸º Bufferï¼Œå› ä¸º fs æ¨¡å—éœ€è¦ç”¨ Buffer æ¥å†™æ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Buffer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">from</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">await</span><span style="color:#D8DEE9;"> blob</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">arrayBuffer</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // ä½¿ç”¨ fs.writeFile æ¥ä¿å­˜è¿™ä¸ªå›¾ç‰‡åˆ°æœ¬åœ°</span></span>
<span class="line"><span style="color:#D8DEE9;">  fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">writeFile</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">downloaded_image.jpg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ä¿å­˜æ–‡ä»¶å¤±è´¥</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æ–‡ä»¶æˆåŠŸä¿å­˜</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡½æ•°è°ƒç”¨ï¼Œä¼ å…¥å›¾ç‰‡çš„ URL</span></span>
<span class="line"><span style="color:#88C0D0;">downloadImageAsBlob</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://example.com/path/to/image.jpg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤ç¤ºä¾‹ä¸­é¦–å…ˆä½¿ç”¨äº† <code>fetch</code> API æ¥è·å–ç½‘ç»œä¸Šçš„å›¾ç‰‡èµ„æºï¼Œç„¶åé€šè¿‡ <code>.getReader()</code> æ–¹æ³•è·å–åˆ°äº†ä¸€ä¸ªè¯»å–å™¨ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸º Node.js å¯ç”¨çš„ <code>stream</code>ã€‚æ¥ç€ä½¿ç”¨ <code>streamConsumers.blob(stream)</code> å°†è¿™ä¸ª <code>stream</code> è½¬æ¢æˆäº†ä¸€ä¸ª <code>Blob</code> å¯¹è±¡ã€‚ç”±äºåœ¨ Node.js ç¯å¢ƒä¸­é€šå¸¸å¤„ç†æ–‡ä»¶ä¼šç”¨åˆ° Bufferï¼Œæ‰€ä»¥ç¤ºä¾‹ä¸­è¿˜å±•ç¤ºäº†å¦‚ä½•å°† Blob è½¬æ¢ä¸º Bufferï¼Œæœ€åä½¿ç”¨ <code>fs.writeFile</code> å‡½æ•°å°†å›¾ç‰‡ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹å±•ç¤ºäº†å¦‚ä½•åœ¨ Node.js ä¸­å¤„ç†äºŒè¿›åˆ¶æ•°æ®æµï¼ŒåŒæ—¶ä¹Ÿè¯´æ˜äº† <code>streamConsumers.blob(stream)</code> åœ¨å®é™…åº”ç”¨ä¸­å¦‚ä½•èµ·åˆ°æ¡¥æ¢ä½œç”¨ï¼Œä½¿å¾—ä»æµåˆ° Blobï¼Œå†åˆ°æœ€ç»ˆæ•°æ®å¤„ç†å˜å¾—å®¹æ˜“å’Œç›´è§‚ã€‚</p><h4 id="streamconsumers-buffer-stream" tabindex="-1"><a class="header-anchor" href="#streamconsumers-buffer-stream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#streamconsumersbufferstream" target="_blank" rel="noopener noreferrer">streamConsumers.buffer(stream)</a></span></a></h4><p>Node.js v21.7.1 ä¸­çš„<code>streamConsumers.buffer(stream)</code>æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå®ƒå±äº Node.js ä¸­çš„ Web Streams APIã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬é€æ­¥äº†è§£ä¸€ä¸‹è¿™ä¸ªåŠŸèƒ½ä»¥åŠå¦‚ä½•è¿ç”¨å®ƒã€‚</p><h3 id="ä»€ä¹ˆæ˜¯-stream-1" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯-stream-1"><span>ä»€ä¹ˆæ˜¯ Streamï¼Ÿ</span></a></h3><p>åœ¨ç¼–ç¨‹ä¸­ï¼Œâ€œStreamâ€æŒ‡çš„æ˜¯æ•°æ®çš„è¿ç»­æµã€‚æƒ³è±¡ä¸€ä¸‹ä¸€æ¡æ²³æµï¼Œæ°´ï¼ˆæ•°æ®ï¼‰ä»æºå¤´ä¸æ–­æµå‘ä¸‹æ¸¸ã€‚åœ¨ Node.js ä¸­ï¼ŒStreams è¢«ç”¨æ¥å¤„ç†å¤§é‡æ•°æ®ï¼Œæ¯”å¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œé€šä¿¡ç­‰ï¼Œå› ä¸ºå®ƒä»¬å…è®¸æ•°æ®è¾¹ç”Ÿæˆè¾¹å¤„ç†ï¼Œè€Œä¸éœ€è¦ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><h3 id="streamconsumers-buffer-stream-1" tabindex="-1"><a class="header-anchor" href="#streamconsumers-buffer-stream-1"><span>streamConsumers.buffer(stream)</span></a></h3><p><code>streamConsumers.buffer(stream)</code>æ˜¯ä¸€ä¸ªç‰¹å®šçš„ APIï¼Œå…¶ä½œç”¨æ˜¯å°†ä¸€ä¸ª Readable Streamï¼ˆå¯è¯»æµï¼‰ä¸­çš„æ‰€æœ‰æ•°æ®æ”¶é›†å¹¶åˆå¹¶æˆä¸€ä¸ªå•ä¸€çš„ Bufferã€‚Buffer æ˜¯ Node.js ä¸­ç”¨æ¥é«˜æ•ˆå¤„ç†æ•°æ®çš„å¯¹è±¡ï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯ä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œä¸“é—¨ç”¨äºå­˜æ”¾äºŒè¿›åˆ¶æ•°æ®ã€‚</p><p>ä½¿ç”¨<code>streamConsumers.buffer(stream)</code>éå¸¸é€‚åˆäºé‚£äº›ä½ éœ€è¦ä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰æµæ•°æ®çš„åœºæ™¯ã€‚</p><h3 id="å®é™…åº”ç”¨ç¤ºä¾‹-7" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ç¤ºä¾‹-7"><span>å®é™…åº”ç”¨ç¤ºä¾‹</span></a></h3><h4 id="ç¤ºä¾‹-1-è¯»å–æ–‡ä»¶å†…å®¹" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-1-è¯»å–æ–‡ä»¶å†…å®¹"><span>ç¤ºä¾‹ 1ï¼šè¯»å–æ–‡ä»¶å†…å®¹</span></a></h4><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œä½ æƒ³ä¸€æ¬¡æ€§è¯»å–å®ƒçš„å…¨éƒ¨å†…å®¹æ¥è¿›è¡Œå¤„ç†ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> streamConsumers</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/consumers</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> readFileContents</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">filePath</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // åˆ›å»ºä¸€ä¸ªå¯è¯»æµ</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">filePath</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // ä½¿ç”¨streamConsumers.buffer()æ¥è·å–å…¨éƒ¨æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> streamConsumers</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">buffer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // å°†Bufferè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼ˆå¦‚æœæ–‡ä»¶æ˜¯æ–‡æœ¬çš„è¯ï¼‰</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> content</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">content</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">readFileContents</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./bigfile.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡<code>fs.createReadStream()</code>åˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘æ–‡ä»¶çš„å¯è¯»æµã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨<code>streamConsumers.buffer(stream)</code>æ¥å°†æµä¸­çš„æ•°æ®å…¨éƒ¨è¯»å–å‡ºæ¥å¹¶æ”¾å…¥ä¸€ä¸ª Buffer ä¸­ã€‚æœ€åï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ª Buffer è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶æ‰“å°å‡ºæ¥ã€‚</p><h4 id="ç¤ºä¾‹-2-å¤„ç†-http-å“åº”æ•°æ®" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-2-å¤„ç†-http-å“åº”æ•°æ®"><span>ç¤ºä¾‹ 2ï¼šå¤„ç† HTTP å“åº”æ•°æ®</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨ä½¿ç”¨ Node.js æ¥å‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œå¹¶ä¸”ä½ æƒ³è¦å¤„ç†è¿”å›çš„æ•°æ®ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> https</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> streamConsumers</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/consumers</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> fetchUrl</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  https</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> async</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">response</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // ä½¿ç”¨streamConsumers.buffer()æ¥è·å–å“åº”ä½“çš„å…¨éƒ¨æ•°æ®</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> streamConsumers</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">buffer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">response</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // å°†Bufferè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼ˆå¦‚æœå“åº”ä½“æ˜¯æ–‡æœ¬çš„è¯ï¼‰</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> responseBody</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">responseBody</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">fetchUrl</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://example.com</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>https.get()</code>æ–¹æ³•å‘èµ·äº†ä¸€ä¸ª GET è¯·æ±‚ã€‚æˆ‘ä»¬åˆ©ç”¨<code>streamConsumers.buffer(response)</code>æ¥å¤„ç†å“åº”ä½“ï¼Œå…¶ä¸­<code>response</code>æ˜¯ä¸€ä¸ª Streamã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°è·å–å’Œä½¿ç”¨æ•´ä¸ªå“åº”ä½“çš„æ•°æ®ã€‚</p><h3 id="æ€»ç»“-20" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-20"><span>æ€»ç»“</span></a></h3><p><code>streamConsumers.buffer(stream)</code>æ˜¯ä¸€ä¸ªå¼ºå¤§è€Œå®ç”¨çš„å·¥å…·ï¼Œå®ƒèƒ½è®©ä½ è½»æ¾åœ°å¤„ç† Node.js ä¸­çš„æµæ•°æ®ã€‚æ— è®ºæ˜¯è¯»å–å¤§æ–‡ä»¶è¿˜æ˜¯å¤„ç†ç½‘ç»œå“åº”ï¼Œè¿™ä¸ª API éƒ½èƒ½è®©ä½ çš„ä»£ç æ›´åŠ ç®€æ´å’Œé«˜æ•ˆã€‚</p><h4 id="streamconsumers-json-stream" tabindex="-1"><a class="header-anchor" href="#streamconsumers-json-stream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#streamconsumersjsonstream" target="_blank" rel="noopener noreferrer">streamConsumers.json(stream)</a></span></a></h4><p>ç†è§£ <code>streamConsumers.json(stream)</code> è¿™ä¸ªåŠŸèƒ½ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œç„¶åé€æ­¥æ·±å…¥åˆ°å…·ä½“çš„ç”¨æ³•å’Œç¤ºä¾‹ã€‚</p><h3 id="åŸºç¡€æ¦‚å¿µ-15" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ-15"><span>åŸºç¡€æ¦‚å¿µ</span></a></h3><ol><li><strong>Node.js</strong> æ˜¯ä¸€ä¸ªè®© JavaScript è¿è¡Œåœ¨æœåŠ¡å™¨ä¸Šçš„å¹³å°ã€‚å®ƒéå¸¸é€‚åˆå¤„ç†é«˜å¹¶å‘ã€IO å¯†é›†çš„ä»»åŠ¡ï¼Œæ¯”å¦‚ç½‘ç»œé€šä¿¡ã€æ–‡ä»¶æ“ä½œç­‰ã€‚</li><li><strong>Streams</strong>ï¼šåœ¨ Node.js ä¸­ï¼Œæµ(Streams)æ˜¯å¤„ç†è¯»å†™æ•°æ®çš„ä¸€ç§æ–¹å¼ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆæ°´æµï¼Œæ•°æ®å°±åƒæ°´ä¸€æ ·ï¼Œä»ä¸€ä¸ªåœ°æ–¹ï¼ˆæºå¤´ï¼‰æµå‘å¦ä¸€ä¸ªåœ°æ–¹ï¼ˆç›®çš„åœ°ï¼‰ã€‚è¿™ç§æ–¹å¼ä½¿å¾—å¤„ç†å¤§é‡æ•°æ®å˜å¾—é«˜æ•ˆï¼Œå› ä¸ºä½ ä¸éœ€è¦ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</li><li><strong>Web Streams API</strong>ï¼šè¿™æ˜¯ Web æ ‡å‡†ä¸­å®šä¹‰çš„ä¸€å¥—æ¥å£ï¼Œç”¨äºåœ¨ç½‘ç»œåº”ç”¨ç¨‹åºä¸­ä»¥æµçš„æ–¹å¼å¤„ç†æ•°æ®ã€‚å®ƒæä¾›äº†æ„å»ºå’Œä½¿ç”¨æµæ•°æ®çš„æ–¹æ³•ï¼Œæ¯”å¦‚è¯»å–è¯·æ±‚çš„æ­£æ–‡æˆ–è€…å†™å…¥å“åº”æ­£æ–‡ã€‚</li></ol><h3 id="streamconsumers-json-stream-1" tabindex="-1"><a class="header-anchor" href="#streamconsumers-json-stream-1"><span>streamConsumers.json(stream)</span></a></h3><p><code>streamConsumers.json(stream)</code> æ˜¯ Node.js v21.7.1 ä¸­å¼•å…¥çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒå±äº Web Streams API çš„ä¸€éƒ¨åˆ†ã€‚ç®€å•æ¥è¯´ï¼Œè¿™ä¸ªåŠŸèƒ½å…è®¸ä½ å°†ä¸€ä¸ªæµï¼ˆstreamï¼‰ä¸­çš„æ•°æ®è¯»å–å¹¶è½¬æ¢æˆ JSON å¯¹è±¡ã€‚è¿™ç‰¹åˆ«æœ‰ç”¨ï¼Œåœ¨å¤„ç†ä¾‹å¦‚ç½‘ç»œè¯·æ±‚æ—¶ï¼Œä½ å¯èƒ½ä¼šæ”¶åˆ°åŒ…å« JSON æ•°æ®çš„æµï¼Œè€Œä½ å¸Œæœ›å°†è¿™äº›æ•°æ®è½¬æ¢æˆ JavaScript å¯¹è±¡ä»¥ä¾¿æ›´æ–¹ä¾¿åœ°æ“ä½œå®ƒä»¬ã€‚</p><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-19" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-19"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª web æœåŠ¡å™¨ï¼Œå¹¶ä¸”ä½ æƒ³è¦å¤„ç†ä¸€ä¸ª POST è¯·æ±‚ï¼Œè¯¥è¯·æ±‚çš„æ­£æ–‡æ˜¯ JSON æ ¼å¼çš„æ•°æ®ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨<code>streamConsumers.json(stream)</code>æ¥å¤„ç†è¿™ç±»è¯·æ±‚çš„ä¸€ä¸ªä¾‹å­ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> http</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">http</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> streamConsumers</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">http</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">createServer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">async</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">req</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> res</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">req</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">method</span><span style="color:#81A1C1;"> ===</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">POST</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">      try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">        // å°†è¯·æ±‚æµè½¬æ¢ä¸ºJSONå¯¹è±¡</span></span>
<span class="line"><span style="color:#81A1C1;">        const</span><span style="color:#D8DEE9;"> data</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> streamConsumers</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">json</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">req</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">        console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // åœ¨æ§åˆ¶å°æ‰“å°è¯·æ±‚ä¸­çš„JSONæ•°æ®</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        // å“åº”å®¢æˆ·ç«¯</span></span>
<span class="line"><span style="color:#D8DEE9;">        res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">writeHead</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">200</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Content-Type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">application/json</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">JSON</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">stringify</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> message</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Data received successfully</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span><span style="color:#81A1C1;"> catch</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">        // é”™è¯¯å¤„ç†</span></span>
<span class="line"><span style="color:#D8DEE9;">        console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">writeHead</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">400</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Content-Type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">application/json</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">JSON</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">stringify</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> error</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Failed to parse JSON</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // å¤„ç†éPOSTè¯·æ±‚</span></span>
<span class="line"><span style="color:#D8DEE9;">      res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">writeHead</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">405</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Content-Type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">application/json</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">      res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">JSON</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">stringify</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> error</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Method Not Allowed</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">listen</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">3000</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#D8DEE9;"> console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Server running on port 3000</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç åˆ›å»ºäº†ä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œå®ƒç›‘å¬ POST è¯·æ±‚ã€‚å½“æ¥æ”¶åˆ° POST è¯·æ±‚æ—¶ï¼Œå®ƒé€šè¿‡<code>streamConsumers.json(req)</code>å°†è¯·æ±‚çš„ body éƒ¨åˆ†ï¼ˆå³æµï¼‰è½¬æ¢æˆäº† JSON å¯¹è±¡ã€‚ç„¶åï¼ŒæœåŠ¡å™¨å°±å¯ä»¥è½»æ¾åœ°å¤„ç†è¿™ä¸ªå¯¹è±¡ï¼Œæ¯”å¦‚æ‰“å°åˆ°æ§åˆ¶å°æˆ–è€…æ ¹æ®å†…å®¹ä½œå‡ºå“åº”ã€‚å¦‚æœè½¬æ¢è¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯ï¼ˆæ¯”å¦‚è¯·æ±‚çš„æ­£æ–‡ä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼‰ï¼Œåˆ™ä¼šæ•è·å¼‚å¸¸ï¼Œå¹¶è¿”å›ä¸€ä¸ªé”™è¯¯å“åº”ç»™å®¢æˆ·ç«¯ã€‚</p><h3 id="å°ç»“-3" tabindex="-1"><a class="header-anchor" href="#å°ç»“-3"><span>å°ç»“</span></a></h3><p><code>streamConsumers.json(stream)</code> æä¾›äº†ä¸€ç§ä¾¿æ·çš„æ–¹æ³•æ¥å¤„ç†é‚£äº›ä»¥æµå½¢å¼æ¥æ”¶çš„ JSON æ•°æ®ï¼Œå®ƒèƒ½å¤Ÿè‡ªåŠ¨å°†æµä¸­çš„æ•°æ®è½¬æ¢ä¸º JavaScript å¯¹è±¡ï¼Œè¿™å¯¹äºå¼€å‘åŸºäº Node.js çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¥è¯´éå¸¸æœ‰å¸®åŠ©ã€‚</p><h4 id="streamconsumers-text-stream" tabindex="-1"><a class="header-anchor" href="#streamconsumers-text-stream"><span><a href="https://nodejs.org/docs/latest/api/webstreams.html#streamconsumerstextstream" target="_blank" rel="noopener noreferrer">streamConsumers.text(stream)</a></span></a></h4><p>Node.js ä¸­çš„ <code>streamConsumers.text(stream)</code> æ–¹æ³•æ˜¯ä¸€ä¸ªç”¨äºå¤„ç†æµï¼ˆstreamsï¼‰çš„å·¥å…·ï¼Œç‰¹åˆ«æ˜¯åœ¨ v21.7.1 ç‰ˆæœ¬ä¸­ä½œä¸º Web Streams API çš„ä¸€éƒ¨åˆ†ã€‚è¦ç†è§£è¿™ä¸ªæ–¹æ³•ï¼Œé¦–å…ˆå¾—å¼„æ¸…æ¥šå‡ ä¸ªæ¦‚å¿µï¼šNode.jsã€æµï¼ˆStreamsï¼‰ã€ä»¥åŠ Web Streams APIã€‚</p><h3 id="node-js-ç®€ä»‹-2" tabindex="-1"><a class="header-anchor" href="#node-js-ç®€ä»‹-2"><span>Node.js ç®€ä»‹</span></a></h3><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œæ—¶ç¯å¢ƒï¼Œè®©ä½ å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScriptã€‚å®ƒéå¸¸é€‚åˆè¿›è¡Œ I/O å¯†é›†å‹æ“ä½œï¼Œæ¯”å¦‚ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶æ“ä½œç­‰ï¼Œè€Œæµï¼ˆStreamsï¼‰æ˜¯ Node.js å¤„ç†è¿™ç±»æ“ä½œçš„é‡è¦æœºåˆ¶ä¹‹ä¸€ã€‚</p><h3 id="æµ-streams-ç®€ä»‹-1" tabindex="-1"><a class="header-anchor" href="#æµ-streams-ç®€ä»‹-1"><span>æµï¼ˆStreamsï¼‰ç®€ä»‹</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œæµæ˜¯ä¸€ç§æŠ½è±¡çš„æ¥å£ï¼Œè¢«è®¾è®¡ç”¨æ¥å¤„ç†è¯»å†™æ“ä½œï¼Œä¾‹å¦‚è¯»å–æ–‡ä»¶ã€ç½‘ç»œé€šä¿¡ç­‰ã€‚æµå¯ä»¥å°†å¤§é‡æ•°æ®åˆ†æˆå°å—é€æ¸å¤„ç†ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å°†æ•°æ®å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè¿™æ ·å°±å¤§å¤§æé«˜äº†ç¨‹åºçš„æ•ˆç‡å’Œæ€§èƒ½ã€‚</p><h3 id="web-streams-api-3" tabindex="-1"><a class="header-anchor" href="#web-streams-api-3"><span>Web Streams API</span></a></h3><p>Web Streams API æä¾›äº†ä¸€å¥—æ ‡å‡†çš„æµæ§åˆ¶æ¥å£ï¼Œå…è®¸ JavaScript åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ä»¥ç›¸ä¼¼çš„æ–¹å¼å¤„ç†æµå¼æ•°æ®ã€‚<code>streamConsumers.text(stream)</code> å°±æ˜¯ Web Streams API ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºå°†ä¸€ä¸ªå¯è¯»æµï¼ˆReadableStreamï¼‰ä¸­çš„æ•°æ®è¯»å–å‡ºæ¥ï¼Œå¹¶è½¬æ¢æˆæ–‡æœ¬å½¢å¼ã€‚</p><h3 id="streamconsumers-text-stream-1" tabindex="-1"><a class="header-anchor" href="#streamconsumers-text-stream-1"><span><code>streamConsumers.text(stream)</code></span></a></h3><p>è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯æŠŠä¸€ä¸ªæµï¼ˆå…·ä½“è€Œè¨€ï¼Œæ˜¯ä¸€ä¸ª <code>ReadableStream</code> å¯¹è±¡ï¼‰ä¸­çš„æ•°æ®å…¨éƒ¨è¯»å–å‡ºæ¥ï¼Œå¹¶å°†è¯»å–åˆ°çš„æ•°æ®è½¬æ¢ä¸ºæ–‡æœ¬ï¼ˆå­—ç¬¦ä¸²ï¼‰ã€‚è¿™å¯¹äºå¤„ç†åƒä» HTTP å“åº”æˆ–è€…æ–‡ä»¶è¯»å–ç­‰æ¥æºè·å–çš„æ–‡æœ¬æ•°æ®éå¸¸æœ‰ç”¨ã€‚</p><h4 id="å®é™…è¿ç”¨ç¤ºä¾‹-20" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-20"><span>å®é™…è¿ç”¨ç¤ºä¾‹ï¼š</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦ä»äº’è”ç½‘ä¸Šä¸‹è½½ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ç„¶åå¤„ç†å…¶ä¸­çš„å†…å®¹ã€‚ä½¿ç”¨ <code>streamConsumers.text(stream)</code> æ–¹æ³•ï¼Œä½ å¯ä»¥è½»æ¾åœ°å°†æ–‡ä»¶å†…å®¹è¯»å–ä¸ºæ–‡æœ¬ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#ECEFF4;"> {</span><span style="color:#8FBCBB;"> streamConsumers</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> from</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">node:stream/web</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">import</span><span style="color:#ECEFF4;"> {</span><span style="color:#8FBCBB;"> fetch</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> from</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">node-fetch</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> fetchText</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> response</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#88C0D0;"> fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">url</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">ok</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    throw</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">Failed to fetch </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">url</span><span style="color:#81A1C1;">}</span><span style="color:#A3BE8C;">: </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">statusText</span><span style="color:#81A1C1;">}</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">  // ä½¿ç”¨ streamConsumers.text å°†æµè½¬æ¢ä¸ºæ–‡æœ¬</span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> text</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> await</span><span style="color:#D8DEE9;"> streamConsumers</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">text</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">stream</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  return</span><span style="color:#D8DEE9;"> text</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾æœ‰ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶çš„ URL</span></span>
<span class="line"><span style="color:#88C0D0;">fetchText</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://example.com/somefile.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">text</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">text</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºä¸‹è½½æ–‡ä»¶çš„å†…å®¹</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Error fetching text:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡ <code>fetch</code> è·å–åˆ°ä¸€ä¸ªç½‘ç»œèµ„æºçš„å“åº”ä½“ï¼ˆResponse.bodyï¼‰ï¼Œè¿™ä¸ªå“åº”ä½“æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæµï¼ˆReadableStreamï¼‰ã€‚ä¹‹åï¼Œæˆ‘ä»¬åˆ©ç”¨ <code>streamConsumers.text(stream)</code> æ–¹æ³•å°†è¿™ä¸ªæµä¸­çš„æ•°æ®å…¨éƒ¨è¯»å–å¹¶è½¬æ¢æˆæ–‡æœ¬æ ¼å¼ï¼Œæœ€ç»ˆè¾“å‡ºæˆ–è¿›ä¸€æ­¥å¤„ç†è¿™æ®µæ–‡æœ¬ã€‚</p><p>è¿™åªæ˜¯ <code>streamConsumers.text(stream)</code> æ–¹æ³•çš„ä¸€ä¸ªå®ä¾‹åº”ç”¨ï¼Œå®é™…ä¸Šï¼Œå®ƒå¯ä»¥å¹¿æ³›åº”ç”¨äºä»»ä½•éœ€è¦ä»æµä¸­è¯»å–æ–‡æœ¬æ•°æ®çš„åœºæ™¯ä¸­ã€‚</p></div><!----><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="vp-meta-label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="vp-meta-info" title="email: kamiacgxu@gmail.com">kamishima-kaede</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/document/node-doc/Web%20Crypto%20API.html" aria-label="Web Crypto API"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->Web Crypto API</div></a><a class="route-link auto-link next" href="/document/node-doc/WebAssembly%20System%20Interface%20(WASI).html" aria-label="WebAssembly System Interface (WASI)"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">WebAssembly System Interface (WASI)<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><!----><div class="vp-copyright">Copyright Â© 2018-present hanekawa-shiki</div></footer></div><!--]--><!--]--><!--[--><!----><!----><!--]--><!--]--></div>
    <script src="/assets/js/runtime~app.b7c0d7f2.js" defer></script><script src="/assets/js/4485.d2710361.js" defer></script><script src="/assets/js/app.ed12edd2.js" defer></script>
  </body>
</html>
