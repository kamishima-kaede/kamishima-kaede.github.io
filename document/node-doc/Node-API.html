<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.14" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.49" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://hanekawa.top/document/node-doc/Node-API.html"><meta property="og:site_name" content="hanekawa-shiki"><meta property="og:title" content="Node-API"><meta property="og:description" content="Node-API Node-APIï¼ˆä»¥å‰ç§°ä¸º N-APIï¼‰æ˜¯ Node.js æä¾›çš„ä¸€ä¸ª API å±‚ï¼Œå®ƒå…è®¸ä½ ç”¨ C æˆ– C++ç¼–å†™æ’ä»¶ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨ Node-APIï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒæä¾›äº†ä¸€ç§ä¸åº•å±‚ JavaScript å¼•æ“ï¼ˆå¦‚ V8ï¼‰è§£è€¦çš„æ–¹å¼æ¥æ„å»ºåŸç”Ÿæ‰©å±•ã€‚è¿™æ„å‘³ç€å½“ Node.js æ›´æ–°å…¶å†…éƒ¨å¼•æ“æ—¶ï¼Œä½¿ç”¨ Node-API æ„å»ºçš„æ’ä»¶ä¸éœ€è¦é‡å†™æ¥..."><meta property="og:type" content="website"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-06-21T09:46:17.000Z"><meta property="article:author" content="hanekawa-shiki"><meta property="article:modified_time" content="2024-06-21T09:46:17.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"WebPage","name":"Node-API","description":"Node-API Node-APIï¼ˆä»¥å‰ç§°ä¸º N-APIï¼‰æ˜¯ Node.js æä¾›çš„ä¸€ä¸ª API å±‚ï¼Œå®ƒå…è®¸ä½ ç”¨ C æˆ– C++ç¼–å†™æ’ä»¶ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨ Node-APIï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒæä¾›äº†ä¸€ç§ä¸åº•å±‚ JavaScript å¼•æ“ï¼ˆå¦‚ V8ï¼‰è§£è€¦çš„æ–¹å¼æ¥æ„å»ºåŸç”Ÿæ‰©å±•ã€‚è¿™æ„å‘³ç€å½“ Node.js æ›´æ–°å…¶å†…éƒ¨å¼•æ“æ—¶ï¼Œä½¿ç”¨ Node-API æ„å»ºçš„æ’ä»¶ä¸éœ€è¦é‡å†™æ¥..."}</script><meta name="keywords" content="JavaScript,HTML,CSS"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/assets/icons/chrome-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/assets/icons/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icons/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/assets/icons/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#5c92d1"><link rel="apple-touch-icon" href="/assets/icons/apple-touch-icon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="white"><meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><title>Node-API | hanekawa-shiki</title><meta name="description" content="Node-API Node-APIï¼ˆä»¥å‰ç§°ä¸º N-APIï¼‰æ˜¯ Node.js æä¾›çš„ä¸€ä¸ª API å±‚ï¼Œå®ƒå…è®¸ä½ ç”¨ C æˆ– C++ç¼–å†™æ’ä»¶ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨ Node-APIï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒæä¾›äº†ä¸€ç§ä¸åº•å±‚ JavaScript å¼•æ“ï¼ˆå¦‚ V8ï¼‰è§£è€¦çš„æ–¹å¼æ¥æ„å»ºåŸç”Ÿæ‰©å±•ã€‚è¿™æ„å‘³ç€å½“ Node.js æ›´æ–°å…¶å†…éƒ¨å¼•æ“æ—¶ï¼Œä½¿ç”¨ Node-API æ„å»ºçš„æ’ä»¶ä¸éœ€è¦é‡å†™æ¥...">
    <link rel="stylesheet" href="/assets/css/styles.a84c0532.css">
    <link rel="preload" href="/assets/js/runtime~app.80796dd3.js" as="script"><link rel="preload" href="/assets/css/styles.a84c0532.css" as="style"><link rel="preload" href="/assets/js/4485.e6fe7c7b.js" as="script"><link rel="preload" href="/assets/js/app.2fd0ad37.js" as="script">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo light" src="/assets/svg/logo.svg" alt><img class="vp-nav-logo dark" src="/assets/svg/logo.svg" alt><span class="vp-site-name hide-in-pad">hanekawa-shiki</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="åšå®¢ä¸»é¡µ"><!--[--><span class="font-icon icon home" style=""></span><!--]-->åšå®¢ä¸»é¡µ<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="å­¦ä¹ ç¬”è®°"><!--[--><span class="font-icon icon framework" style=""></span>å­¦ä¹ ç¬”è®°<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">å‰ç«¯æ¡†æ¶</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/framework_front/vue3/" aria-label="Vue3ç¬”è®°"><!--[--><span class="font-icon icon vue" style=""></span><!--]-->Vue3ç¬”è®°<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/framework_front/react/" aria-label="Reactç¬”è®°"><!--[--><span class="font-icon icon react" style=""></span><!--]-->Reactç¬”è®°<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="æ–‡æ¡£"><!--[--><span class="font-icon icon framework" style=""></span>æ–‡æ¡£<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">æ¬è¿</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link route-link-active auto-link" href="/document/node-doc/" aria-label="Node.jsæ–‡æ¡£"><!--[--><span class="font-icon icon circle-info" style=""></span><!--]-->Node.jsæ–‡æ¡£<!----></a></li></ul></li></ul></button></div></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/hanekawa-shiki/hanekawa-shiki.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/" aria-label="Node.jsæ–‡æ¡£"><!--[--><span class="font-icon icon circle-info" style=""></span><!--]-->Node.jsæ–‡æ¡£<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Assert.html" aria-label="Assert"><!---->Assert<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Async%20hooks.html" aria-label="Async hooks"><!---->Async hooks<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Asynchronous%20context%20tracking.html" aria-label="Asynchronous context tracking"><!---->Asynchronous context tracking<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Buffer.html" aria-label="Buffer"><!---->Buffer<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/C__%20addons.html" aria-label="C++ addons"><!---->C++ addons<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/C__%20embedder%20API.html" aria-label="C++ embedder API"><!---->C++ embedder API<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Child%20process.html" aria-label="Child process"><!---->Child process<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Cluster.html" aria-label="Cluster"><!---->Cluster<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Command-line%20API.html" aria-label="Command-line API"><!---->Command-line API<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Console.html" aria-label="Console"><!---->Console<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Corepack.html" aria-label="Corepack"><!---->Corepack<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Crypto.html" aria-label="Crypto"><!---->Crypto<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Debugger.html" aria-label="Debugger"><!---->Debugger<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Deprecated%20APIs.html" aria-label="Deprecated APIs"><!---->Deprecated APIs<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Diagnostic%20report.html" aria-label="Diagnostic report"><!---->Diagnostic report<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Diagnostics%20Channel.html" aria-label="Diagnostics Channel"><!---->Diagnostics Channel<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/DNS.html" aria-label="DNS"><!---->DNS<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Domain.html" aria-label="Domain"><!---->Domain<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Errors.html" aria-label="Errors"><!---->Errors<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Events.html" aria-label="Events"><!---->Events<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/File%20system.html" aria-label="File system"><!---->File system<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Global%20objects.html" aria-label="Global objects"><!---->Global objects<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/HTTP.html" aria-label="HTTP"><!---->HTTP<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/HTTPS.html" aria-label="HTTPS"><!---->HTTPS<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Inspector.html" aria-label="Inspector"><!---->Inspector<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Internationalization%20support.html" aria-label="Internationalization support"><!---->Internationalization support<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Modules_CommonJS%20modules.html" aria-label="Modules: CommonJS modules"><!---->Modules: CommonJS modules<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Modules_ECMAScript%20modules.html" aria-label="Modules: ECMAScript modules"><!---->Modules: ECMAScript modules<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Modules_node_module%20API.html" aria-label="Modules: node:module API"><!---->Modules: node:module API<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Modules_Packages.html" aria-label="Modules: Packages"><!---->Modules: Packages<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Net.html" aria-label="Net"><!---->Net<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/document/node-doc/Node-API.html" aria-label="Node-API"><!---->Node-API<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/OS.html" aria-label="OS"><!---->OS<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Path.html" aria-label="Path"><!---->Path<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Performance%20measurement%20APIs.html" aria-label="Performance measurement APIs"><!---->Performance measurement APIs<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Permissions.html" aria-label="Permissions"><!---->Permissions<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Process.html" aria-label="Process"><!---->Process<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Punycode.html" aria-label="Punycode"><!---->Punycode<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Query%20string.html" aria-label="Query string"><!---->Query string<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Readline.html" aria-label="Readline"><!---->Readline<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/REPL.html" aria-label="REPL"><!---->REPL<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Stream.html" aria-label="Stream"><!---->Stream<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/String%20decoder.html" aria-label="String decoder"><!---->String decoder<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Test%20runner.html" aria-label="Test runner"><!---->Test runner<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Timers.html" aria-label="Timers"><!---->Timers<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/TLS%20(SSL).html" aria-label="TLS (SSL)"><!---->TLS (SSL)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Trace%20events.html" aria-label="Trace events"><!---->Trace events<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/TTY.html" aria-label="TTY"><!---->TTY<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/URL.html" aria-label="URL"><!---->URL<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Util.html" aria-label="Util"><!---->Util<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/V8.html" aria-label="V8"><!---->V8<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/VM%20(executing%20JavaScript).html" aria-label="VM (executing JavaScript)"><!---->VM (executing JavaScript)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Web%20Crypto%20API.html" aria-label="Web Crypto API"><!---->Web Crypto API<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Web%20Streams%20API.html" aria-label="Web Streams API"><!---->Web Streams API<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/WebAssembly%20System%20Interface%20(WASI).html" aria-label="WebAssembly System Interface (WASI)"><!---->WebAssembly System Interface (WASI)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Worker%20threads.html" aria-label="Worker threads"><!---->Worker threads<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/document/node-doc/Zlib.html" aria-label="Zlib"><!---->Zlib<!----></a></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Node-API</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://hanekawa.top" target="_blank" rel="noopener noreferrer">hanekawa-shiki</a></span><span property="author" content="hanekawa-shiki"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-06-21T09:46:17.000Z"></span><!----><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 546 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT546M"></span><span class="page-word-info" aria-label="å­—æ•°ğŸ” " data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon" name="word"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>çº¦ 163717 å­—</span><meta property="wordCount" content="163717"></span><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#implications-of-abi-stability">Implications of ABI stability</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#abi-ç¨³å®šæ€§çš„å½±å“">ABI ç¨³å®šæ€§çš„å½±å“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­">å®é™…è¿ç”¨çš„ä¾‹å­ï¼š</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#building">Building</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ„å»ºåŸç”Ÿæ¨¡å—çš„æ­¥éª¤">æ„å»ºåŸç”Ÿæ¨¡å—çš„æ­¥éª¤</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­">å®é™…ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#build-tools">Build tools</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#uploading-precompiled-binaries">Uploading precompiled binaries</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¸ºä»€ä¹ˆéœ€è¦-node-pre-gyp">ä¸ºä»€ä¹ˆéœ€è¦ node-pre-gypï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¦‚ä½•ä½¿ç”¨-node-pre-gyp">å¦‚ä½•ä½¿ç”¨ node-pre-gyp</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#prebuildify-ä½¿ç”¨">prebuildify ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­-1">å®é™…ä¾‹å­</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#usage">Usage</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#node-api-version-matrix">Node-API version matrix</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#environment-life-cycle-apis">Environment life cycle APIs</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_1-åˆ›å»ºå’Œé”€æ¯ç¯å¢ƒ">1. åˆ›å»ºå’Œé”€æ¯ç¯å¢ƒ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-ç¯å¢ƒæ•°æ®ç®¡ç†">2. ç¯å¢ƒæ•°æ®ç®¡ç†</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ä¸¾ä¾‹">å®é™…åº”ç”¨ä¸¾ä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-set-instance-data">napi_set_instance_data</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-get-instance-data">napi_get_instance_data</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹">ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹ä»£ç ç‰‡æ®µ">ç¤ºä¾‹ä»£ç ç‰‡æ®µ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#basic-node-api-data-types">Basic Node-API data types</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-status">napi_status</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-1">å®é™…è¿ç”¨çš„ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-extended-error-info">napi_extended_error_info</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-extended-error-info-1">napi_extended_error_info</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-env">napi_env</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#node-api-nogc-env">node_api_nogc_env</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯-n-api">ä»€ä¹ˆæ˜¯ N-APIï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åƒåœ¾å›æ”¶å™¨-gc-æ˜¯ä»€ä¹ˆ">åƒåœ¾å›æ”¶å™¨ï¼ˆGCï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#node-api-nogc-env-çš„ä½œç”¨">node_api_nogc_env çš„ä½œç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-value">napi_value</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-value-1">napi_value</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-threadsafe-function">napi_threadsafe_function</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-threadsafe-function-ä½¿ç”¨åœºæ™¯å’Œä¾‹å­">napi_threadsafe_function ä½¿ç”¨åœºæ™¯å’Œä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-threadsafe-function-release-mode">napi_threadsafe_function_release_mode</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-threadsafe-function-call-mode">napi_threadsafe_function_call_mode</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-2">å®é™…è¿ç”¨çš„ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#node-api-memory-management-types">Node-API memory management types</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#node-api-callback-types">Node-API callback types</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹ç†è§£-napi-callback-info">ç¤ºä¾‹ç†è§£ napi_callback_info</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-2">å®é™…è¿ç”¨ä¾‹å­ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ¦‚å¿µ">æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨ä¾‹å­">ä½¿ç”¨ä¾‹å­</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#error-handling">Error handling</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#return-values">Return values</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹-1-åˆ›å»ºä¸€ä¸ªæ–°çš„-javascript-å­—ç¬¦ä¸²">ç¤ºä¾‹ 1ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å­—ç¬¦ä¸²</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹-2-ä»å‡½æ•°ä¸­è¿”å›æ•°å€¼">ç¤ºä¾‹ 2ï¼šä»å‡½æ•°ä¸­è¿”å›æ•°å€¼</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨-napi-get-last-error-info-çš„æ­¥éª¤">ä½¿ç”¨ napi_get_last_error_info çš„æ­¥éª¤ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-get-last-error-info-çš„å®é™…ä¾‹å­">napi_get_last_error_info çš„å®é™…ä¾‹å­ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#exceptions">Exceptions</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸">æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ•è·å¹¶å¤„ç†å¼‚å¸¸">æ•è·å¹¶å¤„ç†å¼‚å¸¸</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‡½æ•°ç­¾å">å‡½æ•°ç­¾åï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è¿”å›å€¼">è¿”å›å€¼ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-1">å®é™…è¿ç”¨ç¤ºä¾‹ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-is-error-1">napi_is_error</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­-3">å®é™…ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯-napi-create-error">ä»€ä¹ˆæ˜¯ napi_create_errorï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-create-error-å‡½æ•°å‚æ•°å’Œè¿”å›å€¼">napi_create_error å‡½æ•°å‚æ•°å’Œè¿”å›å€¼</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¦‚ä½•ä½¿ç”¨-napi-create-error">å¦‚ä½•ä½¿ç”¨ napi_create_error</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨-napi-create-type-error">ä½¿ç”¨ napi_create_type_error</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ€»ç»“-1">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¾‹å­-1-åˆ›å»ºä¸€ä¸ªç®€å•çš„-syntaxerror">ä¾‹å­ 1: åˆ›å»ºä¸€ä¸ªç®€å•çš„ SyntaxError</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¾‹å­-2-åœ¨æ£€æµ‹åˆ°æ— æ•ˆè¾“å…¥æ—¶ä½¿ç”¨-syntaxerror">ä¾‹å­ 2: åœ¨æ£€æµ‹åˆ°æ— æ•ˆè¾“å…¥æ—¶ä½¿ç”¨ SyntaxError</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#fatal-errors">Fatal errors</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#fatal-errors-1">Fatal errors</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#object-lifetime-management">Object lifetime management</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¼•ç”¨-reference">å¼•ç”¨ (Reference)</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­-4">å®é™…ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#making-handle-lifespan-shorter-than-that-of-the-native-method">Making handle lifespan shorter than that of the native method</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹">ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#references-to-values-with-a-lifespan-longer-than-that-of-the-native-method">References to values with a lifespan longer than that of the native method</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¼•ç”¨ä¸å¯¿å‘½">å¼•ç”¨ä¸å¯¿å‘½</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-2">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-3">å®é™…è¿ç”¨çš„ä¾‹å­ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨æ­¥éª¤">ä½¿ç”¨æ­¥éª¤</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‡½æ•°ç­¾å-2">å‡½æ•°ç­¾å</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‡½æ•°è¿”å›å€¼">å‡½æ•°è¿”å›å€¼</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹-1">ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ³¨æ„äº‹é¡¹-1">æ³¨æ„äº‹é¡¹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#cleanup-on-exit-of-the-current-node-js-environment">Cleanup on exit of the current Node.js environment</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#finalization-on-the-exit-of-the-node-js-environment">Finalization on the exit of the Node.js environment</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#module-registration">Module registration</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ­¥éª¤-1-åˆ›å»ºåŸç”Ÿæ¨¡å—æºæ–‡ä»¶">æ­¥éª¤ 1: åˆ›å»ºåŸç”Ÿæ¨¡å—æºæ–‡ä»¶</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ­¥éª¤-2-ç¼–è¯‘åŸç”Ÿæ¨¡å—">æ­¥éª¤ 2: ç¼–è¯‘åŸç”Ÿæ¨¡å—</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ­¥éª¤-3-åŠ è½½å’Œä½¿ç”¨æ¨¡å—">æ­¥éª¤ 3: åŠ è½½å’Œä½¿ç”¨æ¨¡å—</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-4">å®é™…è¿ç”¨çš„ä¾‹å­</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#working-with-javascript-values">Working with JavaScript values</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#enum-types">Enum types</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-valuetype-æšä¸¾">napi_valuetype æšä¸¾</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-5">å®é™…è¿ç”¨çš„ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#object-creation-functions">Object creation functions</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_1-åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºå¯¹è±¡">1. åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºå¯¹è±¡</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-åˆ›å»ºä¸€ä¸ªå…·æœ‰å±æ€§çš„å¯¹è±¡">2. åˆ›å»ºä¸€ä¸ªå…·æœ‰å±æ€§çš„å¯¹è±¡</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-åˆ›å»ºæ•°ç»„">3. åˆ›å»ºæ•°ç»„</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¾‹å­">ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å…³é”®æ¦‚å¿µ">å…³é”®æ¦‚å¿µï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#node-api-symbol-for-å‡½æ•°çš„ä½œç”¨å’Œè¿ç”¨">node_api_symbol_for å‡½æ•°çš„ä½œç”¨å’Œè¿ç”¨:</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨åœºæ™¯æ€»ç»“">ä½¿ç”¨åœºæ™¯æ€»ç»“ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#functions-to-convert-from-c-types-to-node-api">Functions to convert from C types to Node-API</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‡½æ•°ç­¾å-3">å‡½æ•°ç­¾å</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­-5">å®é™…ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‡½æ•°åŸå‹">å‡½æ•°åŸå‹ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­-6">å®é™…ä¾‹å­ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŠŸèƒ½">åŠŸèƒ½</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‚æ•°">å‚æ•°</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹-1">ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ³¨æ„äº‹é¡¹-2">æ³¨æ„äº‹é¡¹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è§£é‡Š-napi-create-string-utf8">è§£é‡Š napi_create_string_utf8</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‚æ•°-1">å‚æ•°</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è¿”å›å€¼-2">è¿”å›å€¼</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»£ç ç¤ºä¾‹">ä»£ç ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#functions-to-convert-from-node-api-to-c-types">Functions to convert from Node-API to C types</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹-1-è½¬æ¢æ•°å­—">ç¤ºä¾‹ 1ï¼šè½¬æ¢æ•°å­—</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹-2-è½¬æ¢å­—ç¬¦ä¸²">ç¤ºä¾‹ 2ï¼šè½¬æ¢å­—ç¬¦ä¸²</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹-3-è½¬æ¢å‡½æ•°-å›è°ƒ">ç¤ºä¾‹ 3ï¼šè½¬æ¢å‡½æ•°ï¼ˆå›è°ƒï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®æˆ˜ä¾‹å­">å®æˆ˜ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‡½æ•°å£°æ˜">å‡½æ•°å£°æ˜</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹-2">ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹-c-c-ä¾§">ç¤ºä¾‹ - C/C++ä¾§</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹-javascript-ä¾§">ç¤ºä¾‹ - JavaScript ä¾§</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹-é‡æ–°è·å–-c-c-æ•°æ®">ç¤ºä¾‹ - é‡æ–°è·å– C/C++æ•°æ®</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨åœºæ™¯-1">ä½¿ç”¨åœºæ™¯</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‡½æ•°åŸå‹-1">å‡½æ•°åŸå‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è¿”å›å€¼-3">è¿”å›å€¼</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®ä¾‹ä»£ç ">å®ä¾‹ä»£ç </a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#node-js-ä¸­çš„-napi-get-value-int64">Node.js ä¸­çš„ napi_get_value_int64</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-get-value-string-utf8-1">napi_get_value_string_utf8</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¾‹å­-1">ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#functions-to-get-global-instances">Functions to get global instances</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-get-global">napi_get_global</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-get-constructor">napi_get_constructor</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åº”ç”¨ä¾‹å­">åº”ç”¨ä¾‹å­</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#working-with-javascript-values-and-abstract-operations">Working with JavaScript values and abstract operations</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#javascript-å€¼-values">JavaScript å€¼ (Values)</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æŠ½è±¡æ“ä½œ-abstract-operations">æŠ½è±¡æ“ä½œ (Abstract Operations)</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-coerce-to-bool">napi_coerce_to_bool</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¦‚ä½•ç†è§£-bool">å¦‚ä½•ç†è§£ bool</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-coerce-to-bool-çš„ä½œç”¨">napi_coerce_to_bool çš„ä½œç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨-napi-coerce-to-bool">ä½¿ç”¨ napi_coerce_to_bool</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ç¤ºä¾‹-3">å®é™…è¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-coerce-to-number">napi_coerce_to_number</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-coerce-to-object">napi_coerce_to_object</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®ä¾‹-1-å°†æ•°å­—è½¬æ¢ä¸ºå¯¹è±¡">å®ä¾‹ 1ï¼šå°†æ•°å­—è½¬æ¢ä¸ºå¯¹è±¡</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®ä¾‹-2-å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡">å®ä¾‹ 2ï¼šå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-coerce-to-string">napi_coerce_to_string</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-typeof">napi_typeof</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-instanceof">napi_instanceof</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-is-array">napi_is_array</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨-napi-is-array-å‡½æ•°çš„æ­¥éª¤">ä½¿ç”¨ napi_is_array å‡½æ•°çš„æ­¥éª¤</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-6">å®é™…è¿ç”¨çš„ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-is-arraybuffer">napi_is_arraybuffer</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-is-buffer">napi_is_buffer</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-is-date">napi_is_date</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-is-error-2">napi_is_error</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‚æ•°è§£é‡Š">å‚æ•°è§£é‡Š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹-2">ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-is-typedarray">napi_is_typedarray</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-is-typedarray-1">napi_is_typedarray</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-is-dataview">napi_is_dataview</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-is-dataview-1">napi_is_dataview</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-strict-equals">napi_strict_equals</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-detach-arraybuffer">napi_detach_arraybuffer</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#arraybuffer-ç®€ä»‹">ArrayBuffer ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#n-api-ç®€ä»‹">N-API ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-detach-arraybuffer-1">napi_detach_arraybuffer</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­-7">å®é™…ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-is-detached-arraybuffer">napi_is_detached_arraybuffer</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-8">å®é™…è¿ç”¨çš„ä¾‹å­</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#working-with-javascript-properties">Working with JavaScript properties</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åˆ›å»ºå±æ€§">åˆ›å»ºå±æ€§</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è·å–å±æ€§å€¼">è·å–å±æ€§å€¼</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è®¾ç½®å±æ€§å€¼">è®¾ç½®å±æ€§å€¼</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ“ä½œå¯¹è±¡çš„å±æ€§">æ“ä½œå¯¹è±¡çš„å±æ€§</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#structures">Structures</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#functions">Functions</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_1-åˆ›å»ºåŸç”Ÿå¯¹è±¡">1. åˆ›å»ºåŸç”Ÿå¯¹è±¡</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-è°ƒç”¨-javascript-å‡½æ•°">2. è°ƒç”¨ JavaScript å‡½æ•°</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‡½æ•°ç­¾å-4">å‡½æ•°ç­¾å</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‚æ•°è§£é‡Š-1">å‚æ•°è§£é‡Š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ç¤ºä¾‹">å®é™…åº”ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-3">å®é™…è¿ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-delete-property-1">napi_delete_property</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨ä¾‹å­-4">å®é™…è¿ç”¨ä¾‹å­ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨åœºæ™¯è§£é‡Š">ä½¿ç”¨åœºæ™¯è§£é‡Šï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‡½æ•°ç­¾å-5">å‡½æ•°ç­¾åï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è¿”å›å€¼-7">è¿”å›å€¼ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­-8">å®é™…ä¾‹å­ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‡½æ•°ç­¾å-6">å‡½æ•°ç­¾å</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­-9">å®é™…ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‡½æ•°åŸå‹-2">å‡½æ•°åŸå‹ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è¿”å›å€¼-8">è¿”å›å€¼ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä½¿ç”¨ä¾‹å­">å®é™…ä½¿ç”¨ä¾‹å­ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‡½æ•°ç­¾å-7">å‡½æ•°ç­¾å</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è¿”å›å€¼-9">è¿”å›å€¼</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¸¾ä¾‹è¯´æ˜">ä¸¾ä¾‹è¯´æ˜</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#working-with-javascript-functions">Working with JavaScript functions</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è°ƒç”¨-javascript-å‡½æ•°">è°ƒç”¨ JavaScript å‡½æ•°ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åˆ›å»ºæ–°çš„-javascript-å‡½æ•°">åˆ›å»ºæ–°çš„ JavaScript å‡½æ•°ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¼ é€’å‚æ•°ç»™-javascript-å‡½æ•°">ä¼ é€’å‚æ•°ç»™ JavaScript å‡½æ•°ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-call-function">napi_call_function</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-create-function">napi_create_function</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-9">å®é™…è¿ç”¨çš„ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-get-cb-info">napi_get_cb_info</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-get-new-target">napi_get_new_target</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-new-instance">napi_new_instance</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-new-instance-1">napi_new_instance</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#object-wrap">Object wrap</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#object-wrap-çš„åŸºæœ¬åŸç†">Object Wrap çš„åŸºæœ¬åŸç†ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¸¾ä¾‹è¯´æ˜-1">ä¸¾ä¾‹è¯´æ˜ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-define-class">napi_define_class</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-wrap">napi_wrap</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‡½æ•°åŸå‹-3">å‡½æ•°åŸå‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨åœºæ™¯-2">ä½¿ç”¨åœºæ™¯</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-unwrap">napi_unwrap</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-remove-wrap">napi_remove_wrap</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¾‹å­-3">ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-type-tag-object">napi_type_tag_object</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-check-object-type-tag">napi_check_object_type_tag</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‡½æ•°åŸå‹-4">å‡½æ•°åŸå‹ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨åœºæ™¯-3">ä½¿ç”¨åœºæ™¯ï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-add-finalizer">napi_add_finalizer</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½œç”¨">ä½œç”¨:</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨åœºæ™¯ç¤ºä¾‹">ä½¿ç”¨åœºæ™¯ç¤ºä¾‹:</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ³¨æ„äº‹é¡¹-3">æ³¨æ„äº‹é¡¹:</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#simple-asynchronous-operations">Simple asynchronous operations</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-create-async-work">napi_create_async_work</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¦‚ä½•ä½¿ç”¨-napi-create-async-work">å¦‚ä½•ä½¿ç”¨ napi_create_async_work</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-delete-async-work">napi_delete_async_work</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-queue-async-work">napi_queue_async_work</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-cancel-async-work">napi_cancel_async_work</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#custom-asynchronous-operations">Custom asynchronous operations</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ä¾‹å­-1">å®é™…åº”ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-async-init">napi_async_init</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-async-init-1">napi_async_init</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨åœºæ™¯å’Œä¾‹å­">ä½¿ç”¨åœºæ™¯å’Œä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-async-destroy">napi_async_destroy</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-async-destroy-çš„ä½œç”¨">napi_async_destroy çš„ä½œç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹-3">ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-make-callback">napi_make_callback</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-open-callback-scope">napi_open_callback_scope</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-close-callback-scope">napi_close_callback_scope</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#version-management">Version management</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-get-node-version">napi_get_node_version</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-get-version">napi_get_version</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#memory-management">Memory management</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_1-buffer-å’Œ-typedarray">1. Buffer å’Œ TypedArray</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-åƒåœ¾å›æ”¶-garbage-collection">2. åƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼‰</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-n-api-ä¸­çš„å†…å­˜ç®¡ç†å‡½æ•°">3. N-API ä¸­çš„å†…å­˜ç®¡ç†å‡½æ•°</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨çš„ä¾‹å­-åˆ›å»ºä¸€ä¸ªå¤–éƒ¨-buffer">å®é™…åº”ç”¨çš„ä¾‹å­ - åˆ›å»ºä¸€ä¸ªå¤–éƒ¨ Buffer</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-adjust-external-memory">napi_adjust_external_memory</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#promises">Promises</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¾‹å­-1-è¯»å–æ–‡ä»¶">ä¾‹å­ 1ï¼šè¯»å–æ–‡ä»¶</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¾‹å­-2-ç½‘ç»œè¯·æ±‚">ä¾‹å­ 2ï¼šç½‘ç»œè¯·æ±‚</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¾‹å­-3-é“¾å¼æ“ä½œ">ä¾‹å­ 3ï¼šé“¾å¼æ“ä½œ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-create-promise">napi_create_promise</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-resolve-deferred">napi_resolve_deferred</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-reject-deferred">napi_reject_deferred</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®è·µç¤ºä¾‹">å®è·µç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-is-promise">napi_is_promise</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#script-execution">Script execution</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹-1-æ‰§è¡Œç®€å•è„šæœ¬">ç¤ºä¾‹ 1: æ‰§è¡Œç®€å•è„šæœ¬</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹-2-ä½¿ç”¨-n-api-æ‰§è¡Œè„šæœ¬">ç¤ºä¾‹ 2: ä½¿ç”¨ N-API æ‰§è¡Œè„šæœ¬</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-run-script">napi_run_script</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‡½æ•°åŸå‹-5">å‡½æ•°åŸå‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¦‚ä½•ä½¿ç”¨">å¦‚ä½•ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­-10">å®é™…ä¾‹å­</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#libuv-event-loop">libuv event loop</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¾‹å­-1-æ–‡ä»¶è¯»å–">ä¾‹å­ 1ï¼šæ–‡ä»¶è¯»å–</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¾‹å­-2-ç½‘ç»œè¯·æ±‚-1">ä¾‹å­ 2ï¼šç½‘ç»œè¯·æ±‚</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¾‹å­-3-å®æ—¶èŠå¤©åº”ç”¨">ä¾‹å­ 3ï¼šå®æ—¶èŠå¤©åº”ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-get-uv-event-loop">napi_get_uv_event_loop</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç”¨é€”">ç”¨é€”</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¤ºä¾‹-3">ç¤ºä¾‹</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#asynchronous-thread-safe-function-calls">Asynchronous thread-safe function calls</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#thread-safe-function">Thread-safe function</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ä¾‹å­-2">å®é™…åº”ç”¨ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#calling-a-thread-safe-function">Calling a thread-safe function</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#reference-counting-of-thread-safe-functions">Reference counting of thread-safe functions</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#reference-counting-of-thread-safe-functions-1">Reference Counting of Thread-Safe Functions</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#deciding-whether-to-keep-the-process-running">Deciding whether to keep the process running</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¾‹å­-1-å¯åŠ¨åå°ä»»åŠ¡">ä¾‹å­ 1ï¼šå¯åŠ¨åå°ä»»åŠ¡</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¾‹å­-2-åœæ­¢åå°ä»»åŠ¡">ä¾‹å­ 2ï¼šåœæ­¢åå°ä»»åŠ¡</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-create-threadsafe-function">napi_create_threadsafe_function</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å·¥ä½œæœºåˆ¶">å·¥ä½œæœºåˆ¶</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…ä¾‹å­-11">å®é™…ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-get-threadsafe-function-context">napi_get_threadsafe_function_context</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-call-threadsafe-function">napi_call_threadsafe_function</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-acquire-threadsafe-function">napi_acquire_threadsafe_function</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è§£é‡Š">è§£é‡Š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨æ­¥éª¤-1">ä½¿ç”¨æ­¥éª¤</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-10">å®é™…è¿ç”¨çš„ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-release-threadsafe-function">napi_release_threadsafe_function</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-ref-threadsafe-function">napi_ref_threadsafe_function</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯-threadsafe-function">ä»€ä¹ˆæ˜¯ Threadsafe Functionï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-ref-threadsafe-function-åŠŸèƒ½">napi_ref_threadsafe_function åŠŸèƒ½</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¸ºä»€ä¹ˆéœ€è¦å¼•ç”¨-threadsafe-function">ä¸ºä»€ä¹ˆéœ€è¦å¼•ç”¨ threadsafe functionï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…è¿ç”¨çš„ä¾‹å­-11">å®é™…è¿ç”¨çš„ä¾‹å­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#napi-unref-threadsafe-function">napi_unref_threadsafe_function</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#miscellaneous-utilities">Miscellaneous utilities</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#node-api-get-module-file-name">node_api_get_module_file_name</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»€ä¹ˆæ˜¯-node-api-get-module-file-name">ä»€ä¹ˆæ˜¯ node_api_get_module_file_name?</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¦‚ä½•ä½¿ç”¨å®ƒ">å¦‚ä½•ä½¿ç”¨å®ƒï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®é™…åº”ç”¨ä¾‹å­-4">å®é™…åº”ç”¨ä¾‹å­</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h1 id="node-api" tabindex="-1"><a class="header-anchor" href="#node-api"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#node-api" target="_blank" rel="noopener noreferrer">Node-API</a></span></a></h1><p>Node-APIï¼ˆä»¥å‰ç§°ä¸º N-APIï¼‰æ˜¯ Node.js æä¾›çš„ä¸€ä¸ª API å±‚ï¼Œå®ƒå…è®¸ä½ ç”¨ C æˆ– C++ç¼–å†™æ’ä»¶ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨ Node-APIï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒæä¾›äº†ä¸€ç§ä¸åº•å±‚ JavaScript å¼•æ“ï¼ˆå¦‚ V8ï¼‰è§£è€¦çš„æ–¹å¼æ¥æ„å»ºåŸç”Ÿæ‰©å±•ã€‚è¿™æ„å‘³ç€å½“ Node.js æ›´æ–°å…¶å†…éƒ¨å¼•æ“æ—¶ï¼Œä½¿ç”¨ Node-API æ„å»ºçš„æ’ä»¶ä¸éœ€è¦é‡å†™æ¥é€‚åº”æ–°ç‰ˆæœ¬ï¼Œä»è€Œå¢åŠ äº†æ‰©å±•çš„ç¨³å®šæ€§å’Œå…¼å®¹æ€§ã€‚</p><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒNode-API å¯ä»¥ç”¨äºå¤šç§æƒ…å†µï¼Œæ¯”å¦‚ï¼š</p><ol><li><p><strong>æ€§èƒ½å¯†é›†å‹ä»»åŠ¡</strong>ï¼šå¦‚æœä½ çš„ Node.js åº”ç”¨éœ€è¦å¤„ç†å¤§é‡è®¡ç®—ï¼Œå¯èƒ½ä¼šç”±äº JavaScript çš„æ€§èƒ½é™åˆ¶è€Œå˜æ…¢ã€‚é€šè¿‡ Node-APIï¼Œä½ å¯ä»¥ç”¨ C æˆ– C++ç¼–å†™è¿™äº›è®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡ï¼Œç„¶ååœ¨ Node.js ä¸­è°ƒç”¨ï¼Œåˆ©ç”¨ C/C++çš„é«˜æ•ˆç‡æ¥æå‡æ•´ä½“æ€§èƒ½ã€‚</p></li><li><p><strong>ä½¿ç”¨ç°æœ‰çš„ C/C++åº“</strong>ï¼šå¦‚æœæœ‰ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ C/C++åº“å¹¶ä¸”ä½ å¸Œæœ›åœ¨ä½ çš„ Node.js åº”ç”¨ä¸­ä½¿ç”¨å®ƒï¼Œé‚£ä¹ˆä½ å¯ä»¥é€šè¿‡ Node-API åˆ›å»ºä¸€ä¸ªç»‘å®š(binding)ï¼Œè®© JavaScript ä»£ç èƒ½å¤Ÿè°ƒç”¨è¿™ä¸ªåº“ã€‚</p></li><li><p><strong>ç³»ç»Ÿçº§æ“ä½œ</strong>ï¼šå½“éœ€è¦è¿›è¡Œåº•å±‚æ“ä½œç³»ç»Ÿäº¤äº’ï¼ˆå¦‚ç›´æ¥ä¸ç¡¬ä»¶é€šä¿¡ï¼‰æ—¶ï¼ŒNode-API å¯ä»¥ä½¿å¾— Node.js æ‹¥æœ‰è°ƒç”¨ç³»ç»Ÿ API çš„èƒ½åŠ›ã€‚</p></li></ol><p>ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª C++å‡½æ•°ç”¨æ¥è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—çš„ç¬¬ N é¡¹ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ª CPU å¯†é›†å‹ä»»åŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬æœŸæœ›åœ¨é€Ÿåº¦ä¸Šæœ‰æ‰€æå‡ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// fibonacci.cpp</span></span>
<span class="line"><span>##include `&lt;`napi.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>int Fibonacci(int n) {</span></span>
<span class="line"><span>  if (n `&lt;`= 1) {</span></span>
<span class="line"><span>    return n;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  return Fibonacci(n - 1) + Fibonacci(n - 2);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Napi::Number FibonacciWrapped(const Napi::CallbackInfo&amp; info) {</span></span>
<span class="line"><span>  Napi::Env env = info.Env();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (info.Length() `&lt;` 1 || !info[0].IsNumber()) {</span></span>
<span class="line"><span>    Napi::TypeError::New(env, &quot;Number expected&quot;).ThrowAsJavaScriptException();</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  Napi::Number first = info[0].As`&lt;`Napi::Number&gt;();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  int result = Fibonacci(first.Int32Value());</span></span>
<span class="line"><span>  return Napi::Number::New(env, result);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Napi::Object Init(Napi::Env env, Napi::Object exports) {</span></span>
<span class="line"><span>  exports.Set(</span></span>
<span class="line"><span>    Napi::String::New(env, &quot;fibonacci&quot;),</span></span>
<span class="line"><span>    Napi::Function::New(env, FibonacciWrapped)</span></span>
<span class="line"><span>  );</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NODE_API_MODULE(fibonacci, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç é¦–å…ˆåŒ…æ‹¬äº† Node-API å¿…éœ€çš„å¤´æ–‡ä»¶ï¼Œç„¶åå®šä¹‰äº†ä¸€ä¸ª <code>Fibonacci</code> å‡½æ•°ç”¨æ¥é€’å½’è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—ã€‚æˆ‘ä»¬è¿˜å®šä¹‰äº†ä¸€ä¸ª <code>FibonacciWrapped</code> å‡½æ•°æ¥ä½œä¸º Node-API çš„æ¥å£ï¼Œå®ƒå°† JavaScript ä¼ å…¥çš„å‚æ•°è½¬åŒ–ä¸º C++ç±»å‹ï¼Œå¹¶è°ƒç”¨çº¯ C++çš„ <code>Fibonacci</code> å‡½æ•°ã€‚æœ€åï¼Œ<code>Init</code> å‡½æ•°æ³¨å†Œäº† <code>FibonacciWrapped</code> å‡½æ•°ï¼Œä½¿å…¶åœ¨ Node.js æ¨¡å—ä¸­ä»¥ <code>fibonacci</code> åç§°è¢«å¯¼å‡ºã€‚</p><p>å®‰è£…å®Œå¿…è¦çš„ Node.js å’Œ C++ æ„å»ºå·¥å…·åï¼Œä½ å¯ä»¥ç¼–è¯‘è¿™ä¸ªæ‰©å±•ç„¶ååœ¨ Node.js ä»£ç ä¸­è¿™æ ·ä½¿ç”¨å®ƒï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// index.js</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> addon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/fibonacci</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">addon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">fibonacci</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">10</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºæ–æ³¢é‚£å¥‘æ•°åˆ—çš„ç¬¬10é¡¹</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç®€å•çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° Node-API å¦‚ä½•è¿æ¥ Node.js å’Œ C++ä»£ç ï¼Œå…è®¸ JavaScript è°ƒç”¨åŸç”Ÿ C++å‡½æ•°ï¼Œä»¥æ­¤æ¥å®ç°æ›´ä¼˜çš„æ€§èƒ½ã€‚è¿™åªæ˜¯ Node-API åŠŸèƒ½çš„å†°å±±ä¸€è§’ï¼Œä½†å®ƒéå¸¸æ¸…æ¥šåœ°å±•ç¤ºäº† Node-API å¦‚ä½•è¢«ç”¨æ¥æå‡ Node.js åº”ç”¨çš„èƒ½åŠ›ã€‚</p><h2 id="implications-of-abi-stability" tabindex="-1"><a class="header-anchor" href="#implications-of-abi-stability"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#implications-of-abi-stability" target="_blank" rel="noopener noreferrer">Implications of ABI stability</a></span></a></h2><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 JavaScript å¼•æ“çš„ JavaScript è¿è¡Œæ—¶ç¯å¢ƒï¼Œå…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚åœ¨ Node.js ä¸­ï¼Œâ€œABIâ€æ˜¯â€œåº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ¥å£â€çš„ç¼©å†™ï¼Œå®ƒå®šä¹‰äº†åº”ç”¨ç¨‹åºï¼ˆè¿™é‡ŒæŒ‡ Node.js çš„æ¨¡å—æˆ–æ’ä»¶ï¼‰ä¸æ“ä½œç³»ç»Ÿä¹‹é—´æˆ–ä¸åŒåº”ç”¨ç¨‹åºç»„ä»¶ä¹‹é—´å¦‚ä½•ç›¸äº’äº¤äº’çš„è¯¦ç»†è§„èŒƒã€‚</p><p>å½“æˆ‘ä»¬è°ˆè®ºåˆ° ABI ç¨³å®šæ€§æ—¶ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨çš„æ˜¯ç¼–è¯‘è¿‡çš„ Node.js æ¨¡å—ï¼ˆé€šå¸¸ä½¿ç”¨ C æˆ– C++ ç¼–å†™çš„æ‰©å±•ï¼‰æ˜¯å¦å¯ä»¥åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸­æ— éœ€é‡æ–°ç¼–è¯‘è€Œç›´æ¥ä½¿ç”¨ã€‚è¿™æ„å‘³ç€ä¸€ä¸ªæ¨¡å—çš„äºŒè¿›åˆ¶ç‰ˆæœ¬å¯ä»¥é€‚é…å¤šä¸ªç‰ˆæœ¬çš„ Node.jsï¼Œè¿™å¯¹äºå¼€å‘è€…æ¥è¯´éå¸¸æ–¹ä¾¿ï¼Œå› ä¸ºæ¨¡å—çš„å…¼å®¹æ€§å¾—åˆ°äº†å¢å¼ºã€‚</p><h3 id="abi-ç¨³å®šæ€§çš„å½±å“" tabindex="-1"><a class="header-anchor" href="#abi-ç¨³å®šæ€§çš„å½±å“"><span>ABI ç¨³å®šæ€§çš„å½±å“</span></a></h3><p><strong>1. æ¨¡å—å¼€å‘è€…ï¼š</strong><br> å¦‚æœ ABI æ˜¯ç¨³å®šçš„ï¼Œåˆ™æ¨¡å—å¼€å‘è€…ä¸éœ€è¦ä¸ºæ¯ä¸ªæ–°ç‰ˆæœ¬çš„ Node.js é‡æ–°ç¼–è¯‘ä»–ä»¬çš„æ¨¡å—ã€‚è¿™å‡å°‘äº†ç»´æŠ¤å·¥ä½œé‡ï¼Œå¹¶ä½¿å¾—æ¨¡å—æ›´å®¹æ˜“è¢«å¹¿æ³›ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªç”¨äºå›¾åƒå¤„ç†çš„ Node.js æ¨¡å—ï¼Œå¹¶ä¸”è¯¥æ¨¡å—é‡‡ç”¨ C++ ç¼–å†™ï¼Œé‚£ä¹ˆä½ çš„ç”¨æˆ·å°±å¯ä»¥åœ¨å¤šä¸ª Node.js ç‰ˆæœ¬ä¸­ä½¿ç”¨è¿™ä¸ªæ¨¡å—ï¼Œè€Œä¸éœ€è¦ç­‰å¾…ä½ å‘å¸ƒç‰¹å®šäºæ¯ä¸ªç‰ˆæœ¬çš„é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><p><strong>2. åº”ç”¨å¼€å‘è€…ï¼š</strong><br> åº”ç”¨å¼€å‘è€…å¯ä»¥æ›´æœ‰ä¿¡å¿ƒåœ°å‡çº§ä»–ä»¬çš„ Node.js è¿è¡Œæ—¶ï¼Œå› ä¸ºä»–ä»¬çŸ¥é“ä¾èµ–çš„æ¨¡å—å¾ˆå¯èƒ½ä»ç„¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚åœ¨å®è·µä¸­ï¼Œè¿™æ„å‘³ç€å¦‚æœä½ çš„é¡¹ç›®ä½¿ç”¨äº†æŸäº›ä¾èµ–åº“ï¼Œæ¯”å¦‚ç”¨äºæ•°æ®åº“è¿æ¥çš„ <code>node-oracledb</code>ï¼Œå³ä½¿åœ¨ Node.js æ›´æ–°åï¼Œé€šå¸¸ä¹Ÿæ— éœ€æ›´æ”¹ä»»ä½•ä»£ç æˆ–ç­‰å¾…åº“çš„æ›´æ–°ã€‚</p><p><strong>3. Node.js ç¤¾åŒºï¼š</strong><br> æ•´ä¸ª Node.js ç”Ÿæ€ç³»ç»Ÿå—ç›Šäº ABI ç¨³å®šæ€§ï¼Œå› ä¸ºå®ƒé™ä½äº†å„ç§ç‰ˆæœ¬é—´çš„å…¼å®¹æ€§é—®é¢˜ï¼Œä¿ƒè¿›äº†æ¨¡å—å…±äº«å’Œå¤ç”¨ã€‚</p><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­"><span>å®é™…è¿ç”¨çš„ä¾‹å­ï¼š</span></a></h3><ul><li><p><strong>åŸç”Ÿæ¨¡å—å…¼å®¹æ€§ï¼š</strong> å¦‚æœä½ å®‰è£…äº†ä¸€ä¸ªç”¨äºæ€§èƒ½ç›‘æ§çš„åŸç”Ÿ Node.js æ¨¡å—ï¼Œæ¯”å¦‚ <code>v8-profiler</code>ï¼Œå¹¶ä¸” Node.js æœ‰ä¸€ä¸ªæ–°ç‰ˆæœ¬å‘å¸ƒäº†ã€‚ç”±äº ABI ç¨³å®šæ€§ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ç›´æ¥åœ¨æ–°ç‰ˆæœ¬çš„ Node.js ä¸Šè¿è¡Œä½ çš„åº”ç”¨ç¨‹åºï¼Œè€Œä¸å¿…æ‹…å¿ƒ <code>v8-profiler</code> æ¨¡å—ä¼šå› ä¸ºæ–°ç‰ˆæœ¬è€Œä¸å…¼å®¹ã€‚</p></li><li><p><strong>å‡çº§ Node.js ç‰ˆæœ¬ï¼š</strong> å½“å›¢é˜Ÿå†³å®šå°†é¡¹ç›®ä» Node.js v20 å‡çº§åˆ° Node.js v21 æ—¶ï¼Œä»–ä»¬æ£€æŸ¥äº†æ‰€æœ‰ä¾èµ–é¡¹ä»¥ç¡®ä¿å…¼å®¹æ€§ã€‚å¦‚æœæ‰€æœ‰å…³é”®æ¨¡å—éƒ½æ”¯æŒè·¨ç‰ˆæœ¬çš„ ABI ç¨³å®šæ€§ï¼Œè¿™ä¸ªå‡çº§è¿‡ç¨‹ä¼šå˜å¾—ç®€å•å¿«æ·ï¼Œå› ä¸ºå›¢é˜Ÿä¸å¿…æ‹…å¿ƒè¿™äº›æ¨¡å—éœ€è¦é‡æ–°ç¼–è¯‘ã€‚</p></li><li><p><strong>è·¨å¹³å°æ¨¡å—ï¼š</strong> å¼€å‘è€…å¯èƒ½åˆ›å»ºäº†ä¸€ä¸ªç”¨äºè¯»å–ç³»ç»Ÿä¿¡æ¯çš„æ¨¡å—ï¼Œå¹¶ä¸”å¸Œæœ›å®ƒèƒ½åœ¨ Windowsã€macOS å’Œ Linux ä¸Šè¿è¡Œã€‚å¦‚æœè¿™ä¸ªæ¨¡å—éµå¾ª ABI ç¨³å®šæ€§çš„æ ‡å‡†ï¼Œå®ƒå°†èƒ½å¤Ÿåœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šï¼Œä»¥åŠåœ¨æ¯ä¸ªæ“ä½œç³»ç»Ÿä¸Šçš„ä¸åŒ Node.js ç‰ˆæœ¬ä¸­è¿è¡Œï¼Œè€Œæ— éœ€è¿›è¡Œä»»ä½•ç‰¹åˆ«çš„é€‚é…å·¥ä½œã€‚</p></li></ul><p>æ€»ç»“æ¥è¯´ï¼ŒABI ç¨³å®šæ€§åœ¨ Node.js ä¸­æ˜¯ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œå®ƒæå¤§åœ°æé«˜äº†æ¨¡å—è·¨ç‰ˆæœ¬å’Œè·¨å¹³å°çš„å…¼å®¹æ€§ï¼Œå¯¹äºå¼€å‘è€…å’Œæœ€ç»ˆç”¨æˆ·è€Œè¨€éƒ½æ˜¯ä¸€ä¸ªå·¨å¤§çš„åˆ©å¥½ã€‚</p><h2 id="building" tabindex="-1"><a class="header-anchor" href="#building"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#building" target="_blank" rel="noopener noreferrer">Building</a></span></a></h2><p>Node.js æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶ç¯å¢ƒï¼Œå®ƒèƒ½è®©ä½ ä½¿ç”¨ JavaScript æ¥ç¼–å†™æœåŠ¡å™¨ç«¯çš„åº”ç”¨ã€‚å…¶ä¸­ä¸€ä¸ªç‰¹æ€§æ˜¯ N-APIï¼Œè¿™æ˜¯ä¸€ä¸ªæ„å»ºåŸç”Ÿæ¨¡å—çš„ APIã€‚åœ¨ Node.js ä¸­ï¼ŒåŸç”Ÿæ¨¡å—é€šå¸¸æ˜¯ç”¨ C æˆ–è€… C++ å†™çš„æ’ä»¶ï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥å’Œæ“ä½œç³»ç»Ÿå±‚è¿›è¡Œäº¤äº’ã€‚</p><p>åœ¨ Node.js v21.7.1 çš„æ–‡æ¡£ä¸­ï¼Œâ€œBuildingâ€è¿™ä¸€éƒ¨åˆ†ä¸“é—¨ä»‹ç»äº†å¦‚ä½•æ„å»ºä¸€ä¸ªä½¿ç”¨ N-API çš„åŸç”Ÿæ¨¡å—ã€‚ä»¥ä¸‹æ˜¯è¿™ä¸€è¿‡ç¨‹çš„ç®€å•è§£é‡Šå’Œå®ä¾‹ï¼š</p><h3 id="æ„å»ºåŸç”Ÿæ¨¡å—çš„æ­¥éª¤" tabindex="-1"><a class="header-anchor" href="#æ„å»ºåŸç”Ÿæ¨¡å—çš„æ­¥éª¤"><span>æ„å»ºåŸç”Ÿæ¨¡å—çš„æ­¥éª¤</span></a></h3><ol><li><p><strong>é…ç½® <code>binding.gyp</code> æ–‡ä»¶</strong>ï¼š<br> ä¸ºäº†æ„å»ºåŸç”Ÿæ¨¡å—ï¼Œé¦–å…ˆä½ éœ€è¦åˆ›å»ºä¸€ä¸ªå«åš <code>binding.gyp</code> çš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶åŒ…å«äº†æè¿°æ¨¡å—å¦‚ä½•è¢«æ„å»ºçš„é…ç½®ä¿¡æ¯ã€‚è¿™ä¸ªæ–‡ä»¶çš„æ ¼å¼åŸºäº Python çš„ GYPï¼ˆGenerate Your Projectsï¼‰å·¥å…·ï¼Œå³ä½¿ä½ ä¸ç†Ÿæ‚‰ Python ä¹Ÿæ²¡å…³ç³»ï¼Œå› ä¸ºæ ¼å¼ç›¸å¯¹ç›´è§‚ã€‚</p></li><li><p><strong>ç¼–å†™ C/C++ ä»£ç </strong>ï¼š<br> æ¥ä¸‹æ¥ï¼Œä½ å°†ç¼–å†™å®é™…çš„ C æˆ– C++ ä»£ç ã€‚è¿™äº›ä»£ç ä¼šä½¿ç”¨ N-API æä¾›çš„å‡½æ•°æ¥ä¸ JavaScript å±‚çš„ä»£ç è¿›è¡Œäº¤äº’ã€‚</p></li><li><p><strong>ç¼–è¯‘å’Œé“¾æ¥</strong>ï¼š<br> å½“ä½ æœ‰äº† <code>binding.gyp</code> å’Œ C/C++ æºç æ–‡ä»¶åï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>node-gyp</code> å‘½ä»¤è¡Œå·¥å…·æ¥ç¼–è¯‘ä½ çš„åŸç”Ÿæ¨¡å—ã€‚<code>node-gyp</code> ä¼šè¯»å– <code>binding.gyp</code> æ–‡ä»¶ï¼Œæ‰§è¡Œå¿…è¦çš„ç¼–è¯‘å’Œé“¾æ¥æ­¥éª¤ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p></li></ol><h3 id="å®é™…ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­"><span>å®é™…ä¾‹å­</span></a></h3><ol><li><p><strong>åˆ›å»º <code>binding.gyp</code> æ–‡ä»¶</strong>ï¼š<br> å‡è®¾æˆ‘ä»¬æ­£åœ¨åˆ›å»ºä¸€ä¸ªå«åš &quot;awesome&quot; çš„åŸç”Ÿæ¨¡å—ï¼Œä½ å¯èƒ½ä¼šæœ‰ä¸€ä¸ªåƒè¿™æ ·çš„ <code>binding.gyp</code> æ–‡ä»¶ï¼š</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">targets</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">target_name</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">awesome</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">sources</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">src/awesome.cc</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">],</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">include_dirs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#A3BE8C;">`&lt;`!@(node -p </span><span style="color:#EBCB8B;">\&quot;</span><span style="color:#A3BE8C;">require(&#39;node-addon-api&#39;).include</span><span style="color:#EBCB8B;">\&quot;</span><span style="color:#A3BE8C;">)</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">      ],</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">dependencies</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">`&lt;`!(node -p </span><span style="color:#EBCB8B;">\&quot;</span><span style="color:#A3BE8C;">require(&#39;node-addon-api&#39;).gyp</span><span style="color:#EBCB8B;">\&quot;</span><span style="color:#A3BE8C;">)</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">],</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">defines</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">NAPI_DISABLE_CPP_EXCEPTIONS</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">]</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  ]</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡ŒæŒ‡å®šäº†ç¼–è¯‘ç›®æ ‡ã€æºæ–‡ä»¶ã€åŒ…å«ç›®å½•ã€ä¾èµ–å…³ç³»åŠå®å®šä¹‰ã€‚</p></li><li><p><strong>ç¼–å†™ <code>awesome.cc</code> æºæ–‡ä»¶</strong>ï¼š<br> åœ¨ C++æºæ–‡ä»¶ä¸­ï¼Œä½ ä¼šä½¿ç”¨ N-API å®šä¹‰çš„å‡½æ•°å’Œå®ã€‚æ¯”å¦‚ï¼Œä½ å¯èƒ½ä¼šå†™ä¸€ä¸ªç®€å•çš„å‡½æ•°æ¥è¿”å›å­—ç¬¦ä¸² &quot;hello world&quot;:</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`napi.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Napi::String HelloMethod(const Napi::CallbackInfo&amp; info) {</span></span>
<span class="line"><span>  Napi::Env env = info.Env();</span></span>
<span class="line"><span>  return Napi::String::New(env, &quot;hello world&quot;);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Napi::Object Init(Napi::Env env, Napi::Object exports) {</span></span>
<span class="line"><span>  exports.Set(&quot;hello&quot;, Napi::Function::New(env, HelloMethod));</span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NODE_API_MODULE(awesome, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªåä¸º <code>HelloMethod</code> çš„å‡½æ•°ï¼Œå¹¶åœ¨æ¨¡å—åˆå§‹åŒ–æ—¶æŠŠå®ƒæš´éœ²å‡ºæ¥ã€‚</p></li><li><p><strong>ç¼–è¯‘æ¨¡å—</strong>ï¼š<br> æœ€åï¼Œä½ éœ€è¦åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œ <code>node-gyp configure</code> å’Œ <code>node-gyp build</code>ã€‚è¿™äº›å‘½ä»¤ä¼šåˆ†åˆ«é…ç½®å’Œç¼–è¯‘ä½ çš„æ¨¡å—ã€‚</p></li></ol><p>ç»è¿‡ä¸Šè¿°æ­¥éª¤ï¼Œä½ å°±æˆåŠŸæ„å»ºäº†ä¸€ä¸ªåŸç”Ÿæ¨¡å—ã€‚ç„¶åä½ å¯ä»¥é€šè¿‡ <code>require</code> åœ¨ä½ çš„ Node.js ä»£ç ä¸­è½½å…¥å¹¶ä½¿ç”¨è¿™ä¸ªæ¨¡å—ã€‚ä¾‹å¦‚ï¼Œåœ¨ JavaScript ä¸­ï¼Œä½ å¯ä»¥è¿™æ ·ä½¿ç”¨åˆšæ‰æ„å»ºçš„ &quot;awesome&quot; æ¨¡å—:</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> awesomeModule</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/awesome</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">awesomeModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">hello</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: hello world</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>å¸Œæœ›ä»¥ä¸Šè§£é‡Šæ¸…æ¥šäº† Node.js ä¸­æ„å»ºåŸç”Ÿæ¨¡å—çš„è¿‡ç¨‹å’Œä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚å¦‚æœä½ æƒ³æ·±å…¥å­¦ä¹ ï¼Œå»ºè®®é˜…è¯»å®˜æ–¹æ–‡æ¡£ä»¥åŠæ¶‰åŠ <code>node-gyp</code> å’Œ N-API çš„ç›¸å…³èµ„æ–™ã€‚</p><h3 id="build-tools" tabindex="-1"><a class="header-anchor" href="#build-tools"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#build-tools" target="_blank" rel="noopener noreferrer">Build tools</a></span></a></h3><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 JavaScript å¼•æ“çš„ JavaScript è¿è¡Œæ—¶ç¯å¢ƒï¼Œä½¿å¾—ä½ å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScriptã€‚è¿™é‡Œæˆ‘ä»¬èšç„¦äº Node.js ä¸­çš„ä¸€ä¸ªç‰¹å®šåŠŸèƒ½ï¼šN-APIã€‚</p><p>N-API æ˜¯ Node.js æä¾›çš„ä¸€ç»„ C APIï¼Œå®ƒæ˜¯ç”¨æ¥æ„å»ºåŸç”Ÿæ’ä»¶çš„ã€‚æ‰€è°“çš„åŸç”Ÿæ’ä»¶ï¼Œå°±æ˜¯ä½¿ç”¨åƒ C æˆ– C++è¿™æ ·çš„ç³»ç»Ÿç¼–ç¨‹è¯­è¨€ç¼–å†™çš„æ¨¡å—ï¼Œè¿™äº›æ¨¡å—å¯ä»¥ç›´æ¥å’Œ Node.js äºŒè¿›åˆ¶æ¥å£äº¤äº’ï¼Œæ— éœ€é€šè¿‡ JavaScriptã€‚åŸç”Ÿæ’ä»¶é€šå¸¸ç”¨äºæ€§èƒ½æ•æ„Ÿçš„æ“ä½œæˆ–è€…è°ƒç”¨å·²æœ‰çš„ç³»çµ±çº§åˆ«åº“ã€‚</p><p>æƒ³è¦æ„å»ºè¿™äº›åŸç”Ÿæ’ä»¶ï¼Œä½ éœ€è¦ä¸€äº›æ„å»ºå·¥å…·ã€‚è€Œåœ¨ Node.js v21.7.1 çš„ä¸Šä¸‹æ–‡ä¸­æåˆ°çš„ &quot;Build tools&quot; å¾ˆå¯èƒ½æ˜¯æŒ‡é‚£äº›ç”¨æ¥ç¼–è¯‘å’Œé“¾æ¥åŸç”Ÿæ¨¡å—çš„å·¥å…·ï¼Œæ¯”å¦‚ node-gypã€cmake-js ç­‰ã€‚</p><p><strong>node-gyp</strong> æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒä½¿ç”¨ Python å’Œ GYPï¼ˆGenerate Your Projectsï¼‰æ¥ä¸º Node.js åŸç”Ÿæ’ä»¶ç”Ÿæˆå¿…è¦çš„é¡¹ç›®æ„å»ºæ–‡ä»¶ï¼Œé€‚ç”¨äºå¤šç§ç³»ç»Ÿã€‚</p><p>ä¾‹å¦‚ï¼Œå¦‚æœä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªåŸç”Ÿæ’ä»¶æ¥åŠ é€Ÿå›¾åƒå¤„ç†ï¼Œä½ ä¼šç¼–å†™ä¸€äº› C++ ä»£ç æ¥å¤„ç†å›¾åƒæ•°æ®ï¼Œç„¶åä½¿ç”¨ node-gyp æ¥ç¼–è¯‘è¿™æ®µä»£ç ï¼Œä½¿å…¶å˜æˆ Node.js å¯ä»¥åŠ è½½å¹¶ä½¿ç”¨çš„æœ¬åœ°æ¨¡å—ã€‚</p><p>å®‰è£… node-gyp çš„æ­¥éª¤å¤§è‡´å¦‚ä¸‹ï¼š</p><ol><li>å®‰è£… Node.jsï¼Œå®ƒè‡ªå¸¦ npmï¼ˆnode package managerï¼‰ï¼Œnpm ç”¨æ¥ç®¡ç† Node.js æ¨¡å—ã€‚</li><li>ä½¿ç”¨ npm å…¨å±€å®‰è£… node-gypï¼š<code>npm install -g node-gyp</code></li><li>ä½ éœ€è¦ç¡®ä¿ä½ çš„ç”µè„‘ä¸Šå®‰è£…äº†æ‰€æœ‰å¿…è¦çš„æ„å»ºå·¥å…·å’Œé…ç½®ã€‚å¯¹äº Windows, ä½ å¯èƒ½éœ€è¦å®‰è£… windows-build-toolsï¼›å¯¹äº macOS æˆ– Linuxï¼Œä½ éœ€è¦å®‰è£… python å’Œ make å·¥å…·é“¾ç­‰ã€‚</li></ol><p>ä¸€ä¸ªç®€å•çš„ node-gyp é…ç½®ç¤ºä¾‹ï¼ˆbinding.gyp æ–‡ä»¶ï¼‰:</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">targets</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">target_name</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">myaddon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">sources</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">src/myaddon.cc</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">]</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  ]</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªé…ç½®å®šä¹‰äº†ä¸€ä¸ªç›®æ ‡ï¼ˆä½ çš„æ’ä»¶ï¼‰ï¼Œä»¥åŠæºä»£ç çš„ä½ç½®ã€‚å½“ä½ åœ¨ç»ˆç«¯æ‰§è¡Œ <code>node-gyp configure</code> å’Œ <code>node-gyp build</code> æ—¶ï¼Œnode-gyp å°†ä¼šè¯»å–è¿™ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”æ ¹æ®å½“å‰å¹³å°ç”Ÿæˆç›¸åº”çš„æ„å»ºæ–‡ä»¶ï¼Œç„¶åç¼–è¯‘æºä»£ç ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œå¯¹äº Node.js v21.7.1 ä¸­æåŠçš„ Build toolsï¼Œè¿™ä¸»è¦æŒ‡çš„æ˜¯ç”¨äºæ„å»º N-API åŸç”Ÿæ’ä»¶çš„å·¥å…·é›†ï¼Œå®ƒä»¬èƒ½å¤Ÿå¸®åŠ©å¼€å‘è€…ç¼–è¯‘å’Œé“¾æ¥ä»–ä»¬ç”¨ C/C++ ç¼–å†™çš„ä»£ç ï¼Œä½¿ä¹‹æˆä¸º Node.js å¯ä»¥åˆ©ç”¨çš„åŸç”Ÿæ‰©å±•ã€‚æœ€å¸¸è§çš„è¿™ç±»å·¥å…·å°±æ˜¯ node-gypã€‚</p><h4 id="node-gyp" tabindex="-1"><a class="header-anchor" href="#node-gyp"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#node-gyp" target="_blank" rel="noopener noreferrer">node-gyp</a></span></a></h4><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œå®ƒè®©å¼€å‘è€…å¯ä»¥ä½¿ç”¨ JavaScript æ¥ç¼–å†™æœåŠ¡å™¨ç«¯çš„è½¯ä»¶ã€‚è€Œ <code>node-gyp</code> å¹¶ä¸æ˜¯ Node.js æ ¸å¿ƒåŠŸèƒ½çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„å·¥å…·ï¼Œç”¨æ¥ç¼–è¯‘ Node.js çš„ C++ æ‰©å±•æ¨¡å—ã€‚</p><p>åœ¨ Node.js ä¸­ï¼Œå¤§å¤šæ•°æ¨¡å—éƒ½æ˜¯ç”¨ JavaScript å†™çš„ï¼Œä½†æœ‰äº›æƒ…å†µä¸‹ï¼Œä¸ºäº†æ€§èƒ½æˆ–è®¿é—®ç³»ç»Ÿèµ„æºç­‰åŸå› ï¼Œéœ€è¦ç”¨ C æˆ– C++ æ¥ç¼–å†™æ‰©å±•ã€‚è¿™äº›æ‰©å±•å°±æ˜¯é€šè¿‡ <code>node-gyp</code> æ„å»ºçš„ã€‚</p><p><code>node-gyp</code> æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒéœ€è¦ Python å’Œä¸€ä¸ªåˆé€‚çš„ C/C++ ç¼–è¯‘å™¨ï¼ˆä¾‹å¦‚ï¼Œåœ¨ Windows ä¸Šå¯èƒ½æ˜¯ Visual Studio çš„æ„å»ºå·¥å…·ï¼‰ã€‚<code>node-gyp</code> ä½¿ç”¨ GYPï¼ˆGenerate Your Projectsï¼‰é¡¹ç›®ç”Ÿæˆæ‰€éœ€çš„æ„å»ºæ–‡ä»¶ï¼ˆæ¯”å¦‚ makefile æˆ–è€… Visual Studio çš„ .vcxproj æ–‡ä»¶ï¼‰ï¼Œç„¶åç¼–è¯‘å’Œé“¾æ¥ C++ ä»£ç ç”Ÿæˆå¯¹åº”çš„äºŒè¿›åˆ¶æ¨¡å—ã€‚</p><p>ä¸¾å‡ ä¸ªå®é™…è¿ç”¨çš„ä¾‹å­ï¼š</p><ol><li><p><strong>æ•°æ®åº“ç»‘å®š</strong>ï¼šæ¯”å¦‚è¯´ï¼ŒNode.js ä¸ MySQL çš„é€šä¿¡å¯ä»¥ä½¿ç”¨çº¯ JavaScript å†™çš„æ¨¡å—ï¼Œä½†ä¹Ÿå¯ä»¥ä½¿ç”¨åƒ <code>mysql2</code> è¿™æ ·çš„æ¨¡å—ï¼Œåè€…ä½¿ç”¨ <code>node-gyp</code> ç¼–è¯‘æ€§èƒ½æ›´é«˜çš„ C++ ä»£ç æ¥åŠ é€Ÿæ•°æ®åº“æ“ä½œã€‚</p></li><li><p><strong>æ€§èƒ½å¯†é›†å‹è®¡ç®—</strong>ï¼šå¦‚æœä½ åœ¨åšå›¾åƒå¤„ç†æˆ–è€…æ‰§è¡Œå¤æ‚çš„æ•°å­¦è¿ç®—ï¼Œå¯èƒ½ä¼šé€‰æ‹©ç”¨ C++ æ¥ç¼–å†™è¿™éƒ¨åˆ†é€»è¾‘ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œå†é€šè¿‡ <code>node-gyp</code> ç¼–è¯‘æˆ Node.js æ¨¡å—æä¾›ç»™ JavaScript è°ƒç”¨ã€‚</p></li><li><p><strong>ç³»ç»Ÿçº§åˆ«çš„æ“ä½œ</strong>ï¼šå½“ä½ éœ€è¦è¿›è¡Œä½çº§æ–‡ä»¶æ“ä½œã€ç½‘ç»œé€šä¿¡æˆ–ç›´æ¥ä¸æ“ä½œç³»ç»Ÿå¯¹è¯æ—¶ï¼Œå¯èƒ½ä¼šå€ŸåŠ© <code>node-gyp</code> ç¼–è¯‘ä¸€äº› C++ æ¨¡å—ä»¥ä¾¿ç›´æ¥è°ƒç”¨ç³»ç»Ÿ APIã€‚</p></li></ol><p>è¦å®‰è£…å’Œä½¿ç”¨ <code>node-gyp</code>ï¼Œé€šå¸¸ä¼šå…ˆç”¨ npmï¼ˆNode.js çš„åŒ…ç®¡ç†å™¨ï¼‰æ¥å®‰è£…å®ƒï¼š</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#88C0D0;">npm</span><span style="color:#A3BE8C;"> install</span><span style="color:#A3BE8C;"> -g</span><span style="color:#A3BE8C;"> node-gyp</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ç„¶åï¼Œå¦‚æœä½ ä¸‹è½½äº†ä¸€ä¸ªéœ€è¦ç¼–è¯‘çš„ Node.js æ¨¡å—ï¼Œä¸€èˆ¬åœ¨æ¨¡å—çš„ç›®å½•ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥ç¼–è¯‘æ¨¡å—ï¼š</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#88C0D0;">node-gyp</span><span style="color:#A3BE8C;"> configure</span></span>
<span class="line"><span style="color:#88C0D0;">node-gyp</span><span style="color:#A3BE8C;"> build</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>configure</code> å‘½ä»¤ä¼šæ ¹æ®å½“å‰å¹³å°ç”Ÿæˆæ„å»ºæ–‡ä»¶ï¼Œ<code>build</code> å‘½ä»¤å®é™…ä¸Šä¼šè¿›è¡Œç¼–è¯‘ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œ<code>node-gyp</code> æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©å¼€å‘è€…å°† C/C++ ä»£ç é›†æˆåˆ° Node.js åº”ç”¨ä¸­ï¼Œè¿™åœ¨éœ€è¦ç‰¹æ®Šå¤„ç†æˆ–ä¼˜åŒ–æ€§èƒ½çš„åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨ã€‚</p><h4 id="cmake-js" tabindex="-1"><a class="header-anchor" href="#cmake-js"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#cmakejs" target="_blank" rel="noopener noreferrer">CMake.js</a></span></a></h4><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œæ—¶ç¯å¢ƒï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨ JavaScript ç¼–å†™æœåŠ¡å™¨ç«¯ä»£ç ã€‚CMake.js åˆ™æ˜¯ä¸ºäº†ç®€åŒ–åœ¨ Node.js ä¸­ç¼–è¯‘å’Œæ„å»ºæœ¬åœ°ï¼ˆnativeï¼‰æ¨¡å—çš„æ‰©å±•å·¥å…·ã€‚</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå½“ä½ æƒ³è¦åœ¨ Node.js ä¸­ä½¿ç”¨ä¸€äº›éœ€è¦ç¼–è¯‘çš„ C++ä»£ç æ—¶ï¼Œä½ ä¼šç”¨åˆ°ä¸€ä¸ªåå« node-gyp çš„å·¥å…·ã€‚node-gyp ä½¿ç”¨ Python å’Œ gyp æ¥æ„å»ºè¿™äº›æœ¬åœ°æ¨¡å—ã€‚ç„¶è€Œï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„äººéƒ½ç†Ÿæ‚‰ Python æˆ–è€…æƒ³è¦å®‰è£… Python åªä¸ºäº†æ„å»ºä¸€ä¸ªé¡¹ç›®ã€‚å› æ­¤ï¼ŒCMake.js å°±è¢«åˆ›å»ºå‡ºæ¥ä½œä¸º node-gyp çš„æ›¿ä»£å“ã€‚</p><p>CMake.js åˆ©ç”¨ CMake æ¥æ„å»ºæœ¬åœ°æ¨¡å—ã€‚CMake æ˜¯ä¸€ä¸ªéå¸¸æµè¡Œçš„è·¨å¹³å°è‡ªåŠ¨åŒ–æ„å»ºå·¥å…·ï¼Œå®ƒèƒ½å¤Ÿç”Ÿæˆæœ¬åœ°æ„å»ºç¯å¢ƒï¼ˆä¾‹å¦‚ makefile æˆ–è€… Visual Studio çš„é¡¹ç›®æ–‡ä»¶ï¼‰ã€‚</p><p>ä½¿ç”¨ CMake.js çš„æ­¥éª¤å¤§è‡´å¦‚ä¸‹ï¼š</p><ol><li><p><strong>å®‰è£… CMake.js</strong>ï¼šé¦–å…ˆï¼Œä½ éœ€è¦åœ¨ä½ çš„é¡¹ç›®ä¸­å®‰è£… CMake.jsã€‚ä½ å¯ä»¥é€šè¿‡ npm å‘½ä»¤æ¥å®‰è£…å®ƒï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#88C0D0;">npm</span><span style="color:#A3BE8C;"> install</span><span style="color:#A3BE8C;"> --save-dev</span><span style="color:#A3BE8C;"> cmake-js</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p><strong>é…ç½® CMakeLists.txt æ–‡ä»¶</strong>ï¼šåœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª<code>CMakeLists.txt</code>æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶å‘Šè¯‰ CMake æ€æ ·å»æ„å»ºä½ çš„æœ¬åœ°æ¨¡å—ã€‚ä¾‹å¦‚ï¼š</p><div class="language-cmake line-numbers-mode" data-highlighter="shiki" data-ext="cmake" data-title="cmake" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>cmake_minimum_required(VERSION 3.7)</span></span>
<span class="line"><span>project(MyModule)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>add_library(MyModule SHARED</span></span>
<span class="line"><span>    src/my_module.cpp</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>set_target_properties(MyModule PROPERTIES PREFIX &quot;&quot; SUFFIX &quot;.node&quot;)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>ç¼–è¯‘æœ¬åœ°æ¨¡å—</strong>ï¼šé€šè¿‡ CMake.js æä¾›çš„å‘½ä»¤è¡Œå·¥å…·æˆ–è€…é›†æˆåˆ° npm è„šæœ¬ä¸­æ¥æ„å»ºä½ çš„æ¨¡å—ã€‚</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#88C0D0;">cmake-js</span><span style="color:#A3BE8C;"> compile</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æˆ–è€…åœ¨<code>package.json</code>ä¸­æ·»åŠ ä¸€ä¸ªè„šæœ¬:</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">scripts</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">build</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">cmake-js compile</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åä½ å¯ä»¥ç”¨ npm run build æ¥æ„å»ºä½ çš„æ¨¡å—ã€‚</p></li><li><p><strong>åœ¨ Node.js ä¸­ä½¿ç”¨ä½ çš„æ¨¡å—</strong>ï¼šæ„å»ºå®Œæˆåï¼Œä½ å°±å¯ä»¥åƒå…¶ä»–ä»»ä½• npm æ¨¡å—ä¸€æ ·åœ¨ä½ çš„ JavaScript ä»£ç ä¸­å¼•å…¥å¹¶ä½¿ç”¨ä½ çš„æœ¬åœ°æ¨¡å—äº†ã€‚</p></li></ol><p>å®é™…åº”ç”¨ä¾‹å­ï¼š</p><p>å‡è®¾ä½ æœ‰ä¸€æ®µå¤æ‚çš„æ•°å­¦è®¡ç®—ï¼Œè¿™æ®µè®¡ç®—åœ¨ C++ä¸­å®ç°ä¼šæ¯” JavaScript å¿«å¾ˆå¤šã€‚ä½ å¯ä»¥å°†è¿™éƒ¨åˆ†é€»è¾‘å†™åœ¨<code>my_math.cpp</code>æ–‡ä»¶ä¸­ï¼Œç„¶åç”¨ CMake.js æ¥ç¼–è¯‘è¿™ä¸ª C++ä»£ç ä¸º Node.js å¯åŠ è½½çš„æœ¬åœ°æ¨¡å—ã€‚ Node.js ä»£ç å¯ä»¥ç›´æ¥è°ƒç”¨è¿™ä¸ªæ¨¡å—ï¼Œä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚</p><p>è¯·è®°ä½ï¼ŒCMake.js ä¸»è¦æ˜¯é¢å‘å·²ç»æœ‰ C++èƒŒæ™¯ï¼Œå¹¶ä¸”å¸Œæœ›èƒ½æœ‰æ•ˆåœ°å°†è¿™äº›ä»£ç ä¸ Node.js ç»“åˆèµ·æ¥çš„å¼€å‘äººå‘˜ã€‚å¯¹äºç¼–ç¨‹æ–°æ‰‹æ¥è¯´ï¼Œå¦‚æœæ²¡æœ‰å¿…è¦å¤„ç† C++ä»£ç ï¼Œå¼€å§‹æ—¶å¯èƒ½ä¸éœ€è¦æ·±å…¥å­¦ä¹  CMake.jsã€‚</p><h3 id="uploading-precompiled-binaries" tabindex="-1"><a class="header-anchor" href="#uploading-precompiled-binaries"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#uploading-precompiled-binaries" target="_blank" rel="noopener noreferrer">Uploading precompiled binaries</a></span></a></h3><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶çš„ APIï¼Œå®ƒæä¾›äº†ä¸€å¥—ç¨³å®šçš„åœ¨å„ä¸ª Node ç‰ˆæœ¬é—´é€šç”¨çš„å‡½æ•°ï¼Œè¿™æ„å‘³ç€å¦‚æœä½ ä½¿ç”¨ N-API ç¼–å†™çš„æ’ä»¶æˆ–è€…æ¨¡å—ï¼Œåˆ™å¯ä»¥åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸­è¿è¡Œè€Œä¸éœ€è¦é‡æ–°ç¼–è¯‘ã€‚</p><p>å½“å¼€å‘è€…åˆ›å»ºäº†ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼ˆä¹Ÿå°±æ˜¯ç”¨ C æˆ–è€… C++ä¹¦å†™çš„ç›´æ¥å’Œ Node.js äº¤äº’çš„æ¨¡å—ï¼‰åï¼Œä»–ä»¬é€šå¸¸ä¼šå¸Œæœ›ç”¨æˆ·å®‰è£…æ—¶èƒ½å¤Ÿç›´æ¥ä¸‹è½½é¢„ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä»æºä»£ç å¼€å§‹ç¼–è¯‘ã€‚è¿™æ ·å¯ä»¥èŠ‚çœç”¨æˆ·çš„æ—¶é—´ï¼Œç‰¹åˆ«æ˜¯å¯¹é‚£äº›ä¸ç†Ÿæ‚‰æœ¬åœ°ç¼–è¯‘ç¯å¢ƒçš„ç”¨æˆ·æ¥è¯´æ›´åŠ å‹å¥½ã€‚</p><p>ä¸Šä¼ é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶é€šå¸¸æ˜¯é€šè¿‡ä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹æœåŠ¡å’Œå·¥å…·å®Œæˆçš„ï¼Œä¾‹å¦‚ï¼š</p><ol><li><p><strong><code>node-pre-gyp</code></strong>: è¿™æ˜¯ä¸€ä¸ªè®©ä½ èƒ½å¤Ÿå‘å¸ƒå’Œå®‰è£… Node.js C++æ’ä»¶é¢„ç¼–è¯‘ç‰ˆæœ¬çš„å·¥å…·ã€‚åœ¨ä½ çš„é¡¹ç›®ä¸­ï¼Œä½ å¯ä»¥é…ç½®<code>node-pre-gyp</code>æ¥æŒ‡å®šå“ªäº›å¹³å°å’Œ Node.js ç‰ˆæœ¬çš„é¢„ç¼–è¯‘æ–‡ä»¶åº”è¯¥è¢«ä¸Šä¼ åˆ°å­˜å‚¨æœåŠ¡å™¨ä¸Šï¼ˆæ¯”å¦‚ Amazon S3ã€GitHub Releases ç­‰ï¼‰ã€‚å½“ç”¨æˆ·å®‰è£…ä½ çš„æ¨¡å—æ—¶ï¼Œ<code>node-pre-gyp</code>ä¼šæŸ¥æ‰¾åŒ¹é…ç”¨æˆ·å¹³å°å’Œ Node.js ç‰ˆæœ¬çš„é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶å°è¯•ä¸‹è½½å®ƒæ¥å®‰è£…ã€‚</p></li><li><p><strong><code>prebuild</code> / <code>prebuild-install</code></strong>: è¿™æ˜¯å¦ä¸€ç»„å·¥å…·ï¼Œå·¥ä½œæ–¹å¼ç±»ä¼¼äº<code>node-pre-gyp</code>ï¼Œä½†æœ‰å…¶ç‰¹å®šçš„é…ç½®å’Œç‰¹æ€§ã€‚<code>prebuild</code>è´Ÿè´£åˆ›å»ºé¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶å¯ä»¥å°†å®ƒä»¬ä¸Šä¼ åˆ° GitHub Releases ä¸Šã€‚è€Œ<code>prebuild-install</code>åˆ™è¢«ç”¨äºåœ¨ç”¨æˆ·å®‰è£…ä½ çš„æ¨¡å—æ—¶ä¸‹è½½å¹¶å®‰è£…è¿™äº›é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p></li></ol><p>å®é™…è¿ç”¨çš„ä¾‹å­:<br> å‡è®¾ä½ åˆ›å»ºäº†ä¸€ä¸ªåä¸º&quot;awesome-native-module&quot;çš„ Node.js åŸç”Ÿæ¨¡å—ï¼Œå®ƒæä¾›äº†ä¸€äº›ç”¨ C++ç¼–å†™çš„åŠŸèƒ½ã€‚ä½ æƒ³è¦è®©ç”¨æˆ·åœ¨å®‰è£…ä½ çš„æ¨¡å—æ—¶èƒ½å¤Ÿè½»æ¾è·å¾—é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><p>è¿™é‡Œæ˜¯æ€ä¹ˆåšçš„å¤§è‡´æ­¥éª¤ï¼š</p><ol><li><p>åœ¨ä½ çš„æ¨¡å—ä¸­åŠ å…¥<code>node-pre-gyp</code>æˆ–è€…<code>prebuild</code>ä½œä¸ºä¾èµ–é¡¹ï¼Œå¹¶ä¸”é…ç½®å®ƒä»¬çš„è·¯å¾„ï¼ŒæŒ‡å‘ä½ æƒ³è¦ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶çš„åœ°ç‚¹ã€‚</p></li><li><p>è®¾ç½® CI/CD æµç¨‹ï¼ˆæ¯”å¦‚ GitHub Actionsï¼‰ï¼Œåœ¨æ¯æ¬¡ä½ æ¨é€ä»£ç æ›´æ–°æˆ–è€…åˆ›å»ºä¸€ä¸ªæ–°çš„å‘å¸ƒæ—¶è‡ªåŠ¨è¿è¡Œæ„å»ºè¿‡ç¨‹ï¼Œå¹¶ä¸”è§¦å‘<code>node-pre-gyp</code>æˆ–<code>prebuild</code>å»åˆ›å»ºå’Œä¸Šä¼ æ–°çš„é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p></li><li><p>å½“ç”¨æˆ·æ‰§è¡Œ<code>npm install awesome-native-module</code>æ—¶ï¼Œ<code>node-pre-gyp</code>æˆ–<code>prebuild-install</code>ä¼šè¢«è°ƒç”¨ã€‚å®ƒä»¬ä¼šæ£€æŸ¥ç”¨æˆ·çš„ç³»ç»Ÿå’Œ Node ç‰ˆæœ¬ï¼Œå°è¯•å»ä¸‹è½½å¯¹åº”çš„é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é¢„ç¼–è¯‘æ–‡ä»¶ï¼Œå®ƒä»¬ä¼šé€€å›åˆ°ä»æºç ç¼–è¯‘ã€‚</p></li></ol><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥æé«˜ç”¨æˆ·å®‰è£…ä½ åŸç”Ÿæ¨¡å—çš„ä½“éªŒï¼Œå‡å°‘ä»–ä»¬éœ€è¦å¤„ç†ç¼–è¯‘é—®é¢˜çš„æœºä¼šã€‚</p><h4 id="node-pre-gyp" tabindex="-1"><a class="header-anchor" href="#node-pre-gyp"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#node-pre-gyp" target="_blank" rel="noopener noreferrer">node-pre-gyp</a></span></a></h4><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œæ—¶ç¯å¢ƒï¼Œå®ƒè®©å¼€å‘è€…èƒ½å¤Ÿä½¿ç”¨ JavaScript æ¥ç¼–å†™æœåŠ¡ç«¯ä»£ç ã€‚Node.js é«˜æ•ˆçš„äº‹ä»¶é©±åŠ¨ã€éé˜»å¡ I/O æ¨¡å‹ä½¿å…¶éå¸¸é€‚ç”¨äºæ„å»ºå¿«é€Ÿçš„ã€å¯æ‰©å±•çš„ç½‘ç»œåº”ç”¨ã€‚</p><p>åœ¨ Node.js çš„ç”Ÿæ€ç³»ç»Ÿä¸­ï¼Œæœ‰å¾ˆå¤šåŸç”Ÿæ¨¡å—ï¼ˆnative modulesï¼‰ï¼Œå³ç”¨ C æˆ– C++ ç¼–å†™çš„æ¨¡å—ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡ Node.js æä¾›çš„ N-API æ¥å£ä¸ JavaScript ä»£ç äº¤äº’ã€‚è¿™äº›æ¨¡å—é€šå¸¸æ˜¯ä¸ºäº†æé«˜æ€§èƒ½æˆ–è®¿é—®ä¸€äº›åº•å±‚ç³»ç»ŸåŠŸèƒ½ï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€ç½‘ç»œé€šä¿¡æˆ–å›¾å½¢å¤„ç†ç­‰ã€‚</p><p><code>node-pre-gyp</code> æ˜¯ä¸€ä¸ªå·¥å…·å’Œåº“ï¼Œå®ƒå…è®¸å¼€å‘è€…ä¸ºä»–ä»¬çš„ Node.js åŸç”Ÿæ¨¡å—ç¼–è¯‘å¹¶å‘å¸ƒé¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶åŒ…ã€‚è¿™äº›äºŒè¿›åˆ¶åŒ…å¯ä»¥é’ˆå¯¹ä¸åŒçš„å¹³å°ï¼ˆå¦‚ Windowsã€macOS å’Œ Linuxï¼‰ä»¥åŠä¸åŒç‰ˆæœ¬çš„ Node.js æå‰ç¼–è¯‘å¥½ï¼Œå¹¶ä¸”å¯ä»¥åœ¨å®‰è£…æ—¶ç›´æ¥ä½¿ç”¨ï¼Œè€Œæ— éœ€ç”¨æˆ·è‡ªå·±ç¼–è¯‘ã€‚</p><h3 id="ä¸ºä»€ä¹ˆéœ€è¦-node-pre-gyp" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆéœ€è¦-node-pre-gyp"><span>ä¸ºä»€ä¹ˆéœ€è¦ <code>node-pre-gyp</code>ï¼Ÿ</span></a></h3><p>å½“ä½ é€šè¿‡ npm å®‰è£…ä¸€ä¸ªåŒ…å«åŸç”Ÿæ¨¡å—çš„ Node.js åŒ…æ—¶ï¼Œé€šå¸¸éœ€è¦åœ¨æœ¬åœ°ç¼–è¯‘è¯¥æ¨¡å—ã€‚æœ¬åœ°ç¼–è¯‘éœ€è¦å¼€å‘è€…æœºå™¨ä¸Šæœ‰ç¼–è¯‘å·¥å…·é“¾ï¼ˆå¦‚ gccã€clang æˆ– Visual Studioï¼‰ã€‚ä½†æ˜¯ï¼Œç”±äºä»¥ä¸‹å‡ ä¸ªåŸå› ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ï¼š</p><ol><li>ç”¨æˆ·å¯èƒ½æ²¡æœ‰å¿…è¦çš„ç¼–è¯‘å·¥å…·æˆ–è€…å¯¹å¦‚ä½•å®‰è£…å’Œä½¿ç”¨ç¼–è¯‘å·¥å…·ä¸ç†Ÿæ‚‰ã€‚</li><li>ç¼–è¯‘è¿‡ç¨‹å¯èƒ½å› ä¸ºç³»ç»Ÿé…ç½®æˆ–ä¾èµ–é¡¹çš„ä¸åŒè€Œå¤±è´¥ã€‚</li><li>ç¼–è¯‘åŸç”Ÿæ¨¡å—å¯èƒ½ä¼šèŠ±è´¹ç›¸å½“é•¿çš„æ—¶é—´ã€‚</li></ol><p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œ<code>node-pre-gyp</code> å…è®¸æ¨¡å—ç»´æŠ¤è€…æå‰ä¸ºå„ç§ç¯å¢ƒç¼–è¯‘å¥½äºŒè¿›åˆ¶ç‰ˆæœ¬ï¼Œç”¨æˆ·åœ¨å®‰è£…æ—¶ npm èƒ½å¤Ÿç›´æ¥ä¸‹è½½å’Œä½¿ç”¨è¿™äº›é¢„ç¼–è¯‘çš„ç‰ˆæœ¬ï¼Œä»è€Œé¿å…äº†ç¼–è¯‘è¿‡ç¨‹ä¸­çš„å¤æ‚æ€§å’Œè€—æ—¶ã€‚</p><h3 id="å®é™…è¿ç”¨ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ä½¿ç”¨ä¸€ä¸ªåä¸º <code>sharp</code> çš„ Node.js åŒ…ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨äºå›¾ç‰‡å¤„ç†çš„åº“ï¼Œå…¶ä¸­åŒ…å«äº†ç”¨ C++ ç¼–å†™çš„åŸç”Ÿä»£ç ã€‚å¦‚æœæ²¡æœ‰ <code>node-pre-gyp</code>ï¼Œæ¯ä¸ªå®‰è£… <code>sharp</code> çš„äººéƒ½éœ€è¦åœ¨ä»–ä»¬çš„æœºå™¨ä¸Šç¼–è¯‘è¿™ä¸ªåŸç”Ÿæ¨¡å—ã€‚è¿™å¯èƒ½å¯¼è‡´ä¸€äº›ç”¨æˆ·å› ä¸ºç¼ºå°‘ç¼–è¯‘å™¨æˆ–å…¶ä»–åŸå› è€Œæ— æ³•æˆåŠŸå®‰è£…ã€‚</p><p>ä½†æ˜¯ï¼Œç”±äº <code>sharp</code> ä½¿ç”¨äº† <code>node-pre-gyp</code>ï¼Œæ‰€ä»¥åœ¨ä½ æ‰§è¡Œ <code>npm install sharp</code> çš„æ—¶å€™ï¼Œ<code>npm</code> å°†æŸ¥çœ‹ä½ çš„æ“ä½œç³»ç»Ÿå’Œ Node.js ç‰ˆæœ¬ï¼Œç„¶åä» <code>sharp</code> çš„æœåŠ¡å™¨ä¸Šä¸‹è½½é€‚åˆä½ ç³»ç»Ÿçš„é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ•´ä¸ªè¿‡ç¨‹å¯¹ç”¨æˆ·æ¥è¯´æ˜¯é€æ˜çš„ï¼Œæ˜¾è‘—æé«˜äº†å®‰è£…é€Ÿåº¦å’ŒæˆåŠŸç‡ã€‚</p><h3 id="å¦‚ä½•ä½¿ç”¨-node-pre-gyp" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ä½¿ç”¨-node-pre-gyp"><span>å¦‚ä½•ä½¿ç”¨ <code>node-pre-gyp</code></span></a></h3><p>æ¨¡å—ç»´æŠ¤è€…é€šå¸¸ä¼šåœ¨ä»–ä»¬çš„ <code>package.json</code> æ–‡ä»¶ä¸­æ·»åŠ  <code>node-pre-gyp</code> ç›¸å…³çš„é…ç½®ï¼Œå¹¶æŒ‡å®šå¥½äºŒè¿›åˆ¶æ–‡ä»¶çš„å­˜å‚¨ä½ç½®ã€‚åœ¨æ¨¡å—å®‰è£…è¿‡ç¨‹ä¸­ï¼Œ<code>npm</code> æˆ– <code>yarn</code> ä¼šæ ¹æ®è¿™äº›é…ç½®è‡ªåŠ¨è°ƒç”¨ <code>node-pre-gyp</code> æ¥ä¸‹è½½æˆ–ç¼–è¯‘åŸç”Ÿæ¨¡å—ã€‚</p><p>æ€»ç»“èµ·æ¥ï¼Œ<code>node-pre-gyp</code> æ˜¯ Node.js ç”Ÿæ€ç³»ç»Ÿä¸­ä¸€ä¸ªé‡è¦çš„å·¥å…·ï¼Œå®ƒé€šè¿‡æä¾›é¢„ç¼–è¯‘çš„åŸç”Ÿæ¨¡å—äºŒè¿›åˆ¶æ–‡ä»¶æ¥ç®€åŒ–å®‰è£…è¿‡ç¨‹ï¼Œæ”¹å–„æœ€ç»ˆç”¨æˆ·çš„ä½“éªŒã€‚</p><h4 id="prebuild" tabindex="-1"><a class="header-anchor" href="#prebuild"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#prebuild" target="_blank" rel="noopener noreferrer">prebuild</a></span></a></h4><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œå®ƒå…è®¸åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚N-API åˆ™æ˜¯ Node.js æä¾›çš„ä¸€ç»„ C APIï¼Œä½¿å¾—åŸç”Ÿæ’ä»¶ï¼ˆé€šå¸¸ç”¨ C æˆ– C++ ç¼–å†™ï¼‰èƒ½å¤Ÿåœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸­å¹³ç¨³è¿è¡Œï¼Œè€Œä¸éœ€è¦å› ä¸º Node.js å‡çº§åå¼•æ“çš„å˜åŒ–è€Œé‡æ–°ç¼–è¯‘ã€‚</p><p>é‚£ä¹ˆï¼Œâ€œprebuildâ€è¿™ä¸ªæœ¯è¯­é€šå¸¸ä¸ N-API å’Œ node-addon-apiï¼ˆä¸€ç§ç®€åŒ–ç¼–å†™åŸç”Ÿ Node.js æ’ä»¶çš„åŒ…è£…åº“ï¼‰æœ‰å…³ã€‚&quot;prebuild&quot;æŒ‡çš„æ˜¯äº‹å…ˆä¸ºä¸åŒå¹³å°å’Œ Node.js ç‰ˆæœ¬æ„å»ºå¥½çš„åŸç”Ÿæ¨¡å—ï¼ˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ã€‚é€šè¿‡é¢„å…ˆæ„å»ºï¼Œæ¨¡å—çš„å®‰è£…å¯ä»¥å˜å¾—æ›´å¿«ï¼Œå› ä¸ºç”¨æˆ·ä¸éœ€è¦ä»æºä»£ç ç¼–è¯‘å®ƒä»¬ã€‚</p><p>ä¾‹å¦‚ï¼Œå¦‚æœä½ æ­£åœ¨æ„å»ºä¸€ä¸ªæ€§èƒ½æ•æ„Ÿçš„åº”ç”¨ç¨‹åºï¼Œä½ å¯èƒ½ä¼šä½¿ç”¨åˆ°ä¸€äº›éœ€è¦åˆ©ç”¨æ›´æ·±å±‚ç³»ç»Ÿèµ„æºä¼˜åŠ¿çš„ä»£ç ã€‚ä½ æˆ–è®¸ä¼šé€‰æ‹©å†™ä¸€ä¸ªç”¨ C++ ç¼–å†™çš„æ¨¡å—æ¥å¤„ç†å›¾åƒæˆ–è¿›è¡Œæ•°å­¦è®¡ç®—ï¼Œæ¯”ä½¿ç”¨ JavaScript å¿«å¾—å¤šã€‚å½“ç”¨æˆ·æƒ³è¦å®‰è£…ä½ çš„æ¨¡å—æ—¶ï¼Œä½ å¯ä»¥æä¾›é¢„å…ˆæ„å»ºå¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ä»¥å‡å°‘ä»–ä»¬çš„å®‰è£…æ—¶é—´å’Œå¤æ‚åº¦ã€‚</p><p>ç°åœ¨æˆ‘ä»¬å‡è®¾ä½ å·²ç»åˆ›å»ºäº†è¿™æ ·ä¸€ä¸ªæ¨¡å—ï¼Œå¹¶ä¸”ä½ å¸Œæœ›å®ƒèƒ½å¤Ÿè·¨å¹³å°ï¼ˆå¦‚ Windows, macOS, Linuxï¼‰å’Œè·¨ Node.js ç‰ˆæœ¬å·¥ä½œã€‚ä½ å°±å¯ä»¥ä½¿ç”¨ç±»ä¼¼ <code>prebuild</code> æˆ– <code>node-pre-gyp</code> è¿™æ ·çš„å·¥å…·æ¥ä¸ºè¿™äº›ä¸åŒçš„ç»„åˆæ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><p>è¿™é‡Œæœ‰ä¸€äº›å…·ä½“çš„æ­¥éª¤ç¤ºä¾‹ï¼š</p><ol><li><p><strong>å¼€å‘åŸç”Ÿæ¨¡å—</strong>ï¼šé¦–å…ˆï¼Œä½ è¦ç”¨ C æˆ– C++ å¼€å‘ä½ çš„åŸç”Ÿæ¨¡å—ï¼Œå¹¶ä¸”ç¡®ä¿å®ƒé€šè¿‡ N-API æ¥å£ä¸ JavaScript äº¤äº’ã€‚</p></li><li><p><strong>é…ç½®é¢„æ„å»ºè„šæœ¬</strong>ï¼šé…ç½®ä¸€ä¸ª <code>prebuild</code> è„šæœ¬ï¼Œåœ¨ä½ å‘å¸ƒæ¨¡å—ä¹‹å‰è‡ªåŠ¨ä¸ºæ‰€æœ‰ç›®æ ‡å¹³å°å’Œ Node.js ç‰ˆæœ¬æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p></li><li><p><strong>æ„å»ºå’Œä¸Šä¼ </strong>ï¼šå½“ä½ æ‰§è¡Œ <code>prebuild</code> è„šæœ¬æ—¶ï¼Œå®ƒä¼šä¸ºæ¯ä¸ªç›®æ ‡å¹³å°å’Œ Node.js ç‰ˆæœ¬æ„å»ºä½ çš„æ¨¡å—ï¼Œå¹¶å°†æ„å»ºå¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸Šä¼ åˆ° GitHub Releases æˆ–å…¶ä»–æ‰˜ç®¡æœåŠ¡ä¸Šã€‚</p></li><li><p><strong>ç”¨æˆ·å®‰è£…æ¨¡å—</strong>ï¼šå½“ç”¨æˆ·è¿è¡Œ <code>npm install your-module-name</code> å®‰è£…ä½ çš„æ¨¡å—æ—¶ï¼Œ<code>npm</code> æˆ– <code>yarn</code> ä¼šè‡ªåŠ¨æ£€æµ‹ç”¨æˆ·çš„å¹³å°å’Œ Node.js ç‰ˆæœ¬ï¼Œå¹¶å°è¯•ä¸‹è½½ç›¸åº”çš„é¢„æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ã€‚å¦‚æœæ‰¾åˆ°åŒ¹é…çš„é¢„æ„å»ºæ–‡ä»¶ï¼Œå°±ç›´æ¥ä¸‹è½½å’Œå®‰è£…ï¼Œè€Œä¸éœ€è¦ä»æºç ç¼–è¯‘ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é¢„æ„å»ºæ–‡ä»¶ï¼Œåˆ™å›é€€åˆ°ä»æºç ç¼–è¯‘ã€‚</p></li></ol><p>å®é™…åº”ç”¨çš„ä¾‹å­åŒ…æ‹¬æ•°æ®åº“é©±åŠ¨ï¼ˆä¾‹å¦‚ <code>node-sqlite3</code>ï¼‰ï¼ŒåŠ å¯†åº“ï¼ˆä¾‹å¦‚ <code>bcrypt</code>ï¼‰ï¼Œæˆ–æ˜¯æ•°å­¦åº“ï¼ˆä¾‹å¦‚ <code>mathjax-node</code>ï¼‰ï¼Œå®ƒä»¬éƒ½å¯èƒ½æä¾›é¢„æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä»¥æ–¹ä¾¿ç”¨æˆ·å®‰è£…å’Œä½¿ç”¨ã€‚</p><p>æ€»ç»“æ¥è¯´ï¼Œâ€œprebuildâ€åœ¨ Node.js çš„è¯­å¢ƒä¸­å°±æ˜¯æŒ‡é¢„å…ˆä¸ºä¸åŒçš„è¿è¡Œç¯å¢ƒç¼–è¯‘å¥½çš„åŸç”Ÿæ¨¡å—äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç›®çš„æ˜¯ç®€åŒ–æœ€ç»ˆç”¨æˆ·çš„å®‰è£…è¿‡ç¨‹ï¼Œå¹¶æé«˜æ¨¡å—çš„å¯ç§»æ¤æ€§å’Œæ˜“ç”¨æ€§ã€‚</p><h4 id="prebuildify" tabindex="-1"><a class="header-anchor" href="#prebuildify"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#prebuildify" target="_blank" rel="noopener noreferrer">prebuildify</a></span></a></h4><p>Node.js ä¸­çš„ &quot;prebuildify&quot; å¹¶é Node.js çš„å®˜æ–¹ API çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ npm åŒ…ï¼Œç”¨äºä¸º Node.js çš„åŸç”Ÿæ¨¡å—åˆ›å»ºé¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶ç‰ˆæœ¬ã€‚åŸç”Ÿæ¨¡å—æ˜¯ä½¿ç”¨ C æˆ– C++ ç¼–å†™çš„æ’ä»¶ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ Node.js åº•å±‚çš„ APIã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“ä½ å®‰è£…ä¸€ä¸ªåŒ…å«åŸç”Ÿæ¨¡å—çš„èŠ‚ç‚¹åŒ…æ—¶ï¼Œè¿™äº›æ¨¡å—éœ€è¦åœ¨æœ¬åœ°æœºå™¨ä¸Šä»æºä»£ç ç¼–è¯‘ã€‚Prebuildify èƒ½å¤Ÿå¸®åŠ©å¼€å‘è€…å…ˆè¡Œåœ¨ä¸åŒçš„å¹³å°ä¸Šç¼–è¯‘å¥½è¿™äº›åŸç”Ÿæ¨¡å—ï¼Œå¹¶ä¸”éšç€ npm åŒ…ä¸€èµ·å‘å¸ƒã€‚</p><h3 id="prebuildify-ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#prebuildify-ä½¿ç”¨"><span>prebuildify ä½¿ç”¨</span></a></h3><p>è¦ä½¿ç”¨ prebuildifyï¼Œé€šå¸¸éœ€è¦ä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li>ç¡®ä¿ä½ æœ‰ä¸€ä¸ªéœ€è¦ç¼–è¯‘çš„åŸç”Ÿæ¨¡å—é¡¹ç›®ã€‚</li><li>å®‰è£… prebuildifyï¼šé€šè¿‡è¿è¡Œ <code>npm install --save-dev prebuildify</code> å°†å®ƒä½œä¸ºå¼€å‘ä¾èµ–æ·»åŠ åˆ°ä½ çš„é¡¹ç›®ä¸­ã€‚</li><li>åœ¨ package.json æ–‡ä»¶ä¸­é…ç½® scriptsï¼Œå¢åŠ ä¸€ä¸ªè„šæœ¬æ¥è¿è¡Œ prebuildifyã€‚</li><li>è¿è¡Œé…ç½®çš„è„šæœ¬ä»¥åˆ›å»ºé¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</li><li>å‘å¸ƒä½ çš„åŒ…ï¼Œè¿™æ ·å…¶ä»–ç”¨æˆ·åœ¨å®‰è£…æ—¶ï¼Œå°†ä¼šä¸‹è½½ç›¸åº”å¹³å°çš„é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼Œä»è€Œçœç•¥äº†ç¼–è¯‘è¿‡ç¨‹ã€‚</li></ol><h3 id="å®é™…ä¾‹å­-1" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-1"><span>å®é™…ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªåä¸º &quot;awesome-native-module&quot; çš„åŸç”Ÿ Node.js æ¨¡å—ã€‚ä½ å¸Œæœ›ç”¨æˆ·åœ¨å®‰è£…æ—¶ä¸å¿…ä»å¤´ç¼–è¯‘è¿™ä¸ªæ¨¡å—ï¼Œä»¥èŠ‚çœæ—¶é—´å’Œé¿å…æ½œåœ¨çš„ç¼–è¯‘é—®é¢˜ã€‚ä½ å¯ä»¥ä½¿ç”¨ prebuildify æ¥å®ç°è¿™ä¸€ç›®çš„ã€‚ä»¥ä¸‹æ˜¯ç®€åŒ–çš„æ­¥éª¤ï¼š</p><ol><li>å¼€å‘ä½ çš„åŸç”Ÿæ¨¡å—ï¼Œç¡®ä¿å®ƒèƒ½å¤Ÿåœ¨æœ¬åœ°ç¼–è¯‘é€šè¿‡ã€‚</li><li>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œ <code>npm install --save-dev prebuildify</code> å‘½ä»¤ï¼Œæ·»åŠ  prebuildify ä½œä¸ºå¼€å‘ä¾èµ–ã€‚</li><li>åœ¨ package.json ä¸­æ·»åŠ ä¸€ä¸ªè„šæœ¬ï¼š<div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">scripts</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">: </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">prebuild</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">prebuildify --napi</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>è¿è¡Œ <code>npm run prebuild</code>ã€‚è¿™å°†ä¸ºå½“å‰ç³»ç»Ÿç”Ÿæˆé¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ <code>./prebuilds/</code> ç›®å½•ä¸­ã€‚</li><li>ç°åœ¨ä½ å¯ä»¥å‘å¸ƒä½ çš„åŒ…äº†ã€‚ä¾‹å¦‚ï¼Œè¿è¡Œ <code>npm publish</code>ã€‚</li></ol><p>å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œå½“ç”¨æˆ·è¿è¡Œ <code>npm install awesome-native-module</code> æ—¶ï¼Œnpm ä¼šæŸ¥æ‰¾ä¸ç”¨æˆ·ç³»ç»ŸåŒ¹é…çš„é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å¦‚æœæ‰¾åˆ°äº†ï¼Œå®ƒä¼šä¸‹è½½å¹¶ä½¿ç”¨è¿™ä¸ªé¢„ç¼–è¯‘çš„ç‰ˆæœ¬è€Œä¸æ˜¯ä»æºä»£ç é‡æ–°ç¼–è¯‘ã€‚</p><p><strong>æ³¨æ„ï¼š</strong> ä¸Šè¿°ä¿¡æ¯å¯èƒ½ä¸ Node.js v21.7.1 ç‰ˆæœ¬çš„å…·ä½“æƒ…å†µæœ‰æ‰€å·®å¼‚ï¼Œå› ä¸º Node.js å’Œç›¸å…³å·¥å…·é“¾ç»å¸¸æ›´æ–°ã€‚å§‹ç»ˆå»ºè®®æŸ¥é˜…æœ€æ–°çš„æ–‡æ¡£æˆ–åº“è¯´æ˜æ¥è·å–å‡†ç¡®çš„ä½¿ç”¨æ–¹æ³•ã€‚</p><h2 id="usage" tabindex="-1"><a class="header-anchor" href="#usage"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#usage" target="_blank" rel="noopener noreferrer">Usage</a></span></a></h2><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶çš„ APIï¼Œå®ƒæ˜¯ç‹¬ç«‹äºåº•å±‚ JavaScript è¿è¡Œæ—¶ï¼ˆä¾‹å¦‚ V8ï¼‰çš„æŠ½è±¡å±‚ï¼Œç›®çš„æ˜¯ä¿æŒä½ çš„æ’ä»¶åœ¨ Node.js çš„ä¸åŒç‰ˆæœ¬ä¹‹é—´å…¼å®¹ã€‚è¿™æ„å‘³ç€ä½¿ç”¨ N-API ç¼–å†™çš„æœ¬åœ°æ’ä»¶ä¸éœ€è¦é’ˆå¯¹æ¯ä¸ªæ–°çš„ Node.js ç‰ˆæœ¬é‡æ–°ç¼–è¯‘ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œå¦‚æœä½ æƒ³è®©ä½ çš„ JavaScript ä»£ç è°ƒç”¨ C/C++ç¼–å†™çš„å‡½æ•°æˆ–è€…åº“ï¼Œé‚£ä¹ˆ N-API å¯ä»¥å¸®åŠ©ä½ åšåˆ°è¿™ç‚¹ï¼Œè€Œä¸éœ€è¦æ‹…å¿ƒ Node.js ç‰ˆæœ¬å‡çº§åæ’ä»¶ä¸å…¼å®¹çš„é—®é¢˜ã€‚</p><p>ä»¥ä¸‹æ˜¯ä½¿ç”¨ N-API çš„åŸºæœ¬æ­¥éª¤ï¼š</p><ol><li><p><strong>åŒ…å«å¤´æ–‡ä»¶</strong>ï¼šåœ¨ä½ çš„ C æˆ– C++æºæ–‡ä»¶ä¸­ï¼ŒåŒ…å«<code>&lt;`node_api.h`&gt;</code>å¤´æ–‡ä»¶ï¼Œè¿™ä½¿å¾—ä½ èƒ½å¤Ÿä½¿ç”¨ N-API æä¾›çš„å‡½æ•°å’Œå®ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p><strong>åˆ›å»ºå‡½æ•°</strong>ï¼šç¼–å†™ä½ è¦ä» JavaScript è°ƒç”¨çš„ C/C++å‡½æ•°ã€‚è¿™äº›å‡½æ•°å¿…é¡»éµå¾ª N-API å®šä¹‰çš„ç‰¹å®šç­¾åã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // å‡½æ•°é€»è¾‘</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>æ³¨å†Œå‡½æ•°</strong>ï¼šä½¿ç”¨ N-API å‡½æ•°æ³¨å†Œä¸Šé¢å®šä¹‰çš„å‡½æ•°ï¼Œä½¿å…¶å¯ä»¥è¢« JavaScript è°ƒç”¨ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªnapi_valueå¼•ç”¨ï¼ŒæŒ‡å‘æˆ‘ä»¬çš„åŸç”Ÿå‡½æ•°MyFunction</span></span>
<span class="line"><span>    status = napi_create_function(env, NULL, 0, MyFunction, NULL, &amp;fn);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†è¿™ä¸ªå‡½æ•°ä½œä¸ºæ¨¡å—å¯¼å‡ºçš„å±æ€§</span></span>
<span class="line"><span>    status = napi_set_named_property(env, exports, &quot;myFunction&quot;, fn);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>æ„å»ºå’Œå®‰è£…</strong>ï¼šä½¿ç”¨<code>node-gyp</code>ç¼–è¯‘ä½ çš„ C/C++ä»£ç å¹¶ç”Ÿæˆä¸€ä¸ª.node æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å¯ä»¥è¢« Node.js ä½œä¸ºæ¨¡å—åŠ è½½ã€‚</p></li><li><p><strong>åœ¨ Node.js ä¸­ä½¿ç”¨</strong>ï¼šåœ¨ Node.js ä»£ç ä¸­ï¼Œä½¿ç”¨<code>require</code>åŠ è½½ä½ çš„æœ¬åœ°æ’ä»¶ï¼Œå¹¶åƒæ™®é€šæ¨¡å—ä¸€æ ·ä½¿ç”¨ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> myAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">myAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">myFunction</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è°ƒç”¨ä½ åœ¨C/C++ä¸­å®šä¹‰çš„å‡½æ•°</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>å®é™…è¿ç”¨ä¾‹å­ï¼š</p><ul><li><p><strong>æ€§èƒ½å¯†é›†å‹ä»»åŠ¡</strong>ï¼šæŸäº›æ“ä½œåœ¨ JavaScript ä¸­æ‰§è¡Œæ•ˆç‡ä½ä¸‹ï¼Œæ¯”å¦‚å›¾åƒå¤„ç†æˆ–è€…å¤§è§„æ¨¡æ•°å€¼è®¡ç®—ï¼Œä½ å¯ä»¥ä½¿ç”¨ N-API ç¼–å†™é«˜æ•ˆçš„ C/C++ä»£ç æ¥å¤„ç†è¿™äº›ä»»åŠ¡ï¼Œå¹¶é€šè¿‡ Node.js è°ƒç”¨å®ƒä»¬ã€‚</p></li><li><p><strong>ç³»ç»Ÿçº§æ“ä½œ</strong>ï¼šå½“ä½ éœ€è¦è¿›è¡Œç³»ç»Ÿè°ƒç”¨æˆ–è®¿é—®æ“ä½œç³»ç»Ÿå±‚é¢çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ç¡¬ä»¶ä¿¡æ¯è·å–æˆ–ç³»ç»Ÿè°ƒåº¦ï¼Œä½ å¯ä»¥é€šè¿‡ N-API å†™æœ¬åœ°ä»£ç æ¥å®ç°ã€‚</p></li><li><p><strong>é›†æˆç¬¬ä¸‰æ–¹åº“</strong>ï¼šå¦‚æœä½ æƒ³åœ¨ Node.js é¡¹ç›®ä¸­ä½¿ç”¨ä¸€äº›åªæœ‰ C/C++æ¥å£çš„ç¬¬ä¸‰æ–¹åº“ï¼Œå¦‚æœºå™¨å­¦ä¹ åº“æˆ–æ˜¯æ•°æ®åº“é©±åŠ¨ï¼Œä½ å¯ä»¥é€šè¿‡ N-API å°†å®ƒä»¬å°è£…ä¸ºå¯ä» JavaScript è°ƒç”¨çš„å‡½æ•°ã€‚</p></li></ul><p>N-API æ˜¯ Node.js æä¾›çš„éå¸¸å¼ºå¤§çš„åŠŸèƒ½ï¼Œå®ƒæå¤§åœ°æ‰©å±•äº† Node.js çš„åº”ç”¨åœºæ™¯ï¼Œå¹¶ä¸”è§£å†³äº†æœ¬åœ°æ’ä»¶ä¸ Node.js ç‰ˆæœ¬å…¼å®¹æ€§çš„é—®é¢˜ã€‚ä¸è¿‡ï¼Œæœ¬åœ°æ’ä»¶å¼€å‘æ¶‰åŠ C/C++çŸ¥è¯†ï¼Œå› æ­¤ä¼šæœ‰ä¸€å®šçš„å­¦ä¹ éš¾åº¦ã€‚å¦‚æœä½ åˆšå¼€å§‹ç¼–ç¨‹ï¼Œä½ å¯èƒ½éœ€è¦å…ˆæŒæ¡ JavaScript å’Œ Node.js çš„åŸºç¡€ï¼Œç„¶åå†é€æ¸æ·±å…¥å­¦ä¹  N-API ç›¸å…³å†…å®¹ã€‚</p><h2 id="node-api-version-matrix" tabindex="-1"><a class="header-anchor" href="#node-api-version-matrix"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#node-api-version-matrix" target="_blank" rel="noopener noreferrer">Node-API version matrix</a></span></a></h2><p>å¥½çš„ï¼ŒNode.js ä¸­çš„ Node-APIï¼ˆä¹‹å‰ç§°ä¸º N-APIï¼‰æ˜¯ä¸€ä¸ªè®©ä½ èƒ½å¤Ÿç”¨ C æˆ– C++ ç¼–å†™æ‰©å±•çš„ APIã€‚Node-API æ—¨åœ¨æä¾›ä¸€ä¸ªä¸ JavaScript å¼•æ“æ— å…³çš„æŠ½è±¡å±‚ï¼Œè¿™æ ·ä½ å°±å¯ä»¥ç¼–å†™èƒ½åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸Šè¿è¡Œçš„æœ¬åœ°æ’ä»¶ã€‚</p><p>åœ¨ Node.js çš„æ¯ä¸ªæ–°ç‰ˆæœ¬ä¸­ï¼ŒNode-API ä¹Ÿå¯èƒ½ä¼šæœ‰æ›´æ–°ã€‚è¿™äº›æ›´æ–°å¯èƒ½åŒ…æ‹¬æ–°çš„ API å‡½æ•°ã€æ€§èƒ½æ”¹è¿›æˆ–è€…å…¶ä»–å˜åŒ–ã€‚æ¯ä¸ª Node-API çš„ç‰ˆæœ¬éƒ½ä¸ç‰¹å®šçš„ Node.js ç‰ˆæœ¬ç›¸å¯¹åº”ã€‚ä¸ºäº†å¼„æ¸…æ¥šå“ªäº› Node-API ç‰ˆæœ¬å¯ä»¥åœ¨ç‰¹å®šçš„ Node.js ç‰ˆæœ¬ä¸Šä½¿ç”¨ï¼ŒNode.js æä¾›äº†ä¸€ä¸ªç‰ˆæœ¬çŸ©é˜µã€‚</p><p>ä¸‹é¢æˆ‘å°†è§£é‡Šå¦‚ä½•æŸ¥çœ‹å’Œç†è§£ Node-API ç‰ˆæœ¬çŸ©é˜µï¼š</p><ol><li>æ‰“å¼€ Node-API ç‰ˆæœ¬çŸ©é˜µé“¾æ¥ï¼Œä½ å°†çœ‹åˆ°ä¸€å¼ è¡¨æ ¼ã€‚</li><li>è¿™å¼ è¡¨æ ¼åˆ—å‡ºäº†ä¸åŒçš„ Node-API ç‰ˆæœ¬ï¼ˆå³ Node-API v1ã€v2ã€v3 ç­‰ï¼‰ã€‚</li><li>å¯¹äºæ¯ä¸ª Node-API ç‰ˆæœ¬ï¼Œè¡¨æ ¼éƒ½ä¼šæ˜¾ç¤ºå®ƒé¦–æ¬¡å¼•å…¥çš„ Node.js ç‰ˆæœ¬ä»¥åŠå®ƒè¢«åºŸå¼ƒï¼ˆå¦‚æœå·²ç»è¢«åºŸå¼ƒï¼‰çš„ Node.js ç‰ˆæœ¬ã€‚</li></ol><p>ä¾‹å¦‚ï¼Œå‡è®¾ä½ æŸ¥çœ‹çš„ç‰ˆæœ¬çŸ©é˜µå¦‚ä¸‹æ‰€ç¤ºï¼š</p><table><thead><tr><th style="text-align:right;">Node-API</th><th style="text-align:left;">æ”¹åŠ¨</th></tr></thead><tbody><tr><td style="text-align:right;">v8</td><td style="text-align:left;">Added in: v14.0.0, Removed in: <code>&lt;</code>none&gt;</td></tr><tr><td style="text-align:right;">v7</td><td style="text-align:left;">Added in: v13.14.0, Removed in: <code>&lt;</code>none&gt;</td></tr><tr><td style="text-align:right;">v6</td><td style="text-align:left;">Added in: v10.20.0, Removed in: <code>&lt;</code>none&gt;</td></tr></tbody></table><p>è¿™æ„å‘³ç€ï¼š</p><ul><li>Node-API ç‰ˆæœ¬ 8 é¦–æ¬¡å¼•å…¥äº Node.js ç‰ˆæœ¬ 14.0.0ï¼Œå¹¶ä¸”ç›®å‰è¿˜æ²¡æœ‰è¢«ç§»é™¤ï¼›</li><li>Node-API ç‰ˆæœ¬ 7 é¦–æ¬¡å¼•å…¥äº Node.js ç‰ˆæœ¬ 13.14.0ï¼Œä¹Ÿå°šæœªè¢«ç§»é™¤ï¼›</li><li>Node-API ç‰ˆæœ¬ 6 é¦–æ¬¡å¼•å…¥äº Node.js ç‰ˆæœ¬ 10.20.0ï¼ŒåŒæ ·ä¹Ÿæ²¡æœ‰è¢«ç§»é™¤ã€‚</li></ul><p>è¿™æ ·ï¼Œå¦‚æœä½ æ­£åœ¨ä½¿ç”¨ Node.js ç‰ˆæœ¬ 14.xï¼Œä½ å°±å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ Node-API ç‰ˆæœ¬ 8 æˆ–æ›´ä½çš„ç‰ˆæœ¬æ¥æ„å»ºä½ çš„åŸç”Ÿæ’ä»¶ã€‚</p><p>å®é™…è¿ç”¨çš„ä¾‹å­ï¼š</p><ol><li><p>æ¯”å¦‚ä½ æƒ³åˆ›å»ºä¸€ä¸ªæœ¬åœ°æ’ä»¶æ¥åŠ å¿«ä½ çš„åº”ç”¨ç¨‹åºçš„å›¾åƒå¤„ç†é€Ÿåº¦ï¼Œä½ çš„æœåŠ¡å™¨è¿è¡Œçš„æ˜¯ Node.js 14.x ç‰ˆæœ¬ã€‚æ ¹æ®ç‰ˆæœ¬çŸ©é˜µï¼Œä½ å¯ä»¥ä½¿ç”¨ Node-API v8 æ¥ç¼–å†™è¿™ä¸ªæ’ä»¶ï¼Œå› ä¸ºå®ƒå¯ç”¨äº Node.js 14.xã€‚</p></li><li><p>å‡è®¾ä½ éœ€è¦ç”¨åˆ°ä¸€ä¸ªç°æˆçš„æ•°æ®åº“æ’ä»¶ï¼Œä½†è¿™ä¸ªæ’ä»¶æ˜¯åŸºäº Node-API v6 å¼€å‘çš„ã€‚å¦‚æœä½ çš„æœåŠ¡å™¨è¿è¡Œçš„æ˜¯ Node.js ç‰ˆæœ¬ 10.20.0 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œä½ å¯ä»¥æ”¾å¿ƒåœ°ä½¿ç”¨è¯¥æ’ä»¶ã€‚å¦‚æœä½ çš„æœåŠ¡å™¨è¿è¡Œçš„æ˜¯æ›´ä½ç‰ˆæœ¬çš„ Node.jsï¼Œåˆ™éœ€è¦å‡çº§ä½ çš„ Node.js ç‰ˆæœ¬ï¼Œæˆ–å¯»æ‰¾ä¸€ä¸ªå…¼å®¹å½“å‰ç‰ˆæœ¬çš„ç±»ä¼¼æ’ä»¶ã€‚</p></li></ol><p>æ€»ç»“èµ·æ¥ï¼ŒNode-API ç‰ˆæœ¬çŸ©é˜µå¸®åŠ©å¼€å‘è€…ç†è§£å“ªäº› Node-API ç‰ˆæœ¬å¯ä»¥åœ¨ä»–ä»¬çš„ Node.js ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œè¿™æ ·ä»–ä»¬å°±å¯ä»¥é€‰æ‹©æ­£ç¡®çš„ API ç‰ˆæœ¬æ¥ç¼–å†™æˆ–ä½¿ç”¨åŸç”Ÿæ’ä»¶ï¼Œä»¥ç¡®ä¿æœ€ä½³çš„å…¼å®¹æ€§å’Œç¨³å®šæ€§ã€‚</p><h2 id="environment-life-cycle-apis" tabindex="-1"><a class="header-anchor" href="#environment-life-cycle-apis"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#environment-life-cycle-apis" target="_blank" rel="noopener noreferrer">Environment life cycle APIs</a></span></a></h2><p>Node.js ä¸­çš„ Environment Life Cycle APIs æ˜¯ä¸€ç»„ä¸“é—¨çš„ APIï¼Œå®ƒä»¬è¢«ç”¨æ¥ç®¡ç†ä¸ Node.js åº”ç”¨ç›¸å…³è”çš„ç¯å¢ƒï¼ˆenvironmentï¼‰ã€‚æ¯ä¸€ä¸ª Node.js è¿è¡Œå®ä¾‹éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å…³è”çš„ç¯å¢ƒï¼Œè¿™ä¸ªç¯å¢ƒåŒ…å«äº†å½“å‰è¿è¡Œä»£ç æ‰€éœ€çš„æ‰€æœ‰çŠ¶æ€å’Œèµ„æºã€‚</p><p>åœ¨ Node.js v21.7.1 ä¸­ï¼ŒN-API æä¾›äº†ä¸€äº›å…³äºç¯å¢ƒç”Ÿå‘½å‘¨æœŸçš„å‡½æ•°ï¼Œä½¿å¾—åŸç”Ÿæ¨¡å—çš„å¼€å‘è€…å¯ä»¥æ›´å¥½åœ°æ§åˆ¶æ¨¡å—ä¸ Node.js ç¯å¢ƒä¹‹é—´çš„äº¤äº’ã€‚åŸç”Ÿæ¨¡å—æ˜¯ç”¨ C æˆ– C++ ç¼–å†™å¹¶ç¼–è¯‘ä¸ºå…±äº«å¯¹è±¡ï¼Œåœ¨ Node.js ä¸­ç›´æ¥åŠ è½½å’Œè¿è¡Œçš„æ¨¡å—ã€‚</p><p>ä¸‹é¢æˆ‘ä¼šè§£é‡Šä¸€äº›å…³äº Environment Life Cycle ç›¸å…³çš„æ¦‚å¿µï¼Œå¹¶ç»™å‡ºå‡ ä¸ªç®€å•çš„ä¾‹å­æ¥è¯´æ˜å¦‚ä½•ä½¿ç”¨è¿™äº› APIã€‚</p><h3 id="_1-åˆ›å»ºå’Œé”€æ¯ç¯å¢ƒ" tabindex="-1"><a class="header-anchor" href="#_1-åˆ›å»ºå’Œé”€æ¯ç¯å¢ƒ"><span>1. åˆ›å»ºå’Œé”€æ¯ç¯å¢ƒ</span></a></h3><p>å½“ä½ åˆ›å»ºä¸€ä¸ª Node.js åº”ç”¨æ—¶ï¼ŒNode.js ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªç¯å¢ƒã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶å€™åŸç”Ÿæ¨¡å—éœ€è¦ç‹¬ç«‹äºé»˜è®¤ç¯å¢ƒåˆ›å»ºé¢å¤–çš„ç¯å¢ƒã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­æ‰§è¡ŒæŸäº›ä»£ç ï¼Œä½ å¯èƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ç¯å¢ƒã€‚</p><p>åˆ›å»ºç¯å¢ƒçš„ API ç¤ºä¾‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_env env;</span></span>
<span class="line"><span>napi_create_environment(..., &amp;env);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>é”€æ¯ç¯å¢ƒçš„ API ç¤ºä¾‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_env env;</span></span>
<span class="line"><span>napi_destroy_environment(env);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-ç¯å¢ƒæ•°æ®ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#_2-ç¯å¢ƒæ•°æ®ç®¡ç†"><span>2. ç¯å¢ƒæ•°æ®ç®¡ç†</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œä¸€ä¸ªç¯å¢ƒå¯ä»¥å­˜å‚¨å’Œç®¡ç†è®¸å¤šæ•°æ®ï¼Œæ¯”å¦‚å›è°ƒå‡½æ•°ã€å¯¹è±¡å¼•ç”¨ç­‰ã€‚é€šè¿‡ç¯å¢ƒç”Ÿå‘½å‘¨æœŸ APIï¼Œä½ å¯ä»¥åœ¨ç¯å¢ƒä¸­æ·»åŠ æˆ–ç§»é™¤è¿™äº›æ•°æ®ã€‚</p><p>æ·»åŠ ç¯å¢ƒæ•°æ®çš„ API ç¤ºä¾‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_env env;</span></span>
<span class="line"><span>void* data = ...; // æŒ‡å‘ä½ çš„æ•°æ®çš„æŒ‡é’ˆ</span></span>
<span class="line"><span>napi_add_env_cleanup_hook(env, cleanup_cb, data);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œ <code>cleanup_cb</code> æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå®ƒä¼šåœ¨ç¯å¢ƒé”€æ¯æ—¶è¢«è°ƒç”¨ï¼Œä»¥ä¾¿æ¸…ç†ä½ æ·»åŠ çš„æ•°æ®ã€‚</p><p>ç§»é™¤ç¯å¢ƒæ•°æ®çš„ API ç¤ºä¾‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_env env;</span></span>
<span class="line"><span>void* data = ...; // æŒ‡å‘ä½ çš„æ•°æ®çš„æŒ‡é’ˆ</span></span>
<span class="line"><span>napi_remove_env_cleanup_hook(env, cleanup_cb, data);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™äº›å‡½æ•°å…è®¸ä½ ç®¡ç†æ¨¡å—çš„èµ„æºï¼Œç¡®ä¿å®ƒä»¬èƒ½å¤Ÿåœ¨ä¸éœ€è¦çš„æ—¶å€™è¢«é€‚å½“åœ°é‡Šæ”¾ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚</p><h3 id="å®é™…åº”ç”¨ä¸¾ä¾‹" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ä¸¾ä¾‹"><span>å®é™…åº”ç”¨ä¸¾ä¾‹</span></a></h3><p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒNode.js çš„ JavaScript å¼€å‘è€…å¯èƒ½ä¸ä¼šç›´æ¥ä½¿ç”¨è¿™äº›ç¯å¢ƒç”Ÿå‘½å‘¨æœŸ APIï¼Œå› ä¸ºè¿™äº›æ“ä½œé€šå¸¸æ˜¯ç”±åŸç”Ÿæ¨¡å—çš„ä½œè€…åœ¨åº•å±‚å¤„ç†çš„ã€‚ä½†æ˜¯ï¼Œäº†è§£è¿™äº› API å¯ä»¥å¸®åŠ©ä½ ç†è§£åŸç”Ÿæ¨¡å—æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ä¸¾ä¸€äº›å®é™…çš„ä¾‹å­ï¼š</p><ul><li>å¦‚æœä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªæ¶‰åŠå›¾åƒå¤„ç†çš„åŸç”Ÿæ¨¡å—ï¼Œä½ å¯èƒ½éœ€è¦ä¸ºæ¯ä¸ªå¤„ç†ä»»åŠ¡åˆ›å»ºä¸€ä¸ªæ–°çš„ç¯å¢ƒï¼Œå¹¶åœ¨ä»»åŠ¡å®Œæˆåé”€æ¯è¯¥ç¯å¢ƒï¼Œä»¥ç¡®ä¿æ‰€æœ‰çš„èµ„æºéƒ½å¾—åˆ°é‡Šæ”¾ã€‚</li><li>å¦ä¸€ä¸ªä¾‹å­å¯èƒ½æ˜¯å¼€å‘æ•°æ®åº“è¿æ¥æ¨¡å—ï¼Œä½ å¯èƒ½éœ€è¦åœ¨æ¨¡å—åˆå§‹åŒ–æ—¶åˆ›å»ºç¯å¢ƒï¼Œä¿å­˜æ•°æ®åº“è¿æ¥çŠ¶æ€ï¼Œå¹¶åœ¨æ¨¡å—å¸è½½æ—¶é”€æ¯è¿™ä¸ªç¯å¢ƒæ¥å…³é—­æ‰€æœ‰çš„æ•°æ®åº“è¿æ¥ã€‚</li></ul><p>è®°ä½ï¼Œè¿™äº› API å¯¹äºæ™®é€š JavaScript ç”¨æˆ·æ¥è¯´æ˜¯ä¸å¯è§çš„ï¼Œåªæœ‰åœ¨ç¼–å†™æˆ–ç»´æŠ¤ Node.js åŸç”Ÿæ‰©å±•æ—¶ä½ æ‰ä¼šç›´æ¥ä¸å®ƒä»¬æ‰“äº¤é“ã€‚</p><h3 id="napi-set-instance-data" tabindex="-1"><a class="header-anchor" href="#napi-set-instance-data"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_set_instance_data" target="_blank" rel="noopener noreferrer">napi_set_instance_data</a></span></a></h3><p><code>napi_set_instance_data</code> æ˜¯ Node.js ä¸­çš„ N-API åŠŸèƒ½ä¹‹ä¸€ï¼ŒN-API æ˜¯ä¸€ä¸ª C APIï¼Œå®ƒå…è®¸åŸç”Ÿæ’ä»¶ï¼ˆé€šå¸¸ç”¨ C æˆ– C++ç¼–å†™ï¼‰ä¸ Node.js äº¤äº’ã€‚ä½¿ç”¨ <code>napi_set_instance_data</code> å‡½æ•°å¯ä»¥è®©ä½ åœ¨åŸç”Ÿæ¨¡å—ä¸­å‚¨å­˜ç‰¹å®šçš„æ•°æ®ï¼Œå¹¶ä¸”è¿™äº›æ•°æ®æ˜¯ä¸å½“å‰ Node.js å®ä¾‹ï¼ˆé€šå¸¸æŒ‡çš„æ˜¯è¿è¡Œä¸­çš„ Node.js åº”ç”¨ç¨‹åºæˆ–è¿›ç¨‹ï¼‰ç»‘å®šçš„ã€‚</p><p>ç°åœ¨è®©æˆ‘ä»¬è¯¦ç»†è§£é‡Šä¸€ä¸‹ <code>napi_set_instance_data</code> è¿™ä¸ªå‡½æ•°ã€‚</p><p>é¦–å…ˆï¼Œ<code>napi_set_instance_data</code> å¯ä»¥å¸®åŠ©æˆ‘ä»¬ä¿å­˜ä¸€äº›è·¨åŸç”Ÿæ–¹æ³•è°ƒç”¨ä¿æŒä¸å˜çš„æ•°æ®ã€‚æ¯”å¦‚ï¼Œå¦‚æœä½ çš„åŸç”Ÿæ¨¡å—éœ€è¦ä¸€ä¸ªé…ç½®å¯¹è±¡ï¼Œæˆ–è€…éœ€è¦ä¸€ä¸ªçŠ¶æ€æ¥è¡¨ç¤ºæŸç§èµ„æºæ˜¯å¦å·²ç»åˆå§‹åŒ–ï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ã€‚</p><p>å‡½æ•°ç­¾åå¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_set_instance_data(</span></span>
<span class="line"><span>    napi_env env,</span></span>
<span class="line"><span>    void* data,</span></span>
<span class="line"><span>    napi_finalize finalize_cb,</span></span>
<span class="line"><span>    void* finalize_hint);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªå‡½æ•°æ¥å—ä»¥ä¸‹å‚æ•°ï¼š</p><ul><li><code>env</code>ï¼šæ˜¯ä¸€ä¸ªä»£è¡¨ Node.js è¿è¡Œæ—¶ç¯å¢ƒçš„å¥æŸ„ã€‚</li><li><code>data</code>ï¼šæ˜¯ä½ æƒ³è¦å­˜å‚¨çš„æ•°æ®çš„æŒ‡é’ˆã€‚</li><li><code>finalize_cb</code>ï¼šå½“å®ä¾‹é”€æ¯æˆ–æ•°æ®ä¸å†éœ€è¦æ—¶ï¼Œå°†è°ƒç”¨çš„å›è°ƒå‡½æ•°ï¼Œå¯ä»¥ç”¨äºæ¸…ç†èµ„æºã€‚</li><li><code>finalize_hint</code>ï¼šæ˜¯ä¸€ä¸ªé¢å¤–çš„æç¤ºå‚æ•°ï¼Œå°†ä¼ é€’ç»™ <code>finalize_cb</code> å›è°ƒå‡½æ•°ã€‚</li></ul><p>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è¯´æ˜å…¶ç”¨æ³•ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ‰©å±•ï¼Œéœ€è¦ä¿å­˜ä¸€ä¸ªå…¨å±€è®¡æ•°å™¨ï¼Œæ¯æ¬¡è°ƒç”¨ä¸€ä¸ªç‰¹å®šçš„å‡½æ•°æ—¶ï¼Œéƒ½ä¼šå¢åŠ è¿™ä¸ªè®¡æ•°å™¨ã€‚ä¸ºäº†å­˜å‚¨å’Œè®¿é—®è¿™ä¸ªè®¡æ•°å™¨ï¼Œä½ å¯èƒ½ä¼šé€‰æ‹©ä½¿ç”¨ <code>napi_set_instance_data</code>ã€‚</p><ol><li>é¦–å…ˆï¼Œå®šä¹‰ä½ çš„è®¡æ•°å™¨å’Œæ¸…ç†å‡½æ•°ï¼š</li></ol><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>static int counter = 0; // å‡è®¾è¿™æ˜¯ä½ æƒ³è¦å…¨å±€ä¿å­˜çš„æ•°æ®</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void cleanup_counter(napi_env env, void* data, void* hint) {</span></span>
<span class="line"><span>    // å› ä¸ºæˆ‘ä»¬ä»…ä»…ä¿å­˜äº†ä¸€ä¸ªé™æ€æ•´æ•°ï¼Œæ‰€ä»¥è¿™é‡Œå¯èƒ½ä¸éœ€è¦æ‰§è¡Œä»»ä½•ç‰¹æ®Šçš„æ¸…ç†å·¥ä½œ</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>ç„¶åï¼Œåœ¨æ¨¡å—åˆå§‹åŒ–çš„æ—¶å€™è®¾ç½®è¿™ä¸ªæ•°æ®ï¼š</li></ol><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    // è®¾ç½®å®ä¾‹æ•°æ®</span></span>
<span class="line"><span>    napi_status status = napi_set_instance_data(</span></span>
<span class="line"><span>        env,</span></span>
<span class="line"><span>        &amp;counter,</span></span>
<span class="line"><span>        cleanup_counter,</span></span>
<span class="line"><span>        NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>æ¥ç€ï¼Œæ¯æ¬¡ç›¸å…³å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œä½ å¯ä»¥æ›´æ–°è®¡æ•°å™¨ï¼š</li></ol><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>void IncrementCounter(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // æˆ‘ä»¬æœ¬ä¾‹ä¸­ä¸éœ€è¦è·å– instance data</span></span>
<span class="line"><span>    // å› ä¸ºç›´æ¥è®¿é—®é™æ€å˜é‡ &#39;counter&#39; å°±è¶³å¤Ÿäº†</span></span>
<span class="line"><span>    counter++;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ...å…¶ä»–ä»£ç ï¼Œå¯èƒ½åŒ…æ‹¬è¿”å›æ–°çš„è®¡æ•°å™¨å€¼ç»™JavaScript</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·ï¼Œæ— è®ºä½•æ—¶è°ƒç”¨ <code>IncrementCounter</code> å‡½æ•°ï¼ŒåŒä¸€ä¸ª <code>counter</code> å°±ä¼šè¢«æ›´æ–°ï¼Œå› ä¸ºå®ƒæ˜¯ç»‘å®šåˆ° Node.js å®ä¾‹çš„ã€‚</p><p>è®°ä½ï¼Œ<code>napi_set_instance_data</code> æ›´å¤šä½¿ç”¨åœºæ™¯æ˜¯å½“ä½ éœ€è¦åœ¨åŸç”Ÿæ¨¡å—ä¸­å­˜å‚¨æŒ‡å‘å¤æ‚æ•°æ®ç»“æ„ï¼ˆä¾‹å¦‚åŠ¨æ€åˆ†é…çš„å†…å­˜ã€è‡ªå®šä¹‰ç±»å‹çš„å®ä¾‹ç­‰ï¼‰çš„æŒ‡é’ˆæ—¶ã€‚</p><p>æ­¤å‡½æ•°é€‚ç”¨äºéœ€è¦åˆ›å»ºåªåœ¨å•ä¸ª Node.js å®ä¾‹ä¸­å…±äº«çš„æ•°æ®çš„åœºæ™¯ï¼Œè€Œä¸æ˜¯è·¨ä¸åŒåŠ è½½çš„æ¨¡å—æˆ–ä¸åŒ Node.js è¿›ç¨‹å…±äº«ã€‚å¦‚æœä½ éœ€è¦è·¨å®ä¾‹å…±äº«æ•°æ®ï¼Œåˆ™éœ€è¦å¯»æ‰¾å…¶ä»–æœºåˆ¶ï¼Œå¦‚ä½¿ç”¨é™æ€å˜é‡æˆ–å¤–éƒ¨å­˜å‚¨ç³»ç»Ÿã€‚</p><h3 id="napi-get-instance-data" tabindex="-1"><a class="header-anchor" href="#napi-get-instance-data"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_instance_data" target="_blank" rel="noopener noreferrer">napi_get_instance_data</a></span></a></h3><p>Node.js ä¸­çš„ N-APIï¼ˆåŸç”Ÿ APIï¼‰æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºåŸç”Ÿæ’ä»¶çš„æ¥å£ã€‚åŸç”Ÿæ’ä»¶æ˜¯æŒ‡ä½¿ç”¨ C æˆ– C++ ç¼–å†™çš„æ¨¡å—ï¼Œå¯ç›´æ¥é€šè¿‡ Node.js çš„è¿è¡Œæ—¶ç¯å¢ƒè°ƒç”¨ã€‚N-API æ—¨åœ¨æä¾›ä¸€ä¸ªä¸ JavaScript è¿è¡Œæ—¶æ— å…³çš„æŠ½è±¡å±‚ï¼Œè¿™æ„å‘³ç€ä½¿ç”¨å®ƒç¼–å†™çš„æ’ä»¶ä¸ä¾èµ–äºç‰¹å®šç‰ˆæœ¬çš„ Node.jsã€‚</p><p><code>napi_get_instance_data</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå…è®¸ä½ ä»å½“å‰çš„ Node.js æ’ä»¶å®ä¾‹ä¸­è·å–ä¹‹å‰å­˜å‚¨çš„æ•°æ®ã€‚è¿™ä¸ªåŠŸèƒ½å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºå®ƒèƒ½å¤Ÿå¸®åŠ©ä½ ç»´æŠ¤ä¸€äº›çŠ¶æ€ä¿¡æ¯ï¼Œè€Œæ— éœ€å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨å…¨å±€å˜é‡ä¸­ã€‚</p><p>å½“ä½ åˆ›å»ºä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œå¹¶ä¸”å¸Œæœ›è·Ÿè¸ªä¸€äº›ä¸æ’ä»¶å®ä¾‹ç›¸å…³çš„æ•°æ®æ—¶ï¼Œ<code>napi_get_instance_data</code> å°±éå¸¸æœ‰ç”¨äº†ã€‚è¿™ä¸ªå‡½æ•°å¯ä»¥å¸®åŠ©ä½ æ£€ç´¢å…ˆå‰é€šè¿‡ <code>napi_set_instance_data</code> å‡½æ•°è®¾ç½®çš„æ•°æ®ã€‚</p><h3 id="ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹"><span>ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹</span></a></h3><ol><li><p><strong>è®¡æ•°å™¨æ’ä»¶</strong>ï¼šå‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œè¯¥æ’ä»¶ç»´æŠ¤ä¸€ä¸ªç®€å•çš„è®¡æ•°å™¨ã€‚æ¯æ¬¡è°ƒç”¨æ’ä»¶å‡½æ•°æ—¶ï¼Œè®¡æ•°å™¨éƒ½ä¼šé€’å¢ã€‚ä¸ºäº†è·Ÿè¸ªè¿™ä¸ªè®¡æ•°å™¨ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>napi_set_instance_data</code> åœ¨åˆå§‹åŒ–æ—¶å­˜å‚¨å®ƒï¼Œå¹¶åœ¨åç»­çš„å‡½æ•°è°ƒç”¨ä¸­ä½¿ç”¨ <code>napi_get_instance_data</code> æ¥è·å–å½“å‰çš„è®¡æ•°å€¼ã€‚</p></li><li><p><strong>æ•°æ®åº“è¿æ¥</strong>ï¼šå¦‚æœä½ çš„æ’ä»¶è´Ÿè´£ç®¡ç†æ•°æ®åº“è¿æ¥ï¼Œåˆ™å¯ä»¥åœ¨æ’ä»¶åˆå§‹åŒ–æ—¶åˆ›å»ºä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œå¹¶ä½¿ç”¨ <code>napi_set_instance_data</code> å­˜å‚¨è¯¥è¿æ¥çš„å¼•ç”¨ã€‚éšåï¼Œæ¯å½“éœ€è¦æ‰§è¡Œæ•°æ®åº“æ“ä½œæ—¶ï¼Œå°±å¯ä»¥é€šè¿‡ <code>napi_get_instance_data</code> è·å–åˆ°è¿™ä¸ªæ•°æ®åº“è¿æ¥ï¼Œå¹¶ä½¿ç”¨å®ƒè¿›è¡ŒæŸ¥è¯¢æˆ–æ›´æ–°æ“ä½œã€‚</p></li><li><p><strong>é…ç½®ä¿¡æ¯</strong>ï¼šå¦‚æœä½ çš„æ’ä»¶éœ€è¦åŠ è½½å’Œå­˜å‚¨ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨æ’ä»¶å¯åŠ¨æ—¶è¯»å–è¿™äº›é…ç½®ï¼Œå¹¶é€šè¿‡ <code>napi_set_instance_data</code> å­˜å‚¨èµ·æ¥ã€‚ä»¥åæ¯æ¬¡æ’ä»¶éœ€è¦è¿™äº›é…ç½®ä¿¡æ¯æ—¶ï¼Œéƒ½å¯ä»¥é€šè¿‡ <code>napi_get_instance_data</code> æ¥è·å–ã€‚</p></li></ol><h3 id="ç¤ºä¾‹ä»£ç ç‰‡æ®µ" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹ä»£ç ç‰‡æ®µ"><span>ç¤ºä¾‹ä»£ç ç‰‡æ®µ</span></a></h3><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ <code>napi_get_instance_data</code> çš„ä¼ªä»£ç ç¤ºä¾‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç»“æ„ä½“æ¥ä¿å­˜æˆ‘ä»¬çš„å®ä¾‹æ•°æ®</span></span>
<span class="line"><span>typedef struct {</span></span>
<span class="line"><span>  int counter; // ç”¨äºç¤ºä¾‹çš„è®¡æ•°å™¨</span></span>
<span class="line"><span>} MyInstanceData;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡½æ•°ç”¨äºè·å–å®ä¾‹æ•°æ®</span></span>
<span class="line"><span>napi_value GetCounter(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  MyInstanceData* instance_data;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // é€šè¿‡ napi_get_instance_data è·å–å®ä¾‹æ•°æ®</span></span>
<span class="line"><span>  napi_status status = napi_get_instance_data(env, (void**)&amp;instance_data);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯æƒ…å†µ...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ç°åœ¨ä½ å¯ä»¥è®¿é—® instance_data-&gt;counter å¹¶æ ¹æ®éœ€è¦æ“ä½œå®ƒäº†</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›è®¡æ•°å™¨çš„å½“å‰å€¼ä½œä¸º JavaScript æ•°å­—</span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span>  status = napi_create_int32(env, instance_data-&gt;counter, &amp;result);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯æƒ…å†µ...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¯¥å‡½æ•°å¯èƒ½ä¼šåœ¨æ’ä»¶åˆå§‹åŒ–æ—¶è¢«è°ƒç”¨ï¼Œå®ƒä¼šè®¾ç½®å®ä¾‹æ•°æ®</span></span>
<span class="line"><span>void Initialize(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>  MyInstanceData* instance_data = malloc(sizeof(MyInstanceData));</span></span>
<span class="line"><span>  instance_data-&gt;counter = 0; // åˆå§‹åŒ–è®¡æ•°å™¨</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ä½¿ç”¨ napi_set_instance_data å­˜å‚¨å®ä¾‹æ•°æ®</span></span>
<span class="line"><span>  napi_status status = napi_set_instance_data(</span></span>
<span class="line"><span>    env,</span></span>
<span class="line"><span>    instance_data,</span></span>
<span class="line"><span>    NULL, // è¿™é‡Œå¯ä»¥æä¾›ä¸€ä¸ªææ„å‡½æ•°ï¼Œç”¨æ¥åœ¨æ’ä»¶å¸è½½æ—¶æ¸…ç†èµ„æº</span></span>
<span class="line"><span>    NULL</span></span>
<span class="line"><span>  );</span></span>
<span class="line"><span>  // ç¡®ä¿ status == napi_okï¼Œå¦åˆ™å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>napi_get_instance_data</code> å‡½æ•°åœ¨ä¸€ä¸ªåŸç”Ÿæ’ä»¶ä¸­è·å–å®ä¾‹æ•°æ®ã€‚è®°ä½ï¼Œä¸ºäº†ä½¿ä»£ç æ­£å¸¸å·¥ä½œï¼Œä½ è¿˜éœ€è¦å®ç°å…¶ä»–ä¸€äº›éƒ¨åˆ†ï¼Œæ¯”å¦‚æ’ä»¶çš„æ³¨å†Œé€»è¾‘åŠå…¶å®ƒå¿…è¦çš„é”™è¯¯å¤„ç†ã€‚</p><h2 id="basic-node-api-data-types" tabindex="-1"><a class="header-anchor" href="#basic-node-api-data-types"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#basic-node-api-data-types" target="_blank" rel="noopener noreferrer">Basic Node-API data types</a></span></a></h2><p>Node-APIï¼ˆä»¥å‰ç§°ä¸º N-APIï¼‰æ˜¯ Node.js çš„ä¸€ä¸ªæ¥å£å±‚ï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨ C æˆ– C++ ç¼–å†™æ‰©å±•æ¥å’Œ JavaScript ä»£ç äº¤äº’ã€‚Node-API è®¾è®¡çš„ç›®æ ‡æ˜¯å‡å°‘ä¸åº•å±‚ JavaScript å¼•æ“çš„ç›´æ¥äº¤äº’ï¼Œè¿™æ ·ç¼–å†™çš„æ‰©å±•å°±èƒ½å¤Ÿåœ¨ Node.js çš„ä¸åŒç‰ˆæœ¬ä¹‹é—´ä¿æŒå…¼å®¹ã€‚</p><p>åœ¨ Node-API ä¸­æœ‰ä¸€äº›â€œåŸºæœ¬æ•°æ®ç±»å‹â€ï¼Œè¿™äº›æ•°æ®ç±»å‹ä»£è¡¨äº† JavaScript å€¼å’Œç±»å‹åœ¨ C/C++ å±‚é¢ä¸Šçš„ç­‰æ•ˆè¡¨ç¤ºã€‚ç†è§£è¿™äº›åŸºæœ¬æ•°æ®ç±»å‹å¯¹äºç¼–å†™å¯é ã€é«˜æ•ˆçš„åŸç”Ÿæ‰©å±•éå¸¸é‡è¦ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€äº› Node-API ä¸­çš„åŸºæœ¬æ•°æ®ç±»å‹åŠå…¶ç®€å•æè¿°ï¼š</p><ol><li><code>napi_value</code>: ä»£è¡¨ä¸€ä¸ª JavaScript å€¼ã€‚æ— è®ºæ˜¯ä¸ªæ•°å­—ã€å­—ç¬¦ä¸²è¿˜æ˜¯å¯¹è±¡ï¼Œåœ¨ C/C++ å±‚é¢ä¸Šéƒ½ç”¨ <code>napi_value</code> è¡¨ç¤ºã€‚</li><li><code>napi_env</code>: ä»£è¡¨ä¸€ä¸ª Node-API è°ƒç”¨ç¯å¢ƒï¼Œæ‰€æœ‰çš„ Node-API å‡½æ•°è°ƒç”¨éƒ½éœ€è¦è¿™ä¸ªç¯å¢ƒä½œä¸ºå‚æ•°ä¹‹ä¸€ï¼Œå› ä¸ºå®ƒåŒ…å«äº† Node-API æ“ä½œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li><li><code>napi_callback_info</code>: å½“ JavaScript è°ƒç”¨ä¸€ä¸ªç”± C/C++ æä¾›çš„å‡½æ•°æ—¶ï¼Œä¼šå°†ç›¸å…³ä¿¡æ¯æ‰“åŒ…è¿›ä¸€ä¸ª <code>napi_callback_info</code> ç±»å‹ä¸­ï¼Œæ¯”å¦‚å‡½æ•°è¢«è°ƒç”¨æ—¶çš„å‚æ•°ã€‚</li><li><code>napi_ref</code>: ä»£è¡¨ä¸€ä¸ªå¯¹ JavaScript å¯¹è±¡çš„å¼ºå¼•ç”¨ï¼Œè¿™å¯ä»¥é˜²æ­¢è¯¥å¯¹è±¡åœ¨å®ƒä»ç„¶è¢« C/C++ æ‰©å±•ä½¿ç”¨æ—¶è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚</li><li><code>napi_handle_scope</code>: ç®¡ç†å±€éƒ¨ <code>napi_value</code> å¥æŸ„çš„ç”Ÿå‘½å‘¨æœŸï¼Œç”¨äºæ§åˆ¶å†…å­˜åˆ†é…ï¼Œç¡®ä¿åœ¨å½“å‰ä½œç”¨åŸŸç»“æŸæ—¶é‡Šæ”¾å±€éƒ¨å¥æŸ„ã€‚</li><li><code>napi_escapable_handle_scope</code>: ç±»ä¼¼ <code>napi_handle_scope</code>ï¼Œä½†å…è®¸ä¸€ä¸ªå¥æŸ„ä»ä¸€ä¸ªä½œç”¨åŸŸâ€œé€ƒé€¸â€åˆ°çˆ¶ä½œç”¨åŸŸã€‚</li><li><code>napi_callback_scope</code>: ä¸æ­£åœ¨æ‰§è¡Œçš„ JavaScript å‡½æ•°å…³è”çš„ä½œç”¨åŸŸã€‚</li><li><code>napi_async_work</code>: è¡¨ç¤ºå¼‚æ­¥å·¥ä½œçš„å¥æŸ„ï¼Œé€šè¿‡è¿™ä¸ªå¯ä»¥åœ¨åå°çº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡è€Œä¸ä¼šé˜»å¡ JavaScript ä¸»çº¿ç¨‹ã€‚</li><li><code>napi_deferred</code>: ä»£è¡¨ä¸€ä¸ªå»¶è¿Ÿçš„æ“ä½œï¼Œé€šå¸¸ä¸ Promise ç»“åˆä½¿ç”¨ï¼Œå…è®¸ä»åŸç”Ÿä»£ç ä¸­åˆ›å»ºå¯è§£ææˆ–æ‹’ç»çš„ Promise å¯¹è±¡ã€‚</li></ol><p>å®ä¾‹è¿ç”¨ï¼š</p><p>å‡è®¾ä½ æƒ³åœ¨ Node.js ä¸­åˆ›å»ºä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œç”¨æ¥åŠ å¯†å­—ç¬¦ä¸²ã€‚ä½ å¯èƒ½éœ€è¦ç¼–å†™ä¸€ä¸ª C åŠŸèƒ½æ¥å®ŒæˆåŠ å¯†å·¥ä½œï¼Œå¹¶ä¸”åˆ©ç”¨ Node-API æŠŠè¿™ä¸ªåŠŸèƒ½æš´éœ²ç»™ JavaScriptã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å®é™…çš„åŠ å¯†å‡½æ•°</span></span>
<span class="line"><span>void EncryptString(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // è·å–å‡½æ•°å‚æ•°</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°† napi_value è½¬æ¢ä¸º C å­—ç¬¦ä¸²</span></span>
<span class="line"><span>    char* originalStr;</span></span>
<span class="line"><span>    size_t str_len;</span></span>
<span class="line"><span>    napi_get_value_string_utf8(env, args[0], NULL, 0, &amp;str_len);</span></span>
<span class="line"><span>    originalStr = (char*) malloc(str_len + 1);</span></span>
<span class="line"><span>    napi_get_value_string_utf8(env, args[0], originalStr, str_len + 1, &amp;str_len);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿™é‡Œæ˜¯åŠ å¯†æ“ä½œï¼ˆçœç•¥å®ç°ï¼‰</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    free(originalStr);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºè¿”å›å€¼</span></span>
<span class="line"><span>    napi_value returnValue;</span></span>
<span class="line"><span>    napi_create_string_utf8(env, &quot;encrypted string&quot;, NAPI_AUTO_LENGTH, &amp;returnValue);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return returnValue;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ¨¡å—åˆå§‹åŒ–å‡½æ•°</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, EncryptString, NULL, &amp;fn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;encrypt&quot;, fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>EncryptString</code> çš„ C å‡½æ•°ä½œä¸º Node-API æ¥å£ã€‚è¿™ä¸ªå‡½æ•°é€šè¿‡ <code>napi_get_cb_info</code> ä» JavaScript ä¸–ç•Œè·å–å‚æ•°ï¼Œå¹¶ä¸”å°† JavaScript å­—ç¬¦ä¸²è½¬æ¢ä¸º C å­—ç¬¦ä¸²ã€‚ä¹‹åï¼Œæˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªå‡è®¾çš„åŠ å¯†æ“ä½œï¼Œæœ€ååˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å­—ç¬¦ä¸²ï¼ˆåŠ å¯†ç»“æœï¼‰å¹¶è¿”å›ã€‚</p><p>æœ€ç»ˆï¼Œè¿™ä¸ªåŸç”Ÿæ¨¡å—é€šè¿‡ <code>Init</code> å‡½æ•°ï¼ˆä½œä¸ºæ¨¡å—åˆå§‹åŒ–å…¥å£ç‚¹ï¼‰åœ¨ Node.js ä¸­æ³¨å†Œäº† <code>encrypt</code> å‡½æ•°ã€‚JavaScript å¼€å‘è€…å°±å¯ä»¥åƒä½¿ç”¨æ™®é€šçš„ JavaScript å‡½æ•°ä¸€æ ·ï¼Œä½¿ç”¨ <code>require</code> å¯¼å…¥è¿™ä¸ªæ¨¡å—ï¼Œå¹¶è°ƒç”¨å…¶ä¸­çš„ <code>encrypt</code> å‡½æ•°è¿›è¡Œå­—ç¬¦ä¸²åŠ å¯†ã€‚</p><h3 id="napi-status" tabindex="-1"><a class="header-anchor" href="#napi-status"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_status" target="_blank" rel="noopener noreferrer">napi_status</a></span></a></h3><p>Node.js ä¸­çš„ N-APIï¼ˆNode.js APIï¼‰æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ç¨³å®šçº§åˆ«çš„ APIã€‚å®ƒå…è®¸ä½ ä¸ç›´æ¥ä½¿ç”¨ V8 æˆ–å…¶ä»– JavaScript å¼•æ“çš„ APIï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ç»„å›ºå®šçš„ C API æ¥ç¼–å†™å¯è·¨ä¸åŒç‰ˆæœ¬çš„ Node.js è¿è¡Œçš„åŸç”Ÿä»£ç ã€‚</p><p>åœ¨ N-API ä¸­ï¼Œ<code>napi_status</code> æ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œå®ƒä»£è¡¨äº† N-API å‡½æ•°è°ƒç”¨çš„è¿”å›çŠ¶æ€ï¼Œå³å‡½æ•°æ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥çš„çŠ¶æ€ç ã€‚æ¯ä¸ª N-API è°ƒç”¨éƒ½ä¼šè¿”å›ä¸€ä¸ª <code>napi_status</code> å€¼ï¼Œä»¥æŒ‡ç¤ºæ“ä½œæ˜¯å¦æˆåŠŸï¼Œä»¥åŠå¦‚æœ‰é”™è¯¯ï¼Œå…¶æ€§è´¨ä¸ºä½•ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€äº›ä¾‹å­æ¥è§£é‡Š <code>napi_status</code> çš„ä¸åŒå€¼ï¼š</p><ol><li><code>napi_ok</code>: è¡¨ç¤ºè°ƒç”¨æˆåŠŸå®Œæˆï¼Œæ²¡æœ‰é”™è¯¯å‘ç”Ÿã€‚</li><li><code>napi_invalid_arg</code>: è¡¨ç¤ºä¼ é€’ç»™å‡½æ•°çš„æŸä¸ªå‚æ•°æ— æ•ˆã€‚</li><li><code>napi_object_expected</code>: å½“ API æœŸæœ›ä¸€ä¸ªå¯¹è±¡ï¼Œä½†æ²¡æœ‰æ”¶åˆ°å¯¹è±¡æ—¶è¿”å›è¿™ä¸ªçŠ¶æ€ã€‚</li><li><code>napi_string_expected</code>: å½“ API æœŸæœ›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†å¾—åˆ°çš„ä¸æ˜¯å­—ç¬¦ä¸²æ—¶è¿”å›è¿™ä¸ªçŠ¶æ€ã€‚</li><li><code>napi_name_already_registered</code>: å½“å°è¯•æ³¨å†Œå·²ç»å­˜åœ¨çš„åç§°æ—¶è¿”å›è¿™ä¸ªçŠ¶æ€ç ã€‚</li><li><code>napi_generic_failure</code>: è¡¨ç¤ºå‡ºç°äº†æœªåˆ†ç±»çš„é€šç”¨é”™è¯¯ã€‚</li><li><code>napi_pending_exception</code>: è¡¨ç¤º JavaScript å¼•æ“ä¸­å­˜åœ¨å¾…å¤„ç†çš„å¼‚å¸¸ï¼Œé˜»å¡äº† N-API è°ƒç”¨çš„æ­£å¸¸æ‰§è¡Œã€‚</li></ol><p>è¿™äº›çŠ¶æ€ç å¯¹å¼€å‘è€…æ¥è¯´å¾ˆé‡è¦ï¼Œå› ä¸ºå®ƒä»¬æä¾›äº†å…³äºåŸç”Ÿæ’ä»¶ä¸­å‘ç”Ÿä»€ä¹ˆçš„ç›´æ¥åé¦ˆï¼Œå¹¶å¯ä»¥æ®æ­¤é‡‡å–ç›¸åº”çš„é”™è¯¯å¤„ç†æªæ–½ã€‚</p><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-1" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-1"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h3><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨åˆ›å»ºä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€ä¸ªéœ€è¦ä» JavaScript ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œå¤„ç†çš„å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥æ£€æŸ¥ä¼ å…¥çš„å‚æ•°å¹¶æ ¹æ®å…¶çŠ¶æ€é‡‡å–è¡ŒåŠ¨ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value argv[1];</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–JavaScriptä¼ é€’çš„å‚æ•°</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, argv, NULL, NULL);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†è·å–å‚æ•°æ—¶å‡ºç°çš„é”™è¯¯</span></span>
<span class="line"><span>        // ...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç¡®ä¿ä¼ å…¥çš„æ˜¯å­—ç¬¦ä¸²</span></span>
<span class="line"><span>    napi_valuetype valuetype;</span></span>
<span class="line"><span>    status = napi_typeof(env, argv[0], &amp;valuetype);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†è·å–å‚æ•°ç±»å‹æ—¶å‡ºç°çš„é”™è¯¯</span></span>
<span class="line"><span>        // ...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (valuetype != napi_string) {</span></span>
<span class="line"><span>        // æŠ›å‡ºé”™è¯¯: æˆ‘ä»¬æœŸæœ›ä¸€ä¸ªå­—ç¬¦ä¸²</span></span>
<span class="line"><span>        napi_throw_type_error(env, NULL, &quot;String was expected&quot;);</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œåˆ™ç»§ç»­å¤„ç†å­—ç¬¦ä¸²...</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›ä¸€äº›ç»“æœ</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ¨¡å—åˆå§‹åŒ–å‡½æ•°</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, MyFunction, NULL, &amp;fn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;myFunction&quot;, fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆè°ƒç”¨ <code>napi_get_cb_info</code> æ¥è·å–ä» JavaScript ä¼ é€’çš„å‚æ•°ã€‚å¦‚æœå‡ºé”™ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¿”å›çš„ <code>napi_status</code> æ¥ç¡®å®šé”™è¯¯çš„ç±»å‹å¹¶é‡‡å–ç›¸åº”çš„æªæ–½ã€‚ç„¶åæˆ‘ä»¬æ£€æŸ¥ä¼ å…¥å‚æ•°çš„ç±»å‹æ˜¯å¦ä¸ºå­—ç¬¦ä¸²ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™æŠ›å‡ºç±»å‹é”™è¯¯ã€‚</p><p>é€šè¿‡è¿™æ ·çš„æœºåˆ¶ï¼Œå¼€å‘è€…èƒ½å¤Ÿä»¥ç¨³å¥çš„æ–¹å¼æ„å»ºåŸç”Ÿæ‰©å±•ï¼Œç¡®ä¿æ­£ç¡®åœ°å¤„ç†è¾“å…¥å¹¶åœ¨å‡ºç°é—®é¢˜æ—¶æä¾›æœ‰ç”¨çš„é”™è¯¯ä¿¡æ¯ã€‚</p><h3 id="napi-extended-error-info" tabindex="-1"><a class="header-anchor" href="#napi-extended-error-info"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_extended_error_info" target="_blank" rel="noopener noreferrer">napi_extended_error_info</a></span></a></h3><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ª C çº§åˆ«çš„ APIï¼Œå®ƒå…è®¸æœ¬åœ°æ’ä»¶ï¼ˆé€šå¸¸ç”¨ C æˆ– C++ç¼–å†™ï¼‰ä¸ JavaScript ä»£ç é€šä¿¡ã€‚N-API æ—¨åœ¨ä¸ºæ„å»ºè¿™äº›æœ¬åœ°æ’ä»¶æä¾›ç¨³å®šå’Œå…¼å®¹ä¸åŒç‰ˆæœ¬çš„ Node.js çš„æ¥å£ã€‚</p><p><code>napi_extended_error_info</code>ç»“æ„ä½“æ˜¯ N-API ä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œå®ƒæä¾›äº†å…³äºå‘ç”Ÿé”™è¯¯çš„è¯¦ç»†ä¿¡æ¯ã€‚å½“ N-API å‡½æ•°è¿”å›é”™è¯¯æ—¶ï¼Œè¿™ä¸ªç»“æ„ä½“ä¼šåŒ…å«æœ‰åŠ©äºè°ƒè¯•å’Œé”™è¯¯å¤„ç†çš„é™„åŠ ä¿¡æ¯ã€‚</p><p>ä¸‹é¢æˆ‘ä¼šè§£é‡Šä»€ä¹ˆæ˜¯<code>napi_extended_error_info</code>ï¼Œå¹¶ä¸¾ä¸€äº›å¯èƒ½çš„åº”ç”¨åœºæ™¯ï¼š</p><h3 id="napi-extended-error-info-1" tabindex="-1"><a class="header-anchor" href="#napi-extended-error-info-1"><span><code>napi_extended_error_info</code></span></a></h3><p><code>napi_extended_error_info</code> æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼ˆC è¯­è¨€ä¸­çš„ä¸€ç§æ•°æ®ç±»å‹ï¼Œå¯ä»¥åŒ…å«å¤šä¸ªå…¶ä»–ç±»å‹çš„å˜é‡ï¼‰ï¼Œå®ƒå®šä¹‰äº†ä¸ N-API æ“ä½œç›¸å…³çš„é”™è¯¯è¯¦æƒ…ã€‚è¿™ä¸ªç»“æ„ä½“é‡Œé€šå¸¸åŒ…å«ä»¥ä¸‹å­—æ®µï¼š</p><ul><li><code>const char* error_message</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘é”™è¯¯æ¶ˆæ¯å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€‚é”™è¯¯æ¶ˆæ¯æä¾›äº†é—®é¢˜çš„æè¿°ã€‚</li><li><code>void* engine_reserved</code>: è¿™æ˜¯ä¿ç•™ç»™ JavaScript å¼•æ“è‡ªèº«ä½¿ç”¨çš„æ•°æ®ï¼›å¯¹äºæ’ä»¶å¼€å‘è€…æ¥è¯´é€šå¸¸æ˜¯ä¸å¯è§çš„ã€‚</li><li><code>void* engine_error_code</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘ç‰¹å®šäºå¼•æ“çš„é”™è¯¯ä»£ç çš„æŒ‡é’ˆã€‚</li><li><code>uint32_t error_code</code>: è¿™æ˜¯ N-API çš„é”™è¯¯ç ï¼Œå®ƒè¡¨ç¤ºé”™è¯¯çš„å…·ä½“ç±»å‹ã€‚</li></ul><h4 id="å®é™…è¿ç”¨ä¾‹å­-1" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-1"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªæœ¬åœ°æ’ä»¶æ¥æé«˜åº”ç”¨ç¨‹åºæ€§èƒ½ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªå‹ç¼©å›¾ç‰‡çš„æ’ä»¶ã€‚ä½ å¯èƒ½ä¼šç”¨ C æˆ– C++ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥å¤„ç†å›¾ç‰‡æ–‡ä»¶ï¼Œå¹¶é€šè¿‡ N-API å°†å…¶æš´éœ²ç»™ Node.jsã€‚</p><p>å½“ä½ åœ¨æ’ä»¶å†…è°ƒç”¨ä¸€ä¸ª N-API å‡½æ•°æ—¶ï¼Œæ¯”å¦‚<code>napi_create_string_utf8</code>æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªè°ƒç”¨å¯èƒ½å› ä¸ºå„ç§åŸå› å¤±è´¥ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœç³»ç»Ÿå†…å­˜ä¸è¶³ï¼‰ã€‚å¦‚æœè¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªè¡¨ç¤ºå¤±è´¥çš„çŠ¶æ€ç ï¼Œä½ å¯ä»¥è·å–<code>napi_extended_error_info</code>ç»“æ„ä½“æ¥æŸ¥çœ‹é”™è¯¯è¯¦æƒ…ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span>// ... çœç•¥å…¶ä»–å¿…è¦çš„å¤´æ–‡ä»¶å’Œä»£ç  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CreateString(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  // å°è¯•åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸² &quot;hello&quot;</span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span>  napi_status status = napi_create_string_utf8(env, &quot;hello&quot;, NAPI_AUTO_LENGTH, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ£€æŸ¥å‡½æ•°æ˜¯å¦æˆåŠŸæ‰§è¡Œ</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // è·å–é”™è¯¯ä¿¡æ¯</span></span>
<span class="line"><span>    const napi_extended_error_info* error_info;</span></span>
<span class="line"><span>    napi_get_last_error_info(env, &amp;error_info);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ‰“å°é”™è¯¯ä¿¡æ¯åˆ°æ§åˆ¶å°</span></span>
<span class="line"><span>    printf(&quot;Failed to create string: %s\n&quot;, error_info-&gt;error_message);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æŠ›å‡ºä¸€ä¸ªJavaScriptå¼‚å¸¸</span></span>
<span class="line"><span>    napi_throw_error(env, NULL, error_info-&gt;error_message);</span></span>
<span class="line"><span>    return NULL;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå°è¯•ä½¿ç”¨<code>napi_create_string_utf8</code>åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹å­—ç¬¦ä¸²ã€‚å¦‚æœè¿™ä¸ªå°è¯•å¤±è´¥äº†ï¼Œæˆ‘ä»¬é€šè¿‡<code>napi_get_last_error_info</code>è·å–å…³äºè¿™ä¸ªé”™è¯¯çš„æ›´å¤šä¿¡æ¯ï¼Œç„¶åæ‰“å°å‡ºé”™è¯¯æ¶ˆæ¯ï¼Œå¹¶ä¸”æŠ›å‡ºä¸€ä¸ª JavaScript å¼‚å¸¸æ¥å‘Šè¯‰ JavaScript ä»£ç å‘ç”Ÿäº†é”™è¯¯ã€‚</p><p>é€šè¿‡<code>napi_extended_error_info</code>æ‰€æä¾›çš„ä¿¡æ¯ï¼Œä½œä¸ºæ’ä»¶ä½œè€…ï¼Œä½ å¯ä»¥æ›´å¥½åœ°ç†è§£é”™è¯¯å‘ç”Ÿçš„èƒŒæ™¯ï¼Œå¹¶ä¸”æä¾›æ›´å¤šçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ç»™ä½¿ç”¨ä½ æ’ä»¶çš„å¼€å‘è€…ã€‚è¿™ä½¿å¾—è°ƒè¯•æœ¬åœ°æ’ä»¶å’Œå¤„ç†é”™è¯¯æˆä¸ºä¸€ä»¶æ›´åŠ å¯æ§å’Œæ¸…æ™°çš„å·¥ä½œã€‚</p><h3 id="napi-env" tabindex="-1"><a class="header-anchor" href="#napi-env"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_env" target="_blank" rel="noopener noreferrer">napi_env</a></span></a></h3><p><code>napi_env</code>æ˜¯ä¸€ä¸ªä»£è¡¨ Node.js è¿è¡Œç¯å¢ƒçš„æŠ½è±¡æ¦‚å¿µï¼Œå®ƒåœ¨ Node.js çš„ N-APIï¼ˆNative APIï¼‰ä¸­éå¸¸é‡è¦ã€‚N-API æ˜¯ä¸€ç§ C è¯­è¨€çº§åˆ«çš„ APIï¼Œå…è®¸å¼€å‘äººå‘˜ç¼–å†™å¯ä»¥ä¸ Node.js ä»£ç äº¤äº’çš„æœ¬åœ°æ’ä»¶ï¼Œè¿™äº›æ’ä»¶é€šå¸¸æ˜¯ç”¨ C æˆ– C++å†™æˆçš„ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥è°ƒç”¨ Node.js æä¾›çš„å„ç§ APIã€‚</p><p><code>napi_env</code> æ˜¯ä¸€ä¸ªæŒ‡å‘ç¯å¢ƒç›¸å…³æ•°æ®çš„æŒ‡é’ˆï¼Œä½ å¯ä»¥å°†å…¶ç†è§£ä¸ºä¸€ä¸ªåŒ…å«äº†å½“å‰ Node.js å®ä¾‹ä¿¡æ¯çš„ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚åœ¨ N-API ä¸­è¿›è¡Œæœ¬åœ°æ’ä»¶å¼€å‘æ—¶ï¼Œå‡ ä¹æ‰€æœ‰çš„å‡½æ•°éƒ½éœ€è¦è¿™ä¸ªç¯å¢ƒæŒ‡é’ˆæ¥ç¡®è®¤å®ƒä»¬æ­£åœ¨æ“ä½œçš„æ˜¯å“ªä¸€ä¸ª Node.js å®ä¾‹ã€‚</p><p>ä¸ºä»€ä¹ˆè¦æœ‰ <code>napi_env</code>ï¼Ÿ</p><ul><li><strong>å¤šçº¿ç¨‹æ”¯æŒ</strong>: Node.js æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†é€šè¿‡ worker threads å¯ä»¥è¿è¡Œå¤šä¸ªçº¿ç¨‹ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è‡ªå·±çš„<code>napi_env</code>ç¯å¢ƒï¼Œè¿™æ ·å°±èƒ½ç¡®ä¿æ“ä½œä¸ä¼šå†²çªã€‚</li><li><strong>æ¨¡å—å®ä¾‹åŒ–</strong>: å½“ä½ æœ‰å¤šä¸ªæ¨¡å—å®ä¾‹æ—¶ï¼Œæ¯ä¸ªå®ä¾‹éƒ½æœ‰è‡ªå·±çš„<code>napi_env</code>æ¥å­˜å‚¨çŠ¶æ€å’Œä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li></ul><p>ä»¥ä¸‹æ˜¯å‡ ä¸ªä½¿ç”¨<code>napi_env</code>çš„ç®€å•ç¤ºä¾‹ï¼š</p><ol><li><p><strong>åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript Number</strong>:<br> ä¸ºäº†åœ¨æœ¬åœ°æ’ä»¶ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript æ•°å­—å¹¶è¿”å›ç»™ JavaScriptï¼Œä½ ä¼šä½¿ç”¨å¸¦æœ‰<code>napi_env</code>å‚æ•°çš„ N-API å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status status;</span></span>
<span class="line"><span>napi_value my_number;</span></span>
<span class="line"><span>status = napi_create_double(env, 123.456, &amp;my_number);</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>  // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>ä» JavaScript æ¥æ”¶å‚æ•°</strong>:<br> å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªæœ¬åœ°å‡½æ•°ï¼Œè¯¥å‡½æ•°éœ€è¦ä» JavaScript ç«¯è·å–å‚æ•°ï¼Œä½ ä¼šè¿™æ ·ä½¿ç”¨<code>napi_env</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value function_callback(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  size_t argc = 1;</span></span>
<span class="line"><span>  napi_value argv[1];</span></span>
<span class="line"><span>  napi_status status = napi_get_cb_info(env, info, &amp;argc, argv, NULL, NULL);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å‡è®¾æˆ‘ä»¬çŸ¥é“argv[0]æ˜¯ä¸€ä¸ªæ•°å­—</span></span>
<span class="line"><span>  double value;</span></span>
<span class="line"><span>  status = napi_get_value_double(env, argv[0], &amp;value);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ç°åœ¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªå€¼åšä¸€äº›æ“ä½œ...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>æŠ›å‡ºå¼‚å¸¸</strong>:<br> å¦‚æœåœ¨æœ¬åœ°æ’ä»¶çš„æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œä½ å¯èƒ½éœ€è¦æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œè®© JavaScript ç«¯èƒ½å¤Ÿæ•è·åˆ°ã€‚ä½ å°†ä½¿ç”¨<code>napi_env</code>åˆ›å»ºä¸€ä¸ªé”™è¯¯å¯¹è±¡å¹¶æŠ›å‡ºå®ƒï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_throw_error(env, NULL, &quot;An error occurred!&quot;);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><p>è¿™äº›åªæ˜¯<code>napi_env</code>åœ¨ N-API ä¸­åº”ç”¨çš„åŸºç¡€ç¤ºä¾‹ï¼Œä½†å®ƒä»¬å±•ç¤ºäº†<code>napi_env</code>ä½œä¸ºè¿æ¥ C/C++ä»£ç å’Œ Node.js è¿è¡Œç¯å¢ƒçš„æ¡¥æ¢çš„åŸºæœ¬ç”¨é€”ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œ<code>napi_env</code>ç”¨äºç¡®ä¿ä½ çš„æœ¬åœ°æ’ä»¶å¯ä»¥æ­£ç¡®åœ°åœ¨ Node.js ç¯å¢ƒä¸­è¿è¡Œï¼Œç®¡ç†èµ„æºï¼Œä»¥åŠå¤„ç†å¼‚æ­¥æ“ä½œç­‰ç­‰ã€‚</p><h3 id="node-api-nogc-env" tabindex="-1"><a class="header-anchor" href="#node-api-nogc-env"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#node_api_nogc_env" target="_blank" rel="noopener noreferrer">node_api_nogc_env</a></span></a></h3><p><code>node_api_nogc_env</code> æ˜¯ Node.js çš„ N-API ä¸­çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå®ƒå…è®¸åŸç”Ÿæ¨¡å—çš„å¼€å‘è€…åˆ›å»ºä¸€ä¸ªä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨ï¼ˆGCï¼‰å¹²é¢„çš„ç¯å¢ƒã€‚åœ¨è¯¦ç»†è§£é‡Šä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å¼„æ˜ç™½å‡ ä¸ªåŸºæœ¬æ¦‚å¿µã€‚</p><h3 id="ä»€ä¹ˆæ˜¯-n-api" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯-n-api"><span>ä»€ä¹ˆæ˜¯ N-APIï¼Ÿ</span></a></h3><p>N-API æ˜¯ Node.js æä¾›çš„ä¸€å¥— C è¯­è¨€ API æ¥å£ï¼Œå®ƒå…è®¸ä½ ç”¨ C æˆ– C++ç¼–å†™æ‰©å±•æ¨¡å—ï¼Œè¿™äº›æ¨¡å—å¯ä»¥ç›´æ¥ä¸ Node.js è¿è¡Œæ—¶äº¤äº’ã€‚ä½¿ç”¨ N-API ç¼–å†™çš„æ¨¡å—æ˜¯ä¸ Node.js ç‰ˆæœ¬æ— å…³çš„ï¼Œè¿™æ„å‘³ç€ä½ ç¼–å†™ä¸€æ¬¡ä»£ç ï¼Œç†è®ºä¸Šåœ¨ä»»ä½•æ”¯æŒ N-API çš„ Node.js ç‰ˆæœ¬ä¸Šéƒ½èƒ½è¿è¡Œè€Œæ— éœ€ä¿®æ”¹ã€‚</p><h3 id="åƒåœ¾å›æ”¶å™¨-gc-æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#åƒåœ¾å›æ”¶å™¨-gc-æ˜¯ä»€ä¹ˆ"><span>åƒåœ¾å›æ”¶å™¨ï¼ˆGCï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ</span></a></h3><p>åœ¨ JavaScript ä¸­ï¼Œå½“å˜é‡æˆ–è€…å¯¹è±¡ä¸å†éœ€è¦æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šè‡ªåŠ¨é‡Šæ”¾é‚£äº›å†…å­˜ç©ºé—´ã€‚è¿™æ˜¯è‡ªåŠ¨è¿›è¡Œçš„ï¼Œé€šå¸¸å¼€å‘è€…ä¸éœ€è¦æ‰‹åŠ¨ç®¡ç†å†…å­˜ã€‚ä¸è¿‡ï¼Œåœ¨åŸç”Ÿæ¨¡å—ä¸­ï¼Œä½ å¯èƒ½ä¼šåˆ›å»ºä¸€äº›ç”± C/C++ ç®¡ç†çš„èµ„æºï¼Œè¿™äº›èµ„æºä¸æ˜¯ JavaScript åƒåœ¾å›æ”¶å™¨ç›´æ¥ç®¡ç†çš„ã€‚</p><h3 id="node-api-nogc-env-çš„ä½œç”¨" tabindex="-1"><a class="header-anchor" href="#node-api-nogc-env-çš„ä½œç”¨"><span><code>node_api_nogc_env</code> çš„ä½œç”¨</span></a></h3><p>å½“ä½¿ç”¨ N-API ç¼–å†™åŸç”Ÿæ¨¡å—æ—¶ï¼ŒæŸäº›æƒ…å†µä¸‹ä½ å¯èƒ½éœ€è¦ç¡®ä¿åœ¨æ‰§è¡ŒæŸæ®µå…³é”®çš„ä»£ç æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨ä¸è¦è¿è¡Œã€‚å› ä¸ºå¦‚æœåœ¨è¿™äº›ä»£ç æ‰§è¡ŒæœŸé—´å‘ç”Ÿäº†åƒåœ¾å›æ”¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜æˆ–è€…æ›´ç³Ÿçš„æƒ…å†µæ˜¯é”™è¯¯å’Œå´©æºƒã€‚</p><p>ä½¿ç”¨ <code>node_api_nogc_env</code> å¯ä»¥åˆ›å»ºä¸€ä¸ªâ€œæ—  GC ç¯å¢ƒâ€ï¼Œåœ¨è¿™ä¸ªç¯å¢ƒä¸­æ‰§è¡Œä»£ç æ—¶ï¼ŒNode.js çš„åƒåœ¾å›æ”¶å™¨ä¼šè¢«æš‚æ—¶é˜»æ­¢æ‰§è¡Œã€‚è¿™å¯¹äºæ§åˆ¶å¹¶ä¼˜åŒ–æ€§èƒ½éå¸¸æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å®æ—¶æ•°æ®æˆ–é«˜æ€§èƒ½è®¡ç®—æ—¶ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªéœ€è¦ä¸ç¡¬ä»¶è®¾å¤‡é€šä¿¡çš„ Node.js åŸç”Ÿæ¨¡å—ã€‚è¿™ä¸ªé€šä¿¡è¿‡ç¨‹å¯èƒ½æ¶‰åŠç²¾ç¡®çš„æ—¶åºå’Œå¿«é€Ÿçš„æ•°æ®å¤„ç†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœä»£ç æ‰§è¡ŒæœŸé—´å‘ç”Ÿåƒåœ¾å›æ”¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±æˆ–æ—¶åºé—®é¢˜ã€‚æ‰€ä»¥ï¼Œåœ¨è®¾ç½®é€šä¿¡åè®®æˆ–å¤„ç†æ•°æ®çš„æ ¸å¿ƒä»£ç éƒ¨åˆ†ï¼Œä½ å¯èƒ½ä¼šå¸Œæœ›ä½¿ç”¨ <code>node_api_nogc_env</code> æ¥ç¡®ä¿æ­¤æ—¶ä¸ä¼šå‘ç”Ÿåƒåœ¾å›æ”¶ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å‡è®¾çš„ä»£ç ç¤ºä¾‹</span></span>
<span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CommunicateWithDevice(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ— GCç¯å¢ƒã€‚</span></span>
<span class="line"><span>    napi_env nogc_env;</span></span>
<span class="line"><span>    napi_create_env(env, &amp;nogc_env);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åœ¨æ­¤ç¯å¢ƒä¸­æ‰§è¡Œå…³é”®æ“ä½œ...</span></span>
<span class="line"><span>    // ä¾‹å¦‚ï¼šå‘é€æŒ‡ä»¤åˆ°ç¡¬ä»¶è®¾å¤‡ï¼Œå¤„ç†è¿”å›çš„æ•°æ®ç­‰æ“ä½œã€‚</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // é”€æ¯æ— GCç¯å¢ƒ</span></span>
<span class="line"><span>    napi_destroy_env(nogc_env);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return nullptr; // è¿”å›å€¼</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œå‡½æ•°</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, CommunicateWithDevice, NULL, &amp;fn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;communicateWithDevice&quot;, fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·æ³¨æ„ï¼Œè¿™åªæ˜¯ä¸€ä¸ªæ¦‚å¿µæ€§çš„ç¤ºèŒƒï¼Œå®é™…çš„ N-API ç”¨æ³•å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚</p><p>é‡è¦çš„æ˜¯è¦æ˜ç™½ï¼Œ<code>node_api_nogc_env</code> åº”è¯¥è°¨æ…ä½¿ç”¨ã€‚é˜»æ­¢åƒåœ¾å›æ”¶å™¨è¿è¡Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜ä½¿ç”¨éšæ—¶é—´å¢åŠ ï¼Œå› ä¸ºæ²¡æœ‰æ¸…ç†ä¸å†éœ€è¦çš„å¯¹è±¡ã€‚å› æ­¤ï¼Œé€šå¸¸åªåœ¨å¿…é¡»æœ€å¤§åŒ–æ€§èƒ½ï¼Œä¸”äº†è§£ä½ çš„å†…å­˜ç®¡ç†éå¸¸å¥½çš„æƒ…å†µä¸‹ï¼Œæ‰ä½¿ç”¨è¿™ä¸ªç‰¹æ€§ã€‚</p><h3 id="napi-value" tabindex="-1"><a class="header-anchor" href="#napi-value"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_value" target="_blank" rel="noopener noreferrer">napi_value</a></span></a></h3><p><code>napi_value</code> æ˜¯ Node.js ä¸­çš„ N-APIï¼ˆNode APIï¼‰çš„ä¸€ä¸ªæ¦‚å¿µã€‚N-API æ˜¯ä¸€ä¸ª C è¯­è¨€æ¥å£ï¼Œå®ƒæä¾›äº†ä¸€ç§å»ºç«‹ç¨³å®šå’Œå…¼å®¹ä¸åŒ Node.js ç‰ˆæœ¬çš„åŸç”Ÿæ’ä»¶ï¼ˆnative addonsï¼‰çš„æ–¹æ³•ã€‚åœ¨è§£é‡Š <code>napi_value</code> å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£å‡ ä¸ªå…³é”®ç‚¹ï¼š</p><ol><li><p><strong>åŸç”Ÿæ’ä»¶ (Native Addons)</strong>ï¼šè¿™äº›æ˜¯ç”¨ C æˆ– C++ç¼–å†™çš„æ¨¡å—ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ Node.js è¿è¡Œæ—¶ä»¥å¤–çš„ APIï¼Œä¾‹å¦‚ç›´æ¥æ“ä½œç³»ç»Ÿåº•å±‚åŠŸèƒ½æˆ–è®¿é—®ç‰¹å®šç¡¬ä»¶ã€‚</p></li><li><p><strong>N-API</strong>ï¼šä¸ºäº†ä½¿åŸç”Ÿæ’ä»¶æ›´åŠ ç¨³å®šå¹¶å‡å°‘ä¸ Node.js ç‰ˆæœ¬æ›´æ–°ç›¸å…³çš„å¼‚å˜æ€§ï¼ŒNode.js æä¾›äº† N-APIï¼Œå®ƒå®šä¹‰äº†ä¸€å¥—è·¨ç‰ˆæœ¬ç¨³å®šçš„ APIã€‚</p></li><li><p><strong>JavaScript å€¼ä¸ C ç±»å‹çš„æ˜ å°„</strong>ï¼šç”±äº N-API æ˜¯ç”¨ C ç¼–å†™çš„ï¼Œè€Œ Node.js çš„è¿è¡Œç¯å¢ƒæ˜¯åŸºäº JavaScript çš„ï¼Œæ‰€ä»¥å¿…é¡»æœ‰ä¸€ç§æ–¹å¼æ¥åœ¨ JavaScript ä¸–ç•Œå’Œ C è¯­è¨€ä¸–ç•Œä¹‹é—´è½¬æ¢æ•°æ®ã€‚</p></li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·±å…¥ <code>napi_value</code>ï¼š</p><h3 id="napi-value-1" tabindex="-1"><a class="header-anchor" href="#napi-value-1"><span><code>napi_value</code></span></a></h3><p>åœ¨ä½¿ç”¨ N-API ç¼–å†™åŸç”Ÿæ¨¡å—æ—¶ï¼Œä½ ä¼šå¤„ç†å¾ˆå¤š JavaScript å€¼ï¼ˆå¦‚æ•°å­—ã€å­—ç¬¦ä¸²ã€å¯¹è±¡ç­‰ï¼‰ã€‚<code>napi_value</code> æ˜¯ä¸€ä¸ªæŠ½è±¡è¡¨ç¤ºï¼Œå®ƒä»£è¡¨äº†ä¸€ä¸ª JavaScript å€¼åœ¨ C è¯­è¨€å±‚é¢çš„å¼•ç”¨æˆ–å¥æŸ„ã€‚æ¯å½“ä½ æƒ³åœ¨ C/C++ä»£ç ä¸­æ“ä½œä¸€ä¸ª JavaScript å€¼æ—¶ï¼Œä½ å®é™…ä¸Šæ˜¯é€šè¿‡ <code>napi_value</code> è¿™ä¸ªæŠ½è±¡å±‚æ¥è¿›è¡Œæ“ä½œã€‚</p><p><code>napi_value</code> åªæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ˆæˆ–è€…è¯´æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼‰ï¼Œå®ƒæ²¡æœ‰å‘Šè¯‰ä½ å…·ä½“çš„å€¼æ˜¯ä»€ä¹ˆï¼Œä½†å®ƒå¯ä»¥è¢«ä¼ é€’åˆ°å…¶ä»– N-API å‡½æ•°ä¸­å»åˆ›å»ºã€æŸ¥è¯¢æˆ–æ“ä½œé‚£ä¸ª JavaScript å€¼ã€‚</p><h4 id="å®é™…ä¾‹å­-2" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-2"><span>å®é™…ä¾‹å­</span></a></h4><p>å‡è®¾ä½ æƒ³å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶å‡½æ•°ï¼Œå°†ä¸¤ä¸ª JavaScript æ•°å­—ç›¸åŠ ï¼Œå¹¶è¿”å›ç»“æœã€‚ä»¥ä¸‹æ˜¯å¯èƒ½çš„ C ä»£ç ç‰‡æ®µï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡½æ•°å®ç°ï¼Œç”¨äºåŠ æ³•æ“ä½œ</span></span>
<span class="line"><span>napi_value Add(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    size_t argc = 2;</span></span>
<span class="line"><span>    napi_value args[2];</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥å‚æ•°æ•°é‡å’Œç±»å‹ç­‰...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    double value1, value2;</span></span>
<span class="line"><span>    status = napi_get_value_double(env, args[0], &amp;value1);</span></span>
<span class="line"><span>    status = napi_get_value_double(env, args[1], &amp;value2);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_value sum;</span></span>
<span class="line"><span>    status = napi_create_double(env, value1 + value2, &amp;sum);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return sum;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†ŒAddå‡½æ•°åˆ°module.exports</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    status = napi_create_function(env, NULL, 0, Add, NULL, &amp;fn);</span></span>
<span class="line"><span>    status = napi_set_named_property(env, exports, &quot;add&quot;, fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š</p><ul><li><code>Add</code> å‡½æ•°å°±æ˜¯æˆ‘ä»¬è¦ç”¨ N-API æš´éœ²ç»™ JavaScript çš„ C å‡½æ•°ã€‚</li><li><code>args</code> æ•°ç»„åŒ…å«ç€å‡½æ•°è°ƒç”¨æ—¶ä¼ é€’è¿›æ¥çš„ JavaScript å‚æ•°ã€‚</li><li>æ¯ä¸€ä¸ª <code>args</code> å…ƒç´ éƒ½æ˜¯ä¸€ä¸ª <code>napi_value</code> ç±»å‹ï¼Œè¡¨ç¤º JavaScript ä¼ é€’çš„å€¼ã€‚</li><li>ä½¿ç”¨ <code>napi_get_value_double</code> å‡½æ•°ä» <code>napi_value</code> ä¸­æå–å‡º C è¯­è¨€ä¸­çš„ <code>double</code> ç±»å‹çš„æ•°å€¼ã€‚</li><li><code>napi_create_double</code> åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ JavaScript Number å€¼ï¼Œå¹¶è¿”å›å…¶ <code>napi_value</code> è¡¨ç¤ºã€‚</li><li>æœ€åï¼Œ<code>Add</code> å‡½æ•°é€šè¿‡è¿”å›è¿™ä¸ªæ–°åˆ›å»ºçš„ <code>napi_value</code> å°†ç»“æœä¼ å› JavaScriptã€‚</li></ul><p>ä½¿ç”¨ä»¥ä¸Šä»£ç ï¼Œä½ åœ¨ JavaScript ä¸­å°±å¯ä»¥åƒä¸‹é¢è¿™æ ·è°ƒç”¨è¯¥æ’ä»¶ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/nativeAddon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">5</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 10</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: 15</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>napi_value</code> æ˜¯ N-API ç¼–ç¨‹ä¸­çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå› ä¸ºå®ƒæ˜¯ JavaScript ä¸–ç•Œå’Œ C ä¸–ç•Œäº’åŠ¨çš„æ¡¥æ¢ã€‚é€šè¿‡ç†è§£å’Œä½¿ç”¨ <code>napi_value</code>ï¼Œä½ å¯ä»¥æ„å»ºå¼ºå¤§çš„ Node.js åŸç”Ÿæ‰©å±•ï¼Œå……åˆ†å‘æŒ¥ JavaScript å’Œç³»ç»Ÿåº•å±‚èƒ½åŠ›çš„ç»“åˆä¼˜åŠ¿ã€‚</p><h3 id="napi-threadsafe-function" tabindex="-1"><a class="header-anchor" href="#napi-threadsafe-function"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_threadsafe_function" target="_blank" rel="noopener noreferrer">napi_threadsafe_function</a></span></a></h3><p>Node.js ä¸­çš„<code>napi_threadsafe_function</code>æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„åŠŸèƒ½ï¼Œå®ƒå…è®¸ä½ ä»ä»»ä½•çº¿ç¨‹å®‰å…¨åœ°è°ƒç”¨ JavaScript å‡½æ•°ã€‚åœ¨äº†è§£è¿™ä¸ªæ¦‚å¿µä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£å‡ ä¸ªåŸºç¡€ç‚¹ï¼š</p><ol><li><p><strong>Node.js çš„å•çº¿ç¨‹æ¨¡å‹</strong>ï¼šNode.js é€šå¸¸è¿è¡Œåœ¨å•ä¸ªçº¿ç¨‹ä¸Šï¼Œè¿™æ„å‘³ç€æ‰€æœ‰çš„ JavaScript ä»£ç éƒ½åœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰ä¸Šæ‰§è¡Œã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½éœ€è¦æ‰§è¡Œä¸€äº›è€—æ—¶çš„æ“ä½œï¼Œæ¯”å¦‚è¯»å†™æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚æˆ–è€…å…¶ä»–å¤æ‚è®¡ç®—ï¼Œè¿™äº›æ“ä½œå¦‚æœæ”¾åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œä¼šé˜»å¡å…¶ä»–ä»£ç çš„æ‰§è¡Œã€‚</p></li><li><p><strong>å¼‚æ­¥å’Œäº‹ä»¶å¾ªç¯</strong>ï¼šä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼ŒNode.js é‡‡ç”¨éé˜»å¡ I/O å’Œäº‹ä»¶å¾ªç¯æœºåˆ¶æ¥è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹ã€‚è¿™æ ·ï¼Œä¸€äº›è€—æ—¶çš„æ“ä½œå¯ä»¥åœ¨åå°æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæ¯•åé€šè¿‡å›è°ƒå‡½æ•°æ¥é€šçŸ¥ä¸»çº¿ç¨‹ã€‚</p></li><li><p><strong>å¤šçº¿ç¨‹å’Œ<code>worker_threads</code></strong>ï¼šå°½ç®¡ Node.js ä¸»è¦æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†å®ƒä¹Ÿæ”¯æŒä½¿ç”¨<code>worker_threads</code>æ¨¡å—åˆ›å»ºçœŸæ­£çš„å¤šçº¿ç¨‹ã€‚è¿™åœ¨å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡æ—¶éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå¯ä»¥åˆ›å»ºå·¥ä½œçº¿ç¨‹æ¥åˆ†æ‹…è®¡ç®—è´Ÿè·ã€‚</p></li></ol><p>ç°åœ¨ï¼Œå½“ä½ åœ¨å·¥ä½œçº¿ç¨‹ï¼ˆæˆ–è€…ä»»ä½•éä¸»çº¿ç¨‹ï¼‰ä¸­è¿›è¡Œæ“ä½œï¼Œå¹¶ä¸”æƒ³è¦ä¸ä¸»çº¿ç¨‹ä¸­çš„ JavaScript ä»£ç äº¤äº’æ—¶ï¼Œå°±éœ€è¦ç”¨åˆ°<code>napi_threadsafe_function</code>äº†ã€‚</p><h3 id="napi-threadsafe-function-ä½¿ç”¨åœºæ™¯å’Œä¾‹å­" tabindex="-1"><a class="header-anchor" href="#napi-threadsafe-function-ä½¿ç”¨åœºæ™¯å’Œä¾‹å­"><span><code>napi_threadsafe_function</code> ä½¿ç”¨åœºæ™¯å’Œä¾‹å­</span></a></h3><p>å‡è®¾ä½ åœ¨ä¸€ä¸ª Node.js åº”ç”¨ç¨‹åºä¸­è¿è¡Œäº†ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä¸€ä¸ªè€—æ—¶çš„å›¾åƒå¤„ç†ä»»åŠ¡ã€‚å®Œæˆè¿™ä¸ªä»»åŠ¡åï¼Œå·¥ä½œçº¿ç¨‹éœ€è¦å°†ç»“æœä¼ é€å›ä¸»çº¿ç¨‹ï¼Œä»¥ä¾¿æ›´æ–°ç”¨æˆ·ç•Œé¢æˆ–è€…å‘é€ç»™å®¢æˆ·ç«¯ã€‚è¿™é‡Œå°±å¯ä»¥ä½¿ç”¨<code>napi_threadsafe_function</code>æ¥å®ç°å®‰å…¨çš„é€šä¿¡ã€‚</p><p><strong>ä¾‹å­ 1ï¼š</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> Worker</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> isMainThread</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> parentPort</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">worker_threads</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">isMainThread</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">  // ä¸»çº¿ç¨‹ä»£ç </span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> worker</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Worker</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">__filename</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // æ¥æ”¶å·¥ä½œçº¿ç¨‹å‘æ¥çš„æ¶ˆæ¯</span></span>
<span class="line"><span style="color:#D8DEE9;">  worker</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">message</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">msg</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æ”¶åˆ°:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> msg</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">  worker</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">error</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">  worker</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">exit</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">code</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">code</span><span style="color:#81A1C1;"> !==</span><span style="color:#B48EAD;"> 0</span><span style="color:#D8DEE9FF;">) </span><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">å·¥ä½œçº¿ç¨‹åœæ­¢ï¼Œé€€å‡ºç : </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">code</span><span style="color:#81A1C1;">}</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // å·¥ä½œçº¿ç¨‹ä»£ç </span></span>
<span class="line"><span style="color:#D8DEE9;">  parentPort</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">postMessage</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">å·¥ä½œçº¿ç¨‹å‘é€çš„æ•°æ®</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç®€åŒ–çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰ç›´æ¥ä½¿ç”¨<code>napi_threadsafe_function</code>ï¼Œå› ä¸º<code>worker_threads</code>æ¨¡å—å·²ç»å¯¹å…¶è¿›è¡Œäº†å°è£…ã€‚å·¥ä½œçº¿ç¨‹é€šè¿‡<code>parentPort.postMessage</code>å‘é€æ¶ˆæ¯ï¼Œä¸»çº¿ç¨‹é€šè¿‡ç›‘å¬<code>message</code>äº‹ä»¶æ¥æ¥å—æ¶ˆæ¯ã€‚</p><p><strong>ä¾‹å­ 2ï¼šä½¿ç”¨<code>napi_threadsafe_function</code>çš„åŸç”Ÿæ‰©å±•</strong></p><p>å¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªéœ€è¦åœ¨ C++ä¸­åˆ›å»ºæ–°çº¿ç¨‹ï¼Œå¹¶ä¸”éœ€è¦å’Œ JS é€šä¿¡çš„ Node.js åŸç”Ÿæ‰©å±•ï¼Œé‚£ä¹ˆä½ å°±éœ€è¦ç›´æ¥ä½¿ç”¨<code>napi_create_threadsafe_function</code>ã€‚</p><p>ç”±äºè¿™æ¶‰åŠåˆ°è¾ƒå¤æ‚çš„ C++ä»£ç å’Œ Node.js çš„ N-API æ¥å£ï¼Œä»¥ä¸‹åªæä¾›ä¸€ä¸ªé«˜å±‚æ¬¡çš„æ¦‚å¿µä»‹ç»ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// C++ çº¿ç¨‹æ‰§è¡Œçš„å‡½æ•°</span></span>
<span class="line"><span>void MyThreadFunction(napi_threadsafe_function tsfn) {</span></span>
<span class="line"><span>    // æ‰§è¡Œä¸€äº›ä»»åŠ¡...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è°ƒç”¨ JavaScript å‡½æ•°</span></span>
<span class="line"><span>    napi_call_threadsafe_function(tsfn, ...);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ä»»åŠ¡å®Œæˆï¼Œé‡Šæ”¾å‡½æ•°</span></span>
<span class="line"><span>    napi_release_threadsafe_function(tsfn, napi_tsfn_release);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ– threadsafe function å¹¶åˆ›å»ºçº¿ç¨‹</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value js_func;</span></span>
<span class="line"><span>    // è·å– JavaScript å‡½æ•°å‚æ•°...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ª threadsafe function</span></span>
<span class="line"><span>    napi_create_threadsafe_function(env, js_func, ..., MyThreadFunction, ..., &amp;tsfn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>napi_create_threadsafe_function</code>ç”¨äºåˆ›å»ºä¸€ä¸ªå¯ä»¥è·¨çº¿ç¨‹å®‰å…¨è°ƒç”¨çš„ JavaScript å‡½æ•°ã€‚C++çº¿ç¨‹å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥å®‰å…¨åœ°å›è°ƒ JavaScript å‡½æ•°ï¼Œè€Œä¸ä¼šé€ æˆå¹¶å‘é—®é¢˜ã€‚</p><p>æ€»ç»“èµ·æ¥ï¼Œ<code>napi_threadsafe_function</code>æ˜¯ Native Addons åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¸ JavaScript ä»£ç äº¤äº’çš„æ¡¥æ¢ã€‚å¯¹äºçº¯ JavaScript å¼€å‘è€…è€Œè¨€ï¼Œé€šå¸¸ä¸éœ€è¦ç›´æ¥ä½¿ç”¨å®ƒï¼Œå› ä¸º<code>worker_threads</code>æ¨¡å—å·²ç»æä¾›äº†æ›´é«˜çº§åˆ«çš„æŠ½è±¡ã€‚</p><h3 id="napi-threadsafe-function-release-mode" tabindex="-1"><a class="header-anchor" href="#napi-threadsafe-function-release-mode"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_threadsafe_function_release_mode" target="_blank" rel="noopener noreferrer">napi_threadsafe_function_release_mode</a></span></a></h3><p><code>napi_threadsafe_function_release_mode</code> æ˜¯ Node.js ä¸­ N-API çš„ä¸€éƒ¨åˆ†ï¼ŒN-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚åœ¨æ·±å…¥ç†è§£ <code>napi_threadsafe_function_release_mode</code> ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£ä¸€äº›åŸºç¡€æ¦‚å¿µã€‚</p><p><strong>ä»€ä¹ˆæ˜¯ N-APIï¼Ÿ</strong></p><p>N-API æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå…è®¸ä½ ä½¿ç”¨ C æˆ– C++ ç¼–å†™å¯ä»¥å’Œ JavaScript ä»£ç äº¤äº’çš„åŸç”Ÿæ’ä»¶ã€‚è¿™æ ·ï¼Œä½ å°±èƒ½å¤Ÿåœ¨æœ¬åœ°ä»£ç ä¸­æ‰§è¡Œé«˜æ€§èƒ½æˆ–ç³»ç»Ÿçº§åˆ«æ“ä½œï¼Œç„¶åé€šè¿‡ JavaScript åœ¨ Node.js ç¯å¢ƒä¸­è°ƒç”¨è¿™äº›æ“ä½œã€‚</p><p><strong>ä»€ä¹ˆæ˜¯ Thread-safe Functionï¼ˆçº¿ç¨‹å®‰å…¨å‡½æ•°ï¼‰ï¼Ÿ</strong></p><p>åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œ&quot;çº¿ç¨‹å®‰å…¨&quot;æ„å‘³ç€åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€èµ„æºæ—¶ï¼Œç¨‹åºèƒ½å¤Ÿæ­£ç¡®åœ°ç®¡ç†å¯¹è¯¥èµ„æºçš„è®¿é—®ï¼Œä»¥é¿å…ä¸å¯é¢„æ–™çš„ç»“æœæˆ–å´©æºƒã€‚å½“ä½ ä»åŸç”Ÿçº¿ç¨‹è®¿é—® Node.js è¿è¡Œæ—¶æˆ–è€…æƒ³è¦åœ¨åŸç”Ÿçº¿ç¨‹ä¸­è°ƒç”¨ JavaScript å‡½æ•°æ—¶ï¼Œä½ ä¼šéœ€è¦è¿™ç§çº¿ç¨‹å®‰å…¨æœºåˆ¶ã€‚</p><p><strong><code>napi_threadsafe_function_release_mode</code> çš„ä½œç”¨ï¼š</strong></p><p><code>napi_threadsafe_function_release_mode</code> æ˜¯ä¸€ä¸ªæšä¸¾å€¼ï¼Œå®ƒæè¿°äº†åœ¨é‡Šæ”¾ï¼ˆç»“æŸï¼‰ä¸€ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°æ—¶åº”è¯¥é‡‡å–çš„è¡Œä¸ºæ¨¡å¼ã€‚å½“ä½ å®Œæˆäº†å¯¹çº¿ç¨‹å®‰å…¨å‡½æ•°çš„ä½¿ç”¨ï¼Œå¹¶ä¸”æƒ³è¦æ¸…ç†èµ„æºï¼Œé€šçŸ¥ Node.js è¿™ä¸ªå‡½æ•°ä¸å†è¢«åŸç”Ÿä»£ç ä½¿ç”¨æ—¶ï¼Œä½ ä¼šè°ƒç”¨ç›¸å…³çš„ N-API å‡½æ•°æ¥é‡Šæ”¾è¿™ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°ã€‚</p><p>Node.js æä¾›äº†ä¸¤ç§é‡Šæ”¾æ¨¡å¼ï¼š</p><ol><li><p><code>napi_tsfn_release</code>ï¼šè¿™æ˜¯é»˜è®¤çš„é‡Šæ”¾æ¨¡å¼ã€‚å½“ä½ è°ƒç”¨è¿™ä¸ªé€‰é¡¹æ—¶ï¼ŒNode.js å°†ç­‰å¾…æ‰€æœ‰å·²ç»æäº¤ç»™çº¿ç¨‹å®‰å…¨å‡½æ•°çš„ä»»åŠ¡éƒ½å®Œæˆæ‰ä¼šé”€æ¯è¿™ä¸ªå‡½æ•°ã€‚</p></li><li><p><code>napi_tsfn_abort</code>ï¼šå¦‚æœä½ é€‰æ‹©è¿™ä¸ªæ¨¡å¼ï¼ŒNode.js å°†ç«‹å³åœæ­¢æ¥å—æ–°çš„ä»»åŠ¡ï¼Œå¹¶å°½å¯èƒ½å¿«åœ°é”€æ¯è¿™ä¸ªå‡½æ•°ã€‚è¿™ä¸ªæ¨¡å¼é€‚åˆäºé‚£äº›ç”±äºæŸäº›åŸå› éœ€è¦ç«‹å³ç»ˆæ­¢çš„æƒ…å†µã€‚</p></li></ol><p><strong>å®é™…è¿ç”¨ä¾‹å­ï¼š</strong></p><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ç¨‹åºï¼Œè¯¥ç¨‹åºéœ€è¦å¤„ç†å›¾åƒã€‚</p><ol><li><p><strong>æ™®é€šæ¨¡å¼ (napi_tsfn_release)</strong>ï¼š</p><ul><li>ä½ åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°ï¼Œè®©å…¶è°ƒç”¨ä¸€ä¸ª C++ å‡½æ•°æ¥å¤„ç†å›¾åƒã€‚</li><li>éšç€ç”¨æˆ·ä¸Šä¼ æ›´å¤šçš„å›¾ç‰‡ï¼Œä½ çš„åº”ç”¨ç¨‹åºå°†è¿™äº›å›¾ç‰‡æ¨é€åˆ°åŸç”Ÿé˜Ÿåˆ—ä¸­ã€‚</li><li>æœ€ç»ˆç”¨æˆ·åœæ­¢ä¸Šä¼ å›¾ç‰‡ï¼Œä½ å†³å®šå…³é—­åº”ç”¨ç¨‹åºã€‚</li><li>åœ¨å…³é—­å‰ï¼Œä½ ä½¿ç”¨ <code>napi_tsfn_release</code> æ¨¡å¼é‡Šæ”¾çº¿ç¨‹å®‰å…¨å‡½æ•°ï¼Œç¡®ä¿æ‰€æœ‰æ’é˜Ÿçš„å›¾åƒéƒ½å¾—åˆ°å¤„ç†ï¼Œç„¶åå†å…³é—­ã€‚</li></ul></li><li><p><strong>ä¸­æ­¢æ¨¡å¼ (napi_tsfn_abort)</strong>ï¼š</p><ul><li>åŒæ ·çš„æƒ…å†µï¼Œä½†çªç„¶é—´ä½ çš„åº”ç”¨ç¨‹åºéœ€è¦ç´§æ€¥å…³é—­ï¼ˆå¯èƒ½æ˜¯å› ä¸ºå†…å­˜æ³„éœ²æˆ–å…¶ä»–å…³é”®é”™è¯¯ï¼‰ã€‚</li><li>åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œä½ ä¸èƒ½ç­‰å¾…æ‰€æœ‰çš„å›¾ç‰‡éƒ½å¤„ç†å®Œæˆï¼Œå› æ­¤ä½ ä½¿ç”¨ <code>napi_tsfn_abort</code> æ¥å¿«é€Ÿé‡Šæ”¾çº¿ç¨‹å®‰å…¨å‡½æ•°ï¼Œç„¶åå…³é—­åº”ç”¨ç¨‹åºã€‚</li></ul></li></ol><p>é€šè¿‡ä½¿ç”¨åˆé€‚çš„é‡Šæ”¾æ¨¡å¼ï¼Œä½ å¯ä»¥æ›´å¥½åœ°æ§åˆ¶å¦‚ä½•å®‰å…¨åœ°ç»“æŸä¸ JavaScript è¿è¡Œæ—¶çš„äº¤äº’ï¼Œæ— è®ºæ˜¯æœ‰åºåœ°å®Œæˆæ‰€æœ‰ä»»åŠ¡è¿˜æ˜¯ç´§æ€¥ä¸­æ–­ã€‚</p><h3 id="napi-threadsafe-function-call-mode" tabindex="-1"><a class="header-anchor" href="#napi-threadsafe-function-call-mode"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_threadsafe_function_call_mode" target="_blank" rel="noopener noreferrer">napi_threadsafe_function_call_mode</a></span></a></h3><p><code>napi_threadsafe_function_call_mode</code> æ˜¯ Node.js ä¸­ N-API çš„ä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œå®ƒç”¨äºæŒ‡å®šè°ƒç”¨çº¿ç¨‹å®‰å…¨å‡½æ•°æ—¶çš„è¡Œä¸ºæ¨¡å¼ã€‚åœ¨è§£é‡Šè¿™ä¸ªæ¦‚å¿µä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£ä¸€äº›èƒŒæ™¯çŸ¥è¯†ã€‚</p><p>Node.js æ˜¯å•çº¿ç¨‹çš„ï¼Œè¿™æ„å‘³ç€å®ƒé»˜è®¤æƒ…å†µä¸‹åªä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œæ‰€æœ‰çš„ JavaScript ä»£ç ã€‚ç„¶è€Œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½éœ€è¦æ‰§è¡Œä¸€äº›è€—æ—¶çš„ä»»åŠ¡ï¼Œæ¯”å¦‚è¯»å–å¤§æ–‡ä»¶ã€è¿›è¡Œå¤æ‚è®¡ç®—æˆ–è€…è®¿é—®æ•°æ®åº“ç­‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œè¿™äº›è€—æ—¶çš„æ“ä½œï¼Œä¼šé€ æˆåº”ç”¨å“åº”ç¼“æ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒNode.js æä¾›äº† Worker çº¿ç¨‹ï¼ˆé€šè¿‡ <code>worker_threads</code> æ¨¡å—ï¼‰ï¼Œå…è®¸ä½ åˆ›å»ºé¢å¤–çš„çº¿ç¨‹æ¥å¤„ç†è¿™äº›è€—æ—¶ä»»åŠ¡ï¼Œè€Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚</p><p>ç„¶è€Œï¼Œå½“ä½ æƒ³è¦ä»è¿™äº›æ–°åˆ›å»ºçš„ Worker çº¿ç¨‹ä¸ä¸»çº¿ç¨‹ï¼ˆæˆ–è€…å…¶ä»– Worker çº¿ç¨‹ï¼‰é€šä¿¡æ—¶ï¼Œä½ éœ€è¦ä¸€ä¸ªå®‰å…¨çš„æ–¹å¼æ¥äº¤æ¢æ•°æ®å’Œå‘é€æ¶ˆæ¯ã€‚è¿™å°±æ˜¯ <code>napi_threadsafe_function</code> å‡½æ•°å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ï¼šå®ƒå…è®¸ä½ åˆ›å»ºä¸€ä¸ªå¯ä»¥ä»ä»»ä½•çº¿ç¨‹å®‰å…¨åœ°è°ƒç”¨çš„ JavaScript å‡½æ•°ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å›åˆ° <code>napi_threadsafe_function_call_mode</code>ã€‚è¿™ä¸ªæšä¸¾æœ‰ä¸¤ä¸ªå€¼ï¼Œå®ƒä»¬æ§åˆ¶å½“ä½ å°è¯•è°ƒç”¨çº¿ç¨‹å®‰å…¨å‡½æ•°æ—¶çš„è¡Œä¸ºï¼š</p><ol><li><code>napi_tsfn_blocking</code>: å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œè¯¥æ¨¡å¼ä¼šä½¿è°ƒç”¨è€…é˜»å¡ï¼ˆç­‰å¾…ï¼‰ï¼Œç›´åˆ°é˜Ÿåˆ—æœ‰ç©ºä½è®©è°ƒç”¨è€…æ’å…¥å®ƒçš„è¯·æ±‚ã€‚</li><li><code>napi_tsfn_nonblocking</code>: å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œè¯¥æ¨¡å¼ä¼šç›´æ¥è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œä¸ä¼šé˜»å¡è°ƒç”¨è€…ã€‚</li></ol><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-2" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-2"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦ä»å¤šä¸ªç½‘ç»œèµ„æºä¸‹è½½æ•°æ®ã€‚æ¯ä¸ªä¸‹è½½å¯èƒ½ä¼šèŠ±è´¹è¾ƒé•¿æ—¶é—´ï¼Œæ‰€ä»¥ä½ å†³å®šåœ¨ Worker çº¿ç¨‹ä¸­æ‰§è¡Œä¸‹è½½ä»»åŠ¡ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> Worker</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> isMainThread</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> parentPort</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">worker_threads</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">isMainThread</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">  // ä¸»çº¿ç¨‹ä»£ç </span></span>
<span class="line"><span style="color:#81A1C1;">  const</span><span style="color:#D8DEE9;"> worker</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Worker</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">__filename</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // ç›‘å¬æ¥è‡ª Worker çš„æ¶ˆæ¯</span></span>
<span class="line"><span style="color:#D8DEE9;">  worker</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">message</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">msg</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Received from worker:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> msg</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // Worker çº¿ç¨‹ä»£ç </span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // æ¨¡æ‹Ÿä¸€äº›è€—æ—¶çš„æ“ä½œ</span></span>
<span class="line"><span style="color:#88C0D0;">  setTimeout</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    parentPort</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">postMessage</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Download complete</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span><span style="color:#B48EAD;"> 2000</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª Worker çº¿ç¨‹æ¥æ¨¡æ‹Ÿä¸€ä¸ªè€—æ—¶çš„ä¸‹è½½æ“ä½œã€‚ç„¶åï¼Œå½“ä¸‹è½½å®Œæˆåï¼ŒWorker å‘é€ä¸€ä¸ªæ¶ˆæ¯å›ä¸»çº¿ç¨‹ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ”¹è¿›è¿™ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬çš„ä¸‹è½½å‡½æ•°æ˜¯ä¸€ä¸ªåŸç”Ÿçš„ C++ æ’ä»¶ï¼Œå¹¶ä½¿ç”¨ N-API åˆ›å»ºçº¿ç¨‹å®‰å…¨å‡½æ•°æ¥ä» Worker çº¿ç¨‹ä¸­é€šçŸ¥ä¸»çº¿ç¨‹ä¸‹è½½å®Œæˆã€‚</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" data-title="c++" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å‡è®¾è¿™æ˜¯ä¸€ä¸ª C++ æ’ä»¶çš„ä»£ç ç‰‡æ®µ</span></span>
<span class="line"><span>napi_value DownloadComplete(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  // è·å–çº¿ç¨‹å®‰å…¨å‡½æ•°å¯¹è±¡ï¼Œå¹¶è°ƒç”¨å®ƒ</span></span>
<span class="line"><span>  napi_status status = napi_call_threadsafe_function(my_tsfn, &quot;Download complete&quot;, napi_tsfn_blocking);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  return nullptr;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ª C++ ä»£ç ç‰‡æ®µä¸­ï¼Œ<code>my_tsfn</code> æ˜¯ä¹‹å‰åˆ›å»ºçš„çº¿ç¨‹å®‰å…¨å‡½æ•°å¯¹è±¡ã€‚æˆ‘ä»¬å°è¯•ç”¨ <code>napi_call_threadsafe_function</code> è°ƒç”¨å®ƒï¼Œå¹¶ä¼ é€’ <code>&quot;Download complete&quot;</code> å­—ç¬¦ä¸²ä½œä¸ºæ¶ˆæ¯ã€‚æˆ‘ä»¬ä½¿ç”¨ <code>napi_tsfn_blocking</code> æ¨¡å¼ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›åœ¨é˜Ÿåˆ—æ»¡æ—¶ç­‰å¾…ï¼Œç›´åˆ°æœ‰ç©ºé—´å¯ä»¥å‘é€æ¶ˆæ¯ã€‚</p><p>å¦‚æœæˆ‘ä»¬æƒ³è¦éé˜»å¡è¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹© <code>napi_tsfn_nonblocking</code> æ¨¡å¼ï¼Œè¿™æ ·å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œå‡½æ•°å°†ç«‹å³è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬å¯ä»¥æ®æ­¤å†³å®šæ˜¯å¦é‡è¯•æˆ–é‡‡å–å…¶ä»–æªæ–½ã€‚</p><h3 id="node-api-memory-management-types" tabindex="-1"><a class="header-anchor" href="#node-api-memory-management-types"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#node-api-memory-management-types" target="_blank" rel="noopener noreferrer">Node-API memory management types</a></span></a></h3><p>Node-APIï¼ˆä¹‹å‰ç§°ä¸º N-APIï¼‰æ˜¯ Node.js çš„ä¸€ä¸ªéƒ¨åˆ†ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç¨³å®šä¸”ç‹¬ç«‹äº JavaScript è¿è¡Œæ—¶çš„ APIï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥æ„å»ºåŸç”Ÿæ¨¡å—ã€‚è¿™äº›åŸç”Ÿæ¨¡å—æ˜¯ç”¨ C æˆ– C++ç¼–å†™çš„ï¼Œå¹¶ä¸”å¯ä»¥è¢« Node.js ç›´æ¥è°ƒç”¨ã€‚Node-API ä¿è¯äº†è·¨ä¸åŒç‰ˆæœ¬çš„ Node.js äºŒè¿›åˆ¶å…¼å®¹æ€§ï¼Œè¿™æ„å‘³ç€åŸç”Ÿæ¨¡å—ä¸éœ€è¦é’ˆå¯¹æ¯ä¸ªæ–°ç‰ˆæœ¬çš„ Node.js é‡æ–°ç¼–è¯‘ã€‚</p><p>è®©æˆ‘ä»¬æ¥è°ˆè°ˆåœ¨ Node-API ä¸­æ¶‰åŠå†…å­˜ç®¡ç†çš„ç±»å‹ã€‚åœ¨ Node-API ä¸­ï¼Œä½ ä¼šé‡åˆ°å‡ ç§ä¸å†…å­˜ç®¡ç†ç›¸å…³çš„ç±»å‹å’Œæ–¹æ³•ï¼Œè¿™äº›éƒ½æ˜¯ä¸ºäº†ç¡®ä¿èµ„æºæœ‰æ•ˆåœ°ä½¿ç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚ä»¥ä¸‹æ˜¯å…¶ä¸­ä¸€äº›ä¸»è¦çš„æ¦‚å¿µï¼š</p><ol><li><p><strong><code>napi_value</code></strong>: è¿™æ˜¯ä¸€ä¸ªè¡¨ç¤º JavaScript å€¼çš„æŠ½è±¡ç±»å‹ï¼Œåœ¨ Node-API å‡½æ•°ä¸­ç»å¸¸ä½¿ç”¨ã€‚å½“ä½ åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å¯¹è±¡ã€å­—ç¬¦ä¸²æˆ–ä»»ä½•å…¶ä»– JS å€¼æ—¶ï¼ŒNode-API é€šå¸¸ä¼šè¿”å›ä¸€ä¸ª<code>napi_value</code>ã€‚</p></li><li><p><strong>å¼•ç”¨ï¼ˆReferenceï¼‰</strong>: åœ¨ Node-API ä¸­ï¼Œå¼•ç”¨æ˜¯ä¸€ä¸ªæŒ‡å‘<code>napi_value</code>çš„æŒ‡é’ˆï¼Œå®ƒç¡®ä¿äº†å³ä½¿åœ¨æœ¬åœ°ä»£ç æ‰§è¡Œå®Œæˆåï¼Œè¯¥å€¼ä»ç„¶ä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚åœ¨ Node-API ä¸­ï¼Œä½ å¯ä»¥åˆ›å»ºå¼±å¼•ç”¨æˆ–å¼ºå¼•ç”¨ã€‚</p><ul><li><p><strong>å¼ºå¼•ç”¨</strong>ï¼šä¿æŒäº†å¯¹<code>napi_value</code>çš„ä¸€ä¸ªæ´»è·ƒçš„å¼•ç”¨ï¼Œè¿™æ„å‘³ç€åªè¦å¼•ç”¨å­˜åœ¨ï¼Œåƒåœ¾å›æ”¶å™¨å°±ä¸ä¼šé‡Šæ”¾è¯¥å€¼ã€‚è¿™åœ¨ä½ éœ€è¦é•¿æœŸæŒæœ‰ä¸€ä¸ªå€¼æ—¶éå¸¸æœ‰ç”¨ã€‚</p></li><li><p><strong>å¼±å¼•ç”¨</strong>ï¼šä¸ä¿è¯<code>napi_value</code>çš„ç”Ÿå‘½å‘¨æœŸã€‚åƒåœ¾å›æ”¶å™¨å¯ä»¥éšæ—¶é‡Šæ”¾æ‰ç›¸å…³è”çš„å€¼ã€‚è¿™å¯¹äºå…è®¸å†…å­˜é‡Šæ”¾ï¼ŒåŒæ—¶ä¾ç„¶èƒ½å¤Ÿå¶å°”è®¿é—®å€¼çš„åœºæ™¯å¾ˆæœ‰ç”¨ã€‚</p></li></ul></li><li><p><strong><code>napi_finalize</code></strong>: è¿™æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“ä¸€ä¸ªä¸<code>napi_value</code>ç›¸å…³è”çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶æ—¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚å®ƒå…è®¸ä½ è¿›è¡Œæ¸…ç†æ“ä½œï¼Œæ¯”å¦‚é‡Šæ”¾åœ¨åŸç”Ÿå±‚åˆ†é…çš„å†…å­˜ã€‚</p></li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜è¿™äº›æ¦‚å¿µï¼š</p><p>å‡è®¾ä½ æ­£åœ¨åˆ›å»ºä¸€ä¸ª Node.js åŸç”Ÿæ¨¡å—ï¼Œè¯¥æ¨¡å—åŒ…å«äº†ä¸€ä¸ªåŸç”Ÿ C++å¯¹è±¡ã€‚ä½ æƒ³è¦åœ¨ JavaScript å±‚æ¬¡ä¸Šæš´éœ²è¿™ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”æƒ³è¦åœ¨è¯¥å¯¹è±¡ä¸å†éœ€è¦æ—¶è‡ªåŠ¨æ¸…ç†å®ƒæ‰€å ç”¨çš„èµ„æºã€‚</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™æ˜¯ä½ çš„C++å¯¹è±¡</span></span>
<span class="line"><span>class MyObject {</span></span>
<span class="line"><span>public:</span></span>
<span class="line"><span>    MyObject() { /* æ„é€ å‡½æ•°é€»è¾‘ */ }</span></span>
<span class="line"><span>    ~MyObject() { /* ææ„å‡½æ•°é€»è¾‘ï¼Œä¾‹å¦‚é‡Šæ”¾åˆ†é…çš„å†…å­˜ */ }</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯å½“JSå¯¹è±¡è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶æ—¶ï¼Œå°†è¢«è°ƒç”¨çš„å›è°ƒå‡½æ•°</span></span>
<span class="line"><span>void FinalizeCallback(napi_env env, void* finalize_data, void* finalize_hint) {</span></span>
<span class="line"><span>    // å°†finalize_dataè½¬å‹å›MyObjectæŒ‡é’ˆå¹¶åˆ é™¤å®ƒ</span></span>
<span class="line"><span>    MyObject* obj = static_cast`&lt;`MyObject*&gt;(finalize_data);</span></span>
<span class="line"><span>    delete obj;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯ä¸€ä¸ªNode-APIå‡½æ•°ï¼Œå®ƒåˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªæ–°çš„MyObjectå®ä¾‹çš„å°è£…</span></span>
<span class="line"><span>napi_value CreateMyObject(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„C++ MyObjectå®ä¾‹</span></span>
<span class="line"><span>    MyObject* obj = new MyObject();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºJSå¯¹è±¡</span></span>
<span class="line"><span>    napi_value js_obj;</span></span>
<span class="line"><span>    napi_create_object(env, &amp;js_obj);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†C++å¯¹è±¡ä¸JSå¯¹è±¡å…³è”ï¼Œå¹¶è®¾ç½®FinalizeCallbackä½œä¸ºææ„å›è°ƒ</span></span>
<span class="line"><span>    napi_wrap(env, js_obj, obj, FinalizeCallback, nullptr, nullptr);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›åˆ›å»ºçš„JSå¯¹è±¡</span></span>
<span class="line"><span>    return js_obj;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä½ éœ€è¦å°†CreateMyObjectå‡½æ•°æš´éœ²ç»™JavaScriptï¼Œè¿™æ ·ä½ å°±å¯ä»¥åœ¨JSä»£ç ä¸­è°ƒç”¨å®ƒ</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½ åˆ›å»ºäº†ä¸€ä¸ª C++å¯¹è±¡ï¼Œå¹¶é€šè¿‡ Node-API å°†å…¶å°è£…åœ¨ä¸€ä¸ª JavaScript å¯¹è±¡ä¸­ã€‚ä½ è¿˜è®¾ç½®äº†ä¸€ä¸ª<code>FinalizeCallback</code>å›è°ƒï¼Œå½“ JavaScript å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶ï¼Œè¿™ä¸ªå›è°ƒä¼šè¢«è§¦å‘ä»¥æ¸…ç† C++å¯¹è±¡ã€‚è¿™æ ·ï¼Œä½ å°±å®ç°äº†åœ¨åŸç”Ÿæ¨¡å—å’Œ JavaScript ä¹‹é—´çš„æ¡¥æ¢ï¼ŒåŒæ—¶ç¡®ä¿äº†è‰¯å¥½çš„å†…å­˜ç®¡ç†ã€‚</p><h4 id="napi-handle-scope" tabindex="-1"><a class="header-anchor" href="#napi-handle-scope"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_handle_scope" target="_blank" rel="noopener noreferrer">napi_handle_scope</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚åœ¨ Node.js ä¸­ï¼ŒJavaScript é€šå¸¸è¿è¡Œåœ¨ V8 å¼•æ“ä¸Šï¼Œè€Œ N-API å…è®¸å¼€å‘è€…ä½¿ç”¨ C æˆ– C++ ä»£ç ä¸ JavaScript è¿›è¡Œäº¤äº’ã€‚</p><p><code>napi_handle_scope</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå®ƒå’Œåƒåœ¾å›æ”¶æœºåˆ¶æœ‰å…³ã€‚åœ¨ JavaScript ä¸­ï¼Œå½“ä½ åˆ›å»ºäº†å¾ˆå¤šå¯¹è±¡ï¼ˆæ¯”å¦‚å­—ç¬¦ä¸²ã€æ•°ç»„ã€å¯¹è±¡ç­‰ï¼‰ä»¥åï¼Œè¿™äº›å¯¹è±¡ä¼šå ç”¨å†…å­˜ã€‚ä¸ºäº†é‡Šæ”¾ä¸å†éœ€è¦çš„å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ï¼ŒV8 å¼•æ“ä¼šå®šæœŸæ‰§è¡Œåƒåœ¾å›æ”¶ã€‚</p><p>å½“ä½ åœ¨ä½¿ç”¨ N-API ç¼–å†™åŸç”Ÿæ¨¡å—æ—¶ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¾ˆå¤šå’Œ JavaScript äº¤äº’çš„å¯¹è±¡ã€‚<code>napi_handle_scope</code> å°±æ˜¯ç”¨æ¥ç®¡ç†è¿™äº›å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚æ¯ä¸ª <code>napi_handle_scope</code> éƒ½æ˜¯ä¸€ç³»åˆ— N-API å¯¹è±¡çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼ŒN-API ä¼šè´Ÿè´£è·Ÿè¸ªåœ¨è¿™ä¸ªä½œç”¨åŸŸä¸­åˆ›å»ºçš„æ‰€æœ‰å¯¹è±¡ï¼Œå¹¶åœ¨è¿™ä¸ªä½œç”¨åŸŸç»“æŸæ—¶ï¼Œç¡®ä¿è¿™äº›å¯¹è±¡èƒ½å¤Ÿè¢«åƒåœ¾å›æ”¶å™¨æ­£ç¡®åœ°å¤„ç†ã€‚</p><p>ä½¿ç”¨ <code>napi_handle_scope</code> çš„å®é™…ä¾‹å­ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js çš„åŸç”Ÿæ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript æ•°ç»„ï¼Œå¹¶åœ¨è¿™ä¸ªæ•°ç»„ä¸­å¡«å……ä¸€äº›æ•°å­—ã€‚ä½ å¯ä»¥è¿™æ ·åšï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ JavaScript æ•°ç»„ï¼Œæ•°ç»„ä¸­åŒ…å«äº†ä»0åˆ°9çš„æ•°å­—ã€‚</span></span>
<span class="line"><span>napi_value CreateArrayWithNumbers(napi_env env) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„ handle scope</span></span>
<span class="line"><span>    napi_handle_scope scope;</span></span>
<span class="line"><span>    status = napi_open_handle_scope(env, &amp;scope);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript æ•°ç»„</span></span>
<span class="line"><span>    napi_value array;</span></span>
<span class="line"><span>    status = napi_create_array_with_length(env, 10, &amp;array);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¡«å……æ•°ç»„</span></span>
<span class="line"><span>    for (int i = 0; i `&lt;` 10; ++i) {</span></span>
<span class="line"><span>        napi_value num;</span></span>
<span class="line"><span>        status = napi_create_int32(env, i, &amp;num);</span></span>
<span class="line"><span>        if (status != napi_ok) {</span></span>
<span class="line"><span>            // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // æŠŠæ•°å­—è®¾ç½®åˆ°æ•°ç»„å¯¹åº”çš„ç´¢å¼•ä¸Š</span></span>
<span class="line"><span>        status = napi_set_element(env, array, i, num);</span></span>
<span class="line"><span>        if (status != napi_ok) {</span></span>
<span class="line"><span>            // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å…³é—­ handle scopeï¼Œåœ¨è¿™ä¹‹åï¼Œæˆ‘ä»¬åˆ›å»ºçš„æ‰€æœ‰æœ¬åœ°å¯¹è±¡éƒ½å¯ä»¥è¢«åƒåœ¾å›æ”¶äº†</span></span>
<span class="line"><span>    status = napi_close_handle_scope(env, scope);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return array;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆæ‰“å¼€äº†ä¸€ä¸ª <code>napi_handle_scope</code>ï¼Œç„¶åæ‰§è¡Œäº†åˆ›å»ºæ•°ç»„å’Œå¡«å……æ•°ç»„çš„æ“ä½œã€‚åœ¨æ“ä½œå®Œæˆåï¼Œæˆ‘ä»¬å…³é—­äº† <code>napi_handle_scope</code>ã€‚å…³é—­æ“ä½œå‘Šè¯‰ N-APIï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªä½œç”¨åŸŸä¸­åˆ›å»ºçš„æ‰€æœ‰å¯¹è±¡åœ¨è¿™ä¹‹åéƒ½ä¸å†éœ€è¦äº†ï¼Œå› æ­¤å®ƒä»¬å¯ä»¥è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼Œ<code>napi_handle_scope</code> è¢«ç”¨äºåœ¨ç¼–å†™åŸç”Ÿæ¨¡å—æ—¶ç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œç¡®ä¿å®ƒä»¬èƒ½åœ¨åˆé€‚çš„æ—¶å€™è¢«åƒåœ¾å›æ”¶ï¼Œä»¥æ­¤é¿å…å†…å­˜æ³„éœ²ã€‚</p><h4 id="napi-escapable-handle-scope" tabindex="-1"><a class="header-anchor" href="#napi-escapable-handle-scope"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_escapable_handle_scope" target="_blank" rel="noopener noreferrer">napi_escapable_handle_scope</a></span></a></h4><p>å½“ç„¶ï¼Œæˆ‘ä¼šç”¨å°½å¯èƒ½ç®€å•çš„è¯­è¨€æ¥è§£é‡Š <code>napi_escapable_handle_scope</code>ã€‚</p><p>é¦–å…ˆï¼Œè¦äº†è§£ <code>napi_escapable_handle_scope</code> çš„æ¦‚å¿µï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£ Node.js ä¸­çš„ N-API ä»¥åŠå®ƒä¸ºä½•å­˜åœ¨ã€‚</p><p><strong>N-API æ˜¯ä»€ä¹ˆï¼Ÿ</strong><br> N-API æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç¨³å®šçš„åŸç”Ÿï¼ˆC/C++ï¼‰API å±‚ã€‚å®ƒå…è®¸åŸç”Ÿæ¨¡å—ï¼ˆnative modulesï¼‰å¼€å‘è€…ç¼–å†™ä¸ Node.js ç‰ˆæœ¬æ— å…³çš„ä»£ç ï¼Œè¿™å°±æ„å‘³ç€ä¸€æ—¦ä½ ç¼–å†™äº†ä½¿ç”¨ N-API çš„åŸç”Ÿæ¨¡å—ï¼Œå®ƒå¯ä»¥åœ¨æœªæ¥çš„ Node.js ç‰ˆæœ¬ä¸­è¿è¡Œï¼Œè€Œä¸éœ€è¦é‡æ–°ç¼–è¯‘ã€‚</p><p><strong>ä»€ä¹ˆæ˜¯ Handle Scopeï¼Ÿ</strong><br> åœ¨ Node.js ä¸­ï¼ŒJavaScript å’ŒåŸç”Ÿä»£ç ï¼ˆæ¯”å¦‚ C/C++ ä»£ç ï¼‰ä¹‹é—´æœ‰ä¸€ä¸ªæ¡¥æ¢ï¼Œé‚£å°±æ˜¯ V8 å¼•æ“ã€‚åœ¨ V8 ä¸­ï¼Œæ‰€æœ‰çš„ JavaScript å¯¹è±¡éƒ½è¢«è¡¨ç¤ºä¸º &quot;handles&quot;ï¼ˆå¥æŸ„ï¼‰ã€‚Handle Scopes æ˜¯ V8 æä¾›çš„ä¸€ç§ç®¡ç†å†…å­˜çš„æœºåˆ¶ï¼Œå®ƒå¯ä»¥ç¡®ä¿å¯¹è±¡ï¼ˆhandlesï¼‰ä¸ä¼šæ³„æ¼ï¼Œå¹¶ä¸”åœ¨åˆé€‚çš„æ—¶å€™å¾—åˆ°æ¸…ç†ã€‚</p><p><strong>é‚£ä¹ˆ napi_escapable_handle_scope æ˜¯ä»€ä¹ˆï¼Ÿ</strong><br><code>napi_escapable_handle_scope</code> æ˜¯ä¸€ä¸ªç‰¹æ®Šç±»å‹çš„ handle scopeï¼Œå®ƒå…è®¸ä¸€ä¸ªä»å…¶ä¸­åˆ›å»ºçš„å¥æŸ„â€œé€ƒé€¸â€å‡ºæ¥ï¼Œå˜æˆå¯ä»¥åœ¨çˆ¶çº§ä½œç”¨åŸŸä¸­ä½¿ç”¨çš„å¥æŸ„ã€‚</p><p>åœ¨ N-API ä¸­ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ª <code>napi_handle_scope</code> æ¥ç®¡ç†æˆ‘ä»¬åˆ›å»ºçš„å¥æŸ„ï¼Œè¿™æ ·å¯ä»¥é¿å…å†…å­˜æ³„éœ²ã€‚è€Œå½“æˆ‘ä»¬æƒ³è¦å°†æŸä¸ªå¥æŸ„ä¼ é€’ç»™å¦å¤–ä¸€ä¸ªä½œç”¨åŸŸä½¿ç”¨æ—¶ï¼Œæ™®é€šçš„ <code>napi_handle_scope</code> æ˜¯åšä¸åˆ°çš„ï¼Œè¿™æ—¶æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ° <code>napi_escapable_handle_scope</code>ã€‚</p><p><strong>å®é™…è¿ç”¨ä¾‹å­ï¼š</strong><br> è®©æˆ‘ä»¬å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œè¯¥æ¨¡å—éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å¯¹è±¡å¹¶è¿”å›ç»™è°ƒç”¨è€…ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CreateObject(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_escapable_handle_scope scope;</span></span>
<span class="line"><span>    napi_value object;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ª escapable handle scope</span></span>
<span class="line"><span>    status = napi_open_escapable_handle_scope(env, &amp;scope);</span></span>
<span class="line"><span>    if (status != napi_ok) return nullptr;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å¯¹è±¡</span></span>
<span class="line"><span>    status = napi_create_object(env, &amp;object);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        napi_close_escapable_handle_scope(env, scope);</span></span>
<span class="line"><span>        return nullptr;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿™é‡Œå¯ä»¥è®¾ç½®å¯¹è±¡çš„å±æ€§ç­‰</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // &quot;é€ƒé€¸&quot;è¿™ä¸ªå¯¹è±¡å‡ºå»ï¼Œä½¿å®ƒèƒ½åœ¨å‡½æ•°å¤–éƒ¨ä½¿ç”¨</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    status = napi_escape_handle(env, scope, object, &amp;result);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        napi_close_escapable_handle_scope(env, scope);</span></span>
<span class="line"><span>        return nullptr;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å…³é—­ handle scope</span></span>
<span class="line"><span>    status = napi_close_escapable_handle_scope(env, scope);</span></span>
<span class="line"><span>    if (status != napi_ok) return nullptr;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return result; // è¿”å›é€ƒé€¸åçš„å¯¹è±¡</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆæ‰“å¼€äº†ä¸€ä¸ª escapable handle scopeï¼Œè¿™å…è®¸æˆ‘ä»¬ç¨åé€šè¿‡ <code>napi_escape_handle</code> å‡½æ•°å°†åˆ›å»ºçš„ JavaScript å¯¹è±¡ä¼ é€’åˆ°è¿™ä¸ªä½œç”¨åŸŸä¹‹å¤–ã€‚ç„¶åæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¹¶é€šè¿‡ <code>napi_escape_handle</code> &quot;é€ƒé€¸&quot; è¿™ä¸ªå¯¹è±¡ã€‚æœ€åï¼Œæˆ‘ä»¬å…³é—­äº† handle scope å¹¶è¿”å›äº†é€ƒé€¸çš„å¯¹è±¡ã€‚</p><p>è¿™å°±æ˜¯ <code>napi_escapable_handle_scope</code> çš„åŸºæœ¬ç”¨æ³•ï¼Œå®ƒåœ¨ç¼–å†™æ¶‰åŠè·¨ä½œç”¨åŸŸä¼ é€’ JavaScript å¯¹è±¡çš„åŸç”Ÿæ¨¡å—æ—¶éå¸¸æœ‰ç”¨ã€‚</p><h4 id="napi-ref" tabindex="-1"><a class="header-anchor" href="#napi-ref"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_ref" target="_blank" rel="noopener noreferrer">napi_ref</a></span></a></h4><p>å¥½çš„ï¼Œé¦–å…ˆæˆ‘ä¼šç®€å•ä»‹ç»ä¸€ä¸‹ Node.js å’Œ N-API æ˜¯ä»€ä¹ˆï¼Œç„¶åå†è¯¦ç»†è§£é‡Š napi_refï¼Œå¹¶ç»™å‡ºå®é™…çš„ä¾‹å­ã€‚</p><p><strong>Node.js ç®€ä»‹</strong>ï¼š<br> Node.js æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœåŠ¡å™¨ç«¯å’Œç½‘ç»œåº”ç”¨ç¨‹åºçš„å¼€æºè·¨å¹³å° JavaScript è¿è¡Œæ—¶ç¯å¢ƒã€‚å®ƒå…è®¸ä½ ä½¿ç”¨ JavaScript ç¼–å†™æœåŠ¡å™¨ç«¯ä»£ç ï¼Œè¿™æ˜¯ä¸€ç§é€šå¸¸ä»…ç”¨äºç¼–å†™ç½‘é¡µå‰ç«¯ä»£ç çš„è¯­è¨€ã€‚</p><p><strong>N-API ç®€ä»‹</strong>ï¼š<br> N-API æ˜¯ Node.js æä¾›çš„ä¸€ä¸ª C APIï¼Œå®ƒæ—¨åœ¨å‡å°‘ Node.js åŸç”Ÿæ’ä»¶ä¸ä¸åŒç‰ˆæœ¬çš„ V8 å¼•æ“ï¼ˆNode.js çš„åº•å±‚ JavaScript å¼•æ“ï¼‰ä¹‹é—´çš„å…¼å®¹æ€§é—®é¢˜ã€‚ç®€è€Œè¨€ä¹‹ï¼ŒN-API è®©å¼€å‘è€…å¯ä»¥ç¼–å†™åªéœ€è¦ç¼–è¯‘ä¸€æ¬¡å°±èƒ½åœ¨å¤šä¸ªç‰ˆæœ¬çš„ Node.js ä¸Šè¿è¡Œçš„åŸç”Ÿæ’ä»¶ã€‚</p><p><strong>napi_ref æ˜¯ä»€ä¹ˆ</strong>ï¼š<br><code>napi_ref</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œä»£è¡¨ä¸€ä¸ªå¯¹ JavaScript å¯¹è±¡çš„å¼•ç”¨ã€‚åœ¨ Node.js çš„åŸç”Ÿæ’ä»¶ä¸­ï¼Œå½“ä½ æƒ³è¦ä¿æŒå¯¹æŸä¸ª JavaScript å¯¹è±¡çš„å¼•ç”¨ï¼Œä»¥ä¾¿åœ¨å°†æ¥çš„æœ¬åœ°å‡½æ•°è°ƒç”¨ä¸­ä½¿ç”¨å®ƒæ—¶ï¼Œä½ ä¼šç”¨åˆ° <code>napi_ref</code>ã€‚</p><p>å¦‚æœæ²¡æœ‰ <code>napi_ref</code>ï¼ŒJavaScript å¯¹è±¡å¯èƒ½ä¼šå› ä¸ºåƒåœ¾å›æ”¶è€Œè¢«é”€æ¯ï¼Œç‰¹åˆ«æ˜¯å½“å¯¹è±¡ä¸å†è¢«ä»»ä½•å˜é‡å¼•ç”¨æ—¶ã€‚é€šè¿‡åˆ›å»ºä¸€ä¸ª <code>napi_ref</code>ï¼Œä½ å¯ä»¥ç¡®ä¿è¯¥å¯¹è±¡åœ¨æœ¬åœ°ä»£ç ä¸­ä»ç„¶æœ‰æ•ˆï¼Œç›´åˆ°ä½ ä¸»åŠ¨åˆ é™¤è¯¥å¼•ç”¨ã€‚</p><p><strong>å®é™…çš„ä¾‹å­</strong>ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åŸç”Ÿæ’ä»¶ï¼Œè¯¥æ’ä»¶éœ€è¦åœ¨æœ¬åœ°ä»£ç ä¸­ä¿å­˜ä¸€ä¸ª JavaScript å‡½æ•°ï¼Œä»¥ä¾¿ç¨åè°ƒç”¨å®ƒã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>napi_create_reference</code> åˆ›å»ºä¸€ä¸ª <code>napi_ref</code> æ¥å­˜å‚¨å¯¹è¯¥å‡½æ•°çš„å¼•ç”¨ã€‚</p><p>ä»¥ä¸‹æ˜¯å¦‚ä½•åœ¨ N-API ä¸­åˆ›å»ºå’Œä½¿ç”¨ <code>napi_ref</code> çš„ç®€å•ç¤ºä¾‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡æ¥å­˜å‚¨å¼•ç”¨</span></span>
<span class="line"><span>static napi_ref myFunctionRef;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¸€ä¸ªåˆå§‹åŒ–å‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ª JavaScript å‡½æ•°å¹¶ä¿å­˜å®ƒçš„å¼•ç”¨</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>  // è·å–ä¼ å…¥çš„å‚æ•°ï¼ˆæˆ‘ä»¬å‡å®šæ˜¯ä¸€ä¸ªå‡½æ•°ï¼‰</span></span>
<span class="line"><span>  napi_value myFunction;</span></span>
<span class="line"><span>  napi_get_cb_info(env, args, &amp;myFunction, NULL, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ªå¼•ç”¨</span></span>
<span class="line"><span>  napi_create_reference(env, myFunction, 1, &amp;myFunctionRef);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¸€ä¸ªè°ƒç”¨ä¿å­˜çš„ JavaScript å‡½æ•°çš„å‡½æ•°</span></span>
<span class="line"><span>void CallMyFunction(napi_env env) {</span></span>
<span class="line"><span>  napi_value myFunction;</span></span>
<span class="line"><span>  napi_get_reference_value(env, myFunctionRef, &amp;myFunction);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è°ƒç”¨è¯¥å‡½æ•°</span></span>
<span class="line"><span>  napi_value global;</span></span>
<span class="line"><span>  napi_get_global(env, &amp;global);</span></span>
<span class="line"><span>  napi_call_function(env, global, myFunction, 0, NULL, NULL);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ é™¤å¼•ç”¨</span></span>
<span class="line"><span>void DeleteReference(napi_env env) {</span></span>
<span class="line"><span>  napi_delete_reference(env, myFunctionRef);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>Init</code> çš„åˆå§‹åŒ–å‡½æ•°ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªå¼•ç”¨æ¥ä¿å­˜ JavaScript ç¯å¢ƒä¸­ä¼ é€’è¿›æ¥çš„å‡½æ•°ã€‚ç„¶åï¼Œåœ¨ <code>CallMyFunction</code> å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸ªå¼•ç”¨è·å–å‡½æ•°å¯¹è±¡å¹¶è°ƒç”¨å®ƒã€‚æœ€åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>DeleteReference</code> å‡½æ•°æ¥åˆ é™¤è¿™ä¸ªå¼•ç”¨ï¼Œä»¥å…è®¸ JavaScript å¯¹è±¡è¢«åƒåœ¾å›æ”¶ã€‚</p><p>è¯·æ³¨æ„ï¼Œè¿™é‡Œçš„ä¾‹å­éå¸¸ç®€å•ï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦æ›´å¤šçš„é”™è¯¯æ£€æŸ¥å’Œèµ„æºç®¡ç†æœºåˆ¶ã€‚</p><h4 id="napi-type-tag" tabindex="-1"><a class="header-anchor" href="#napi-type-tag"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_type_tag" target="_blank" rel="noopener noreferrer">napi_type_tag</a></span></a></h4><p>N-API æ˜¯ Node.js çš„ä¸€ä¸ª APIï¼Œå®ƒæä¾›äº†ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œä½¿å¾—ä½ å¯ä»¥åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js è¿è¡Œæ—¶ä¸­ç¼–å†™åŸç”Ÿæ’ä»¶ï¼Œè€Œä¸ç”¨æ‹…å¿ƒåº•å±‚çš„å˜åŒ–ã€‚<code>napi_type_tag</code>æ˜¯ N-API ä¸­çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œæ—¨åœ¨å¸®åŠ©ä½ ç¡®ä¿ä½ åœ¨ JavaScript å’Œ C ä¹‹é—´ä¼ é€’çš„å¯¹è±¡æ˜¯æ­£ç¡®çš„ç±»å‹ã€‚</p><p>è¦ç†è§£<code>napi_type_tag</code>çš„ä½œç”¨ï¼Œæˆ‘ä»¬å…ˆå¾—çŸ¥é“ç±»å‹æ ‡è®°ï¼ˆtype taggingï¼‰æ˜¯ä»€ä¹ˆã€‚ç±»å‹æ ‡è®°æ˜¯ä¸€ç§æŠ€æœ¯ï¼Œç”¨äºæ ‡è¯†ç‰¹å®šçš„å¯¹è±¡ï¼Œä»¥ä¾¿èƒ½å¤ŸéªŒè¯å¯¹è±¡æ˜¯å¦ä¸ºé¢„æœŸçš„ç±»å‹ã€‚å½“ä½ åœ¨ C å’Œ JavaScript ä¹‹é—´ä¼ é€’å¯¹è±¡æ—¶ï¼Œæœ‰æ—¶ä½ éœ€è¦ç¡®ä¿æ¥æ”¶åˆ°çš„å¯¹è±¡æ­£æ˜¯ä½ å‘é€çš„å¯¹è±¡çš„ç±»å‹ï¼Œè¿™æ ·æ‰èƒ½å®‰å…¨åœ°è¿›è¡Œæ“ä½œã€‚</p><p>ä½¿ç”¨<code>napi_type_tag</code>ï¼Œä½ å¯ä»¥ç»™ä¸€ä¸ªè‡ªå®šä¹‰çš„å¯¹è±¡æŒ‡å®šä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„&quot;æ ‡ç­¾&quot;ï¼ˆå³<code>napi_type_tag</code>ç»“æ„ï¼‰ã€‚ç„¶åï¼Œæ¯æ¬¡è¯¥å¯¹è±¡é€šè¿‡ N-API æ¥å£ä» C ä¼ åˆ° JavaScript æˆ–ä» JavaScript ä¼ å› C æ—¶ï¼ŒN-API éƒ½ä¼šæ£€æŸ¥è¿™ä¸ªæ ‡ç­¾ç¡®ä¿å®ƒåŒ¹é…ï¼Œå¦‚æœä¸åŒ¹é…ï¼Œå°±ä¼šæŠ¥é”™ã€‚</p><p>ä¸¾ä¾‹è¯´æ˜ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åŸç”Ÿæ¨¡å—ï¼Œè¯¥æ¨¡å—æä¾›äº†ä¸€ä¸ªåä¸ºâ€œMyObjectâ€çš„è‡ªå®šä¹‰å¯¹è±¡ï¼Œå¹¶ä¸”ä½ æƒ³ç¡®ä¿åªæœ‰â€œMyObjectâ€å®ä¾‹å¯ä»¥è¢«ç”¨äºæŸäº›ç‰¹å®šçš„å‡½æ•°è°ƒç”¨ã€‚</p><ol><li>é¦–å…ˆï¼Œä½ ä¼šåˆ›å»ºä¸€ä¸ªå…¨å±€çš„<code>napi_type_tag</code>å˜é‡æ¥ä»£è¡¨&quot;MyObject&quot;ç±»å‹ï¼š</li></ol><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_type_tag my_object_type_tag = { 0 }; // åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„type tag</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="2"><li>å½“ä½ åœ¨ C ä»£ç é‡Œåˆ›å»ºä¸€ä¸ªæ–°çš„&quot;MyObject&quot;å®ä¾‹æ—¶ï¼Œä½ ä¼šä½¿ç”¨<code>napi_type_tag_instance()</code>å‡½æ•°æ¥å°†è¿™ä¸ªæ–°å¯¹è±¡ä¸<code>my_object_type_tag</code>å…³è”èµ·æ¥ï¼š</li></ol><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value create_my_object(napi_env env) {</span></span>
<span class="line"><span>    napi_value my_object;</span></span>
<span class="line"><span>    // ... åˆ›å»ºmy_objectçš„ä»£ç  ...</span></span>
<span class="line"><span>    napi_status status = napi_type_tag_instance(env, my_object, &amp;my_object_type_tag);</span></span>
<span class="line"><span>    // æ£€æŸ¥å¹¶å¤„ç†statusæ˜¯å¦æˆåŠŸ...</span></span>
<span class="line"><span>    return my_object;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>å¦‚æœä½ æœ‰ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„è¾“å…¥å‚æ•°åº”è¯¥æ˜¯&quot;MyObject&quot;ç±»å‹çš„å¯¹è±¡ï¼Œä½ å¯ä»¥åœ¨è¿™ä¸ªå‡½æ•°ä¸­ä½¿ç”¨<code>napi_check_object_type_tag()</code>æ¥éªŒè¯ä¼ å…¥çš„å¯¹è±¡æ˜¯å¦çœŸçš„å¸¦æœ‰æ­£ç¡®çš„æ ‡ç­¾ï¼š</li></ol><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value use_my_object(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_value this_arg;</span></span>
<span class="line"><span>    void* data;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ä»infoä¸­è·å–JavaScriptä¼ å…¥çš„å‚æ•°</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, &amp;this_arg, &amp;data);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥ä¼ å…¥çš„å¯¹è±¡æ˜¯å¦æ˜¯MyObjectç±»å‹</span></span>
<span class="line"><span>    bool is_my_object;</span></span>
<span class="line"><span>    napi_status status = napi_check_object_type_tag(env, args[0], &amp;my_object_type_tag, &amp;is_my_object);</span></span>
<span class="line"><span>    // æ£€æŸ¥å¹¶å¤„ç†statusæ˜¯å¦æˆåŠŸ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (!is_my_object) {</span></span>
<span class="line"><span>        // æŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºä¼ å…¥çš„ä¸æ˜¯MyObjectç±»å‹</span></span>
<span class="line"><span>        napi_throw_error(env, NULL, &quot;Argument is not a MyObject type.&quot;);</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åœ¨è¿™é‡Œæ‰§è¡Œå…¶ä»–æ“ä½œ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return some_result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å°±å¯ä»¥ç¡®ä¿åœ¨åŸç”Ÿæ¨¡å—ä¸­çš„å‡½æ•°åªæ¥æ”¶å’Œæ“ä½œæ­£ç¡®ç±»å‹çš„å¯¹è±¡ï¼Œä»è€Œé¿å…æ½œåœ¨çš„ç±»å‹æ··æ·†å’Œè¿è¡Œæ—¶é”™è¯¯ã€‚è¿™å¯¹äºåœ¨åŸç”Ÿæ¨¡å—ä¸­ç»´æŠ¤ç±»å‹å®‰å…¨éå¸¸é‡è¦ï¼Œå°¤å…¶æ˜¯å½“æ¶‰åŠåˆ°å†…å­˜ç®¡ç†æ—¶ï¼Œé”™è¯¯çš„ç±»å‹æ“ä½œå¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒæˆ–è€…å®‰å…¨æ¼æ´ã€‚</p><h4 id="napi-async-cleanup-hook-handle" tabindex="-1"><a class="header-anchor" href="#napi-async-cleanup-hook-handle"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_async_cleanup_hook_handle" target="_blank" rel="noopener noreferrer">napi_async_cleanup_hook_handle</a></span></a></h4><p><code>napi_async_cleanup_hook_handle</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå®ƒå±äº N-APIï¼ˆNode APIï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚åœ¨ç†è§£ <code>napi_async_cleanup_hook_handle</code> ä¹‹å‰ï¼Œéœ€è¦äº†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š</p><ol><li><p><strong>N-API</strong>ï¼šè¿™æ˜¯ä¸€ä¸ª C è¯­è¨€çº§åˆ«çš„ APIï¼Œè®©å¼€å‘è€…å¯ä»¥ä¸ä¾èµ–äº V8 å¼•æ“ç›´æ¥ä¸ Node.js è¿›è¡Œäº¤äº’ã€‚å®ƒçš„å¥½å¤„æ˜¯ä½¿å¾—åŸç”Ÿæ’ä»¶ä¸å—ç‰¹å®šç‰ˆæœ¬çš„ Node.js é™åˆ¶ï¼Œå¢åŠ äº†è·¨ç‰ˆæœ¬å…¼å®¹æ€§ã€‚</p></li><li><p><strong>åŸç”Ÿæ’ä»¶</strong>ï¼šé€šå¸¸ç”¨ C æˆ– C++ç¼–å†™ï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨æ“ä½œç³»ç»Ÿåº•å±‚èƒ½åŠ›æˆ–å…¶ä»–æœ¬åœ°åº“ï¼Œä¸º Node.js æä¾›é¢å¤–åŠŸèƒ½ã€‚</p></li><li><p><strong>å¼‚æ­¥æ¸…ç†é’©å­</strong>ï¼šåœ¨ Node.js ä¸­ï¼Œå½“ä½ åˆ›å»ºå¼‚æ­¥èµ„æºæ—¶ï¼ˆä¾‹å¦‚ï¼Œå¼€å§‹ä¸€ä¸ªæ–°çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹æˆ–è€…åˆ†é…ä¸€äº›éœ€è¦åœ¨æœªæ¥æŸä¸ªæ—¶é—´ç‚¹é‡Šæ”¾çš„å†…å­˜ï¼‰ï¼Œå¯èƒ½éœ€è¦åœ¨è¿™äº›èµ„æºä¸å†éœ€è¦æ—¶è¿›è¡Œæ¸…ç†ã€‚å¼‚æ­¥æ¸…ç†é’©å­å°±æ˜¯åœ¨ Node.js ç¯å¢ƒå³å°†å…³é—­æ—¶ç¡®ä¿è¿™äº›èµ„æºè¢«æ­£ç¡®æ¸…ç†çš„æœºåˆ¶ã€‚</p></li></ol><p>ç°åœ¨ï¼Œè®²è§£ä¸€ä¸‹ <code>napi_async_cleanup_hook_handle</code>ï¼š</p><ul><li>å½“ä½ ä½¿ç”¨ N-API åˆ›å»ºåŸç”Ÿæ’ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­åˆ›å»ºäº†å¼‚æ­¥èµ„æºæ—¶ï¼Œä½ å¯èƒ½å¸Œæœ›åœ¨ Node.js é€€å‡ºå‰æ‰§è¡Œä¸€äº›æ¸…ç†å·¥ä½œã€‚</li><li><code>napi_async_cleanup_hook_handle</code> å°±æ˜¯è¿™æ ·ä¸€ä¸ªæœºåˆ¶ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒæ˜¯ä¸€ç§ç±»å‹ï¼Œä»£è¡¨äº†ä¸€ä¸ªæ¸…ç†é’©å­çš„â€œå¥æŸ„â€ï¼ˆhandleï¼‰ã€‚</li><li>ä½ å¯ä»¥é€šè¿‡è°ƒç”¨ <code>napi_add_async_cleanup_hook</code> å‡½æ•°æ¥æ³¨å†Œä¸€ä¸ªæ¸…ç†å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåœ¨é€‚å½“çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œä»¥ä¾¿è¿›è¡Œèµ„æºæ¸…ç†ã€‚</li><li>æ³¨å†Œæ¸…ç†å‡½æ•°æ—¶ï¼Œä½ ä¼šè·å¾—ä¸€ä¸ª <code>napi_async_cleanup_hook_handle</code> å®ä¾‹ï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥ç§»é™¤æ³¨å†Œçš„é’©å­ï¼ˆå¦‚æœåœ¨æŸä¸ªæ—¶é—´ç‚¹ä½ å†³å®šä¸å†éœ€è¦å®ƒï¼‰ã€‚</li></ul><p>å®é™…åº”ç”¨ç¤ºä¾‹ï¼š<br> å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œè¯¥æ’ä»¶éœ€è¦åœ¨èƒŒåè¿è¡Œä¸€ä¸ªè®¡æ—¶å™¨ã€‚å½“ Node.js è¿›ç¨‹ç»“æŸæ—¶ï¼Œä½ éœ€è¦ç¡®ä¿è¿™ä¸ªè®¡æ—¶å™¨è¢«åœæ­¢å¹¶ä¸”ç›¸å…³èµ„æºè¢«é‡Šæ”¾ã€‚ä½ å¯ä»¥è¿™æ ·åšï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void cleanup_timer(void* arg) {</span></span>
<span class="line"><span>  // å‡è®¾argæ˜¯æŒ‡å‘ä½ çš„è®¡æ—¶å™¨èµ„æºçš„æŒ‡é’ˆ</span></span>
<span class="line"><span>  // åœ¨è¿™é‡Œå†™ä¸Šåœæ­¢è®¡æ—¶å™¨å’Œé‡Šæ”¾èµ„æºçš„ä»£ç </span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>  // ... åˆå§‹åŒ–ä»£ç ï¼Œæ¯”å¦‚åˆ›å»ºè®¡æ—¶å™¨ç­‰</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ³¨å†Œæ¸…ç†é’©å­</span></span>
<span class="line"><span>  napi_async_cleanup_hook_handle handle;</span></span>
<span class="line"><span>  napi_status status = napi_add_async_cleanup_hook(env, cleanup_timer, /*arg=*/timer, &amp;handle);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª <code>cleanup_timer</code> å‡½æ•°ï¼Œå½“ Node.js è¿›ç¨‹é€€å‡ºæ—¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«è°ƒç”¨æ¥æ¸…ç†è®¡æ—¶å™¨ã€‚ç„¶åï¼Œåœ¨æ¨¡å—çš„åˆå§‹åŒ–å‡½æ•° <code>Init</code> ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>napi_add_async_cleanup_hook</code> æ¥æ³¨å†Œè¿™ä¸ªæ¸…ç†å‡½æ•°ï¼Œå¹¶ä¼ é€’è®¡æ—¶å™¨ä½œä¸ºå‚æ•°ã€‚</p><p>æ€»ç»“èµ·æ¥ï¼Œ<code>napi_async_cleanup_hook_handle</code> æ˜¯ä¸€ç§ç¡®ä¿åŸç”Ÿæ’ä»¶çš„å¼‚æ­¥èµ„æºåœ¨ Node.js ç¯å¢ƒå…³é—­å‰å¾—åˆ°åˆé€‚å¤„ç†çš„æœºåˆ¶ã€‚é€šè¿‡æ³¨å†Œæ¸…ç†é’©å­ï¼Œå¯ä»¥å¸®åŠ©å¼€å‘è€…ç®¡ç†èµ„æºçš„ç”Ÿå‘½å‘¨æœŸï¼Œé¿å…å†…å­˜æ³„æ¼ç­‰é—®é¢˜ã€‚</p><h3 id="node-api-callback-types" tabindex="-1"><a class="header-anchor" href="#node-api-callback-types"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#node-api-callback-types" target="_blank" rel="noopener noreferrer">Node-API callback types</a></span></a></h3><p>Node-APIï¼ˆä¹‹å‰ç§°ä¸º N-APIï¼‰æ˜¯ Node.js çš„ä¸€ä¸ª API å±‚ï¼Œå®ƒå…è®¸ä½ ç¼–å†™èƒ½å¤Ÿåœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸Šè¿è¡Œçš„æœ¬æœºæ’ä»¶ã€‚æœ¬æœºæ’ä»¶æ˜¯ä½¿ç”¨ C æˆ– C++ç¼–å†™çš„æ¨¡å—ï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥ä¸ Node.js çš„ V8 å¼•æ“äº¤äº’ï¼Œè¿™ä½¿å¾—å®ƒä»¬åœ¨æ‰§è¡Œé€Ÿåº¦ä¸Šéå¸¸é«˜æ•ˆã€‚ä½†æ˜¯ï¼Œè¿™äº›ä»£ç é€šå¸¸éœ€è¦é’ˆå¯¹ä¸åŒç‰ˆæœ¬çš„ Node.js è¿›è¡Œä¿®æ”¹ï¼Œå› ä¸ºå†…éƒ¨çš„ V8 API å¯èƒ½ä¼šæœ‰å˜åŒ–ã€‚Node-API æ—¨åœ¨æä¾›ä¸€ä¸ªç¨³å®šã€ç‰ˆæœ¬æ— å…³çš„ APIï¼Œä½¿å¾—æœ¬æœºæ’ä»¶å¼€å‘è€…ä¸å¿…æ‹…å¿ƒè¿™äº›é—®é¢˜ã€‚</p><p>åœ¨ Node-API ä¸­ï¼Œ&quot;å›è°ƒç±»å‹&quot;æŒ‡çš„æ˜¯å½“ä½ åˆ›å»ºä¸€ä¸ªåŸç”Ÿå‡½æ•°æ—¶ï¼Œå¯ä»¥ä¼ é€’ç»™ Node-API çš„ä¸åŒç§ç±»çš„å‡½æ•°ç­¾åã€‚è¿™äº›å›è°ƒç±»å‹å®šä¹‰äº†ä½ çš„å‡½æ•°åº”è¯¥å¦‚ä½•ä¸ JavaScript ä»£ç äº’åŠ¨ã€‚ä¸‹é¢åˆ†åˆ«è§£é‡Šä¸€ä¸‹è¿™äº›ç±»å‹ï¼Œå¹¶æä¾›ä¸€äº›å®é™…çš„ä¾‹å­ã€‚</p><ol><li><p><code>napi_callback</code>: è¿™æ˜¯æœ€åŸºæœ¬çš„å›è°ƒç±»å‹ã€‚å®ƒè¡¨ç¤ºä¸€ä¸ªæœ¬æœºå‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥è¢« JavaScript ä»£ç è°ƒç”¨ã€‚å®ƒé€šå¸¸ç”¨äºæ‰§è¡ŒæŸäº›æ“ä½œï¼Œç„¶åè¿”å›ç»“æœç»™ JavaScriptã€‚</p><p>ä¾‹å­:<br> å‡è®¾æˆ‘ä»¬æƒ³è¦åˆ›å»ºä¸€ä¸ªæœ¬æœºå‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸¤ä¸ªæ•°å€¼å‚æ•°ï¼Œè¿”å›å®ƒä»¬çš„å’Œã€‚æˆ‘ä»¬ä¼šå®šä¹‰ä¸€ä¸ª<code>napi_callback</code>å‡½æ•°ï¼Œåƒè¿™æ ·ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value Add(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    size_t argc = 2;</span></span>
<span class="line"><span>    napi_value argv[2];</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, argv, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥ä¼ å…¥å‚æ•°çš„æ•°é‡å’Œç±»å‹ç­‰...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    double value1, value2;</span></span>
<span class="line"><span>    status = napi_get_value_double(env, argv[0], &amp;value1);</span></span>
<span class="line"><span>    status = napi_get_value_double(env, argv[1], &amp;value2);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_value sum;</span></span>
<span class="line"><span>    status = napi_create_double(env, value1 + value2, &amp;sum);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return sum;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ JavaScript ä¸­ï¼Œä½ å¯ä»¥åƒè°ƒç”¨æ™®é€šå‡½æ•°é‚£æ ·è°ƒç”¨è¿™ä¸ª<code>Add</code>å‡½æ•°ã€‚</p></li><li><p><code>napi_threadsafe_function</code>: å½“ä½ éœ€è¦ä»ä»»ä½•çº¿ç¨‹å®‰å…¨åœ°è°ƒç”¨ JavaScript å‡½æ•°æ—¶ï¼Œå°±ä¼šç”¨åˆ°è¿™ä¸ªç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œåœ¨å·¥ä½œå®Œæˆåæƒ³è¦é€šçŸ¥ JavaScript ä¸»çº¿ç¨‹ï¼Œåˆ™å¯ä»¥ä½¿ç”¨è¿™ä¸ªç±»å‹ã€‚</p><p>ä¾‹å­:<br> å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ‰§è¡Œè€—æ—¶è®¡ç®—çš„å·¥ä½œçº¿ç¨‹ï¼Œæˆ‘ä»¬æƒ³åœ¨å®Œæˆåå°†ç»“æœå›ä¼ ç»™ JavaScriptã€‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª<code>napi_threadsafe_function</code>å¹¶åœ¨å·¥ä½œçº¿ç¨‹ä¸­è°ƒç”¨å®ƒã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>void CallJs(napi_env env, napi_value js_callback, void* context, void* data) {</span></span>
<span class="line"><span>    // ä»æ•°æ®ä¸­è·å–è®¡ç®—çš„ç»“æœï¼Œå¹¶é€šè¿‡å›è°ƒå‡½æ•°ä¼ é€’ç»™JavaScript</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å…¶ä»–ä»£ç ä¼šè®¾ç½®å·¥ä½œçº¿ç¨‹ï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶å€™è°ƒç”¨CallJs</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶ååœ¨ JavaScript ä¸­ï¼Œä½ å¯ä»¥æä¾›ä¸€ä¸ªå›è°ƒå‡½æ•°æ¥æ¥æ”¶å’Œå¤„ç†ç»“æœã€‚</p></li><li><p><code>napi_async_execute_callback</code> å’Œ <code>napi_async_complete_callback</code>: è¿™ä¸¤ä¸ªç±»å‹ç”¨äºå¼‚æ­¥æ“ä½œã€‚ç¬¬ä¸€ä¸ªç”¨äºåœ¨ç‹¬ç«‹çš„çº¿ç¨‹ä¸­æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼Œè€Œç¬¬äºŒä¸ªç”¨äºåœ¨ä»»åŠ¡å®Œæˆæ—¶åœ¨ä¸»äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œå›è°ƒã€‚</p><p>ä¾‹å­:<br> å¦‚æœæˆ‘ä»¬æƒ³è¯»å–ä¸€ä¸ªå¤§æ–‡ä»¶è€Œä¸é˜»å¡ä¸»äº‹ä»¶å¾ªç¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå¼‚æ­¥æ“ä½œã€‚ä½¿ç”¨è¿™ä¸¤ä¸ªå›è°ƒï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­è¯»å–æ–‡ä»¶å†…å®¹ï¼ˆ<code>napi_async_execute_callback</code>ï¼‰ï¼Œç„¶ååœ¨è¯»å–å®Œæˆæ—¶é€šçŸ¥ JavaScript ä¸»çº¿ç¨‹ï¼ˆ<code>napi_async_complete_callback</code>ï¼‰ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>void ExecuteReadFile(napi_env env, void* data) {</span></span>
<span class="line"><span>    // åœ¨æ­¤å¤„æ‰§è¡Œæ–‡ä»¶è¯»å–æ“ä½œ</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void CompleteReadFile(napi_env env, napi_status status, void* data) {</span></span>
<span class="line"><span>    // å¤„ç†å®Œæˆåçš„å›è°ƒï¼Œä¾‹å¦‚å°†è¯»å–çš„å†…å®¹ä¼ é€’ç»™JavaScript</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä½¿ç”¨napi_create_async_workåˆ›å»ºå¼‚æ­¥å·¥ä½œï¼Œç„¶åä½¿ç”¨napi_queue_async_workå°†å…¶åŠ å…¥äº‹ä»¶å¾ªç¯</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>é€šè¿‡ä½¿ç”¨è¿™äº›å›è°ƒç±»å‹ï¼Œä½ å¯ä»¥å°†å¤æ‚çš„ã€è€—æ—¶çš„æˆ–éœ€è¦è·¨çº¿ç¨‹æ“ä½œçš„ä»»åŠ¡ä» JavaScript ç§»è‡³æ›´åº•å±‚çš„ C/C++ä»£ç ä¸­å¤„ç†ï¼ŒåŒæ—¶ä¿è¯ JavaScript ä¾§çš„äº‹ä»¶å¾ªç¯ä¸ä¼šè¢«é˜»å¡ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥æå¤§åœ°æå‡æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨ CPU å¯†é›†å‹æˆ– IO å¯†é›†å‹çš„åœºæ™¯ä¸‹ã€‚</p><h4 id="napi-callback-info" tabindex="-1"><a class="header-anchor" href="#napi-callback-info"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_callback_info" target="_blank" rel="noopener noreferrer">napi_callback_info</a></span></a></h4><p>Node.js çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚åŸç”Ÿæ’ä»¶æ˜¯ç”¨ C æˆ– C++ ç¼–å†™çš„æ¨¡å—ï¼Œå¯ä»¥è¢« Node.js ç›´æ¥è°ƒç”¨ã€‚<code>napi_callback_info</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå®ƒä»£è¡¨äº†ä¸€æ¬¡ä» JavaScript åˆ°åŸç”Ÿå‡½æ•°çš„è°ƒç”¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p><p>å½“ä½ åœ¨ JavaScript ä¸­è°ƒç”¨ä¸€ä¸ªåŸç”Ÿæ¨¡å—é‡Œçš„å‡½æ•°æ—¶ï¼Œè¿™ä¸ªå‡½æ•°å®é™…ä¸Šæ˜¯ç”¨ C æˆ– C++ å®ç°çš„ã€‚JavaScript ä»£ç å’ŒåŸç”Ÿä»£ç ä¹‹é—´éœ€è¦ä¸€ä¸ªâ€œæ¡¥æ¢â€æ¥ä¼ é€’ä¿¡æ¯ã€‚è¿™ä¸ªâ€œæ¡¥æ¢â€å°±æ˜¯ç”± <code>napi_callback_info</code> æä¾›çš„ã€‚</p><h3 id="ç¤ºä¾‹ç†è§£-napi-callback-info" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹ç†è§£-napi-callback-info"><span>ç¤ºä¾‹ç†è§£ <code>napi_callback_info</code></span></a></h3><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„ Node.js åŸç”Ÿæ¨¡å—ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªå‡½æ•° <code>sayHello</code>ï¼Œå½“ä½ ä» JavaScript è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œå®ƒå°†è¿”å› &quot;Hello, World!&quot; å­—ç¬¦ä¸²ã€‚</p><p>JavaScript è°ƒç”¨ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeModule</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my-native-module</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sayHello</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: Hello, World!</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨åŸç”Ÿæ¨¡å—ä¸­ï¼Œä½¿ç”¨ C è¯­è¨€å®ç° <code>sayHello</code> å‡½æ•°å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value SayHello(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value greeting;</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸² &#39;Hello, World!&#39; è¿”å›ç»™ JavaScript</span></span>
<span class="line"><span>    status = napi_create_string_utf8(env, &quot;Hello, World!&quot;, NAPI_AUTO_LENGTH, &amp;greeting);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return greeting;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œæ³¨å†Œ `sayHello`</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value sayHelloFn;</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    status = napi_create_function(env, NULL, 0, SayHello, NULL, &amp;sayHelloFn);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    status = napi_set_named_property(env, exports, &quot;sayHello&quot;, sayHelloFn);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>SayHello</code> å‡½æ•°æ˜¯æˆ‘ä»¬è¦ç»™ JavaScript è°ƒç”¨çš„åŸç”Ÿå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š<code>env</code> å’Œ <code>info</code>ã€‚</p><ul><li><code>env</code> æ˜¯ä¸€ä¸ªè¡¨ç¤ºå½“å‰æ‰§è¡Œç¯å¢ƒçš„å˜é‡ã€‚</li><li><code>info</code> å°±æ˜¯æˆ‘ä»¬è®¨è®ºçš„ <code>napi_callback_info</code>ã€‚å®ƒåŒ…å«äº†è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶æ‰€æœ‰é‡è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ¯”å¦‚è°ƒç”¨çš„å‚æ•°ã€<code>this</code> çš„å€¼ç­‰ç­‰ã€‚</li></ul><p>åœ¨ <code>SayHello</code> å‡½æ•°å†…éƒ¨ï¼Œæˆ‘ä»¬ä¸ç›´æ¥å¤„ç† JavaScript ä¼ å…¥çš„å‚æ•°ï¼Œè€Œæ˜¯é€šè¿‡ <code>napi_callback_info</code> æ¥è·å–è¿™äº›ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³çŸ¥é“è°ƒç”¨æ—¶ä¼ é€’äº†å¤šå°‘ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>napi_get_cb_info</code> å‡½æ•°ï¼ˆè¿™æ˜¯ N-API æä¾›çš„å‡½æ•°ä¹‹ä¸€ï¼‰æ¥ä» <code>info</code> ä¸­è·å–è¿™äº›ä¿¡æ¯ã€‚</p><p>å®é™…åº”ç”¨ä¸­ï¼Œ<code>napi_callback_info</code> æ›´å¤šåœ°è¢«ç”¨äºè·å–å‚æ•°ã€å¤„ç†ä¸åŒæ•°é‡çš„å‚æ•°ã€è·å– <code>this</code> å¯¹è±¡å¼•ç”¨ç­‰é«˜çº§æ“ä½œã€‚ä½†åŸºæœ¬æ€è·¯æ˜¯å°† JavaScript ä¸­çš„è°ƒç”¨ä¿¡æ¯æ˜ å°„åˆ° C/C++ çš„ä¸–ç•Œä¸­ï¼Œç„¶ååœ¨åŸç”Ÿä»£ç å±‚é¢å¤„ç†è¿™äº›ä¿¡æ¯ã€‚</p><p>æ€»ç»“èµ·æ¥ï¼Œ<code>napi_callback_info</code> æ˜¯åŸç”Ÿæ¨¡å—ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªç»„ä»¶ï¼Œå› ä¸ºå®ƒä½¿å¾— JavaScript å’Œ C/C++ ä¹‹é—´çš„äº¤äº’æˆä¸ºå¯èƒ½ï¼Œå¹¶ä¸”ç®¡ç†ç€è¿™ç§äº¤äº’è¿‡ç¨‹ä¸­æ‰€æœ‰å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p><h4 id="napi-callback" tabindex="-1"><a class="header-anchor" href="#napi-callback"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_callback" target="_blank" rel="noopener noreferrer">napi_callback</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªä¸ºäº†æ„å»ºåŸç”Ÿæ’ä»¶ï¼ˆä¹Ÿå°±æ˜¯ç”¨ç±»ä¼¼ C æˆ– C++è¿™æ ·çš„ä½çº§è¯­è¨€ç¼–å†™çš„æ¨¡å—ï¼‰è€Œè®¾è®¡çš„ç¨³å®šçš„ API å±‚ã€‚å®ƒçš„ç›®çš„æ˜¯è®©ä½ èƒ½å¤Ÿä¸å— Node.js ç‰ˆæœ¬æ›´è¿­çš„å½±å“ï¼Œç¼–å†™èƒ½å¤Ÿåœ¨å¤šä¸ªç‰ˆæœ¬ä¸Šè¿è¡Œçš„æ’ä»¶ã€‚</p><p><code>napi_callback</code> æ˜¯è¿™ä¸ª N-API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆç±»å‹ï¼Œä½ åœ¨åˆ›å»ºåŸç”Ÿæ’ä»¶æ—¶ä¼šä½¿ç”¨è¿™ç§ç±»å‹çš„å˜é‡æ¥å¼•ç”¨ä½ çš„ C æˆ– C++ ä»£ç ä¸­çš„å‡½æ•°ã€‚å½“ JavaScript ä»£ç è°ƒç”¨è¿™äº›åŸç”Ÿå‡½æ•°æ—¶ï¼Œåº•å±‚çš„ Node.js å¼•æ“ä¼šé€šè¿‡è¿™ä¸ª <code>napi_callback</code> æŒ‡å‘çš„å‡½æ•°æ¥æ‰§è¡Œç›¸åº”çš„ C/C++ ä»£ç ã€‚</p><p>é€šä¿—åœ°è¯´ï¼Œ<code>napi_callback</code> å°±åƒæ˜¯ä¸€ä¸ªæ¡¥æ¢ï¼Œè¿æ¥äº† JavaScript çš„ä¸–ç•Œå’Œ C/C++ çš„ä¸–ç•Œã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªç”µè¯å·ç ï¼ŒJavaScript ä»£ç é€šè¿‡è¿™ä¸ªå·ç â€œæ‰“ç”µè¯â€ç»™ C/C++ å‡½æ•°ï¼Œç„¶åé‚£è¾¹çš„ä»£ç æ¥å¬å¹¶å¤„ç†è¯·æ±‚ï¼Œæœ€ç»ˆå°†ç»“æœè¿”å›ç»™ JavaScriptã€‚</p><h3 id="å®é™…è¿ç”¨ä¾‹å­-2" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-2"><span>å®é™…è¿ç”¨ä¾‹å­ï¼š</span></a></h3><p>å‡è®¾ä½ æƒ³è¦åœ¨ Node.js ä¸­ä½¿ç”¨æŸä¸ª C åº“ä¸­çš„åŠŸèƒ½ï¼Œä¾‹å¦‚å¤„ç†å›¾åƒçš„åº“ã€‚è¿™ä¸ªåº“æä¾›äº†ä¸€ä¸ªå‡½æ•°å«åš <code>process_image</code>ï¼Œä½ æƒ³é€šè¿‡ Node.js è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</p><p>é¦–å…ˆï¼Œä½ éœ€è¦åœ¨ C ä»£ç ä¸­å®šä¹‰ä¸€ä¸ªç¬¦åˆ <code>napi_callback</code> ç±»å‹ç­¾åçš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å«å®ƒ <code>ProcessImageWrapper</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™æ˜¯é‚£ä¸ªå›¾åƒå¤„ç†åº“æä¾›çš„å‡½æ•°</span></span>
<span class="line"><span>void process_image(const char* image_path);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯ä½ å®šä¹‰çš„ napi_callback å¯¹åº”çš„å‡½æ•°</span></span>
<span class="line"><span>napi_value ProcessImageWrapper(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // ä» JavaScript è·å–å‚æ•°ï¼Œè°ƒç”¨ process_image å‡½æ•°ç­‰é€»è¾‘</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›å¤„ç†ç»“æœç»™ JavaScript</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹‹åï¼Œä½ éœ€è¦æ³¨å†Œè¿™ä¸ªå‡½æ•°åˆ° Node.js ç¯å¢ƒä¸­ï¼Œè®© JavaScript èƒ½å¤Ÿæ‰¾åˆ°å¹¶è°ƒç”¨å®ƒï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°å¯¹è±¡ProcessImageWrapperï¼Œæš´éœ²ç»™JavaScript</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, ProcessImageWrapper, NULL, &amp;fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è®¾ç½®å‡½æ•°åç§°ä¸º &#39;processImage&#39;ï¼Œå¹¶æŠŠå®ƒä½œä¸ºå¯¼å‡ºçš„æ¨¡å—çš„å±æ€§</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;processImage&quot;, fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ï¼Œåœ¨ JavaScript ä»£ç ä¸­ï¼Œä½ å¯ä»¥è¿™æ ·è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> addon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾è¿™é‡Œ &#39;./image.png&#39; æ˜¯ä½ æƒ³è¦å¤„ç†çš„å›¾ç‰‡è·¯å¾„</span></span>
<span class="line"><span style="color:#D8DEE9;">addon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">processImage</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./image.png</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> result</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">error</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Image processing failed:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Image processed successfully:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> result</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒJavaScript ä»£ç é€šè¿‡ <code>napi_callback</code> æŒ‡å®šçš„ <code>ProcessImageWrapper</code> å‡½æ•°è°ƒç”¨äº† C ä»£ç ï¼Œä»è€Œå®ç°äº†ä¸åŸç”Ÿå›¾åƒå¤„ç†åº“çš„äº¤äº’ã€‚è¿™åªæ˜¯ä¸€ä¸ªç®€åŒ–ç¤ºä¾‹ï¼Œå®é™…çš„é”™è¯¯å¤„ç†å’Œæ•°æ®è½¬æ¢ä¼šæ›´å¤æ‚ï¼Œä½†å®ƒå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>napi_callback</code> åœ¨ Node.js ä¸­åˆ›å»ºå’Œä½¿ç”¨åŸç”Ÿæ‰©å±•çš„åŸºæœ¬æ¦‚å¿µã€‚</p><h4 id="node-api-nogc-finalize" tabindex="-1"><a class="header-anchor" href="#node-api-nogc-finalize"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#node_api_nogc_finalize" target="_blank" rel="noopener noreferrer">node_api_nogc_finalize</a></span></a></h4><p><code>node_api_nogc_finalize</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ª N-API å‡½æ•°ï¼Œå®ƒå…è®¸ä½ è®¾ç½®ä¸€ä¸ªå¯¹è±¡åœ¨è¢«åƒåœ¾å›æ”¶ï¼ˆGCï¼‰ä¹‹å‰ä¸ä¼šè°ƒç”¨å…¶ç»ˆç»“å™¨ï¼ˆfinalizerï¼‰ã€‚è¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨äºæ€§èƒ½ä¼˜åŒ–ã€‚</p><p>åœ¨ Node.js ä¸­ï¼ŒN-API æä¾›äº†ä¸€å¥—ç”¨äºæ„å»ºåŸç”Ÿæ‰©å±•çš„ C APIã€‚å½“ä½¿ç”¨ N-API åˆ›å»ºåŸç”Ÿèµ„æºæ—¶ï¼ˆä¾‹å¦‚åœ¨ C/C++ æ¨¡å—ä¸­åˆ†é…å†…å­˜ï¼‰ï¼Œé€šå¸¸éœ€è¦æŒ‡å®šå½“ JavaScript å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶åº”è¯¥å¦‚ä½•æ¸…ç†è¿™äº›èµ„æºã€‚è¿™æ˜¯é€šè¿‡ä¸ºè¯¥å¯¹è±¡è®¾ç½®ä¸€ä¸ªç»ˆç»“å™¨æ¥å®ç°çš„ã€‚</p><p>ç„¶è€Œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å®Œå…¨çŸ¥é“è¯¥èµ„æºå°†åœ¨æŸä¸ªç‰¹å®šæ—¶é—´ç‚¹ä¹‹å‰ä¸éœ€è¦è¢«æ¸…ç†ï¼Œæˆ–è€…å¸Œæœ›æ‰‹åŠ¨ç®¡ç†èµ„æºçš„ç”Ÿå‘½å‘¨æœŸï¼Œä»¥é¿å…ä¸åƒåœ¾å›æ”¶å™¨çš„æ½œåœ¨æ€§èƒ½å¼€é”€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ <code>node_api_nogc_finalize</code> å‡½æ•°æ¥å‘Šè¯‰ N-API ä¸è¦åœ¨åƒåœ¾å›æ”¶æ—¶è°ƒç”¨å¯¹è±¡çš„ç»ˆç»“å™¨ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ <code>node_api_nogc_finalize</code> çš„ç®€å•ä¾‹å­ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™æ˜¯æˆ‘ä»¬çš„ä¸€äº›åŸç”Ÿèµ„æº</span></span>
<span class="line"><span>typedef struct {</span></span>
<span class="line"><span>  int some_resource;</span></span>
<span class="line"><span>} MyResource;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯æ­£å¸¸çš„æ¸…ç†å‡½æ•°ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œé€šå¸¸ä¼šåœ¨å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶è°ƒç”¨</span></span>
<span class="line"><span>void Finalize(napi_env env, void* finalize_data, void* finalize_hint) {</span></span>
<span class="line"><span>  MyResource* my_resource = (MyResource*)finalize_data;</span></span>
<span class="line"><span>  // åœ¨è¿™é‡Œé‡Šæ”¾èµ„æº</span></span>
<span class="line"><span>  free(my_resource);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°å¯ä»¥åœ¨é€‚å½“çš„æ—¶å€™æ‰‹åŠ¨è°ƒç”¨ä»¥æ¸…ç†èµ„æº</span></span>
<span class="line"><span>void ManualCleanup(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>  // è·å–ä¹‹å‰å…³è”åˆ° JavaScript å¯¹è±¡çš„åŸç”Ÿèµ„æº</span></span>
<span class="line"><span>  MyResource* my_resource;</span></span>
<span class="line"><span>  napi_get_instance_data(env, &amp;my_resource);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ¸…ç†èµ„æº</span></span>
<span class="line"><span>  free(my_resource);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è®¾ç½® instance data ä¸º NULLï¼Œé¿å…é‡å¤æ¸…ç†</span></span>
<span class="line"><span>  napi_set_instance_data(env, NULL, NULL, NULL);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œåˆ›å»ºå’Œè®¾ç½®å®ä¾‹æ•°æ®</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>  MyResource* my_resource = malloc(sizeof(MyResource));</span></span>
<span class="line"><span>  my_resource-&gt;some_resource = 42; // ä¾‹å­ä¸­çš„å‡èµ„æº</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å°†èµ„æºä¸ JavaScript å¯¹è±¡å…³è”ï¼Œå¹¶å‘Šè¯‰ N-API ä¸è¦åœ¨åƒåœ¾å›æ”¶æ—¶è°ƒç”¨ç»ˆç»“å™¨</span></span>
<span class="line"><span>  napi_set_instance_data(env, my_resource, NULL /* ä½¿ç”¨NULLä»£æ›¿Finalize */, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ... è¿™é‡Œå¯èƒ½ä¼šæœ‰æ›´å¤šä»£ç  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>Init</code> å‡½æ•°ç”¨äºåˆå§‹åŒ–ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œå¹¶ä¸”ä½¿ç”¨ <code>napi_set_instance_data</code> æ¥å…³è”ä¸€ä¸ªåŸç”Ÿèµ„æºï¼Œä½†æ˜¯æˆ‘ä»¬ä¼ é€’äº† <code>NULL</code> è€Œä¸æ˜¯ <code>Finalize</code> å‡½æ•°ã€‚è¿™æ ·ï¼Œå½“åƒåœ¾å›æ”¶å™¨å°è¯•æ¸…ç†ç›¸å…³çš„ JavaScript å¯¹è±¡æ—¶ï¼Œå®ƒä¸ä¼šå°è¯•è°ƒç”¨ç»ˆç»“å™¨å‡½æ•°æ¥æ¸…ç† <code>MyResource</code>ã€‚å› æ­¤ï¼Œå¿…é¡»ç¡®ä¿åœ¨åˆé€‚çš„æ—¶å€™æ‰‹åŠ¨è°ƒç”¨ <code>ManualCleanup</code> å‡½æ•°æ¥æ¸…ç†èµ„æºï¼Œå¦åˆ™å°±ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼ã€‚</p><p>è¯·æ³¨æ„ï¼Œä»¥ä¸Šä»£ç ä»…ä¸ºè¯´æ˜ä½¿ç”¨ <code>node_api_nogc_finalize</code> çš„åœºæ™¯ï¼Œå¹¶éä¸€ä¸ªå¯ç›´æ¥è¿è¡Œçš„ä¾‹å­ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨æ—¶ï¼Œä½ éœ€è¦æ ¹æ®ä½ çš„å…·ä½“éœ€æ±‚å’Œèµ„æºç±»å‹è¿›è¡Œé€‚å½“çš„ä¿®æ”¹ã€‚</p><h4 id="napi-finalize" tabindex="-1"><a class="header-anchor" href="#napi-finalize"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_finalize" target="_blank" rel="noopener noreferrer">napi_finalize</a></span></a></h4><p><code>napi_finalize</code> æ˜¯ Node.js ä¸­ N-APIï¼ˆåŸç”Ÿ APIï¼‰çš„ä¸€éƒ¨åˆ†ã€‚N-API æ˜¯ Node.js æä¾›ç»™ C å’Œ C++ æ’ä»¶å¼€å‘è€…çš„ä¸€ä¸ªç¨³å®šçš„ API é›†åˆï¼Œå®ƒå…è®¸å¼€å‘è€…ç¼–å†™å¯ä»¥ä¸ä¸åŒç‰ˆæœ¬çš„ Node.js å…¼å®¹çš„æœ¬åœ°æ’ä»¶ã€‚</p><p>åœ¨è¯¦ç»†è§£é‡Š <code>napi_finalize</code> ä¹‹å‰ï¼Œéœ€è¦çŸ¥é“å‡ ä¸ªèƒŒæ™¯ä¿¡æ¯ï¼š</p><ol><li><p><strong>åƒåœ¾å›æ”¶(Garbage Collectionï¼ŒGC)</strong>ï¼šJavaScript åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¼šåˆ›å»ºå’Œä½¿ç”¨å¾ˆå¤šå¯¹è±¡ã€‚å½“è¿™äº›å¯¹è±¡ä¸å†è¢«éœ€è¦æ—¶ï¼ŒJavaScript çš„åƒåœ¾å›æ”¶å™¨ä¼šè‡ªåŠ¨é‡Šæ”¾è¿™äº›å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ åœ¨æœ¬åœ°æ’ä»¶ä¸­åˆ›å»ºäº†ä¸€äº›é JavaScript èµ„æºï¼ˆæ¯”å¦‚åœ¨ C/C++ ä¸­åˆ†é…çš„å†…å­˜ã€æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æˆ–è€…å…¶ä»–ç³»ç»Ÿèµ„æºï¼‰ï¼ŒJavaScript çš„åƒåœ¾å›æ”¶å™¨å¹¶ä¸çŸ¥é“å¦‚ä½•å¤„ç†è¿™äº›èµ„æºã€‚</p></li><li><p><strong>å¼•ç”¨è®¡æ•°(Reference Counting)</strong>ï¼šè¿™æ˜¯ä¸€ç§ç¡®ä¿èµ„æºæ­£ç¡®ç®¡ç†çš„æŠ€æœ¯ã€‚æ¯å½“ä½ åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶æŠŠå®ƒèµ‹å€¼ç»™æŸä¸ªå˜é‡ï¼Œè¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å°±ä¼šå¢åŠ ã€‚ç›¸åï¼Œå½“è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨å‡å°‘åˆ°é›¶æ—¶ï¼Œæ„å‘³ç€æ²¡æœ‰ä»»ä½•å˜é‡æ˜¯æŒ‡å‘è¿™ä¸ªå¯¹è±¡çš„ï¼Œè¿™æ—¶å€™èµ„æºå°±å¯ä»¥è¢«æ¸…ç†äº†ã€‚</p></li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£ <code>napi_finalize</code>ï¼š</p><p><code>napi_finalize</code> æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œä½ ä½œä¸ºæ’ä»¶å¼€å‘è€…åœ¨åˆ›å»ºä¸€ä¸ªèƒ½å¤Ÿé€šè¿‡ JavaScript è®¿é—®çš„æœ¬åœ°èµ„æºæ—¶æä¾›ç»™ N-API çš„ã€‚è¿™ä¸ªå›è°ƒå‡½æ•°çš„ç›®çš„æ˜¯åœ¨ç›¸å…³ JavaScript å¯¹è±¡è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶æ—¶ï¼Œä½ å¯ä»¥æœ‰æœºä¼šå»æ¸…ç†é‚£äº›ç”±æœ¬åœ°ä»£ç åˆ›å»ºçš„é JavaScript èµ„æºã€‚</p><p>å½“ä½ é€šè¿‡ N-API å‡½æ•° <code>napi_wrap</code> å°†ä¸€ä¸ªæœ¬åœ°èµ„æºä¸ä¸€ä¸ªæ–°çš„æˆ–ç°æœ‰çš„ JavaScript å¯¹è±¡å…³è”æ—¶ï¼Œä½ å¯ä»¥æŒ‡å®šä¸€ä¸ª <code>napi_finalize</code> å›è°ƒå‡½æ•°ã€‚è¿™æ ·ï¼Œå½“è¿™ä¸ª JavaScript å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶ï¼Œ<code>napi_finalize</code> æ‰€æŒ‡å®šçš„å‡½æ•°å°±ä¼šè¢«è°ƒç”¨ï¼Œè¿™æ—¶ä½ å¯ä»¥åœ¨è¿™ä¸ªå‡½æ•°å†…éƒ¨æ‰§è¡Œå¿…è¦çš„æ¸…ç†å·¥ä½œã€‚</p><p>ä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js æœ¬åœ°æ’ä»¶æ¥è¯»å–æ“ä½œç³»ç»Ÿçš„ç³»ç»Ÿä¿¡æ¯ã€‚ä½ å¯èƒ½ä¼šåœ¨ C++ ä¸­åˆ›å»ºä¸€ä¸ªç±» <code>SystemInfo</code> æ¥å¤„ç†ä¸ç³»ç»Ÿäº¤äº’çš„å…·ä½“ç»†èŠ‚ï¼Œå¹¶ä¸”æƒ³è¦åœ¨ JavaScript ä¸­ä¹Ÿèƒ½å¤Ÿä½¿ç”¨è¿™ä¸ªç±»ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ ä¼šï¼š</p><ol><li>ä½¿ç”¨ <code>napi_create_object</code> åˆ›å»ºä¸€ä¸ªæ–°çš„ JS å¯¹è±¡ã€‚</li><li>ä½¿ç”¨ <code>napi_wrap</code> å°†è¿™ä¸ª JS å¯¹è±¡ä¸ä¸€ä¸ª <code>SystemInfo</code> ç±»çš„å®ä¾‹å…³è”èµ·æ¥ã€‚</li><li>å½“ JS å¯¹è±¡å³å°†è¢«åƒåœ¾å›æ”¶æ—¶ï¼Œä½ éœ€è¦æ¸…ç† <code>SystemInfo</code> å®ä¾‹æ‰€å ç”¨çš„èµ„æºï¼Œæ¯”å¦‚å…³é—­æ–‡ä»¶å¥æŸ„ç­‰ã€‚è¿™å°±æ˜¯ä½ éœ€è¦æä¾›ä¸€ä¸ª <code>napi_finalize</code> å›è°ƒå‡½æ•°çš„åœ°æ–¹ã€‚</li></ol><p>ç¤ºä¾‹ä»£ç ç‰‡æ®µï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™æ˜¯ä½ çš„ç³»ç»Ÿä¿¡æ¯ç±»</span></span>
<span class="line"><span>class SystemInfo {</span></span>
<span class="line"><span>public:</span></span>
<span class="line"><span>    SystemInfo() {</span></span>
<span class="line"><span>        // åˆå§‹åŒ–ä»£ç </span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ~SystemInfo() {</span></span>
<span class="line"><span>        // æ¸…ç†ä»£ç ï¼Œä¾‹å¦‚å…³é—­æ–‡ä»¶å¥æŸ„ç­‰</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å…¶ä»–æ–¹æ³•...</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯ napi_finalize å›è°ƒå‡½æ•°</span></span>
<span class="line"><span>void FinalizeSystemInfo(napi_env env, void* finalize_data, void* finalize_hint) {</span></span>
<span class="line"><span>    // åœ¨è¿™é‡Œé‡Šæ”¾ SystemInfo å®ä¾‹</span></span>
<span class="line"><span>    SystemInfo* sys_info = reinterpret_cast`&lt;`SystemInfo*&gt;(finalize_data);</span></span>
<span class="line"><span>    delete sys_info;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯ N-API æš´éœ²ç»™ JS çš„æ–¹æ³•ï¼Œç”¨äºåˆ›å»º SystemInfo å¯¹è±¡</span></span>
<span class="line"><span>napi_value CreateSystemInfoWrapper(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_value sys_info_obj;</span></span>
<span class="line"><span>    status = napi_create_object(env, &amp;sys_info_obj);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    SystemInfo* sys_info = new SystemInfo(); // åˆ›å»º SystemInfo å®ä¾‹</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æŠŠ SystemInfo å®ä¾‹å’Œ JS å¯¹è±¡å…³è”èµ·æ¥ï¼Œå¹¶æŒ‡å®š FinalizeSystemInfo ä½œä¸ºæ¸…ç†å›è°ƒ</span></span>
<span class="line"><span>    status = napi_wrap(env, sys_info_obj, sys_info, FinalizeSystemInfo, nullptr, nullptr);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return sys_info_obj; // è¿”å›æ–°åˆ›å»ºçš„ JS å¯¹è±¡</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª <code>FinalizeSystemInfo</code> å‡½æ•°ä½œä¸º <code>napi_finalize</code> å›è°ƒï¼Œå½“ç›¸å…³è”çš„ JavaScript å¯¹è±¡å³å°†è¢« GC æ¸…ç†æ—¶ï¼Œè¯¥å‡½æ•°ä¼šè¢«è°ƒç”¨ä»¥é‡Šæ”¾ <code>SystemInfo</code> å®ä¾‹ã€‚è¿™æ ·æˆ‘ä»¬å°±ç¡®ä¿äº†ï¼Œæ— è®ºä½•æ—¶ JavaScript å¯¹è±¡è¢«å›æ”¶ï¼Œå…¶å¯¹åº”çš„æœ¬åœ°èµ„æºéƒ½èƒ½å¤Ÿå¾—åˆ°é€‚å½“çš„å¤„ç†ï¼Œé¿å…äº†å†…å­˜æ³„éœ²ã€‚</p><h4 id="napi-async-execute-callback" tabindex="-1"><a class="header-anchor" href="#napi-async-execute-callback"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_async_execute_callback" target="_blank" rel="noopener noreferrer">napi_async_execute_callback</a></span></a></h4><p>Node.js çš„ N-APIï¼ˆåŸç”Ÿ APIï¼‰æ˜¯ä¸€ä¸ªè®©ä½ èƒ½å¤Ÿç”¨ C æˆ–è€… C++ ç¼–å†™æ‰©å¼ æ¨¡å—çš„ç•Œé¢ã€‚å½“ä½ æƒ³è¦æé«˜æ€§èƒ½ï¼Œæˆ–è€…ä½¿ç”¨ä¸€äº› Node.js ä¸­æ²¡æœ‰ç›´æ¥æä¾›çš„æœ¬åœ°åº“æ—¶ï¼Œä½ å¯èƒ½ä¼šç”¨åˆ°å®ƒã€‚</p><p><code>napi_async_execute_callback</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå…è®¸ä½ åœ¨åˆ›å»ºå¼‚æ­¥ä»»åŠ¡æ—¶å®šä¹‰è¦æ‰§è¡Œçš„é€»è¾‘ã€‚å½“ä½ è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼ŒNode.js ä¼šåœ¨åå°çº¿ç¨‹ä¸Šæ‰§è¡Œå®šä¹‰çš„å›è°ƒå‡½æ•°ï¼Œè€Œä¸ä¼šé˜»å¡ä¸»äº‹ä»¶å¾ªç¯ã€‚è¿™å¯¹äºä¸å¸Œæœ›å½±å“åˆ°ä¸»çº¿ç¨‹æ€§èƒ½çš„å¯†é›†å‹è®¡ç®—ä»»åŠ¡éå¸¸æœ‰ç”¨ã€‚</p><p>ä¸ºäº†ç†è§£ <code>napi_async_execute_callback</code>ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ˜ç™½å‡ ä¸ªæ¦‚å¿µï¼š</p><ul><li><strong>å¼‚æ­¥ç¼–ç¨‹</strong>ï¼šåœ¨ Node.js ä¸­ï¼Œå¼‚æ­¥ç¼–ç¨‹æŒ‡çš„æ˜¯ç¨‹åºåœ¨ç­‰å¾…æŸä¸ªæ“ä½œå®Œæˆæ—¶å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–ä»£ç ï¼Œæ¯”å¦‚è¯»å–æ–‡ä»¶ã€æ•°æ®åº“æ“ä½œæˆ–è€…ç½‘ç»œè¯·æ±‚ã€‚</li><li><strong>äº‹ä»¶å¾ªç¯</strong>ï¼šNode.js ä½¿ç”¨äº‹ä»¶å¾ªç¯æ¥å¤„ç†å¼‚æ­¥æ“ä½œã€‚å½“æ‰€æœ‰åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•åï¼Œå®ƒä¼šæ£€æŸ¥æ˜¯å¦æœ‰å¼‚æ­¥ä»»åŠ¡å®Œæˆå¹¶å‡†å¤‡å¥½å›è°ƒå‡½æ•°æ‰§è¡Œã€‚</li><li><strong>å¤šçº¿ç¨‹</strong>ï¼šè™½ç„¶ JavaScript åœ¨ Node.js ä¸­é»˜è®¤æ˜¯å•çº¿ç¨‹è¿è¡Œçš„ï¼Œä½† Node.js å¯ä»¥åˆ©ç”¨ C++ æ‰©å±•æˆ–è€…å·¥ä½œçº¿ç¨‹ï¼ˆworker threadsï¼‰åœ¨åå°æ‰§è¡Œå¤šçº¿ç¨‹ä»»åŠ¡ã€‚</li></ul><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­æ¥æè¿° <code>napi_async_execute_callback</code> æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š</p><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªè€—æ—¶çš„å›¾åƒå¤„ç†ä»»åŠ¡ï¼Œåœ¨ Node.js ä¸­ä½ æƒ³é€šè¿‡ä¸€ä¸ªæ‰©å±•æ¨¡å—æ¥å®ç°ï¼Œä»¥é¿å…é˜»å¡ä¸»äº‹ä»¶å¾ªç¯ã€‚é¦–å…ˆï¼Œä½ ä¼šç”¨ C++ æ¥å†™è¿™ä¸ªå›¾åƒå¤„ç†é€»è¾‘ï¼Œç„¶åéœ€è¦å‘ Node.js æ³¨å†Œè¿™ä¸ªä»»åŠ¡ï¼Œå‘Šè¯‰å®ƒè¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ã€‚</p><ol><li>ä½ ä¼šåˆ›å»ºä¸€ä¸ª <code>napi_async_work</code> å¯¹è±¡ï¼Œå®ƒä»£è¡¨äº†ä¸€ä¸ªå°†è¦è¢«å¼‚æ­¥æ‰§è¡Œçš„ä»»åŠ¡ã€‚</li><li>ä½ ä¼šå®šä¹‰ä¸€ä¸ª <code>Execute</code> å›è°ƒï¼Œè¿™ä¸ªå›è°ƒåŒ…å«äº†çœŸæ­£çš„å¤„ç†é€»è¾‘ï¼Œå³å›¾åƒå¤„ç†ç®—æ³•ã€‚</li><li>ä½ å°†è¿™ä¸ª <code>Execute</code> å›è°ƒä¸ <code>napi_async_work</code> å¯¹è±¡å…³è”ï¼Œå¹¶é€šè¿‡è°ƒç”¨ <code>napi_async_execute_callback</code> æ¥åœ¨ä¸€ä¸ªåå°çº¿ç¨‹ä¸Šæ‰§è¡Œå®ƒã€‚</li></ol><p>è¿™ä¸ªè¿‡ç¨‹å…è®¸ Node.js åœ¨å¤„ç†è¯¥ä»»åŠ¡çš„åŒæ—¶ï¼Œç»§ç»­å¤„ç†å…¶ä»–äº‹ä»¶å¾ªç¯ä¸­çš„äº‹é¡¹ï¼Œå¦‚å¤„ç† HTTP è¯·æ±‚æˆ–è€…ç”¨æˆ·çš„è¾“å…¥ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªæŠ½è±¡çš„ä¼ªä»£ç ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>napi_async_execute_callback</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°æ˜¯è€—æ—¶ä»»åŠ¡çš„å®é™…é€»è¾‘</span></span>
<span class="line"><span>void Execute(napi_env env, void* data) {</span></span>
<span class="line"><span>    // æ‰§è¡Œä¸€äº›è€—æ—¶çš„æ“ä½œï¼Œä¾‹å¦‚å›¾åƒå¤„ç†</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°ä¼šåœ¨è€—æ—¶ä»»åŠ¡å®Œæˆåè¢«è°ƒç”¨ï¼Œé€šå¸¸ç”¨æ¥è¿”å›ç»“æœç»™JavaScript</span></span>
<span class="line"><span>void Complete(napi_env env, napi_status status, void* data) {</span></span>
<span class="line"><span>    // å¤„ç†å®Œæˆåï¼Œè¿”å›ç»“æœç»™ JavaScript ç¯å¢ƒ</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥å¯åŠ¨æ•´ä¸ªå¼‚æ­¥ä»»åŠ¡çš„</span></span>
<span class="line"><span>napi_value StartAsyncWork(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value work_name;</span></span>
<span class="line"><span>    napi_create_string_utf8(env, &quot;WorkName&quot;, NAPI_AUTO_LENGTH, &amp;work_name);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»º async work</span></span>
<span class="line"><span>    napi_async_work work;</span></span>
<span class="line"><span>    napi_create_async_work(env, NULL, work_name, Execute, Complete, NULL, &amp;work);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†è¿™ä¸ª work æ’å…¥é˜Ÿåˆ—ï¼Œä½¿å…¶å¼€å§‹åœ¨åå°çº¿ç¨‹ä¸Šæ‰§è¡Œ</span></span>
<span class="line"><span>    napi_queue_async_work(env, work);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return NULL;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šä»£ç æ˜¯éå¸¸ç®€åŒ–çš„ç¤ºä¾‹ï¼Œä»…ç”¨äºè¯´æ˜ <code>napi_async_execute_callback</code> çš„åŸºæœ¬æ¦‚å¿µã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ è¿˜éœ€è¦ç®¡ç†å†…å­˜ï¼Œå¤„ç†é”™è¯¯ï¼Œå¹¶ç¡®ä¿è·¨è¯­è¨€è¾¹ç•Œï¼ˆC++ åˆ° JavaScriptï¼‰æ—¶æ•°æ®æ­£ç¡®ä¼ é€’ã€‚</p><h4 id="napi-async-complete-callback" tabindex="-1"><a class="header-anchor" href="#napi-async-complete-callback"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_async_complete_callback" target="_blank" rel="noopener noreferrer">napi_async_complete_callback</a></span></a></h4><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œæ—¶ç¯å¢ƒï¼Œè®©ä½ å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯æ‰§è¡Œ JavaScript ä»£ç ã€‚N-API æ˜¯ Node.js æä¾›çš„ä¸€å¥— C APIï¼Œä½¿å¾—åŸç”Ÿæ’ä»¶ï¼ˆnative addonsï¼‰èƒ½å¤Ÿä¸å— Node.js ç‰ˆæœ¬å½±å“åœ°ç¼–è¯‘å’Œè¿è¡Œã€‚</p><p>åœ¨ Node.js çš„ N-API ä¸­ï¼Œ<code>napi_async_complete_callback</code> æ˜¯ä¸€ä¸ªç±»å‹å®šä¹‰ï¼Œå®ƒæ˜¯ç”¨äºå¼‚æ­¥æ“ä½œçš„å›è°ƒå‡½æ•°çš„ç­¾åã€‚è¿™ä¸ªå›è°ƒå‡½æ•°åœ¨ä¸€ä¸ªå¼‚æ­¥æ“ä½œå®Œæˆæ—¶è¢«è°ƒç”¨ã€‚</p><p>ä¸ºäº†ç†è§£ <code>napi_async_complete_callback</code>ï¼Œéœ€è¦å…ˆæ˜ç™½å‡ ä¸ªæ¦‚å¿µï¼š</p><ol><li><strong>åŸç”Ÿæ’ä»¶</strong>ï¼šè¿™äº›æ’ä»¶æ˜¯ä½¿ç”¨ C æˆ– C++ ç¼–å†™çš„ï¼Œé€šè¿‡ N-API å¯ä»¥ä¸ Node.js äº¤äº’ã€‚</li><li><strong>å¼‚æ­¥æ“ä½œ</strong>ï¼šåœ¨ Node.js ä¸­ï¼Œå¾ˆå¤šæ“ä½œéƒ½æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œå³å®ƒä»¬ä¼šåœ¨åå°æ‰§è¡Œï¼Œå¹¶åœ¨å®Œæˆæ—¶é€šçŸ¥ Node.js ä¸»çº¿ç¨‹ã€‚</li><li><strong>å›è°ƒå‡½æ•°</strong>ï¼šå½“å¼‚æ­¥æ“ä½œå®Œæˆæ—¶ï¼Œç”¨æ¥æ¥æ”¶ç»“æœæˆ–è€…é”™è¯¯ä¿¡æ¯çš„å‡½æ•°ã€‚</li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹ <code>napi_async_complete_callback</code>ã€‚è¿™ä¸ªå›è°ƒå‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>typedef void (*napi_async_complete_callback)(napi_env env,</span></span>
<span class="line"><span>                                              napi_status status,</span></span>
<span class="line"><span>                                              void* data);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>napi_env env</code>: è¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªè¡¨ç¤º N-API ç¯å¢ƒçš„å¥æŸ„ï¼Œå®ƒæä¾›äº†å¤§é‡çš„ API å‡½æ•°ä½¿å¾—ä½ èƒ½åœ¨åŸç”Ÿæ’ä»¶ä¸­æ“ä½œ JavaScript ä»£ç ã€å¯¹è±¡ç­‰ã€‚</li><li><code>napi_status status</code>: è¿™ä¸ªå‚æ•°è¡¨ç¤ºå¼‚æ­¥æ“ä½œçš„å®ŒæˆçŠ¶æ€ï¼Œå®ƒå¯ä»¥å‘Šè¯‰ä½ æ“ä½œæ˜¯å¦æˆåŠŸï¼Œæˆ–è€…å‘ç”Ÿäº†å“ªç§ç±»å‹çš„é”™è¯¯ã€‚</li><li><code>void* data</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘ä»»æ„æ•°æ®çš„æŒ‡é’ˆï¼Œä½ å¯ä»¥åœ¨å¼€å§‹å¼‚æ­¥æ“ä½œæ—¶ä¼ é€’ä¸€ä¸ªæŒ‡å‘ä½ çš„æ•°æ®çš„æŒ‡é’ˆï¼Œåœ¨å›è°ƒå‡½æ•°è¢«è°ƒç”¨æ—¶å†ä»è¿™ä¸ªæŒ‡é’ˆè·å–æ•°æ®ã€‚</li></ul><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªéœ€è¦æ‰§è¡Œé•¿æ—¶é—´è®¡ç®—çš„å¼‚æ­¥æ“ä½œã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ <code>napi_async_complete_callback</code> çš„ä¾‹å­ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å‡è®¾è¿™ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„å¼‚æ­¥æ“ä½œ</span></span>
<span class="line"><span>void long_running_operation(void* data) {</span></span>
<span class="line"><span>    // æ‰§è¡Œä¸€äº›é•¿æ—¶é—´çš„æ“ä½œ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯å½“ä¸Šè¿°é•¿æ—¶é—´è¿è¡Œçš„æ“ä½œå®Œæˆåä¼šè¢«è°ƒç”¨çš„å›è°ƒå‡½æ•°</span></span>
<span class="line"><span>void operation_completed(napi_env env, napi_status status, void* data) {</span></span>
<span class="line"><span>    // æ ¹æ® status å‚æ•°æ£€æŸ¥æ“ä½œæ˜¯å¦æˆåŠŸå®Œæˆ</span></span>
<span class="line"><span>    if (status == napi_ok) {</span></span>
<span class="line"><span>        // å¦‚æœæˆåŠŸï¼Œå¤„ç†ç»“æœ</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // å¦‚æœå¤±è´¥ï¼Œå¤„ç†é”™è¯¯</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åœ¨ä½ çš„æ’ä»¶ä¸­å¯åŠ¨å¼‚æ­¥æ“ä½œï¼Œå¹¶æä¾›ä¸Šé¢çš„å›è°ƒ</span></span>
<span class="line"><span>void start_async_work() {</span></span>
<span class="line"><span>    // åˆå§‹åŒ–ä¸€äº›æ•°æ®</span></span>
<span class="line"><span>    void* data = ...;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¯åŠ¨å¼‚æ­¥æ“ä½œ</span></span>
<span class="line"><span>    long_running_operation(data);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è®¾ç½®å½“æ“ä½œå®Œæˆæ—¶è¦è°ƒç”¨çš„å›è°ƒå‡½æ•°</span></span>
<span class="line"><span>    napi_async_complete_callback callback = operation_completed;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ›´å¤šçš„ä»£ç æ¥å®‰æ’å›è°ƒå‡½æ•°åœ¨åˆé€‚çš„æ—¶æœºè¢«è°ƒç”¨...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼šå®é™…ä¸Šä½ ä¸èƒ½ç›´æ¥è¿™æ ·ç®€å•åœ°è°ƒç”¨ <code>long_running_operation</code> å’Œ <code>operation_completed</code>ï¼Œå› ä¸ºè¿™å°†åŒæ­¥æ‰§è¡Œå¹¶ä¸æ˜¯å¼‚æ­¥ã€‚åœ¨ Node.js çš„ N-API ä¸­ï¼Œä½ å¿…é¡»ä½¿ç”¨æ­£ç¡®çš„æ¨¡å¼æ¯”å¦‚ <code>napi_create_async_work</code> å’Œ <code>napi_queue_async_work</code> æ¥å®‰æ’å¼‚æ­¥å·¥ä½œå’Œç›¸åº”çš„å®Œæˆå›è°ƒã€‚ä»¥ä¸Šä»£ç åªæ˜¯ä¸ºäº†æ¼”ç¤º <code>napi_async_complete_callback</code> çš„æ¦‚å¿µè€Œå·²ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>napi_async_complete_callback</code> æ˜¯å®šä¹‰å¼‚æ­¥æ“ä½œå®Œæˆæ—¶è°ƒç”¨çš„å›è°ƒå‡½æ•°ç±»å‹ï¼Œå®ƒå…è®¸åŸç”Ÿæ’ä»¶å¼€å‘è€…å¤„ç†å¼‚æ­¥æ“ä½œçš„ç»“æœæˆ–é”™è¯¯ã€‚</p><h4 id="napi-threadsafe-function-call-js" tabindex="-1"><a class="header-anchor" href="#napi-threadsafe-function-call-js"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_threadsafe_function_call_js" target="_blank" rel="noopener noreferrer">napi_threadsafe_function_call_js</a></span></a></h4><p>Node.js ä¸­çš„ <code>napi_threadsafe_function_call_js</code> æ˜¯ä¸€ä¸ªç”¨äºå¤šçº¿ç¨‹ç¼–ç¨‹çš„é«˜çº§ API å‡½æ•°ï¼Œå®ƒå…è®¸ä½ åœ¨ä»»ä½•çº¿ç¨‹ä¸­å®‰å…¨åœ°è°ƒç”¨ JavaScript å‡½æ•°ã€‚è¿™å¾ˆé‡è¦ï¼Œå› ä¸ºé€šå¸¸åœ¨ Node.js ä¸­ï¼Œåªèƒ½åœ¨ä¸»çº¿ç¨‹ï¼ˆä¹Ÿå°±æ˜¯äº‹ä»¶å¾ªç¯è¿è¡Œçš„çº¿ç¨‹ï¼‰ä¸­ç›´æ¥æ‰§è¡Œ JavaScriptã€‚</p><p><code>napi_threadsafe_function_call_js</code> å±äº N-APIï¼Œè¿™æ˜¯ Node.js æä¾›çš„ä¸€ç»„ C è¯­è¨€ APIã€‚é€šè¿‡ N-APIï¼ŒåŸç”Ÿæ’ä»¶å¯ä»¥ä¸å— Node.js ç‰ˆæœ¬æ›´è¿›å»ºç«‹å’Œç»´æŠ¤ï¼ŒåŒæ—¶ä¿æŒå¯¹å‰åç‰ˆæœ¬çš„å…¼å®¹æ€§ã€‚</p><h3 id="æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#æ¦‚å¿µ"><span>æ¦‚å¿µ</span></a></h3><p>åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œå½“ä½ æƒ³ä»ä¸€ä¸ªéä¸»çº¿ç¨‹ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªç”± C++åº“åˆ›å»ºçš„çº¿ç¨‹ï¼‰è°ƒç”¨ JavaScript å‡½æ•°æ—¶ï¼Œå¦‚æœç›´æ¥è¿›è¡Œè¿™æ ·çš„è°ƒç”¨ï¼Œå¾ˆå¯èƒ½ä¼šå¯¼è‡´ç«äº‰æ¡ä»¶ã€å†…å­˜æ³„éœ²æˆ–ç¨‹åºå´©æºƒç­‰é—®é¢˜ï¼Œå› ä¸º V8 å¼•æ“ï¼ˆNode.js çš„ JavaScript å¼•æ“ï¼‰å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<code>napi_create_threadsafe_function()</code> å‡½æ•°è¢«ç”¨æ¥åˆ›å»ºä¸€ä¸ªæ‰€è°“çš„â€œçº¿ç¨‹å®‰å…¨å‡½æ•°â€ã€‚ç„¶åï¼Œä½ å¯ä»¥ä»ä»»ä½•çº¿ç¨‹ä½¿ç”¨ <code>napi_threadsafe_function_call_js</code> æ¥è°ƒç”¨è¿™ä¸ª JavaScript å‡½æ•°ï¼Œè€Œä¸ç”¨æ‹…å¿ƒä¸Šè¿°é‚£äº›é—®é¢˜ã€‚</p><h3 id="ä½¿ç”¨ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨ä¾‹å­"><span>ä½¿ç”¨ä¾‹å­</span></a></h3><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè€—æ—¶çš„è¿ç®—ä»»åŠ¡ï¼Œæˆ‘ä»¬æƒ³è¦åœ¨ä¸€ä¸ª C++çš„è¾…åŠ©çº¿ç¨‹ä¸­æ‰§è¡Œå®ƒï¼Œä½†åœ¨ä»»åŠ¡å®Œæˆåæˆ‘ä»¬éœ€è¦å›åˆ° Node.js çš„ä¸»çº¿ç¨‹æ¥å¤„ç†ç»“æœã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯å°†è¢«è¾…åŠ©çº¿ç¨‹è°ƒç”¨çš„JavaScriptå‡½æ•°</span></span>
<span class="line"><span>void js_callback(napi_env env, napi_value js_callback, void* context, void* data) {</span></span>
<span class="line"><span>    // åœ¨è¿™é‡Œæ„é€ ä½ çš„å›è°ƒé€»è¾‘</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è°ƒç”¨napi_create_threadsafe_functionåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°</span></span>
<span class="line"><span>napi_value resource_id;</span></span>
<span class="line"><span>napi_create_string_utf8(env, &quot;MyResource&quot;, NAPI_AUTO_LENGTH, &amp;resource_id);</span></span>
<span class="line"><span>napi_threadsafe_function tsfn;</span></span>
<span class="line"><span>napi_create_threadsafe_function(env,</span></span>
<span class="line"><span>                                js_func,      // ä¼ å…¥çš„JSå‡½æ•°</span></span>
<span class="line"><span>                                NULL,         // async_resource</span></span>
<span class="line"><span>                                resource_id,  // async_resource_name</span></span>
<span class="line"><span>                                0,            // max_queue_size</span></span>
<span class="line"><span>                                1,            // initial_thread_count</span></span>
<span class="line"><span>                                NULL,         // context</span></span>
<span class="line"><span>                                NULL,         // finalize_cb</span></span>
<span class="line"><span>                                NULL,         // finalize_hint</span></span>
<span class="line"><span>                                js_callback,  // nativeå›è°ƒ</span></span>
<span class="line"><span>                                &amp;tsfn);</span></span>
<span class="line"><span>...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åï¼Œåœ¨ä¸€ä¸ªè¾…åŠ©çº¿ç¨‹ä¸­ï¼Œå½“æˆ‘ä»¬æƒ³è¦è°ƒç”¨ JavaScript å‡½æ•°æ—¶ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>void some_async_work(void* data) {</span></span>
<span class="line"><span>    ...</span></span>
<span class="line"><span>    // æ‰§è¡ŒæŸäº›å¼‚æ­¥æ“ä½œ</span></span>
<span class="line"><span>    ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å½“å‡†å¤‡å¥½è°ƒç”¨JavaScriptæ—¶ï¼š</span></span>
<span class="line"><span>    napi_call_threadsafe_function(tsfn, data, napi_tsfn_blocking); // data æ˜¯å°†ä¼ é€’ç»™ `js_callback` çš„å‚æ•°</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ›å»ºæ–°çº¿ç¨‹å¹¶å¼€å§‹å¼‚æ­¥å·¥ä½œ</span></span>
<span class="line"><span>pthread_t thread_id;</span></span>
<span class="line"><span>pthread_create(&amp;thread_id, NULL, some_async_work, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åï¼Œå½“æˆ‘ä»¬ä¸å†éœ€è¦çº¿ç¨‹å®‰å…¨å‡½æ•°æ—¶ï¼Œé‡Šæ”¾å®ƒï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_release_threadsafe_function(tsfn, napi_tsfn_release);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç ç¤ºä¾‹è¯´æ˜äº†å¦‚ä½•è®¾ç½®ä¸€ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°å¹¶åœ¨è¾…åŠ©çº¿ç¨‹ä¸­è°ƒç”¨å®ƒã€‚è¿™é‡Œæ²¡æœ‰å±•ç¤ºå®Œæ•´çš„ä»£ç ï¼Œå› ä¸ºå®é™…çš„å®ç°éœ€è¦è€ƒè™‘ Node.js æ¨¡å—çš„åˆå§‹åŒ–ã€é”™è¯¯å¤„ç†ç­‰å¤šä¸ªæ–¹é¢ã€‚ä½†åŸºæœ¬æ€è·¯å°±æ˜¯åˆ›å»ºä¸€ä¸ªå¯ä»¥åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«å¹¶å®‰å…¨è°ƒç”¨çš„ JavaScript å‡½æ•°ï¼Œå¹¶ä¸”ç¡®ä¿å½“ä½ å®Œæˆä½¿ç”¨æ—¶æ­£ç¡®åœ°æ¸…ç†èµ„æºã€‚</p><h4 id="napi-cleanup-hook" tabindex="-1"><a class="header-anchor" href="#napi-cleanup-hook"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_cleanup_hook" target="_blank" rel="noopener noreferrer">napi_cleanup_hook</a></span></a></h4><p>Node.js çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„æ¥å£ã€‚åŸç”Ÿæ’ä»¶æ˜¯ä½¿ç”¨ C, C++ç­‰ç¼–ç¨‹è¯­è¨€ç¼–å†™çš„æ¨¡å—ï¼Œå¯ä»¥è¢« Node.js ç›´æ¥è°ƒç”¨ï¼Œé€šå¸¸ç”¨äºæ€§èƒ½å…³é”®å‹ä»»åŠ¡æˆ–è€…è°ƒç”¨æ“ä½œç³»ç»Ÿçº§åˆ«åŠŸèƒ½ã€‚</p><p><code>napi_cleanup_hook</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒå…è®¸åŸç”Ÿæ’ä»¶åœ¨ Node.js çš„ç¯å¢ƒè¢«æ¸…ç†å‰æ‰§è¡Œä¸€äº›ç‰¹å®šçš„ä»£ç ã€‚æ¢å¥è¯è¯´ï¼Œå½“ä½ çš„ Node.js åº”ç”¨ç¨‹åºå‡†å¤‡å…³é—­æ—¶ï¼ˆä¾‹å¦‚è°ƒç”¨äº†<code>process.exit()</code>æˆ–è€…æ­£å¸¸ç»“æŸï¼‰ï¼Œè¿™ä¸ªé’©å­å‡½æ•°å°±ä¼šè¢«è§¦å‘ã€‚</p><p>è¿™å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºå®ƒä¸ºåŸç”Ÿæ¨¡å—æä¾›äº†ä¸€ç§åœ¨åƒåœ¾æ”¶é›†å™¨é”€æ¯ä¹‹å‰è‡ªåŠ¨é‡Šæ”¾èµ„æºçš„æœºåˆ¶ã€‚å¦‚æœä½ åˆ›å»ºäº†ä¸€äº›éœ€è¦æ‰‹åŠ¨æ¸…ç†çš„èµ„æºï¼ˆæ¯”å¦‚åŠ¨æ€åˆ†é…çš„å†…å­˜ã€æ–‡ä»¶æè¿°ç¬¦ã€çº¿ç¨‹ç­‰ï¼‰ï¼Œé‚£ä¹ˆä½¿ç”¨<code>napi_cleanup_hook</code>å°±éå¸¸é‡è¦äº†ã€‚</p><p>ä¾‹å­ 1ï¼šå‡è®¾æ‚¨ç¼–å†™äº†ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œè¯¥æ¨¡å—æ‰“å¼€ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå¹¶ä¸”å¸Œæœ›åœ¨ Node.js é€€å‡ºæ—¶å…³é—­è¯¥æ–‡ä»¶ä»¥é˜²æ­¢æ•°æ®æŸåã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>void cleanup_file(void* arg) {</span></span>
<span class="line"><span>    FILE* file = (FILE*)arg;</span></span>
<span class="line"><span>    fclose(file);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ...åœ¨æŸå¤„æ³¨å†Œæ¸…ç†é’©å­</span></span>
<span class="line"><span>FILE* log_file = fopen(&quot;log.txt&quot;, &quot;a&quot;);</span></span>
<span class="line"><span>napi_add_cleanup_hook(env, cleanup_file, log_file);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªåä¸º<code>cleanup_file</code>çš„å‡½æ•°æ¥å…³é—­æ–‡ä»¶ã€‚ç„¶åï¼Œæˆ‘ä»¬æ‰“å¼€æ—¥å¿—æ–‡ä»¶ï¼Œå¹¶ç”¨<code>napi_add_cleanup_hook</code>æ³¨å†Œäº†è¿™ä¸ªå‡½æ•°ä½œä¸ºæ¸…ç†é’©å­ï¼Œå¹¶å°†æ–‡ä»¶æŒ‡é’ˆä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ƒã€‚</p><p>ä¾‹å­ 2ï¼šå‡è®¾ä½ çš„åŸç”Ÿæ¨¡å—å¯åŠ¨äº†ä¸€ä¸ªåå°çº¿ç¨‹æ¥æ‰§è¡Œä¸€äº›é•¿æ—¶é—´è¿è¡Œçš„è®¡ç®—ï¼Œå¹¶ä¸”éœ€è¦åœ¨åº”ç”¨ç¨‹åºé€€å‡ºæ—¶å®‰å…¨åœ°åœæ­¢è¯¥çº¿ç¨‹ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>void cleanup_thread(void* arg) {</span></span>
<span class="line"><span>    my_thread_data* data = (my_thread_data*)arg;</span></span>
<span class="line"><span>    // è®¾ç½®ä¸€ä¸ªæ ‡å¿—æˆ–å‘é€ä¿¡å·æ¥å‘Šè¯‰çº¿ç¨‹åœæ­¢è¿è¡Œ</span></span>
<span class="line"><span>    stop_thread(data-&gt;thread_id);</span></span>
<span class="line"><span>    // ç­‰å¾…çº¿ç¨‹å®é™…ç»“æŸ</span></span>
<span class="line"><span>    join_thread(data-&gt;thread_id);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ...åœ¨æŸå¤„æ³¨å†Œæ¸…ç†é’©å­</span></span>
<span class="line"><span>my_thread_data* thread_data = start_background_thread();</span></span>
<span class="line"><span>napi_add_cleanup_hook(env, cleanup_thread, thread_data);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå‡½æ•°<code>start_background_thread</code>æ¥å¯åŠ¨åå°çº¿ç¨‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«çº¿ç¨‹ä¿¡æ¯çš„ç»“æ„ä½“ã€‚æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<code>cleanup_thread</code>å‡½æ•°æ¥å¤„ç†çº¿ç¨‹çš„åœæ­¢è¿‡ç¨‹ï¼Œå¹¶é€šè¿‡<code>napi_add_cleanup_hook</code>æ³¨å†Œäº†å®ƒä½œä¸ºä¸€ä¸ªæ¸…ç†é’©å­ã€‚</p><p>æ€»ç»“ï¼š<code>napi_cleanup_hook</code>æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œå®ƒç¡®ä¿äº†å³ä½¿ Node.js åº”ç”¨ç¨‹åºæ­£åœ¨é€€å‡ºï¼ŒåŸç”Ÿæ¨¡å—ä¹Ÿèƒ½å¤Ÿæœ‰åºåœ°æ¸…ç†è‡ªå·±çš„èµ„æºï¼Œé¿å…å†…å­˜æ³„æ¼å’Œå…¶ä»–æ½œåœ¨é—®é¢˜ã€‚è®°ä½ï¼Œè¿™æ˜¯é«˜çº§åŠŸèƒ½ï¼Œå¹¶ä¸”ä¸»è¦ç”¨äºé‚£äº›åˆ›å»ºå¤æ‚åŸç”Ÿæ‰©å±•çš„å¼€å‘è€…ã€‚</p><h4 id="napi-async-cleanup-hook" tabindex="-1"><a class="header-anchor" href="#napi-async-cleanup-hook"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_async_cleanup_hook" target="_blank" rel="noopener noreferrer">napi_async_cleanup_hook</a></span></a></h4><p>Node.js ä¸­çš„ <code>napi_async_cleanup_hook</code> æ˜¯ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒå…è®¸ä½ åœ¨ Node.js çš„å¼‚æ­¥ç¯å¢ƒä¸­æ³¨å†Œæ¸…ç†é’©å­ï¼ˆcleanup hooksï¼‰ã€‚è¿™æ˜¯ä¸ºäº†ç¡®ä¿å½“ä¸€ä¸ªå¼‚æ­¥èµ„æºï¼Œæ¯”å¦‚å®šæ—¶å™¨ã€æ–‡ä»¶æµç­‰ï¼Œä¸å†éœ€è¦æ—¶èƒ½å¤Ÿé€‚å½“åœ°æ‰§è¡Œæ¸…ç†å·¥ä½œã€‚</p><p>åœ¨ Node.js åº”ç”¨ç¨‹åºä¸­ï¼Œæœ‰æ—¶ä½ ä¼šåˆ›å»ºä¸€äº›é•¿æœŸè¿è¡Œçš„å¼‚æ­¥æ“ä½œã€‚ä¾‹å¦‚ï¼Œå¯èƒ½ä¼šå¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨æ¥å‘¨æœŸæ€§åœ°æ‰§è¡Œä»»åŠ¡ï¼Œæˆ–è€…æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æµè¿›è¡Œè¯»å†™ã€‚å½“è¿™äº›å¼‚æ­¥æ“ä½œç»“æŸæˆ–ä¸å†éœ€è¦æ—¶ï¼Œä¸å®ƒä»¬ç›¸å…³è”çš„èµ„æºå¿…é¡»è¢«æ­£ç¡®åœ°é‡Šæ”¾ï¼Œä»¥é¿å…å†…å­˜æ³„æ¼å’Œå…¶ä»–æ½œåœ¨é—®é¢˜ã€‚</p><p><code>napi_async_cleanup_hook</code> å‡½æ•°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œè®¾è®¡çš„ã€‚é€šè¿‡ä½¿ç”¨è¿™ä¸ªå‡½æ•°ï¼Œä½ å¯ä»¥æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“ Node.js è¿›ç¨‹å‡†å¤‡é€€å‡ºæ—¶ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°å°†è¢«è°ƒç”¨ï¼Œä½¿å¾—ä½ æœ‰æœºä¼šå»æ¸…ç†é‚£äº›ä»ç„¶æŒ‚èµ·çš„å¼‚æ­¥èµ„æºã€‚</p><p>ä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼š</p><ol><li><strong>åˆ›å»ºå®šæ—¶å™¨ç¤ºä¾‹</strong>ï¼š<br> å‡è®¾ä½ åœ¨ Node.js åº”ç”¨ç¨‹åºä¸­è®¾ç½®äº†ä¸€ä¸ªé—´éš”å®šæ—¶å™¨ï¼ˆinterval timerï¼‰ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´æ‰§è¡ŒæŸé¡¹ä»»åŠ¡ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœä½ çš„åº”ç”¨ç¨‹åºéœ€è¦ä¼˜é›…åœ°å…³é—­ï¼Œä½ å¯èƒ½éœ€è¦æ¸…é™¤è¿™ä¸ªå®šæ—¶å™¨ã€‚</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> createHook</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> asyncResource</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">async_hooks</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡å®šå­˜åœ¨ä¸€ä¸ªå®šæ—¶å™¨å˜é‡</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> intervalTimer</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> initIntervalTimer</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // è®¾ç½®å®šæ—¶å™¨</span></span>
<span class="line"><span style="color:#D8DEE9;">  intervalTimer</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> setInterval</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">å®šæ—¶å™¨è¿è¡Œä¸­...</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span><span style="color:#B48EAD;"> 1000</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">  // ä½¿ç”¨ napi_async_cleanup_hook æ³¨å†Œæ¸…ç†é’©å­</span></span>
<span class="line"><span style="color:#88C0D0;">  createHook</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">    init</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">asyncId</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> type</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> triggerAsyncId</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> resource</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // å½“ Node.js é€€å‡ºæ—¶è°ƒç”¨çš„æ¸…ç†å‡½æ•°</span></span>
<span class="line"><span style="color:#81A1C1;">      if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">type</span><span style="color:#81A1C1;"> ===</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">TIMERWRAP</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">        napi_async_cleanup_hook</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">          clearInterval</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">intervalTimer</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">          console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">å®šæ—¶å™¨å·²æ¸…é™¤</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enable</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">initIntervalTimer</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åœ¨æŸä¸ªæ—¶é—´ç‚¹ä¹‹ååœæ­¢åº”ç”¨ç¨‹åº</span></span>
<span class="line"><span style="color:#88C0D0;">setTimeout</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  process</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">exit</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">0</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è§¦å‘æ¸…ç†é’©å­</span></span>
<span class="line"><span style="color:#ECEFF4;">},</span><span style="color:#B48EAD;"> 5000</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªåˆå§‹åŒ–å®šæ—¶å™¨çš„å‡½æ•° <code>initIntervalTimer()</code>ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œå¹¶æ³¨å†Œä¸€ä¸ª <code>napi_async_cleanup_hook</code> æ¥æ¸…ç†è¿™ä¸ªå®šæ—¶å™¨ã€‚å½“ <code>process.exit(0)</code> è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šè§¦å‘æ¸…ç†é’©å­ï¼Œä»è€Œæ¸…é™¤å®šæ—¶å™¨å¹¶è¾“å‡ºæ—¥å¿—è¡¨ç¤ºå®šæ—¶å™¨å·²è¢«æ¸…é™¤ã€‚</p><ol start="2"><li><strong>æ–‡ä»¶æµæ¸…ç†ç¤ºä¾‹</strong>ï¼š<br> å¦‚æœä½ æ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶æµç”¨äºè¯»å–æˆ–å†™å…¥æ•°æ®ï¼Œå¯èƒ½ä¹Ÿå¸Œæœ›åœ¨åº”ç”¨ç¨‹åºé€€å‡ºä¹‹å‰å…³é—­è¿™ä¸ªæµã€‚</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> createReadStream</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> createHook</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> asyncResource</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">async_hooks</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æµ</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> stream</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> createReadStream</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/file.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">createHook</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  init</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">asyncId</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> type</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> triggerAsyncId</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> resource</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">type</span><span style="color:#81A1C1;"> ===</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">FSREQCALLBACK</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">      // å½“ Node.js é€€å‡ºæ—¶è°ƒç”¨çš„æ¸…ç†å‡½æ•°</span></span>
<span class="line"><span style="color:#88C0D0;">      napi_async_cleanup_hook</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        stream</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">          console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">æ–‡ä»¶æµå·²å…³é—­</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">enable</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åœ¨æŸä¸ªæ—¶é—´ç‚¹ä¹‹ååœæ­¢åº”ç”¨ç¨‹åº</span></span>
<span class="line"><span style="color:#88C0D0;">setTimeout</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  process</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">exit</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">0</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è§¦å‘æ¸…ç†é’©å­</span></span>
<span class="line"><span style="color:#ECEFF4;">},</span><span style="color:#B48EAD;"> 5000</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¾‹å­ä¸­çš„ä»£ç ç±»ä¼¼ï¼Œæˆ‘ä»¬æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æµå¹¶ä½¿ç”¨ <code>napi_async_cleanup_hook</code> æ¥æ³¨å†Œä¸€ä¸ªæ¸…ç†é’©å­ï¼Œå®ƒå°†åœ¨åº”ç”¨ç¨‹åºé€€å‡ºå‰å…³é—­è¿™ä¸ªæ–‡ä»¶æµã€‚</p><p>é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œ<code>napi_async_cleanup_hook</code> æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼ŒN-API æ˜¯ä¸€ä¸ª C APIï¼Œå¯ç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶ã€‚åœ¨ JavaScript å±‚é¢ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ Node.js æä¾›çš„é«˜çº§æŠ½è±¡å¦‚ <code>async_hooks</code> æ¨¡å—æ¥å¤„ç†å¼‚æ­¥èµ„æºçš„ç”Ÿå‘½å‘¨æœŸã€‚</p><p>ä¸Šè¿°ä¾‹å­ä¸­ç®€åŒ–äº†è®¸å¤šåº•å±‚çš„ç»†èŠ‚ï¼Œå¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨ <code>napi_async_cleanup_hook</code>ï¼Œå› ä¸ºåœ¨çº¯ JavaScript ç¯å¢ƒä¸­ä¸ç›´æ¥ä½¿ç”¨ N-API å‡½æ•°ã€‚ä¸è¿‡ï¼Œå¯¹äºç¼–å†™æœ¬åœ°æ’ä»¶ï¼ˆnative addonï¼‰çš„å¼€å‘äººå‘˜æ¥è¯´ï¼Œäº†è§£å¦‚ä½•é€šè¿‡ N-API ä½¿ç”¨è¿™äº›é’©å­æ˜¯å¾ˆé‡è¦çš„ã€‚</p><h2 id="error-handling" tabindex="-1"><a class="header-anchor" href="#error-handling"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#error-handling" target="_blank" rel="noopener noreferrer">Error handling</a></span></a></h2><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ API å±‚ï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨ C æˆ– C++ ä»£ç ä¸ JavaScript è¿è¡Œæ—¶äº¤äº’ï¼Œå¹¶åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¹‹é—´æä¾›äºŒè¿›åˆ¶å…¼å®¹æ€§ã€‚é”™è¯¯å¤„ç†æ˜¯ç¼–ç¨‹ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªç¯èŠ‚ï¼Œå› ä¸ºå®ƒå¯ä»¥å¸®åŠ©ä½ ç†è§£ç¨‹åºè¿è¡Œæ—¶å¯èƒ½é‡åˆ°çš„é—®é¢˜å¹¶å¦¥å–„åœ°å¯¹è¿™äº›é—®é¢˜è¿›è¡Œå¤„ç†ã€‚</p><p>åœ¨ Node.js çš„ N-API ä¸­ï¼Œé”™è¯¯å¤„ç†é€šå¸¸æ¶‰åŠä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><ol><li><p><strong>N-API å‡½æ•°è¿”å›å€¼</strong>ï¼šå½“ä½ è°ƒç”¨ä¸€ä¸ª N-API å‡½æ•°æ—¶ï¼Œå®ƒé€šå¸¸ä¼šè¿”å›ä¸€ä¸ªç§°ä¸º <code>napi_status</code> çš„æšä¸¾å€¼ã€‚è¿™ä¸ªè¿”å›å€¼è¡¨ç¤ºå‡½æ•°è°ƒç”¨æ˜¯å¦æˆåŠŸã€‚å¦‚æœå‡½æ•°æ‰§è¡ŒæˆåŠŸï¼Œå®ƒé€šå¸¸è¿”å› <code>napi_ok</code>ã€‚å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œå®ƒå°†è¿”å›ä¸€ä¸ªä¸åŒçš„æšä¸¾å€¼ï¼Œæ¥æè¿°å‘ç”Ÿäº†ä»€ä¹ˆç±»å‹çš„é”™è¯¯ã€‚</p><p>ä¾‹å¦‚ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status status;</span></span>
<span class="line"><span>napi_value result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å°è¯•è°ƒç”¨ N-API å‡½æ•°å¹¶æ£€æŸ¥å…¶è¿”å›çŠ¶æ€</span></span>
<span class="line"><span>status = napi_do_something(env, &amp;result);</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>  // é”™è¯¯å¤„ç†é€»è¾‘</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>é”™è¯¯ä¿¡æ¯</strong>ï¼šå½“ N-API è¿”å›ä¸€ä¸ªé”™è¯¯çŠ¶æ€æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€äº›ç‰¹å®šçš„ N-API å‡½æ•°æ¥è·å–æ›´å¤šå…³äºé”™è¯¯çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥è·å–é”™è¯¯æ¶ˆæ¯æˆ–è§¦å‘é”™è¯¯çš„å¼•æ“å¼‚å¸¸ã€‚</p><p>ä¾‹å¦‚ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>const napi_extended_error_info* error_info;</span></span>
<span class="line"><span>status = napi_get_last_error_info(env, &amp;error_info);</span></span>
<span class="line"><span>if (status == napi_ok) {</span></span>
<span class="line"><span>  const char* error_message = error_info-&gt;error_message;</span></span>
<span class="line"><span>  // ä½¿ç”¨é”™è¯¯ä¿¡æ¯è¿›è¡Œå¤„ç†</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>å¼‚å¸¸å¤„ç†</strong>ï¼šJavaScript ä¸­çš„å¼‚å¸¸å¯ä»¥é€šè¿‡ N-API æ•è·å’ŒæŠ›å‡ºã€‚å¦‚æœæœ‰ä¸€ä¸ª JavaScript å¼‚å¸¸è¢«æŠ›å‡ºï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>napi_is_exception_pending</code> å‡½æ•°æ¥æ£€æŸ¥ï¼Œå¹¶ä½¿ç”¨ <code>napi_get_and_clear_last_exception</code> æ¥è·å–å¼‚å¸¸å¯¹è±¡ã€‚</p><p>ä¾‹å¦‚ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value exception;</span></span>
<span class="line"><span>bool has_exception;</span></span>
<span class="line"><span>status = napi_is_exception_pending(env, &amp;has_exception);</span></span>
<span class="line"><span>if (status == napi_ok &amp;&amp; has_exception) {</span></span>
<span class="line"><span>  status = napi_get_and_clear_last_exception(env, &amp;exception);</span></span>
<span class="line"><span>  // ç°åœ¨ä½ å¯ä»¥å¤„ç†å¼‚å¸¸äº†</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>åˆ›å»ºå’ŒæŠ›å‡ºé”™è¯¯</strong>ï¼šå¦‚æœä½ éœ€è¦ä»ä½ çš„åŸç”Ÿæ¨¡å—ä¸­æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œä½ å¯ä»¥ä½¿ç”¨å¦‚ <code>napi_throw_error</code>ã€<code>napi_throw_type_error</code> æˆ– <code>napi_throw_range_error</code> ç­‰å‡½æ•°æ¥åˆ›å»ºå¹¶æŠ›å‡ºé”™è¯¯ã€‚</p><p>ä¾‹å¦‚ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>status = napi_throw_error(env, NULL, &quot;An error occurred&quot;);</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>  // æŠ›å‡ºé”™è¯¯å¤±è´¥çš„å¤„ç†é€»è¾‘</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>å®é™…åº”ç”¨ä¾‹å­ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œè¯¥æ’ä»¶éœ€è¦å®Œæˆä¸€ä¸ªæ•°å­¦è®¡ç®—ï¼Œå¹¶ä¸”åªæ¥å—æ­£æ•´æ•°ä½œä¸ºè¾“å…¥ã€‚ä½ å¯ä»¥ä½¿ç”¨ N-API çš„é”™è¯¯å¤„ç†åŠŸèƒ½æ¥ç¡®ä¿è¾“å…¥æœ‰æ•ˆï¼Œå¹¶åœ¨å‡ºç°é”™è¯¯æ—¶é€šçŸ¥ JavaScriptã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status sum_positive_integers(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  size_t argc = 2;</span></span>
<span class="line"><span>  napi_value args[2];</span></span>
<span class="line"><span>  napi_value this_arg;</span></span>
<span class="line"><span>  int64_t number1, number2;</span></span>
<span class="line"><span>  napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è·å–å‚æ•°</span></span>
<span class="line"><span>  status = napi_get_cb_info(env, info, &amp;argc, args, &amp;this_arg, NULL);</span></span>
<span class="line"><span>  if (status != napi_ok || argc `&lt;` 2) {</span></span>
<span class="line"><span>    napi_throw_error(env, NULL, &quot;Function requires 2 arguments.&quot;);</span></span>
<span class="line"><span>    return status;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ç¡®ä¿å‚æ•°æ˜¯æ•°å­—å¹¶ä¸”æ˜¯æ­£æ•´æ•°</span></span>
<span class="line"><span>  status = napi_get_value_int64(env, args[0], &amp;number1);</span></span>
<span class="line"><span>  if (status != napi_ok || number1 `&lt;` 0) {</span></span>
<span class="line"><span>    napi_throw_type_error(env, NULL, &quot;First argument must be a positive integer.&quot;);</span></span>
<span class="line"><span>    return status;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  status = napi_get_value_int64(env, args[1], &amp;number2);</span></span>
<span class="line"><span>  if (status != napi_ok || number2 `&lt;` 0) {</span></span>
<span class="line"><span>    napi_throw_type_error(env, NULL, &quot;Second argument must be a positive integer.&quot;);</span></span>
<span class="line"><span>    return status;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è®¡ç®—å’Œ</span></span>
<span class="line"><span>  int64_t sum = number1 + number2;</span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span>  status = napi_create_int64(env, sum, &amp;result);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    napi_throw_error(env, NULL, &quot;An error occurred while creating return value.&quot;);</span></span>
<span class="line"><span>    return status;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›ç»“æœ</span></span>
<span class="line"><span>  return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ£€æŸ¥äº†å‡½æ•°æ˜¯å¦æ”¶åˆ°äº†æ­£ç¡®æ•°é‡çš„å‚æ•°ï¼ŒéªŒè¯äº†è¿™äº›å‚æ•°æ˜¯å¦ç¬¦åˆé¢„æœŸï¼ˆæ­£æ•´æ•°ï¼‰ï¼Œå¦‚æœæ£€æµ‹åˆ°ä»»ä½•é”™è¯¯ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨ N-API çš„é”™è¯¯æŠ›å‡ºå‡½æ•°æ¥è¿”å›ä¸€ä¸ªé€‚å½“çš„é”™è¯¯ç»™ JavaScript ç¯å¢ƒã€‚è¿™æ ·ï¼ŒJavaScript è°ƒç”¨è€…å°±å¯ä»¥æ•è·è¿™äº›é”™è¯¯å¹¶æ®æ­¤é‡‡å–ç›¸åº”çš„æªæ–½ã€‚</p><h3 id="return-values" tabindex="-1"><a class="header-anchor" href="#return-values"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#return-values" target="_blank" rel="noopener noreferrer">Return values</a></span></a></h3><p>Node.js ä¸­çš„ N-APIï¼ˆåŸç”Ÿ APIï¼‰å…è®¸ JavaScript ä»£ç å’Œ C/C++åŸç”Ÿæ’ä»¶ä¹‹é—´è¿›è¡Œäº¤äº’ã€‚å½“ä½ ä½¿ç”¨ N-API ç¼–å†™åŸç”Ÿæ‰©å±•æ—¶ï¼Œä½ ä¼šç»å¸¸éœ€è¦å¤„ç†å‡½æ•°è¿”å›å€¼ã€‚åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œâ€œè¿”å›å€¼â€ç‰¹æŒ‡ä»ä¸€ä¸ª N-API è°ƒç”¨è¿”å›åˆ° JavaScript çš„å€¼ã€‚</p><p>åœ¨ Node.js v21.7.1 çš„æ–‡æ¡£ä¸­ï¼Œå…³äºè¿”å›å€¼çš„è¯´æ˜ä¸»è¦æ˜¯å‘Šè¯‰å¼€å‘è€…å¦‚ä½•æ­£ç¡®åœ°ä» N-API å‡½æ•°è¿”å›ç»“æœç»™ JavaScript ä»£ç ã€‚å¤§å¤šæ•° N-API å‡½æ•°ä¼šè¿”å›ç±»å‹ä¸º <code>napi_status</code> çš„å€¼ã€‚è¿™ä¸ªå€¼è¡¨ç¤ºå‡½æ•°æ‰§è¡Œæ˜¯å¦æˆåŠŸï¼Œæˆ–è€…å‘ç”Ÿäº†ä»€ä¹ˆæ ·çš„é”™è¯¯ã€‚</p><p>è¿™é‡Œæœ‰ä¸€äº›å¯èƒ½çš„è¿”å›å€¼ï¼š</p><ul><li><code>napi_ok</code>: è¡¨ç¤ºæ²¡æœ‰é”™è¯¯å‘ç”Ÿï¼Œå‡½æ•°è°ƒç”¨æˆåŠŸã€‚</li><li><code>napi_invalid_arg</code>: è¡¨ç¤ºæä¾›äº†æ— æ•ˆå‚æ•°ã€‚</li><li><code>napi_object_expected</code>: è¡¨ç¤ºé¢„æœŸä¸€ä¸ªå¯¹è±¡ä½†æ²¡æœ‰å¾—åˆ°ã€‚</li><li><code>napi_string_expected</code>: è¡¨ç¤ºé¢„æœŸä¸€ä¸ªå­—ç¬¦ä¸²ä½†æ²¡æœ‰å¾—åˆ°ã€‚</li><li>...ä»¥åŠå…¶ä»–æ›´å¤šçš„çŠ¶æ€ç ã€‚</li></ul><p>ç°åœ¨æ¥çœ‹å‡ ä¸ªå®é™…çš„ä¾‹å­ï¼š</p><h3 id="ç¤ºä¾‹-1-åˆ›å»ºä¸€ä¸ªæ–°çš„-javascript-å­—ç¬¦ä¸²" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-1-åˆ›å»ºä¸€ä¸ªæ–°çš„-javascript-å­—ç¬¦ä¸²"><span>ç¤ºä¾‹ 1ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å­—ç¬¦ä¸²</span></a></h3><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªå°† C è¯­è¨€çš„å­—ç¬¦ä¸²å¤åˆ¶åˆ° JavaScript å­—ç¬¦ä¸²çš„ N-API å‡½æ•°ã€‚å‡½æ•°é¦–å…ˆæ£€æŸ¥å‚æ•°æœ‰æ•ˆï¼Œç„¶åæ‰§è¡Œæ“ä½œï¼Œå¹¶è¿”å›çŠ¶æ€ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯æˆ‘ä»¬çš„æœ¬åœ°æ‰©å±•å‡½æ•°</span></span>
<span class="line"><span>napi_status CreateNewString(napi_env env, napi_value* result) {</span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªCå­—ç¬¦ä¸²</span></span>
<span class="line"><span>    const char* str = &quot;Hello from native code!&quot;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ä½¿ç”¨N-APIåˆ›å»ºä¸€ä¸ªæ–°çš„JSå­—ç¬¦ä¸²</span></span>
<span class="line"><span>    return napi_create_string_utf8(env, str, NAPI_AUTO_LENGTH, result);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œå‡½æ•°ä½œä¸ºæ¨¡å—å¯¼å‡º</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>  napi_value new_str;</span></span>
<span class="line"><span>  napi_status status = CreateNewString(env, &amp;new_str);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  return new_str;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>CreateNewString</code>å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ JavaScript å­—ç¬¦ä¸²ï¼Œå¹¶é€šè¿‡<code>result</code>å‚æ•°è¿”å›å®ƒã€‚å¦‚æœæ“ä½œæˆåŠŸï¼Œ<code>napi_create_string_utf8</code>ä¼šè¿”å›<code>napi_ok</code>ã€‚</p><h3 id="ç¤ºä¾‹-2-ä»å‡½æ•°ä¸­è¿”å›æ•°å€¼" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-2-ä»å‡½æ•°ä¸­è¿”å›æ•°å€¼"><span>ç¤ºä¾‹ 2ï¼šä»å‡½æ•°ä¸­è¿”å›æ•°å€¼</span></a></h3><p>å¦ä¸€ä¸ªå¸¸è§ç”¨ä¾‹æ˜¯ä»åŸç”Ÿå‡½æ•°è¿”å›ä¸€ä¸ªæ•°å­—ç»™ JavaScriptã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯æˆ‘ä»¬çš„æœ¬åœ°æ‰©å±•å‡½æ•°</span></span>
<span class="line"><span>napi_status CalculateSum(napi_env env, int a, int b, napi_value* result) {</span></span>
<span class="line"><span>    int sum = a + b;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†è®¡ç®—ç»“æœè½¬æ¢ä¸ºJavaScriptæ•°å­—</span></span>
<span class="line"><span>    return napi_create_int32(env, sum, result);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œå‡½æ•°ä½œä¸ºæ¨¡å—å¯¼å‡º</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>  napi_value sum_result;</span></span>
<span class="line"><span>  napi_status status = CalculateSum(env, 3, 5, &amp;sum_result);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  return sum_result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>CalculateSum</code>æ¥æ”¶ä¸¤ä¸ªæ•´æ•°ï¼Œè®¡ç®—å®ƒä»¬çš„å’Œï¼Œå¹¶é€šè¿‡<code>result</code>è¿”å›è¿™ä¸ªå’Œçš„ JavaScript æ•°å€¼ã€‚å¦‚æœæˆåŠŸï¼Œ<code>napi_create_int32</code>ä¼šè¿”å›<code>napi_ok</code>ã€‚</p><p>æ³¨æ„ï¼Œåœ¨è¿™äº›ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰å±•ç¤ºé”™è¯¯å¤„ç†çš„å®Œæ•´ä»£ç ã€‚åœ¨å®é™…çš„ N-API æ¨¡å—ä¸­ï¼Œä½ éœ€è¦æ£€æŸ¥æ¯ä¸ª N-API è°ƒç”¨çš„è¿”å›çŠ¶æ€ï¼Œå¹¶é€‚å½“åœ°å¤„ç†é”™è¯¯æƒ…å†µï¼Œä¾‹å¦‚é‡Šæ”¾èµ„æºã€æ‰“å°é”™è¯¯ä¿¡æ¯ã€æˆ–è€…è¿”å›ä¸€ä¸ªé”™è¯¯å¯¹è±¡åˆ° JavaScriptã€‚</p><p>æ€»ç»“å°±æ˜¯ï¼ŒNode.js æ–‡æ¡£ä¸­å…³äº N-API çš„â€œè¿”å›å€¼â€éƒ¨åˆ†ä¸»è¦å¼ºè°ƒäº†ä» N-API å‡½æ•°è¿”å›çŠ¶æ€ç çš„é‡è¦æ€§ã€‚è¿™äº›çŠ¶æ€ç å¯¹äºè°ƒè¯•å’Œç¡®ä¿ N-API å‡½æ•°æ­£ç¡®åœ°ä¸ JavaScript äº¤äº’è‡³å…³é‡è¦ã€‚</p><h4 id="napi-get-last-error-info" tabindex="-1"><a class="header-anchor" href="#napi-get-last-error-info"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_last_error_info" target="_blank" rel="noopener noreferrer">napi_get_last_error_info</a></span></a></h4><p>å½“æ‚¨åœ¨ä½¿ç”¨ Node.js è¿›è¡Œç¼–ç¨‹ï¼Œç‰¹åˆ«æ˜¯å½“æ‚¨åœ¨ä½¿ç”¨ N-APIï¼ˆNode.js çš„ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIï¼‰æ—¶ï¼Œæ‚¨å¯èƒ½ä¼šé‡åˆ°é”™è¯¯å’Œé—®é¢˜ã€‚è¿™æ—¶å€™ï¼Œ<code>napi_get_last_error_info</code> å°±æ´¾ä¸Šäº†ç”¨åœºã€‚</p><p><code>napi_get_last_error_info</code> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒèƒ½å¤Ÿå¸®åŠ©æ‚¨è·å¾—å…³äºæœ€åä¸€ä¸ªå‘ç”Ÿçš„ N-API è°ƒç”¨é”™è¯¯çš„ä¿¡æ¯ã€‚æ¯å½“ N-API å‡½æ•°å¤±è´¥æ—¶ï¼ŒNode.js éƒ½ä¼šå­˜å‚¨æœ‰å…³é”™è¯¯çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬é”™è¯¯ä»£ç ã€é”™è¯¯æ¶ˆæ¯ç­‰ã€‚</p><p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ <code>napi_get_last_error_info</code> å’Œå®ƒæœ‰ä»€ä¹ˆä½œç”¨ï¼š</p><h3 id="ä½¿ç”¨-napi-get-last-error-info-çš„æ­¥éª¤" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-napi-get-last-error-info-çš„æ­¥éª¤"><span>ä½¿ç”¨ <code>napi_get_last_error_info</code> çš„æ­¥éª¤ï¼š</span></a></h3><ol><li>å½“æ‚¨è°ƒç”¨ä¸€ä¸ª N-API å‡½æ•°ä¸”å®ƒè¿”å›ä¸€ä¸ªè¡¨ç¤ºå¤±è´¥çš„ç»“æœæ—¶ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªé”™è¯¯ç ï¼‰ã€‚</li><li>ç„¶åæ‚¨å¯ä»¥ç«‹å³è°ƒç”¨ <code>napi_get_last_error_info</code> æ¥è·å–é”™è¯¯è¯¦æƒ…ã€‚</li><li>æ­¤å‡½æ•°å°†å¡«å……ä¸€ä¸ªä½ æä¾›çš„ <code>napi_extended_error_info</code> ç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…å«äº†é”™è¯¯ä¿¡æ¯ã€‚</li></ol><h3 id="napi-get-last-error-info-çš„å®é™…ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#napi-get-last-error-info-çš„å®é™…ä¾‹å­"><span><code>napi_get_last_error_info</code> çš„å®é™…ä¾‹å­ï¼š</span></a></h3><p>å‡è®¾æ‚¨æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åŸç”Ÿæ’ä»¶ï¼Œè¯¥æ’ä»¶éœ€è¦ä» Node.js æ¥æ”¶ä¸€äº›æ•°æ®ã€‚æ‚¨å¯èƒ½ä¼šè°ƒç”¨ä¸€ä¸ª N-API å‡½æ•°æ¥è¯»å–è¿™ä¸ªæ•°æ®ï¼Œæ¯”å¦‚ <code>napi_get_value_string_utf8</code>ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ª napi_value å˜é‡ `value` ä»£è¡¨JSä¼ è¿‡æ¥çš„å­—ç¬¦ä¸²</span></span>
<span class="line"><span>napi_status status;</span></span>
<span class="line"><span>size_t result;</span></span>
<span class="line"><span>char* buffer;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å°è¯•è·å–å­—ç¬¦ä¸²é•¿åº¦</span></span>
<span class="line"><span>status = napi_get_value_string_utf8(env, value, NULL, 0, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ¤æ–­æ˜¯å¦æˆåŠŸæ‰§è¡Œ</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>  // å¦‚æœå¤±è´¥ï¼Œåˆ™è·å–é”™è¯¯ä¿¡æ¯</span></span>
<span class="line"><span>  const napi_extended_error_info* error_info;</span></span>
<span class="line"><span>  napi_get_last_error_info(env, &amp;error_info);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¾“å‡ºé”™è¯¯ä¿¡æ¯</span></span>
<span class="line"><span>  printf(&quot;Error code: %d\n&quot;, error_info-&gt;error_code);</span></span>
<span class="line"><span>  printf(&quot;Error message: %s\n&quot;, error_info-&gt;error_message);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š</p><ul><li>æˆ‘ä»¬é¦–å…ˆå°è¯•é€šè¿‡è°ƒç”¨ <code>napi_get_value_string_utf8</code> æ¥è·å–å­—ç¬¦ä¸²é•¿åº¦ã€‚</li><li>å¦‚æœçŠ¶æ€ç  <code>status</code> ä¸æ˜¯ <code>napi_ok</code>ï¼Œæ„å‘³ç€å‡½æ•°è°ƒç”¨å¤±è´¥ã€‚</li><li>æ¥ç€æˆ‘ä»¬è°ƒç”¨ <code>napi_get_last_error_info</code> è·å–æ›´å¤šå…³äºé”™è¯¯çš„ä¿¡æ¯ã€‚</li><li>æˆ‘ä»¬ä½¿ç”¨ <code>napi_extended_error_info</code> ç»“æ„ä½“æ¥è·å–é”™è¯¯ä»£ç å’Œæ¶ˆæ¯ã€‚</li><li>æœ€åæ‰“å°å‡ºé”™è¯¯ä¿¡æ¯ã€‚</li></ul><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½¿ç”¨ <code>napi_get_last_error_info</code> å¯ä»¥å¸®åŠ©å¼€å‘è€…è¯Šæ–­ N-API å‡½æ•°è°ƒç”¨å¤±è´¥çš„åŸå› ï¼Œå¹¶æ ¹æ®é”™è¯¯ä¿¡æ¯æ¥ä¿®å¤é—®é¢˜ã€‚</p><p>è®°ä½ï¼Œè¿™æ˜¯åœ¨ç¼–å†™ C æˆ– C++æ‰©å±•æ—¶ä½¿ç”¨çš„å‡½æ•°ã€‚åœ¨ JavaScript ä»£ç ä¸­ï¼Œæ‚¨é€šå¸¸ä¸ä¼šç›´æ¥ä¸è¿™äº›åº•å±‚ API æ‰“äº¤é“ã€‚è¿™æ˜¯ä¸ºé‚£äº›æƒ³è¦æ‰©å±• Node.js èƒ½åŠ›ï¼Œé€šè¿‡ç¼–å†™æ¥è¿‘ç¡¬ä»¶å±‚é¢ä»£ç çš„é«˜çº§ç”¨æˆ·å‡†å¤‡çš„ã€‚</p><h3 id="exceptions" tabindex="-1"><a class="header-anchor" href="#exceptions"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#exceptions" target="_blank" rel="noopener noreferrer">Exceptions</a></span></a></h3><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶çš„æ¥å£ã€‚å®ƒå…è®¸ä½ ä½¿ç”¨ C æˆ–è€… C++ ä»£ç ä¸ Node.js è¿›è¡Œäº¤äº’ï¼Œè¿™æ ·å¯ä»¥åœ¨æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ä¸­è¿ç”¨æ›´é«˜æ•ˆçš„ä»£ç ã€‚åœ¨ v21.7.1 ç‰ˆæœ¬çš„æ–‡æ¡£ä¸­ï¼Œâ€œExceptionsâ€æŒ‡çš„æ˜¯åœ¨ä½ çš„æœ¬åœ°æ’ä»¶ä»£ç ä¸­å¦‚ä½•å¤„ç†å’ŒæŠ›å‡ºé”™è¯¯ã€‚</p><p>å¼‚å¸¸ï¼ˆExceptionsï¼‰æ˜¯ä¸€ç§åœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°ä¸æ­£å¸¸æƒ…å†µæ—¶é€šçŸ¥è¿è¡Œç¯å¢ƒçš„æœºåˆ¶ã€‚åœ¨ JavaScript ä¸­ï¼Œé€šå¸¸ä¼šä½¿ç”¨ <code>throw</code> å…³é”®å­—æ¥æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œå¹¶ä¸”å¯ä»¥ç”¨ <code>try...catch</code> ç»“æ„æ¥æ•è·å¹¶å¤„ç†è¿™äº›å¼‚å¸¸ã€‚</p><p>å½“ä½ åœ¨ç¼–å†™ä½¿ç”¨ N-API çš„æœ¬åœ°æ’ä»¶æ—¶ï¼Œä½ ä¹Ÿéœ€è¦æ­£ç¡®å¤„ç†å¯èƒ½å‘ç”Ÿçš„å¼‚å¸¸ï¼Œè¿™åŒ…æ‹¬ä¸¤ä¸ªæ–¹é¢ï¼š</p><ol><li>å°† C/C++ ä¸­çš„é”™è¯¯è½¬æ¢ä¸º JavaScript å¼‚å¸¸ã€‚</li><li>æ•è· JavaScript å¼‚å¸¸å¹¶åœ¨æœ¬åœ°ä»£ç ä¸­è¿›è¡Œå¤„ç†ã€‚</li></ol><p>ä¸‹é¢æ˜¯å‡ ä¸ªå…³äºåœ¨ Node.js N-API ä¸­å¦‚ä½•å¤„ç†å¼‚å¸¸çš„ä¾‹å­ï¼š</p><h3 id="æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸" tabindex="-1"><a class="header-anchor" href="#æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸"><span>æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸</span></a></h3><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªæœ¬åœ°å‡½æ•°ï¼Œä½ æƒ³åœ¨æŸç§é”™è¯¯æ¡ä»¶ä¸‹å°†å…¶è½¬æ¢ä¸º JavaScript å¼‚å¸¸ã€‚</p><p>C++ ä»£ç ç¤ºä¾‹:</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // å‡è®¾å‘ç”Ÿäº†æŸç§é”™è¯¯</span></span>
<span class="line"><span>    bool has_error = true;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (has_error) {</span></span>
<span class="line"><span>        // åˆ›å»ºä¸€ä¸ª JavaScript é”™è¯¯å¯¹è±¡</span></span>
<span class="line"><span>        napi_value error;</span></span>
<span class="line"><span>        napi_create_error(env, nullptr, napi_value(&quot;å‘ç”Ÿé”™è¯¯&quot;), &amp;error);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // æŠ›å‡ºè¿™ä¸ªé”™è¯¯å¯¹è±¡</span></span>
<span class="line"><span>        napi_throw(env, error);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›æœªå®šä¹‰ï¼ˆå¦‚æœæ²¡æœ‰é”™è¯¯ï¼‰</span></span>
<span class="line"><span>    napi_value undefined;</span></span>
<span class="line"><span>    napi_get_undefined(env, &amp;undefined);</span></span>
<span class="line"><span>    return undefined;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ•è·å¹¶å¤„ç†å¼‚å¸¸" tabindex="-1"><a class="header-anchor" href="#æ•è·å¹¶å¤„ç†å¼‚å¸¸"><span>æ•è·å¹¶å¤„ç†å¼‚å¸¸</span></a></h3><p>ç°åœ¨å‡è®¾ä½ è°ƒç”¨äº†ä¸€ä¸ªå¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸çš„ JavaScript å‡½æ•°ï¼Œå¹¶ä¸”ä½ æƒ³åœ¨ä½ çš„æœ¬åœ°ä»£ç ä¸­æ•è·å¹¶å¤„ç†è¿™ä¸ªå¼‚å¸¸ã€‚</p><p>C++ ä»£ç ç¤ºä¾‹:</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void CallJavaScriptFunction(napi_env env) {</span></span>
<span class="line"><span>    // è·å–å…¨å±€å¯¹è±¡</span></span>
<span class="line"><span>    napi_value global;</span></span>
<span class="line"><span>    napi_get_global(env, &amp;global);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–ä½ æƒ³è°ƒç”¨çš„ JavaScript å‡½æ•°ï¼ˆæ¯”å¦‚ &#39;someFunction&#39;ï¼‰</span></span>
<span class="line"><span>    napi_value js_function;</span></span>
<span class="line"><span>    napi_get_named_property(env, global, &quot;someFunction&quot;, &amp;js_function);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è°ƒç”¨è¿™ä¸ªå‡½æ•°</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    napi_status status = napi_call_function(env, global, js_function, 0, nullptr, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦åœ¨è°ƒç”¨æœŸé—´æŠ›å‡ºäº†å¼‚å¸¸</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // ä»ç¯å¢ƒä¸­è·å–å¼‚å¸¸</span></span>
<span class="line"><span>        napi_value exception;</span></span>
<span class="line"><span>        napi_get_and_clear_last_exception(env, &amp;exception);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // å¤„ç†è¿™ä¸ªå¼‚å¸¸ï¼Œæˆ–è€…é‡æ–°æŠ›å‡º</span></span>
<span class="line"><span>        // (ä¾‹å¦‚æ‰“å°é”™è¯¯ä¿¡æ¯)</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ç¬¬äºŒä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°è¯•è°ƒç”¨ä¸€ä¸ª JavaScript å‡½æ•°ï¼Œå¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡ <code>napi_get_and_clear_last_exception</code> æ•è·å®ƒï¼Œå¹¶å†³å®šå¦‚ä½•å¤„ç†ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œåœ¨ Node.js N-API ä¸­å¤„ç†å¼‚å¸¸æ¶‰åŠåˆ›å»º JavaScript é”™è¯¯å¯¹è±¡ã€æŠ›å‡ºå®ƒä»¬ä»¥åŠåœ¨æœ¬åœ°ä»£ç ä¸­æ•è·å’Œå¤„ç† JavaScript æŠ›å‡ºçš„å¼‚å¸¸ã€‚æ­£ç¡®åœ°å¤„ç†å¼‚å¸¸å¯¹äºç¼–å†™ç¨³å®šä¸”å¯é çš„åŸç”Ÿæ’ä»¶è‡³å…³é‡è¦ã€‚</p><h4 id="napi-throw" tabindex="-1"><a class="header-anchor" href="#napi-throw"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_throw" target="_blank" rel="noopener noreferrer">napi_throw</a></span></a></h4><p>Node.js ä¸­çš„<code>napi_throw</code>æ˜¯ Node.js æä¾›çš„ä¸€ä¸ª APIï¼Œå®ƒå±äº N-APIï¼ˆåŸç”Ÿ APIï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨ C æˆ– C++ç¼–å†™åŸç”Ÿæ’ä»¶çš„æ¥å£ã€‚<code>napi_throw</code>çš„ä½œç”¨æ˜¯åœ¨åŸç”Ÿä»£ç ä¸­æŠ›å‡ºä¸€ä¸ª JavaScript é”™è¯¯ã€‚</p><p>å½“ä½ ä½¿ç”¨ Node.js è¿›è¡Œå¼€å‘æ—¶ï¼Œå¤§éƒ¨åˆ†æ—¶é—´ä½ å¯èƒ½éƒ½æ˜¯åœ¨ç”¨ JavaScript ç¼–å†™ä»£ç ã€‚ç„¶è€Œï¼Œæœ‰æ—¶å€™ä½ å¯èƒ½éœ€è¦è°ƒç”¨ä¸€äº›åº•å±‚ç³»ç»Ÿçº§åˆ«çš„åŠŸèƒ½ï¼Œæˆ–è€…æƒ³è¦æé«˜ç¨‹åºçš„æ€§èƒ½ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨ C æˆ– C++æ¥ç¼–å†™é‚£éƒ¨åˆ†ä»£ç ï¼Œç„¶åé€šè¿‡ N-API ä¸ä½ çš„ Node.js åº”ç”¨ç¨‹åºäº¤äº’ã€‚</p><p>ä¸‹é¢æˆ‘å°†é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­è§£é‡Š<code>napi_throw</code>çš„å·¥ä½œåŸç†ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js çš„æ‰©å±•æ¨¡å—ï¼Œè¯¥æ¨¡å—éœ€è¦å¯¹ä¼ å…¥çš„å­—ç¬¦ä¸²å‚æ•°è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœä¼ å…¥çš„ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™åº”è¯¥æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚ä½ çš„ C å‡½æ•°å¯èƒ½ä¼šåƒè¿™æ ·ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  size_t argc = 1;</span></span>
<span class="line"><span>  napi_value argv[1];</span></span>
<span class="line"><span>  napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è·å–å‡½æ•°å‚æ•°</span></span>
<span class="line"><span>  status = napi_get_cb_info(env, info, &amp;argc, argv, NULL, NULL);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    napi_throw_error(env, NULL, &quot;è·å–å‚æ•°å¤±è´¥ï¼&quot;);</span></span>
<span class="line"><span>    return NULL;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ£€æŸ¥å‚æ•°ç±»å‹æ˜¯å¦ä¸ºå­—ç¬¦ä¸²</span></span>
<span class="line"><span>  napi_valuetype val_type;</span></span>
<span class="line"><span>  status = napi_typeof(env, argv[0], &amp;val_type);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    napi_throw_error(env, NULL, &quot;æ— æ³•æ£€æŸ¥å‚æ•°ç±»å‹ï¼&quot;);</span></span>
<span class="line"><span>    return NULL;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (val_type != napi_string) {</span></span>
<span class="line"><span>    // å¦‚æœå‚æ•°ä¸æ˜¯å­—ç¬¦ä¸²ï¼ŒæŠ›å‡ºTypeError</span></span>
<span class="line"><span>    napi_throw_type_error(env, NULL, &quot;å‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼&quot;);</span></span>
<span class="line"><span>    return NULL;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿™é‡Œæ˜¯å¤„ç†å­—ç¬¦ä¸²çš„å…¶ä»–é€»è¾‘...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å‡è®¾ä¸€åˆ‡é¡ºåˆ©ï¼Œä½ è¿”å›äº†æŸä¸ªç»“æœ</span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span>  // ... åˆ›å»ºresultå€¼ ...</span></span>
<span class="line"><span>  return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°å’Œå¯¼å‡ºæ¨¡å—...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡<code>napi_get_cb_info</code>è·å– JavaScript ä¼ ç»™å‡½æ•°çš„å‚æ•°ã€‚ç„¶åï¼Œæˆ‘ä»¬æ£€æŸ¥è¿™ä¸ªå‚æ•°æ˜¯å¦ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>napi_throw_type_error</code>æŠ›å‡ºä¸€ä¸ª TypeError å¼‚å¸¸ã€‚æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨çš„æ˜¯ç‰¹æ®Šçš„<code>napi_throw_type_error</code>è€Œä¸æ˜¯<code>napi_throw</code>ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³è¦æŠ›å‡ºçš„æ˜¯å…·ä½“çš„ TypeError å¼‚å¸¸ã€‚</p><p>å®é™…ä¸Šï¼Œ<code>napi_throw</code>æ›´åŠ é€šç”¨ï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒç›´æ¥æŠ›å‡ºä¸€ä¸ªè‡ªå®šä¹‰çš„é”™è¯¯å¯¹è±¡ã€‚ä¾‹å¦‚ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value error_object;</span></span>
<span class="line"><span>// ... åˆ›å»ºæˆ–è·å–æŸä¸ªé”™è¯¯å¯¹è±¡ ...</span></span>
<span class="line"><span>status = napi_throw(env, error_object); // æŠ›å‡ºè¿™ä¸ªé”™è¯¯å¯¹è±¡</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>napi_throw</code>å°±æ˜¯ä¸€ä¸ªè®©ä½ åœ¨åŸç”Ÿæ¨¡å—ä»£ç ä¸­æŠ›å‡º JavaScript é”™è¯¯çš„å·¥å…·ï¼Œå®ƒè®©ä½ èƒ½å¤Ÿå‘ŠçŸ¥ JavaScript è¿è¡Œæ—¶ï¼šè¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå¤„ç†æµç¨‹åº”è¯¥åœä¸‹æ¥ï¼Œå¹¶ä»¥å¼‚å¸¸çš„æ–¹å¼å‘Šè¯‰è°ƒç”¨æ–¹ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ­£ç¡®åœ°å¤„ç†é”™è¯¯å¹¶æŠ›å‡ºå¼‚å¸¸æ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºå®ƒæœ‰åŠ©äºä¿æŒä»£ç çš„é²æ£’æ€§å¹¶ä½¿å¾—è°ƒè¯•æ›´åŠ å®¹æ˜“ã€‚</p><h4 id="napi-throw-error" tabindex="-1"><a class="header-anchor" href="#napi-throw-error"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_throw_error" target="_blank" rel="noopener noreferrer">napi_throw_error</a></span></a></h4><p><code>napi_throw_error</code> æ˜¯ Node.js ä¸­ N-APIï¼ˆNode.js APIï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå…è®¸æœ¬åœ°æ’ä»¶çš„å¼€å‘è€…ï¼ˆé€šå¸¸æ˜¯ä½¿ç”¨ C æˆ–è€… C++è¯­è¨€ç¼–å†™çš„ä»£ç æ¨¡å—ï¼‰åœ¨å‘ç”Ÿé”™è¯¯æ—¶å‘ JavaScript æŠ›å‡ºå¼‚å¸¸ã€‚N-API æ˜¯ä¸€ä¸ªç¨³å®šçš„ API å±‚ï¼Œå…è®¸ä½ æ„å»ºåŸç”Ÿæ’ä»¶å¹¶ä¿è¯åœ¨ Node.js çš„ä¸åŒç‰ˆæœ¬é—´ä¿æŒå…¼å®¹æ€§ã€‚</p><p>å½“ä½ åœ¨ JavaScript ä»£ç ä¸­é‡åˆ°é”™è¯¯æ—¶ï¼Œå¯èƒ½ä¼šç”¨åˆ° <code>throw</code> å…³é”®å­—æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œç±»ä¼¼åœ°ï¼Œåœ¨åŸç”Ÿæ¨¡å—ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>napi_throw_error</code> æ¥å®ç°è¿™ä¸ªç›®çš„ã€‚å½“ä½ è°ƒç”¨ <code>napi_throw_error</code> åï¼Œå½“å‰æ‰§è¡Œçš„ Node.js å‡½æ•°ä¼šåœæ­¢ï¼Œå¹¶ä¸”è¿™ä¸ªé”™è¯¯ä¼šè¢«è¿”å›ç»™è°ƒç”¨è¿™ä¸ªåŸç”Ÿæ¨¡å—çš„ JavaScript ä»£ç ã€‚</p><p>ä¸‹é¢æ˜¯ <code>napi_throw_error</code> çš„åŸºæœ¬ç”¨æ³•ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ... ä¸€äº›ä»£ç é€»è¾‘ ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å‡è®¾å‡ºç°äº†ä¸€ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬éœ€è¦æŠ›å‡ºå®ƒ</span></span>
<span class="line"><span>    if (å‘ç°é”™è¯¯) {</span></span>
<span class="line"><span>        status = napi_throw_error(env, NULL, &quot;è¿™é‡Œæ˜¯é”™è¯¯ä¿¡æ¯&quot;);</span></span>
<span class="line"><span>        if (status != napi_ok) {</span></span>
<span class="line"><span>            // å¤„ç†æ— æ³•æŠ›å‡ºé”™è¯¯çš„æƒ…å†µ</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å…¶ä»–é€»è¾‘...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º <code>MyFunction</code> çš„å‡½æ•°ï¼Œå®ƒå¯èƒ½æ˜¯ä½œä¸ºä¸€ä¸ªåŸç”Ÿæ¨¡å—æš´éœ²ç»™ JavaScript çš„åŠŸèƒ½ã€‚å¦‚æœåœ¨å‡½æ•°å†…éƒ¨æ£€æµ‹åˆ°äº†é”™è¯¯æ¡ä»¶ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨ <code>napi_throw_error</code> æ¥æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚ç¬¬ä¸€ä¸ªå‚æ•° <code>env</code> æ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œå®ƒæä¾›äº†å½“å‰ Node.js è°ƒç”¨çš„ä¸Šä¸‹æ–‡ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯é”™è¯¯ç ï¼Œè¿™é‡Œä¼ é€’ <code>NULL</code> è¡¨ç¤ºæˆ‘ä»¬æ²¡æœ‰æŒ‡å®šé”™è¯¯ç ã€‚æœ€åä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªäººç±»å¯è¯»çš„é”™è¯¯ä¿¡æ¯å­—ç¬¦ä¸²ã€‚</p><p>ä¾‹å¦‚ï¼Œå‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œç”¨æ¥å¤„ç†å›¾åƒï¼Œä½†æ˜¯å¦‚æœä¼ å…¥çš„æ–‡ä»¶è·¯å¾„ä¸å­˜åœ¨ï¼Œä½ å°±éœ€è¦æŠ¥å‘Šä¸€ä¸ªé”™è¯¯ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span>#include `&lt;`stdio.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value ProcessImage(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    char filename[100];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å‡è®¾æˆ‘ä»¬é€šè¿‡æŸäº›æ–¹å¼è·å–åˆ°äº†æ–‡ä»¶ååˆ° filename å˜é‡</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span>
<span class="line"><span>    if (fopen(filename, &quot;r&quot;) == NULL) {</span></span>
<span class="line"><span>        // æ–‡ä»¶ä¸å­˜åœ¨ï¼ŒæŠ›å‡ºé”™è¯¯</span></span>
<span class="line"><span>        status = napi_throw_error(env, NULL, &quot;æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•æ‰“å¼€ï¼&quot;);</span></span>
<span class="line"><span>        if (status != napi_ok) {</span></span>
<span class="line"><span>            // å¤„ç†æ— æ³•æŠ›å‡ºé”™è¯¯çš„æƒ…å†µ</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¤„ç†å›¾åƒ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›ç»“æœ...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœå°è¯•æ‰“å¼€æ–‡ä»¶å¤±è´¥äº†ï¼Œé‚£ä¹ˆ <code>fopen</code> ä¼šè¿”å› <code>NULL</code>ï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨ <code>napi_throw_error</code> æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯æ˜¯ &quot;æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•æ‰“å¼€ï¼&quot;ã€‚å½“è¿™ä¸ªåŸç”Ÿæ¨¡å—çš„è¿™ä¸ªå‡½æ•°è¢« JavaScript ä»£ç è°ƒç”¨æ—¶ï¼Œå¦‚æœé‡åˆ°è¿™ä¸ªé”™è¯¯ï¼ŒJavaScript è°ƒç”¨è€…å¯ä»¥æ•è·è¿™ä¸ªå¼‚å¸¸å¹¶ä½œå‡ºç›¸åº”çš„å¤„ç†ã€‚</p><h4 id="napi-throw-type-error" tabindex="-1"><a class="header-anchor" href="#napi-throw-type-error"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_throw_type_error" target="_blank" rel="noopener noreferrer">napi_throw_type_error</a></span></a></h4><p>å½“ç„¶ï¼Œè®©æˆ‘æ¥è¯¦ç»†è§£é‡Šä¸€ä¸‹ <code>napi_throw_type_error</code> è¿™ä¸ªå‡½æ•°åœ¨ Node.js ä¸­çš„ä½œç”¨ã€‚</p><p>Node.js çš„ N-API æ˜¯ä¸€ä¸ª C è¯­è¨€çš„æ¥å£ï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨ C æˆ– C++ç¼–å†™æ‰©å±•ï¼Œå¹¶ä¸ JavaScript äº¤äº’ã€‚è¿™ä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿä¸º Node.js ç¼–å†™æ€§èƒ½æ•æ„Ÿçš„æ“ä½œï¼Œæ¯”å¦‚ç›´æ¥ä¸æ“ä½œç³»ç»Ÿæˆ–å…¶ä»–åº•å±‚ç³»ç»Ÿäº¤äº’ã€‚</p><p><code>napi_throw_type_error</code> æ˜¯ N-API ä¸­æä¾›çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåœ¨åŸç”Ÿä»£ç ä¸­æŠ›å‡ºä¸€ä¸ª JavaScript ç±»å‹é”™è¯¯ï¼ˆTypeErrorï¼‰ã€‚ç±»å‹é”™è¯¯é€šå¸¸å‘ç”Ÿåœ¨å€¼ä¸æ˜¯é¢„æœŸç±»å‹æ—¶ï¼Œæ¯”å¦‚å½“æœŸæœ›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆStringï¼‰è€Œå®é™…ä¸Šå¾—åˆ°äº†ä¸€ä¸ªæ•°å­—ï¼ˆNumberï¼‰ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œè¯´æ˜äº†å¦‚ä½•åœ¨ N-API æ‰©å±•ä¸­ä½¿ç”¨ <code>napi_throw_type_error</code>ï¼š</p><p>æƒ³è±¡æˆ‘ä»¬æ­£åœ¨åˆ›å»ºä¸€ä¸ª N-API æ¨¡å—ï¼Œè¯¥æ¨¡å—åŒ…å«ä¸€ä¸ªå‡½æ•°ï¼Œæ­¤å‡½æ•°è¦æ±‚ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ã€‚å¦‚æœè°ƒç”¨è€…ä¼ å…¥éå­—ç¬¦ä¸²å‚æ•°ï¼Œæˆ‘ä»¬å°±æŠ›å‡ºä¸€ä¸ªç±»å‹é”™è¯¯ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åŸç”Ÿå‡½æ•°ï¼ŒæœŸæœ›æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°</span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value argv[1];</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–JavaScriptä¼ é€’çš„å‚æ•°</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, argv, NULL, NULL);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        napi_throw_error(env, NULL, &quot;Failed to parse arguments&quot;);</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥å‚æ•°ç±»å‹æ˜¯å¦ä¸ºå­—ç¬¦ä¸²</span></span>
<span class="line"><span>    napi_valuetype valuetype;</span></span>
<span class="line"><span>    status = napi_typeof(env, argv[0], &amp;valuetype);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        napi_throw_error(env, NULL, &quot;Failed to identify argument type&quot;);</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¦‚æœä¸æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™æŠ›å‡ºç±»å‹é”™è¯¯</span></span>
<span class="line"><span>    if (valuetype != napi_string) {</span></span>
<span class="line"><span>        napi_throw_type_error(env, NULL, &quot;Argument must be a string.&quot;);</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ... è¿›è¡Œå…¶å®ƒæ“ä½œ ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›undefinedè¡¨ç¤ºå‡½æ•°æ‰§è¡ŒæˆåŠŸä½†æ²¡æœ‰è¿”å›å€¼</span></span>
<span class="line"><span>    napi_value undefined;</span></span>
<span class="line"><span>    napi_get_undefined(env, &amp;undefined);</span></span>
<span class="line"><span>    return undefined;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ¨¡å—åˆå§‹åŒ–å‡½æ•°</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, MyFunction, NULL, &amp;fn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;myFunction&quot;, fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>MyFunction</code> çš„ C å‡½æ•°ï¼Œå®ƒå°†è¢«æš´éœ²ç»™ JavaScript ç¯å¢ƒå¹¶ä¸”å¯ä»¥ä» Node.js ä»£ç ä¸­è°ƒç”¨ã€‚å¦‚æœè°ƒç”¨è€…æ²¡æœ‰ä¼ é€’ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œ<code>napi_typeof</code> å‡½æ•°ä¼šæ£€æµ‹åˆ°è¿™ä¸ªé—®é¢˜ï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨ <code>napi_throw_type_error</code> æ¥æŠ›å‡ºç±»å‹é”™è¯¯ã€‚</p><p>ç°åœ¨ï¼Œå‡è®¾ä½ å·²ç»ç¼–è¯‘äº†è¿™ä¸ª N-API æ¨¡å—å¹¶å‘½åä¸º <code>my_native_module</code>ã€‚åœ¨ Node.js ä»£ç ä¸­ï¼Œä½ å¯ä»¥è¿™æ ·è°ƒç”¨å®ƒï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeModule</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./my_native_module</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  nativeModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">myFunction</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">123</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // æ•…æ„ä¼ å…¥ä¸€ä¸ªéå­—ç¬¦ä¸²å‚æ•°</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;"> catch</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¿™é‡Œå°†æ•è·å¹¶æ‰“å°å‡ºç±»å‹é”™è¯¯</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ª JavaScript ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°è¯•ä½¿ç”¨ä¸€ä¸ªæ•°å­—å»è°ƒç”¨ <code>myFunction</code>ã€‚å› ä¸ºæˆ‘ä»¬çš„åŸç”Ÿå‡½æ•°æœŸæœ›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å®ƒä½¿ç”¨ <code>napi_throw_type_error</code> æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œç„¶ååœ¨ JavaScript å±‚é¢ï¼Œæˆ‘ä»¬é€šè¿‡ try-catch ç»“æ„æ•è·å¹¶å¤„ç†è¿™ä¸ªé”™è¯¯ã€‚</p><p>å¸Œæœ›è¿™ä¸ªè§£é‡Šå’Œä¾‹å­å¯ä»¥å¸®åŠ©ä½ ç†è§£ <code>napi_throw_type_error</code> åœ¨ Node.js ä¸­çš„åº”ç”¨ã€‚</p><h4 id="napi-throw-range-error" tabindex="-1"><a class="header-anchor" href="#napi-throw-range-error"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_throw_range_error" target="_blank" rel="noopener noreferrer">napi_throw_range_error</a></span></a></h4><p>Node.js ä¸­çš„ <code>napi_throw_range_error</code> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå±äº Node.js çš„ N-APIï¼ˆåŸç”Ÿ APIï¼‰ï¼Œå®ƒå…è®¸æœ¬åœ°æ¨¡å—ï¼ˆç”¨ C æˆ– C++ç¼–å†™çš„æ‰©å±•ï¼‰ä¸ JavaScript ä»£ç äº¤äº’ã€‚å½“ä½ éœ€è¦ä» C/C++ä»£ç ä¸­æŠ›å‡ºä¸€ä¸ª JavaScript çš„ <code>RangeError</code> å¼‚å¸¸æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå‡½æ•°ã€‚</p><p>åœ¨è¯¦ç»†è§£é‡Šä¹‹å‰ï¼Œé¦–å…ˆè¦äº†è§£å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š</p><ol><li><p><strong>N-API</strong>: è¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹äºå…·ä½“ç‰ˆæœ¬çš„ Node.js APIï¼Œæ„åœ¨å‡å°‘åŸç”Ÿæ’ä»¶ä½œè€…å›  Node.js å‡çº§å¯¼è‡´çš„ç»´æŠ¤æˆæœ¬ï¼Œå¹¶æä¾› ABIï¼ˆåº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ¥å£ï¼‰ç¨³å®šæ€§ã€‚</p></li><li><p><strong>RangeError</strong>: åœ¨ JavaScript ä¸­ï¼Œ<code>RangeError</code> æ˜¯ä¸€ç§é”™è¯¯å¯¹è±¡ï¼Œè¡¨ç¤ºå€¼ä¸åœ¨å…¶å…è®¸çš„èŒƒå›´æˆ–è€…é•¿åº¦ä¹‹å†…æ—¶å‘ç”Ÿçš„é”™è¯¯ã€‚</p></li><li><p><strong>C/C++ åŸç”Ÿæ¨¡å—</strong>: é€šå¸¸æŒ‡çš„æ˜¯ä½¿ç”¨ Node.js æä¾›çš„ N-API ç¼–å†™çš„ã€å¯ä»¥è¢« Node.js ç›´æ¥è°ƒç”¨çš„æ¨¡å—ï¼Œè¿™äº›æ¨¡å—æ˜¯ç”¨ C æˆ– C++è¯­è¨€ç¼–å†™çš„ã€‚</p></li></ol><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥æ›´åŠ è¯¦ç»†åœ°çœ‹çœ‹ <code>napi_throw_range_error</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_throw_range_error(napi_env env,</span></span>
<span class="line"><span>                                   const char* code,</span></span>
<span class="line"><span>                                   const char* msg);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>: è¿™ä¸ªå‚æ•°æ˜¯æŒ‡å‘ N-API ç¯å¢ƒçš„æŒ‡é’ˆï¼Œè¿™ä¸ªç¯å¢ƒåŒ…å«äº†æ‰€æœ‰ N-API è°ƒç”¨æ‰€éœ€çš„çŠ¶æ€ä¿¡æ¯ã€‚</li><li><code>code</code>: è¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä»£è¡¨é”™è¯¯çš„æ ‡è¯†ç ã€‚å®ƒå¯¹äºåŒºåˆ†ä¸åŒçš„é”™è¯¯ç±»å‹å¾ˆæœ‰ç”¨ã€‚</li><li><code>msg</code>: è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå«æœ‰æè¿°é”™è¯¯è¯¦æƒ…çš„æ–‡æœ¬ä¿¡æ¯ã€‚</li></ul><p>å½“ä½ è°ƒç”¨ <code>napi_throw_range_error</code> æ—¶ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ <code>RangeError</code> å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ä½ æä¾›çš„ <code>code</code> å’Œ <code>msg</code> æ¥åˆå§‹åŒ–è¿™ä¸ªé”™è¯¯å¯¹è±¡ã€‚ç„¶åï¼Œå®ƒä¼šæŠ›å‡ºè¿™ä¸ªé”™è¯¯ï¼Œå°±åƒåœ¨ JavaScript ä»£ç ä¸­ä½¿ç”¨ <code>throw new RangeError(msg);</code> ä¸€æ ·ã€‚</p><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œè¯¥æ¨¡å—æä¾›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è¦æ±‚è¾“å…¥ä¸€ä¸ªæ•°ç»„å’Œä¸€ä¸ªç´¢å¼•å€¼ï¼Œè¿”å›æ•°ç»„ä¸­å¯¹åº”ç´¢å¼•ä½ç½®çš„å…ƒç´ ã€‚å¦‚æœä¼ å…¥çš„ç´¢å¼•è¶…å‡ºäº†æ•°ç»„èŒƒå›´ï¼Œä½ æƒ³è¦æŠ›å‡ºä¸€ä¸ª <code>RangeError</code>ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åŸç”Ÿå‡½æ•°å®ç°</span></span>
<span class="line"><span>napi_value GetArrayElement(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 2;</span></span>
<span class="line"><span>    napi_value args[2];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–JavaScriptä¼ é€’çš„å‚æ•°</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦ä¼ å…¥äº†è¶³å¤Ÿçš„å‚æ•°ï¼Œä»¥åŠå‚æ•°çš„ç±»å‹æ˜¯å¦æ­£ç¡®</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å‡è®¾å·²ç»è·å–äº†arrayå’Œindexï¼Œå¹¶å¯¹å®ƒä»¬è¿›è¡Œäº†éªŒè¯</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    bool is_out_of_range = false;</span></span>
<span class="line"><span>    // ... åˆ¤æ–­ç´¢å¼•æ˜¯å¦è¶…å‡ºæ•°ç»„èŒƒå›´çš„ä»£ç  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (is_out_of_range) {</span></span>
<span class="line"><span>        // ç´¢å¼•è¶…å‡ºèŒƒå›´ï¼ŒæŠ›å‡ºRangeError</span></span>
<span class="line"><span>        napi_throw_range_error(env, &quot;ERR_INDEX_OUT_OF_RANGE&quot;, &quot;Index is out of range.&quot;);</span></span>
<span class="line"><span>        return NULL; // è¿”å›NULLè¡¨ç¤ºå‘ç”Ÿäº†å¼‚å¸¸</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å…¶ä»–å¤„ç†ä»£ç ï¼Œè¿”å›æ•°ç»„ä¸­çš„å…ƒç´  ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–æ¨¡å—ï¼Œæ³¨å†ŒåŸç”Ÿå‡½æ•°</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value getArrayElementFn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, GetArrayElement, NULL, &amp;getArrayElementFn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;getArrayElement&quot;, getArrayElementFn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå¦‚æœåˆ¤æ–­ç´¢å¼•è¶…å‡ºäº†æ•°ç»„èŒƒå›´ï¼Œæˆ‘ä»¬å°±è°ƒç”¨ <code>napi_throw_range_error</code> æŠ›å‡ºå¼‚å¸¸ã€‚è¿™ä¼šç«‹å³åœæ­¢å½“å‰çš„å‡½æ•°æ‰§è¡Œï¼Œå¹¶å°†æ§åˆ¶æƒè¿”å›ç»™ JavaScript è°ƒç”¨è€…ã€‚JavaScript è°ƒç”¨è€…å¯ä»¥é€šè¿‡ try-catch ç»“æ„æ•è·å¹¶å¤„ç†è¿™ä¸ªå¼‚å¸¸ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼Œä½¿ç”¨ä½ ç¼–å†™çš„åŸç”Ÿæ¨¡å—çš„å¼€å‘è€…å°±èƒ½å¾—åˆ°æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ï¼Œå¹¶ä¸”èƒ½å¤Ÿåƒå¤„ç†å¸¸è§„ JavaScript å¼‚å¸¸ä¸€æ ·å¤„ç†è¿™äº›é”™è¯¯ã€‚</p><h4 id="node-api-throw-syntax-error" tabindex="-1"><a class="header-anchor" href="#node-api-throw-syntax-error"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#node_api_throw_syntax_error" target="_blank" rel="noopener noreferrer">node_api_throw_syntax_error</a></span></a></h4><p>Node.js ä¸­çš„ <code>napi_throw_syntax_error</code> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå±äº N-API è¿™å¥— API çš„ä¸€éƒ¨åˆ†ã€‚N-API æä¾›äº†ä¸€ä¸ª C è¯­è¨€çš„æ¥å£ï¼Œå…è®¸åŸç”Ÿæ’ä»¶ï¼ˆç”¨ C æˆ– C++ç¼–å†™ï¼‰ä¸ Node.js ä»£ç äº¤äº’ã€‚è¿™äº›åŸç”Ÿæ’ä»¶é€šå¸¸ç”¨äºæ€§èƒ½å…³é”®å‹ä»»åŠ¡ï¼Œæ¯”å¦‚å›¾åƒå¤„ç†æˆ–è€…è®¿é—®ç³»ç»Ÿåº•å±‚èµ„æºã€‚</p><p><code>napi_throw_syntax_error</code> å‡½æ•°å…·ä½“æ˜¯ç”¨æ¥åˆ›å»ºå¹¶æŠ›å‡ºä¸€ä¸ª JavaScript è¯­æ³•é”™è¯¯ (<code>SyntaxError</code>)ã€‚åœ¨ JavaScript ä¸­ï¼Œå½“ä»£ç ä¸­æœ‰è¯­æ³•é”™è¯¯æ—¶ï¼Œæ¯”å¦‚æ‹¬å·ä¸åŒ¹é…ã€å…³é”®å­—ä½¿ç”¨ä¸å½“ç­‰æƒ…å†µï¼Œè§£é‡Šå™¨å°±ä¼šæŠ›å‡º <code>SyntaxError</code>ã€‚ç„¶è€Œï¼Œåœ¨ä¸€ä¸ªåŸç”Ÿæ¨¡å—ä¸­ï¼Œå¦‚æœä½ æƒ³è¦ä» C/C++ çº§åˆ«ä¸ŠæŠ›å‡ºä¸€ä¸ªç±»ä¼¼çš„é”™è¯¯åˆ° JavaScript ç¯å¢ƒï¼Œä½ å¯ä»¥é€šè¿‡ <code>napi_throw_syntax_error</code> æ¥å®ç°ã€‚</p><h3 id="å‡½æ•°ç­¾å" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°ç­¾å"><span>å‡½æ•°ç­¾åï¼š</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_throw_syntax_error(napi_env env, const char* code, const char* msg);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>env</code> å‚æ•°æ˜¯ä¸€ä¸ª <code>napi_env</code> ç±»å‹çš„å˜é‡ï¼Œå®ƒä»£è¡¨äº†å½“å‰çš„ Node.js æ‰§è¡Œç¯å¢ƒã€‚</li><li><code>code</code> å‚æ•°æ˜¯ä¸€ä¸ªä»¥ NULL ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºé”™è¯¯ä»£ç æˆ–æ ‡è¯†ç¬¦ã€‚</li><li><code>msg</code> å‚æ•°æ˜¯å¦ä¸€ä¸ªä»¥ NULL ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œå®ƒæè¿°äº†é”™è¯¯çš„è¯¦ç»†ä¿¡æ¯ã€‚</li></ul><h3 id="è¿”å›å€¼" tabindex="-1"><a class="header-anchor" href="#è¿”å›å€¼"><span>è¿”å›å€¼ï¼š</span></a></h3><p>è¯¥å‡½æ•°è¿”å›ä¸€ä¸ª <code>napi_status</code> ç±»å‹çš„å€¼ï¼Œè¡¨ç¤ºæ“ä½œæˆåŠŸä¸å¦ï¼š</p><ul><li>å¦‚æœå‡½æ•°æ‰§è¡ŒæˆåŠŸï¼Œå®ƒå°†è¿”å› <code>napi_ok</code>ã€‚</li><li>å¦‚æœå‘ç”Ÿäº†é”™è¯¯ï¼ˆä¾‹å¦‚å‚æ•°æ— æ•ˆï¼‰ï¼Œå®ƒå°†è¿”å›ç›¸åº”çš„é”™è¯¯ç ã€‚</li></ul><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-1" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-1"><span>å®é™…è¿ç”¨ç¤ºä¾‹ï¼š</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åŸç”Ÿæ¨¡å—ï¼Œè¦æ±‚ç”¨æˆ·ä¼ å…¥ä¸€æ®µ JSON å­—ç¬¦ä¸²æ¥å¤„ç†ã€‚å¦‚æœä¼ å…¥çš„å­—ç¬¦ä¸²æ ¼å¼é”™è¯¯ï¼Œä½ å¸Œæœ›æŠ›å‡ºä¸€ä¸ªè¯­æ³•é”™è¯¯æé†’ç”¨æˆ·ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€æ®µå¯èƒ½çš„ C/C++ ä»£ç ç‰‡æ®µï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>napi_throw_syntax_error</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value ParseJSON(napi_env env, napi_callback_info args) {</span></span>
<span class="line"><span>    // è·å–ä¼ é€’ç»™è¿™ä¸ªå‡½æ•°çš„å‚æ•°</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value argv[1];</span></span>
<span class="line"><span>    napi_get_cb_info(env, args, &amp;argc, argv, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥å‚æ•°ç±»å‹æ˜¯å¦ä¸ºå­—ç¬¦ä¸²</span></span>
<span class="line"><span>    napi_valuetype val_type;</span></span>
<span class="line"><span>    napi_typeof(env, argv[0], &amp;val_type);</span></span>
<span class="line"><span>    if (val_type != napi_string) {</span></span>
<span class="line"><span>        napi_throw_type_error(env, NULL, &quot;Argument must be a string.&quot;);</span></span>
<span class="line"><span>        return nullptr;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°è¯•å°†ä¼ å…¥çš„å­—ç¬¦ä¸²è§£æä¸º JSON</span></span>
<span class="line"><span>    // å‡è®¾ parseJSONString æ˜¯æŸä¸ªè‡ªå®šä¹‰çš„å‡½æ•°ï¼Œç”¨äºè§£æ JSON</span></span>
<span class="line"><span>    bool parse_successful = parseJSONString(env, argv[0]);</span></span>
<span class="line"><span>    if (!parse_successful) {</span></span>
<span class="line"><span>        // å¦‚æœè§£æå¤±è´¥ï¼Œåˆ™æŠ›å‡ºè¯­æ³•é”™è¯¯</span></span>
<span class="line"><span>        napi_throw_syntax_error(env, NULL, &quot;Invalid JSON string&quot;);</span></span>
<span class="line"><span>        return nullptr;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span>    // ä½™ä¸‹çš„å‡½æ•°é€»è¾‘</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åœ¨åŸç”Ÿæ¨¡å—åˆå§‹åŒ–æ—¶æ³¨å†Œä¸Šè¿°å‡½æ•°</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, ParseJSON, NULL, &amp;fn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;parseJSON&quot;, fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ<code>ParseJSON</code> å‡½æ•°é¦–å…ˆæ£€æŸ¥ä¼ å…¥çš„å‚æ•°æ˜¯å¦ä¸ºå­—ç¬¦ä¸²ï¼Œå¦‚æœä¸æ˜¯ï¼Œå®ƒä¼šæŠ›å‡ºä¸€ä¸ªç±»å‹é”™è¯¯ã€‚å¦‚æœå‚æ•°ç¡®å®æ˜¯å­—ç¬¦ä¸²ï¼Œä½†æ— æ³•è¢«æ­£ç¡®è§£æä¸º JSONï¼Œå®ƒåˆ™ä¼šä½¿ç”¨ <code>napi_throw_syntax_error</code> æŠ›å‡ºä¸€ä¸ªè¯­æ³•é”™è¯¯ã€‚è¿™æ ·ï¼Œå½“ JavaScript ä»£ç è°ƒç”¨è¿™ä¸ªåŸç”Ÿæ¨¡å—æ—¶ï¼Œå¦‚æœæä¾›çš„ JSON å­—ç¬¦ä¸²æ ¼å¼æœ‰è¯¯ï¼ŒJavaScript ä»£ç å°†èƒ½å¤Ÿæ•è·åˆ°ä¸€ä¸ª <code>SyntaxError</code> å¼‚å¸¸ã€‚</p><h4 id="napi-is-error" tabindex="-1"><a class="header-anchor" href="#napi-is-error"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_is_error" target="_blank" rel="noopener noreferrer">napi_is_error</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªåº•å±‚çš„ APIï¼Œå®ƒå…è®¸ä½ ç”¨ C æˆ– C++ç¼–å†™æ‰©å±•ã€‚è¿™äº›æ‰©å±•å¯ä»¥è¢« Node.js ç›´æ¥è°ƒç”¨ï¼Œç”¨äºæ‰§è¡Œé‚£äº› JavaScript ä¸æ“…é•¿æˆ–è€…é€Ÿåº¦è¾ƒæ…¢çš„ä»»åŠ¡ã€‚<code>napi_is_error</code>æ˜¯ N-API æä¾›çš„ä¸€ç§åŠŸèƒ½ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†äº†è§£ä¸€ä¸‹ã€‚</p><h3 id="napi-is-error-1" tabindex="-1"><a class="header-anchor" href="#napi-is-error-1"><span>napi_is_error</span></a></h3><p>ç®€å•æ¥è¯´ï¼Œ<code>napi_is_error</code>å‡½æ•°ç”¨æ¥æ£€æŸ¥ä¸€ä¸ª<code>napi_value</code>æ˜¯å¦è¡¨ç¤ºä¸€ä¸ª JavaScript çš„ Error å¯¹è±¡ã€‚åœ¨ JavaScript ä¸­ï¼Œé”™è¯¯é€šå¸¸ç”¨ Error å¯¹è±¡æ¥è¡¨ç¤ºã€‚è¿™ä¸ªåŠŸèƒ½å¯¹äºåŸç”Ÿæ¨¡å—çš„å¼€å‘è€…æ¥è¯´å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºå®ƒä»¬éœ€è¦å¤„ç†ä» JavaScript ä¼ é€’è¿‡æ¥çš„å€¼ï¼Œå¹¶ä¸”æœ‰æ—¶éœ€è¦åŒºåˆ†å“ªäº›å€¼æ˜¯æ­£å¸¸å€¼ï¼Œå“ªäº›æ˜¯é”™è¯¯ã€‚</p><h4 id="å‡½æ•°ç­¾å-1" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°ç­¾å-1"><span>å‡½æ•°ç­¾å</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_is_error(napi_env env, napi_value value, bool* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>env</code>ï¼šç¯å¢ƒå˜é‡ï¼Œä»£è¡¨äº† Node.js çš„è¿è¡Œç¯å¢ƒã€‚</li><li><code>value</code>ï¼šè¦æ£€æŸ¥çš„<code>napi_value</code>ã€‚</li><li><code>result</code>ï¼šè¾“å‡ºå‚æ•°ï¼Œå¦‚æœ<code>value</code>æ˜¯ä¸€ä¸ªé”™è¯¯å¯¹è±¡ï¼Œ<code>*result</code>ä¼šè®¾ç½®ä¸º<code>true</code>ï¼Œå¦åˆ™ä¸º<code>false</code>ã€‚</li></ul><h4 id="è¿”å›å€¼-1" tabindex="-1"><a class="header-anchor" href="#è¿”å›å€¼-1"><span>è¿”å›å€¼</span></a></h4><p>è¿”å›<code>napi_status</code>ï¼Œå®ƒå‘Šè¯‰ä½ æ“ä½œæ˜¯å¦æˆåŠŸã€‚å¦‚æœæ“ä½œå¤±è´¥ï¼Œé€šå¸¸æ„å‘³ç€æœ‰ä¸€äº›ä¸¥é‡çš„é—®é¢˜ï¼Œæ¯”å¦‚å‚æ•°æ— æ•ˆç­‰ã€‚</p><h3 id="å®é™…ä¾‹å­-3" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-3"><span>å®é™…ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js çš„åŸç”Ÿæ¨¡å—ï¼Œä½ å¯èƒ½æœ‰ä¸€ä¸ª C å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªä» JavaScript ä¼ æ¥çš„å‚æ•°ï¼Œä½ éœ€è¦ç¡®å®šè¿™ä¸ªå‚æ•°æ˜¯ä¸æ˜¯ä¸€ä¸ª Error å¯¹è±¡ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨<code>napi_is_error</code>çš„ C ä»£ç ç‰‡æ®µï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾å·²ç»è·å¾—äº†napi_env envå’Œnapi_value arg</span></span>
<span class="line"><span></span></span>
<span class="line"><span>bool is_error;</span></span>
<span class="line"><span>napi_status status = napi_is_error(env, arg, &amp;is_error);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯ï¼Œä¾‹å¦‚å¯ä»¥è¾“å‡ºé”™è¯¯æ—¥å¿—ã€æŠ›å‡ºå¼‚å¸¸ç­‰</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (is_error) {</span></span>
<span class="line"><span>    // å¦‚æœargæ˜¯ä¸€ä¸ªErrorå¯¹è±¡ï¼Œæ‰§è¡Œç›¸åº”çš„å¤„ç†</span></span>
<span class="line"><span>} else {</span></span>
<span class="line"><span>    // å¦‚æœargä¸æ˜¯Errorå¯¹è±¡ï¼Œæ‰§è¡Œå…¶ä»–é€»è¾‘</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½ é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªå¸ƒå°”å˜é‡<code>is_error</code>æ¥å­˜å‚¨ç»“æœã€‚ç„¶åï¼Œä½ è°ƒç”¨<code>napi_is_error</code>å¹¶ä¼ å…¥<code>env</code>ã€<code>arg</code>å’Œ<code>is_error</code>çš„åœ°å€ã€‚å‡½æ•°å°†æ£€æŸ¥<code>arg</code>æ˜¯å¦æ˜¯ä¸€ä¸ª Error å¯¹è±¡ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨<code>is_error</code>ä¸­ã€‚ä¹‹åï¼Œæ ¹æ®<code>is_error</code>çš„å€¼ï¼Œä½ å¯ä»¥å†³å®šæ¥ä¸‹æ¥çš„å¤„ç†æµç¨‹ã€‚</p><p>è¯·è®°ä½ï¼Œè¿™ä¸ª API å’Œå…¶å®ƒçš„ N-API å‡½æ•°ä¸€æ ·ï¼Œä¸»è¦ç”¨äºåˆ›å»º Node.js çš„åŸç”Ÿæ‰©å±•ã€‚å¦‚æœä½ æ˜¯ä¸€ä¸ªç¼–ç¨‹æ–°æ‰‹ï¼Œå¯èƒ½è¿˜ä¸éœ€è¦æ·±å…¥åˆ°è¿™ä¸ªå±‚é¢ã€‚ä½†äº†è§£ Node.js èƒ½ä¸ C/C++äº¤äº’ï¼Œä»¥åŠå¦‚ä½•æ£€æŸ¥é”™è¯¯æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚éšç€ä½ é€æ¸æ·±å…¥å­¦ä¹ ï¼Œå¯èƒ½ä¼šé‡åˆ°éœ€è¦ä½¿ç”¨è¿™äº›é«˜çº§ç‰¹æ€§çš„æƒ…å†µã€‚</p><h4 id="napi-create-error" tabindex="-1"><a class="header-anchor" href="#napi-create-error"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_error" target="_blank" rel="noopener noreferrer">napi_create_error</a></span></a></h4><p>å½“ç„¶ï¼Œæˆ‘ä¼šå°½é‡è¯¦ç»†å¹¶é€šä¿—åœ°è§£é‡Š <code>napi_create_error</code> è¿™ä¸ªå‡½æ•°åŠå…¶åœ¨ Node.js ä¸­çš„ä½œç”¨ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯-napi-create-error" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯-napi-create-error"><span>ä»€ä¹ˆæ˜¯ <code>napi_create_error</code>ï¼Ÿ</span></a></h3><p><code>napi_create_error</code> æ˜¯ Node.js çš„ N-APIï¼ˆNode.js APIï¼‰ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„ <code>Error</code> å¯¹è±¡ã€‚N-API æ˜¯ Node.js æä¾›ç»™åŸç”Ÿæ’ä»¶ä½œè€…çš„ç¨³å®šçš„ C æ¥å£ï¼Œè®©ä»–ä»¬å¯ä»¥ä¸å¿…æ‹…å¿ƒ Node.js ç‰ˆæœ¬çš„å˜åŒ–è€Œé¢‘ç¹æ›´æ–°ä»£ç ã€‚</p><p>JavaScript ä¸­çš„é”™è¯¯å¤„ç†æ˜¯é€šè¿‡ <code>throw</code> å…³é”®å­—å’Œ <code>try...catch</code> ç»“æ„æ¥å®ç°çš„ã€‚åœ¨åŸç”Ÿæ¨¡å—ä¸­ï¼Œä½ å¯èƒ½éœ€è¦åˆ›å»ºä¸€ä¸ª JavaScript é”™è¯¯å¯¹è±¡å¹¶å°†å…¶ä¼ é€’å› JavaScript ç¯å¢ƒä»¥ä¾¿èƒ½å¤Ÿåœ¨ JavaScript ä¸­å¤„ç†è¿™äº›é”™è¯¯ã€‚<code>napi_create_error</code> å°±æ˜¯ç”¨æ¥åœ¨åŸç”Ÿä»£ç ä¸­åˆ›å»º JavaScript é”™è¯¯å¯¹è±¡çš„æ–¹æ³•ã€‚</p><h3 id="napi-create-error-å‡½æ•°å‚æ•°å’Œè¿”å›å€¼" tabindex="-1"><a class="header-anchor" href="#napi-create-error-å‡½æ•°å‚æ•°å’Œè¿”å›å€¼"><span><code>napi_create_error</code> å‡½æ•°å‚æ•°å’Œè¿”å›å€¼</span></a></h3><p><code>napi_create_error</code> å‡½æ•°é€šå¸¸æ¥å—ä»¥ä¸‹å‡ ä¸ªå‚æ•°ï¼š</p><ol><li><code>napi_env env</code>: å½“å‰æ‰§è¡Œç¯å¢ƒçš„å¥æŸ„ï¼Œå®ƒæä¾›äº†ä»åŸç”Ÿä»£ç åˆ° Node.js è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ã€‚</li><li><code>napi_value code</code>: é”™è¯¯ç ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–æ•´æ•°ï¼Œè¡¨ç¤ºé”™è¯¯ç±»å‹ã€‚</li><li><code>napi_value msg</code>: å®é™…çš„é”™è¯¯ä¿¡æ¯ï¼Œé€šå¸¸æ˜¯æè¿°é”™è¯¯è¯¦æƒ…çš„å­—ç¬¦ä¸²ã€‚</li></ol><p>è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª <code>napi_status</code> ç±»å‹çš„æšä¸¾å€¼ï¼Œè¡¨ç¤ºè°ƒç”¨æ˜¯å¦æˆåŠŸã€‚å¦‚æœæˆåŠŸï¼Œä½ å°±å¯ä»¥åœ¨ä¹‹åçš„ä»£ç ä¸­ä½¿ç”¨åˆ›å»ºçš„é”™è¯¯å¯¹è±¡ã€‚</p><h3 id="å¦‚ä½•ä½¿ç”¨-napi-create-error" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ä½¿ç”¨-napi-create-error"><span>å¦‚ä½•ä½¿ç”¨ <code>napi_create_error</code></span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åŸç”Ÿæ’ä»¶ï¼Œå¹¶ä¸”éœ€è¦åœ¨æ£€æµ‹åˆ°æŸç§é”™è¯¯æƒ…å†µæ—¶ï¼ŒæŠ›å‡ºä¸€ä¸ªé”™è¯¯ç»™ JavaScript å¤„ç†ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåŸç”Ÿå‡½æ•°ï¼Œè¯¥å‡½æ•°éœ€è¦åœ¨å‘ç”Ÿé”™è¯¯æ—¶æŠ›å‡ºå¼‚å¸¸</span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value error_code, error_message, error_object;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿™é‡Œä½ çš„é€»è¾‘ä»£ç å¯èƒ½ä¼šå‘ç°äº†ä¸€ä¸ªé”™è¯¯ï¼Œå¹¶éœ€è¦æŠ¥å‘Šå®ƒ</span></span>
<span class="line"><span>    bool has_error = true; // å‡è®¾æˆ‘ä»¬æ£€æµ‹åˆ°äº†ä¸€ä¸ªé”™è¯¯</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (has_error) {</span></span>
<span class="line"><span>        // åˆ›å»ºé”™è¯¯ç </span></span>
<span class="line"><span>        status = napi_create_string_utf8(env, &quot;MY_ERROR_CODE&quot;, NAPI_AUTO_LENGTH, &amp;error_code);</span></span>
<span class="line"><span>        if (status != napi_ok) return NULL;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // åˆ›å»ºé”™è¯¯ä¿¡æ¯</span></span>
<span class="line"><span>        status = napi_create_string_utf8(env, &quot;An unexpected error occurred!&quot;, NAPI_AUTO_LENGTH, &amp;error_message);</span></span>
<span class="line"><span>        if (status != napi_ok) return NULL;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // åˆ›å»ºé”™è¯¯å¯¹è±¡</span></span>
<span class="line"><span>        status = napi_create_error(env, error_code, error_message, &amp;error_object);</span></span>
<span class="line"><span>        if (status != napi_ok) return NULL;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // æŠ›å‡ºé”™è¯¯</span></span>
<span class="line"><span>        napi_throw(env, error_object);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å…¶ä»–æ­£å¸¸é€»è¾‘...</span></span>
<span class="line"><span>    return some_successful_result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œæ³¨å†Œ MyFunction</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, MyFunction, NULL, &amp;fn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;myFunction&quot;, fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœ <code>MyFunction</code> æ£€æµ‹åˆ°é”™è¯¯ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªå¸¦æœ‰é”™è¯¯ç  <code>&quot;MY_ERROR_CODE&quot;</code> å’Œé”™è¯¯ä¿¡æ¯ <code>&quot;An unexpected error occurred!&quot;</code> çš„é”™è¯¯å¯¹è±¡ã€‚ç„¶åï¼Œå®ƒä½¿ç”¨ <code>napi_throw</code> å‡½æ•°æŠ›å‡ºè¿™ä¸ªé”™è¯¯å¯¹è±¡ã€‚</p><h3 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“"><span>æ€»ç»“</span></a></h3><p><code>napi_create_error</code> æ˜¯ Node.js N-API ä¸­ç”¨æ¥åœ¨åŸç”Ÿæ¨¡å—ä»£ç ä¸­åˆ›å»º JavaScript é”™è¯¯å¯¹è±¡çš„å‡½æ•°ã€‚é€šè¿‡å®ƒï¼Œä½ å¯ä»¥åœ¨åŸç”Ÿä»£ç ä¸­ç”Ÿæˆé”™è¯¯ï¼Œå¹¶é€šè¿‡ JavaScript çš„é”™è¯¯å¤„ç†æœºåˆ¶æ¥æ•è·å’Œå¤„ç†è¿™äº›é”™è¯¯ã€‚å®ƒå¯¹äºæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œä¿æŒ JavaScript å’ŒåŸç”Ÿä»£ç ä¹‹é—´çš„å…¼å®¹æ€§éå¸¸é‡è¦ã€‚</p><p>è®°ä½ï¼Œåœ¨å®ç°åŸç”Ÿæ¨¡å—æ—¶ï¼Œæ­£ç¡®çš„é”™è¯¯å¤„ç†èƒ½å¤Ÿå¤§å¤§æé«˜æ¨¡å—çš„å¥å£®æ€§å’Œå¯ç”¨æ€§ã€‚</p><h4 id="napi-create-type-error" tabindex="-1"><a class="header-anchor" href="#napi-create-type-error"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_type_error" target="_blank" rel="noopener noreferrer">napi_create_type_error</a></span></a></h4><p>Node.js ä¸­çš„ N-API (Node Addon API) æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶ï¼ˆnative addonsï¼‰çš„ API å±‚ã€‚æœ¬åœ°æ’ä»¶æ˜¯æŒ‡ç›´æ¥ä¸ Node.js è¿è¡Œæ—¶é›†æˆçš„ï¼Œä½¿ç”¨ C æˆ– C++ ç¼–å†™çš„æ¨¡å—ã€‚è¿™äº›æ’ä»¶å¯ä»¥æä¾›æ€§èƒ½ä¸Šçš„ä¼˜åŠ¿æˆ–è€…ä½¿å¾— Node.js èƒ½å¤Ÿè®¿é—®ç³»ç»Ÿçº§èµ„æºå’Œåº“ã€‚</p><p><code>napi_create_type_error</code> å‡½æ•°æ˜¯ N-API ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå…è®¸ä½ åˆ›å»ºä¸€ä¸ª JavaScript çš„ç±»å‹é”™è¯¯ (TypeError) å¯¹è±¡ã€‚åœ¨ JavaScript ä¸­ï¼Œå½“ä¸€ä¸ªå€¼ä¸æ˜¯é¢„æœŸçš„æ•°æ®ç±»å‹æ—¶ï¼Œé€šå¸¸ä¼šæŠ›å‡ºä¸€ä¸ª TypeErrorã€‚ä¾‹å¦‚ï¼Œå¦‚æœå‡½æ•°æœŸæœ›ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œä½†æ˜¯æ”¶åˆ°äº†ä¸€ä¸ªæ•°å­—ï¼Œé‚£ä¹ˆå°±å¯èƒ½æŠ›å‡ºä¸€ä¸ª TypeErrorã€‚</p><h3 id="ä½¿ç”¨-napi-create-type-error" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-napi-create-type-error"><span>ä½¿ç”¨ <code>napi_create_type_error</code></span></a></h3><p>åœ¨ Node.js çš„æœ¬åœ°æ’ä»¶ä¸­ï¼Œä½ æœ‰æ—¶éœ€è¦å‘ JavaScript ä»£ç æŠ¥å‘ŠæŸä¸ªå€¼çš„ç±»å‹ä¸æ­£ç¡®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>napi_create_type_error</code> æ¥åˆ›å»ºä¸€ä¸ªç›¸åº”çš„é”™è¯¯å¯¹è±¡ï¼Œå¹¶å°†å®ƒä¼ é€’å› JavaScript ç¯å¢ƒã€‚</p><p>ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ <code>napi_create_type_error</code> çš„æ­¥éª¤ï¼š</p><ol><li>ç¡®è®¤ä½ æ­£åœ¨ç¼–å†™çš„ä»£ç æ˜¯ä¸€ä¸ªæœ¬åœ°æ’ä»¶ï¼Œå³ä½¿ç”¨ C æˆ– C++ å¹¶å¸Œæœ›ä¸ Node.js äº¤äº’ã€‚</li><li>åŒ…å«å¿…è¦çš„ N-API å¤´æ–‡ä»¶ã€‚</li><li>å®ç°ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šæ£€æŸ¥è¾“å…¥å‚æ•°çš„ç±»å‹ï¼Œå¹¶åœ¨ç±»å‹ä¸ç¬¦åˆæœŸæœ›æ—¶åˆ›å»ºç±»å‹é”™è¯¯ã€‚</li></ol><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­æ¥æ¼”ç¤ºå…¶ç”¨æ³•ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæœŸæœ›ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_value this_arg;</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–å‡½æ•°å‚æ•°</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, args, &amp;this_arg, NULL);</span></span>
<span class="line"><span>    if (status != napi_ok) return NULL;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥å‚æ•°ç±»å‹</span></span>
<span class="line"><span>    napi_valuetype valuetype;</span></span>
<span class="line"><span>    status = napi_typeof(env, args[0], &amp;valuetype);</span></span>
<span class="line"><span>    if (status != napi_ok) return NULL;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¦‚æœä¸æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™åˆ›å»º TypeError</span></span>
<span class="line"><span>    if (valuetype != napi_string) {</span></span>
<span class="line"><span>        napi_value result;</span></span>
<span class="line"><span>        napi_value error_message;</span></span>
<span class="line"><span>        const char* message = &quot;Wrong argument type. Expected a string.&quot;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // åˆ›å»ºä¸€ä¸ªJSå­—ç¬¦ä¸²ä½œä¸ºé”™è¯¯ä¿¡æ¯</span></span>
<span class="line"><span>        status = napi_create_string_utf8(env, message, NAPI_AUTO_LENGTH, &amp;error_message);</span></span>
<span class="line"><span>        if (status != napi_ok) return NULL;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // åˆ›å»º TypeError é”™è¯¯å¯¹è±¡</span></span>
<span class="line"><span>        status = napi_create_type_error(env, NULL, error_message, &amp;result);</span></span>
<span class="line"><span>        if (status != napi_ok) return NULL;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // æŠ›å‡ºé”™è¯¯</span></span>
<span class="line"><span>        napi_throw(env, result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¦‚æœå‚æ•°ç±»å‹æ­£ç¡®ï¼Œç»§ç»­æ‰§è¡Œå‡½æ•°...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–ä»£ç ç•¥è¿‡...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>MyFunction</code> æ˜¯ä¸€ä¸ªæœ¬åœ°æ’ä»¶ä¸­å®šä¹‰çš„å‡½æ•°ï¼Œå®ƒæœŸæœ›æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°ã€‚å¦‚æœä¼ å…¥çš„å‚æ•°ä¸æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä½¿ç”¨ <code>napi_create_type_error</code> æ¥åˆ›å»ºä¸€ä¸ª TypeError å¯¹è±¡ï¼Œå¹¶é€šè¿‡ <code>napi_throw</code> æ¥æŠ›å‡ºè¿™ä¸ªé”™è¯¯ã€‚</p><h3 id="æ€»ç»“-1" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-1"><span>æ€»ç»“</span></a></h3><p><code>napi_create_type_error</code> æ˜¯ Node.js N-API çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºåœ¨æœ¬åœ°æ’ä»¶ä¸­åˆ›å»ºå¹¶æŠ›å‡º JavaScript çš„ TypeErrorã€‚è¿™å¯¹äºç¡®ä¿ JavaScript ä»æœ¬åœ°æ’ä»¶æ¥æ”¶åˆ°æ­£ç¡®ç±»å‹çš„æ•°æ®éå¸¸æœ‰ç”¨ï¼Œå¹¶ä¸”æœ‰åŠ©äºå¼€å‘è€…è¯Šæ–­å’Œå¤„ç†é”™è¯¯ã€‚</p><h4 id="napi-create-range-error" tabindex="-1"><a class="header-anchor" href="#napi-create-range-error"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_range_error" target="_blank" rel="noopener noreferrer">napi_create_range_error</a></span></a></h4><p>Node.js ä¸­çš„<code>napi_create_range_error</code>æ˜¯ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒå±äº N-APIï¼ˆåŸç”Ÿ APIï¼‰ï¼Œè¿™æ˜¯ä¸€å¥— C è¯­è¨€ç¼–å†™çš„æ¥å£ï¼Œå…è®¸ä½ åˆ›å»ºå’Œæ“ä½œ JavaScript å€¼ï¼Œå¹¶åœ¨åŸç”Ÿæ’ä»¶ï¼ˆç”¨ C/C++ç¼–å†™çš„æ¨¡å—ï¼‰ä¸­ä¸ JavaScript ä»£ç äº¤äº’ã€‚ä½¿ç”¨ N-API ç¼–å†™çš„åŸç”Ÿæ¨¡å—å¯ä»¥åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸Šè¿è¡Œè€Œæ— éœ€é‡æ–°ç¼–è¯‘ï¼Œè¿™æœ‰åŠ©äºæé«˜æ¨¡å—çš„å…¼å®¹æ€§å’Œç¨³å®šæ€§ã€‚</p><p>ç°åœ¨ï¼Œæ¥è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯<code>napi_create_range_error</code>ï¼š</p><p>åœ¨ JavaScript ä¸­ï¼Œ<code>RangeError</code>æ˜¯ä¸€ç§é”™è¯¯å¯¹è±¡ï¼Œè¡¨ç¤ºå½“ä¸€ä¸ªå€¼ä¸åœ¨å…¶é¢„æœŸèŒƒå›´å†…æ—¶æŠ›å‡ºçš„é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ å°è¯•ç”¨ä¸€ä¸ªè´Ÿæ•°å»è®¿é—®æ•°ç»„çš„å…ƒç´ ï¼Œæˆ–è€…ä½¿ç”¨<code>Number</code>å¯¹è±¡çš„æ–¹æ³•ä¼ é€’äº†ä¸€ä¸ªæ— æ•ˆçš„æ•°å­—èŒƒå›´ï¼Œå°±ä¼šæŠ›å‡º<code>RangeError</code>ã€‚</p><p>ä½¿ç”¨<code>napi_create_range_error</code>ï¼Œä½ å¯ä»¥ä» C/C++ä»£ç ä¸­åˆ›å»ºä¸€ä¸ªä¸ JavaScript <code>RangeError</code>ç›¸å¯¹åº”çš„ N-API é”™è¯¯å¯¹è±¡ã€‚è¿™åœ¨ä½ éœ€è¦å°†ä¸€ä¸ªç”±åŸç”Ÿä»£ç æ£€æµ‹åˆ°çš„èŒƒå›´é”™è¯¯ä¼ è¾¾ç»™ JavaScript ç¯å¢ƒæ—¶éå¸¸æœ‰ç”¨ã€‚</p><p>è¿™ä¸ªå‡½æ•°çš„ç­¾åå¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_create_range_error(napi_env env,</span></span>
<span class="line"><span>                                    napi_value code,</span></span>
<span class="line"><span>                                    napi_value msg,</span></span>
<span class="line"><span>                                    napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>: è¿™æ˜¯ä¸€ä¸ªä»£è¡¨ N-API ç¯å¢ƒçš„å¥æŸ„ï¼Œä½ å¯ä»¥é€šè¿‡å®ƒæ¥è°ƒç”¨ N-API çš„å…¶ä»–å‡½æ•°ã€‚</li><li><code>code</code>: ä¸€ä¸ª<code>napi_value</code>ï¼ŒåŒ…å«äº†ä¸€ä¸ªé”™è¯¯ç ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸² IDã€‚</li><li><code>msg</code>: ä¸€ä¸ª<code>napi_value</code>ï¼ŒåŒ…å«äº†ä¸€ä¸ªæè¿°é”™è¯¯çš„æ¶ˆæ¯ã€‚</li><li><code>result</code>: è¿™æ˜¯ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼ŒæŒ‡å‘åˆ›å»ºå¥½çš„<code>RangeError</code>å¯¹è±¡ã€‚</li></ul><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œéœ€è¦æ£€æŸ¥ä¼ å…¥çš„å‚æ•°æ˜¯å¦åœ¨æœ‰æ•ˆçš„ç´¢å¼•èŒƒå›´å†…ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_status CheckIndexInRange(napi_env env, int index, int array_size) {</span></span>
<span class="line"><span>    if (index `&lt;` 0 || index &gt;= array_size) {</span></span>
<span class="line"><span>        // åˆ›å»ºä¸€ä¸ªé”™è¯¯æ¶ˆæ¯</span></span>
<span class="line"><span>        napi_value msg;</span></span>
<span class="line"><span>        napi_create_string_utf8(env, &quot;Index is out of range&quot;, NAPI_AUTO_LENGTH, &amp;msg);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // åˆ›å»ºä¸€ä¸ª RangeError å¯¹è±¡</span></span>
<span class="line"><span>        napi_value range_error;</span></span>
<span class="line"><span>        napi_create_range_error(env, NULL, msg, &amp;range_error);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // å°†è¿™ä¸ªé”™è¯¯æŠ›ç»™ JavaScript ç¯å¢ƒ</span></span>
<span class="line"><span>        napi_throw(env, range_error);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        return napi_throw_error; // è¿”å›ä¸€ä¸ªè¡¨ç¤ºå‘ç”Ÿäº†é”™è¯¯çš„çŠ¶æ€ç </span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    return napi_ok; // æ²¡æœ‰é”™è¯¯å‘ç”Ÿ</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå½“<code>CheckIndexInRange</code>å‡½æ•°æ£€æµ‹åˆ°<code>index</code>ä¸åœ¨åˆæ³•èŒƒå›´å†…æ—¶ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ª<code>RangeError</code>å¹¶ä½¿ç”¨<code>napi_throw</code>å°†è¿™ä¸ªé”™è¯¯æŠ›å‡ºåˆ° JavaScript ç¯å¢ƒä¸­ã€‚è¿™æ ·ï¼Œå½“ JavaScript ä»£ç è°ƒç”¨è¿™ä¸ªåŸç”Ÿæ¨¡å—çš„ç›¸å…³å‡½æ•°å¹¶å‘ç”ŸèŒƒå›´é”™è¯¯æ—¶ï¼ŒJavaScript ä»£ç å°±èƒ½æ•è·åˆ°è¿™ä¸ªé”™è¯¯å¹¶ç›¸åº”åœ°å¤„ç†ã€‚</p><h4 id="node-api-create-syntax-error" tabindex="-1"><a class="header-anchor" href="#node-api-create-syntax-error"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#node_api_create_syntax_error" target="_blank" rel="noopener noreferrer">node_api_create_syntax_error</a></span></a></h4><p>å¥½çš„ï¼ŒNode.js ä¸­çš„ <code>node_api_create_syntax_error</code> æ˜¯ä¸€ä¸ªå…³äº N-API çš„åŠŸèƒ½ç‚¹ã€‚N-API æ˜¯ Node.js æä¾›çš„ä¸€å¥—ç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIï¼Œè¿™äº› API æ˜¯ç‹¬ç«‹äº JavaScript è¿è¡Œæ—¶çš„ï¼Œå¹¶ä¸”åœ¨ Node.js çš„ä¸åŒç‰ˆæœ¬ä¸­ä¿æŒå‘åå…¼å®¹ã€‚</p><p><code>node_api_create_syntax_error</code> å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„ <code>SyntaxError</code> å¯¹è±¡ã€‚<code>SyntaxError</code> æ˜¯ JavaScript ä¸­çš„ä¸€ä¸ªé”™è¯¯ç±»å‹ï¼Œå®ƒè¡¨ç¤ºåœ¨è§£æä»£ç æ—¶å‘ç”Ÿçš„è¯­æ³•é”™è¯¯ã€‚å½“ JavaScript å¼•æ“è¯»å–å’Œè§£é‡Šä»£ç è€Œé‡åˆ°ä¸èƒ½ç†è§£çš„ç»“æ„æ—¶ï¼Œå°±ä¼šæŠ›å‡º <code>SyntaxError</code>ã€‚</p><p>è¯¥å‡½æ•°çš„å…·ä½“ä½œç”¨æ˜¯åœ¨åŸç”Ÿä»£ç ï¼ˆæ¯”å¦‚ C æˆ– C++æ¨¡å—ï¼‰ä¸­åˆ›å»ºä¸€ä¸ªä¸ JavaScript <code>SyntaxError</code> ç›¸ä¼¼çš„é”™è¯¯å¯¹è±¡ï¼Œç„¶åå¯ä»¥å°†è¿™ä¸ªé”™è¯¯ä¼ å›åˆ° JavaScript ç¯å¢ƒä¸­ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†è®©åŸç”Ÿæ¨¡å—èƒ½å¤Ÿä»¥ä¸€ç§å¯¹ JavaScript å¼€å‘è€…æ¥è¯´ç†Ÿæ‚‰çš„æ–¹å¼æŠ¥å‘Šé”™è¯¯ã€‚</p><p>ä½¿ç”¨ <code>node_api_create_syntax_error</code> æ—¶ï¼Œé€šå¸¸ä¼šæŒ‡å®šä¸‰ä¸ªå‚æ•°ï¼š</p><ol><li><code>env</code> - å½“å‰çš„ N-API ç¯å¢ƒå¥æŸ„ï¼Œå®ƒæä¾›äº†å¤§é‡å®ç”¨çš„ APIã€‚</li><li><code>code</code> - é”™è¯¯ç ï¼Œæ˜¯ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„é”™è¯¯ã€‚</li><li><code>msg</code> - å®é™…çš„é”™è¯¯ä¿¡æ¯ï¼Œæè¿°äº†å‘ç”Ÿäº†ä»€ä¹ˆé”™è¯¯ã€‚</li></ol><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªç®€å•çš„ä¾‹å­:</p><h3 id="ä¾‹å­-1-åˆ›å»ºä¸€ä¸ªç®€å•çš„-syntaxerror" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-åˆ›å»ºä¸€ä¸ªç®€å•çš„-syntaxerror"><span>ä¾‹å­ 1: åˆ›å»ºä¸€ä¸ªç®€å•çš„ <code>SyntaxError</code></span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œéœ€è¦æ£€æµ‹ä¼ å…¥çš„å­—ç¬¦ä¸²æ˜¯å¦ç¬¦åˆä½ é¢„æœŸçš„æ ¼å¼ã€‚å¦‚æœå­—ç¬¦ä¸²æ ¼å¼ä¸æ­£ç¡®ï¼Œä½ æƒ³è¦æŠ›å‡ºä¸€ä¸ª <code>SyntaxError</code>ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CreateSyntaxErrorExample(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  napi_value syntax_error;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ª SyntaxError å¯¹è±¡</span></span>
<span class="line"><span>  const char* error_message = &quot;Unexpected token in JSON at position 10&quot;;</span></span>
<span class="line"><span>  napi_status status = napi_create_syntax_error(env, NULL, error_message, &amp;syntax_error);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ£€æŸ¥æ“ä½œæ˜¯å¦æˆåŠŸ</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å°†åˆ›å»ºçš„é”™è¯¯è¿”å›ç»™ JavaScript</span></span>
<span class="line"><span>  return syntax_error;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ›´å¤šçš„æ¨¡å—åˆå§‹åŒ–ä»£ç ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç å®šä¹‰äº†ä¸€ä¸ªå‡½æ•° <code>CreateSyntaxErrorExample</code>ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªåŒ…å«è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯çš„ <code>SyntaxError</code> å¯¹è±¡ï¼Œå¹¶å°†å…¶è¿”å›ç»™ JavaScriptã€‚è‹¥åˆ›å»ºå¤±è´¥ï¼Œåº”å½“å¤„ç†ç›¸åº”çš„é”™è¯¯çŠ¶æ€ã€‚</p><h3 id="ä¾‹å­-2-åœ¨æ£€æµ‹åˆ°æ— æ•ˆè¾“å…¥æ—¶ä½¿ç”¨-syntaxerror" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-åœ¨æ£€æµ‹åˆ°æ— æ•ˆè¾“å…¥æ—¶ä½¿ç”¨-syntaxerror"><span>ä¾‹å­ 2: åœ¨æ£€æµ‹åˆ°æ— æ•ˆè¾“å…¥æ—¶ä½¿ç”¨ <code>SyntaxError</code></span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value ParseJSON(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  size_t argc = 1;</span></span>
<span class="line"><span>  napi_value args[1];</span></span>
<span class="line"><span>  napi_status status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ä»¥ä¸‹ç•¥è¿‡å‚æ•°æ£€éªŒå’Œè½¬æ¢çš„ä»£ç </span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å‡è®¾æˆ‘ä»¬å·²ç»è·å–äº†è¦è§£æçš„å­—ç¬¦ä¸²ï¼šjson_str</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  bool is_valid_json = false;</span></span>
<span class="line"><span>  // å¯¹ json_str è¿›è¡Œå¤„ç†å¹¶è®¾ç½® is_valid_json æ ‡å¿—</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (!is_valid_json) {</span></span>
<span class="line"><span>    // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œåˆ™åˆ›å»º SyntaxError å¹¶å°†å…¶æŠ›å‡º</span></span>
<span class="line"><span>    napi_value syntax_error;</span></span>
<span class="line"><span>    status = napi_create_syntax_error(env, NULL, &quot;Invalid JSON string&quot;, &amp;syntax_error);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (status == napi_ok) {</span></span>
<span class="line"><span>      napi_throw(env, syntax_error); // æŠ›å‡ºé”™è¯¯</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è§£ææˆåŠŸçš„é€»è¾‘...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ›´å¤šçš„æ¨¡å—åˆå§‹åŒ–ä»£ç ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>ParseJSON</code> å‡½æ•°è¯•å›¾è§£æä¸€ä¸ª JSON å­—ç¬¦ä¸²ã€‚å¦‚æœæ£€æµ‹åˆ°è¯¥å­—ç¬¦ä¸²ä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œå®ƒå°†åˆ›å»ºä¸€ä¸ª <code>SyntaxError</code> å¯¹è±¡å¹¶é€šè¿‡è°ƒç”¨ <code>napi_throw</code> å°†å…¶æŠ›ç»™è°ƒç”¨æ–¹ã€‚è¿™æ ·ï¼ŒJavaScript è°ƒç”¨ä¾§å°±å¯ä»¥æ•è·å¹¶å¤„ç†è¿™ä¸ªé”™è¯¯äº†ã€‚</p><h4 id="napi-get-and-clear-last-exception" tabindex="-1"><a class="header-anchor" href="#napi-get-and-clear-last-exception"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_and_clear_last_exception" target="_blank" rel="noopener noreferrer">napi_get_and_clear_last_exception</a></span></a></h4><p><code>napi_get_and_clear_last_exception</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå±äº N-API çš„ä¸€éƒ¨åˆ†ã€‚N-API æ˜¯ä¸€ä¸ªç¨³å®šçš„ C APIï¼Œå…è®¸ä½ æ„å»ºåŸç”Ÿæ’ä»¶ï¼Œå³ç”¨ Cã€C++ç­‰è¯­è¨€ç¼–å†™çš„æ¨¡å—ï¼Œè¿™äº›æ¨¡å—å¯ä»¥ç›´æ¥è¢« Node.js ä»£ç è°ƒç”¨ã€‚</p><p>å½“ä½ åœ¨åˆ›å»º Node.js çš„åŸç”Ÿæ’ä»¶æ—¶ï¼Œå¯èƒ½ä¼šä¸ JavaScript ä»£ç è¿›è¡Œäº¤äº’ï¼Œå¹¶ä¸”æœ‰æ—¶å€™è¿™äº›äº¤äº’å¯èƒ½ä¼šå¯¼è‡´å¼‚å¸¸ï¼ˆé”™è¯¯ï¼‰å‘ç”Ÿã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœ JavaScript ä»£ç æŠ›å‡ºäº†ä¸€ä¸ªå¼‚å¸¸ï¼Œè€Œä½ æ²¡æœ‰æ°å½“åœ°å¤„ç†å®ƒï¼Œé‚£ä¹ˆè¿™ä¸ªå¼‚å¸¸å°±ä¼šæ²¿ç€è°ƒç”¨æ ˆå‘ä¸Šä¼ æ’­ï¼Œç›´åˆ°å®ƒåˆ°è¾¾æœ€é¡¶å±‚å¹¶è¢« Node.js ç¯å¢ƒæ•è·ã€‚</p><p><code>napi_get_and_clear_last_exception</code> è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ï¼šå½“ä½ çš„åŸç”Ÿä»£ç å¼•èµ·äº† JavaScript å¼‚å¸¸æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨æ­¤å‡½æ•°æ¥æ£€ç´¢è¿™ä¸ªå¼‚å¸¸å¯¹è±¡ï¼Œå¹¶ä¸”åŒæ—¶æ¸…é™¤æ‰è¿™ä¸ªå¼‚å¸¸ï¼Œé˜²æ­¢å®ƒç»§ç»­å‘ä¸Šä¼ æ’­ã€‚</p><p>ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ <code>napi_get_and_clear_last_exception</code> çš„ä¸€ä¸ªç®€å•ä¾‹å­ï¼š</p><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåŸç”Ÿå‡½æ•°ï¼Œè¯¥å‡½æ•°è¯•å›¾æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç ï¼Œä½†å¯èƒ½ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾çš„åŸç”Ÿå‡½æ•°ï¼Œå…¶ä¸­å¯èƒ½ä¼šäº§ç”ŸJavaScriptå¼‚å¸¸</span></span>
<span class="line"><span>napi_value MyNativeFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°è¯•åšä¸€äº›å·¥ä½œ...</span></span>
<span class="line"><span>    // è¿™é‡Œçš„æŸäº›æ“ä½œå¯èƒ½ä¼šæŠ›å‡ºJavaScriptå¼‚å¸¸</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸å‘ç”Ÿ</span></span>
<span class="line"><span>    napi_value exception;</span></span>
<span class="line"><span>    napi_status status = napi_get_and_clear_last_exception(env, &amp;exception);</span></span>
<span class="line"><span>    if (status == napi_ok) {</span></span>
<span class="line"><span>        // å¼‚å¸¸å·²ç»è¢«æ¸…ç†ï¼Œç°åœ¨ä½ å¯ä»¥å†³å®šå¦‚ä½•å¤„ç†å®ƒ</span></span>
<span class="line"><span>        // ä¾‹å¦‚ï¼Œä½ å¯ä»¥æ‰“å°å‡ºé”™è¯¯ä¿¡æ¯æˆ–å°†å…¶ä½œä¸ºé”™è¯¯è¿”å›å€¼è¿”å›ç»™è°ƒç”¨è€…</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å…¶ä»–å·¥ä½œ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>MyNativeFunction</code> å‡½æ•°åœ¨æ‰§è¡ŒæœŸé—´å¯èƒ½ä¼šäº§ç”Ÿä¸€ä¸ªå¼‚å¸¸ã€‚é€šè¿‡è°ƒç”¨ <code>napi_get_and_clear_last_exception</code>ï¼Œæˆ‘ä»¬æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å¼‚å¸¸å‘ç”Ÿï¼Œå¹¶æ¸…é™¤å®ƒã€‚å¦‚æœç¡®å®å­˜åœ¨å¼‚å¸¸ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å–å¼‚å¸¸å¯¹è±¡ï¼Œå¹¶å†³å®šå¦‚ä½•å¤„ç†å®ƒï¼Œæ¯”å¦‚è®°å½•æ—¥å¿—ï¼Œæˆ–è€…å°†é”™è¯¯ä¿¡æ¯è¿”å›ç»™åŸç”Ÿå‡½æ•°çš„è°ƒç”¨è€…ã€‚</p><p>æ­¤å¤–ï¼ŒN-API æä¾›äº†ä¸€å¥—å®Œæ•´çš„å¼‚å¸¸å¤„ç† APIï¼ŒåŒ…æ‹¬ä½†ä¸é™äºè·å–å¼‚å¸¸ä¿¡æ¯ã€åˆ›å»ºæ–°çš„é”™è¯¯å¯¹è±¡ç­‰ï¼Œè®©åŸç”Ÿæ¨¡å—å¼€å‘è€…èƒ½å¤Ÿæ›´å¥½åœ°æ§åˆ¶é”™è¯¯å¤„ç†æµç¨‹ã€‚</p><p>è®°ä½ï¼ŒN-API æ˜¯ä¸“é—¨è®¾è®¡ç”¨æ¥æ„å»ºåŸç”Ÿæ’ä»¶çš„ï¼Œæ‰€ä»¥å¦‚æœä½ åªæ˜¯åœ¨å†™æ™®é€šçš„ Node.js JavaScript ä»£ç ï¼Œå¯èƒ½æ°¸è¿œéƒ½ä¸éœ€è¦ç›´æ¥æ¥è§¦åˆ°åƒ<code>napi_get_and_clear_last_exception</code>è¿™æ ·çš„å‡½æ•°ã€‚è¿™äº› API æ›´å¤šåœ°ç”¨åœ¨åº•å±‚çš„æ€§èƒ½ä¼˜åŒ–æˆ–ç‰¹æ®ŠåŠŸèƒ½å®ç°ä¸Šã€‚</p><h4 id="napi-is-exception-pending" tabindex="-1"><a class="header-anchor" href="#napi-is-exception-pending"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_is_exception_pending" target="_blank" rel="noopener noreferrer">napi_is_exception_pending</a></span></a></h4><p>å¥½çš„ï¼Œè®©æˆ‘æ¥è§£é‡Šä¸€ä¸‹ Node.js ä¸­çš„ <code>napi_is_exception_pending</code> å‡½æ•°ã€‚</p><p>N-APIï¼ˆNode.js APIï¼‰æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„æ¥å£ã€‚åŸç”Ÿæ’ä»¶æŒ‡çš„æ˜¯ç”¨ Cã€C++ç­‰ç¼–ç¨‹è¯­è¨€å†™æˆçš„æ¨¡å—ï¼Œå®ƒä»¬èƒ½å¤Ÿç›´æ¥ä¸ Node.js çš„åº•å±‚ API è¿›è¡Œäº¤äº’ï¼Œé€šå¸¸ç”¨äºæ€§èƒ½å…³é”®å‹æ“ä½œæˆ–è€…è°ƒç”¨ç³»ç»Ÿçº§åˆ«çš„åº“ã€‚</p><p>åœ¨ä½¿ç”¨ N-API ç¼–å†™åŸç”Ÿä»£ç æ—¶ï¼Œå¯èƒ½ä¼šäº§ç”Ÿå¼‚å¸¸ã€‚åœ¨ JavaScript ä¸­ï¼Œå¼‚å¸¸é€šå¸¸æ˜¯ä¸€ä¸ªé”™è¯¯å¯¹è±¡ï¼Œå½“ä½ çš„ä»£ç æ‰§è¡Œå‡ºé”™æ—¶ï¼ŒJavaScript è¿è¡Œæ—¶ä¼šæŠ›å‡ºè¿™ä¸ªé”™è¯¯å¯¹è±¡ã€‚ç±»ä¼¼åœ°ï¼Œåœ¨ N-API ç¼–å†™çš„åŸç”Ÿæ’ä»¶ä¸­ä¹Ÿå¯ä»¥æŠ›å‡ºå¼‚å¸¸ã€‚</p><p><code>napi_is_exception_pending</code> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸åœ¨åŸç”Ÿæ¨¡å—ä¸­è¢«è§¦å‘ä½†è¿˜æœªè¢« JavaScript å¤„ç†ã€‚è¿™ä¸ªå‡½æ•°éå¸¸é‡è¦ï¼Œå› ä¸ºåœ¨ç»§ç»­æ‰§è¡Œå…¶ä»– N-API è°ƒç”¨å‰ï¼Œå¿…é¡»æ¸…ç†ç°æœ‰çš„å¼‚å¸¸ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´ä¸å¯é¢„è§çš„è¡Œä¸ºã€‚</p><p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>napi_is_exception_pending</code> å‡½æ•°çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  // ...ä½ çš„ä»£ç ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ£€æŸ¥æ˜¯å¦æœ‰æœªå¤„ç†çš„å¼‚å¸¸</span></span>
<span class="line"><span>  bool hasException;</span></span>
<span class="line"><span>  napi_status status = napi_is_exception_pending(env, &amp;hasException);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å¦‚æœè°ƒç”¨æˆåŠŸï¼Œå¹¶ä¸”æœ‰å¼‚å¸¸å­˜åœ¨</span></span>
<span class="line"><span>  if (status == napi_ok &amp;&amp; hasException) {</span></span>
<span class="line"><span>    // å¤„ç†å¼‚å¸¸ï¼Œæ¯”å¦‚è·å–å¼‚å¸¸å¯¹è±¡å¹¶æ‰“å°å®ƒ</span></span>
<span class="line"><span>    napi_value exception;</span></span>
<span class="line"><span>    status = napi_get_and_clear_last_exception(env, &amp;exception);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ... æ‰“å°å¼‚å¸¸ä¿¡æ¯æˆ–å…¶ä»–å¤„ç† ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›ä¸€ä¸ªé”™è¯¯æˆ–nullè¡¨ç¤ºå‡½æ•°æ‰§è¡Œé‡åˆ°äº†é—®é¢˜</span></span>
<span class="line"><span>    return NULL;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ... å…¶ä»–ä»£ç ï¼Œå¦‚æœæ²¡æœ‰å¼‚å¸¸å°±ç»§ç»­æ‰§è¡Œ ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›ç»“æœ</span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span>  // å‡è®¾æˆ‘ä»¬è¦è¿”å›ä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸² &quot;hello world&quot;</span></span>
<span class="line"><span>  status = napi_create_string_utf8(env, &quot;hello world&quot;, NAPI_AUTO_LENGTH, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return status == napi_ok ? result : NULL;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œä¸Šé¢çš„å‡½æ•°ä¸ºä¸€ä¸ªåŸç”Ÿæ¨¡å—çš„å¯¼å‡ºå‡½æ•°</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>  napi_value fn;</span></span>
<span class="line"><span>  napi_status status = napi_create_function(env, NULL, 0, MyFunction, NULL, &amp;fn);</span></span>
<span class="line"><span>  if (status != napi_ok) return NULL;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  napi_set_named_property(env, exports, &quot;myFunction&quot;, fn);</span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>MyFunction</code> çš„å‡½æ•°ï¼Œå®ƒé¦–å…ˆä½¿ç”¨ <code>napi_is_exception_pending</code> æ¥æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸åœ¨ç­‰å¾…å¤„ç†ã€‚å¦‚æœæœ‰å¼‚å¸¸ï¼Œæˆ‘ä»¬åˆ©ç”¨å‡½æ•° <code>napi_get_and_clear_last_exception</code> è·å–è¿™ä¸ªå¼‚å¸¸å¯¹è±¡ï¼Œå¹¶ä¸”å¯ä»¥åšè¿›ä¸€æ­¥å¤„ç†ï¼Œä¾‹å¦‚æ‰“å°å¼‚å¸¸ä¿¡æ¯ã€‚æ­¤å¤–ï¼Œå¦‚æœæ²¡æœ‰å¼‚å¸¸å°±ç»§ç»­åé¢çš„æ“ä½œï¼Œå¹¶æœ€ç»ˆåˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²è¿”å›ç»“æœã€‚</p><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨ç¼–å†™åŸç”Ÿæ’ä»¶çš„æ—¶å€™èƒ½å¤Ÿæ›´å¥½åœ°ç®¡ç†å’Œå“åº”å¼‚å¸¸æƒ…å†µï¼Œç¡®ä¿ Node.js åº”ç”¨çš„ç¨³å®šæ€§å’Œæ­£ç¡®æ€§ã€‚</p><h4 id="napi-fatal-exception" tabindex="-1"><a class="header-anchor" href="#napi-fatal-exception"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_fatal_exception" target="_blank" rel="noopener noreferrer">napi_fatal_exception</a></span></a></h4><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome çš„ V8 JavaScript å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œå…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚Node.js ä½¿ç”¨äº‹ä»¶é©±åŠ¨ã€éé˜»å¡ I/O æ¨¡å‹ï¼Œä½¿å…¶è½»é‡ä¸”é«˜æ•ˆï¼Œéå¸¸é€‚åˆå¤„ç†æ•°æ®å¯†é›†å‹å®æ—¶åº”ç”¨ã€‚</p><p>åœ¨ Node.js ä¸­ï¼Œæœ‰ä¸€ä¸ªåŸç”Ÿæ¨¡å—ç³»ç»Ÿå«ä½œ N-APIï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—çš„ APIï¼Œè®©ä½ èƒ½å¤Ÿä½¿ç”¨ C æˆ–è€… C++ æ¥ç¼–å†™æ‰©å±•ã€‚è¿™äº›æ‰©å±•èƒ½å¤Ÿç›´æ¥ä¸ Node.js çš„ JavaScript è¿è¡Œæ—¶è¿›è¡Œäº¤äº’ï¼Œæä¾›ä¸€äº› JavaScript æœ¬èº«æ— æ³•æˆ–è€…ä¸é‚£ä¹ˆé«˜æ•ˆå®ç°çš„åŠŸèƒ½ã€‚</p><p><code>napi_fatal_exception</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå½“ä½ åœ¨ç¼–å†™ä¸€ä¸ª Node.js çš„åŸç”Ÿæ‰©å±•æ—¶å¯èƒ½ä¼šç”¨åˆ°å®ƒã€‚ç®€å•æ¥è¯´ï¼Œå½“ä½ çš„åŸç”Ÿæ‰©å±•ä¸­å‘ç”Ÿäº†ä¸€ä¸ªæ— æ³•æ¢å¤çš„é”™è¯¯ï¼Œå¯ä»¥è°ƒç”¨æ­¤å‡½æ•°æ¥é€šçŸ¥ Node.js å¼‚å¸¸æƒ…å†µï¼Œå¹¶è®© Node.js åœæ­¢å½“å‰çš„äº‹ä»¶å¾ªç¯å¹¶é€€å‡ºã€‚</p><p>ä¸‹é¢æ˜¯ <code>napi_fatal_exception</code> çš„ä¸€ä¸ªç®€åŒ–ç¤ºä¾‹è¯´æ˜ï¼š</p><p>æƒ³è±¡ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œè¯¥æ¨¡å—éœ€è¦æ‰§è¡Œä¸€äº›åº•å±‚æ“ä½œï¼Œæ¯”å¦‚è®¿é—®ç¡¬ä»¶ä¿¡æ¯æˆ–è€…è¿›è¡Œå¤æ‚çš„æ•°å­¦è®¡ç®—ã€‚å‡è®¾åœ¨æ‰§è¡Œè¿™äº›æ“ä½œæ—¶å‡ºç°äº†ä¸€ä¸ªä¸¥é‡é”™è¯¯ï¼Œä¾‹å¦‚è®¿é—®äº†æ— æ•ˆçš„å†…å­˜åœ°å€æˆ–è€…è§¦å‘äº†ä¸€ä¸ªæ–­è¨€å¤±è´¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦ç«‹å³ç»ˆæ­¢ç¨‹åºï¼Œå› ä¸ºç¨‹åºçš„çŠ¶æ€å·²ç»ä¸ç¡®å®šä¸”å¯èƒ½å¯¼è‡´æ›´å¤šé”™è¯¯æˆ–å®‰å…¨é—®é¢˜ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¸€ä¸ªç¤ºä¾‹åŸç”Ÿå‡½æ•°ï¼Œå®ƒå¯èƒ½ä¼šé‡åˆ°è‡´å‘½çš„å¼‚å¸¸</span></span>
<span class="line"><span>napi_value ExampleFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // å‡è®¾æˆ‘ä»¬åœ¨è¿™é‡Œè¿›è¡Œä¸€äº›æ“ä½œï¼Œä½†å‡ºç°äº†ä¸€ä¸ªä¸¥é‡é”™è¯¯...</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è‡´å‘½é”™è¯¯å‘ç”Ÿï¼Œæˆ‘ä»¬éœ€è¦é€šçŸ¥ Node.js</span></span>
<span class="line"><span>    napi_value error;</span></span>
<span class="line"><span>    napi_create_string_utf8(env, &quot;è‡´å‘½é”™è¯¯ï¼šæ“ä½œæ— æ³•å®Œæˆï¼&quot;, NAPI_AUTO_LENGTH, &amp;error);</span></span>
<span class="line"><span>    napi_fatal_exception(env, error);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ­¤è¡Œä¹‹åçš„ä»£ç å°†ä¸ä¼šè¢«æ‰§è¡Œï¼Œå› ä¸º napi_fatal_exception å°†ç»ˆæ­¢æ‰§è¡Œ</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ¨¡å—åˆå§‹åŒ–å‡½æ•°</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, ExampleFunction, NULL, &amp;fn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;exampleFunction&quot;, fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œæ¨¡å—</span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œå¦‚æœ <code>ExampleFunction</code> å‡½æ•°ä¸­çš„æ“ä½œå¤±è´¥å¹¶è§¦å‘äº†è‡´å‘½çš„å¼‚å¸¸ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªé”™è¯¯ä¿¡æ¯å­—ç¬¦ä¸²å¹¶é€šè¿‡ <code>napi_fatal_exception</code> ä¼ é€’ç»™ Node.jsã€‚ä¸€æ—¦è°ƒç”¨äº† <code>napi_fatal_exception</code>ï¼ŒNode.js ä¼šè®¤ä¸ºå‘ç”Ÿäº†ä¸å¯æ¢å¤çš„é”™è¯¯ï¼Œå¹¶å°†é»˜è®¤ç»ˆæ­¢è¿›ç¨‹ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨çœŸå®çš„åŸç”Ÿæ¨¡å—å¼€å‘ä¸­ï¼Œä½ ä¸ä¼šé¢‘ç¹åœ°ä½¿ç”¨ <code>napi_fatal_exception</code>ï¼Œå› ä¸ºå¤§éƒ¨åˆ†é”™è¯¯éƒ½åº”è¯¥é€šè¿‡æ­£å¸¸çš„ JavaScript å¼‚å¸¸æœºåˆ¶æ¥å¤„ç†ã€‚åªæœ‰åœ¨ç¡®å®é‡åˆ°äº†æ— æ³•æ¢å¤çš„ä¸¥é‡é”™è¯¯æ—¶ï¼Œæ‰åº”è¯¥ä½¿ç”¨æ­¤å‡½æ•°ã€‚</p><h3 id="fatal-errors" tabindex="-1"><a class="header-anchor" href="#fatal-errors"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#fatal-errors" target="_blank" rel="noopener noreferrer">Fatal errors</a></span></a></h3><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome çš„ V8 JavaScript å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œå®ƒä½¿å¾—å¼€å‘è€…å¯ä»¥ä½¿ç”¨ JavaScript ç¼–å†™æœåŠ¡ç«¯ä»£ç ã€‚åœ¨ Node.js ä¸­æä¾›äº†å¾ˆå¤šçš„å†…å»ºæ¨¡å—ï¼Œä»¥åŠé€šè¿‡ npmï¼ˆNode Package Managerï¼‰å¯ä»¥å®‰è£…çš„ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œä»¥ä¾¿å¼€å‘è€…æ„å»ºå„ç§åº”ç”¨ç¨‹åºã€‚</p><p>N-API æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç”¨æ¥æ„å»ºåŸç”Ÿæ‰©å±•çš„ APIã€‚åŸç”Ÿæ‰©å±•æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æ¨¡å—ï¼Œå®ƒå…è®¸ JavaScript ä¸èƒ½å¤Ÿä»¥æ›´é«˜æ€§èƒ½æ‰§è¡Œç‰¹å®šä»»åŠ¡çš„ C/C++ä»£ç äº’æ“ä½œã€‚è¿™é€šå¸¸ç”¨äºé‚£äº›å¯¹æ€§èƒ½è¦æ±‚å¾ˆé«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚è®¿é—®ç¡¬ä»¶åŠŸèƒ½æˆ–è€…è¿›è¡Œå¯†é›†å‹è®¡ç®—ã€‚</p><p>å½“ä½ é‡åˆ° &quot;Fatal errors&quot; è¿™ä¸ªæœ¯è¯­æ—¶ï¼Œå®ƒæŒ‡çš„æ˜¯åœ¨è¿è¡Œ Node.js ç¨‹åºè¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿé‡åˆ°äº†æ— æ³•æ¢å¤çš„é”™è¯¯ï¼Œå¯¼è‡´ Node.js è¿›ç¨‹å´©æºƒã€‚ä¸‹é¢å°±æ¥ç®€å•è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯ Fatal errorsï¼Œå¹¶ç»™å‡ºä¸€äº›å®é™…çš„ä¾‹å­ã€‚</p><h3 id="fatal-errors-1" tabindex="-1"><a class="header-anchor" href="#fatal-errors-1"><span>Fatal errors</span></a></h3><p>åœ¨ Node.js çš„ N-API ä¸Šä¸‹æ–‡ä¸­ï¼ŒFatal error æ˜¯æŒ‡åœ¨ä½¿ç”¨ N-API å‡½æ•°è°ƒç”¨æ—¶ï¼Œå¦‚æœå› ä¸ºæŸç§åŸå› ï¼ˆæ¯”å¦‚å†…å­˜ä¸è¶³ã€æ— æ•ˆçš„å‚æ•°ç­‰ï¼‰å¯¼è‡´ç¨‹åºæ— æ³•ç»§ç»­æ‰§è¡Œï¼ŒNode.js å°±ä¼šè§¦å‘ä¸€ä¸ªè‡´å‘½é”™è¯¯ã€‚</p><p>å®ƒé€šå¸¸æ„å‘³ç€æœ‰ä¸€äº›é‡å¤§çš„é—®é¢˜å‡ºç°äº†ï¼Œå¿…é¡»ç«‹å³ä¿®å¤ï¼Œå› ä¸ºå®ƒä¼šå¯¼è‡´ Node.js è¿›ç¨‹å®Œå…¨é€€å‡ºï¼Œè€Œä¸”ä¸ä¼šè§¦å‘æ­£å¸¸çš„å¼‚å¸¸å¤„ç†æµç¨‹ã€‚è€Œä¸”ï¼Œç”±äºè¿™ç±»é”™è¯¯æ˜¯åœ¨ C/C++ å±‚é¢äº§ç”Ÿçš„ï¼ŒJavaScript å±‚é¢çš„ try-catch æ— æ³•æ•æ‰åˆ°å®ƒä»¬ã€‚</p><h4 id="å®é™…çš„ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#å®é™…çš„ä¾‹å­"><span>å®é™…çš„ä¾‹å­ï¼š</span></a></h4><ol><li><p><strong>å†…å­˜ä¸è¶³</strong>: å¦‚æœä½ çš„åŸç”Ÿæ‰©å±•å°è¯•åˆ†é…å†…å­˜ï¼Œä½†æ˜¯ç³»ç»Ÿæ²¡æœ‰è¶³å¤Ÿçš„å¯ç”¨å†…å­˜ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´è‡´å‘½é”™è¯¯ã€‚</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" data-title="c++" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>Napi::Env env = ...;</span></span>
<span class="line"><span>size_t size_to_allocate = 1024 * 1024 * 1024; // å°è¯•åˆ†é… 1GB å†…å­˜</span></span>
<span class="line"><span>char* large_block = new (std::nothrow) char[size_to_allocate];</span></span>
<span class="line"><span>if (large_block == nullptr) {</span></span>
<span class="line"><span>  // å†…å­˜åˆ†é…å¤±è´¥ï¼Œè§¦å‘Fatal error</span></span>
<span class="line"><span>  NAPI_FATAL_ERROR(&quot;Unable to allocate enough memory&quot;);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>è¿å API ä½¿ç”¨è§„åˆ™</strong>: æ¯”å¦‚ï¼Œå¦‚æœä¸€ä¸ª N-API å‡½æ•°è¦æ±‚ä¼ å…¥éç©ºæŒ‡é’ˆä½œä¸ºå‚æ•°ï¼Œä½†ä½ é”™è¯¯åœ°ä¼ å…¥äº†ç©ºæŒ‡é’ˆï¼Œè¿™å¯èƒ½å¯¼è‡´è‡´å‘½é”™è¯¯ã€‚</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" data-title="c++" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>Napi::Env env = ...;</span></span>
<span class="line"><span>napi_value result;</span></span>
<span class="line"><span>// å‡è®¾ some_function éœ€è¦ä¸€ä¸ªæœ‰æ•ˆçš„ `napi_value` å‚æ•°ï¼Œè€Œä¸æ˜¯ `nullptr`</span></span>
<span class="line"><span>napi_status status = some_function(env, nullptr, &amp;result);</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>  // API è°ƒç”¨ä¸æ­£ç¡®ï¼Œè§¦å‘Fatal error</span></span>
<span class="line"><span>  const napi_extended_error_info* error_info;</span></span>
<span class="line"><span>  napi_get_last_error_info(env, &amp;error_info);</span></span>
<span class="line"><span>  NAPI_FATAL_ERROR(error_info-&gt;error_message);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>æœªå¤„ç†çš„å¼‚å¸¸</strong>: å¦‚æœä½ çš„åŸç”Ÿæ‰©å±•å‡½æ•°ä¸­å‘ç”Ÿäº†æœªè¢«æ•è·çš„å¼‚å¸¸ï¼Œå®ƒä¹Ÿå¯èƒ½è½¬å˜æˆè‡´å‘½é”™è¯¯ã€‚</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" data-title="c++" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>Napi::Env env = ...;</span></span>
<span class="line"><span>try {</span></span>
<span class="line"><span>  // æ‰§è¡Œä¸€äº›å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„æ“ä½œ</span></span>
<span class="line"><span>} catch (const std::exception&amp; e) {</span></span>
<span class="line"><span>  // å¼‚å¸¸è¢«æ•è·ï¼Œä½†æ²¡æœ‰åˆé€‚çš„å¤„ç†æ–¹å¼ï¼Œè§¦å‘Fatal error</span></span>
<span class="line"><span>  NAPI_FATAL_ERROR(e.what());</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>åœ¨å¤„ç†è‡´å‘½é”™è¯¯æ—¶ï¼Œä½ éœ€è¦è°¨æ…ï¼Œç¡®ä¿åªæœ‰åœ¨çœŸæ­£æ— æ³•æ¢å¤çš„æƒ…å†µä¸‹æ‰è§¦å‘å®ƒä»¬ï¼Œå¹¶ä¸”æœ€å¥½åœ¨å‘ç”Ÿä¹‹å‰ï¼Œå°±é€šè¿‡ä»£ç å®¡æŸ¥å’Œæµ‹è¯•æ¥é¢„é˜²è¿™ç±»é”™è¯¯çš„å‘ç”Ÿã€‚å› ä¸ºä¸€æ—¦å‘ç”Ÿï¼Œå®ƒé€šå¸¸æ„å‘³ç€è¿›ç¨‹çš„å³åˆ»ç»ˆæ­¢ã€‚</p><h4 id="napi-fatal-error" tabindex="-1"><a class="header-anchor" href="#napi-fatal-error"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_fatal_error" target="_blank" rel="noopener noreferrer">napi_fatal_error</a></span></a></h4><p>Node.js ä¸­æœ‰ä¸€ç§å« N-API çš„ APIï¼ˆåº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼‰ï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨ C æˆ– C++ ç¼–å†™ä»£ç ï¼Œè¿™äº›ä»£ç å¯ä»¥å’Œ Node.js è¿›è¡Œäº¤äº’ã€‚N-API è®¾è®¡çš„ç›®çš„æ˜¯å¸®åŠ©å¼€å‘è€…åˆ›å»ºæ‰€è°“çš„åŸç”Ÿæ’ä»¶æˆ–åŸç”Ÿæ¨¡å—ï¼Œå³ç›´æ¥ä¸ Node.js JavaScript å¼•æ“é€šä¿¡çš„é JavaScript ä»£ç ã€‚</p><p><code>napi_fatal_error</code> æ˜¯ N-API æä¾›çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨ä¸€ä¸ªä¸å¯æ¢å¤çš„é”™è¯¯å‘ç”Ÿæ—¶é€šçŸ¥ Node.jsã€‚å½“è¿™ä¸ªå‡½æ•°è¢«è°ƒç”¨åï¼Œå®ƒä¼šå¯¼è‡´ Node.js è¿›ç¨‹ç«‹å³ç»ˆæ­¢ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ çš„ Node.js åº”ç”¨ä¼šç«‹åˆ»åœæ­¢è¿è¡Œï¼Œå¹¶è¾“å‡ºä¸€æ¡é”™è¯¯æ¶ˆæ¯ã€‚</p><p>è¿™ä¸ªå‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>void napi_fatal_error(const char* location, size_t location_length,</span></span>
<span class="line"><span>                      const char* message, size_t message_length);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>å‚æ•°è¯´æ˜ï¼š</p><ul><li><code>location</code>: è¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºé”™è¯¯å‘ç”Ÿçš„ä½ç½®ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶åæˆ–è€…å‡½æ•°åã€‚</li><li><code>location_length</code>: æ˜¯ä¸Šè¿°ä½ç½®å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚</li><li><code>message</code>: è¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒåŒ…å«äº†é”™è¯¯ä¿¡æ¯ã€‚</li><li><code>message_length</code>: æ˜¯ä¸Šè¿°é”™è¯¯ä¿¡æ¯å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚</li></ul><p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œ<code>napi_fatal_error</code> é€šå¸¸åªåœ¨æœ€ç³Ÿç³•çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œå½“ä½ ç¡®å®æ²¡æœ‰å…¶ä»–æ–¹æ³•æ¥å¤„ç†é”™è¯¯æ—¶ã€‚å› ä¸ºä¸€æ—¦è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œä½ çš„åº”ç”¨å°†ä¸ä¼šæœ‰æœºä¼šè¿›è¡Œä»»ä½•å½¢å¼çš„æ¸…ç†å·¥ä½œï¼Œæ¯”å¦‚å…³é—­æ–‡ä»¶å¥æŸ„ã€æ•°æ®åº“è¿æ¥ç­‰ã€‚</p><p>ä¸¾ä¾‹æ¥è¯´ï¼Œå‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶æ¥è¯»å–æŸç§ç‰¹æ®Šæ ¼å¼çš„æ–‡ä»¶ï¼Œè€Œè¿™ç§æ ¼å¼çš„è§£æåº“åªæä¾›äº† C++ æ¥å£ã€‚åœ¨è§£ææ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‘ç°äº†ä¸€ä¸ªæ ¹æœ¬æ— æ³•è§£æçš„é”™è¯¯ï¼ˆæ¯”å¦‚æ–‡ä»¶å·²æŸååˆ°æ— æ³•ä¿®å¤çš„åœ°æ­¥ï¼‰ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨ <code>napi_fatal_error</code> æ¥æŠ¥å‘Šè¿™ä¸ªé—®é¢˜ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void readFileAndParse(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // å‡è®¾ params åŒ…å«äº†æˆ‘ä»¬éœ€è¦çš„å‚æ•°</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (file_is_corrupted(params)) {</span></span>
<span class="line"><span>        // å¦‚æœæ–‡ä»¶æŸåäº†ï¼Œå¹¶ä¸”æˆ‘ä»¬æ— æ³•å¤„ç†è¿™ä¸ªé”™è¯¯</span></span>
<span class="line"><span>        const char* location = &quot;readFileAndParse&quot;;</span></span>
<span class="line"><span>        const char* message = &quot;The file is corrupted and cannot be read.&quot;;</span></span>
<span class="line"><span>        napi_fatal_error(location, NAPI_AUTO_LENGTH, message, NAPI_AUTO_LENGTH);</span></span>
<span class="line"><span>        // è°ƒç”¨ napi_fatal_error åï¼Œä¸‹é¢çš„ä»£ç ä¸ä¼šè¢«æ‰§è¡Œ</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ­£å¸¸çš„æ–‡ä»¶å¤„ç†ä»£ç </span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·è®°ä½ï¼Œ<code>napi_fatal_error</code> åº”è¯¥æ˜¯æœ€åçš„æ‰‹æ®µã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä¼˜é›…åœ°å¤„ç†é”™è¯¯ï¼ˆå¦‚è¿”å›å¼‚å¸¸ç»™ JavaScriptï¼‰æ˜¯æ›´å¥½çš„åšæ³•ï¼Œå› ä¸ºè¿™å…è®¸ä½ çš„åº”ç”¨æœ‰æœºä¼šæ¢å¤æˆ–è‡³å°‘ä»¥é€‚å½“çš„æ–¹å¼é€€å‡ºã€‚</p><h2 id="object-lifetime-management" tabindex="-1"><a class="header-anchor" href="#object-lifetime-management"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#object-lifetime-management" target="_blank" rel="noopener noreferrer">Object lifetime management</a></span></a></h2><p>åœ¨ Node.js ä¸­ï¼ŒN-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶çš„ APIã€‚å®ƒå…è®¸ä½ ä½¿ç”¨ C æˆ–è€… C++ ä»£ç æ¥å†™æ‰©å±•ï¼Œè¿™äº›æ‰©å±•å¯ä»¥ç›´æ¥ä¸ Node.js çš„è¿è¡Œæ—¶äº¤äº’ã€‚è€Œâ€œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†â€æŒ‡çš„æ˜¯åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­å¦‚ä½•ç®¡ç† JavaScript å¯¹è±¡å’Œæœ¬åœ°èµ„æºï¼ˆC/C++ åˆ†é…çš„å†…å­˜ï¼‰çš„åˆ›å»ºã€ä½¿ç”¨å’Œé”€æ¯ã€‚</p><p>åœ¨ç¼–å†™ N-API æ‰©å±•æ—¶ï¼Œéœ€è¦æ ¼å¤–æ³¨æ„ä¸è¦é€ æˆå†…å­˜æ³„éœ²æˆ–é‡æŒ‡é’ˆã€‚è¿™å°±éœ€è¦å¦¥å–„ç®¡ç†ä½ åˆ›å»ºçš„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚Node.js çš„åƒåœ¾å›æ”¶å™¨è´Ÿè´£ç®¡ç† JavaScript å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œä½†å¯¹äºæœ¬åœ°èµ„æºå¹¶ä¸ä¼šè‡ªåŠ¨ç®¡ç†ã€‚å› æ­¤ï¼ŒN-API æä¾›äº†ä¸€ç³»åˆ—çš„å‡½æ•°æ¥å¸®åŠ©æ§åˆ¶æœ¬åœ°èµ„æºçš„ç”Ÿå‘½å‘¨æœŸã€‚</p><h3 id="å¼•ç”¨-reference" tabindex="-1"><a class="header-anchor" href="#å¼•ç”¨-reference"><span>å¼•ç”¨ (Reference)</span></a></h3><p>åœ¨ N-API ä¸­ï¼Œä½ å¯ä»¥åˆ›å»ºå¯¹ JavaScript å¯¹è±¡çš„å¼•ç”¨ã€‚è¿™ç§å¼•ç”¨ä¿è¯äº†å¯¹è±¡ä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼Œç›´åˆ°ä½ æ˜ç¡®åœ°å‘Šè¯‰å®ƒè¿™æ ·åšã€‚å¼•ç”¨åˆ†ä¸ºä¸¤ç§ï¼š</p><ul><li>å¼ºå¼•ç”¨ (<code>napi_ref</code>): å½“ä½ åˆ›å»ºä¸€ä¸ªå¼ºå¼•ç”¨æ—¶ï¼Œç›¸åº”çš„å¯¹è±¡å°†ä¿æŒæ´»è·ƒçŠ¶æ€ï¼Œä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚</li><li>å¼±å¼•ç”¨ (<code>napi_weakref</code>): å¼±å¼•ç”¨ä¸ä¼šé˜»æ­¢å¯¹è±¡è¢«å›æ”¶ã€‚å½“ä½ åªæƒ³è¦çŸ¥é“å¯¹è±¡æ˜¯å¦è¿˜æ´»ç€ï¼Œä½†ä¸æƒ³å½±å“å…¶ç”Ÿå‘½å‘¨æœŸæ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¼±å¼•ç”¨ã€‚</li></ul><h3 id="å®é™…ä¾‹å­-4" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-4"><span>å®é™…ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js æ¨¡å—ï¼Œè¯¥æ¨¡å—éœ€è¦ä» JavaScript åˆ›å»ºä¸€ä¸ªå¤§å‹çš„æ•°æ®ç¼“å­˜ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ C++ çš„æŸä¸ªåº“å»å¤„ç†ã€‚</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" data-title="c++" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™æ˜¯ä½ å³å°†å­˜å‚¨ JavaScript å¯¹è±¡å¼•ç”¨çš„å˜é‡</span></span>
<span class="line"><span>napi_ref myObjectRef;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°å°†ä¸€ä¸ª JavaScript å¯¹è±¡ä¿å­˜ä¸ºä¸€ä¸ªå¼ºå¼•ç”¨ï¼Œä½¿å…¶ä¸ä¼šè¢«å›æ”¶</span></span>
<span class="line"><span>void CreateStrongReference(napi_env env, napi_value object) {</span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„å¼ºå¼•ç”¨</span></span>
<span class="line"><span>    napi_status status = napi_create_reference(env, object, 1, &amp;myObjectRef);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯ ...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å½“ä½ ä¸å†éœ€è¦é‚£ä¸ªå¯¹è±¡æ—¶ï¼Œå¯ä»¥åˆ é™¤å¼•ç”¨ä»¥å…è®¸åƒåœ¾å›æ”¶å™¨å›æ”¶å®ƒ</span></span>
<span class="line"><span>void DeleteReference(napi_env env) {</span></span>
<span class="line"><span>    napi_delete_reference(env, myObjectRef);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªå…¨å±€å˜é‡ <code>myObjectRef</code> æ¥å­˜å‚¨å¯¹è±¡çš„å¼•ç”¨ã€‚ç„¶åæœ‰ä¸¤ä¸ªå‡½æ•°ï¼š<code>CreateStrongReference</code> ç”¨äºåˆ›å»ºä¸€ä¸ªå¼ºå¼•ç”¨ï¼Œå®ƒæ¥å—ä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œå¹¶ç¡®ä¿å®ƒä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼›<code>DeleteReference</code> ç”¨äºé‡Šæ”¾å¼•ç”¨ï¼Œè¿™æ ·åƒåœ¾å›æ”¶å™¨å°±å¯ä»¥æ­£å¸¸åœ°å›æ”¶å¯¹è±¡äº†ã€‚</p><h3 id="æ³¨æ„äº‹é¡¹" tabindex="-1"><a class="header-anchor" href="#æ³¨æ„äº‹é¡¹"><span>æ³¨æ„äº‹é¡¹</span></a></h3><p>å½“ä½ ä½¿ç”¨ N-API ç®¡ç†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸæ—¶ï¼Œä»¥ä¸‹å‡ ç‚¹éå¸¸é‡è¦ï¼š</p><ol><li><p><strong>å¹³è¡¡åˆ›å»ºå’Œåˆ é™¤å¼•ç”¨</strong>ï¼šæ¯æ¬¡è°ƒç”¨ <code>napi_create_reference</code> åï¼Œéƒ½åº”è¯¥åœ¨é€‚å½“çš„æ—¶æœºè°ƒç”¨ <code>napi_delete_reference</code>ã€‚å¦åˆ™å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p></li><li><p><strong>éµå¾ªæœ€ä½³å®è·µ</strong>ï¼šé¿å…ä¿ç•™ä¸å¿…è¦çš„å¼•ç”¨ï¼Œå°¤å…¶æ˜¯å¼ºå¼•ç”¨ï¼Œå› ä¸ºå®ƒä»¬ä¼šå½±å“åƒåœ¾å›æ”¶å™¨çš„å·¥ä½œï¼Œå¯èƒ½å¯¼è‡´æ›´å¤šçš„å†…å­˜æ¶ˆè€—ã€‚</p></li><li><p><strong>çº¿ç¨‹å®‰å…¨</strong>ï¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä½¿ç”¨ N-API æ—¶ï¼Œç¡®ä¿ç›¸å…³æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p></li></ol><p>ç»¼ä¸Šæ‰€è¿°ï¼Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†åœ¨ä½¿ç”¨ N-API ç¼–å†™æœ¬åœ°æ‰©å±•æ—¶è‡³å…³é‡è¦ï¼Œåˆç†åœ°ç®¡ç†ä¸ä»…å¯ä»¥é¿å…å†…å­˜æ³„æ¼ï¼Œè¿˜èƒ½ç¡®ä¿ç¨‹åºçš„æ€§èƒ½ã€‚</p><h3 id="making-handle-lifespan-shorter-than-that-of-the-native-method" tabindex="-1"><a class="header-anchor" href="#making-handle-lifespan-shorter-than-that-of-the-native-method"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#making-handle-lifespan-shorter-than-that-of-the-native-method" target="_blank" rel="noopener noreferrer">Making handle lifespan shorter than that of the native method</a></span></a></h3><p>åœ¨ Node.js ä¸­ï¼ŒN-API æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚å®ƒå…è®¸ä½ ä½¿ç”¨ C/C++ä»£ç ä¸ Node.js çš„ JavaScript å¼•æ“äº¤äº’ï¼Œä»¥æ­¤å¯ä»¥åˆ›å»ºæ€§èƒ½æ›´ä¼˜çš„æ¨¡å—æˆ–è€…ç›´æ¥è°ƒç”¨ç³»ç»Ÿçº§åˆ«çš„ APIã€‚</p><p>ç”±äº JavaScript å’Œ C/C++ åœ¨å†…å­˜ç®¡ç†ä¸Šæœ‰å¾ˆå¤§çš„ä¸åŒï¼ŒN-API æä¾›äº†ä¸€å¥—å¤„ç†è¿™äº›å·®å¼‚çš„æœºåˆ¶ã€‚ç‰¹åˆ«åœ°ï¼Œåœ¨ N-API ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦åˆ›å»ºâ€œå¥æŸ„â€ï¼ˆhandleï¼‰ï¼Œè¿™æ˜¯æŒ‡å‘ JavaScript å¯¹è±¡çš„å¼•ç”¨ï¼Œé€šè¿‡è¿™äº›å¥æŸ„æˆ‘ä»¬å¯ä»¥åœ¨ C/C++ ä»£ç ä¸­æ“ä½œ JavaScript å¯¹è±¡ã€‚</p><p>ç„¶è€Œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¥æŸ„çš„ç”Ÿå‘½å‘¨æœŸå¯èƒ½ä¼šæ¯”å®ƒæ‰€å…³è”çš„ C/C++åŸç”Ÿæ–¹æ³•æ›´é•¿ã€‚è¿™å°±å¼•å…¥äº†æ½œåœ¨çš„é—®é¢˜ï¼šå¦‚æœå¥æŸ„å¤ªä¹…æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œå®ƒä¼šä¿æŒå¯¹ä¸€ä¸ªå¯èƒ½å·²ç»ä¸å†éœ€è¦çš„ JavaScript å¯¹è±¡çš„å¼•ç”¨ï¼Œä»è€Œå¯¼è‡´è¯¥å¯¹è±¡æ— æ³•è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒNode.js v21.7.1 ä¸­ N-API æä¾›äº†ä¸€ç§æ–¹å¼æ¥ç¡®ä¿å¥æŸ„ä¸ä¼šæ¯”å…¶å¯¹åº”çš„åŸç”Ÿæ–¹æ³•ç”Ÿå‘½å‘¨æœŸæ›´é•¿ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯é€šè¿‡é™åˆ¶å¥æŸ„çš„ä½œç”¨åŸŸï¼Œåªè®©å®ƒå­˜åœ¨äºéœ€è¦å®ƒçš„ä»£ç æ‰§è¡ŒæœŸé—´ã€‚</p><p>è®©æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­:</p><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œè¯¥æ¨¡å—è´Ÿè´£ä»æ“ä½œç³»ç»Ÿä¸­è·å–ç³»ç»Ÿæ—¶é—´ï¼Œå¹¶å°†å®ƒè¿”å›ç»™ JavaScript ä»£ç ã€‚æˆ‘ä»¬çš„ C++å‡½æ•°å¯èƒ½ä¼šçœ‹èµ·æ¥åƒè¿™æ ·:</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`napi.h&gt;</span></span>
<span class="line"><span>#include `&lt;`time.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™æ˜¯ä¸€ä¸ªN-APIæš´éœ²ç»™JSçš„å‡½æ•°</span></span>
<span class="line"><span>Napi::Value GetSystemTime(const Napi::CallbackInfo&amp; info) {</span></span>
<span class="line"><span>    Napi::Env env = info.Env();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–ç³»ç»Ÿæ—¶é—´</span></span>
<span class="line"><span>    time_t current_time = time(nullptr);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿™é‡Œåˆ›å»ºä¸€ä¸ªå¥æŸ„ï¼Œè¿™ä¸ªå¥æŸ„å…³è”åˆ°ä¸€ä¸ªæ–°çš„JS Dateå¯¹è±¡</span></span>
<span class="line"><span>    Napi::Object dateObject = Napi::Date::New(env, static_cast`&lt;`double&gt;(current_time) * 1000);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›è¿™ä¸ªå¥æŸ„ï¼Œå³è¿”å›Dateå¯¹è±¡ç»™JS</span></span>
<span class="line"><span>    return dateObject;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// çœç•¥å…¶ä»–æ³¨å†Œæ¨¡å—çš„ä»£ç ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>dateObject</code> æ˜¯ä¸€ä¸ªå¥æŸ„ï¼Œå®ƒæŒ‡å‘äº†ä¸€ä¸ªæ–°åˆ›å»ºçš„ JavaScript <code>Date</code> å¯¹è±¡ã€‚å½“ <code>GetSystemTime</code> å‡½æ•°æ‰§è¡Œå®Œæ¯•å¹¶è¿”å›è¿™ä¸ª <code>Date</code> å¯¹è±¡ä¹‹åï¼Œåœ¨ C++ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦ <code>dateObject</code> è¿™ä¸ªå¥æŸ„äº†ã€‚N-API çš„è®¾è®¡å¯ä»¥ä¿è¯ï¼Œä¸€æ—¦è¿™ä¸ªå‡½æ•°è¿”å›ï¼Œé™¤é JavaScript ä»£ç ä¾ç„¶æŒæœ‰è¿™ä¸ª <code>Date</code> å¯¹è±¡çš„å¼•ç”¨ï¼ˆä¾‹å¦‚ï¼ŒæŠŠå®ƒèµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼‰ï¼Œå¦åˆ™è¿™ä¸ª <code>Date</code> å¯¹è±¡å’Œ <code>dateObject</code> å¥æŸ„éƒ½å¯ä»¥è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼Œé¿å…äº†å†…å­˜æ³„æ¼ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œé€šè¿‡è°ƒæ•´ N-API ä¸­å¥æŸ„çš„ç”Ÿå‘½å‘¨æœŸï¼Œä½¿å¾—å®ƒä»¬ä¸ä¼šæ¯”ç›¸å…³çš„åŸç”Ÿæ–¹æ³•æ´»å¾—æ›´ä¹…ï¼ŒNode.js V21.7.1 å¸®åŠ©å¼€å‘è€…æ›´å¥½åœ°ç®¡ç†å†…å­˜ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚è¿™å¯¹äºç¼–å†™é«˜æ•ˆã€ç¨³å®šçš„åŸç”Ÿæ‰©å±•è‡³å…³é‡è¦ã€‚</p><h4 id="napi-open-handle-scope" tabindex="-1"><a class="header-anchor" href="#napi-open-handle-scope"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_open_handle_scope" target="_blank" rel="noopener noreferrer">napi_open_handle_scope</a></span></a></h4><p>Node.js ä¸­çš„ <code>napi_open_handle_scope</code> æ˜¯ä¸€ä¸ªä¸ N-APIï¼ˆNode.js APIï¼‰ç›¸å…³çš„åŠŸèƒ½ã€‚åœ¨æ·±å…¥äº†è§£è¿™ä¸ªå‡½æ•°ä¹‹å‰ï¼Œå…ˆè§£é‡Šä¸€ä¸‹å‡ ä¸ªæ¦‚å¿µï¼Œè¿™æ ·ä½ å¯ä»¥æ›´å¥½åœ°ç†è§£å®ƒçš„ä½œç”¨ã€‚</p><p><strong>N-APIï¼ˆNode APIï¼‰</strong><br> N-API æ˜¯ä¸€ä¸ª C è¯­è¨€çš„ API å±‚ï¼Œå®ƒå…è®¸ä½ ç¼–å†™èƒ½å¤Ÿè·¨ä¸åŒç‰ˆæœ¬ Node.js è¿è¡Œçš„æœ¬åœ°æ’ä»¶ã€‚ä½¿ç”¨ N-API ç¼–å†™çš„æœ¬åœ°æ’ä»¶ä¸ä¾èµ–äº V8 å¼•æ“çš„å†…éƒ¨ç»“æ„ï¼Œå› æ­¤å½“ Node.js å‡çº§æ—¶ï¼Œå¾ˆå¯èƒ½æ— éœ€ä¿®æ”¹ä»£ç å°±èƒ½ç»§ç»­å·¥ä½œã€‚</p><p><strong>å¥æŸ„ï¼ˆHandleï¼‰</strong><br> åœ¨ Node.js ä¸­ï¼Œå¥æŸ„æ˜¯å¯¹ JavaScript å€¼çš„å¼•ç”¨ï¼Œå®ƒä»¬åœ¨ N-API ä¸­ç”¨äºç®¡ç†å’Œç»´æŠ¤ JavaScript å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚å¥æŸ„ä½¿å¾— C/C++ä»£ç å¯ä»¥å­˜å‚¨å’Œæ“ä½œ JavaScript å¯¹è±¡ã€‚</p><p><strong>å¥æŸ„ä½œç”¨åŸŸï¼ˆHandle Scopeï¼‰</strong><br> å¥æŸ„ä½œç”¨åŸŸæä¾›äº†ä¸€ç§é™åˆ¶å¥æŸ„ç”Ÿå‘½å‘¨æœŸçš„æ–¹å¼ï¼Œå®ƒå¯ä»¥ç¡®ä¿åœ¨è¿™ä¸ªä½œç”¨åŸŸç»“æŸæ—¶ï¼Œæ‰€æœ‰åˆ›å»ºçš„å¥æŸ„éƒ½ä¼šè¢«æ­£ç¡®çš„æ¸…é™¤ã€‚è¿™æœ‰åŠ©äºé¿å…å†…å­˜æ³„éœ²ã€‚</p><p>ç°åœ¨ï¼Œæ¥çœ‹ <code>napi_open_handle_scope</code> è¿™ä¸ªå‡½æ•°çš„ä½œç”¨ï¼š</p><ul><li>å½“ä¸€ä¸ªæœ¬åœ°æ’ä»¶ï¼ˆç”¨ C æˆ– C++ç¼–å†™çš„ä»£ç ï¼‰è¦ä¸ JavaScript äº¤äº‘æ—¶ï¼Œå®ƒå¯èƒ½éœ€è¦åˆ›å»ºè®¸å¤š JavaScript å¯¹è±¡ã€‚<code>napi_open_handle_scope</code> ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„å¥æŸ„ä½œç”¨åŸŸã€‚åœ¨è¿™ä¸ªä½œç”¨åŸŸä¸­ï¼Œä½ å¯ä»¥å®‰å…¨åœ°åˆ›å»º JavaScript å¯¹è±¡å¹¶ä¸”ä¸å®ƒä»¬äº¤äº’ã€‚</li><li>åœ¨æ‰§è¡Œå®Œç›¸å…³æ“ä½œåï¼Œä½ éœ€è¦è°ƒç”¨ <code>napi_close_handle_scope</code> å‡½æ•°æ¥å…³é—­ä½œç”¨åŸŸå¹¶ä¸”é‡Šæ”¾å…¶ä¸­çš„å¥æŸ„ï¼Œä»¥é˜²æ­¢å†…å­˜æ³„éœ²ã€‚</li></ul><p><strong>å®é™…è¿ç”¨ä¾‹å­ï¼š</strong></p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªæœ¬åœ°æ’ä»¶ï¼Œè¯¥æ’ä»¶æä¾›äº†ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript æ•°ç»„å¹¶ä¸”å¡«å……ä¸€äº›æ•°æ®ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ªJavaScriptæ•°ç»„å¹¶ä¸”å¡«å……æ•°æ®</span></span>
<span class="line"><span>napi_value CreateArray(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // å¼€å¯ä¸€ä¸ªæ–°çš„å¥æŸ„ä½œç”¨åŸŸ</span></span>
<span class="line"><span>    napi_handle_scope scope;</span></span>
<span class="line"><span>    napi_open_handle_scope(env, &amp;scope);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªç©ºçš„JavaScriptæ•°ç»„</span></span>
<span class="line"><span>    napi_value array;</span></span>
<span class="line"><span>    napi_create_array(env, &amp;array);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¡«å……æ•°ç»„</span></span>
<span class="line"><span>    for (int i = 0; i `&lt;` 10; i++) {</span></span>
<span class="line"><span>        napi_value num;</span></span>
<span class="line"><span>        napi_create_int32(env, i, &amp;num);</span></span>
<span class="line"><span>        napi_set_element(env, array, i, num);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å…³é—­å¥æŸ„ä½œç”¨åŸŸ</span></span>
<span class="line"><span>    napi_close_handle_scope(env, scope);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›åˆ›å»ºçš„æ•°ç»„</span></span>
<span class="line"><span>    return array;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå¼€å¯äº†ä¸€ä¸ªæ–°çš„å¥æŸ„ä½œç”¨åŸŸï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ª JavaScript æ•°ç»„ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå¾ªç¯å‘å…¶ä¸­å¡«å……äº†æ•´æ•° 0 åˆ° 9ã€‚åœ¨å®Œæˆè¿™äº›æ“ä½œåï¼Œæˆ‘ä»¬å…³é—­äº†å¥æŸ„ä½œç”¨åŸŸï¼Œä»¥ç¡®ä¿æ‰€æœ‰åœ¨ä½œç”¨åŸŸä¸­åˆ›å»ºçš„å¥æŸ„éƒ½å¾—åˆ°é€‚å½“çš„æ¸…ç†ã€‚æœ€åï¼Œæˆ‘ä»¬è¿”å›äº†è¿™ä¸ªæ•°ç»„ï¼Œè¿™æ · JavaScript ä»£ç å°±å¯ä»¥ä½¿ç”¨å®ƒäº†ã€‚</p><p>ä½¿ç”¨ <code>napi_open_handle_scope</code> å’Œ <code>napi_close_handle_scope</code> å¯ä»¥å¸®åŠ©ä½ ç¼–å†™å‡ºæ›´ç¨³å¥ã€å†…å­˜é«˜æ•ˆçš„æœ¬åœ°æ’ä»¶ã€‚</p><h4 id="napi-close-handle-scope" tabindex="-1"><a class="header-anchor" href="#napi-close-handle-scope"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_close_handle_scope" target="_blank" rel="noopener noreferrer">napi_close_handle_scope</a></span></a></h4><p><code>napi_close_handle_scope</code> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå±äº Node.js çš„ N-APIï¼ˆNode.js APIï¼‰ï¼Œè¿™ä¸ª API æä¾›äº†ä¸€å¥—ç”¨ C è¯­è¨€ç¼–å†™æœ¬åœ°æ’ä»¶çš„æ¥å£ã€‚åœ¨è§£é‡Š <code>napi_close_handle_scope</code> ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£ä¸¤ä¸ªæ¦‚å¿µï¼š<code>handle</code> å’Œ <code>handle scope</code>ã€‚</p><p>åœ¨ JavaScript ä¸­ï¼Œå½“ä½ åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ã€å‡½æ•°æˆ–è€…å…¶ä»–ä»»ä½•ç±»å‹çš„å€¼æ—¶ï¼ŒJavaScript å¼•æ“ä¼šåœ¨å†…å­˜ä¸­ä¸ºå…¶åˆ†é…ä¸€ä¸ªåœ°å€ã€‚åœ¨ C/C++ æ’ä»¶ä»£ç ä¸­æ“ä½œè¿™äº› JavaScript å€¼æ—¶ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨å®ƒä»¬åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œè€Œæ˜¯é€šè¿‡â€œå¥æŸ„â€(handles)æ¥å¼•ç”¨è¿™äº›å€¼ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†ç¡®ä¿åƒåœ¾å›æ”¶æœºåˆ¶èƒ½å¤Ÿæ­£ç¡®åœ°ç®¡ç†è¿™äº›å€¼çš„ç”Ÿå‘½å‘¨æœŸï¼Œé˜²æ­¢å†…å­˜æ³„éœ²ã€‚</p><p><code>handle scope</code> åˆ™æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªå¥æŸ„çš„å®¹å™¨ï¼Œå½“ä½ åœ¨ C/C++ ä»£ç ä¸­åˆ›å»ºäº†å¾ˆå¤š JavaScript å€¼æ—¶ï¼Œè¿™äº›å€¼çš„å¥æŸ„ä¼šè¢«å­˜æ”¾åœ¨ä¸€ä¸ª<code>handle scope</code> ä¸­ã€‚æ¯ä¸ª<code>handle scope</code>éƒ½æœ‰è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸï¼Œåœ¨è¿™æ®µæ—¶é—´å†…ï¼Œå¯ä»¥å®‰å…¨åœ°å¼•ç”¨å…¶ä¸­çš„å¥æŸ„ã€‚</p><p>ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹ <code>napi_close_handle_scope</code> å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ç”¨äºå…³é—­ä¸€ä¸ªå…ˆå‰æ‰“å¼€çš„ <code>handle scope</code>ã€‚æ¯å½“ä½ åœ¨ C/C++ çš„ N-API æ’ä»¶ä»£ç ä¸­å®Œæˆäº†ä¸€ç³»åˆ—ä¸ JavaScript å€¼ç›¸å…³çš„æ“ä½œï¼Œå¹¶ä¸”ä¸å†éœ€è¦ç»§ç»­è®¿é—®è¿™äº›å€¼æ—¶ï¼Œå°±åº”è¯¥å…³é—­ç›¸åº”çš„ <code>handle scope</code>ã€‚å…³é—­ <code>handle scope</code> å¯ä»¥å‘Šè¯‰ Node.js çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œæ‰€æœ‰åœ¨è¿™ä¸ª <code>handle scope</code> ä¸­çš„å¥æŸ„æ‰€å¼•ç”¨çš„ JavaScript å€¼ç°åœ¨éƒ½å¯ä»¥è¢«å›æ”¶ï¼Œå¦‚æœå®ƒä»¬ä¸å†è¢«ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†æ‰€å¼•ç”¨çš„è¯ã€‚</p><h3 id="ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹"><span>ç¤ºä¾‹</span></a></h3><p>ä¸ºäº†å…·ä½“è¯´æ˜ï¼Œæˆ‘ä»¬å¯ä»¥è®¾æƒ³è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js çš„ C++ æ’ä»¶ï¼Œå®ƒéœ€è¦åˆ›å»ºå¤šä¸ªæ–°çš„ JavaScript å¯¹è±¡ï¼Œå¹¶å°†å®ƒä»¬ä¼ é€’ç»™ Node.js çš„ JavaScript ç¯å¢ƒã€‚</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°æ¨¡æ‹Ÿäº†ä¸€ä¸ªå¯èƒ½ä¼šåˆ›å»ºå¾ˆå¤šJavaScriptå¯¹è±¡çš„æ“ä½œ</span></span>
<span class="line"><span>napi_value CreateObjects(napi_env env) {</span></span>
<span class="line"><span>    napi_handle_scope scope;</span></span>
<span class="line"><span>    napi_open_handle_scope(env, &amp;scope); // æ‰“å¼€ä¸€ä¸ª handle scope</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ¥ä¸‹æ¥åˆ›å»ºä¸€äº› JavaScript å¯¹è±¡ï¼Œæ¯”å¦‚ï¼š</span></span>
<span class="line"><span>    napi_value jsObject1, jsObject2;</span></span>
<span class="line"><span>    napi_create_object(env, &amp;jsObject1);</span></span>
<span class="line"><span>    napi_create_object(env, &amp;jsObject2);</span></span>
<span class="line"><span>    // ... åˆ›å»ºæ›´å¤šå¯¹è±¡ï¼Œå¹¶è¿›è¡Œç›¸å…³æ“ä½œ</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å®Œæˆæ‰€æœ‰æ“ä½œåï¼Œæˆ‘ä»¬ä¸å†éœ€è¦ç»´æŒè¿™äº›å¯¹è±¡çš„å¥æŸ„ï¼š</span></span>
<span class="line"><span>    napi_close_handle_scope(env, scope); // å…³é—­ handle scope</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å‡è®¾æˆ‘ä»¬è¦è¿”å›æœ€ååˆ›å»ºçš„å¯¹è±¡ç»™ JavaScript ç¯å¢ƒ</span></span>
<span class="line"><span>    return jsObject2;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œä¸Šé¢çš„å‡½æ•°ä½œä¸ºä¸€ä¸ªæ¨¡å—å¯¼å‡º</span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_property_descriptor desc = { &quot;createObjects&quot;, 0, CreateObjects, 0, 0, 0, napi_default, 0 };</span></span>
<span class="line"><span>    napi_define_properties(env, exports, 1, &amp;desc);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ<code>napi_open_handle_scope</code> å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„ <code>handle scope</code>ã€‚éšåï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°åˆ›å»ºå¤šä¸ª JavaScript å¯¹è±¡ã€‚åœ¨è¿™äº›æ“ä½œå®Œæˆåï¼Œé€šè¿‡è°ƒç”¨ <code>napi_close_handle_scope</code> æ¥å…³é—­ <code>handle scope</code>ï¼Œè¿™è¡¨æ˜æ‰€æœ‰åœ¨æ­¤ <code>handle scope</code> ä¸­åˆ›å»ºçš„å¥æŸ„æ‰€æŒ‡å‘çš„å¯¹è±¡ç°åœ¨å¯ä»¥è¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶ã€‚æœ€åï¼Œ<code>CreateObjects</code> å‡½æ•°è¿”å›äº†ä¸€ä¸ª JavaScript å¯¹è±¡ç»™ Node.js ç¯å¢ƒã€‚</p><p>æ³¨æ„ï¼Œä»¥ä¸Šä»£ç åªæ˜¯ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­ï¼Œæ—¨åœ¨å¸®åŠ©ç†è§£ <code>napi_close_handle_scope</code> çš„ç”¨æ³•ã€‚åœ¨å®é™…çš„ N-API æ’ä»¶å¼€å‘ä¸­ï¼Œè¿˜éœ€è¦è€ƒè™‘é”™è¯¯å¤„ç†å’Œå¼‚å¸¸å®‰å…¨ç­‰å› ç´ ã€‚</p><h4 id="napi-open-escapable-handle-scope" tabindex="-1"><a class="header-anchor" href="#napi-open-escapable-handle-scope"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_open_escapable_handle_scope" target="_blank" rel="noopener noreferrer">napi_open_escapable_handle_scope</a></span></a></h4><p>å½“ç„¶ï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£ Node.js ä¸­çš„ <code>napi_open_escapable_handle_scope</code> å‡½æ•°ã€‚</p><p>é¦–å…ˆï¼Œ<code>N-API</code> æ˜¯ Node.js æä¾›çš„ä¸€ä¸ª API å±‚ï¼Œå…è®¸ä½ ç”¨ C æˆ– C++ ç¼–å†™æ‰©å±•ã€‚è¿™äº›æ‰©å±•å¯ä»¥ç›´æ¥ä¸ Node.js çš„åº•å±‚ V8 JavaScript å¼•æ“äº¤äº’ã€‚è¿™æ ·åšçš„å¥½å¤„ä¹‹ä¸€æ˜¯ç¼–å†™å‡ºæ¥çš„æ¨¡å—ä¸ä¾èµ–äº V8 å¼•æ“çš„ç‰¹å®šç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä»¬åœ¨ Node.js çš„ä¸åŒç‰ˆæœ¬ä¸­æ›´åŠ ç¨³å®šã€‚</p><p>ç°åœ¨è®©æˆ‘ä»¬èŠèŠ <code>handle scope</code>ã€‚åœ¨ V8ï¼ˆNode.js ä½¿ç”¨çš„ JavaScript å¼•æ“ï¼‰ä¸­ï¼Œå¤§éƒ¨åˆ†çš„ JavaScript å¯¹è±¡éƒ½æ˜¯é€šè¿‡å †å†…å­˜ç®¡ç†çš„ã€‚ä¸ºäº†é«˜æ•ˆåœ°å›æ”¶è¿™äº›å¯¹è±¡ï¼ŒV8 ä½¿ç”¨äº†åƒåœ¾å›æ”¶æœºåˆ¶ã€‚<code>Handle scope</code> æ˜¯ V8 ç”¨æ¥è·Ÿè¸ªå’Œç®¡ç† JavaScript å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„æœºåˆ¶ä¹‹ä¸€ã€‚å½“ä½ åˆ›å»ºäº†å¾ˆå¤šå±€éƒ¨ JavaScript å¯¹è±¡ï¼Œå¹¶ä¸”å¸Œæœ›è¿™äº›å¯¹è±¡åœ¨å½“å‰å‡½æ•°è°ƒç”¨å®Œæˆåèƒ½å¤Ÿæœ‰æ•ˆåœ°è¢«åƒåœ¾å›æ”¶å™¨æ¸…ç†æ—¶ï¼Œä½ ä¼šä½¿ç”¨ <code>handle scope</code>ã€‚</p><p>é‚£ä¹ˆ <code>napi_open_escapable_handle_scope</code> å…·ä½“æ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªå«åš <code>escapable handle scope</code> çš„æ–°ç¯å¢ƒï¼Œå®ƒå…è®¸ä½ ä¸´æ—¶ä¿ç•™ä¸€äº› JavaScript å¯¹è±¡ï¼Œå³ä½¿å½“å‰çš„å‡½æ•°å·²ç»ç»“æŸï¼Œè¿™äº›å¯¹è±¡ä¹Ÿå¯ä»¥â€œé€ƒç¦»â€è¿™ä¸ªä½œç”¨åŸŸå¹¶è¢«å…¶ä»–éƒ¨åˆ†çš„ä»£ç ç»§ç»­ä½¿ç”¨ã€‚</p><p><strong>å®é™…è¿ç”¨ç¤ºä¾‹ï¼š</strong></p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js æ‰©å±•æ¥å¤„ç†å›¾åƒï¼Œä½ éœ€è¦åœ¨ C++ ä»£ç ä¸­åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºå›¾ç‰‡çš„ JavaScript å¯¹è±¡ï¼Œç„¶åå°†è¿™ä¸ªå¯¹è±¡ä¼ å›ç»™ Node.js çš„è°ƒç”¨è€…ã€‚</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™ä¸ªå‡½æ•°ä¼šåœ¨æŸå¤„è¢«è°ƒç”¨ï¼Œä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„å›¾ç‰‡å¯¹è±¡</span></span>
<span class="line"><span>napi_value CreatePictureObject(napi_env env) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_handle_scope scope;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ª escapable handle scope</span></span>
<span class="line"><span>    status = napi_open_escapable_handle_scope(env, &amp;scope);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åœ¨è¿™ä¸ªä½œç”¨åŸŸä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å¯¹è±¡</span></span>
<span class="line"><span>    napi_value pictureObj;</span></span>
<span class="line"><span>    status = napi_create_object(env, &amp;pictureObj);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ...è®¾ç½®å¯¹è±¡çš„å±æ€§ç­‰...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // â€œé€ƒé€¸â€å¯¹è±¡ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥è¢«è¿”å›å¹¶ç”±å‡½æ•°å¤–éƒ¨çš„ä»£ç æ‰€ä½¿ç”¨</span></span>
<span class="line"><span>    napi_value escaped_pictureObj;</span></span>
<span class="line"><span>    status = napi_escape_handle(env, scope, pictureObj, &amp;escaped_pictureObj);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å…³é—­ handle scope</span></span>
<span class="line"><span>    status = napi_close_escapable_handle_scope(env, scope);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return escaped_pictureObj; // è¿”å›â€œé€ƒé€¸â€åçš„å¯¹è±¡</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°å¯èƒ½ä¼šè¢«æš´éœ²ç»™ Node.js ä»£ç è°ƒç”¨</span></span>
<span class="line"><span>// ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>napi_open_escapable_handle_scope</code> åˆ›å»ºäº†ä¸€ä¸ªå¯ä»¥ä»ä¸­â€œé€ƒé€¸â€çš„ä½œç”¨åŸŸã€‚åœ¨è¿™ä¸ªä½œç”¨åŸŸé‡Œï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ <code>pictureObj</code>ï¼Œå¹¶ä¸”é€šè¿‡è°ƒç”¨ <code>napi_escape_handle</code> è®©è¿™ä¸ªå¯¹è±¡åœ¨ <code>napi_close_escapable_handle_scope</code> è°ƒç”¨å…³é—­ä½œç”¨åŸŸåä»ç„¶å¯ä»¥è¢«ä½¿ç”¨ã€‚</p><p>è¿™æ ·ï¼Œå½“ä½ çš„ C++ å‡½æ•°è¿”å›æ—¶ï¼ŒNode.js çš„è°ƒç”¨è€…å°±èƒ½å¤Ÿè·å–åˆ°è¿™ä¸ª JavaScript å¯¹è±¡å¹¶ä¸å…¶äº¤äº’ï¼Œæ¯”å¦‚è¯»å–å±æ€§å€¼æˆ–è€…è°ƒç”¨å¯¹è±¡ä¸Šçš„æ–¹æ³•ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æœºåˆ¶ï¼Œå°¤å…¶æ˜¯åœ¨æ‚¨éœ€è¦åœ¨åŸç”Ÿä»£ç ä¸­åˆ›å»ºå¤æ‚å¯¹è±¡å¹¶å°†å®ƒä»¬ä¼ é€’å› JavaScript ç¯å¢ƒæ—¶ã€‚</p><h4 id="napi-close-escapable-handle-scope" tabindex="-1"><a class="header-anchor" href="#napi-close-escapable-handle-scope"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_close_escapable_handle_scope" target="_blank" rel="noopener noreferrer">napi_close_escapable_handle_scope</a></span></a></h4><p>å½“ç„¶ï¼Œæˆ‘ä¼šåŠªåŠ›ä»¥é€šä¿—æ˜“æ‡‚çš„æ–¹å¼æ¥è§£é‡Šè¿™ä¸ªæ¦‚å¿µã€‚</p><p>åœ¨ Node.js ä¸­ï¼Œ<code>napi_close_escapable_handle_scope</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå±äº N-APIï¼ˆNode.js APIï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶çš„ APIã€‚ä¸ºäº†ç†è§£<code>napi_close_escapable_handle_scope</code>ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ç†è§£å‡ ä¸ªå…³é”®æ¦‚å¿µï¼šå¥æŸ„ï¼ˆhandleï¼‰ï¼Œå¥æŸ„ä½œç”¨åŸŸï¼ˆhandle scopeï¼‰å’Œå¯é€ƒé€¸çš„å¥æŸ„ä½œç”¨åŸŸï¼ˆescapable handle scopeï¼‰ã€‚</p><p><strong>å¥æŸ„ (Handle)</strong>: åœ¨ Node.js çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå¥æŸ„æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼ŒæŒ‡å‘ JavaScript å€¼æˆ–å¯¹è±¡ã€‚ç”±äº Node.js å†…éƒ¨ä½¿ç”¨ V8 å¼•æ“æ¥ç®¡ç† JavaScript ä»£ç ï¼Œæ‰€ä»¥å¥æŸ„å®é™…ä¸Šæ˜¯å¯¹ V8 å¼•æ“ä¸­å¯¹è±¡çš„å¼•ç”¨ã€‚</p><p><strong>å¥æŸ„ä½œç”¨åŸŸ (Handle Scope)</strong>: ä¸ºäº†ç®¡ç†å†…å­˜ï¼ŒV8 å¼•æ“ä½¿ç”¨äº†ä¸€ä¸ªæ¦‚å¿µå«åšå¥æŸ„ä½œç”¨åŸŸã€‚ä¸€ä¸ªå¥æŸ„ä½œç”¨åŸŸå¯ä»¥åŒ…å«å¾ˆå¤šå¥æŸ„ã€‚å½“ä½ åœ¨ C++æ‰©å±•ä¸­åˆ›å»º JavaScript å€¼æ—¶ï¼Œè¿™äº›å€¼ä¼šè¢«æ”¾å…¥å½“å‰çš„å¥æŸ„ä½œç”¨åŸŸã€‚å½“è¯¥ä½œç”¨åŸŸç»“æŸæ—¶ï¼Œå¦‚æœè¿™äº› JavaScript å€¼æ²¡æœ‰è¢«å…¶ä»–éƒ¨åˆ†çš„ä»£ç å¼•ç”¨ï¼Œå®ƒä»¬å°±ä¼šè¢«åƒåœ¾æ”¶é›†å™¨æ¸…é™¤æ‰ã€‚è¿™æœ‰åŠ©äºé˜²æ­¢å†…å­˜æ³„æ¼ã€‚</p><p><strong>å¯é€ƒé€¸çš„å¥æŸ„ä½œç”¨åŸŸ (Escapable Handle Scope)</strong>: è¿™æ˜¯ä¸€ç§ç‰¹æ®Šçš„å¥æŸ„ä½œç”¨åŸŸã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨å¥æŸ„ä½œç”¨åŸŸå†…åˆ›å»ºçš„å€¼ä¸èƒ½â€œé€ƒé€¸â€åˆ°å¤–é¢çš„ä½œç”¨åŸŸï¼Œä½†åœ¨å¯é€ƒé€¸çš„å¥æŸ„ä½œç”¨åŸŸå†…ï¼Œä½ å¯ä»¥æŒ‡å®šæŸä¸ªå€¼â€œé€ƒé€¸â€ï¼Œè¿™æ„å‘³ç€å³ä½¿è¿™ä¸ªä½œç”¨åŸŸç»“æŸäº†ï¼Œè¯¥å€¼ä¹Ÿä¸ä¼šè¢«æ¸…ç†ï¼Œè€Œæ˜¯å¯ä»¥ç»§ç»­è¢«å¤–éƒ¨çš„ä»£ç æ‰€ä½¿ç”¨ã€‚</p><p>ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹<code>napi_close_escapable_handle_scope</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_close_escapable_handle_scope(napi_env env,</span></span>
<span class="line"><span>                                              napi_escapable_handle_scope scope);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å…³é—­ä¸€ä¸ªå¯é€ƒé€¸çš„å¥æŸ„ä½œç”¨åŸŸã€‚å½“ä½ å®Œæˆäº†åœ¨å¯é€ƒé€¸çš„å¥æŸ„ä½œç”¨åŸŸå†…çš„å·¥ä½œï¼Œå¹¶ä¸”å·²ç»æ ‡è®°äº†æƒ³è¦é€ƒé€¸çš„å€¼ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œä½ å°±åº”è¯¥è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥å…³é—­ä½œç”¨åŸŸã€‚</p><p><strong>ä¾‹å­</strong>: å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªæ¥æ”¶ä¸€ä¸ª JavaScript æ•°ç»„ï¼Œå¹¶è¿”å›æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ çš„æ‰©å±•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½ä¼šåˆ›å»ºä¸€ä¸ªå¯é€ƒé€¸çš„å¥æŸ„ä½œç”¨åŸŸï¼Œè·å–æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶å°†å…¶æ ‡è®°ä¸ºé€ƒé€¸ã€‚ç„¶åä½¿ç”¨<code>napi_close_escapable_handle_scope</code>æ¥ç»“æŸä½œç”¨åŸŸï¼ŒåŒæ—¶ä¿æŒå¯¹é‚£ä¸ªå…ƒç´ çš„å¼•ç”¨ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ env æ˜¯æœ‰æ•ˆçš„ napi_env</span></span>
<span class="line"><span>napi_status status;</span></span>
<span class="line"><span>napi_escapable_handle_scope scope;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ›å»ºå¯é€ƒé€¸çš„å¥æŸ„ä½œç”¨åŸŸ</span></span>
<span class="line"><span>status = napi_open_escapable_handle_scope(env, &amp;scope);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... å‡è®¾ä½ å·²ç»è·å–äº†æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å°†ä½ å¸Œæœ›é€ƒé€¸çš„å€¼æ ‡è®°ä¸ºé€ƒé€¸ï¼Œç¡®ä¿å®ƒåœ¨ä½œç”¨åŸŸä¹‹å¤–ä»ç„¶æœ‰æ•ˆ</span></span>
<span class="line"><span>napi_value escaped_value;</span></span>
<span class="line"><span>status = napi_escape_handle(env, scope, array_element, &amp;escaped_value);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å…³é—­å¯é€ƒé€¸çš„å¥æŸ„ä½œç”¨åŸŸ</span></span>
<span class="line"><span>status = napi_close_escapable_handle_scope(env, scope);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ­¤æ—¶ï¼Œescaped_value ä¾ç„¶æœ‰æ•ˆï¼Œå¯ä»¥è¿”å›ç»™ JavaScript</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼š</p><ul><li><code>napi_open_escapable_handle_scope</code> åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¯é€ƒé€¸çš„å¥æŸ„ä½œç”¨åŸŸã€‚</li><li><code>napi_escape_handle</code> æ ‡è®°äº†ä¸€ä¸ªå€¼ä½¿å…¶èƒ½ä»ä½œç”¨åŸŸä¸­é€ƒé€¸ã€‚</li><li><code>napi_close_escapable_handle_scope</code> ç»“æŸäº†è¿™ä¸ªä½œç”¨åŸŸï¼Œä½†å…è®¸æ ‡è®°ä¸ºé€ƒé€¸çš„å€¼åœ¨ä½œç”¨åŸŸä¹‹å¤–ç”Ÿå­˜ã€‚</li></ul><p>è¯·æ³¨æ„ï¼Œè¿™é‡Œçš„<code>status</code>å˜é‡ç”¨äºæ£€æŸ¥æ¯ä¸ª N-API è°ƒç”¨æ˜¯å¦æˆåŠŸã€‚åœ¨çœŸæ­£çš„ä»£ç ä¸­ï¼Œä½ åº”è¯¥æ€»æ˜¯æ£€æŸ¥<code>status</code>å¹¶ç›¸åº”åœ°å¤„ç†é”™è¯¯ã€‚</p><p>å¸Œæœ›è¿™ä¸ªè§£é‡Šæœ‰åŠ©äºä½ ç†è§£<code>napi_close_escapable_handle_scope</code>å‡½æ•°åŠå…¶åœ¨ Node.js æœ¬åœ°æ¨¡å—å¼€å‘ä¸­çš„ä½œç”¨ã€‚</p><h4 id="napi-escape-handle" tabindex="-1"><a class="header-anchor" href="#napi-escape-handle"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_escape_handle" target="_blank" rel="noopener noreferrer">napi_escape_handle</a></span></a></h4><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬æ¥è¯¦ç»†äº†è§£ä¸€ä¸‹ Node.js ä¸­çš„ <code>napi_escape_handle</code>ã€‚</p><p>é¦–å…ˆï¼Œ<code>napi_escape_handle</code> æ˜¯ä¸€ä¸ªå±äº Node.js N-APIï¼ˆåŸç”Ÿ APIï¼‰çš„å‡½æ•°ã€‚N-API æ˜¯ Node.js æä¾›çš„ä¸€ä¸ª C è¯­è¨€çš„ API å±‚ï¼Œå…è®¸ä½ ä½¿ç”¨ C æˆ–è€… C++ç¼–å†™æ‰©å±•æ¨¡å—ã€‚è¿™äº›æ‰©å±•æ¨¡å—å¯ä»¥ç›´æ¥è°ƒç”¨ä½çº§åˆ«çš„ APIï¼Œä¸ V8 å¼•æ“ï¼ˆNode.js è¿è¡Œæ—¶çš„æ ¸å¿ƒï¼‰è¿›è¡Œäº¤äº’ï¼Œè€Œæ— éœ€å…³å¿ƒ Node.js å†…éƒ¨ä»£ç çš„å…·ä½“å®ç°ç»†èŠ‚ã€‚</p><p>åœ¨ç†è§£<code>napi_escape_handle</code>ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ä»€ä¹ˆæ˜¯&quot;handle scope&quot;ã€‚åœ¨ Node.js ä¸­ï¼Œä¸ºäº†æœ‰æ•ˆåœ°ç®¡ç† JavaScript å¯¹è±¡çš„å†…å­˜ï¼ŒV8 ä½¿ç”¨äº†ä¸€ç§ç§°ä½œåƒåœ¾å›æ”¶ï¼ˆGCï¼‰çš„æœºåˆ¶ã€‚ä¸ºäº†é…åˆè¿™ä¸ªæœºåˆ¶ï¼ŒV8 å¼•å…¥äº†æ‰€è°“çš„&quot;handle scope&quot;ï¼šå½“ä½ åœ¨ C/C++æ‰©å±•ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å¯¹è±¡æ—¶ï¼Œå®ƒä¼šè¢«è‡ªåŠ¨æ”¾å…¥å½“å‰çš„ handle scopeã€‚å½“è¿™ä¸ª scope ç»“æŸæ—¶ï¼Œå¦‚æœè¿™ä¸ªå¯¹è±¡æ²¡æœ‰åˆ«çš„å¼•ç”¨ï¼Œå®ƒå°±å¯ä»¥è¢«åƒåœ¾å›æ”¶å™¨æ¸…ç†æ‰ã€‚è¿™æ ·å¯ä»¥å¸®åŠ©é˜²æ­¢å†…å­˜æ³„æ¼ã€‚</p><p>ç„¶è€Œï¼Œæœ‰æ—¶ä½ å¯èƒ½å¸Œæœ›ä¸€ä¸ª JavaScript å¯¹è±¡èƒ½å¤Ÿâ€œé€ƒé€¸â€å‡ºå½“å‰çš„ handle scopeï¼Œä½¿å…¶ä¸å—å½“å‰ scope ç»“æŸæ—¶åƒåœ¾å›æ”¶çš„å½±å“ã€‚è¿™å°±æ˜¯<code>napi_escape_handle</code>å‡½æ•°çš„ä½œç”¨ã€‚</p><p>ä¸¾ä¸ªå®é™…çš„ä¾‹å­ï¼š<br> æƒ³è±¡ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js æ‰©å±•ï¼Œè¯¥æ‰©å±•åˆ›å»ºäº†ä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œå¹¶å¸Œæœ›åœ¨æœªæ¥æŸä¸ªæ—¶å€™ï¼Œå³ä¾¿æ˜¯åœ¨å½“å‰çš„ handle scope å·²ç»ç»“æŸåï¼Œä¹Ÿèƒ½å†æ¬¡è®¿é—®åˆ°è¿™ä¸ªå¯¹è±¡ã€‚ä½ å¯ä»¥ä½¿ç”¨<code>napi_escape_handle</code>æ¥ä¿è¯è¿™ä¸ªå¯¹è±¡åœ¨å½“å‰ scope å¤–ä»ç„¶å¯ç”¨ã€‚</p><p>ä»£ç ç¤ºä¾‹å¯èƒ½ç±»ä¼¼äºä»¥ä¸‹æƒ…å†µï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾envæ˜¯å½“å‰çš„ç¯å¢ƒæ ‡è¯†ï¼Œscopeæ˜¯ä½ å½“å‰çš„handle scope</span></span>
<span class="line"><span>napi_handle_scope scope;</span></span>
<span class="line"><span>napi_open_handle_scope(env, &amp;scope);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ›å»ºä¸€ä¸ªæ–°çš„JavaScriptå¯¹è±¡</span></span>
<span class="line"><span>napi_value js_object;</span></span>
<span class="line"><span>napi_create_object(env, &amp;js_object); // ç›´æ¥æ“ä½œV8å¼•æ“åˆ›å»ºå¯¹è±¡</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ä½ æƒ³è®©è¿™ä¸ªå¯¹è±¡åœ¨scopeå¤–é¢ä¹Ÿèƒ½è®¿é—®åˆ°</span></span>
<span class="line"><span>napi_escapable_handle_scope escapable_scope;</span></span>
<span class="line"><span>napi_open_escapable_handle_scope(env, &amp;escapable_scope);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// é€šè¿‡napi_escape_handleè®©js_objecté€ƒé€¸å‡ºå½“å‰çš„handle scope</span></span>
<span class="line"><span>napi_value escaped_js_object;</span></span>
<span class="line"><span>napi_escape_handle(env, escapable_scope, js_object, &amp;escaped_js_object);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ç°åœ¨å³ä½¿å…³é—­scopeï¼Œescaped_js_objectä¹Ÿä¸ä¼šè¢«æ¸…é™¤</span></span>
<span class="line"><span>napi_close_escapable_handle_scope(env, escapable_scope);</span></span>
<span class="line"><span>napi_close_handle_scope(env, scope);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä½ ç°åœ¨å¯ä»¥åœ¨ä»»ä½•æ—¶å€™å®‰å…¨åœ°ä½¿ç”¨escaped_js_objectï¼Œå› ä¸ºå®ƒå·²ç»é€ƒé€¸å‡ºäº†scope</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œ<code>napi_open_handle_scope</code> å’Œ <code>napi_open_escapable_handle_scope</code> ç”¨æ¥åˆ†åˆ«æ‰“å¼€æ™®é€šçš„å’Œå¯é€ƒé€¸çš„ handle scopesã€‚<code>napi_escape_handle</code> åˆ™ç”¨äºå°†<code>js_object</code>ä»<code>escapable_scope</code>ä¸­é€ƒé€¸åˆ°å¤–é¢ï¼Œè®©å®ƒå¯ä»¥åœ¨<code>escapable_scope</code>å’Œ<code>scope</code>å…³é—­åç»§ç»­å­˜åœ¨ã€‚è¿™æ ·åšä¹‹åï¼Œ<code>escaped_js_object</code>å¯ä»¥åœ¨å…¶ä»–åœ°æ–¹è¢«å®‰å…¨åœ°ä½¿ç”¨ï¼Œè€Œä¸å¿…æ‹…å¿ƒå®ƒä¼šè¢«åƒåœ¾å›æ”¶æ‰ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>napi_escape_handle</code>æ˜¯ä¸€ä¸ªé«˜çº§ç‰¹æ€§ï¼Œä¸»è¦ç”¨äºåœ¨ç¼–å†™ C/C++æ‰©å±•æ—¶ï¼Œç¡®ä¿ JavaScript å¯¹è±¡å¯ä»¥åœ¨å®ƒä»¬è¢«åˆ›å»ºçš„ handle scope å¤–éƒ¨ç”Ÿå­˜ã€‚è¿™å¯¹äºç®¡ç†å¤æ‚çš„å¯¹è±¡ç”Ÿå‘½å‘¨æœŸååˆ†æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨å¼‚æ­¥æ“ä½œå’Œå›è°ƒå‡½æ•°ä¸­ã€‚</p><h3 id="references-to-values-with-a-lifespan-longer-than-that-of-the-native-method" tabindex="-1"><a class="header-anchor" href="#references-to-values-with-a-lifespan-longer-than-that-of-the-native-method"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#references-to-values-with-a-lifespan-longer-than-that-of-the-native-method" target="_blank" rel="noopener noreferrer">References to values with a lifespan longer than that of the native method</a></span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œ<code>N-API</code> æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚åŸç”Ÿæ’ä»¶æ˜¯æŒ‡ç›´æ¥ä½¿ç”¨ C æˆ– C++ è¯­è¨€ç¼–å†™çš„æ¨¡å—ï¼Œè¿™äº›æ¨¡å—å¯ä»¥é€šè¿‡ Node.js è°ƒç”¨ã€‚è¿™æ ·åšçš„ç†ç”±é€šå¸¸æ˜¯ä¸ºäº†æé«˜æ€§èƒ½ï¼Œæˆ–è€…æ˜¯ä¸ºäº†èƒ½ä½¿ç”¨æŸäº›åªæœ‰åœ¨ä½çº§è¯­è¨€ä¸­æ‰å­˜åœ¨çš„åŠŸèƒ½ã€‚</p><p>åœ¨ JavaScript ä¸­ï¼Œå½“ä½ åˆ›å»ºä¸€ä¸ªå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œå¹¶ä¸”ä¸å†æœ‰ä»»ä½•å¼•ç”¨æŒ‡å‘å®ƒæ—¶ï¼Œåƒåœ¾å›æ”¶å™¨å°†ä¼šè‡ªåŠ¨é‡Šæ”¾è¯¥å¯¹è±¡å ç”¨çš„å†…å­˜ã€‚ä½†åœ¨ C/C++ ä¸­ï¼Œç®¡ç†å†…å­˜çš„è´£ä»»åœ¨äºå¼€å‘è€…ï¼Œä»–ä»¬éœ€è¦æ˜¾å¼åœ°åˆ†é…å’Œé‡Šæ”¾å†…å­˜ã€‚</p><h3 id="å¼•ç”¨ä¸å¯¿å‘½" tabindex="-1"><a class="header-anchor" href="#å¼•ç”¨ä¸å¯¿å‘½"><span>å¼•ç”¨ä¸å¯¿å‘½</span></a></h3><p>å½“æˆ‘ä»¬åœ¨ <code>N-API</code> æ’ä»¶ä¸­å¤„ç† JavaScript å€¼æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°ä¸€ç§æƒ…å†µï¼šæˆ‘ä»¬å¸Œæœ›åœ¨åŸç”Ÿä»£ç ä¸­ä¿æŒå¯¹ JavaScript å€¼çš„å¼•ç”¨ï¼Œå³ä½¿å½“å‰çš„åŸç”Ÿæ–¹æ³•ç»“æŸæ‰§è¡Œåä¹Ÿæ˜¯å¦‚æ­¤ã€‚è¿™æ˜¯å› ä¸ºåŸç”Ÿæ–¹æ³•æ‰§è¡Œå®Œæ¯•åï¼ŒæŒ‰ç…§ JavaScript çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–å¼•ç”¨æŒ‡å‘è¿™ä¸ªå€¼ï¼Œå®ƒå¯èƒ½å°±ä¼šè¢«å›æ”¶æ‰ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<code>N-API</code> æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå…è®¸æˆ‘ä»¬åœ¨åŸç”Ÿä»£ç ä¸­åˆ›å»ºå¯¹ JavaScript å€¼çš„<strong>å¼ºå¼•ç”¨</strong>ï¼Œè¿™äº›å¼•ç”¨ä¿è¯äº†å³ä½¿åŸç”Ÿæ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼ŒJavaScript å€¼ä¹Ÿä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚</p><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-2" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-2"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶æ¥å¤„ç†å›¾ç‰‡ã€‚ä½ åœ¨ JavaScript ç«¯æœ‰ä¸€ä¸ªå›¾ç‰‡çš„å¼•ç”¨ï¼Œè€Œä½ æƒ³åœ¨åå°è¿›è¡Œä¸€äº›é•¿æ—¶é—´è¿è¡Œçš„å›¾åƒå¤„ç†å·¥ä½œã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™æ˜¯ä¸€ä¸ªå°†è¢«é•¿æ—¶é—´è¿è¡Œçš„å›¾åƒå¤„ç†å‡½æ•°</span></span>
<span class="line"><span>void ProcessImageInBackground(napi_env env, void* data) {</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span>    // è¿™é‡Œæˆ‘ä»¬æ‰§è¡Œä¸€äº›è€—æ—¶çš„å›¾åƒå¤„ç†æ“ä½œ</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value StartProcessingImage(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–ä¼ é€’ç»™è¯¥å‡½æ•°çš„ JavaScript å›¾ç‰‡å¯¹è±¡</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªå¯¹è¯¥ JavaScript å›¾ç‰‡å¯¹è±¡çš„å¼ºå¼•ç”¨</span></span>
<span class="line"><span>    napi_ref image_ref;</span></span>
<span class="line"><span>    status = napi_create_reference(env, args[0], 1, &amp;image_ref);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†å›¾åƒå¤„ç†ä»»åŠ¡æ”¾å…¥åå°çº¿ç¨‹</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    status = napi_create_async_work(env, ... , ProcessImageInBackground, ... , &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¯åŠ¨å¼‚æ­¥å·¥ä½œ</span></span>
<span class="line"><span>    status = napi_queue_async_work(env, result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¼ªä»£ç ä¸­ï¼Œ<code>StartProcessingImage</code> å‡½æ•°è¢«è°ƒç”¨æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªå›¾åƒå¤„ç†çš„å¼‚æ­¥ä»»åŠ¡ã€‚ç”±äºè¿™é¡¹ä»»åŠ¡å°†åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿æ‰€å¤„ç†çš„ JavaScript å›¾ç‰‡å¯¹è±¡åœ¨æ•´ä¸ªå¤„ç†è¿‡ç¨‹ä¸­éƒ½æ˜¯æ´»è·ƒçš„ï¼Œä¸ä¼šè¢«åƒåœ¾å›æ”¶ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬é€šè¿‡ <code>napi_create_reference</code> åˆ›å»ºäº†ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚è¿™ä¸ªå¼ºå¼•ç”¨å°†ä¿ç•™å›¾ç‰‡å¯¹è±¡ï¼Œç›´åˆ°æˆ‘ä»¬ä¸»åŠ¨åˆ é™¤è¿™ä¸ªå¼•ç”¨ï¼Œæˆ–è€…å‡å°‘å¼•ç”¨è®¡æ•°åˆ°é›¶ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œè¿™ä¸ªç‰¹æ€§è®©æˆ‘ä»¬å¯ä»¥åœ¨åŸç”Ÿæ’ä»¶ä¸­å®‰å…¨åœ°æŒæœ‰ JavaScript å¯¹è±¡çš„å¼•ç”¨ï¼Œç¡®ä¿å³ä½¿å®ƒä»¬ä¸å†è¢« JS ä»£ç ç›´æ¥å¼•ç”¨ï¼Œå®ƒä»¬ä¹Ÿä¸ä¼šåœ¨æˆ‘ä»¬è¿˜éœ€è¦å®ƒä»¬çš„æ—¶å€™è¢«åƒåœ¾å›æ”¶ã€‚è¿™å¯¹äºå®ç°å¤æ‚çš„å¼‚æ­¥æ“ä½œå’Œèµ„æºç®¡ç†ååˆ†é‡è¦ã€‚</p><h4 id="napi-create-reference" tabindex="-1"><a class="header-anchor" href="#napi-create-reference"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_reference" target="_blank" rel="noopener noreferrer">napi_create_reference</a></span></a></h4><p>Node.js ä¸­çš„ <code>napi_create_reference</code> å‡½æ•°æ˜¯ä¸€ä¸ª N-API è°ƒç”¨ï¼Œå®ƒå…è®¸ä½ åœ¨åŸç”Ÿæ¨¡å—ä¸­åˆ›å»ºä¸€ä¸ªå¯¹ JavaScript å¯¹è±¡çš„å¼•ç”¨ã€‚è¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨äºç®¡ç†åŸç”Ÿä»£ç ä¸ JavaScript ä»£ç ä¹‹é—´å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚</p><p>åœ¨è¯¦ç»†è§£é‡Šè¿™ä¸ªå‡½æ•°ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š</p><ol><li><p><strong>N-APIï¼ˆNode APIï¼‰</strong>ï¼šè¿™æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç¨³å®šçš„ API å±‚ï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨ C æˆ– C++ ç¼–å†™æ‰©å±•ï¼Œè€Œä¸å¿…æ‹…å¿ƒéš Node.js ç‰ˆæœ¬å˜åŒ–å¯¼è‡´çš„æ‰©å±•ä¸å…¼å®¹é—®é¢˜ã€‚</p></li><li><p><strong>å¼•ç”¨ï¼ˆReferenceï¼‰</strong>ï¼šåœ¨ç¼–ç¨‹ä¸­ï¼Œå¼•ç”¨é€šå¸¸æ˜¯æŒ‡å‘å¦ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆæˆ–è€…è¿æ¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è°ˆè®ºçš„æ˜¯æŒ‡å‘ JavaScript å¯¹è±¡çš„å¼•ç”¨ã€‚</p></li><li><p><strong>åƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼ŒGCï¼‰</strong>ï¼šJavaScript æœ‰è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå½“å¯¹è±¡ä¸å†è¢«éœ€è¦æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šè‡ªåŠ¨é‡Šæ”¾å®ƒä»¬å ç”¨çš„å†…å­˜ã€‚ä½†æ˜¯ï¼Œåœ¨åŸç”Ÿæ¨¡å—ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ç¡®ä¿æŸä¸ªå¯¹è±¡åœ¨åŸç”Ÿä»£ç æ‰§è¡ŒæœŸé—´ä¸ä¼šè¢« GC æ¸…é™¤ã€‚</p></li></ol><p>ç°åœ¨æ¥çœ‹çœ‹ <code>napi_create_reference</code> å‡½æ•°çš„ç”¨æ³•å’Œç›®çš„ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_create_reference(napi_env env,</span></span>
<span class="line"><span>                                  napi_value value,</span></span>
<span class="line"><span>                                  uint32_t initial_refcount,</span></span>
<span class="line"><span>                                  napi_ref* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>ï¼šä¸€ä¸ªè¡¨ç¤ºå½“å‰ç¯å¢ƒçš„å¥æŸ„ï¼Œåœ¨ä»»ä½• N-API è°ƒç”¨ä¸­éƒ½éœ€è¦ã€‚</li><li><code>value</code>ï¼šæƒ³è¦åˆ›å»ºå¼•ç”¨çš„ JavaScript å¯¹è±¡ã€‚</li><li><code>initial_refcount</code>ï¼šåˆå§‹å¼•ç”¨è®¡æ•°ã€‚å¦‚æœä½ è®¾ç½®ä¸º 0ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å¯ä»¥è¢«åƒåœ¾å›æ”¶ï¼›å¦‚æœè®¾ç½®å¤§äº 0ï¼Œé‚£ä¹ˆå¯¹è±¡ä¼šä¿æŒæ´»è·ƒçŠ¶æ€ç›´åˆ°å¼•ç”¨è®¡æ•°é™è‡³ 0ã€‚</li><li><code>result</code>ï¼šè¿™å°†è¾“å‡ºä¸€ä¸ª <code>napi_ref</code> å¥æŸ„ï¼Œä»£è¡¨äº†åˆ›å»ºçš„å¼•ç”¨ã€‚</li></ul><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-3" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-3"><span>å®é™…è¿ç”¨çš„ä¾‹å­ï¼š</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js çš„åŸç”Ÿæ‰©å±•ï¼Œè¯¥æ‰©å±•ä¸æŸç¡¬ä»¶è®¾å¤‡è¿›è¡Œäº¤äº’ï¼Œå¹¶ä¸”å½“ç¡¬ä»¶è®¾å¤‡å‘å‡ºç‰¹å®šäº‹ä»¶æ—¶ï¼Œå®ƒåº”è¯¥è°ƒç”¨ä¸€ä¸ª JavaScript å›è°ƒå‡½æ•°ã€‚ä½ å¸Œæœ›è¿™ä¸ª JavaScript å›è°ƒå‡½æ•°åœ¨åŸç”Ÿæ¨¡å—å­˜æ´»æœŸé—´ä¸€ç›´æœ‰æ•ˆï¼Œå³ä½¿å®ƒåœ¨ JavaScript ä»£ç ä¸­å·²ç»æ²¡æœ‰å…¶ä»–å¼•ç”¨äº†ã€‚è¿™å°±æ˜¯ <code>napi_create_reference</code> å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æœ‰ä¸ªç¡¬ä»¶äº‹ä»¶ç›‘å¬å™¨çš„ç»“æ„ä½“</span></span>
<span class="line"><span>typedef struct {</span></span>
<span class="line"><span>    void (*on_event)(void); // å½“ç¡¬ä»¶äº‹ä»¶å‘ç”Ÿæ—¶çš„å›è°ƒæŒ‡é’ˆ</span></span>
<span class="line"><span>} HardwareEventListener;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯åœ¨ JavaScript è°ƒç”¨åŸç”Ÿæ¨¡å—æ¥æ³¨å†Œå›è°ƒæ—¶çš„å‡½æ•°</span></span>
<span class="line"><span>napi_value RegisterCallback(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_ref callbackRef;</span></span>
<span class="line"><span>    // åˆ›å»ºå¯¹å›è°ƒå‡½æ•°çš„å¼•ç”¨ï¼Œå¹¶å°†åˆå§‹å¼•ç”¨è®¡æ•°è®¾ç½®ä¸º 1ï¼Œç¡®ä¿å®ƒä¸ä¼šè¢«åƒåœ¾å›æ”¶</span></span>
<span class="line"><span>    napi_create_reference(env, args[0], 1, &amp;callbackRef);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å­˜å‚¨å›è°ƒå¼•ç”¨ä»¥ä¾¿ç¨åä½¿ç”¨...</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return NULL;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å½“ç¡¬ä»¶äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè¿™ä¸ªå‡½æ•°å°†è¢«è°ƒç”¨</span></span>
<span class="line"><span>void OnHardwareEvent() {</span></span>
<span class="line"><span>    // ä½¿ç”¨ä¹‹å‰å­˜å‚¨çš„ `callbackRef` æ¥è·å– JavaScript å›è°ƒå‡½æ•°å¹¶è°ƒç”¨å®ƒ</span></span>
<span class="line"><span>    napi_value callback;</span></span>
<span class="line"><span>    napi_get_reference_value(env, callbackRef, &amp;callback);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_value global;</span></span>
<span class="line"><span>    napi_get_global(env, &amp;global);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è°ƒç”¨ JavaScript å›è°ƒå‡½æ•°</span></span>
<span class="line"><span>    napi_call_function(env, global, callback, 0, NULL, NULL);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œè¯¥äº‹ä»¶ç›‘å¬å™¨</span></span>
<span class="line"><span>void SetupHardwareListener(HardwareEventListener *listener) {</span></span>
<span class="line"><span>    listener-&gt;on_event = OnHardwareEvent;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª <code>napi_ref</code> å¼•ç”¨æ¥ç¡®ä¿å³ä½¿åœ¨ JavaScript ä¸­æ²¡æœ‰å…¶ä»–å¼•ç”¨ï¼Œå›è°ƒå‡½æ•°ä»ç„¶ä¸ä¼šè¢«åƒåœ¾å›æ”¶ã€‚è¿™æ ·ï¼Œæ¯å½“ç¡¬ä»¶äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥å®‰å…¨åœ°è°ƒç”¨è¿™ä¸ª JavaScript å›è°ƒå‡½æ•°ã€‚</p><h4 id="napi-delete-reference" tabindex="-1"><a class="header-anchor" href="#napi-delete-reference"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_delete_reference" target="_blank" rel="noopener noreferrer">napi_delete_reference</a></span></a></h4><p>å½“ç„¶ï¼Œæˆ‘å¾ˆä¹æ„å¸®åŠ©ä½ äº†è§£ <code>napi_delete_reference</code> å‡½æ•°ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ <code>N-API</code> æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ API æ¥å£ã€‚åŸç”Ÿæ’ä»¶å…è®¸å¼€å‘è€…ä½¿ç”¨ C æˆ–è€… C++ ç­‰è¯­è¨€æ¥ç¼–å†™å¯ä»¥ç›´æ¥è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„ä»£ç ï¼Œè¿™äº›ä»£ç å¯ä»¥è¢« Node.js é¡¹ç›®è°ƒç”¨ã€‚é€šå¸¸è¿™æ˜¯ä¸ºäº†å®ç°ä¸€äº› JavaScript éš¾ä»¥å®ç°æˆ–è€…æ€§èƒ½ä¸ä½³çš„åº•å±‚æ“ä½œã€‚</p><p>åœ¨ N-API ä¸­ï¼Œ<code>napi_create_reference</code> å’Œ <code>napi_delete_reference</code> è¿™ä¸¤ä¸ªå‡½æ•°ä¸ â€œå¼•ç”¨â€ ç›¸å…³ã€‚åœ¨è¿™é‡Œï¼Œâ€œå¼•ç”¨â€ æŒ‡çš„æ˜¯ä»åŸç”Ÿä»£ç ï¼ˆC/C++ï¼‰æŒæœ‰å¯¹ JavaScript å¯¹è±¡çš„å¼•ç”¨ã€‚å½“ä½ åœ¨åŸç”Ÿæ¨¡å—ä¸­åˆ›å»ºäº†ä¸€ä¸ªå¼•ç”¨åï¼Œå³ä½¿ JavaScript ä»£ç å·²ç»æ²¡æœ‰ä»»ä½•å˜é‡æŒ‡å‘è¯¥å¯¹è±¡ï¼Œåƒåœ¾å›æ”¶å™¨ä¹Ÿä¸ä¼šé‡Šæ”¾å®ƒï¼Œå› ä¸ºå®ƒçŸ¥é“åŸç”Ÿä»£ç ä»ç„¶éœ€è¦å®ƒã€‚</p><p>ç°åœ¨æ¥çœ‹ <code>napi_delete_reference</code>ï¼š</p><ul><li><p><strong>å‡½æ•°ç›®çš„</strong>ï¼šåˆ é™¤å…ˆå‰åˆ›å»ºçš„å¯¹ JavaScript å€¼çš„å¼ºå¼•ç”¨ï¼Œé€šå¸¸æ˜¯å› ä¸ºåŸç”Ÿä»£ç ä¸å†éœ€è¦å¼•ç”¨è¯¥å€¼ã€‚åˆ é™¤å¼•ç”¨åï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–æ´»åŠ¨å¼•ç”¨æŒ‡å‘è¯¥ JavaScript å€¼ï¼Œåˆ™è¯¥å€¼å¯èƒ½ä¼šåœ¨æœªæ¥çš„åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­è¢«æ¸…é™¤ã€‚</p></li><li><p><strong>åŸºæœ¬ç”¨æ³•</strong>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_delete_reference(napi_env env, napi_ref ref);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><code>env</code> å‚æ•°æ˜¯ä»£è¡¨ N-API è°ƒç”¨ç¯å¢ƒçš„å¥æŸ„ï¼Œè€Œ <code>ref</code> æ˜¯ä¹‹å‰ä½¿ç”¨ <code>napi_create_reference</code> åˆ›å»ºçš„å¼•ç”¨ã€‚</p></li><li><p><strong>ä¾‹å­</strong>ï¼šå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå…¨å±€ JavaScript å‡½æ•°çš„å¼•ç”¨ï¼Œä¸€æ—¦æˆ‘ä»¬ç¡®å®šä¸å†éœ€è¦è¿™ä¸ªå‡½æ•°ï¼Œå°±åº”è¯¥åˆ é™¤å¼•ç”¨ï¼Œä»¥é¿å…å†…å­˜æ³„æ¼ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å‡è®¾åœ¨æŸå¤„å·²ç»åˆ›å»ºäº†ä¸€ä¸ªå¼•ç”¨</span></span>
<span class="line"><span>napi_ref my_function_ref; // è¿™æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ...ç­‰åˆ°ä¸å†éœ€è¦è¿™ä¸ªå‡½æ•°æ—¶...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ é™¤å¼•ç”¨ï¼Œå…è®¸ JavaScript åƒåœ¾å›æ”¶å™¨é‡Šæ”¾å‡½æ•°</span></span>
<span class="line"><span>napi_status status = napi_delete_reference(env, my_function_ref);</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>  // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ¸…ç©ºå¼•ç”¨å˜é‡ï¼Œè¡¨ç¤ºå®ƒä¸å†æŒ‡å‘ä»»ä½•å†…å®¹</span></span>
<span class="line"><span>my_function_ref = NULL;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>è¯·æ³¨æ„ï¼Œåœ¨å®é™…çš„åŸç”Ÿæ¨¡å—å¼€å‘ä¸­ï¼Œæ­£ç¡®ç®¡ç†å¼•ç”¨è‡³å…³é‡è¦ï¼Œä»¥ç¡®ä¿ä¸ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚åˆ é™¤å¼•ç”¨é€šå¸¸æ˜¯åœ¨æ¨¡å—å¸è½½æ—¶ã€å¯¹è±¡ä¸å†éœ€è¦æ—¶æˆ–è€…æ¨¡å—çš„ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶è¿›è¡Œã€‚</p><h4 id="napi-reference-ref" tabindex="-1"><a class="header-anchor" href="#napi-reference-ref"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_reference_ref" target="_blank" rel="noopener noreferrer">napi_reference_ref</a></span></a></h4><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬èŠèŠ Node.js ä¸­çš„ <code>napi_reference_ref</code> è¿™ä¸ªåŠŸèƒ½ã€‚</p><p>é¦–å…ˆï¼Œä¸ºäº†ç†è§£ <code>napi_reference_ref</code>ï¼Œä½ éœ€è¦çŸ¥é“ä¸€äº›å…³äº Node.js å’Œ N-API çš„èƒŒæ™¯ã€‚</p><p>N-API æ˜¯ Node.js çš„ä¸€ä¸ª C APIï¼Œå®ƒå…è®¸æœ¬åœ°æ’ä»¶ï¼ˆç”¨ C æˆ– C++ç¼–å†™çš„ä»£ç ï¼‰ä¸ Node.js çš„ JavaScript å¼•æ“è¿›è¡Œäº¤äº’ã€‚è¿™æ„å‘³ç€å¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ç¼–å†™èƒ½å¤Ÿä¸ JavaScript ä»£ç æ— ç¼é›†æˆçš„æ¨¡å—ã€‚</p><p>åœ¨ JavaScript ä¸­ï¼Œæœ‰ä¸€ä¸ªå«åšåƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼ŒGCï¼‰çš„æœºåˆ¶ã€‚è¿™ä¸ªæœºåˆ¶ä¼šè‡ªåŠ¨é‡Šæ”¾ä¸å†è¢«ç¨‹åºä½¿ç”¨çš„å†…å­˜ã€‚ä½†æ˜¯ï¼Œå½“ä½ åœ¨ JavaScript ä¸­ä½¿ç”¨ç”± N-API åˆ›å»ºçš„æœ¬åœ°èµ„æºæ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œåƒåœ¾å›æ”¶å™¨ä¸çŸ¥é“å¦‚ä½•å¤„ç†è¿™äº›èµ„æºã€‚å› æ­¤ï¼Œå¦‚æœä¸é€‚å½“åœ°ç®¡ç†è¿™äº›èµ„æºï¼Œå°±å¯èƒ½å‡ºç°å†…å­˜æ³„éœ²ã€‚</p><p>ç°åœ¨æ¥åˆ° <code>napi_reference_ref</code>ã€‚è¿™ä¸ªå‡½æ•°ä¸ç®¡ç† N-API ä¸­çš„å¯¹è±¡å¼•ç”¨è®¡æ•°æœ‰å…³ã€‚å½“ä½ åœ¨æœ¬åœ°ä»£ç ä¸­åˆ›å»ºä¸€ä¸ªå¯¹ JavaScript å¯¹è±¡çš„å¼•ç”¨ï¼Œä½ éœ€è¦ç¡®ä¿å³ä½¿ JavaScript çš„åƒåœ¾å›æ”¶æƒ³è¦æ¸…ç†è¿™ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¹Ÿä¸ä¼šè¢«é”€æ¯ï¼Œç›´åˆ°ä½ çš„æœ¬åœ°ä»£ç å®Œæˆä½¿ç”¨å®ƒã€‚é€šè¿‡å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œä½ å®é™…ä¸Šæ˜¯åœ¨å‘Šè¯‰åƒåœ¾å›æ”¶å™¨ï¼šâ€œå˜¿ï¼Œæˆ‘è¿˜åœ¨ç”¨è¿™ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥è¯·ä¸è¦åˆ é™¤å®ƒã€‚â€</p><p>å…·ä½“æ¥è¯´ï¼Œ<code>napi_reference_ref</code>å‡½æ•°ä¼šå¢åŠ ä¸€ä¸ªå¼•ç”¨çš„å¼•ç”¨è®¡æ•°ã€‚æ¯æ¬¡è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå…³è”çš„å¯¹è±¡å°±æ›´éš¾è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼Œç›´åˆ°ç›¸åº”æ•°é‡çš„ <code>napi_reference_unref</code> è¢«è°ƒç”¨æ¥å‡å°‘å¼•ç”¨è®¡æ•°ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªæœ¬åœ°æ’ä»¶ï¼Œè¯¥æ’ä»¶ä¿å­˜äº†ä¸€ä¸ª JavaScript å¯¹è±¡çš„å¼•ç”¨ï¼Œä»¥ä¾¿éšåä½¿ç”¨ã€‚ä½ ä¼šè¿™æ ·ä½¿ç”¨ <code>napi_reference_ref</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status status;</span></span>
<span class="line"><span>napi_ref ref;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ `env` æ˜¯å½“å‰çš„ç¯å¢ƒå¥æŸ„, `object` æ˜¯å·²ç»åˆ›å»ºçš„N-APIä¸­çš„å¯¹è±¡å¥æŸ„</span></span>
<span class="line"><span>status = napi_create_reference(env, object, 1, &amp;ref);</span></span>
<span class="line"><span>// æ£€æŸ¥çŠ¶æ€æ˜¯å¦æ­£å¸¸...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ç°åœ¨ï¼Œä½ æƒ³è¦å¢åŠ å¼•ç”¨çš„å¼•ç”¨è®¡æ•°ï¼Œç¡®ä¿å¯¹è±¡ä¸ä¼šè¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶</span></span>
<span class="line"><span>int32_t ref_count;</span></span>
<span class="line"><span>status = napi_reference_ref(env, ref, &amp;ref_count);</span></span>
<span class="line"><span>// æ£€æŸ¥çŠ¶æ€æ˜¯å¦æ­£å¸¸...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åšä¸€äº›å·¥ä½œ...</span></span>
<span class="line"><span>// ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å¦‚æœä½ å®Œæˆäº†å¯¹è¯¥å¯¹è±¡çš„ä½¿ç”¨ï¼Œå¯ä»¥å‡å°‘å¼•ç”¨è®¡æ•°</span></span>
<span class="line"><span>status = napi_reference_unref(env, ref, &amp;ref_count);</span></span>
<span class="line"><span>// æ£€æŸ¥çŠ¶æ€æ˜¯å¦æ­£å¸¸...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å½“å¼•ç”¨è®¡æ•°å‡å°‘è‡³0æ—¶ï¼Œå¯¹è±¡å¯ä»¥è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶</span></span>
<span class="line"><span>if (ref_count == 0) {</span></span>
<span class="line"><span>    status = napi_delete_reference(env, ref);</span></span>
<span class="line"><span>    // æ£€æŸ¥çŠ¶æ€æ˜¯å¦æ­£å¸¸...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šä»£ç æ®µæ¼”ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªå¼•ç”¨(<code>napi_create_reference</code>)ï¼Œå¢åŠ å¼•ç”¨è®¡æ•° (<code>napi_reference_ref</code>)ï¼Œå‡å°‘å¼•ç”¨è®¡æ•° (<code>napi_reference_unref</code>)ï¼Œå¹¶åœ¨ä¸å†éœ€è¦æ—¶åˆ é™¤å¼•ç”¨ (<code>napi_delete_reference</code>)ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼Œ<code>napi_reference_ref</code> åœ¨ N-API ä¸­æ˜¯ç”¨æ¥å¸®åŠ©ä½ ç®¡ç†æœ¬åœ°ä»£ç ä¸­ JavaScript å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»¥é¿å…åœ¨æœ¬åœ°æ’ä»¶ä¸ JavaScript ä¹‹é—´çš„äº’æ“ä½œè¿‡ç¨‹ä¸­å‡ºç°å†…å­˜é—®é¢˜ã€‚</p><h4 id="napi-reference-unref" tabindex="-1"><a class="header-anchor" href="#napi-reference-unref"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_reference_unref" target="_blank" rel="noopener noreferrer">napi_reference_unref</a></span></a></h4><p>å¥½çš„ï¼Œé¦–å…ˆè®©æˆ‘ç®€å•è§£é‡Šä¸€ä¸‹ Node.js å’Œ N-API æ˜¯ä»€ä¹ˆï¼Œç„¶åå†è¯¦ç»†è®²è§£ <code>napi_reference_unref</code> è¿™ä¸ªå‡½æ•°ã€‚</p><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome çš„ V8 JavaScript å¼•æ“çš„å¹³å°ï¼Œå…è®¸ä½ ä½¿ç”¨ JavaScript æ¥ç¼–å†™æœåŠ¡å™¨ç«¯ä»£ç ã€‚N-API åˆ™æ˜¯ Node.js æä¾›çš„ä¸€å¥— C è¯­è¨€ APIï¼Œå®ƒå…è®¸æœ¬åœ°æ’ä»¶ï¼ˆé€šå¸¸ç”¨ C æˆ– C++ç¼–å†™ï¼‰ä¸ JavaScript ä»£ç äº¤äº’ã€‚è¿™æ„å‘³ç€å¼€å‘è€…å¯ä»¥åœ¨ JavaScript ä¸­è°ƒç”¨ C/C++ ä»£ç ï¼Œæˆ–åœ¨ C/C++ ä»£ç ä¸­æ“ä½œ JavaScript å¯¹è±¡ã€‚</p><p>ç°åœ¨ï¼Œè°ˆè®º <code>napi_reference_unref</code> å‡½æ•°ã€‚åœ¨ N-API ä¸­ï¼Œä¸ºäº†æ§åˆ¶ JavaScript å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªå¼•ç”¨ï¼ˆreferenceï¼‰æ¥ä¿æŒå¯¹è±¡æ´»è·ƒï¼Œé˜²æ­¢å®ƒè¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶ã€‚æœ‰æ—¶å€™ä½ éœ€è¦å‡å°‘å¯¹è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œè¯´æ˜ä½ å¯¹è¿™ä¸ªå¯¹è±¡çš„éœ€æ±‚é™ä½äº†ï¼Œè¿™å°±æ˜¯ <code>napi_reference_unref</code> å‡½æ•°çš„ä½œç”¨ã€‚</p><p>å®é™…ä¸Šï¼Œæ¯å½“ä½ ç”¨ <code>napi_create_reference</code> åˆ›å»ºå¯¹ä¸€ä¸ªå¯¹è±¡çš„æ–°å¼•ç”¨æ—¶ï¼Œå¼•ç”¨è®¡æ•°ä¼šå¢åŠ ã€‚å¦‚æœä½ æƒ³&quot;è§£é™¤&quot;è¿™ä¸ªå¼•ç”¨ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>napi_reference_unref</code> æ¥å‡å°‘å¼•ç”¨è®¡æ•°ã€‚å½“å¼•ç”¨è®¡æ•°é™åˆ° 0 æ—¶ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–å¼•ç”¨ä¿æŒè¿™ä¸ªå¯¹è±¡æ´»è·ƒï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å¯èƒ½ä¼šåœ¨å°†æ¥çš„æŸä¸ªæ—¶é—´ç‚¹è¢«åƒåœ¾å›æ”¶ã€‚</p><p>è¿™é‡Œæ˜¯ <code>napi_reference_unref</code> å‡½æ•°çš„ç­¾åï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_reference_unref(napi_env env, napi_ref ref, uint32_t* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>env</code> æ˜¯ä¸€ä¸ªè¡¨ç¤º N-API ç¯å¢ƒçš„å¥æŸ„ã€‚</li><li><code>ref</code> æ˜¯ä½ ä¹‹å‰é€šè¿‡ <code>napi_create_reference</code> åˆ›å»ºçš„å¼•ç”¨ã€‚</li><li><code>result</code> æ˜¯ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼Œå½“å‡½æ•°æ‰§è¡Œåï¼Œå®ƒä¼šä¿å­˜æ–°çš„å¼•ç”¨è®¡æ•°å€¼ã€‚</li></ul><p>ç°åœ¨ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><p>å‡è®¾ä½ ç¼–å†™äº†ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œè¯¥æ¨¡å—åœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºäº†å¯¹ä¸€ä¸ªç‰¹æ®Š JavaScript å¯¹è±¡çš„å¼•ç”¨ï¼Œå¹¶ä¸”å¸Œæœ›åœ¨æ¨¡å—å·¥ä½œæœŸé—´é˜»æ­¢è¯¥å¯¹è±¡è¢«åƒåœ¾å›æ”¶ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å‡è®¾ obj æ˜¯ä¸€ä¸ªä½ å·²ç»è·å¾—çš„ napi_value è¡¨ç¤ºçš„ JS å¯¹è±¡</span></span>
<span class="line"><span>napi_ref my_ref;</span></span>
<span class="line"><span>napi_status status = napi_create_reference(env, obj, 1, &amp;my_ref);</span></span>
<span class="line"><span>// æ£€æŸ¥çŠ¶æ€æ˜¯å¦ OKï¼Œç„¶åä½ çš„å¼•ç”¨å°±è¢«åˆ›å»ºäº†</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ï¼ŒæŸä¸ªæ—¶é—´ç‚¹ä½ å†³å®šä¸å†éœ€è¦è¿™ä¸ªå¼•ç”¨ï¼Œä½ å¯ä»¥åƒè¿™æ ·å‡å°‘å¼•ç”¨è®¡æ•°ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>uint32_t ref_count;</span></span>
<span class="line"><span>status = napi_reference_unref(env, my_ref, &amp;ref_count);</span></span>
<span class="line"><span>// æ£€æŸ¥çŠ¶æ€ï¼Œå¦‚æœ OKï¼Œref_count å°†åŒ…å«å‡å°‘åçš„å¼•ç”¨è®¡æ•°</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœä»¥åå†ä¹Ÿä¸éœ€è¦è¿™ä¸ªå¯¹è±¡ï¼Œä½ å¯ä»¥å®Œå…¨åˆ é™¤è¿™ä¸ªå¼•ç”¨ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>if (ref_count == 0) {</span></span>
<span class="line"><span>    status = napi_delete_reference(env, my_ref);</span></span>
<span class="line"><span>    // æ£€æŸ¥çŠ¶æ€ï¼Œç¡®ä¿å¼•ç”¨è¢«æ­£ç¡®åˆ é™¤</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç†è§£ <code>napi_reference_unref</code> åŠå…¶ç›¸å…³å‡½æ•°å¯¹äºç¼–å†™å¥å£®ä¸”å†…å­˜ç®¡ç†è‰¯å¥½çš„åŸç”Ÿæ¨¡å—æ˜¯å¾ˆé‡è¦çš„ã€‚è®°ä½ï¼Œé”™è¯¯çš„å¼•ç”¨è®¡æ•°ç®¡ç†å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼æˆ–ææ—©åƒåœ¾å›æ”¶å¯¹è±¡ï¼Œè¿™å¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒæˆ–ä¸å¯é¢„æµ‹çš„è¡Œä¸ºã€‚</p><h4 id="napi-get-reference-value" tabindex="-1"><a class="header-anchor" href="#napi-get-reference-value"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_reference_value" target="_blank" rel="noopener noreferrer">napi_get_reference_value</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶çš„ API å±‚ï¼Œå®ƒæä¾›äº†ä» JavaScript ä»£ç ä¸­è°ƒç”¨ C æˆ– C++ å‡½æ•°çš„åŠŸèƒ½ã€‚ä½¿ç”¨ N-API å¯ä»¥åˆ›å»ºå¯ä»¥ç”± Node.js è°ƒç”¨çš„æœ¬æœºæ¨¡å—ï¼Œè¿™æ ·å¯ä»¥æå‡æ€§èƒ½æˆ–è€…å…è®¸ä½ ä½¿ç”¨ç³»ç»Ÿçº§åˆ«çš„ç‰¹æ€§ã€‚</p><p><code>napi_get_reference_value</code> æ˜¯ N-API æä¾›çš„ä¸€ç§å‡½æ•°ï¼Œå®ƒç”¨æ¥ä»ä¸€ä¸ªå·²ç»åˆ›å»ºçš„å¼•ç”¨ä¸­æ£€ç´¢ JavaScript å€¼ã€‚åœ¨ Node.js çš„æœ¬åœ°æ’ä»¶å¼€å‘ä¸­ï¼Œæˆ‘ä»¬æ—¶å¸¸éœ€è¦ä¿æŒå¯¹æŸäº› JavaScript å¯¹è±¡çš„å¼•ç”¨ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨æˆ–é˜²æ­¢è¿™äº›å¯¹è±¡è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨ N-API åˆ›å»ºå¼•ç”¨ï¼Œå¹¶é€šè¿‡ <code>napi_get_reference_value</code> å‡½æ•°æ¥è·å–è¿™ä¸ªå¼•ç”¨æ‰€æŒ‡å‘çš„å®é™… JavaScript å€¼ã€‚</p><p>ä¸‹é¢æˆ‘å°†è§£é‡Š <code>napi_get_reference_value</code> çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œå¹¶ç»™å‡ºä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚</p><h3 id="ä½¿ç”¨æ­¥éª¤" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨æ­¥éª¤"><span>ä½¿ç”¨æ­¥éª¤</span></a></h3><ol><li><strong>åˆ›å»ºå¼•ç”¨</strong>ï¼šé¦–å…ˆï¼Œä½ éœ€è¦æœ‰ä¸€ä¸ªå¼•ç”¨ (<code>napi_ref</code>) æŒ‡å‘ä¸€ä¸ª JavaScript å¯¹è±¡ã€‚è¿™é€šå¸¸æ˜¯é€šè¿‡ <code>napi_create_reference</code> å®Œæˆçš„ã€‚</li><li><strong>è·å–å¼•ç”¨å€¼</strong>ï¼šä¹‹åï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>napi_get_reference_value</code> æ¥è·å–å¼•ç”¨æŒ‡å‘çš„é‚£ä¸ª JavaScript å€¼ã€‚</li></ol><h3 id="å‡½æ•°ç­¾å-2" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°ç­¾å-2"><span>å‡½æ•°ç­¾å</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_get_reference_value(napi_env env,</span></span>
<span class="line"><span>                                     napi_ref ref,</span></span>
<span class="line"><span>                                     napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>ï¼šå½“å‰ç¯å¢ƒçš„å¥æŸ„ï¼Œå®ƒä»£è¡¨äº† Node.js è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ï¼Œç”¨äºå¤„ç†æ‰€æœ‰ N-API è°ƒç”¨ã€‚</li><li><code>ref</code>ï¼šè¦è·å–å…¶å€¼çš„å¼•ç”¨ã€‚</li><li><code>result</code>ï¼šæŒ‡å‘ <code>napi_value</code> çš„æŒ‡é’ˆï¼Œè¯¥å‡½æ•°ä¼šå°†å¼•ç”¨çš„ JavaScript å€¼èµ‹ç»™è¿™ä¸ªæŒ‡é’ˆã€‚</li></ul><h3 id="å‡½æ•°è¿”å›å€¼" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°è¿”å›å€¼"><span>å‡½æ•°è¿”å›å€¼</span></a></h3><ul><li>è¿”å›ç±»å‹ä¸º <code>napi_status</code>ï¼Œå®ƒè¡¨ç¤ºå‡½æ•°è°ƒç”¨çš„çŠ¶æ€ã€‚å¦‚æœæˆåŠŸï¼Œä¼šè¿”å› <code>napi_ok</code>ï¼›å¦‚æœå¤±è´¥ï¼Œä¼šè¿”å›é”™è¯¯ä»£ç ã€‚</li></ul><h3 id="ç¤ºä¾‹-1" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-1"><span>ç¤ºä¾‹</span></a></h3><p>å‡è®¾æˆ‘ä»¬æƒ³è¦åˆ›å»ºä¸€ä¸ªæœ¬åœ°æ¨¡å—ï¼Œè¯¥æ¨¡å—ä¿æŒå¯¹æŸä¸ª JavaScript å¯¹è±¡çš„å¼•ç”¨ï¼Œå¹¶ä¸”å¸Œæœ›åœ¨æœªæ¥æŸä¸ªæ—¶é—´ç‚¹å†æ¬¡è·å–è¿™ä¸ªå¯¹è±¡ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡å®šæœ‰ä¸€ä¸ªå…¨å±€å˜é‡ä¿å­˜å¼•ç”¨</span></span>
<span class="line"><span>napi_ref global_ref;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ›å»ºå¼•ç”¨çš„å‡½æ•°</span></span>
<span class="line"><span>napi_value CreateReference(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  napi_status status;</span></span>
<span class="line"><span>  napi_value argv[1];</span></span>
<span class="line"><span>  size_t argc = 1;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è·å–ä¼ å…¥çš„JavaScriptå¯¹è±¡</span></span>
<span class="line"><span>  status = napi_get_cb_info(env, info, &amp;argc, argv, NULL, NULL);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    napi_throw_error(env, NULL, &quot;Failed to parse arguments&quot;);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ªå¼±å¼•ç”¨ï¼Œå¼•ç”¨è®¡æ•°è®¾ç½®ä¸º1</span></span>
<span class="line"><span>  status = napi_create_reference(env, argv[0], 1, &amp;global_ref);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    napi_throw_error(env, NULL, &quot;Failed to create reference&quot;);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return argv[0];</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è·å–å¼•ç”¨å¯¹è±¡çš„å‡½æ•°</span></span>
<span class="line"><span>napi_value GetReferenceValue(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  napi_status status;</span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ä½¿ç”¨global_refè·å–JavaScriptå¯¹è±¡</span></span>
<span class="line"><span>  status = napi_get_reference_value(env, global_ref, &amp;result);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    napi_throw_error(env, NULL, &quot;Failed to get reference value&quot;);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›JavaScriptå±‚é¢çš„å¯¹è±¡</span></span>
<span class="line"><span>  return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–æ¨¡å—...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªå‡½æ•°ï¼š<code>CreateReference</code> å’Œ <code>GetReferenceValue</code>ã€‚<code>CreateReference</code> æ¥æ”¶ä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå¼•ç”¨ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»»æ„æ—¶é—´ç‚¹ï¼Œé€šè¿‡ <code>GetReferenceValue</code> å‡½æ•°æ¥è·å–è¿™ä¸ªå¼•ç”¨æ‰€æŒ‡å‘çš„åŸå§‹ JavaScript å¯¹è±¡ã€‚</p><h3 id="æ³¨æ„äº‹é¡¹-1" tabindex="-1"><a class="header-anchor" href="#æ³¨æ„äº‹é¡¹-1"><span>æ³¨æ„äº‹é¡¹</span></a></h3><ul><li>ä½¿ç”¨å¼•ç”¨æ—¶éœ€è¦æ³¨æ„é€‚å½“ç®¡ç†å®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸï¼Œé¿å…å†…å­˜æ³„éœ²ã€‚</li><li>å¼•ç”¨å¯ä»¥æ˜¯å¼ºå¼•ç”¨æˆ–å¼±å¼•ç”¨ï¼ŒåŒºåˆ«åœ¨äºå®ƒæ˜¯å¦é˜»æ­¢åƒåœ¾å›æ”¶å™¨å›æ”¶å…¶æŒ‡å‘çš„ JavaScript å¯¹è±¡ã€‚</li></ul><p>ä»¥ä¸Šå°±æ˜¯ <code>napi_get_reference_value</code> åœ¨ Node.js N-API ä¸­çš„åŸºæœ¬ä»‹ç»å’Œä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ã€‚å¸Œæœ›è¿™æœ‰åŠ©äºä½ ç†è§£å¦‚ä½•åœ¨æœ¬åœ°æ’ä»¶ä¸­å¤„ç† JavaScript å¯¹è±¡çš„å¼•ç”¨ã€‚</p><h3 id="cleanup-on-exit-of-the-current-node-js-environment" tabindex="-1"><a class="header-anchor" href="#cleanup-on-exit-of-the-current-node-js-environment"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#cleanup-on-exit-of-the-current-nodejs-environment" target="_blank" rel="noopener noreferrer">Cleanup on exit of the current Node.js environment</a></span></a></h3><p>Node.js ä¸­çš„&quot;N-API&quot;æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶ï¼ˆnative addonsï¼‰çš„ APIã€‚æœ¬åœ°æ’ä»¶æ˜¯ä¸€äº›ç”¨ C, C++ç­‰è¯­è¨€ç¼–å†™çš„æ¨¡å—ï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥ä¸ Node.js çš„ JavaScript è¿è¡Œæ—¶è¿›è¡Œäº¤äº’ã€‚ä½¿ç”¨æœ¬åœ°æ’ä»¶ï¼Œä½ å¯ä»¥æ‰§è¡Œä¸€äº›éœ€è¦æ›´é«˜æ€§èƒ½æˆ–è€…éœ€è¦ç›´æ¥è®¿é—®ç³»ç»Ÿèµ„æºçš„ä»»åŠ¡ã€‚</p><p>åœ¨ Node.js v21.7.1 ç‰ˆæœ¬ä¸­ï¼Œâ€œCleanup on exit of the current Node.js environmentâ€æŒ‡çš„æ˜¯å½“ Node.js è¿›ç¨‹é€€å‡ºæ—¶ï¼Œç›¸å…³çš„ N-API èµ„æºä¼šè¢«æ¸…ç†æ‰ã€‚è¿™æ„å‘³ç€å¦‚æœä½ çš„ Node.js åº”ç”¨ç¨‹åºæ­£åœ¨ä½¿ç”¨æœ¬åœ°æ’ä»¶ï¼Œå¹¶ä¸”åˆ›å»ºäº†ä¸€äº›é€šè¿‡ N-API åˆ›å»ºçš„å¯¹è±¡ï¼Œé‚£ä¹ˆå½“ Node.js è¿›ç¨‹ç»“æŸæ—¶ï¼ˆä¾‹å¦‚ï¼Œä½ å…³é—­äº†æœåŠ¡å™¨ï¼‰ï¼Œè¿™äº›å¯¹è±¡æ‰€å ç”¨çš„èµ„æºä¼šè‡ªåŠ¨è¢«é‡Šæ”¾ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œè¿™ä¸ªç‰¹æ€§æ¶‰åŠåˆ°å¦‚ä½•å¤„ç†å„ç§å›è°ƒå’Œé’©å­(hooks)ï¼Œä»¥ç¡®ä¿å½“ Node.js ç¯å¢ƒç»ˆæ­¢æ—¶ï¼Œä»»ä½•æœªå®Œæˆçš„ä»»åŠ¡éƒ½èƒ½æ­£ç¡®åœ°æ¸…ç†å¹²å‡€ï¼Œä»è€Œé¿å…å†…å­˜æ³„éœ²å’Œå…¶ä»–æ½œåœ¨é—®é¢˜ã€‚è¿™é€šå¸¸ä¼šåœ¨å¦‚ä¸‹æƒ…å†µä¸­å‘ç”Ÿï¼š</p><ul><li>å½“ Node.js ç”±äºå¼‚å¸¸é”™è¯¯è€Œé€€å‡ºæ—¶ã€‚</li><li>å½“ Node.js æ­£å¸¸å…³é—­æ—¶ï¼Œæ¯”å¦‚è°ƒç”¨<code>process.exit()</code>ã€‚</li></ul><p>å®é™…è¿ç”¨çš„ä¾‹å­å¯èƒ½åŒ…æ‹¬ï¼š</p><ol><li><p><strong>æ•°æ®åº“è¿æ¥æ’ä»¶</strong>: å¦‚æœä½ ä½¿ç”¨ä¸€ä¸ªæœ¬åœ°æ’ä»¶æ¥ç®¡ç†æ•°æ®åº“è¿æ¥ï¼Œé‚£ä¹ˆåœ¨ Node.js é€€å‡ºæ—¶ï¼Œæ‰€æœ‰çš„æ•°æ®åº“è¿æ¥éƒ½ä¼šè¢«è‡ªåŠ¨å…³é—­ï¼Œé˜²æ­¢å‡ºç°è¿æ¥æ²¡æœ‰æ­£ç¡®ç»“æŸçš„æƒ…å†µã€‚</p></li><li><p><strong>æ–‡ä»¶æ“ä½œæ’ä»¶</strong>: å‡è®¾ä½ æœ‰ä¸€ä¸ªæœ¬åœ°æ’ä»¶ç”¨äºæ‰§è¡Œæ–‡ä»¶ I/O æ“ä½œï¼Œåœ¨ Node.js ç»“æŸæ—¶ï¼Œæ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ä¼šè¢«å…³é—­ï¼Œç¡®ä¿æ²¡æœ‰æ–‡ä»¶è¢«æ„å¤–ç•™åœ¨æ‰“å¼€çŠ¶æ€ä¸­ã€‚</p></li><li><p><strong>ç¡¬ä»¶æ¥å£æ’ä»¶</strong>: å¦‚æœä½ çš„ Node.js åº”ç”¨ç¨‹åºä¸æŸäº›ç¡¬ä»¶è®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œæ¯”å¦‚é€šè¿‡ä¸²å£ä¸ä¼ æ„Ÿå™¨äº¤äº’ï¼Œé‚£ä¹ˆåœ¨é€€å‡ºæ—¶ï¼Œç›¸å…³çš„ç¡¬ä»¶èµ„æºä¹Ÿä¼šè¢«é€‚å½“é‡Šæ”¾ã€‚</p></li></ol><p>è¦ç‚¹æ˜¯ï¼ŒN-API æä¾›äº†ä¸€ç»„ç¨³å®šçš„ APIsï¼Œä½¿å¾—æœ¬åœ°æ’ä»¶çš„å¼€å‘è€…ä¸éœ€è¦å¯¹æ¯ä¸€ä¸ª Node.js çš„æ–°ç‰ˆæœ¬éƒ½åšé€‚é…ï¼ŒåŒæ—¶ç¡®ä¿äº† Node.js ç¯å¢ƒé€€å‡ºæ—¶èµ„æºèƒ½å¤Ÿå¾—åˆ°æ­£ç¡®çš„æ¸…ç†ã€‚è¿™æ ·çš„è®¾è®¡æ—¢æ–¹ä¾¿äº†å¼€å‘è€…ï¼Œä¹Ÿæé«˜äº†ç¨‹åºçš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚</p><h4 id="napi-add-env-cleanup-hook" tabindex="-1"><a class="header-anchor" href="#napi-add-env-cleanup-hook"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_add_env_cleanup_hook" target="_blank" rel="noopener noreferrer">napi_add_env_cleanup_hook</a></span></a></h4><p>å¥½çš„ï¼Œé¦–å…ˆæ¥ç®€å•ä»‹ç»ä¸€ä¸‹ Node.js å’Œ N-API æ˜¯ä»€ä¹ˆï¼Œç„¶åæˆ‘ä¼šè¯¦ç»†è§£é‡Š <code>napi_add_env_cleanup_hook</code> è¿™ä¸ªå‡½æ•°åŠå…¶åº”ç”¨ã€‚</p><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 JavaScript å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ JavaScript ä»£ç ã€‚Node.js çš„ç‰¹ç‚¹æ˜¯å¼‚æ­¥å’Œéé˜»å¡ IOï¼Œè¿™ä½¿å¾—å®ƒéå¸¸é€‚åˆå¤„ç†å¤§é‡å¹¶å‘è¿æ¥ï¼Œä¾‹å¦‚åœ¨ç½‘ç»œæœåŠ¡å™¨æˆ–ä¸æ•°æ®åº“çš„äº¤äº’ä¸­ã€‚</p><p>N-API æ˜¯ Node.js çš„ä¸€ä¸ªç¨³å®šçš„ API å±‚ï¼Œç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶ã€‚åŸç”Ÿæ’ä»¶æ˜¯ç”¨ C æˆ– C++ å†™çš„æ¨¡å—ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ç³»ç»Ÿçº§åˆ«çš„ APIï¼Œæ¯”å¦‚æ“ä½œæ–‡ä»¶ç³»ç»Ÿæˆ–è€…åˆ›å»ºç½‘ç»œè¿æ¥ã€‚N-API çš„ä½œç”¨æ˜¯æä¾›ä¸€ç»„ç¨³å®šã€ç‰ˆæœ¬æ— å…³çš„æ¥å£ï¼Œå…è®¸åŸç”Ÿæ’ä»¶ä»£ç ä¸ Node.js è¿›è¡Œäº¤äº’ï¼Œè€Œä¸å¿…æ‹…å¿ƒåº•å±‚ JavaScript å¼•æ“çš„å˜åŒ–ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ <code>napi_add_env_cleanup_hook</code> è¿™ä¸ªå‡½æ•°ã€‚</p><p><code>napi_add_env_cleanup_hook</code> å‡½æ•°ç”¨äºæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°å°†åœ¨ Node.js ç¯å¢ƒå³å°†é”€æ¯æ—¶è¢«è°ƒç”¨ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨ Node.js åº”ç”¨ç¨‹åºå³å°†é€€å‡ºæ—¶ï¼Œæˆ–è€…å½“æŸä¸ªç‰¹å®šçš„ Node.js å·¥ä½œçº¿ç¨‹ï¼ˆä¾‹å¦‚åœ¨ worker_threads æ¨¡å—ä¸­ï¼‰å³å°†ç»“æŸæ—¶ã€‚</p><p>ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªåŠŸèƒ½å‘¢ï¼Ÿ</p><p>å½“ä½ åˆ›å»ºåŸç”Ÿæ’ä»¶æ—¶ï¼Œå¯èƒ½ä¼šåˆ†é…ä¸€äº›èµ„æºï¼Œä¾‹å¦‚å†…å­˜ã€æ–‡ä»¶æè¿°ç¬¦æˆ–å…¶ä»–æ“ä½œç³»ç»Ÿèµ„æºã€‚å¦‚æœè¿™äº›èµ„æºåœ¨æ’ä»¶ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶æ²¡æœ‰æ­£ç¡®åœ°æ¸…ç†ï¼Œå¯èƒ½ä¼šå¯¼è‡´èµ„æºæ³„éœ²ã€‚ä½¿ç”¨ <code>napi_add_env_cleanup_hook</code> å¯ä»¥ç¡®ä¿å½“ Node.js ç¯å¢ƒç»“æŸæ—¶ï¼Œä½ æœ‰æœºä¼šé‡Šæ”¾è¿™äº›èµ„æºï¼Œä»è€Œé¿å…èµ„æºæ³„éœ²ã€‚</p><p>ä¸‹é¢æ˜¯ <code>napi_add_env_cleanup_hook</code> çš„åŸºæœ¬ç”¨æ³•ç¤ºä¾‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯ä½ å¸Œæœ›åœ¨ç¯å¢ƒæ¸…ç†æ—¶æ‰§è¡Œçš„å‡½æ•°</span></span>
<span class="line"><span>void cleanup(void* arg) {</span></span>
<span class="line"><span>    // é‡Šæ”¾èµ„æºï¼Œarg æ˜¯åœ¨æ³¨å†Œå›è°ƒæ—¶ä¼ é€’çš„ä»»æ„æ•°æ®</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œå½“ä½ çš„æ’ä»¶è¢«åŠ è½½æ—¶æ‰§è¡Œ</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ³¨å†Œæ¸…ç†é’©å­</span></span>
<span class="line"><span>    napi_add_env_cleanup_hook(env, cleanup, nullptr);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä½¿ç”¨ NODE_API_MODULE å®æ³¨å†Œä½ çš„æ’ä»¶</span></span>
<span class="line"><span>NODE_API_MODULE(your_module_name, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æ­¤ä»£ç ä¸­ï¼š</p><ol><li><code>cleanup</code> å‡½æ•°æ˜¯åœ¨ Node.js ç¯å¢ƒç»ˆæ­¢å‰éœ€è¦æ‰§è¡Œçš„æ¸…ç†é€»è¾‘ã€‚</li><li><code>Init</code> å‡½æ•°æ˜¯æ¨¡å—åˆå§‹åŒ–æ—¶è°ƒç”¨çš„å…¥å£ç‚¹ï¼Œåœ¨è¿™é‡Œæ³¨å†Œäº†æ¸…ç†é’©å­ã€‚</li><li><code>napi_add_env_cleanup_hook</code> å°† <code>cleanup</code> å‡½æ•°æ³¨å†Œä¸ºæ¸…ç†é’©å­ï¼Œè€Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å¯é€‰çš„ï¼Œå¯ä»¥ä¼ é€’ç»™ <code>cleanup</code> å‡½æ•°çš„æ•°æ®ã€‚</li></ol><p>å®é™…åº”ç”¨ä¸¾ä¾‹ï¼š</p><ul><li>å¦‚æœä½ çš„æ’ä»¶æ‰“å¼€äº†æ–‡ä»¶è¿›è¡Œè¯»å†™ï¼Œä½ éœ€è¦ç¡®ä¿åœ¨é€€å‡ºå‰å…³é—­è¿™äº›æ–‡ä»¶ã€‚</li><li>å¦‚æœä½ çš„æ’ä»¶å¯åŠ¨äº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹æˆ–è¿›ç¨‹ï¼Œå¹¶åœ¨èƒŒåè¿è¡Œï¼Œä½ éœ€è¦ç¡®ä¿åœ¨æ¸…ç†é’©å­ä¸­åœæ­¢å¹¶æ¸…ç†è¿™äº›çº¿ç¨‹æˆ–è¿›ç¨‹ã€‚</li><li>å¦‚æœä½ çš„æ’ä»¶åˆ†é…äº†å†…å­˜ï¼Œå¯èƒ½éœ€è¦åœ¨æ¸…ç†é’©å­ä¸­é‡Šæ”¾è¿™äº›å†…å­˜ã€‚</li></ul><p>æ€»ç»“ä¸€ä¸‹ï¼Œä½¿ç”¨ <code>napi_add_env_cleanup_hook</code> å¯ä»¥ç¡®ä¿å½“ Node.js ç¯å¢ƒç»“æŸæ—¶ï¼ŒåŸç”Ÿæ’ä»¶æœ‰æœºä¼šè¿›è¡Œé€‚å½“çš„èµ„æºå›æ”¶å’Œæ¸…ç†å·¥ä½œï¼Œè¿™å¯¹äºç¼–å†™é«˜æ•ˆã€ä¸æ³„éœ²èµ„æºçš„åŸç”Ÿæ’ä»¶è‡³å…³é‡è¦ã€‚</p><h4 id="napi-remove-env-cleanup-hook" tabindex="-1"><a class="header-anchor" href="#napi-remove-env-cleanup-hook"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_remove_env_cleanup_hook" target="_blank" rel="noopener noreferrer">napi_remove_env_cleanup_hook</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ¬æœºæ’ä»¶çš„ APIã€‚è¿™ä¸ª API è®¾è®¡å¾—ç›¸å¯¹åº•å±‚ï¼Œæä¾›äº†æ›´ç›´æ¥åœ°ä¸ JavaScript è¿è¡Œæ—¶å’Œ V8 å¼•æ“äº¤äº’çš„èƒ½åŠ›ã€‚N-API æ—¨åœ¨ä¸ä»…è·¨ Node.js ç‰ˆæœ¬æä¾›ç¨³å®šæ€§ï¼Œè¿˜é™ä½å‘ä¸‹å…¼å®¹æ€§é—®é¢˜ï¼Œå› æ­¤å¼€å‘è€…å¯ä»¥ç¼–å†™ä¸€æ¬¡ä»£ç ï¼Œåœ¨å¤šä¸ªç‰ˆæœ¬çš„ Node.js ä¸Šè¿è¡Œã€‚</p><p><code>napi_remove_env_cleanup_hook</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯ç§»é™¤ä¹‹å‰ä½¿ç”¨ <code>napi_add_env_cleanup_hook</code> å‡½æ•°æ³¨å†Œçš„ç¯å¢ƒæ¸…ç†é’©å­ï¼ˆcleanup hookï¼‰ã€‚æ‰€è°“â€œç¯å¢ƒæ¸…ç†é’©å­â€æ˜¯æŒ‡å½“ Node.js ç¯å¢ƒæ­£åœ¨é”€æ¯æ—¶å°†è¦æ‰§è¡Œçš„å‡½æ•°ï¼Œå®ƒä»¬é€šå¸¸ç”¨æ¥é‡Šæ”¾èµ„æºï¼Œæ¯”å¦‚å…³é—­æ–‡ä»¶æè¿°ç¬¦ã€è§£é™¤å†…å­˜åˆ†é…ç­‰ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä»¥é€šä¿—æ˜“æ‡‚çš„æ–¹å¼è¿›è¡Œè§£é‡Šï¼š</p><p>æƒ³è±¡ä½ å‚åŠ äº†ä¸€ä¸ªèšä¼šï¼Œåœ¨èšä¼šç»“æŸä¹‹å‰ï¼Œä½ è¯´ï¼šâ€œèšä¼šç»“æŸæ—¶å€™æˆ‘ä¼šå¸®å¿™æ”¶æ‹¾æ¡Œå­ã€‚â€ä½ çš„è¿™ä¸ªæ‰¿è¯ºå°±ç±»ä¼¼äºä¸€ä¸ªâ€œæ¸…ç†é’©å­â€ï¼Œèšä¼šä¸»åŠæ–¹ä¼šè®°ä½è¿™ä¸ªæ‰¿è¯ºï¼Œå¹¶åœ¨èšä¼šç»“æŸæ—¶è°ƒç”¨å®ƒï¼Œå³å‘Šè¯‰ä½ å»æ‰§è¡Œæ”¶æ‹¾æ¡Œå­çš„å·¥ä½œã€‚</p><p>ä½†æ˜¯å¦‚æœåœ¨èšä¼šç»“æŸä¹‹å‰ï¼Œä½ ä¸å¾—ä¸æå‰ç¦»å¼€ï¼Œä½ å¯èƒ½éœ€è¦å‘ŠçŸ¥ä¸»åŠæ–¹ï¼šâ€œå˜¿ï¼Œæˆ‘å¾—èµ°äº†ï¼Œæ‰€ä»¥è¯·åˆ«æŒ‡æœ›æˆ‘æ¥æ”¶æ‹¾æ¡Œå­ã€‚â€è¿™æ ·ï¼Œä¸»åŠæ–¹å°±ä¼šä»ä»–ä»¬çš„å¾…åŠåˆ—è¡¨ä¸­ç§»é™¤ä½ çš„é‚£é¡¹ä»»åŠ¡ã€‚åœ¨ Node.js ä¸­ï¼Œä½¿ç”¨ <code>napi_remove_env_cleanup_hook</code> å°±æ˜¯æ‰§è¡Œè¿™ä¸ªâ€œé€šçŸ¥å–æ¶ˆâ€çš„åŠ¨ä½œã€‚</p><p>å®é™…ä½¿ç”¨çš„ä¾‹å­:</p><p>å‡è®¾ä½ ç¼–å†™äº†ä¸€ä¸ª Node.js çš„æœ¬åœ°æ’ä»¶ï¼Œå®ƒæ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨ Node.js ç¯å¢ƒæ¸…ç†æ—¶éœ€è¦ç¡®ä¿è¿™ä¸ªæ–‡ä»¶è¢«æ­£ç¡®å…³é—­ã€‚ä½ å¯èƒ½é¦–å…ˆä¼šç”¨ <code>napi_add_env_cleanup_hook</code> æ·»åŠ ä¸€ä¸ªæ¸…ç†é’©å­æ¥å…³é—­è¿™ä¸ªæ–‡ä»¶ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªå…³é—­æ–‡ä»¶çš„å‡½æ•°</span></span>
<span class="line"><span>void close_file(void* arg) {</span></span>
<span class="line"><span>  // ... å…³é—­æ–‡ä»¶çš„ä»£ç  ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œæ¸…ç†é’©å­</span></span>
<span class="line"><span>napi_status status = napi_add_env_cleanup_hook(env, close_file, nullptr);</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>  // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨è®¾æƒ³ï¼Œéšç€ä»£ç çš„è¿è¡Œï¼Œå‡ºäºæŸç§åŸå› ï¼Œä½ çš„æ’ä»¶åœ¨ Node.js ç¯å¢ƒç»“æŸä¹‹å‰å·²ç»å…³é—­äº†æ–‡ä»¶ï¼Œå¹¶ä¸”ä½ ç¡®å®šä¸å†éœ€è¦åœ¨ç¯å¢ƒæ¸…ç†æ—¶æ‰§è¡Œè¿™ä¸ªé’©å­ã€‚è¿™æ—¶ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨ <code>napi_remove_env_cleanup_hook</code> æ¥ç§»é™¤ä¹‹å‰è®¾ç½®çš„æ¸…ç†é’©å­ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// ç§»é™¤æ¸…ç†é’©å­</span></span>
<span class="line"><span>status = napi_remove_env_cleanup_hook(env, close_file, nullptr);</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>  // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ€»ç»“èµ·æ¥ï¼Œ<code>napi_remove_env_cleanup_hook</code> çš„ä½œç”¨å°±æ˜¯ä¸ºäº†æ’¤é”€é‚£äº›ä¸å†éœ€è¦åœ¨ Node.js ç¯å¢ƒç»“æŸæ—¶æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä»¥ç¡®ä¿èµ„æºå¾—åˆ°æ­£ç¡®çš„ç®¡ç†å’Œé‡Šæ”¾ã€‚</p><h4 id="napi-add-async-cleanup-hook" tabindex="-1"><a class="header-anchor" href="#napi-add-async-cleanup-hook"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_add_async_cleanup_hook" target="_blank" rel="noopener noreferrer">napi_add_async_cleanup_hook</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ª C è¯­è¨€çš„ API å±‚ï¼Œå®ƒå…è®¸ä½ ç¼–å†™åŸç”Ÿæ’ä»¶ã€‚åŸç”Ÿæ’ä»¶æ˜¯ä¸€äº›ç”¨ C æˆ– C++ç­‰ç¼–ç¨‹è¯­è¨€ç¼–å†™çš„æ¨¡å—ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨åº•å±‚æ“ä½œç³»ç»Ÿçš„ API æˆ–è€…æ‰§è¡Œä¸€äº› JavaScript å¼•æ“ä¸èƒ½ç›´æ¥æ‰§è¡Œçš„è®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€‚</p><p>åœ¨ Node.js ä¸­ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ä¼šå¯åŠ¨ä¸€äº›å¼‚æ­¥æ“ä½œï¼Œæ¯”å¦‚è¯»å–æ–‡ä»¶ã€å‘é€ç½‘ç»œè¯·æ±‚ç­‰ã€‚è¿™äº›æ“ä½œé€šå¸¸ç”± Node.js åå°çš„çº¿ç¨‹æ± å¤„ç†ã€‚ä½†æ˜¯å¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œå¯èƒ½éœ€è¦åœ¨è‡ªå·±çš„ä»£ç ä¸­åˆ›å»ºé¢å¤–çš„èµ„æºï¼Œæ¯”å¦‚åŠ¨æ€åˆ†é…å†…å­˜ã€æ‰“å¼€æ–‡ä»¶å¥æŸ„æˆ–æ•°æ®åº“è¿æ¥ç­‰ã€‚å½“ Node.js çš„è¿›ç¨‹é€€å‡ºæ—¶ï¼Œä½ éœ€è¦ç¡®ä¿æ¸…ç†è¿™äº›èµ„æºï¼Œä»¥é¿å…å†…å­˜æ³„éœ²æˆ–å…¶ä»–é—®é¢˜ã€‚</p><p><code>napi_add_async_cleanup_hook</code>å‡½æ•°æ­£æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œå­˜åœ¨ã€‚å®ƒå¯ä»¥æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“ Node.js çš„å¼‚æ­¥æ“ä½œå³å°†å®Œæˆå¹¶ä¸”è¿›ç¨‹å‡†å¤‡é€€å‡ºæ—¶ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥åœ¨å›è°ƒå‡½æ•°ä¸­åšä¸€äº›æ¸…ç†å·¥ä½œã€‚</p><p>ä½¿ç”¨<code>napi_add_async_cleanup_hook</code>çš„å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li><p><strong>å®šä¹‰æ¸…ç†å‡½æ•°</strong>: åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åŒ…å«äº†ä½ è¦æ‰§è¡Œçš„æ¸…ç†é€»è¾‘ã€‚</p></li><li><p><strong>æ³¨å†Œæ¸…ç†é’©å­</strong>: åœ¨ä½ çš„åŸç”Ÿæ¨¡å—çš„åˆé€‚ä½ç½®è°ƒç”¨<code>napi_add_async_cleanup_hook</code>ï¼Œå°†ä½ çš„æ¸…ç†å‡½æ•°å’Œä»»ä½•éœ€è¦ä¼ é€’ç»™å®ƒçš„æ•°æ®ä½œä¸ºå‚æ•°æä¾›ç»™è¿™ä¸ª APIã€‚</p></li><li><p><strong>æ‰§è¡Œæ¸…ç†</strong>: å½“ Node.js å‡†å¤‡é€€å‡ºæˆ–è€…æ¨¡å—è¢«å¸è½½æ—¶ï¼Œè¯¥æ¸…ç†å‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚</p></li></ol><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­æ¥è¯´æ˜è¿™ä¸ªè¿‡ç¨‹ï¼š</p><p>é¦–å…ˆï¼Œä½ å°†å®šä¹‰ä¸€ä¸ªæ¸…ç†å‡½æ•°ï¼Œä¾‹å¦‚ç”¨äºå…³é—­æ–‡ä»¶æè¿°ç¬¦ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>void cleanup_file_descriptor(void* arg) {</span></span>
<span class="line"><span>    int fd = *(int*)arg;</span></span>
<span class="line"><span>    close(fd); // å‡è®¾è¿™æ˜¯ä¸€ä¸ªå…³é—­æ–‡ä»¶æè¿°ç¬¦çš„æ ‡å‡†åº“å‡½æ•°</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åï¼Œåœ¨ä½ çš„æ¨¡å—åˆå§‹åŒ–æˆ–è€…åˆ›å»ºèµ„æºæ—¶ï¼Œä½ å°†æ³¨å†Œè¿™ä¸ªæ¸…ç†é’©å­ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_env env; // N-APIç¯å¢ƒå˜é‡ï¼Œé€šå¸¸ä»å‡½æ•°å‚æ•°è·å¾—</span></span>
<span class="line"><span>int* fd_ptr = malloc(sizeof(int)); // åŠ¨æ€åˆ†é…å†…å­˜å­˜æ”¾æ–‡ä»¶æè¿°ç¬¦</span></span>
<span class="line"><span>// ... ä½ çš„ä»£ç æ‰“å¼€æ–‡ä»¶ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨fd_ptræŒ‡å‘çš„å†…å­˜ä¸­</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œæ¸…ç†é’©å­</span></span>
<span class="line"><span>napi_status status = napi_add_async_cleanup_hook(env, cleanup_file_descriptor, fd_ptr, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ï¼Œæ— è®ºä½•æ—¶ä½ çš„æ¨¡å—è¢«å¸è½½æˆ–è€… Node.js è¿›ç¨‹é€€å‡ºï¼Œ<code>cleanup_file_descriptor</code>éƒ½ä¼šè¢«è°ƒç”¨æ¥å…³é—­æ–‡ä»¶å’Œé‡Šæ”¾èµ„æºã€‚</p><p>è¯·æ³¨æ„ï¼Œä½ éœ€è¦å¤„ç†å¥½æ‰€æœ‰å¯èƒ½çš„è¾¹ç•Œæƒ…å†µï¼Œæ¯”å¦‚æ¸…ç†å‡½æ•°è¢«è°ƒç”¨æ—¶èµ„æºå·²ç»æ¸…ç†è¿‡äº†ï¼Œæˆ–è€…åœ¨å¼‚æ­¥æ“ä½œå°šæœªå®Œæˆæ—¶è¿›ç¨‹é€€å‡ºç­‰æƒ…å†µã€‚æ­£ç¡®åœ°ç®¡ç†èµ„æºæ˜¯ç¼–å†™å¯é å’Œé«˜æ•ˆåŸç”Ÿæ¨¡å—çš„å…³é”®éƒ¨åˆ†ã€‚</p><h4 id="napi-remove-async-cleanup-hook" tabindex="-1"><a class="header-anchor" href="#napi-remove-async-cleanup-hook"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_remove_async_cleanup_hook" target="_blank" rel="noopener noreferrer">napi_remove_async_cleanup_hook</a></span></a></h4><p>å¥½çš„ï¼Œè®©æˆ‘æ¥è§£é‡Šä¸€ä¸‹ Node.js ä¸­çš„ <code>napi_remove_async_cleanup_hook</code> æ˜¯ä»€ä¹ˆä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ N-API æ˜¯ä»€ä¹ˆã€‚N-APIï¼ˆNode.js APIï¼‰æ˜¯ä¸€ä¸ªå†…ç½®äº Node.js çš„ C API å±‚ï¼Œå®ƒè®©ä½ å¯ä»¥ç”¨ C æˆ– C++ ç¼–å†™æ‰©å±•æ¨¡å—ï¼Œå¹¶ä¿è¯å¯¹ Node.js ä¸åŒç‰ˆæœ¬çš„å…¼å®¹æ€§ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒå…è®¸å¼€å‘è€…ç¼–å†™å¯è·¨ Node.js ç‰ˆæœ¬è¿è¡Œçš„åŸç”Ÿæ’ä»¶ã€‚</p><p>ç°åœ¨ï¼Œè°ˆè®º <code>napi_remove_async_cleanup_hook</code> è¿™ä¸ªå‡½æ•°ï¼Œå®ƒæ˜¯ N-API çš„ä¸€éƒ¨åˆ†ã€‚æ­¤å‡½æ•°ç”¨äºç§»é™¤ä¹‹å‰é€šè¿‡ <code>napi_add_async_cleanup_hook</code> æ·»åŠ çš„å¼‚æ­¥æ¸…ç†é’©å­ï¼ˆhookï¼‰ã€‚&quot;å¼‚æ­¥æ¸…ç†é’©å­&quot;æ˜¯ä¸€ç§åœ¨å¼‚æ­¥æ“ä½œå®Œæˆæ—¶æˆ– Node.js ç¯å¢ƒè¢«é”€æ¯æ—¶è°ƒç”¨çš„å‡½æ•°ï¼Œä¸»è¦ç”¨äºèµ„æºçš„æ¸…ç†å·¥ä½œã€‚</p><p>ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·çš„æœºåˆ¶ï¼Ÿæƒ³è±¡è¿™æ ·ä¸€ä¸ªæƒ…å†µï¼šä½ åˆ›å»ºäº†ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œé‡Œé¢æœ‰äº›å¼‚æ­¥æ“ä½œï¼Œæ¯”å¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œè¯·æ±‚ç­‰ã€‚è¿™äº›å¼‚æ­¥æ“ä½œå¯èƒ½ä¼šä½¿ç”¨åˆ°ä¸€äº›éœ€è¦æ‰‹åŠ¨é‡Šæ”¾çš„èµ„æºï¼Œå¦‚åŠ¨æ€åˆ†é…çš„å†…å­˜ã€æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„ç­‰ã€‚å¦‚æœä½ çš„æ’ä»¶åœ¨æ²¡å¤„ç†å®Œè¿™äº›æ“ä½œå°±è¢«å¸è½½äº†ï¼Œå°±éœ€è¦ç¡®ä¿è¿™äº›èµ„æºè¢«æ­£ç¡®åœ°é‡Šæ”¾ï¼Œé¿å…å†…å­˜æ³„æ¼ç­‰é—®é¢˜ã€‚è¿™å°±æ˜¯æ·»åŠ å¼‚æ­¥æ¸…ç†é’©å­çš„ç›®çš„ã€‚</p><p>å½“ä½ ä¸å†éœ€è¦è¿™äº›æ¸…ç†é’©å­æ—¶ï¼Œå°±å¯ä»¥ç”¨ <code>napi_remove_async_cleanup_hook</code> æ¥åˆ é™¤å®ƒä»¬ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨ä½ ç¡®å®šå¼‚æ­¥æ“ä½œå·²ç»å®Œå…¨æ¸…ç†å¹²å‡€ï¼Œæˆ–è€…ä½ çš„æ¨¡å—æ­£åœ¨è¢«å¸è½½å¹¶ä¸”ä½ æƒ³æ˜¾å¼åœ°è¿›è¡Œæ¸…ç†ã€‚</p><p>ä¸¾ä¸ªå®é™…çš„ä¾‹å­ï¼š</p><p>å‡è®¾ä½ çš„åŸç”Ÿæ‰©å±•æ¨¡å—ä¸­æœ‰ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œè¿™ä¸ªæ“ä½œåœ¨èƒŒåæ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶è¿›è¡Œäº†ä¸€äº›è¯»å†™æ“ä½œã€‚ä½ ä¼šä½¿ç”¨ <code>napi_add_async_cleanup_hook</code> æ¥æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå›è°ƒå‡½æ•°ä¸­å…³é—­æ–‡ä»¶å¥æŸ„ï¼Œå¹¶é‡Šæ”¾ä»»ä½•åˆ†é…çš„å†…å­˜ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å‡è®¾è¿™æ˜¯ä½ çš„æ¸…ç†å‡½æ•°</span></span>
<span class="line"><span>void cleanup_file(void* arg) {</span></span>
<span class="line"><span>  // è¿™é‡Œæˆ‘ä»¬å…³é—­æ–‡ä»¶å¹¶é‡Šæ”¾å†…å­˜</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åœ¨ä½ çš„å¼‚æ­¥æ“ä½œä¸­ï¼Œä½ æ·»åŠ äº†æ¸…ç†é’©å­</span></span>
<span class="line"><span>napi_status status = napi_add_async_cleanup_hook(env, cleanup_file, NULL, &amp;handle);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½†æ˜¯åœ¨æŸä¸ªæ—¶é—´ç‚¹ï¼Œä½ çŸ¥é“æ–‡ä»¶å·²ç»å®‰å…¨åœ°å…³é—­ï¼Œç›¸å…³èµ„æºä¹Ÿå·²ç»é‡Šæ”¾äº†ï¼Œå› æ­¤ä½ ä¸å†éœ€è¦æ¸…ç†é’©å­ã€‚è¿™æ—¶ä½ å°±å¯ä»¥è°ƒç”¨ <code>napi_remove_async_cleanup_hook</code> æ¥ç§»é™¤å®ƒï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// ç§»é™¤ä¹‹å‰æ·»åŠ çš„æ¸…ç†é’©å­</span></span>
<span class="line"><span>napi_status remove_status = napi_remove_async_cleanup_hook(env, handle);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>napi_remove_async_cleanup_hook</code> æ˜¯ N-API æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œè®©ä½ èƒ½å¤Ÿç®¡ç†å’Œç§»é™¤åœ¨åŸç”Ÿæ¨¡å—ä¸­æ·»åŠ çš„èµ„æºæ¸…ç†å›è°ƒï¼Œä¿è¯èµ„æºå¾—åˆ°å¦¥å–„å¤„ç†ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå®ƒå¸®åŠ©ä½ æ§åˆ¶ä½•æ—¶åœæ­¢ç›‘å¬å’Œæ‰§è¡Œæ¸…ç†å·¥ä½œï¼Œç‰¹åˆ«æ˜¯åœ¨ä½ ç¡®è®¤èµ„æºå·²ç»è¢«æ¸…ç†æˆ–è€…æ¨¡å—å³å°†å¸è½½æ—¶éå¸¸æœ‰ç”¨ã€‚</p><h3 id="finalization-on-the-exit-of-the-node-js-environment" tabindex="-1"><a class="header-anchor" href="#finalization-on-the-exit-of-the-node-js-environment"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#finalization-on-the-exit-of-the-nodejs-environment" target="_blank" rel="noopener noreferrer">Finalization on the exit of the Node.js environment</a></span></a></h3><p>Node.js æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨æœåŠ¡å™¨ç«¯çš„ JavaScript ç¯å¢ƒï¼Œå®ƒå…è®¸å¼€å‘è€…ä½¿ç”¨ JavaScript æ¥ç¼–å†™æœåŠ¡å™¨ç«¯ä»£ç ã€‚åœ¨ Node.js ä¸­æœ‰ä¸€ä¸ªåä¸º N-API çš„æ¥å£ï¼Œå®ƒå…è®¸åŸç”Ÿæ¨¡å—ï¼ˆé€šå¸¸æ˜¯ç”¨ C æˆ– C++ å†™çš„æ‰©å±•ï¼‰ä¸ JavaScript ä»£ç è¿›è¡Œäº¤äº’ã€‚</p><p>åœ¨ N-API ä¸­ï¼Œâ€œFinalizationâ€ä¸€è¯æŒ‡çš„æ˜¯ä¸€ä¸ªå¯¹è±¡çš„æ¸…ç†è¿‡ç¨‹ï¼Œå³å½“è¯¥å¯¹è±¡ä¸å†éœ€è¦æ—¶ï¼Œå°†å…¶å ç”¨çš„èµ„æºè¿›è¡Œé‡Šæ”¾çš„è¿‡ç¨‹ã€‚è¿™åœ¨å¤„ç†åŸç”Ÿèµ„æºå¦‚æ–‡ä»¶å¥æŸ„ã€ç½‘ç»œè¿æ¥æˆ–è€…å†…å­˜åˆ†é…æ—¶å°¤ä¸ºé‡è¦ï¼Œä»¥é¿å…å‡ºç°èµ„æºæ³„éœ²ï¼Œå³è¿™äº›èµ„æºæ²¡æœ‰è¢«é€‚å½“é‡Šæ”¾ï¼Œå¯¼è‡´å†…å­˜ç­‰èµ„æºçš„æµªè´¹ã€‚</p><p>åœ¨ Node.js v21.7.1 çš„æ–‡æ¡£ä¸­æåˆ°çš„â€œFinalization on the exit of the Node.js environmentâ€ç‰¹æŒ‡ Node.js åº”ç”¨ç¨‹åºé€€å‡ºæ—¶è§¦å‘çš„æ¸…ç†åŠ¨ä½œã€‚è¿™æ„å‘³ç€å½“ä½ çš„ Node.js ç¨‹åºç»“æŸè¿è¡Œæ—¶ï¼ŒN-API ä¼šç¡®ä¿æ‰€æœ‰æ³¨å†Œäº† finalizer çš„åŸç”Ÿå¯¹è±¡éƒ½å¾—åˆ°å¦¥å–„å¤„ç†ï¼Œå³ä½¿å®ƒä»¬è¿˜æ²¡æœ‰æ˜¾å¼åœ°é€šè¿‡åƒåœ¾å›æ”¶æœºåˆ¶è¢«æ¸…ç†ã€‚</p><p>è¿™ä¸ªåŠŸèƒ½çš„é‡è¦æ€§åœ¨äºï¼Œå®ƒä¿è¯äº†å³ä¾¿åœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼Œæ¯”å¦‚ç¨‹åºå´©æºƒæˆ–æ˜¯ç”±äºå…¶ä»–åŸå› æå‰é€€å‡ºæ—¶ï¼Œä»ç„¶èƒ½å¤Ÿé‡Šæ”¾æ‰æ‰€æœ‰çš„åŸç”Ÿèµ„æºã€‚</p><p>è®©æˆ‘ä»¬ä¸¾å‡ ä¸ªå®é™…çš„ä¾‹å­æ¥è¯´æ˜è¿™ä¸ªæ¦‚å¿µï¼š</p><ol><li><p><strong>æ•°æ®åº“è¿æ¥</strong>ï¼š<br> å‡è®¾ä½ æ­£åœ¨ä½¿ç”¨ä¸€ä¸ª Node.js çš„æ•°æ®åº“è¿æ¥åº“æ¥ä¸æ•°æ®åº“è¿›è¡Œäº¤äº’ã€‚æ¯ä¸ªæ•°æ®åº“è¿æ¥å¯èƒ½éƒ½ä¼šåœ¨ç³»ç»Ÿä¸­æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æˆ–è€…ç»´æŒä¸€ä¸ªç½‘ç»œå¥—æ¥å­—ã€‚å½“ä½ çš„ç¨‹åºæ­£å¸¸ç»“æŸæ—¶ï¼Œä½ å¯èƒ½ä¼šæ‰‹åŠ¨å…³é—­è¿™äº›è¿æ¥ã€‚ç„¶è€Œï¼Œå¦‚æœç¨‹åºéæ­£å¸¸é€€å‡ºï¼Œæ¯”å¦‚ç”±äºä¸€ä¸ªæœªæ•è·çš„å¼‚å¸¸ï¼Œé‚£ä¹ˆæ²¡æœ‰æ‰§è¡Œæ¸…ç†ä»£ç çš„è¯ï¼Œè¿™äº›æ•°æ®åº“è¿æ¥å¯èƒ½å°±ä¸ä¼šå…³é—­ã€‚ä½¿ç”¨ N-APIï¼Œå¹¶æ³¨å†Œäº†æ­£ç¡®çš„ finalizerï¼Œå¯ä»¥ä¿è¯åœ¨ Node.js ç¯å¢ƒé€€å‡ºæ—¶è¿™äº›è¿æ¥èƒ½å¤Ÿè¢«å…³é—­ã€‚</p></li><li><p><strong>ä¸´æ—¶æ–‡ä»¶æ¸…ç†</strong>ï¼š<br> ä½ çš„åº”ç”¨ç¨‹åºå¯èƒ½ä¼šåˆ›å»ºä¸´æ—¶æ–‡ä»¶æ¥å¤„ç†æ•°æ®ã€‚åœ¨åº”ç”¨ç¨‹åºçš„æ­£å¸¸å·¥ä½œæµç¨‹ä¸­ï¼Œè¿™äº›ä¸´æ—¶æ–‡ä»¶åœ¨ä½¿ç”¨å®Œä¹‹åä¼šè¢«åˆ é™¤ã€‚ä½†æ˜¯ï¼Œå¦‚æœç¨‹åºæ„å¤–é€€å‡ºï¼Œå¯èƒ½ä¼šç•™ä¸‹è¿™äº›æ²¡ç”¨çš„ä¸´æ—¶æ–‡ä»¶ã€‚é€šè¿‡åœ¨åŸç”Ÿæ¨¡å—ä¸­è®¾ç½® finalizerï¼Œæ— è®ºç¨‹åºæ­£å¸¸è¿˜æ˜¯å¼‚å¸¸é€€å‡ºï¼Œéƒ½èƒ½ä¿è¯è¿™äº›æ–‡ä»¶ä¼šåœ¨ Node.js ç¯å¢ƒé€€å‡ºæ—¶è¢«åˆ é™¤ã€‚</p></li><li><p><strong>è‡ªå®šä¹‰èµ„æºç®¡ç†</strong>ï¼š<br> å¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªå¯¹å¤–éƒ¨ç¡¬ä»¶ï¼ˆä¾‹å¦‚ USB è®¾å¤‡ï¼‰è¿›è¡Œæ“ä½œçš„åŸç”Ÿæ¨¡å—ï¼Œå½“ Node.js ç¯å¢ƒé€€å‡ºæ—¶ï¼Œä½ éœ€è¦ç¡®ä¿æ‰€æœ‰çš„ç¡¬ä»¶è¿æ¥è¢«æ­£ç¡®æ–­å¼€ï¼Œå¹¶ä¸”ç›¸å…³èµ„æºå¾—åˆ°é‡Šæ”¾ã€‚è®¾ç½® finalizer å¯ä»¥å¸®åŠ©ä½ åœ¨ç¯å¢ƒé€€å‡ºæ—¶æ‰§è¡Œå¿…è¦çš„èµ„æºæ¸…ç†åŠ¨ä½œã€‚</p></li></ol><p>æ€»ç»“ä¸€ä¸‹ï¼šâ€œFinalization on the exit of the Node.js environmentâ€æ˜¯å…³äºç¡®ä¿åœ¨ Node.js ç¯å¢ƒé€€å‡ºæ—¶ï¼Œæ‰€æœ‰çš„åŸç”Ÿèµ„æºéƒ½èƒ½å¤Ÿè¢«æ­£ç¡®é‡Šæ”¾çš„æœºåˆ¶ã€‚è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½ï¼Œå› ä¸ºå®ƒé˜²æ­¢äº†èµ„æºæ³„éœ²ï¼Œä¿æŠ¤äº†ç³»ç»Ÿçš„å¥åº·å’Œç¨³å®šæ€§ã€‚</p><h2 id="module-registration" tabindex="-1"><a class="header-anchor" href="#module-registration"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#module-registration" target="_blank" rel="noopener noreferrer">Module registration</a></span></a></h2><p>Node.js ä¸­çš„ Module registrationï¼ˆæ¨¡å—æ³¨å†Œï¼‰æ˜¯ä¸€ä¸ªå…³é”®çš„è¿‡ç¨‹ï¼Œç”¨äºå‘Šè¯‰ Node.js æœ‰å“ªäº›æ¨¡å—å¯ç”¨ï¼Œä»¥åŠå¦‚ä½•åœ¨éœ€è¦æ—¶åŠ è½½å’Œä½¿ç”¨è¿™äº›æ¨¡å—ã€‚Node.js ä½¿ç”¨ CommonJS è§„èŒƒæ¥ç»„ç»‡å’Œä½¿ç”¨æ¨¡å—ï¼Œè€Œ N-API æ˜¯ Node.js æä¾›çš„ä¸€å¥—ç¨³å®šçš„ APIï¼Œå…è®¸åŸç”Ÿæ’ä»¶ï¼ˆé€šå¸¸æ˜¯ C æˆ– C++ç¼–å†™çš„æ¨¡å—ï¼‰ä¸ Node.js ä»£ç æ— ç¼åœ°äº¤äº’ã€‚</p><p>åœ¨ Node.js v21.7.1 ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ N-API æ¥åˆ›å»ºåŸç”Ÿæ’ä»¶ï¼Œå¹¶é€šè¿‡æ¨¡å—æ³¨å†Œå°†è¿™äº›æ’ä»¶æš´éœ²ç»™ Node.js ç¯å¢ƒã€‚è®©æˆ‘ä»¬é€æ­¥è¯¦ç»†äº†è§£è¿™ä¸ªè¿‡ç¨‹ï¼š</p><h3 id="æ­¥éª¤-1-åˆ›å»ºåŸç”Ÿæ¨¡å—æºæ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-1-åˆ›å»ºåŸç”Ÿæ¨¡å—æºæ–‡ä»¶"><span>æ­¥éª¤ 1: åˆ›å»ºåŸç”Ÿæ¨¡å—æºæ–‡ä»¶</span></a></h3><p>é¦–å…ˆï¼Œä½ éœ€è¦ç”¨ C æˆ– C++ç¼–å†™ä½ çš„åŸç”Ÿæ¨¡å—ä»£ç ã€‚æ¯”å¦‚ï¼Œå‡è®¾ä½ æƒ³åˆ›å»ºä¸€ä¸ªç®€å•çš„åŸç”Ÿæ¨¡å—<code>hello</code>, å®ƒåªåšä¸€ä»¶äº‹ï¼šè¿”å›&quot;Hello, world!&quot;å­—ç¬¦ä¸²ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value HelloMethod(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value greeting;</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªJavaScriptå­—ç¬¦ä¸² &quot;Hello, world!&quot;</span></span>
<span class="line"><span>    status = napi_create_string_utf8(env, &quot;Hello, world!&quot;, NAPI_AUTO_LENGTH, &amp;greeting);</span></span>
<span class="line"><span>    if (status != napi_ok) return nullptr;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return greeting;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªç»“æ„ä½“å®šä¹‰äº†æ¨¡å—çš„å±æ€§å’Œæ–¹æ³•</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°</span></span>
<span class="line"><span>    status = napi_create_function(env, NULL, 0, HelloMethod, NULL, &amp;fn);</span></span>
<span class="line"><span>    if (status != napi_ok) return nullptr;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†ä¸Šé¢åˆ›å»ºçš„å‡½æ•°è®¾ç½®ä¸ºè¿™ä¸ªæ¨¡å—çš„å±æ€§ &quot;hello&quot;</span></span>
<span class="line"><span>    status = napi_set_named_property(env, exports, &quot;hello&quot;, fn);</span></span>
<span class="line"><span>    if (status != napi_ok) return nullptr;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°<code>HelloMethod</code>ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªåŒ…å«&quot;Hello, world!&quot;å­—ç¬¦ä¸²çš„ JavaScript å€¼ã€‚ç„¶ååœ¨<code>Init</code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬æŠŠ<code>HelloMethod</code>ä½œä¸ºæ¨¡å—çš„å¯¼å‡ºå‡½æ•°ï¼Œä½¿å¾—å½“æ¨¡å—è¢«åŠ è½½æ—¶ï¼Œå¯ä»¥é€šè¿‡<code>require</code>è°ƒç”¨è¯¥å‡½æ•°ã€‚</p><h3 id="æ­¥éª¤-2-ç¼–è¯‘åŸç”Ÿæ¨¡å—" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-2-ç¼–è¯‘åŸç”Ÿæ¨¡å—"><span>æ­¥éª¤ 2: ç¼–è¯‘åŸç”Ÿæ¨¡å—</span></a></h3><p>è¦ä½¿ç”¨è¿™ä¸ªåŸç”Ÿæ¨¡å—ï¼Œå®ƒå¿…é¡»è¢«ç¼–è¯‘æˆ Node.js å¯ä»¥åŠ è½½çš„æ ¼å¼ï¼ˆé€šå¸¸æ˜¯<code>.node</code>æ–‡ä»¶ï¼‰ã€‚è¿™é€šå¸¸æ˜¯é€šè¿‡å·¥å…·åƒ<code>node-gyp</code>æ¥å®Œæˆçš„ã€‚ä½ éœ€è¦ä¸€ä¸ª<code>binding.gyp</code>æ–‡ä»¶æ¥å‘Šè¯‰<code>node-gyp</code>å¦‚ä½•ç¼–è¯‘ä½ çš„æ¨¡å—ã€‚</p><h3 id="æ­¥éª¤-3-åŠ è½½å’Œä½¿ç”¨æ¨¡å—" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-3-åŠ è½½å’Œä½¿ç”¨æ¨¡å—"><span>æ­¥éª¤ 3: åŠ è½½å’Œä½¿ç”¨æ¨¡å—</span></a></h3><p>ç¼–è¯‘å®Œæˆåï¼Œä½ å¯ä»¥åƒä½¿ç”¨æ™®é€šçš„ JavaScript æ¨¡å—ä¸€æ ·åœ¨ Node.js ä¸­ä½¿ç”¨ä½ çš„åŸç”Ÿæ¨¡å—ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> helloAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/hello.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">helloAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">hello</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º &quot;Hello, world!&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡<code>require</code>åŠ è½½åŸç”Ÿæ¨¡å—åï¼Œä½ å°±å¯ä»¥è°ƒç”¨æ¨¡å—ä¸­å®šä¹‰çš„å‡½æ•°ï¼Œå°±åƒä¸Šé¢ä¾‹å­ä¸­çš„<code>helloAddon.hello()</code>ã€‚</p><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-4" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-4"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h3><ul><li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šå¦‚æœä½ çš„ Node.js åº”ç”¨ä¸­æœ‰ç‰¹åˆ«è®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡ï¼Œä½ å¯èƒ½ä¼šé€‰æ‹©ç”¨ C++æ¥å®ç°è¿™äº›éƒ¨åˆ†ä»¥æé«˜æ€§èƒ½ã€‚</li><li><strong>ç³»ç»Ÿçº§æ“ä½œ</strong>ï¼šæ¯”å¦‚ä½ éœ€è¦ç›´æ¥å’Œæ“ä½œç³»ç»Ÿåº•å±‚ API äº¤äº’ï¼Œé‚£ä¹ˆåŸç”Ÿæ¨¡å—ä¼šéå¸¸æœ‰ç”¨ã€‚</li><li><strong>ç¬¬ä¸‰æ–¹åº“çš„é›†æˆ</strong>ï¼šå¦‚æœå­˜åœ¨æŸäº›æ²¡æœ‰ JavaScript ç‰ˆæœ¬ä½†åŠŸèƒ½å¼ºå¤§çš„ C/C++åº“ï¼Œä½ å¯ä»¥é€šè¿‡ç¼–å†™åŸç”Ÿæ’ä»¶æ¥åœ¨ Node.js ä¸­ä½¿ç”¨è¿™äº›åº“ã€‚</li></ul><p>Node.js çš„åŸç”Ÿæ¨¡å—æ³¨å†Œæœºåˆ¶ä¸ºå¼€å‘è€…æä¾›äº†å¼ºå¤§çš„åŠŸèƒ½æ‰©å±•èƒ½åŠ›ï¼Œä½†åŒæ—¶ä¹Ÿæ¶‰åŠåˆ°æ›´å¤æ‚çš„ç¼–ç¨‹çŸ¥è¯†ï¼Œå¯èƒ½éœ€è¦å¯¹ C/C++åŠæ“ä½œç³»ç»Ÿæœ‰è¾ƒæ·±çš„ç†è§£ã€‚</p><h2 id="working-with-javascript-values" tabindex="-1"><a class="header-anchor" href="#working-with-javascript-values"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#working-with-javascript-values" target="_blank" rel="noopener noreferrer">Working with JavaScript values</a></span></a></h2><p>Node.js æ˜¯ä¸€ä¸ªè®© JavaScript å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œçš„å¹³å°ã€‚åœ¨ Node.js ä¸­ï¼Œä½ å¯ä»¥ç¼–å†™ JavaScript æ¥æ“æ§æœåŠ¡å™¨çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œé€šä¿¡ç­‰ã€‚å½“æˆ‘ä»¬åœ¨ Node.js ä¸­ä½¿ç”¨ JavaScript ç¼–å†™ä»£ç æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å¤„ç†å„ç§æ•°æ®å€¼ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²ã€æ•°å­—ã€å¯¹è±¡ç­‰ã€‚</p><p>ä¸ºäº†æ›´å¥½åœ°åœ¨åŸç”Ÿæ¨¡å—ä¸­ï¼ˆç”± C æˆ– C++ç¼–å†™çš„æ¨¡å—ï¼‰ä¸ JavaScript çš„æ•°æ®è¿›è¡Œäº¤äº’ï¼ŒNode.js æä¾›äº†ä¸€ä¸ª N-APIï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚N-API æä¾›äº†ä¸€ç³»åˆ—çš„å‡½æ•°ï¼Œä½¿å¾—åŸç”Ÿä»£ç èƒ½å¤Ÿåˆ›å»ºå’Œæ“ä½œ JavaScript ä¸­çš„å€¼ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€äº›åŸºæœ¬çš„ JavaScript å€¼æ“ä½œå’Œå¯¹åº”çš„ä¾‹å­ï¼š</p><ol><li><p>åˆ›å»º JavaScript èµ‹å€¼ï¼š<br> åœ¨åŸç”Ÿæ¨¡å—ä¸­ï¼Œä½ å¯èƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å­—ç¬¦ä¸²æˆ–è€…æ•°å­—ï¼Œå¹¶å°†å®ƒè¿”å›ç»™ JavaScript ç¯å¢ƒã€‚ä¾‹å¦‚ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value create_number(napi_env env) {</span></span>
<span class="line"><span>    napi_value num;</span></span>
<span class="line"><span>    napi_status status = napi_create_double(env, 123.456, &amp;num);</span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ›å»ºæ•°å­—</span></span>
<span class="line"><span>    if (status == napi_ok) {</span></span>
<span class="line"><span>        return num; // è¿”å›åˆ›å»ºçš„æ•°å­—</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>napi_create_double</code> å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ª JavaScript æ•°å­—ï¼Œå¹¶é€šè¿‡å‚æ•° <code>env</code>ï¼ˆè¡¨ç¤ºå½“å‰çš„æ‰§è¡Œç¯å¢ƒï¼‰å’Œ <code>num</code>ï¼ˆç”¨æ¥å­˜æ”¾åˆ›å»ºçš„ JavaScript æ•°å­—ï¼‰ã€‚</p></li><li><p>ä» JavaScript å€¼ä¸­è¯»å–æ•°æ®ï¼š<br> å¦‚æœä½ æƒ³ä» JavaScript ç¯å¢ƒä¼ é€’ç»™åŸç”Ÿæ¨¡å—çš„æ•°æ®ä¸­è¯»å–ä¿¡æ¯ï¼Œä½ å¯ä»¥ä½¿ç”¨ N-API æä¾›çš„å‡½æ•°æ¥åšåˆ°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ è¦è¯»å–ä¸€ä¸ªä» JavaScript ä¼ å…¥çš„æ•°å­—ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>void read_number(napi_env env, napi_value js_value) {</span></span>
<span class="line"><span>    double value;</span></span>
<span class="line"><span>    napi_status status = napi_get_value_double(env, js_value, &amp;value);</span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦æˆåŠŸè¯»å–æ•°å€¼</span></span>
<span class="line"><span>    if (status == napi_ok) {</span></span>
<span class="line"><span>        printf(&quot;Received number: %f\n&quot;, value);</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>napi_get_value_double</code> å‡½æ•°ç”¨äºè·å– JavaScript ä¼ å…¥çš„æ•°å€¼å¹¶å­˜å‚¨åœ¨å˜é‡ <code>value</code> ä¸­ã€‚</p></li><li><p>æ“ä½œ JavaScript å¯¹è±¡ï¼š<br> JavaScript ä¸­çš„å¯¹è±¡æ˜¯é”®å€¼å¯¹çš„é›†åˆï¼Œåœ¨åŸç”Ÿä»£ç ä¸­ï¼Œä½ ä¹Ÿå¯ä»¥åˆ›å»ºå’Œä¿®æ”¹è¿™æ ·çš„å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ è¦åˆ›å»ºä¸€ä¸ª JavaScript å¯¹è±¡å¹¶è®¾ç½®å±æ€§ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value create_object(napi_env env) {</span></span>
<span class="line"><span>    napi_value obj;</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºå¯¹è±¡</span></span>
<span class="line"><span>    status = napi_create_object(env, &amp;obj);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ·»åŠ ä¸€ä¸ªå±æ€§â€œnameâ€åˆ°å¯¹è±¡ä¸­</span></span>
<span class="line"><span>    if (status == napi_ok) {</span></span>
<span class="line"><span>        napi_value name;</span></span>
<span class="line"><span>        status = napi_create_string_utf8(env, &quot;Node.js&quot;, NAPI_AUTO_LENGTH, &amp;name);</span></span>
<span class="line"><span>        if (status == napi_ok) {</span></span>
<span class="line"><span>            status = napi_set_named_property(env, obj, &quot;name&quot;, name);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ•´ä¸ªè¿‡ç¨‹æ˜¯å¦æˆåŠŸ</span></span>
<span class="line"><span>    if (status == napi_ok) {</span></span>
<span class="line"><span>        return obj; // è¿”å›åˆ›å»ºçš„å¯¹è±¡</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ JavaScript å¯¹è±¡ <code>obj</code>ï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ª JavaScript å­—ç¬¦ä¸² <code>name</code>ï¼Œæœ€åï¼Œå®ƒå°† <code>name</code> æ·»åŠ åˆ° <code>obj</code> å¯¹è±¡ä½œä¸ºä¸€ä¸ªåä¸º <code>&quot;name&quot;</code> çš„å±æ€§ã€‚</p></li></ol><p>é€šè¿‡ä»¥ä¸Šç¤ºä¾‹ï¼Œä½ å¯ä»¥çœ‹åˆ° Node.js ä¸­çš„ N-API å¦‚ä½•å¸®åŠ©æˆ‘ä»¬åœ¨åŸç”Ÿæ¨¡å—ä¸ JavaScript ä¹‹é—´ä¼ é€’å’Œæ“ä½œæ•°æ®ã€‚è¿™ä½¿å¾— Node.js å¯ä»¥è¢«ç”¨äºæ›´åŠ å¤æ‚å’Œæ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ï¼Œå› ä¸ºåŸç”Ÿæ¨¡å—é€šå¸¸æ¯”çº¯ JavaScript ä»£ç æ‰§è¡Œå¾—æ›´å¿«ã€‚</p><h3 id="enum-types" tabindex="-1"><a class="header-anchor" href="#enum-types"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#enum-types" target="_blank" rel="noopener noreferrer">Enum types</a></span></a></h3><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚N-API çš„ç›®çš„æ˜¯å‡å°‘ç»´æŠ¤åŸç”Ÿæ’ä»¶æ—¶ Node.js ç‰ˆæœ¬æ›´è¿­å¯èƒ½å¼•å‘çš„é—®é¢˜ï¼Œå®ƒæä¾›äº†ä¸€å¥—ç¨³å®šçš„ API é›†åˆï¼Œä½¿å¾—æ’ä»¶ä¸ Node.js ç‰ˆæœ¬ä¹‹é—´æ›´åŠ è§£è€¦ã€‚</p><p>åœ¨ N-API ä¸­çš„ Enumï¼ˆæšä¸¾ï¼‰ç±»å‹æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç±»å‹ï¼Œå®ƒå…è®¸å¼€å‘è€…å®šä¹‰ä¸€ç»„å‘½åçš„å¸¸é‡ã€‚ä½¿ç”¨æšä¸¾å¯ä»¥æ›´æ¸…æ™°åœ°è¡¨è¾¾ä»£ç çš„æ„å›¾ï¼Œå¹¶é™åˆ¶å˜é‡å¯ä»¥æ¥å—çš„å€¼èŒƒå›´ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œè®©æˆ‘ä»¬æƒ³è±¡ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶æ¥å¤„ç†æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½éœ€è¦å¤„ç†ä¸åŒç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿé”™è¯¯ã€‚é€šå¸¸ï¼Œè¿™äº›é”™è¯¯å¯ä»¥åˆ†æˆè‹¥å¹²ç±»åˆ«ï¼Œä¾‹å¦‚ &quot;æƒé™é”™è¯¯&quot;ã€&quot;è·¯å¾„ä¸å­˜åœ¨&quot; å’Œ &quot;ç›˜æ»¡&quot; ç­‰ã€‚ä½¿ç”¨æšä¸¾ç±»å‹å¯ä»¥å¸®åŠ©ä½ é¢„å…ˆå®šä¹‰è¿™äº›é”™è¯¯ç±»åˆ«ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å®šä¹‰æšä¸¾ç±»å‹</span></span>
<span class="line"><span>enum FileSystemError {</span></span>
<span class="line"><span>  PERMISSION_ERROR,</span></span>
<span class="line"><span>  PATH_NOT_FOUND,</span></span>
<span class="line"><span>  DISK_FULL</span></span>
<span class="line"><span>};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åï¼Œåœ¨ä½ çš„ä»£ç ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™äº›æšä¸¾å€¼æ¥è¡¨ç¤ºç‰¹å®šçš„é”™è¯¯ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// ä½¿ç”¨æšä¸¾ç±»å‹</span></span>
<span class="line"><span>FileSystemError errorType = PATH_NOT_FOUND;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (errorType == PATH_NOT_FOUND) {</span></span>
<span class="line"><span>  // å¤„ç†è·¯å¾„ä¸å­˜åœ¨çš„é”™è¯¯</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ N-API ä¸­ï¼Œæœ‰å¾ˆå¤šå†…ç½®çš„æšä¸¾ç±»å‹ï¼Œå®ƒä»¬ä»£è¡¨äº† Node.js åŸç”Ÿå±‚é¢ä¸Šå„ç§ä¸åŒçš„å€¼å’ŒçŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œå½“åˆ›å»ºå¼‚æ­¥å·¥ä½œé˜Ÿåˆ—é¡¹ç›®æˆ–å¤„ç†å›è°ƒæ—¶ï¼Œä½ ä¼šç”¨åˆ°è¿™æ ·çš„æšä¸¾ç±»å‹ã€‚è¿™äº›æšä¸¾å€¼åœ¨ N-API æ–‡æ¡£ä¸­éƒ½æœ‰è¯¦ç»†çš„æè¿°ã€‚å®ƒä»¬é€šå¸¸ç”¨æ¥æŒ‡ç¤ºå¦‚ä½•å¤„ç† JavaScript å€¼å’ŒåŸç”Ÿå‡½æ•°è°ƒç”¨çš„ç»“æœã€‚</p><p>å‡è®¾ä½ è¦åˆ›å»ºä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°éœ€è¦åœ¨å®Œæˆæ—¶è¿”å›å…¶æ‰§è¡Œçš„ç»“æœï¼Œé‚£ä¹ˆä½ å¯èƒ½ä¼šä½¿ç”¨ <code>napi_status</code> æšä¸¾æ¥ä¼ é€’æ“ä½œçš„ç»“æœçŠ¶æ€ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¸€ä¸ªå¼‚æ­¥å‡½æ•°çš„ç¤ºä¾‹ï¼Œè¯¥å‡½æ•°åœ¨æ‰§è¡Œåä¼šè¿”å›çŠ¶æ€ç </span></span>
<span class="line"><span>napi_value SomeAsyncFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ...æ‰§è¡Œä¸€äº›æ“ä½œ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è·Ÿæ®æ‰§è¡Œç»“æœè®¾ç½®çŠ¶æ€</span></span>
<span class="line"><span>  status = (æ‰§è¡ŒæˆåŠŸ) ? napi_ok : napi_generic_failure;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›çŠ¶æ€ç å¯¹åº”çš„JavaScriptå€¼</span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span>  napi_create_int32(env, (int32_t)status, &amp;result);</span></span>
<span class="line"><span>  return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>napi_status</code> æ˜¯ N-API å®šä¹‰çš„ä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œå…¶ä¸­åŒ…å«äº†è¯¸å¦‚ <code>napi_ok</code>, <code>napi_invalid_arg</code>, <code>napi_object_expected</code> ç­‰ç­‰ï¼Œç”¨æ¥æŒ‡ç¤ºå‡½æ•°è°ƒç”¨çš„ç»“æœçŠ¶æ€ã€‚åœ¨å®é™…çš„å¼‚æ­¥å‡½æ•°ä¸­ï¼Œä½ ä¼šæ ¹æ®æ“ä½œçš„æˆåŠŸæˆ–å¤±è´¥ï¼Œè®¾ç½®ç›¸åº”çš„æšä¸¾å€¼ï¼Œç„¶åå°†è¿™ä¸ªå€¼è½¬æ¢æˆ JavaScript èƒ½å¤Ÿç†è§£çš„å½¢å¼ï¼Œè¿”å›ç»™è°ƒç”¨è€…ã€‚è¿™æ ·çš„è®¾è®¡å¯ä»¥è®©ä½ çš„åŸç”Ÿæ’ä»¶ä¸ JavaScript ä»£ç ä¹‹é—´æœ‰ä¸€ä¸ªæ¸…æ™°çš„äº¤äº’ç•Œé¢ã€‚</p><h4 id="napi-key-collection-mode" tabindex="-1"><a class="header-anchor" href="#napi-key-collection-mode"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_key_collection_mode" target="_blank" rel="noopener noreferrer">napi_key_collection_mode</a></span></a></h4><p>Node.js ä¸­çš„ N-API (Native API) æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIï¼Œå®ƒè®© JavaScript ä»£ç èƒ½å¤Ÿå’Œ C/C++ä»£ç äº¤äº’ï¼Œè¿™æ ·ä½ å°±å¯ä»¥ä½¿ç”¨ C/C++æ¥ç¼–å†™ä¸€äº›æ€§èƒ½æ•æ„Ÿæˆ–è€…éœ€è¦ç›´æ¥ä¸æ“ä½œç³»ç»Ÿåº•å±‚äº¤äº’çš„éƒ¨åˆ†ï¼Œå¹¶ä¸”åœ¨ Node.js ç¯å¢ƒä¸­è°ƒç”¨å®ƒä»¬ã€‚</p><p><code>napi_key_collection_mode</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œç”¨äºè®¾å®šå¦‚ä½•æ”¶é›†å¯¹äº Native å¯¹è±¡çš„ property keysã€‚åœ¨ JavaScript ä¸­ï¼Œå¯¹è±¡æ˜¯ç”±é”®å€¼å¯¹ç»„æˆçš„ï¼Œè€Œå½“æˆ‘ä»¬ä» C/C++ä»£ç ä¸­åˆ›å»ºæˆ–æ“ä½œ JavaScript å¯¹è±¡æ—¶ï¼Œå¯èƒ½éœ€è¦è€ƒè™‘åˆ°åƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼Œç®€ç§° GCï¼‰çš„é—®é¢˜ã€‚</p><p>æ‰€ä»¥ï¼Œ<code>napi_key_collection_mode</code> æœ‰ä»¥ä¸‹ä¸¤ç§æ¨¡å¼ï¼š</p><ol><li><code>napi_key_include_prototypes</code>ï¼šè¿™ä¸ªæ¨¡å¼æ„å‘³ç€å½“æ”¶é›†å¯¹è±¡çš„ keys æ—¶ï¼Œä¼šåŒ…æ‹¬è¯¥å¯¹è±¡åŸå‹é“¾ä¸Šçš„ keysã€‚</li><li><code>napi_key_own_only</code>ï¼šè¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œåˆ™åªä¼šæ”¶é›†å¯¹è±¡è‡ªèº«çš„ keysï¼Œè€Œä¸åŒ…æ‹¬å…¶åŸå‹é“¾ä¸Šçš„ä»»ä½• keysã€‚</li></ol><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ä½ åœ¨ C/C++æ’ä»¶ä¸­åˆ›å»ºäº†ä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œå¹¶ä¸”æƒ³è¦è·å–å®ƒçš„å±æ€§é”®åˆ—è¡¨ã€‚å¦‚æœä½ é€‰æ‹©<code>napi_key_include_prototypes</code>æ¨¡å¼ï¼Œä½ å¾—åˆ°çš„åˆ—è¡¨å°†åŒ…æ‹¬å¯¹è±¡æœ¬èº«çš„ keys åŠ ä¸Šå®ƒç»§æ‰¿çš„æ‰€æœ‰ keysï¼ˆä¾‹å¦‚ï¼Œæ¥è‡ªå®ƒçš„åŸå‹æˆ–<code>prototype</code>å±æ€§ï¼‰ã€‚å¦‚æœä½ é€‰æ‹©<code>napi_key_own_only</code>ï¼Œé‚£ä¹ˆä½ åªä¼šå¾—åˆ°å¯¹è±¡è‡ªå·±çš„ keysï¼Œä¸åŒ…å«ç»§æ‰¿çš„ã€‚</p><p>åœ¨å®é™…çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œè¿™ä¸ªåŠŸèƒ½å¯èƒ½è¢«ç”¨åœ¨æ’ä»¶éœ€è¦è¯¦å°½åœ°æ£€æŸ¥ JavaScript å¯¹è±¡çš„æƒ…å†µä¸‹ã€‚æ¯”å¦‚ï¼Œå¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªæ’ä»¶æ¥åºåˆ—åŒ–ä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œé‚£ä¹ˆä½ å¯èƒ½éœ€è¦æ ¹æ®æ˜¯å¦å¸Œæœ›åŒ…æ‹¬åŸå‹é“¾ä¸Šçš„å±æ€§æ¥é€‰æ‹©åˆé€‚çš„<code>napi_key_collection_mode</code>ã€‚</p><p>è¿™é‡Œæ˜¯ä¸€ä¸ªç®€åŒ–çš„ç¤ºä¾‹ä»£ç ç‰‡æ®µï¼ˆå¹¶éå®Œæ•´ç¨‹åºï¼‰ï¼Œå®ƒå±•ç¤ºäº†å¦‚ä½•åœ¨ C/C++ä¸­ä½¿ç”¨<code>napi_key_collection_mode</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... çœç•¥å…¶ä»–å¿…é¡»çš„å‡½æ•°å’Œé”™è¯¯å¤„ç† ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value GetOwnPropertyKeys(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–JavaScriptä¼ é€’çš„å¯¹è±¡</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥å‚æ•°æ•°é‡å’Œç±»å‹ç­‰...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ•°ç»„æ¥å­˜æ”¾å¯¹è±¡çš„keys</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    status = napi_get_property_names(env, args[0], &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è®¾ç½®key collection modeä¸ºä»…åŒ…æ‹¬å¯¹è±¡è‡ªèº«çš„keys</span></span>
<span class="line"><span>    status = napi_set_property_names_enum(env, args[0], napi_key_own_only);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ... è¿˜æœ‰æ›´å¤šçš„æµç¨‹å’Œé”™è¯¯å¤„ç† ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return result; // è¿”å›keysæ•°ç»„</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ<code>GetOwnPropertyKeys</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè¯•å›¾ä» Node.js ä¼ å…¥çš„å¯¹è±¡ä¸­è·å–æ‰€æœ‰çš„è‡ªèº«å±æ€§ keysã€‚æˆ‘ä»¬é¦–å…ˆè·å¾—äº† JS ä¼ é€’ç»™æˆ‘ä»¬çš„å¯¹è±¡ï¼Œç„¶åä½¿ç”¨<code>napi_get_property_names</code>è·å–å±æ€§ keysï¼Œå¹¶é€šè¿‡<code>napi_set_property_names_enum</code>è®¾ç½®æˆ‘ä»¬æƒ³è¦çš„ key collection æ¨¡å¼ã€‚æœ€ç»ˆè¿”å›äº†ä¸€ä¸ªåŒ…å«æ‰€æœ‰è‡ªèº«å±æ€§ keys çš„æ•°ç»„ã€‚</p><p>è¯·æ³¨æ„ï¼Œç”±äºè¿™ä¸ªç‰¹æ€§æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒé€šå¸¸åœ¨ç›¸å¯¹åº•å±‚çš„åœºæ™¯ä¸­ä½¿ç”¨ï¼Œå¹¶ä¸”è¿™é‡Œçš„ä»£ç åªæ˜¯ä¸ºäº†è§£é‡Š<code>napi_key_collection_mode</code>æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå®é™…ä½¿ç”¨ä¸­éœ€è¦è€ƒè™‘é”™è¯¯å¤„ç†å’Œå†…å­˜ç®¡ç†ç­‰é—®é¢˜ã€‚</p><h4 id="napi-key-filter" tabindex="-1"><a class="header-anchor" href="#napi-key-filter"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_key_filter" target="_blank" rel="noopener noreferrer">napi_key_filter</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚ä¸€ä¸ªåŸç”Ÿæ’ä»¶æ˜¯ä¸€ä¸ªå¯ä»¥ç›´æ¥è°ƒç”¨ C/C++ä»£ç çš„ JavaScript æ¨¡å—ï¼Œè¿™ä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿç¼–å†™æ€§èƒ½å…³é”®å‹æ“ä½œï¼Œæˆ–æ˜¯éœ€è¦ä½¿ç”¨åˆ°ç³»ç»Ÿåº•å±‚åŠŸèƒ½çš„åº”ç”¨ç¨‹åºã€‚</p><p>åœ¨ N-API ä¸­æœ‰ä¸€ä¸ªæ¦‚å¿µå«â€œå±æ€§é”®è¿‡æ»¤â€ï¼ˆProperty Key Filteringï¼‰ï¼Œè¿™æ¶‰åŠåˆ°åœ¨æ“ä½œå¯¹è±¡æ—¶ç­›é€‰å‡ºå“ªäº›å±æ€§é”®ï¼ˆå³å¯¹è±¡çš„å±æ€§åï¼‰æ˜¯æˆ‘ä»¬æ„Ÿå…´è¶£çš„ã€‚<code>napi_key_filter</code>æ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œå®ƒå®šä¹‰äº†ä¸åŒçš„ç­›é€‰é€‰é¡¹ï¼Œè®©ä½ èƒ½å¤Ÿæ›´ç²¾å‡†åœ°æ§åˆ¶å“ªäº›é”®è¢«åŒ…å«åœ¨æŸäº›ç‰¹å®š N-API å‡½æ•°çš„æ“ä½œä¸­ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€äº›<code>napi_key_filter</code>å¯èƒ½çš„é€‰é¡¹ï¼š</p><ul><li><code>napi_key_all_properties</code>: ä¸è¿›è¡Œè¿‡æ»¤ï¼ŒåŒ…æ‹¬æ‰€æœ‰çš„å±æ€§ã€‚</li><li><code>napi_key_own_only</code>: åªåŒ…æ‹¬å¯¹è±¡è‡ªå·±çš„å±æ€§ï¼Œä¸åŒ…æ‹¬ä»åŸå‹é“¾ç»§æ‰¿çš„å±æ€§ã€‚</li><li><code>napi_key_writable</code>: åªåŒ…æ‹¬å¯å†™çš„å±æ€§ã€‚</li><li><code>napi_key_enumerable</code>: åªåŒ…æ‹¬å¯æšä¸¾çš„å±æ€§ã€‚</li><li><code>napi_key_skip_strings</code>: è·³è¿‡å­—ç¬¦ä¸²é”®ï¼Œåªå…³æ³¨ Symbol é”®ã€‚</li><li><code>napi_key_skip_symbols</code>: è·³è¿‡ Symbol é”®ï¼Œåªå…³æ³¨å­—ç¬¦ä¸²é”®ã€‚</li></ul><p>å®é™…è¿ç”¨ä¸¾ä¾‹ï¼š</p><ol><li><p><strong>è·å–å¯¹è±¡çš„æ‰€æœ‰è‡ªæœ‰å±æ€§</strong>:</p><p>å¦‚æœä½ æƒ³è·å–ä¸€ä¸ªå¯¹è±¡ä¸Šæ‰€æœ‰å±äºè¯¥å¯¹è±¡æœ¬èº«çš„å±æ€§ï¼ˆä¸åŒ…æ‹¬é‚£äº›é€šè¿‡åŸå‹é“¾ç»§æ‰¿æ¥çš„ï¼‰ï¼Œä½ å¯ä»¥ç»“åˆä½¿ç”¨<code>napi_key_own_only</code>å’Œä¸€äº›ç›¸å…³çš„ N-API å‡½æ•°ã€‚</p></li><li><p><strong>æšä¸¾å¯å†™å±æ€§</strong>:</p><p>ä½ å¯èƒ½æ­£æ„å»ºä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œéœ€è¦å¤åˆ¶ä¸€ä¸ª JavaScript å¯¹è±¡çš„å±æ€§åˆ° C++å¯¹è±¡ä¸­å»ã€‚ä½†ä½ åªå¸Œæœ›å¤åˆ¶é‚£äº›å¯å†™çš„å±æ€§ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>napi_key_writable</code>ä½œä¸ºè¿‡æ»¤å™¨ã€‚</p></li><li><p><strong>é¿å¼€ Symbols</strong>:</p><p>JavaScript ä¸­çš„ Symbol æ˜¯å”¯ä¸€çš„ï¼Œä¸èƒ½è¢«å¸¸è§„å­—ç¬¦ä¸²é”®æ±¡æŸ“ã€‚å¦‚æœä½ çš„åº”ç”¨é€»è¾‘éœ€è¦è·³è¿‡å¤„ç† Symbol é”®ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>napi_key_skip_symbols</code>ã€‚</p></li></ol><p>ç¤ºä¾‹ä»£ç ç‰‡æ®µï¼ˆå¹¶éå®Œæ•´ç¨‹åºï¼‰:</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ env å’Œ object æ˜¯å·²ç»å®šä¹‰å¥½çš„å˜é‡</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è·å–å¯¹è±¡çš„æ‰€æœ‰è‡ªæœ‰å±æ€§</span></span>
<span class="line"><span>napi_value result;</span></span>
<span class="line"><span>napi_status status = napi_get_property_names(env, object, napi_key_own_only, &amp;result);</span></span>
<span class="line"><span>if (status == napi_ok) {</span></span>
<span class="line"><span>  // ä½¿ç”¨ result è¿™é‡Œä»£è¡¨åŒ…å«äº†æ‰€æœ‰è‡ªæœ‰å±æ€§çš„æ•°ç»„</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ­¤å¤„çš„ä»£ç éœ€è¦é…åˆå®Œæ•´çš„N-APIä½¿ç”¨ç¯å¢ƒæ¥å·¥ä½œ</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä»…ç”¨äºè¯´æ˜å¦‚ä½•åœ¨ C++ä¸­ä½¿ç”¨<code>napi_key_own_only</code>è¿‡æ»¤å™¨ä¸ N-API ç›¸ç»“åˆè¿›è¡Œæ“ä½œã€‚å¼€å‘è€…éœ€è¦æä¾›å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œç¯å¢ƒè®¾ç½®ä»£ç ä»¥ç¡®ä¿å…¶æ­£ç¡®è¿è¡Œã€‚è®°ä½ï¼Œè¿™äº›æ¥å£æ˜¯é¢å‘ C/C++å¼€å‘è€…çš„ï¼Œå¯¹äºåˆå­¦è€…æ¥è¯´å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´å»ç†Ÿæ‚‰å’Œç†è§£ã€‚</p><h4 id="napi-key-conversion" tabindex="-1"><a class="header-anchor" href="#napi-key-conversion"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_key_conversion" target="_blank" rel="noopener noreferrer">napi_key_conversion</a></span></a></h4><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 JavaScript å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œå®ƒå…è®¸åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚N-APIï¼ˆNode APIï¼‰æ˜¯ Node.js æä¾›çš„ä¸€ç»„ C APIï¼Œä½¿å¾—æœ¬åœ°æ’ä»¶ï¼ˆé€šå¸¸ç”¨ C æˆ– C++ç¼–å†™ï¼‰å¯ä»¥ä¸å—ç‰¹å®šç‰ˆæœ¬ Node.js å½±å“åœ°è¿è¡Œã€‚</p><p><code>napi_key_conversion</code> å¹¶ä¸æ˜¯ Node.js v21.7.1 ä¸­ç‰¹å®šçš„åŠŸèƒ½ï¼Œè€Œæ˜¯æŒ‡ N-API å½“ä¸­ä¸é”®è½¬æ¢ç›¸å…³çš„å¤šä¸ªå‡½æ•°ã€‚è¿™äº›å‡½æ•°è¢«ç”¨æ¥å°† JavaScript ä¸­çš„å¯¹è±¡å±æ€§åï¼ˆkeysï¼‰è½¬æ¢ä¸ºé€‚åˆæœ¬åœ°æ’ä»¶ä½¿ç”¨çš„æ ¼å¼ï¼Œæˆ–åä¹‹ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™ä½¿å¾— JavaScript ä»£ç å’Œæœ¬åœ°æ’ä»¶èƒ½å¤Ÿç›¸äº’äº¤æ¢æ•°æ®ã€‚</p><p>ä¸¾å‡ ä¸ªå®é™…ä¾‹å­æ¥è¯´æ˜ï¼š</p><ol><li><p><strong>è¯»å– JavaScript å¯¹è±¡å±æ€§</strong>ï¼šä½ å¯èƒ½åœ¨ C/C++ æ’ä»¶ä¸­éœ€è¦è¯»å–ä¸€ä¸ªä» JavaScript ä¼ å…¥çš„å¯¹è±¡çš„å±æ€§ã€‚ä½¿ç”¨ N-API ä¸­çš„é”®è½¬æ¢å‡½æ•°ï¼Œä½ å¯ä»¥å°† JavaScript çš„å­—ç¬¦ä¸²å±æ€§åè½¬æ¢ä¸ºä¸€ä¸ª N-API å¯ä»¥ç†è§£çš„è¡¨ç¤ºå½¢å¼ï¼Œç„¶åè·å–è¯¥å±æ€§çš„å€¼ã€‚</p></li><li><p><strong>è®¾ç½® JavaScript å¯¹è±¡å±æ€§</strong>ï¼šç›¸å¯¹åœ°ï¼Œå¦‚æœä½ æƒ³åœ¨æœ¬åœ°æ’ä»¶ä¸­åˆ›å»ºæˆ–ä¿®æ”¹ JavaScript å¯¹è±¡çš„å±æ€§ï¼Œä½ å¯ä»¥å…ˆå°†å±æ€§åè½¬æ¢ä¸º N-API çš„é”®è¡¨ç¤ºï¼Œç„¶åè®¾ç½®å…¶å€¼ã€‚</p></li><li><p><strong>å¤„ç† JavaScript Map æˆ– Set</strong>ï¼šå½“ JavaScript çš„ Map æˆ– Set æ•°æ®ç»“æ„ä¸æœ¬åœ°æ’ä»¶äº¤äº’æ—¶ï¼Œä½ å¯èƒ½éœ€è¦å°† JavaScript çš„å€¼è½¬æ¢ä¸ºé€‚å½“çš„é”®ï¼Œä»¥ä¾¿åœ¨ C/C++ æ’ä»¶ä¸­ä½¿ç”¨è¿™äº›é›†åˆã€‚</p></li></ol><p>è¯·æ³¨æ„ï¼Œç”±äºæˆ‘ä¸èƒ½æä¾›è¶…å‡ºçŸ¥è¯†æˆªæ­¢æ—¥æœŸèŒƒå›´çš„å…·ä½“ä¿¡æ¯ï¼Œæ‰€è¿°å†…å®¹ä»…åŸºäº Node.js å’Œ N-API åœ¨è¯¥æ—¶é—´ç‚¹ä¹‹å‰çš„é€šç”¨æ¦‚å¿µè¿›è¡Œäº†è§£é‡Šã€‚å¦‚éœ€æœ€æ–°è¯¦æƒ…ï¼Œè¯·å‚è€ƒ Node.js çš„å®˜æ–¹æ–‡æ¡£ã€‚</p><h4 id="napi-valuetype" tabindex="-1"><a class="header-anchor" href="#napi-valuetype"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_valuetype" target="_blank" rel="noopener noreferrer">napi_valuetype</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚åŸç”Ÿæ’ä»¶æ˜¯å¯ä»¥ç›´æ¥ä¸ Node.js è¿è¡Œæ—¶è¿›è¡Œäº¤äº’çš„ C æˆ– C++ä»£ç æ¨¡å—ï¼Œå®ƒä»¬é€šå¸¸ç”¨äºæ‰§è¡Œè®¡ç®—å¯†é›†å‹ä»»åŠ¡æˆ–è¿›è¡Œç³»ç»Ÿçº§æ“ä½œï¼Œæ¯”å¦‚è®¿é—®ç¡¬ä»¶ã€‚</p><p><code>napi_valuetype</code>æ˜¯ N-API æä¾›çš„æšä¸¾ç±»å‹ä¹‹ä¸€ï¼Œç”¨äºè¡¨ç¤º JavaScript å€¼åœ¨åŸç”Ÿä»£ç ä¸­çš„ç±»å‹ã€‚åœ¨ JavaScript ä¸­ï¼Œå„ç§æ•°æ®ç±»å‹ï¼ˆå¦‚æ•°å­—ã€å­—ç¬¦ä¸²ã€å¯¹è±¡ç­‰ï¼‰éƒ½å¯ä»¥é€šè¿‡ N-API åœ¨åŸç”Ÿä»£ç é‡Œæœ‰å¯¹åº”çš„è¡¨ç¤ºæ–¹æ³•ã€‚äº†è§£ä¸€ä¸ª JavaScript å€¼çš„å…·ä½“ç±»å‹å¯¹äºåŸç”Ÿæ’ä»¶çš„ç¼–å†™æ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºä¸åŒçš„ç±»å‹åœ¨åŸç”Ÿå±‚é¢ä¸Šå¯èƒ½éœ€è¦ä¸åŒçš„å¤„ç†æ–¹å¼ã€‚</p><h3 id="napi-valuetype-æšä¸¾" tabindex="-1"><a class="header-anchor" href="#napi-valuetype-æšä¸¾"><span><code>napi_valuetype</code> æšä¸¾</span></a></h3><p>è¿™ä¸ªæšä¸¾åŒ…æ‹¬äº†ä¸€ç³»åˆ—é¢„å®šä¹‰çš„å€¼ï¼Œæ¯ä¸€ä¸ªéƒ½ä»£è¡¨äº†ä¸€ä¸ª JavaScript å€¼çš„ç±»å‹ã€‚ä¸‹é¢æ˜¯ä¸€äº›ä¾‹å­ï¼š</p><ul><li><code>napi_undefined</code>: è¡¨ç¤º JavaScript çš„<code>undefined</code>ç±»å‹ã€‚</li><li><code>napi_null</code>: è¡¨ç¤º JavaScript çš„<code>null</code>ç±»å‹ã€‚</li><li><code>napi_boolean</code>: è¡¨ç¤º JavaScript çš„å¸ƒå°”ç±»å‹ï¼ˆ<code>true</code>æˆ–<code>false</code>ï¼‰ã€‚</li><li><code>napi_number</code>: è¡¨ç¤º JavaScript çš„æ•°å€¼ç±»å‹ã€‚</li><li><code>napi_string</code>: è¡¨ç¤º JavaScript çš„å­—ç¬¦ä¸²ç±»å‹ã€‚</li><li><code>napi_symbol</code>: è¡¨ç¤º JavaScript çš„ Symbol ç±»å‹ã€‚</li><li><code>napi_object</code>: è¡¨ç¤º JavaScript çš„å¯¹è±¡ç±»å‹ã€‚</li><li><code>napi_function</code>: è¡¨ç¤º JavaScript çš„å‡½æ•°ç±»å‹ã€‚</li><li><code>napi_external</code>: è¡¨ç¤ºä¸€ä¸ªå¤–éƒ¨ç±»å‹ï¼Œè¿™é€šå¸¸ç”¨äºè¡¨ç¤ºä¸€ä¸ª C/C++æ•°æ®ç»“æ„ç»‘å®šåˆ°ä¸€ä¸ª JavaScript å¯¹è±¡ã€‚</li></ul><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-5" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-5"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h3><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œå¹¶ä¸”æˆ‘ä»¬æƒ³è¦è·å–ä» JavaScript ä¼ é€’ç»™æˆ‘ä»¬çš„å€¼çš„ç±»å‹ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨<code>napi_valuetype</code>æ¥ç¡®å®šä¸€ä¸ª JavaScript å€¼çš„ç±»å‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªnapi_valueç±»å‹çš„å˜é‡`value`ä»£è¡¨ä¸€ä¸ªJSä¼ é€’è¿‡æ¥çš„å€¼</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_valuetype valueType;</span></span>
<span class="line"><span>napi_status status = napi_typeof(env, value, &amp;valueType);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (status == napi_ok) {</span></span>
<span class="line"><span>  switch (valueType) {</span></span>
<span class="line"><span>    case napi_undefined:</span></span>
<span class="line"><span>      // å¤„ç†undefinedå€¼</span></span>
<span class="line"><span>      break;</span></span>
<span class="line"><span>    case napi_null:</span></span>
<span class="line"><span>      // å¤„ç†nullå€¼</span></span>
<span class="line"><span>      break;</span></span>
<span class="line"><span>    case napi_boolean:</span></span>
<span class="line"><span>      // å¤„ç†å¸ƒå°”å€¼</span></span>
<span class="line"><span>      break;</span></span>
<span class="line"><span>    case napi_number:</span></span>
<span class="line"><span>      // å¤„ç†æ•°å€¼</span></span>
<span class="line"><span>      break;</span></span>
<span class="line"><span>    case napi_string:</span></span>
<span class="line"><span>      // å¤„ç†å­—ç¬¦ä¸²</span></span>
<span class="line"><span>      break;</span></span>
<span class="line"><span>    case napi_symbol:</span></span>
<span class="line"><span>      // å¤„ç†Symbol</span></span>
<span class="line"><span>      break;</span></span>
<span class="line"><span>    case napi_object:</span></span>
<span class="line"><span>      // å¤„ç†å¯¹è±¡</span></span>
<span class="line"><span>      break;</span></span>
<span class="line"><span>    case napi_function:</span></span>
<span class="line"><span>      // å¤„ç†å‡½æ•°</span></span>
<span class="line"><span>      break;</span></span>
<span class="line"><span>    case napi_external:</span></span>
<span class="line"><span>      // å¤„ç†å¤–éƒ¨ç»‘å®šçš„æ•°æ®ç»“æ„</span></span>
<span class="line"><span>      break;</span></span>
<span class="line"><span>    default:</span></span>
<span class="line"><span>      // æœªçŸ¥ç±»å‹</span></span>
<span class="line"><span>      break;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>} else {</span></span>
<span class="line"><span>  // å¤„ç†è·å–ç±»å‹å¤±è´¥çš„æƒ…å†µ</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨<code>napi_typeof</code>æ¥è·å–ä¸€ä¸ª<code>napi_value</code>å¯¹åº”çš„ç±»å‹ï¼Œå¹¶ä¸”æ ¹æ®è¿™ä¸ªç±»å‹æ‰§è¡Œä¸åŒçš„é€»è¾‘å¤„ç†ã€‚ è¿™åœ¨åŸç”Ÿæ’ä»¶å¼€å‘ä¸­æ˜¯å¾ˆå¸¸è§çš„åœºæ™¯ï¼Œç‰¹åˆ«æ˜¯å½“ä½ éœ€è¦å¤„ç†ä» JavaScript ä¼ é€’è¿‡æ¥çš„å¤šç§ç±»å‹çš„å‚æ•°æ—¶ã€‚</p><p>é€šè¿‡æ­£ç¡®åœ°è¯†åˆ«å’Œå¤„ç†ä¸åŒçš„ JavaScript å€¼ç±»å‹ï¼ŒåŸç”Ÿæ’ä»¶å°±èƒ½å¤Ÿæ›´å®‰å…¨å’Œæœ‰æ•ˆåœ°æ‰§è¡Œå…¶ä»»åŠ¡ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ›´å¥½åœ°ä¸ JavaScript ä»£ç è¿›è¡Œäº¤äº’ã€‚</p><h4 id="napi-typedarray-type" tabindex="-1"><a class="header-anchor" href="#napi-typedarray-type"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_typedarray_type" target="_blank" rel="noopener noreferrer">napi_typedarray_type</a></span></a></h4><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬æ¥è¯¦ç»†äº†è§£ä¸€ä¸‹ Node.js v21.7.1 ä¸­çš„ <code>napi_typedarray_type</code>ã€‚</p><p>é¦–å…ˆï¼ŒN-API æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚å®ƒå…è®¸ä½ ä½¿ç”¨ C æˆ–è€… C++ è¯­è¨€æ¥ç¼–å†™å¯ä»¥ç›´æ¥å’Œ JavaScript äº¤äº’çš„ä»£ç ç‰‡æ®µï¼Œè¿™é€šå¸¸åœ¨æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜æˆ–è€…éœ€è¦ä½¿ç”¨ç³»ç»Ÿçº§èµ„æºçš„æ—¶å€™ä¼šéå¸¸æœ‰ç”¨ã€‚<code>napi_typedarray_type</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œç”¨æ¥è·å–ä¸€ä¸ª TypedArray çš„ç±»å‹ã€‚</p><p>TypedArray æ˜¯ JavaScript ä¸­çš„ä¸€ä¸ªç‰¹æ®Šçš„æ•°ç»„å¯¹è±¡ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªåº•å±‚çš„äºŒè¿›åˆ¶ç¼“å†²åŒºï¼ˆbinary bufferï¼‰ï¼Œå¯ä»¥ç”¨æ¥å­˜å‚¨å¤šç§ä¸åŒç±»å‹çš„æ•°æ®ï¼Œä¾‹å¦‚æ•´æ•°æˆ–æµ®ç‚¹æ•°ï¼Œå¹¶ä¸”æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½æ“ä½œã€‚ä¸åŒç±»å‹çš„ TypedArray å¯ä»¥å­˜å‚¨ä¸åŒç±»å‹çš„å€¼ï¼Œæ¯”å¦‚ <code>Int32Array</code> å¯ä»¥å­˜å‚¨ 32 ä½æ•´æ•°ï¼Œ<code>Float64Array</code> å¯ä»¥å­˜å‚¨ 64 ä½æµ®ç‚¹æ•°ç­‰ã€‚</p><p>ç°åœ¨ï¼Œå½“ä½ åœ¨åŸç”Ÿæ¨¡å—ä¸­å¤„ç†ä¸€ä¸ªä» JavaScript ä¼ é€’è¿‡æ¥çš„ TypedArray æ—¶ï¼Œä½ å¯èƒ½æƒ³çŸ¥é“å®ƒå…·ä½“æ˜¯ä»€ä¹ˆç±»å‹çš„ TypedArrayã€‚è¿™å°±æ˜¯ <code>napi_typedarray_type</code> å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åŸç”Ÿæ¨¡å—ï¼Œéœ€è¦å¤„ç†ä¸€ä¸ªä» JavaScript ä¼ é€’è¿‡æ¥çš„ TypedArrayï¼Œä½†ä½ ä¸ç¡®å®šå®ƒæ˜¯ <code>Int32Array</code> è¿˜æ˜¯å…¶ä»–ä»€ä¹ˆç±»å‹çš„ TypedArrayã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>napi_typedarray_type</code> æ¥æŸ¥çœ‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... åœ¨æŸä¸ªåŸç”Ÿå‡½æ•°ä¸­</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‚æ•° env æ˜¯ napi_env ç±»å‹ï¼Œè¡¨ç¤ºå½“å‰çš„ç¯å¢ƒä¸Šä¸‹æ–‡</span></span>
<span class="line"><span>// å‚æ•° value æ˜¯ napi_value ç±»å‹ï¼Œè¡¨ç¤º JavaScript ä¼ é€’ç»™åŸç”Ÿå‡½æ•°çš„ TypedArray å¯¹è±¡</span></span>
<span class="line"><span>void MyFunction(napi_env env, napi_value value) {</span></span>
<span class="line"><span>    // ç”¨äºå­˜å‚¨æŸ¥è¯¢ç»“æœçš„å˜é‡</span></span>
<span class="line"><span>    napi_typedarray_type type;</span></span>
<span class="line"><span>    size_t length;</span></span>
<span class="line"><span>    void* data;</span></span>
<span class="line"><span>    size_t offset;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æŸ¥è¯¢ TypedArray çš„ç±»å‹</span></span>
<span class="line"><span>    napi_status status = napi_get_typedarray_info(env, value, &amp;type, &amp;length, &amp;data, NULL, &amp;offset);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥ napi_get_typedarray_info è°ƒç”¨æ˜¯å¦æˆåŠŸ</span></span>
<span class="line"><span>    if (status == napi_ok) {</span></span>
<span class="line"><span>        // æ ¹æ®å¾—åˆ°çš„ type å€¼å¯¹åº”ä¸åŒçš„ç±»å‹</span></span>
<span class="line"><span>        switch (type) {</span></span>
<span class="line"><span>            case napi_int8_array:</span></span>
<span class="line"><span>                // å¤„ç† Int8Array ç±»å‹çš„ TypedArray</span></span>
<span class="line"><span>                break;</span></span>
<span class="line"><span>            case napi_uint8_array:</span></span>
<span class="line"><span>                // å¤„ç† Uint8Array ç±»å‹çš„ TypedArray</span></span>
<span class="line"><span>                break;</span></span>
<span class="line"><span>            // ... å…¶ä»– case åˆ†æ”¯</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // é”™è¯¯å¤„ç†</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œé€šè¿‡è°ƒç”¨ <code>napi_get_typedarray_info</code> å‡½æ•°å¹¶ä¼ å…¥ <code>napi_typedarray_type</code> ç±»å‹çš„æŒ‡é’ˆ <code>&amp;type</code>ï¼Œå°±å¯ä»¥æŸ¥è¯¢å‡º TypedArray çš„ç¡®åˆ‡ç±»å‹ï¼Œå¹¶æ ¹æ®ç±»å‹æ‰§è¡Œä¸åŒçš„æ“ä½œã€‚è¿™æ ·ä½ å°±å¯ä»¥é’ˆå¯¹ä¸åŒç±»å‹çš„ TypedArray ç¼–å†™é«˜æ•ˆçš„æ•°æ®å¤„ç†é€»è¾‘äº†ã€‚</p><p>å¸Œæœ›è¿™ä¸ªè§£é‡Šå’Œç¤ºä¾‹èƒ½å¤Ÿå¸®åŠ©ä½ ç†è§£ <code>napi_typedarray_type</code> åœ¨ Node.js ä¸­çš„è¿ç”¨ã€‚</p><h3 id="object-creation-functions" tabindex="-1"><a class="header-anchor" href="#object-creation-functions"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#object-creation-functions" target="_blank" rel="noopener noreferrer">Object creation functions</a></span></a></h3><p>Node.js v21.7.1 ä¸­çš„â€œObject creation functionsâ€æ˜¯æŒ‡ Node.js æä¾›çš„ä¸€ç»„ç”¨äºåˆ›å»ºå’Œæ“ä½œ JavaScript å¯¹è±¡çš„å‡½æ•°ï¼Œå®ƒä»¬éƒ½æ˜¯åŸºäº N-APIï¼ˆNode.js APIï¼‰å®ç°çš„ã€‚è¿™äº›å‡½æ•°å…è®¸åŸç”Ÿæ¨¡å—ï¼ˆé€šå¸¸ç”¨ C æˆ– C++ç¼–å†™ï¼‰ä¸ JavaScript ä»£ç äº¤äº’ï¼Œå³ä½ å¯ä»¥åœ¨ C/C++ä»£ç ä¸­åˆ›å»º JavaScript å¯¹è±¡ï¼Œå¹¶å°†å®ƒä»¬ä¼ é€’ç»™ JavaScript å±‚é¢çš„ä»£ç ã€‚</p><p>N-API æ˜¯ä¸€ä¸ªç‹¬ç«‹äº JavaScript è¿è¡Œæ—¶çš„ API å±‚ï¼Œæ—¨åœ¨ç»´æŠ¤åŸç”Ÿæ’ä»¶ï¼ˆnative addonsï¼‰çš„å…¼å®¹æ€§ across different versions of Node.js å’Œä¸åŒçš„ JavaScript engines æ¯”å¦‚ V8 (Chrome), Chakra (Microsoft Edge), SpiderMonkey (Firefox), ç­‰ç­‰ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªå…·ä½“çš„ä¾‹å­ä»¥ç†è§£ N-API æä¾›çš„å¯¹è±¡åˆ›å»ºå‡½æ•°çš„ä½¿ç”¨ï¼š</p><h3 id="_1-åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºå¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#_1-åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºå¯¹è±¡"><span>1. åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºå¯¹è±¡</span></a></h3><p>åœ¨åŸç”Ÿæ¨¡å—ä¸­ï¼Œä½ å¯èƒ½æƒ³è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºå¯¹è±¡å¹¶è¿”å›ç»™ JavaScriptï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value create_empty_object(napi_env env) {</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    napi_status status = napi_create_object(env, &amp;result);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // Handle error...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ<code>napi_create_object</code>å‡½æ•°ç”¨äºåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ç©º JavaScript å¯¹è±¡ã€‚<code>env</code>å‚æ•°æ˜¯è¡¨ç¤ºå½“å‰ N-API ç¯å¢ƒçš„å¥æŸ„ï¼Œè€Œ<code>result</code>å°†ä¼šè¢«èµ‹å€¼ä¸ºæ–°åˆ›å»ºçš„å¯¹è±¡ã€‚</p><h3 id="_2-åˆ›å»ºä¸€ä¸ªå…·æœ‰å±æ€§çš„å¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#_2-åˆ›å»ºä¸€ä¸ªå…·æœ‰å±æ€§çš„å¯¹è±¡"><span>2. åˆ›å»ºä¸€ä¸ªå…·æœ‰å±æ€§çš„å¯¹è±¡</span></a></h3><p>å¦‚æœä½ æƒ³åœ¨å¯¹è±¡ä¸­æ·»åŠ å±æ€§ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value create_object_with_properties(napi_env env) {</span></span>
<span class="line"><span>    napi_value obj;</span></span>
<span class="line"><span>    napi_status status = napi_create_object(env, &amp;obj);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è®¾ç½®å±æ€§â€œnameâ€ä¸ºå­—ç¬¦ä¸²â€œNode.jsâ€</span></span>
<span class="line"><span>    napi_value name_string;</span></span>
<span class="line"><span>    status = napi_create_string_utf8(env, &quot;Node.js&quot;, NAPI_AUTO_LENGTH, &amp;name_string);</span></span>
<span class="line"><span>    status = napi_set_named_property(env, obj, &quot;name&quot;, name_string);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è®¾ç½®å±æ€§â€œversionâ€ä¸ºæ•°å­—21.7</span></span>
<span class="line"><span>    napi_value version_number;</span></span>
<span class="line"><span>    status = napi_create_double(env, 21.7, &amp;version_number);</span></span>
<span class="line"><span>    status = napi_set_named_property(env, obj, &quot;version&quot;, version_number);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // Handle error...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    return obj;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆä½¿ç”¨<code>napi_create_object</code>åˆ›å»ºäº†ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œç„¶åä½¿ç”¨<code>napi_create_string_utf8</code>åˆ›å»ºäº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¥ç€ç”¨<code>napi_set_named_property</code>å°†è¿™ä¸ªå­—ç¬¦ä¸²è®¾ç½®ä¸ºå¯¹è±¡çš„å±æ€§ã€‚åŒæ ·çš„è¿‡ç¨‹ä¹Ÿç”¨æ¥åˆ›å»ºä¸€ä¸ªæ•°å€¼å±æ€§ã€‚</p><h3 id="_3-åˆ›å»ºæ•°ç»„" tabindex="-1"><a class="header-anchor" href="#_3-åˆ›å»ºæ•°ç»„"><span>3. åˆ›å»ºæ•°ç»„</span></a></h3><p>åˆ›å»º JavaScript æ•°ç»„çš„ç¤ºä¾‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value create_array_with_numbers(napi_env env) {</span></span>
<span class="line"><span>    napi_value my_array;</span></span>
<span class="line"><span>    napi_status status = napi_create_array(env, &amp;my_array);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å‘æ•°ç»„ä¸­å¡«å……æ•°å­—</span></span>
<span class="line"><span>    for (int i = 0; i `&lt;` 10; i++) {</span></span>
<span class="line"><span>        napi_value num;</span></span>
<span class="line"><span>        status = napi_create_int32(env, i, &amp;num);</span></span>
<span class="line"><span>        status = napi_set_element(env, my_array, i, num);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // Handle error...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    return my_array;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>napi_create_array</code>ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ï¼Œ<code>napi_set_element</code>ç”¨äºè®¾ç½®æ•°ç»„å…ƒç´ ã€‚</p><p>è¿™äº›åªæ˜¯ç®€å•çš„ä¾‹å­ï¼Œä½†å®ƒä»¬å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ N-API çš„å¯¹è±¡åˆ›å»ºå‡½æ•°åœ¨åŸç”Ÿä»£ç ä¸­æ“ä½œ JavaScript å¯¹è±¡ã€‚è¿™æ˜¯æ„å»ºé«˜æ•ˆä¸”å¯è·¨å¤šä¸ª Node.js ç‰ˆæœ¬è¿è¡Œçš„åŸç”Ÿæ‰©å±•çš„å…³é”®æŠ€æœ¯ä¹‹ä¸€ã€‚å½“ç„¶ï¼Œå®é™…å¼€å‘ä¸­éœ€è¦å¤„ç†æ›´å¤æ‚çš„é€»è¾‘ï¼ŒåŒ…æ‹¬é”™è¯¯å¤„ç†ã€å¼‚æ­¥ç¼–ç¨‹ç­‰ã€‚</p><h4 id="napi-create-array" tabindex="-1"><a class="header-anchor" href="#napi-create-array"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_array" target="_blank" rel="noopener noreferrer">napi_create_array</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ API å±‚ï¼Œå®ƒå…è®¸ä½ ç”¨ C æˆ– C++ ç¼–å†™å¯ä»¥ç›´æ¥ä¸ JavaScript äº¤äº’çš„ä»£ç ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥æé«˜æ€§èƒ½ï¼Œæˆ–è€…å…è®¸ä½ ä½¿ç”¨æ“ä½œç³»ç»Ÿåº•å±‚çš„åŠŸèƒ½ï¼Œè¿™åœ¨çº¯ JavaScript ä¸­å¯èƒ½æ— æ³•å®ç°ã€‚</p><p><code>napi_create_array</code> æ˜¯ N-API æä¾›çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå…è®¸ä½ åœ¨åŸç”Ÿä»£ç ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºæ•°ç»„ï¼Œå¹¶ä¸”å°†è¿™ä¸ªæ•°ç»„è¿”å›ç»™ JavaScript ç¯å¢ƒã€‚</p><p>è¿™é‡Œæ˜¯ <code>napi_create_array</code> å‡½æ•°çš„ç­¾åï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_create_array(napi_env env,</span></span>
<span class="line"><span>                              napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>: è¿™æ˜¯è¡¨ç¤º N-API ç¯å¢ƒçš„å¥æŸ„ï¼Œæ¯æ¬¡ N-API è°ƒç”¨éƒ½éœ€è¦è¿™ä¸ªç¯å¢ƒå˜é‡ã€‚</li><li><code>result</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>napi_value</code> çš„æŒ‡é’ˆï¼Œå®ƒå°†åœ¨å‡½æ•°æ‰§è¡Œåä¿å­˜åˆ›å»ºçš„æ•°ç»„å¯¹è±¡ã€‚</li></ul><p>å¦‚æœè°ƒç”¨æˆåŠŸï¼Œ<code>napi_create_array</code> ä¼šè¿”å› <code>napi_ok</code> å¹¶é€šè¿‡ <code>result</code> å‚æ•°è¿”å›ä¸€ä¸ªæ–°çš„æ•°ç»„å¯¹è±¡ã€‚</p><p>ä¸‹é¢æ˜¯å¦‚ä½•åœ¨ C++ æ‰©å±•ä¸­ä½¿ç”¨ <code>napi_create_array</code> çš„ç®€å•ä¾‹å­ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªN-APIè°ƒç”¨çš„ç¤ºä¾‹ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„å¹¶è¿”å›ç»™JavaScript</span></span>
<span class="line"><span>napi_value CreateArrayExample(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  // å®šä¹‰ä¸€ä¸ªnapi_valueæ¥å­˜æ”¾ç»“æœæ•°ç»„</span></span>
<span class="line"><span>  napi_value array;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºæ•°ç»„</span></span>
<span class="line"><span>  napi_status status = napi_create_array(env, &amp;array);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ›å»ºäº†æ•°ç»„</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯æƒ…å†µ...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›åˆ›å»ºçš„æ•°ç»„</span></span>
<span class="line"><span>  return array;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œæ­¤å‡½æ•°ç”¨æ¥å£°æ˜å’Œè®¾ç½®æ¨¡å—çš„å¯¼å‡º</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>  // æ³¨å†Œå‡½æ•°CreateArrayExampleåˆ°exportså¯¹è±¡ï¼Œä½¿å…¶åœ¨JSä¸­å¯è§</span></span>
<span class="line"><span>  napi_value create_array_fn;</span></span>
<span class="line"><span>  napi_create_function(env, NULL, 0, CreateArrayExample, NULL, &amp;create_array_fn);</span></span>
<span class="line"><span>  napi_set_named_property(env, exports, &quot;createArray&quot;, create_array_fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// N-APIæ¨¡å—å£°æ˜å®</span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‡è®¾ä¸Šé¢çš„ä»£ç æ˜¯ä½ çš„åŸç”Ÿæ¨¡å—çš„ä¸€éƒ¨åˆ†ï¼Œç¼–è¯‘å¹¶å®‰è£…ä¹‹åï¼Œä½ å°±å¯ä»¥åœ¨ Node.js ä¸­è¿™æ ·ä½¿ç”¨å®ƒï¼š</p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å¯¼å…¥ä½ çš„åŸç”Ÿæ¨¡å—</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeModule</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">your-native-module-name</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨åŸç”Ÿæ¨¡å—ä¸­çš„å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºæ•°ç»„</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> newArray</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> nativeModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createArray</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">newArray</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: []</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª <code>CreateArrayExample</code> å‡½æ•°å›è°ƒï¼Œè¯¥å‡½æ•°ä½¿ç”¨ <code>napi_create_array</code> åˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„ï¼Œå¹¶å°†å…¶è¿”å›ç»™ JavaScript ç«¯ã€‚ç„¶åï¼Œæˆ‘ä»¬åœ¨ <code>Init</code> å‡½æ•°ä¸­å°†è¿™ä¸ªå›è°ƒæ³¨å†Œä¸ºæ¨¡å—å¯¼å‡ºçš„ä¸€éƒ¨åˆ†ï¼Œä½¿å¾—å½“æˆ‘ä»¬åœ¨ JavaScript ä¸­å¯¼å…¥è¿™ä¸ªåŸç”Ÿæ¨¡å—æ—¶èƒ½å¤Ÿè°ƒç”¨ <code>createArray</code> æ–¹æ³•æ¥åˆ›å»ºæ•°ç»„ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>napi_create_array</code> æ˜¯ä¸€ä¸ªç”¨äºä»åŸç”Ÿæ¨¡å—åˆ›å»ºæ–°æ•°ç»„çš„å·¥å…·ï¼Œå®ƒå…è®¸åŸç”Ÿæ¨¡å—ä¸ JavaScript æ›´ç´§å¯†åœ°é›†æˆå’Œäº¤äº’ã€‚</p><h4 id="napi-create-array-with-length" tabindex="-1"><a class="header-anchor" href="#napi-create-array-with-length"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_array_with_length" target="_blank" rel="noopener noreferrer">napi_create_array_with_length</a></span></a></h4><p><code>napi_create_array_with_length</code> æ˜¯ Node.js ä¸­ç”¨äºåŸç”Ÿæ’ä»¶å¼€å‘çš„ä¸€ä¸ªå‡½æ•°ã€‚Node.js å…è®¸ä½ ä½¿ç”¨ C æˆ– C++ è¯­è¨€å†™æ‰©å±•æ¨¡å—ï¼Œè¿™äº›æ¨¡å—éœ€è¦ä½¿ç”¨ N-APIï¼ˆNode APIï¼‰æ¥å’Œ JavaScript ä»£ç è¿›è¡Œäº¤äº’ã€‚<code>napi_create_array_with_length</code> å°±æ˜¯å…¶ä¸­ä¸€ä¸ªç”¨äºåˆ›å»ºæ•°ç»„çš„ API å‡½æ•°ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç†è§£åœ¨ Node.js çš„ç¯å¢ƒä¸­ï¼ŒJavaScript è¿è¡Œåœ¨ V8 å¼•æ“ä¸Šã€‚è€Œ N-API åˆ™æä¾›äº†ä¸€å±‚æŠ½è±¡ï¼Œä½¿å¾—åŸç”Ÿæ¨¡å—çš„ä»£ç èƒ½å¤Ÿè„±ç¦»ç‰¹å®šç‰ˆæœ¬çš„ V8 å¼•æ“è¿è¡Œï¼Œå¢åŠ äº†ä¸ä¸åŒ Node.js ç‰ˆæœ¬ä¹‹é—´çš„å…¼å®¹æ€§ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬è¯¦ç»†è§£é‡Šä¸€ä¸‹ <code>napi_create_array_with_length</code> çš„åŠŸèƒ½ï¼š</p><ul><li><p><strong>ä½œç”¨</strong>ï¼š<br><code>napi_create_array_with_length</code> å‡½æ•°ç”¨æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript æ•°ç»„å¯¹è±¡ï¼Œå¹¶ä¸”å¯ä»¥æŒ‡å®šè¿™ä¸ªæ•°ç»„åˆå§‹æ—¶åº”è¯¥æœ‰çš„é•¿åº¦ã€‚</p></li><li><p><strong>å‚æ•°</strong>ï¼š</p><ul><li><code>napi_env env</code>: å½“å‰çš„ N-API ç¯å¢ƒçš„å¥æŸ„ï¼ˆhandleï¼‰ï¼Œå®ƒä»£è¡¨äº†ä¸€ä¸ªç‹¬ç«‹çš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œæ˜¯å¤§å¤šæ•° N-API å‡½æ•°è°ƒç”¨æ—¶å¿…é¡»ä¼ å…¥çš„ã€‚</li><li><code>size_t length</code>: ä½ æƒ³è¦åˆ›å»ºæ•°ç»„çš„é•¿åº¦ã€‚</li><li><code>napi_value* result</code>: æŒ‡é’ˆå˜é‡ï¼Œç”¨æ¥æ¥æ”¶åˆ›å»ºå¥½çš„ JavaScript æ•°ç»„å¯¹è±¡ã€‚</li></ul></li><li><p><strong>è¿”å›å€¼</strong>ï¼š<br> è¿”å›ä¸€ä¸ª <code>napi_status</code> å€¼ï¼Œè¡¨ç¤ºå‡½æ•°è°ƒç”¨æˆåŠŸè¿˜æ˜¯å¤±è´¥ã€‚å¦‚æœæˆåŠŸï¼Œ<code>result</code> å‚æ•°å°†è¢«è®¾ç½®ä¸ºæ–°åˆ›å»ºçš„æ•°ç»„ã€‚</p></li></ul><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œåœ¨ä¸€ä¸ªåŸç”Ÿæ¨¡å—ä¸­åˆ›å»ºä¸€ä¸ªå…·æœ‰ç‰¹å®šé•¿åº¦çš„æ•°ç»„ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æˆ‘ä»¬è¦åœ¨ä¸€ä¸ªåä¸ºâ€œCreateArrayâ€çš„å‡½æ•°ä¸­ä½¿ç”¨è¿™ä¸ª API</span></span>
<span class="line"><span>napi_value CreateArray(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value array;</span></span>
<span class="line"><span>    size_t array_length = 10; // æˆ‘ä»¬æƒ³è¦åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º10çš„æ•°ç»„</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è°ƒç”¨ `napi_create_array_with_length` æ¥åˆ›å»ºæ•°ç»„</span></span>
<span class="line"><span>    napi_status status = napi_create_array_with_length(env, array_length, &amp;array);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦è°ƒç”¨æˆåŠŸ</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¦‚æœæˆåŠŸï¼Œè¿”å›æ–°åˆ›å»ºçš„æ•°ç»„</span></span>
<span class="line"><span>    return array;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ å¯èƒ½ä¼šåœ¨ç¼–å†™ä¸€ä¸ªéœ€è¦è¿”å›å¤§é‡æ•°æ®ã€æˆ–è€…åˆå§‹åŒ–ä¸€ä¸ªç‰¹å®šé•¿åº¦çš„æ•°ç»„å€¼æ—¶ä½¿ç”¨åˆ° <code>napi_create_array_with_length</code>ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ ç¼–å†™çš„åŸç”Ÿæ¨¡å—éœ€è¦æ‰§è¡Œä¸€äº›è®¡ç®—å¹¶å°†ç»“æœå­˜å‚¨åœ¨ä¸€ä¸ªæ•°ç»„ä¸­è¿”å›ç»™ JavaScriptï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ª API æ¥åˆ›å»ºè¿™æ ·ä¸€ä¸ªæ•°ç»„ã€‚</p><h4 id="napi-create-arraybuffer" tabindex="-1"><a class="header-anchor" href="#napi-create-arraybuffer"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_arraybuffer" target="_blank" rel="noopener noreferrer">napi_create_arraybuffer</a></span></a></h4><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£ Node.js ä¸­çš„ <code>napi_create_arraybuffer</code> å‡½æ•°ã€‚</p><p>åœ¨ Node.js ä¸­ï¼ŒN-API æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºåŸç”Ÿæ’ä»¶ï¼ˆnative addonsï¼‰çš„ APIã€‚å®ƒè®©ä½ å¯ä»¥ç”¨ C æˆ– C++ ç¼–å†™ä¸ JavaScript ä»£ç äº¤äº‘åˆä½œæ‰§è¡Œçš„ä»£ç ã€‚è¿™å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºé€šè¿‡åŸç”Ÿæ’ä»¶ä½ å¯ä»¥æ›´é«˜æ•ˆåœ°åˆ©ç”¨ç³»ç»Ÿèµ„æºæˆ–æ‰§è¡Œä¸€äº›æ— æ³•ç›´æ¥åœ¨ JavaScript ä¸­å®ç°çš„ä»»åŠ¡ã€‚</p><p><code>napi_create_arraybuffer</code> æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå…è®¸ä½ åœ¨åŸç”Ÿä»£ç ä¸­åˆ›å»ºä¸€ä¸ª ArrayBuffer å¯¹è±¡ã€‚ArrayBuffer æ˜¯ä¸€ä¸ªè¡¨ç¤ºå›ºå®šé•¿åº¦çš„åŸå§‹äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºçš„ç±»å‹ï¼Œåœ¨ JavaScript ä¸­é€šå¸¸è¢«ç”¨äºå¤„ç†äºŒè¿›åˆ¶æ•°æ®ã€‚</p><p>ä¸‹é¢æ˜¯å¦‚ä½•ä½¿ç”¨ <code>napi_create_arraybuffer</code> å‡½æ•°çš„æ­¥éª¤ï¼š</p><ol><li><p><strong>ç¡®å®šè¦åˆ›å»ºçš„ ArrayBuffer çš„å¤§å°ã€‚</strong> ä½ éœ€è¦çŸ¥é“ä½ å¸Œæœ›åˆ†é…å¤šå°‘å­—èŠ‚çš„å†…å­˜ã€‚</p></li><li><p><strong>è°ƒç”¨ <code>napi_create_arraybuffer</code> å‡½æ•°ã€‚</strong> ä¼ å…¥è¦åˆ†é…çš„å­—èŠ‚æ•°å’Œä¸€ä¸ªæŒ‡å‘æŒ‡é’ˆå˜é‡çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆå˜é‡å°†ä¼šæŒ‡å‘ ArrayBuffer æ•°æ®çš„å¼€å§‹å¤„ã€‚</p></li><li><p><strong>å¤„ç†å‡½æ•°è¿”å›çš„ç»“æœã€‚</strong> <code>napi_create_arraybuffer</code> è°ƒç”¨åå°†è¿”å›ä¸€ä¸ªçŠ¶æ€å€¼ï¼Œè¡¨ç¤ºæ“ä½œæ˜¯å¦æˆåŠŸã€‚</p></li><li><p><strong>åˆ©ç”¨è¿™ä¸ª ArrayBufferã€‚</strong> ä½ å¯ä»¥å¡«å……è¿™ä¸ª ArrayBufferï¼Œæˆ–è€…æŠŠå®ƒä¼ å› JavaScript ä¾§å»ä½¿ç”¨ã€‚</p></li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥ç†è§£è¿™ä¸ªè¿‡ç¨‹ï¼š</p><p>å‡è®¾æˆ‘ä»¬æƒ³è¦åˆ›å»ºä¸€ä¸ªåŒ…å« 10 ä¸ªå­—èŠ‚çš„ ArrayBufferã€‚åœ¨ C/C++ ç¯å¢ƒä¸‹ä½ çš„ä»£ç å¯èƒ½ä¼šæ˜¯è¿™æ ·çš„ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¸€ä¸ªç¤ºä¾‹å‡½æ•°ï¼Œå±•ç¤ºå¦‚ä½•åˆ›å»ºä¸€ä¸ªæ–°çš„ ArrayBuffer</span></span>
<span class="line"><span>napi_value CreateArrayBufferExample(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // æˆ‘ä»¬æƒ³è¦åˆ›å»ºçš„ ArrayBuffer çš„å¤§å°</span></span>
<span class="line"><span>    const size_t byteLength = 10;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿™å°†æ˜¯æŒ‡å‘ ArrayBuffer æ•°æ®çš„æŒ‡é’ˆ</span></span>
<span class="line"><span>    void* data;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿™å°†æ˜¯æœ€ç»ˆåˆ›å»ºçš„ ArrayBuffer å¯¹è±¡</span></span>
<span class="line"><span>    napi_value arrayBuffer;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªå¤§å°ä¸º 10 ä¸ªå­—èŠ‚çš„ ArrayBuffer</span></span>
<span class="line"><span>    napi_status status = napi_create_arraybuffer(env, byteLength, &amp;data, &amp;arrayBuffer);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ›å»ºäº† ArrayBuffer</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¡«å…… ArrayBufferï¼Œä¾‹å¦‚ï¼šç”¨é›¶åˆå§‹åŒ–å®ƒ</span></span>
<span class="line"><span>    memset(data, 0, byteLength);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›åˆ›å»ºçš„ ArrayBuffer å¯¹è±¡ç»™ JavaScript ä½¿ç”¨</span></span>
<span class="line"><span>    return arrayBuffer;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªå‡½æ•° <code>CreateArrayBufferExample</code>ï¼Œå®ƒå°†åˆ›å»ºä¸€ä¸ªæ–°çš„ ArrayBufferã€‚æˆ‘ä»¬è®¾å®šäº† ArrayBuffer çš„å¤§å°æ˜¯ 10 ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”é€šè¿‡ <code>napi_create_arraybuffer</code> åˆ†é…äº†å†…å­˜ã€‚å¦‚æœå‡½æ•°è°ƒç”¨æˆåŠŸï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªæŒ‡å‘æ–°åˆ†é…å†…å­˜çš„æŒ‡é’ˆ <code>data</code>ï¼Œä»¥åŠä¸€ä¸ªä»£è¡¨ ArrayBuffer çš„ N-API value <code>arrayBuffer</code>ã€‚ç„¶åæˆ‘ä»¬ä½¿ç”¨ <code>memset</code> æ¥åˆå§‹åŒ–è¿™æ®µå†…å­˜ï¼ˆåœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬æŠŠå®ƒå…¨éƒ¨è®¾ç½®ä¸ºé›¶ï¼‰ã€‚æœ€åï¼Œæˆ‘ä»¬è¿”å› <code>arrayBuffer</code>ï¼Œå®ƒå¯ä»¥åœ¨ JavaScript ä»£ç ä¸­ä½œä¸ºä¸€ä¸ª ArrayBuffer å¯¹è±¡ä½¿ç”¨ã€‚</p><p>æ€»ç»“èµ·æ¥ï¼Œ<code>napi_create_arraybuffer</code> æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å‡½æ•°ï¼Œå¯ä»¥å¸®åŠ©ä½ åœ¨åŸç”Ÿæ’ä»¶ä¸­åˆ›å»ºç”¨äºå¤„ç†äºŒè¿›åˆ¶æ•°æ®çš„ ArrayBuffer å¯¹è±¡ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥æ„å»ºæ€§èƒ½æ›´ä¼˜å¼‚çš„åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”å¯ä»¥åœ¨ JavaScript å’ŒåŸç”Ÿä»£ç ä¹‹é—´æœ‰æ•ˆåœ°ä¼ é€’å¤§å‹æ•°æ®å—ã€‚</p><h4 id="napi-create-buffer" tabindex="-1"><a class="header-anchor" href="#napi-create-buffer"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_buffer" target="_blank" rel="noopener noreferrer">napi_create_buffer</a></span></a></h4><p>Node.js ä¸­çš„<code>napi_create_buffer</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå±äº N-APIï¼ˆNode APIï¼‰çš„ä¸€éƒ¨åˆ†ã€‚N-API æä¾›äº†ä¸€ç§ç¨³å®šçš„ã€ç‰ˆæœ¬æ— å…³çš„ APIï¼Œä½¿å¾—åŸç”Ÿæ¨¡å—ï¼ˆå³ç”¨ C æˆ– C++ç¼–å†™çš„æ‰©å±•æ¨¡å—ï¼‰å¯ä»¥ä¸ Node.js çš„ä¸åŒç‰ˆæœ¬å…¼å®¹ã€‚</p><p>åœ¨è§£é‡Š<code>napi_create_buffer</code>ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£ä»€ä¹ˆæ˜¯ Bufferã€‚åœ¨ Node.js ä¸­ï¼ŒBuffer æ˜¯ä¸€ä¸ªç”¨æ¥å¤„ç†äºŒè¿›åˆ¶æ•°æ®çš„å¯¹è±¡ã€‚æ¯”å¦‚è¯´ä½ æƒ³ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œæˆ–è€…ä¸ç½‘ç»œä¸Šçš„æœåŠ¡å™¨äº¤æ¢æ•°æ®ï¼Œé€šå¸¸è¿™äº›æ•°æ®éƒ½æ˜¯ä»¥äºŒè¿›åˆ¶å½¢å¼å­˜åœ¨çš„ã€‚Buffer å°±æ˜¯ç”¨æ¥è¡¨ç¤ºè¿™äº›åŸå§‹çš„äºŒè¿›åˆ¶æ•°æ®çš„ã€‚</p><p>ç°åœ¨æ¥çœ‹<code>napi_create_buffer</code>è¿™ä¸ªå‡½æ•°ã€‚å®ƒçš„ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„ Buffer å¯¹è±¡ï¼Œè¿™ä¸ª Buffer å¯¹è±¡æ˜¯åœ¨ Node.js çš„ C/C++æ’ä»¶ï¼ˆnative addonï¼‰ä¸­ä½¿ç”¨çš„ã€‚ä½¿ç”¨è¿™ä¸ªå‡½æ•°å¯ä»¥è®©æ’ä»¶åˆ›å»ºä¸€ä¸ª JavaScript Buffer å®ä¾‹ï¼Œç„¶åè¿™ä¸ªå®ä¾‹å¯ä»¥è¢«è¿”å›ç»™ JavaScript ä»£ç ä½¿ç”¨ã€‚</p><p>ä¸‹é¢æ˜¯<code>napi_create_buffer</code>çš„åŸºæœ¬ç”¨æ³•ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CreateBuffer(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  // å®šä¹‰é•¿åº¦ä¸º1024å­—èŠ‚çš„buffer</span></span>
<span class="line"><span>  size_t length = 1024;</span></span>
<span class="line"><span>  void* data;</span></span>
<span class="line"><span>  napi_value buffer;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è°ƒç”¨napi_create_bufferæ¥åˆ›å»ºä¸€ä¸ªbuffer</span></span>
<span class="line"><span>  napi_status status = napi_create_buffer(env, length, &amp;data, &amp;buffer);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆå§‹åŒ–bufferå†…å®¹ï¼Œåªæ˜¯ç¤ºä¾‹ï¼Œå®é™…å¯èƒ½ä¼šæ ¹æ®å…·ä½“éœ€æ±‚æ¥æ“ä½œå†…å­˜</span></span>
<span class="line"><span>  memset(data, 0, length);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›æ–°åˆ›å»ºçš„Bufferå¯¹è±¡ç»™JavaScript</span></span>
<span class="line"><span>  return buffer;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åœ¨æ’ä»¶åˆå§‹åŒ–æ—¶æ³¨å†Œä¸Šé¢å®šä¹‰çš„å‡½æ•°</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>  napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  napi_create_function(env, NULL, 0, CreateBuffer, NULL, &amp;fn);</span></span>
<span class="line"><span>  napi_set_named_property(env, exports, &quot;createBuffer&quot;, fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°<code>CreateBuffer</code>ã€‚è¿™ä¸ªå‡½æ•°è¢«ç”¨æ¥åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º 1024 å­—èŠ‚çš„ Bufferï¼Œå¹¶ä¸”å°†å®ƒåˆå§‹åŒ–ä¸ºå…¨ 0ã€‚ç„¶åæˆ‘ä»¬æŠŠè¿™ä¸ª Buffer å¯¹è±¡è¿”å›ç»™ JS ä»£ç ï¼ŒJS ä»£ç å°±å¯ä»¥åƒä½¿ç”¨æ™®é€š Buffer ä¸€æ ·ä½¿ç”¨å®ƒã€‚</p><p>å¦‚ä½•åœ¨ Javascript ä¸­ä½¿ç”¨è¿™ä¸ª Buffer å‘¢ï¼Ÿå‡è®¾ä¸Šé¢çš„ C ä»£ç æ˜¯æˆ‘ä»¬çš„æ’ä»¶ä»£ç ï¼Œæˆ‘ä»¬ç¼–è¯‘å¹¶å®‰è£…ä¹‹åï¼Œåœ¨ JS ä¸­å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> myAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my-addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // åŠ è½½æˆ‘ä»¬çš„C/C++æ’ä»¶</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> myAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createBuffer</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // åˆ›å»ºä¸€ä¸ª1024å­—èŠ‚çš„Buffer</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">buffer</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">length)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºï¼š1024</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">buffer</span><span style="color:#D8DEE9FF;">[</span><span style="color:#B48EAD;">0</span><span style="color:#D8DEE9FF;">])</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºï¼š0 å› ä¸ºæˆ‘ä»¬åœ¨Cä»£ç ä¸­å°†å…¶åˆå§‹åŒ–ä¸º0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>napi_create_buffer</code>ä¸€èˆ¬åœ¨éœ€è¦åœ¨ C/C++æ’ä»¶ä¸­å¤„ç†å¤§é‡äºŒè¿›åˆ¶æ•°æ®æ—¶ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œå¤„ç†å›¾åƒã€éŸ³é¢‘æ–‡ä»¶ã€å‡†å¤‡è¦é€šè¿‡ç½‘ç»œå‘é€çš„æ•°æ®åŒ…ç­‰åœºæ™¯ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ’ä»¶å¯ä»¥åˆ›å»º Buffer å¯¹è±¡å¹¶å¡«å……æ•°æ®ï¼Œæœ€åå°† Buffer ä¼ é€’å› JavaScriptï¼Œä»¥ä¾¿è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†æˆ–è¾“å‡ºã€‚</p><h4 id="napi-create-buffer-copy" tabindex="-1"><a class="header-anchor" href="#napi-create-buffer-copy"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_buffer_copy" target="_blank" rel="noopener noreferrer">napi_create_buffer_copy</a></span></a></h4><p>å¥½çš„ï¼Œæˆ‘æ¥è§£é‡Šä¸€ä¸‹ <code>napi_create_buffer_copy</code> è¿™ä¸ªå‡½æ•°åœ¨ Node.js ä¸­çš„ä½œç”¨å’Œå¦‚ä½•ä½¿ç”¨å®ƒã€‚</p><p>åœ¨ Node.js ä¸­ï¼ŒN-APIï¼ˆNode APIï¼‰æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶çš„æ¥å£ã€‚æœ¬åœ°æ’ä»¶æ˜¯ç”¨ C æˆ– C++ç¼–å†™çš„æ¨¡å—ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ Node.js æä¾›çš„ APIï¼Œä»è€Œå®ç°ä¸€äº› JavaScript ä¸èƒ½é«˜æ•ˆå¤„ç†çš„ä»»åŠ¡ï¼Œæ¯”å¦‚ç›´æ¥ä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’æˆ–æ‰§è¡Œ CPU å¯†é›†å‹è®¡ç®—ç­‰ã€‚</p><p>å‡½æ•° <code>napi_create_buffer_copy</code> æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå…è®¸ä½ åœ¨åŸç”Ÿä»£ç ï¼ˆå¦‚ C/C++ï¼‰ä¸­åˆ›å»ºä¸€ä¸ª Node.js çš„ <code>Buffer</code> å¯¹è±¡ï¼Œå¹¶ä¸”å°†ä¸€æ®µæ•°æ®å¤åˆ¶åˆ°è¿™ä¸ªæ–°åˆ›å»ºçš„ <code>Buffer</code> ä¸­ã€‚</p><p>åœ¨ JavaScript ä¸­ï¼Œ<code>Buffer</code> å¯¹è±¡é€šå¸¸ç”¨äºå¤„ç†äºŒè¿›åˆ¶æ•°æ®æµï¼Œæ¯”å¦‚ç½‘ç»œé€šä¿¡ã€æ–‡ä»¶æ“ä½œç­‰åœºæ™¯ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ <code>napi_create_buffer_copy</code> çš„å®šä¹‰ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_create_buffer_copy(napi_env env,</span></span>
<span class="line"><span>                                    size_t length,</span></span>
<span class="line"><span>                                    const void* data,</span></span>
<span class="line"><span>                                    napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>ï¼šè¿™æ˜¯ä¸€ä¸ªè¡¨ç¤ºå½“å‰ N-API ç¯å¢ƒçš„å¥æŸ„ã€‚</li><li><code>length</code>ï¼šéœ€è¦å¤åˆ¶çš„æ•°æ®é•¿åº¦ã€‚</li><li><code>data</code>ï¼šæŒ‡å‘ä½ æƒ³è¦å¤åˆ¶åˆ°æ–° <code>Buffer</code> çš„æ•°æ®ã€‚</li><li><code>result</code>ï¼šæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œç”¨äºè¿”å›æ–°åˆ›å»ºçš„ <code>Buffer</code> å¯¹è±¡ã€‚</li></ul><h3 id="ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­"><span>ä¾‹å­</span></a></h3><p>å‡è®¾åœ¨ä½ çš„ C/C++æ‰©å±•ä¸­ï¼Œä½ æƒ³è¦åˆ›å»ºä¸€ä¸ªåŒ…å«ç‰¹å®šæ•°æ®çš„ <code>Buffer</code> å®ä¾‹ï¼Œä½ å¯ä»¥è¿™æ ·ä½¿ç”¨ <code>napi_create_buffer_copy</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CreateBufferExample(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    char data[] = &quot;Hello, world!&quot;; // æ•°æ®æº</span></span>
<span class="line"><span>    size_t data_length = sizeof(data) - 1; // è®¡ç®—æ•°æ®é•¿åº¦ï¼Œä¸åŒ…æ‹¬æœ«å°¾çš„ç©ºå­—ç¬¦</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_value buffer;</span></span>
<span class="line"><span>    // è°ƒç”¨ napi_create_buffer_copy åˆ›å»º Buffer å¹¶å¤åˆ¶æ•°æ®</span></span>
<span class="line"><span>    napi_status status = napi_create_buffer_copy(env, data_length, data, &amp;buffer);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // é”™è¯¯å¤„ç†</span></span>
<span class="line"><span>        napi_throw_error(env, NULL, &quot;Unable to create buffer&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return buffer; // è¿”å›æ–°åˆ›å»ºçš„ Buffer å®ä¾‹</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>CreateBufferExample</code> çš„å‡½æ•°ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªåŒ…å« &quot;Hello, world!&quot; æ–‡æœ¬çš„ Node.js <code>Buffer</code> å®ä¾‹ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å£°æ˜äº†ä¸€ä¸ªåŒ…å«æ–‡æœ¬ä¿¡æ¯çš„ <code>char</code> æ•°ç»„ï¼Œç„¶åè®¡ç®—å‡ºæ²¡æœ‰åŒ…æ‹¬æœ«å°¾ç©ºå­—ç¬¦çš„æ•°æ®é•¿åº¦ã€‚é€šè¿‡è°ƒç”¨ <code>napi_create_buffer_copy</code> å‡½æ•°ï¼Œæˆ‘ä»¬å°†æ•°æ®å¤åˆ¶åˆ°æ–°åˆ›å»ºçš„ <code>Buffer</code> ä¸­ï¼Œå¹¶å°†å…¶è¿”å›ç»™ JavaScript ç¯å¢ƒã€‚</p><p>åœ¨æ‚¨çš„ Node.js æ‰©å±•æ¨¡å—ä¸­å¯¼å‡ºè¯¥å‡½æ•°å¹¶ä» JavaScript è°ƒç”¨æ—¶ï¼Œæ‚¨å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªåŒ…å« &quot;Hello, world!&quot; çš„ <code>Buffer</code> å¯¹è±¡ã€‚ä¾‹å¦‚ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> myAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/myAddon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> myAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">CreateBufferExample</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">buffer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: Hello, world!</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·æ³¨æ„ï¼Œç”±äºè¿™æ˜¯ä¸€ä¸ªä½çº§æ“ä½œï¼Œæ­£å¸¸æƒ…å†µä¸‹ä½ ä¸éœ€è¦ç›´æ¥ä½¿ç”¨ N-API æ¥å¤„ç† <code>Buffer</code>ï¼Œé™¤éä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªæœ¬åœ°æ‰©å±•æ¨¡å—æ¥å¢å¼º Node.js çš„èƒ½åŠ›ã€‚åœ¨çº¯ JavaScript ä»£ç ä¸­ï¼Œä½ å¯ä»¥ç®€å•åœ°é€šè¿‡ <code>Buffer.from</code> æ–¹æ³•æ¥åˆ›å»º <code>Buffer</code> å®ä¾‹ã€‚</p><h4 id="napi-create-date" tabindex="-1"><a class="header-anchor" href="#napi-create-date"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_date" target="_blank" rel="noopener noreferrer">napi_create_date</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚åŸç”Ÿæ’ä»¶é€šå¸¸æ˜¯ä¸€äº›ç”¨ C æˆ– C++ç¼–å†™çš„æ‰©å±•ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ Node.js çš„åº•å±‚ APIï¼Œè¿™æ ·ä½ å°±å¯ä»¥åœ¨ Node.js ä¸­æ‰§è¡Œæ›´é«˜æ•ˆç‡çš„æ“ä½œï¼Œæ¯”å¦‚ç›´æ¥ä¸ç¡¬ä»¶äº¤äº’ï¼Œæˆ–è€…è¿è¡Œä¸€äº› CPU å¯†é›†å‹çš„è®¡ç®—ä»»åŠ¡ã€‚</p><p><code>napi_create_date</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå…è®¸ä½ åœ¨åŸç”Ÿæ¨¡å—ä¸­åˆ›å»ºä¸€ä¸ª JavaScript çš„ Date å¯¹è±¡ã€‚JavaScript çš„ Date å¯¹è±¡æ˜¯ç”¨äºå¤„ç†æ—¥æœŸå’Œæ—¶é—´çš„ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>napi_create_date</code>çš„ç­¾åï¼ˆå³å®šä¹‰ï¼‰:</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_create_date(napi_env env,</span></span>
<span class="line"><span>                             double time,</span></span>
<span class="line"><span>                             napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªå‡½æ•°æ¥å—ä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li><code>env</code>ï¼šå½“å‰ç¯å¢ƒçš„å¥æŸ„ï¼Œå®ƒä»£è¡¨äº† Node.js è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ã€‚æ¯å½“ä½ æƒ³è¦ä½¿ç”¨ N-API è¿›è¡Œä»»ä½•æ“ä½œæ—¶ï¼Œä½ éƒ½éœ€è¦é€šè¿‡è¿™ä¸ªç¯å¢ƒä¸ Node.js çš„è¿è¡Œæ—¶ç¯å¢ƒäº¤æµã€‚</li><li><code>time</code>ï¼šè¡¨ç¤ºè‡ª 1970 å¹´ 1 æœˆ 1 æ—¥ 00:00:00 UTC ä»¥æ¥ç»è¿‡çš„æ¯«ç§’æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ—¶é—´æˆ³ã€‚</li><li><code>result</code>ï¼šæ˜¯ä¸€ä¸ªæŒ‡å‘ napi_value çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆå°†è¢«èµ‹å€¼ä¸ºæ–°åˆ›å»ºçš„ Date å¯¹è±¡ã€‚</li></ul><p>å¦‚æœå‡½æ•°æ‰§è¡ŒæˆåŠŸï¼Œå®ƒä¼šè¿”å›<code>napi_ok</code>ï¼Œè¿™è¡¨ç¤ºæ²¡æœ‰é”™è¯¯å‘ç”Ÿã€‚ç„¶åï¼Œ<code>result</code>æŒ‡é’ˆæ‰€æŒ‡å‘çš„å†…å­˜åœ°å€ä¼šåŒ…å«ä¸€ä¸ªæŒ‡å‘æ–°åˆ›å»ºçš„ Date å¯¹è±¡çš„å¼•ç”¨ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œä½ æƒ³åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºå½“å‰æ—¶é—´çš„ Date å¯¹è±¡ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯ä½ çš„åŸç”Ÿå‡½æ•°å®ç°</span></span>
<span class="line"><span>napi_value CreateCurrentDate(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value date;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–å½“å‰æ—¶é—´</span></span>
<span class="line"><span>    double currentTime = (double)time(NULL) * 1000;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„Dateå¯¹è±¡</span></span>
<span class="line"><span>    status = napi_create_date(env, currentTime, &amp;date);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯å‘ç”Ÿ</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¦‚æœæœ‰é”™è¯¯ï¼Œè¿”å›undefined</span></span>
<span class="line"><span>        napi_get_undefined(env, &amp;date);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›æ–°åˆ›å»ºçš„Dateå¯¹è±¡</span></span>
<span class="line"><span>    return date;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–ä½ çš„æ’ä»¶ï¼Œæ³¨å†Œ`CreateCurrentDate`å‡½æ•°</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value current_date_fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æŠŠCå‡½æ•°åŒ…è£…ä¸ºJavaScriptå¯è°ƒç”¨çš„å‡½æ•°</span></span>
<span class="line"><span>    napi_create_function(env, &quot;createCurrentDate&quot;, NAPI_AUTO_LENGTH, CreateCurrentDate, NULL, &amp;current_date_fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è®¾ç½®å¯¼å‡ºçš„å‡½æ•°</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;createCurrentDate&quot;, current_date_fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„<code>CreateCurrentDate</code>å‡½æ•°è°ƒç”¨äº†<code>napi_create_date</code>å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ Date å¯¹è±¡ï¼Œå¹¶è¿”å›å®ƒç»™ JavaScriptã€‚JavaScript ä»£ç å°±èƒ½å¤Ÿåƒä¸‹é¢è¿™æ ·è°ƒç”¨ä½ çš„åŸç”Ÿå‡½æ•°ï¼Œå¹¶å¾—åˆ°ä¸€ä¸ª Date å¯¹è±¡ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ä½ çš„åŸç”Ÿæ’ä»¶åç§°</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> currentDate</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createCurrentDate</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">currentDate</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // æ‰“å°å½“å‰æ—¥æœŸå’Œæ—¶é—´</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥åœ¨åŸç”Ÿæ’ä»¶ä¸­åˆ›å»ºå¹¶æ“ä½œ JavaScript å¯¹è±¡ï¼Œè¿™ä¸º Node.js åº”ç”¨ç¨‹åºæä¾›äº†æ›´å¤§çš„çµæ´»æ€§å’Œæ€§èƒ½ã€‚</p><h4 id="napi-create-external" tabindex="-1"><a class="header-anchor" href="#napi-create-external"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_external" target="_blank" rel="noopener noreferrer">napi_create_external</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIï¼Œå®ƒå…è®¸ä½ åœ¨ Node.js ç¯å¢ƒä¸­ä½¿ç”¨ C æˆ– C++ ä»£ç æ¥åˆ›å»ºå¯ä»¥ç”± JavaScript ä»£ç ç›´æ¥è°ƒç”¨çš„åŠŸèƒ½ã€‚è¿™ç§æ–¹å¼éå¸¸æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯å½“ä½ éœ€è¦æ‰§è¡Œä¸€äº›æ€§èƒ½æ•æ„Ÿæˆ–è€…éœ€è¦ç›´æ¥ä¸ç³»ç»Ÿèµ„æºäº¤äº’çš„ä»»åŠ¡æ—¶ã€‚</p><p><code>napi_create_external</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå…è®¸ä½ åœ¨ JavaScript ä¸­åˆ›å»ºä¸€ä¸ªç‰¹æ®Šç±»å‹çš„å¯¹è±¡ï¼Œç§°ä¸º &quot;å¤–éƒ¨&quot; å¯¹è±¡ã€‚è¿™ä¸ªå¤–éƒ¨å¯¹è±¡å¯ä»¥ç”¨æ¥åŒ…è£… C/C++ ä¸­çš„æŸäº›æ•°æ®æˆ–èµ„æºï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥åœ¨ JavaScript ä¸­è¢«å¼•ç”¨å’Œä½¿ç”¨ï¼Œè€Œä¸å¿…æ‹…å¿ƒå¦‚ä½•åœ¨ JavaScript å’Œ C/C++ æ•°æ®ç»“æ„ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚</p><p>ä¸‹é¢æ˜¯ <code>napi_create_external</code> å‡½æ•°çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_create_external(napi_env env,</span></span>
<span class="line"><span>                                 void* data,</span></span>
<span class="line"><span>                                 napi_finalize finalize_cb,</span></span>
<span class="line"><span>                                 void* finalize_hint,</span></span>
<span class="line"><span>                                 napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‚æ•°è§£é‡Šï¼š</p><ul><li><code>env</code>: å½“å‰çš„ N-API ç¯å¢ƒå¥æŸ„ï¼Œä»£è¡¨äº†å½“å‰çš„ Node.js ä¸Šä¸‹æ–‡ã€‚</li><li><code>data</code>: æŒ‡å‘ä½ æƒ³è¦åœ¨ JavaScript ä¸­è¡¨ç¤ºçš„ C/C++ æ•°æ®çš„æŒ‡é’ˆã€‚</li><li><code>finalize_cb</code>: ä¸€ä¸ªå¯é€‰çš„å›è°ƒå‡½æ•°ï¼Œå½“å¤–éƒ¨å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶ä¼šè¢«è°ƒç”¨ï¼Œç”¨äºæ¸…ç†é‚£äº›ä¸å†éœ€è¦çš„èµ„æºã€‚</li><li><code>finalize_hint</code>: æä¾›ç»™ <code>finalize_cb</code> çš„å¯é€‰æ•°æ®ï¼Œé€šå¸¸ç”¨äºä¼ é€’é¢å¤–çš„ä¿¡æ¯ã€‚</li><li><code>result</code>: æŒ‡å‘ <code>napi_value</code> å˜é‡çš„æŒ‡é’ˆï¼Œåˆ›å»ºæˆåŠŸåæ­¤å˜é‡å°†åŒ…å«å¯¹åº”äºå¤–éƒ¨å¯¹è±¡çš„å¼•ç”¨ã€‚</li></ul><p>å®é™…è¿ç”¨ä¾‹å­ï¼š</p><p>å‡è®¾ä½ æœ‰ä¸€ä¸ª C ç»“æ„ä½“ï¼Œä»£è¡¨äº†ä¸€ä¸ªç®€å•çš„ç”¨æˆ·ä¿¡æ¯ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>typedef struct {</span></span>
<span class="line"><span>    char* name;</span></span>
<span class="line"><span>    int age;</span></span>
<span class="line"><span>} UserInfo;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨æˆ‘ä»¬å¸Œæœ›åœ¨ Node.js æ’ä»¶ä¸­åˆ›å»ºä¸€ä¸ªåŒ…è£…è¿™ä¸ª <code>UserInfo</code> çš„å¤–éƒ¨å¯¹è±¡ï¼Œå¹¶ä¸”åœ¨ JavaScript ä¸­ä½¿ç”¨å®ƒã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¸…ç†å‡½æ•°ï¼Œåœ¨å¤–éƒ¨å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶æ¸…ç†èµ„æºï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>void finalize_user_info(napi_env env, void* finalize_data, void* finalize_hint) {</span></span>
<span class="line"><span>    UserInfo* user_info = (UserInfo*)finalize_data;</span></span>
<span class="line"><span>    // æ¸…ç†æ“ä½œï¼Œä¾‹å¦‚é‡Šæ”¾å†…å­˜</span></span>
<span class="line"><span>    free(user_info-&gt;name);</span></span>
<span class="line"><span>    free(user_info);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥åˆ›å»ºå¤–éƒ¨å¯¹è±¡å¹¶è¿”å›ç»™ JavaScriptï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value create_user_info(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    UserInfo* user_info = malloc(sizeof(UserInfo));</span></span>
<span class="line"><span>    // å‡è®¾æˆ‘ä»¬é€šè¿‡æŸç§æ–¹å¼å¡«å……äº† user_info ç»“æ„ä½“</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_value user_info_external;</span></span>
<span class="line"><span>    napi_status status = napi_create_external(env, user_info, finalize_user_info, NULL, &amp;user_info_external);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return user_info_external;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åï¼Œåœ¨ Node.js ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åƒè¿™æ ·ä½¿ç”¨è¿™ä¸ªå¤–éƒ¨å¯¹è±¡ï¼š</p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> addon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> userInfo</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> addon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createUserInfo</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">// æ­¤æ—¶ userInfo æ˜¯ä¸€ä¸ªå¤–éƒ¨å¯¹è±¡ï¼ŒåŒ…è£…äº† C ç»“æ„ä½“ UserInfo</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·ä½ å°±å¯ä»¥åœ¨ JavaScript ä¸­ä¿å­˜ä¸€ä¸ªæŒ‡å‘ C æ•°æ®çš„å¼•ç”¨ï¼Œè€Œä¸”å½“è¿™ä¸ªå¤–éƒ¨å¯¹è±¡ä¸å†è¢«éœ€è¦æ—¶ï¼ŒN-API ä¼šè°ƒç”¨ <code>finalize_user_info</code> æ¥æ¸…ç†ç›¸å…³èµ„æºã€‚è¿™æ˜¯ä¸€ä¸ªé«˜æ•ˆç®¡ç†åŸç”Ÿèµ„æºçš„æ–¹æ³•ï¼Œå¹¶ä¸”å…è®¸ä½ åœ¨ JavaScript ä¸­åˆ©ç”¨åŸç”Ÿæ€§èƒ½ã€‚</p><h4 id="napi-create-external-arraybuffer" tabindex="-1"><a class="header-anchor" href="#napi-create-external-arraybuffer"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_external_arraybuffer" target="_blank" rel="noopener noreferrer">napi_create_external_arraybuffer</a></span></a></h4><p>Node.js çš„ N-API (Node.js API) æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚åŸç”Ÿæ’ä»¶æ˜¯ä¸€ç§å¯ä»¥ç›´æ¥ä½¿ç”¨ç³»ç»Ÿèµ„æºå’Œå†…å­˜çš„ä»£ç ï¼Œé€šå¸¸ç”¨ C æˆ– C++ç¼–å†™ï¼Œå¹¶ä¸”å¯ä»¥è¢« Node.js ä»£ç ç›´æ¥è°ƒç”¨ã€‚<code>napi_create_external_arraybuffer</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå…è®¸ä½ åˆ›å»ºä¸€ä¸ªæ‰€è°“çš„â€œå¤–éƒ¨â€ ArrayBufferã€‚</p><p>åœ¨ JavaScript ä¸­ï¼ŒArrayBuffer æ˜¯ä¸€ç§ä»£è¡¨å›ºå®šå¤§å°çš„åŸå§‹äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºçš„å¯¹è±¡ã€‚å®ƒä»¬å¸¸ç”¨äºå¤„ç†åƒæ–‡ä»¶ã€å›¾åƒæˆ–å…¶ä»–äºŒè¿›åˆ¶æµæ•°æ®è¿™æ ·çš„åº•å±‚æ•°æ®ã€‚</p><p><code>napi_create_external_arraybuffer</code>å…·ä½“æ¥è¯´ï¼Œå®ƒå¯ä»¥è®©ä½ å°†ä¸€ä¸ª C/C++ä¸­çš„å·²ç»å­˜åœ¨çš„æ•°æ®ï¼ˆæ¯”å¦‚å †ä¸Šåˆ†é…çš„ä¸€å—å†…å­˜ï¼‰ä½œä¸ºä¸€ä¸ª ArrayBuffer æš´éœ²ç»™ JavaScript ä»£ç ï¼Œè€Œæ— éœ€å¤åˆ¶æ•°æ®ã€‚è¿™å¯ä»¥æé«˜æ€§èƒ½å’Œæ•ˆç‡ï¼Œå› ä¸ºé¿å…äº†ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°†è¯¦ç»†è§£é‡Šè¿™ä¸ªå‡½æ•°å’Œå¦‚ä½•ä½¿ç”¨å®ƒï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_create_external_arraybuffer(napi_env env,</span></span>
<span class="line"><span>                                             void* external_data,</span></span>
<span class="line"><span>                                             size_t byte_length,</span></span>
<span class="line"><span>                                             napi_finalize finalize_cb,</span></span>
<span class="line"><span>                                             void* finalize_hint,</span></span>
<span class="line"><span>                                             napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‚æ•°è¯´æ˜ï¼š</p><ul><li><code>env</code>: è¡¨ç¤ºå½“å‰çš„ N-API ç¯å¢ƒï¼Œå®ƒæ˜¯ä¸€ä¸ªè¡¨ç¤º Node.js è¿è¡Œæ—¶ä¸Šä¸‹æ–‡çš„å¥æŸ„ã€‚</li><li><code>external_data</code>: è¿™æ˜¯æŒ‡å‘ä½ è¦æš´éœ²ç»™ JavaScript çš„é‚£å—å·²æœ‰æ•°æ®çš„æŒ‡é’ˆã€‚</li><li><code>byte_length</code>: æ•°æ®å—çš„å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ã€‚</li><li><code>finalize_cb</code>: å½“ ArrayBuffer è¢«åƒåœ¾å›æ”¶æ—¶ï¼Œå°†ä¼šè°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚å®ƒå¯ä»¥ç”¨æ¥é‡Šæ”¾<code>external_data</code>ã€‚</li><li><code>finalize_hint</code>: ä¸€ä¸ªä¼ é€’ç»™<code>finalize_cb</code>çš„å¯é€‰æç¤ºå€¼ï¼Œå¯ä»¥ç”¨äºç¡®å®šå¦‚ä½•æ¸…ç†<code>external_data</code>ã€‚</li><li><code>result</code>: è¿™ä¸ªå‡½æ•°æ‰§è¡ŒæˆåŠŸåï¼Œå°†è¿”å›æ–°åˆ›å»ºçš„ ArrayBuffer çš„ N-API å¼•ç”¨ã€‚</li></ul><p>å®é™…ä¾‹å­ï¼š</p><p>å‡è®¾ä½ æœ‰ä¸€ä¸ª C/C++åº“ï¼Œå®ƒå¤„ç†äº†ä¸€äº›å›¾åƒæ“ä½œï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªå‡½æ•°å¯ä»¥ç”Ÿæˆä¸€ä¸ªå›¾åƒæ•°æ®çš„æ•°ç»„ï¼Œä½ æƒ³æŠŠè¿™äº›æ•°æ®ä»¥ ArrayBuffer çš„å½¢å¼æš´éœ²ç»™ Node.jsï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void FreeImageData(void* data, void* hint) {</span></span>
<span class="line"><span>  free(data); // å‡è®¾è¿™é‡Œæˆ‘ä»¬é€šè¿‡mallocåˆ†é…äº†å›¾åƒæ•°æ®ï¼Œç°åœ¨é‡Šæ”¾å®ƒ</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CreateImageBuffer(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  napi_status status;</span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å‡è®¾è¿™ä¸ªå‡½æ•°è·å–å›¾åƒæ•°æ®å’Œå¤§å°</span></span>
<span class="line"><span>  int image_width, image_height;</span></span>
<span class="line"><span>  unsigned char* image_data = GetImageData(&amp;image_width, &amp;image_height);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å›¾åƒæ•°æ®çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰</span></span>
<span class="line"><span>  size_t byte_length = image_width * image_height * sizeof(unsigned char);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ªå¯¹è¿™å—å·²æœ‰æ•°æ®çš„å¼•ç”¨çš„ArrayBuffer</span></span>
<span class="line"><span>  status = napi_create_external_arraybuffer(env, image_data, byte_length, FreeImageData, NULL, &amp;result);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    napi_throw_error(env, NULL, &quot;Unable to create external ArrayBuffer&quot;);</span></span>
<span class="line"><span>    return NULL;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ¥ä¸‹æ¥éœ€è¦å°†&#39;CreateImageBuffer&#39;æ³¨å†Œåˆ°æ¨¡å—å½“ä¸­ç­‰æ›´å¤šæ­¥éª¤...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ Node.js ä¸­ï¼Œä½ å¯èƒ½ä¼šè¿™ä¹ˆä½¿ç”¨å®ƒï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/native-addon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾nativeAddonæœ‰ä¸€ä¸ªæ–¹æ³•å«createImageBufferï¼Œå®ƒå°±æ˜¯ä¸Šé¢å®šä¹‰çš„CreateImageBuffer</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> imageBuffer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createImageBuffer</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ç°åœ¨ä½ æ‹¥æœ‰äº†ä¸€ä¸ªArrayBufferï¼Œå…¶ä¸­åŒ…å«ç€ä½ çš„å›¾åƒæ•°æ®</span></span>
<span class="line"><span style="color:#616E88;">// ä½ å¯ä»¥ç”¨TypedArrayæˆ–è€…Bufferå¯¹è±¡æ¥ç®¡ç†è¿™äº›æ•°æ®</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¾‹å­æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨<code>napi_create_external_arraybuffer</code>å°† C/C++ä¸­çš„æ•°æ®å®‰å…¨ä¸”é«˜æ•ˆåœ°æš´éœ²ç»™ Node.jsã€‚è®°ä½ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨å’ŒåŒæ­¥é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯å¦‚æœä½ æ‰“ç®—ä»å¤šä¸ªçº¿ç¨‹è®¿é—®æ•°æ®çš„è¯ã€‚</p><h4 id="napi-create-external-buffer" tabindex="-1"><a class="header-anchor" href="#napi-create-external-buffer"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_external_buffer" target="_blank" rel="noopener noreferrer">napi_create_external_buffer</a></span></a></h4><p><code>napi_create_external_buffer</code> æ˜¯ Node.js åœ¨å…¶ Native APIï¼ˆN-APIï¼‰ä¸­æä¾›çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ª&quot;å¤–éƒ¨&quot;ç¼“å†²åŒºï¼ˆexternal bufferï¼‰ã€‚ç†è§£è¿™ä¸ªå‡½æ•°å‰ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦çŸ¥é“ Node.js ä¸­çš„ Buffer å’Œ N-API æ˜¯ä»€ä¹ˆã€‚</p><p>åœ¨ Node.js ä¸­ï¼ŒBuffer ç±»æ˜¯ç”¨æ¥å¤„ç†äºŒè¿›åˆ¶æ•°æ®çš„ï¼Œå®ƒå¯ä»¥ç”¨æ¥è¯»å†™æ–‡ä»¶ã€ç½‘ç»œé€šä¿¡ç­‰æ“ä½œä¸­ä¼ è¾“çš„æ•°æ®ã€‚è€Œ N-API åˆ™æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç¨³å®šçš„ API é›†ï¼Œå…è®¸ä½ ä½¿ç”¨ C æˆ– C++ç¼–å†™åŸç”Ÿæ’ä»¶ï¼Œè¿™äº›æ’ä»¶å¯ä»¥ç›´æ¥ä¸ Node.js çš„ JavaScript è¿è¡Œæ—¶äº¤äº’ã€‚</p><p>ç°åœ¨æ¥å…·ä½“è®²è§£ä¸€ä¸‹ <code>napi_create_external_buffer</code> å‡½æ•°ï¼š</p><ul><li><p><strong>åŠŸèƒ½</strong>ï¼šè¯¥å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ª Buffer å¯¹è±¡ï¼Œä½†å…¶å†…å­˜æ˜¯ç”±å¼€å‘è€…è‡ªå·±ç®¡ç†çš„ï¼Œè€Œä¸æ˜¯ç”± Node.js çš„åƒåœ¾å›æ”¶æœºåˆ¶æ¥ç®¡ç†ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•å°†å·²ç»å­˜åœ¨çš„æ•°æ®ï¼ˆæ¯”å¦‚ C++åˆ†é…çš„å †ä¸Šçš„æ•°æ®ï¼‰åŒ…è£…æˆä¸€ä¸ª Node.js å¯ç”¨çš„ Buffer å¯¹è±¡ï¼Œè€Œæ— éœ€å¤åˆ¶æ•°æ®ã€‚</p></li><li><p><strong>å‚æ•°</strong>ï¼š</p><ol><li><code>env</code>: å½“å‰çš„ napi ç¯å¢ƒï¼Œä»£è¡¨äº† Node.js ç¯å¢ƒçš„ä¸€ä¸ªå¥æŸ„ã€‚</li><li><code>length</code>: è¦åˆ›å»ºçš„ Buffer çš„é•¿åº¦ã€‚</li><li><code>data</code>: æŒ‡å‘é¢„å…ˆåˆ†é…å¥½çš„æ•°æ®çš„æŒ‡é’ˆã€‚</li><li><code>finalize_cb</code>: ä¸€ä¸ªå¯é€‰çš„å›è°ƒå‡½æ•°ï¼Œå½“è¿™ä¸ª Buffer è¢«åƒåœ¾å›æ”¶æ—¶ä¼šè¢«è°ƒç”¨ï¼Œè¿™ä¸ªå‡½æ•°é€šå¸¸ç”¨æ¥é‡Šæ”¾å¤–éƒ¨åˆ†é…çš„å†…å­˜ã€‚</li><li><code>finalize_hint</code>: ä¼ é€’ç»™<code>finalize_cb</code>çš„å¯é€‰å‚æ•°ã€‚</li><li><code>result</code>: è¿™æ˜¯ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼Œåˆ›å»ºæˆåŠŸåè¿”å›çš„ Buffer å¯¹è±¡ã€‚</li></ol></li><li><p><strong>è¿”å›å€¼</strong>ï¼šå¦‚æœæˆåŠŸï¼Œè¿”å›<code>napi_ok</code>ï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªé”™è¯¯ç ã€‚</p></li></ul><p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ <code>napi_create_external_buffer</code> çš„ä½¿ç”¨ï¼š</p><p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ åœ¨ C++ä¸­æœ‰ä¸€å—å†…å­˜ï¼Œé‡Œé¢å­˜æ”¾ç€éŸ³é¢‘æ•°æ®ï¼Œç°åœ¨ä½ å¸Œæœ›åœ¨ä¸€ä¸ª Node.js åº”ç”¨ä¸­å¤„ç†è¿™äº›æ•°æ®ï¼Œä½†ä½ ä¸å¸Œæœ›è¿›è¡Œæ•°æ®çš„å¤åˆ¶ä»¥é¿å…é¢å¤–çš„æ€§èƒ½å¼€é”€ã€‚</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™æ˜¯ä½ çš„éŸ³é¢‘æ•°æ®å’Œæ¸…ç†å‡½æ•°</span></span>
<span class="line"><span>const size_t AUDIO_DATA_SIZE = 1024;</span></span>
<span class="line"><span>char* audioData = new char[AUDIO_DATA_SIZE];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void FreeAudioData(napi_env env, void* finalize_data, void* finalize_hint) {</span></span>
<span class="line"><span>  char* data = reinterpret_cast`&lt;`char*&gt;(finalize_data);</span></span>
<span class="line"><span>  delete[] data;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°å°†è¢«æš´éœ²ç»™Node.js</span></span>
<span class="line"><span>napi_value CreateExternalBuffer(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  napi_value externalBuffer;</span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ªå¤–éƒ¨ç¼“å†²åŒºï¼Œå°†éŸ³é¢‘æ•°æ®åŒ…è£…æˆNode.jsçš„Bufferå¯¹è±¡</span></span>
<span class="line"><span>  napi_status status = napi_create_external_buffer(env,</span></span>
<span class="line"><span>                                                   AUDIO_DATA_SIZE,</span></span>
<span class="line"><span>                                                   audioData,</span></span>
<span class="line"><span>                                                   FreeAudioData,</span></span>
<span class="line"><span>                                                   nullptr,</span></span>
<span class="line"><span>                                                   &amp;externalBuffer);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return externalBuffer;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–ä»£ç å’Œæ¨¡å—æ³¨å†Œ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå¤–éƒ¨ç¼“å†²åŒºæ¥å¼•ç”¨æˆ‘ä»¬å·²ç»æœ‰çš„éŸ³é¢‘æ•°æ®ï¼Œå¹¶ä¸”å®šä¹‰äº†ä¸€ä¸ªæ¸…ç†å‡½æ•°<code>FreeAudioData</code>ï¼Œå½“ Node.js åˆ¤æ–­è¿™ä¸ª Buffer ä¸å†è¢«éœ€è¦æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªæ¸…ç†å‡½æ•°æ¥é‡Šæ”¾å†…å­˜ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æœ‰æ•ˆåœ°åœ¨ Node.js ä¸­å¤„ç†æˆ‘ä»¬çš„éŸ³é¢‘æ•°æ®è€Œä¸éœ€è¦æ‹·è´å®ƒã€‚</p><p>æœ€ååœ¨ Node.js ä¸­ï¼Œä½ å¯ä»¥åƒè¿™æ ·ä½¿ç”¨è¿™ä¸ªæ–°å»ºçš„ Bufferï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/nativeAddon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è·å–ç”±C++åˆ›å»ºçš„å¤–éƒ¨Buffer</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> audioBuffer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">CreateExternalBuffer</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åšä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚æ’­æ”¾æˆ–è€…ä¿®æ”¹éŸ³é¢‘æ•°æ®</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å®ç°äº† C++å’Œ Node.js ä¹‹é—´é«˜æ•ˆçš„äºŒè¿›åˆ¶æ•°æ®äº¤æ¢ã€‚è¿™å¯¹äºæ€§èƒ½æ•æ„Ÿå‹çš„åº”ç”¨éå¸¸é‡è¦ï¼Œæ¯”å¦‚å¤„ç†å¤šåª’ä½“å†…å®¹ã€å¤§é‡ç§‘å­¦è®¡ç®—æ•°æ®ç­‰åœºæ™¯ã€‚</p><h4 id="napi-create-object" tabindex="-1"><a class="header-anchor" href="#napi-create-object"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_object" target="_blank" rel="noopener noreferrer">napi_create_object</a></span></a></h4><p>å¥½çš„ï¼Œæ—¢ç„¶ä½ å¯¹ç¼–ç¨‹è¿˜æ¯”è¾ƒæ–°ï¼Œæˆ‘ä¼šå°½é‡ç”¨ç®€å•çš„è¯­è¨€æ¥è§£é‡Šã€‚é¦–å…ˆï¼Œ<code>napi_create_object</code> æ˜¯ Node.js ä¸­ N-API çš„ä¸€éƒ¨åˆ†ï¼ŒN-API æ˜¯ä¸€ä¸ª C è¯­è¨€çš„æ¥å£ï¼Œå…è®¸ä½ åˆ›å»ºå’Œæ“ä½œ JavaScript å¯¹è±¡ä» C æˆ–è€… C++ä»£ç ä¸­ã€‚</p><p>åœ¨ Node.js ä¸­ï¼Œè®¸å¤šæ—¶å€™æˆ‘ä»¬æƒ³è¦ä½¿ç”¨ C æˆ– C++æ‰©å±•æ€§èƒ½æˆ–è€…è®¿é—®ä¸€äº›åº•å±‚ç³»ç»Ÿèµ„æºï¼Œè¿™å°±æ˜¯ N-API å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚é€šè¿‡ N-APIï¼Œä½ å¯ä»¥æ„å»ºåŸç”Ÿçš„æ’ä»¶ï¼Œè€Œ<code>napi_create_object</code> å°±æ˜¯ç”¨æ¥åˆ›å»ºä¸€ä¸ªç©ºçš„ JavaScript å¯¹è±¡çš„å‡½æ•°ã€‚</p><p>ç°åœ¨æˆ‘ä¼šé€šè¿‡ä¸€ä¸ªå®é™…çš„ä¾‹å­æ¥è¯´æ˜<code>napi_create_object</code> æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚å‡è®¾æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œæˆ‘ä»¬éœ€è¦ä» C ä»£ç ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å¯¹è±¡è¿”å›ç»™ JavaScript ç¯å¢ƒã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™ä¸ªå‡½æ•°æ˜¯æš´éœ²ç»™JavaScriptçš„åŠŸèƒ½</span></span>
<span class="line"><span>napi_value CreateObject(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value myObject;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ä½¿ç”¨ napi_create_object åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å¯¹è±¡</span></span>
<span class="line"><span>    status = napi_create_object(env, &amp;myObject);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¦‚æœåˆ›å»ºå¯¹è±¡å¤±è´¥ï¼ŒæŠ›å‡ºä¸€ä¸ªé”™è¯¯</span></span>
<span class="line"><span>        napi_throw_error(env, NULL, &quot;Unable to create object&quot;);</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å‡è®¾æˆ‘ä»¬åœ¨è¿™ä¸ªå¯¹è±¡ä¸Šè®¾ç½®äº†ä¸€äº›å±æ€§...</span></span>
<span class="line"><span>    // napi_set_named_property(env, myObject, &quot;key&quot;, someValue);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›è¿™ä¸ªæ–°åˆ›å»ºçš„å¯¹è±¡</span></span>
<span class="line"><span>    return myObject;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œå°†CreateObjectç»‘å®šåˆ°exportsä¸Šï¼Œè®©JSå¯ä»¥è°ƒç”¨å®ƒ</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªå‡½æ•°å€¼</span></span>
<span class="line"><span>    status = napi_create_function(env, NULL, 0, CreateObject, NULL, &amp;fn);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        napi_throw_error(env, NULL, &quot;Unable to wrap native function&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†è¿™ä¸ªå‡½æ•°ä½œä¸ºä¸€ä¸ªå±æ€§æ·»åŠ åˆ°exportså¯¹è±¡ä¸Š</span></span>
<span class="line"><span>    status = napi_set_named_property(env, exports, &quot;createObject&quot;, fn);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        napi_throw_error(env, NULL, &quot;Unable to populate exports&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å®šä¹‰æ¨¡å—ï¼Œå…¶ä¸­ &quot;addon&quot; æ˜¯æ¨¡å—å</span></span>
<span class="line"><span>NAPI_MODULE(addon, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼š</p><ol><li><code>CreateObject</code> å‡½æ•°æ˜¯æˆ‘ä»¬æƒ³è¦åœ¨ JavaScript ç¯å¢ƒä¸­è°ƒç”¨çš„ C å‡½æ•°ã€‚</li><li>æˆ‘ä»¬ä½¿ç”¨<code>napi_create_object</code> æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºç™½ JavaScript å¯¹è±¡ã€‚</li><li>ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…¶å®ƒ N-API å‡½æ•°åƒ<code>napi_set_named_property</code> ç»™è¿™ä¸ªå¯¹è±¡è®¾ç½®å±æ€§æˆ–è€…æ–¹æ³•ã€‚</li><li>æœ€åï¼Œ<code>CreateObject</code> è¿”å›è¿™ä¸ªæ–°åˆ›å»ºçš„å¯¹è±¡åˆ° JavaScript ç¯å¢ƒã€‚</li></ol><p>è¿™æ ·ï¼Œå½“ä½ åœ¨ Node.js ç¯å¢ƒä¸­å®‰è£…å¹¶å¼•å…¥è¿™ä¸ªåŸç”Ÿæ¨¡å—æ—¶ï¼Œä½ å¯ä»¥è¿™æ ·ä½¿ç”¨å®ƒï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> addon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> obj</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> addon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createObject</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">obj</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: {}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ JavaScript ä»£ç ä¸­ï¼Œ<code>addon.createObject()</code> è°ƒç”¨äº†æˆ‘ä»¬ç”¨ C è¯­è¨€ç¼–å†™çš„å‡½æ•°ï¼Œå¹¶ä¸”è¿”å›äº†ä¸€ä¸ªæ–°çš„ JavaScript å¯¹è±¡ã€‚</p><p>ç†è§£<code>napi_create_object</code>å’Œå…¶å®ƒ N-API å‡½æ•°çš„å…³é”®ç‚¹åœ¨äºï¼šå®ƒä»¬æä¾›äº† JavaScript å’Œ C/C++ä¹‹é—´çš„æ¡¥æ¢ï¼Œå…è®¸å¼€å‘è€…åˆ©ç”¨ C/C++çš„æ€§èƒ½å’Œç³»ç»Ÿçº§è®¿é—®æƒé™æ¥æ‰©å±• Node.js çš„åŠŸèƒ½ã€‚</p><h4 id="napi-create-symbol" tabindex="-1"><a class="header-anchor" href="#napi-create-symbol"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_symbol" target="_blank" rel="noopener noreferrer">napi_create_symbol</a></span></a></h4><p><code>napi_create_symbol</code> æ˜¯ Node.js ä¸­ N-API çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå…è®¸åŸç”Ÿæ¨¡å—åˆ›å»º JavaScript çš„ Symbol ç±»å‹çš„å€¼ã€‚åœ¨ ES6 (ECMAScript 2015) ä¸­å¼•å…¥çš„ Symbol æ˜¯ä¸€ä¸ªåŸºæœ¬æ•°æ®ç±»å‹ï¼Œç”¨äºåˆ›å»ºå”¯ä¸€çš„æ ‡è¯†ç¬¦ã€‚Symbols éå¸¸é€‚åˆç”¨ä½œå¯¹è±¡å±æ€§çš„é”®ï¼Œå› ä¸ºæ¯ä¸ª Symbol éƒ½æ˜¯å”¯ä¸€çš„ï¼Œä¸ä¼šä¸å…¶ä»–å±æ€§çš„é”®å‘ç”Ÿå†²çªã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸‹ JavaScript ä¸­çš„ Symbol æ˜¯ä»€ä¹ˆï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// åœ¨ JavaScript ä¸­åˆ›å»º Symbol</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> mySymbol</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> Symbol</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my unique identifier</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">mySymbol</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºï¼šSymbol(my unique identifier)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç å±•ç¤ºäº†åœ¨ JavaScript ä¸­å¦‚ä½•åˆ›å»ºä¸€ä¸ª Symbolã€‚Symbols é€šå¸¸ç”¨äºåˆ›å»ºç‹¬ä¸€æ— äºŒçš„æ ‡è¯†ç¬¦ã€‚</p><p>ç°åœ¨ï¼Œå¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js çš„åŸç”Ÿæ‰©å±•æ¨¡å—ï¼ˆå¯èƒ½ä½¿ç”¨ C æˆ–è€… C++ï¼‰ï¼Œä½ å¯èƒ½ä¼šéœ€è¦åœ¨è¿™äº›ä½çº§è¯­è¨€ä¸­åˆ›å»º JavaScript å¯¹è±¡å’Œç±»å‹ã€‚N-API æ˜¯ Node.js æä¾›çš„ä¸€ä¸ª C APIï¼Œè®©ä½ èƒ½å¤Ÿæ„å»ºè¿™ç±»åŸç”Ÿæ’ä»¶ï¼Œå¹¶ä¸”ä¿è¯ä¸ Node.js ç‰ˆæœ¬ä¹‹é—´çš„å…¼å®¹æ€§ã€‚</p><p>ä½¿ç”¨ <code>napi_create_symbol</code> å‡½æ•°å¯ä»¥åœ¨åŸç”Ÿä»£ç ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript Symbolã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼Œå±•ç¤ºå¦‚ä½•åœ¨ä¸€ä¸ªåŸç”Ÿæ¨¡å—ä¸­ä½¿ç”¨ <code>napi_create_symbol</code>ï¼š</p><p>å‡è®¾ä½ æœ‰ä»¥ä¸‹çš„ C ä»£ç ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°è¢«è°ƒç”¨ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ Symbol</span></span>
<span class="line"><span>napi_value CreateSymbol(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value symbolDescription;</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¸¦æœ‰æè¿°çš„ JS å­—ç¬¦ä¸²</span></span>
<span class="line"><span>    status = napi_create_string_utf8(env, &quot;my unique identifier&quot;, NAPI_AUTO_LENGTH, &amp;symbolDescription);</span></span>
<span class="line"><span>    if (status != napi_ok) return NULL;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ¥ä¸‹æ¥ï¼Œä½¿ç”¨è¯¥æè¿°åˆ›å»ºä¸€ä¸ª Symbol</span></span>
<span class="line"><span>    status = napi_create_symbol(env, symbolDescription, &amp;result);</span></span>
<span class="line"><span>    if (status != napi_ok) return NULL;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›è¿™ä¸ªæ–°åˆ›å»ºçš„ Symbol</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ¨¡å—åˆå§‹åŒ–å‡½æ•°</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†ä¸Šé¢çš„ CreateSymbol å‡½æ•°æš´éœ²ç»™ JavaScript</span></span>
<span class="line"><span>    status = napi_create_function(env, NULL, 0, CreateSymbol, NULL, &amp;fn);</span></span>
<span class="line"><span>    if (status == napi_ok) {</span></span>
<span class="line"><span>        napi_set_named_property(env, exports, &quot;createSymbol&quot;, fn);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç æ¼”ç¤ºäº†å¦‚ä½•åœ¨åŸç”Ÿæ¨¡å—ä¸­åˆ›å»ºä¸€ä¸ªå‡½æ•° <code>CreateSymbol</code> ï¼Œè¿™ä¸ªå‡½æ•°å½“ä» JavaScript è°ƒç”¨æ—¶ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Symbolã€‚åœ¨æ¨¡å—åˆå§‹åŒ–å‡½æ•° <code>Init</code> ä¸­ï¼Œæˆ‘ä»¬å°† <code>CreateSymbol</code> å‡½æ•°å¯¼å‡ºä¸ºæ¨¡å—çš„ä¸€ä¸ªå±æ€§ï¼Œä½¿å¾— JavaScript ä»£ç å¯ä»¥è°ƒç”¨å®ƒã€‚</p><p>åœ¨ JavaScript ä¸­ä½¿ç”¨è¿™ä¸ªåŸç”Ÿæ¨¡å—å¯èƒ½åƒè¿™æ ·ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/native-addon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä»åŸç”Ÿæ¨¡å—ä¸­åˆ›å»ºä¸€ä¸ª Symbol</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> sym</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createSymbol</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">sym</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºï¼šSymbol(my unique identifier)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡è¿™ä¸ªä¾‹å­ï¼Œä½ å¯ä»¥çœ‹åˆ° <code>napi_create_symbol</code> å¦‚ä½•åœ¨åŸç”Ÿæ¨¡å—ä¸­è¢«ç”¨æ¥åˆ›å»º JavaScript ä¸­çš„ Symbol ç±»å‹ï¼ŒåŒæ—¶ä½¿å¾—è¿™ä¸ªåŠŸèƒ½å¯ä»¥è¢« JavaScript ä»£ç æ‰€è°ƒç”¨ã€‚</p><h4 id="node-api-symbol-for" tabindex="-1"><a class="header-anchor" href="#node-api-symbol-for"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#node_api_symbol_for" target="_blank" rel="noopener noreferrer">node_api_symbol_for</a></span></a></h4><p>Node.js ä¸­çš„ <code>napi_symbol_for</code> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå±äº Node.js çš„ N-APIï¼ˆåŸç”Ÿ APIï¼‰ï¼Œè¿™æ˜¯ä¸€å¥—ç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚åœ¨è¯¦ç»†è§£é‡Šè¿™ä¸ªå‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬å¾—å…ˆç†è§£å‡ ä¸ªæ¦‚å¿µã€‚</p><h3 id="å…³é”®æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#å…³é”®æ¦‚å¿µ"><span>å…³é”®æ¦‚å¿µï¼š</span></a></h3><ol><li><p><strong>Symbol</strong>: åœ¨ JavaScript ä¸­ï¼ŒSymbol æ˜¯ä¸€ç§åŸå§‹æ•°æ®ç±»å‹ï¼Œåƒ Numberã€String æˆ– Boolean ä¸€æ ·ã€‚æ¯ä¸ª Symbol å€¼éƒ½æ˜¯å”¯ä¸€ä¸å˜çš„ï¼Œé€šå¸¸ç”¨ä½œå¯¹è±¡å±æ€§çš„é”®ï¼Œä»¥ä¿è¯ä¸ä¼šä¸å…¶ä»–å±æ€§é”®å‘ç”Ÿå†²çªã€‚</p></li><li><p><strong>N-API</strong>ï¼šN-API æ˜¯ Node.js æä¾›çš„ä¸€å¥— C è¯­è¨€ APIï¼Œå®ƒå…è®¸ä½ ç¼–å†™èƒ½å¤Ÿä¸ Node.js äº¤äº’çš„æœ¬åœ°æ’ä»¶ã€‚é€šè¿‡ N-APIï¼Œä½ å¯ä»¥åˆ›å»ºä¸€äº›æ€§èƒ½æ›´é«˜ã€æ›´æ¥è¿‘æ“ä½œç³»ç»Ÿåº•å±‚çš„ä»£ç ã€‚</p></li><li><p><strong>node_api_symbol_for</strong>ï¼šè¿™ä¸ªå‡½æ•°æ˜¯ N-API æä¾›çš„ï¼Œç”¨æ¥åˆ›å»ºæˆ–è·å–å…¨å±€ç¬¦å·æ³¨å†Œè¡¨ä¸­çš„ Symbolï¼Œè¿™æ„å‘³ç€å½“ä½ åœ¨ä¸åŒçš„æ¨¡å—æˆ–è€…æ’ä»¶ä¸­ä½¿ç”¨ç›¸åŒåç§°åˆ›å»º Symbol æ—¶ï¼Œé€šè¿‡ <code>napi_symbol_for</code> æ€»æ˜¯èƒ½å¤Ÿæ‹¿åˆ°åŒä¸€ä¸ª Symbol å®ä¾‹ã€‚</p></li></ol><h3 id="node-api-symbol-for-å‡½æ•°çš„ä½œç”¨å’Œè¿ç”¨" tabindex="-1"><a class="header-anchor" href="#node-api-symbol-for-å‡½æ•°çš„ä½œç”¨å’Œè¿ç”¨"><span><code>node_api_symbol_for</code> å‡½æ•°çš„ä½œç”¨å’Œè¿ç”¨:</span></a></h3><p><code>node_api_symbol_for</code> å‡½æ•°çš„ç›®çš„æ˜¯è®©ä¸åŒçš„åŸç”Ÿæ’ä»¶å…±äº«ç›¸åŒçš„ Symbol å€¼ï¼Œè€Œä¸æ˜¯æ¯ä¸ªæ’ä»¶ç‹¬ç«‹åˆ›å»ºè‡ªå·±çš„ Symbolã€‚è¿™æœ‰åŠ©äºé¿å…æ„å¤–çš„å‘½åå†²çªï¼Œå› ä¸º Symbol å€¼å³ä½¿åç§°ç›¸åŒï¼Œå¦‚æœç‹¬ç«‹åˆ›å»ºï¼Œä¹Ÿä¼šæ˜¯ä¸åŒçš„å€¼ã€‚</p><h4 id="å®é™…åº”ç”¨ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ä¾‹å­"><span>å®é™…åº”ç”¨ä¾‹å­ï¼š</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸¤ä¸ªä¸åŒçš„ Node.js åŸç”Ÿæ’ä»¶ï¼Œå®ƒä»¬éƒ½éœ€è¦å¼•ç”¨ä¸€ä¸ªåä¸º <code>&quot;shared_event&quot;</code> çš„äº‹ä»¶åç§°ã€‚ä¸ºäº†ç¡®ä¿è¿™ä¸¤ä¸ªæ’ä»¶å¼•ç”¨çš„æ˜¯åŒä¸€ä¸ªäº‹ä»¶åç§°ï¼Œä½ å¯ä»¥åœ¨æ¯ä¸ªæ’ä»¶ä¸­ä½¿ç”¨ <code>napi_symbol_for</code> æ¥è·å–è¿™ä¸ªäº‹ä»¶çš„ Symbol å€¼ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// æ’ä»¶Aä¸­çš„ä»£ç </span></span>
<span class="line"><span>napi_value symbol_for_plugin_a;</span></span>
<span class="line"><span>napi_status status = napi_symbol_for(env, &quot;shared_event&quot;, &amp;symbol_for_plugin_a);</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ’ä»¶Bä¸­çš„ä»£ç </span></span>
<span class="line"><span>napi_value symbol_for_plugin_b;</span></span>
<span class="line"><span>napi_status status = napi_symbol_for(env, &quot;shared_event&quot;, &amp;symbol_for_plugin_b);</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä»¥ä¸Šä¸¤æ®µä»£ç å³ä½¿åœ¨ä¸åŒçš„æ’ä»¶ä¸­ï¼Œé€šè¿‡ napi_symbol_for è·å–åˆ°çš„ symbol_for_plugin_a å’Œ symbol_for_plugin_b æ˜¯ç›¸åŒçš„ã€‚</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·ï¼Œæ— è®ºå“ªä¸ªæ’ä»¶å‘å¸ƒæˆ–ç›‘å¬ <code>&quot;shared_event&quot;</code> äº‹ä»¶ï¼Œå®ƒä»¬éƒ½ä¼šæŒ‡å‘åŒä¸€ä¸ªäº‹ä»¶æ ‡è¯†ç¬¦ï¼Œç¡®ä¿äº†é€šä¿¡çš„ä¸€è‡´æ€§ã€‚</p><h3 id="ä½¿ç”¨åœºæ™¯æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯æ€»ç»“"><span>ä½¿ç”¨åœºæ™¯æ€»ç»“ï¼š</span></a></h3><ul><li>å½“å¤šä¸ªåŸç”Ÿæ’ä»¶éœ€è¦å¯¹æŸä¸ªç‰¹å®šçš„åŠŸèƒ½æˆ–äº‹ä»¶è¿›è¡Œåä½œæ—¶ã€‚</li><li>å½“ä½ æƒ³è¦é¿å…å…¨å±€ç©ºé—´ä¸­çš„å‘½åå†²çªã€‚</li><li>å½“åœ¨åŸç”Ÿæ’ä»¶ä¸­å®ç°è·¨æ¨¡å—çš„ç¬¦å·å…±äº«æ—¶ã€‚</li></ul><p>å¸Œæœ›ä»¥ä¸Šè§£é‡Šå’Œä¾‹å­èƒ½å¸®åŠ©ä½ ç†è§£ <code>node_api_symbol_for</code> åœ¨ Node.js ä¸­çš„ä½œç”¨å’Œå¦‚ä½•ä½¿ç”¨å®ƒã€‚</p><h4 id="napi-create-typedarray" tabindex="-1"><a class="header-anchor" href="#napi-create-typedarray"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_typedarray" target="_blank" rel="noopener noreferrer">napi_create_typedarray</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ API å±‚ï¼Œå®ƒæä¾›äº†ä¸ V8 å’Œå…¶ä»– Node.js å†…éƒ¨ç»„ä»¶ç›¸äº’æ“ä½œçš„æ¥å£ï¼Œå¹¶ä¸”æ˜¯è·¨ Node ç‰ˆæœ¬ç¨³å®šçš„ã€‚<code>napi_create_typedarray</code> å‡½æ•°æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå…è®¸ä½ åœ¨åŸç”Ÿä»£ç ä¸­åˆ›å»ºä¸€ä¸ª TypedArray å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å¯ä»¥è¢« JavaScript ä»£ç ä½¿ç”¨ã€‚</p><p>TypedArray æ˜¯ JavaScript çš„ä¸€ç§æ•°æ®ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªå›ºå®šé•¿åº¦çš„äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºã€‚å¯¹äºéœ€è¦å¤„ç†äºŒè¿›åˆ¶æ•°æ®ï¼ˆå¦‚æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€ç½‘ç»œé€šä¿¡ã€æˆ–è€…å›¾åƒå¤„ç†ç­‰ï¼‰çš„åº”ç”¨æ¥è¯´éå¸¸æœ‰ç”¨ã€‚</p><p>ä¸‹é¢å°†è¯¦ç»†è§£é‡Š <code>napi_create_typedarray</code> å‡½æ•°å’Œä¸€ä¸ªç®€å•å®ä¾‹ã€‚</p><p>å‡½æ•°çš„å®šä¹‰ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_create_typedarray(</span></span>
<span class="line"><span>    napi_env env,                  // [in] N-API ç¯å¢ƒå¥æŸ„</span></span>
<span class="line"><span>    napi_typedarray_type type,     // [in] è¦åˆ›å»ºçš„ TypedArray ç±»å‹</span></span>
<span class="line"><span>    size_t length,                 // [in] æ•°ç»„ä¸­å…ƒç´ çš„æ•°é‡</span></span>
<span class="line"><span>    napi_value arraybuffer,        // [in] ArrayBuffer å¯¹è±¡</span></span>
<span class="line"><span>    size_t byte_offset,            // [in] åœ¨ ArrayBuffer ä¸­å¼€å§‹çš„å­—èŠ‚åç§»é‡</span></span>
<span class="line"><span>    napi_value* result             // [out] æ–°åˆ›å»ºçš„ TypedArray å¼•ç”¨</span></span>
<span class="line"><span>);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‚æ•°è¯´æ˜ï¼š</p><ol><li><code>env</code>: è¿™æ˜¯ä¸€ä¸ªä»£è¡¨å½“å‰ N-API ç¯å¢ƒçš„å¥æŸ„ï¼Œæ¯æ¬¡è°ƒç”¨ N-API å‡½æ•°æ—¶éƒ½éœ€è¦ä¼ é€’ã€‚</li><li><code>type</code>: æŒ‡å®šä½ æƒ³åˆ›å»ºçš„ TypedArray çš„å…·ä½“ç±»å‹ï¼Œæ¯”å¦‚ <code>napi_uint8_array</code>, <code>napi_int16_array</code> ç­‰ã€‚</li><li><code>length</code>: æ•°ç»„çš„é•¿åº¦ï¼Œå³ä½ å¸Œæœ›åˆ›å»ºçš„æ•°ç»„ä¸­ä¼šæœ‰å¤šå°‘ä¸ªå…ƒç´ ã€‚</li><li><code>arraybuffer</code>: ä¸€ä¸ªå·²å­˜åœ¨çš„ ArrayBuffer å¯¹è±¡ï¼ŒTypedArray å°†ä¼šä½¿ç”¨è¿™ä¸ª ArrayBuffer ä½œä¸ºæ•°æ®æºã€‚</li><li><code>byte_offset</code>: åœ¨ç»™å®šçš„ ArrayBuffer ä¸­çš„èµ·å§‹ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ä»å“ªé‡Œå¼€å§‹åˆ›å»º TypedArrayã€‚</li><li><code>result</code>: è¿™æ˜¯ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼Œåˆ›å»ºæˆåŠŸåï¼Œæ–°çš„ TypedArray çš„å¼•ç”¨å°†ä¼šè¢«å­˜å‚¨åœ¨è¿™é‡Œã€‚</li></ol><p>è¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ª <code>napi_status</code> æšä¸¾å€¼ï¼Œè¡¨ç¤ºå‡½æ•°è°ƒç”¨æ˜¯å¦æˆåŠŸã€‚</p><p>ç¤ºä¾‹ï¼š</p><p>å‡è®¾æˆ‘ä»¬æƒ³åœ¨åŸç”Ÿæ¨¡å—ä¸­åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º 10 çš„ <code>Uint8Array</code>ï¼ˆæ— ç¬¦å· 8 ä½æ•´æ•°æ•°ç»„ï¼‰ï¼Œå¹¶å¡«å……ä¸€äº›æ•°æ®ç„¶åè¿”å›ç»™ JavaScript ä½¿ç”¨ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™ä¸ªå‡½æ•°æ˜¯è¢«è§¦å‘çš„åŸç”Ÿå‡½æ•°</span></span>
<span class="line"><span>napi_value CreateUint8Array(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // å®šä¹‰ä¸€ä¸ªæŒ‡å‘ç»“æœ TypedArray çš„å˜é‡</span></span>
<span class="line"><span>    napi_value result_array;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ª ArrayBufferã€‚å‡è®¾æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸€ä¸ª buffer å˜é‡ã€‚</span></span>
<span class="line"><span>    napi_value buffer;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æˆ‘ä»¬å‡è®¾ buffer å·²ç»è¢«æ­£ç¡®åˆ›å»ºï¼Œå¹¶ä¸”æœ‰è¶³å¤Ÿçš„ç©ºé—´ (è‡³å°‘ 10 bytes)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»º TypedArray</span></span>
<span class="line"><span>    napi_status status = napi_create_typedarray(env, napi_uint8_array, 10, buffer, 0, &amp;result_array);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æµ‹æ˜¯å¦åˆ›å»ºæˆåŠŸ</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›æ–°åˆ›å»ºçš„ TypedArray ç»™ JavaScript</span></span>
<span class="line"><span>    return result_array;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†ŒåŸç”Ÿå‡½æ•°ç­‰...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå£°æ˜äº†ä¸€ä¸ª <code>napi_value</code> ç±»å‹çš„ <code>result_array</code> æ¥å­˜æ”¾æˆ‘ä»¬åˆ›å»ºå¥½çš„ TypedArrayã€‚ä¹‹åï¼Œæˆ‘ä»¬è°ƒç”¨ <code>napi_create_typedarray</code>ï¼ŒæŒ‡å®šäº†æˆ‘ä»¬è¦åˆ›å»ºçš„æ˜¯ <code>napi_uint8_array</code> ç±»å‹çš„æ•°ç»„ï¼Œé•¿åº¦ä¸º 10ï¼ŒåŸºäºå·²æœ‰çš„ <code>buffer</code> <code>ArrayBuffer</code>ï¼Œä»ç¬¬ 0 ä¸ªå­—èŠ‚å¼€å§‹åˆ›å»ºã€‚å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªæŒ‡å‘æ–° Uint8Array çš„å¼•ç”¨ï¼Œå¹¶å°†å…¶è¿”å›ç»™ JavaScript ä»£ç ä½¿ç”¨ã€‚</p><p>åœ¨ JavaScript å±‚é¢ï¼Œä½ å¯ä»¥åƒä½¿ç”¨å¸¸è§„çš„ <code>Uint8Array</code> é‚£æ ·ä½¿ç”¨è¿™ä¸ªåŸç”Ÿæ¨¡å—è¿”å›çš„å¯¹è±¡ï¼Œæ¯”å¦‚éå†å…ƒç´ æˆ–è€…å°†å®ƒä¼ é€’ç»™å…¶ä»–éœ€è¦äºŒè¿›åˆ¶æ•°æ®çš„ APIã€‚</p><h4 id="napi-create-dataview" tabindex="-1"><a class="header-anchor" href="#napi-create-dataview"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_dataview" target="_blank" rel="noopener noreferrer">napi_create_dataview</a></span></a></h4><p>å¥½çš„ï¼Œæˆ‘ä¼šå°½é‡é€šä¿—æ˜“æ‡‚åœ°è§£é‡Šç»™ä½ ã€‚</p><p><code>napi_create_dataview()</code> æ˜¯ Node.js ä¸­ N-APIï¼ˆNative APIï¼‰çš„ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ª API å…è®¸åŸç”Ÿæ’ä»¶ä½œè€…ç”¨ C æˆ– C++å†™ä»£ç ï¼Œç„¶åå¯ä»¥åœ¨ Node.js ä¸­è°ƒç”¨è¿™äº›ä»£ç ã€‚N-API çš„ç›®çš„æ˜¯æä¾›ä¸€ä¸ªä¸ Node.js ç‰ˆæœ¬æ— å…³çš„ APIï¼Œè¿™æ ·ç¼–å†™çš„åŸç”Ÿä»£ç å°±ä¸éœ€è¦é’ˆå¯¹ä¸åŒç‰ˆæœ¬çš„ Node.js é‡æ–°ç¼–è¯‘ã€‚</p><p>ç°åœ¨ï¼Œæ¥çœ‹<code>napi_create_dataview()</code>è¿™ä¸ªå‡½æ•°ã€‚DataView æ˜¯ JavaScript çš„ä¸€ç§å¯¹è±¡ï¼Œç”¨äºè¯»å–å’Œå†™å…¥äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºï¼ˆArrayBufferï¼‰ã€‚åœ¨ JavaScript ä¸­ï¼ŒArrayBuffer æ˜¯ä¸€ç§å›ºå®šé•¿åº¦çš„åŸå§‹äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºï¼Œè€Œ DataView åˆ™æä¾›äº†ä¸€ä¸ªæ›´çµæ´»çš„æ¥å£æ¥æ“ä½œè¿™äº›äºŒè¿›åˆ¶æ•°æ®ã€‚</p><p><code>napi_create_dataview()</code> å‡½æ•°å°±æ˜¯ç”¨æ¥åœ¨åŸç”Ÿæ¨¡å—ä»£ç ä¸­åˆ›å»ºä¸€ä¸ªä¸ JavaScript å±‚é¢ä¸Šçš„ DataView å¯¹è±¡ç›¸å¯¹åº”çš„ N-API ç‰ˆæœ¬çš„ DataViewã€‚é€šè¿‡è¿™ä¸ªå‡½æ•°ï¼Œä½ å¯ä»¥æŒ‡å®šä½ æƒ³è¦æ“ä½œçš„ ArrayBuffer çš„å“ªä¸€éƒ¨åˆ†ï¼Œä»¥åŠå¼€å§‹æ“ä½œçš„å­—èŠ‚åç§»é‡å’Œé•¿åº¦ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåŸç”Ÿå‡½æ•°ï¼Œæƒ³è¦åˆ›å»ºä¸€ä¸ªDataView</span></span>
<span class="line"><span>napi_value CreateDataView(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t byte_offset = 0; // æˆ‘ä»¬ä»ç¼“å†²åŒºçš„èµ·å§‹ä½ç½®å¼€å§‹</span></span>
<span class="line"><span>    size_t length = 8; // å‡è®¾æˆ‘ä»¬æƒ³æ“ä½œ8ä¸ªå­—èŠ‚</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ArrayBuffer</span></span>
<span class="line"><span>    napi_value arraybuffer;</span></span>
<span class="line"><span>    // ... è¿™é‡Œçœç•¥äº†åˆ›å»ºæˆ–è€…è·å–ArrayBufferçš„è¿‡ç¨‹</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºDataView</span></span>
<span class="line"><span>    napi_value dataview;</span></span>
<span class="line"><span>    napi_status status = napi_create_dataview(env, length, arraybuffer, byte_offset, &amp;dataview);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // é”™è¯¯å¤„ç†...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›åˆ›å»ºçš„DataViewå¯¹è±¡</span></span>
<span class="line"><span>    return dataview;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<code>CreateDataView</code>å‡½æ•°ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªå­—èŠ‚é•¿åº¦ä¸º 8 çš„ DataViewï¼Œå¹¶ä¸”ä»ç»™å®šçš„ ArrayBuffer çš„èµ·å§‹ä½ç½®å¼€å§‹ã€‚è¿”å›çš„<code>dataview</code>å¯¹è±¡å¯ä»¥åœ¨éšåçš„åŸç”Ÿä»£ç ä¸­ä½¿ç”¨ï¼Œæˆ–è€…ä¼ é€’å› JavaScript è¿›è¡Œè¿›ä¸€æ­¥çš„æ“ä½œã€‚</p><p>å®é™…ä¸Šï¼Œæ‚¨å¯èƒ½ä¼šä½¿ç”¨<code>napi_create_dataview()</code>æ¥æ„å»ºèƒ½å¤Ÿå¤„ç†å›¾åƒæ•°æ®ã€éŸ³é¢‘æµã€ç½‘ç»œåŒ…æˆ–ä»»ä½•å…¶ä»–éœ€è¦ç²¾ç¡®å­—èŠ‚çº§åˆ«æ“ä½œçš„äºŒè¿›åˆ¶æ•°æ®çš„åº“ã€‚æ€»ä¹‹ï¼Œè¿™æ˜¯ä¸€ä¸ªè¿æ¥ JavaScript é«˜çº§åŠŸèƒ½ä¸åº•å±‚äºŒè¿›åˆ¶æ•°æ®æ“ä½œä¹‹é—´çš„æ¡¥æ¢ã€‚</p><h3 id="functions-to-convert-from-c-types-to-node-api" tabindex="-1"><a class="header-anchor" href="#functions-to-convert-from-c-types-to-node-api"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#functions-to-convert-from-c-types-to-node-api" target="_blank" rel="noopener noreferrer">Functions to convert from C types to Node-API</a></span></a></h3><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome çš„ V8 JavaScript å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒã€‚Node.js å…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScriptï¼Œè€Œ Node-APIï¼ˆä¹‹å‰ç§°ä¸º N-APIï¼‰æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚åŸç”Ÿæ’ä»¶æ˜¯ç”¨ C æˆ– C++ç¼–å†™çš„æ¨¡å—ï¼Œå®ƒä»¬å¯ä»¥è¢« Node.js ç›´æ¥è°ƒç”¨ã€‚</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå½“ä½ ä½¿ç”¨ JavaScript å¼€å‘ Node.js åº”ç”¨æ—¶ï¼Œä½ ä¸éœ€è¦å…³å¿ƒ C/C++ä»£ç æˆ–è€… Node-APIã€‚ä½†å¦‚æœä½ æƒ³è¦æé«˜æ€§èƒ½ï¼Œè®¿é—®ç³»ç»Ÿåº•å±‚ç‰¹æ€§ï¼Œæˆ–è€…å¤ç”¨ç°æœ‰çš„ C/C++åº“ï¼Œä½ å¯èƒ½ä¼šéœ€è¦ç¼–å†™åŸç”Ÿæ’ä»¶ã€‚</p><p>Node-API ä¸­çš„ &quot;Functions to convert from C types to Node-API&quot; éƒ¨åˆ†æä¾›äº†ä¸€ç³»åˆ—å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å…è®¸ä½ å°† C è¯­è¨€ä¸­çš„æ•°æ®ç±»å‹è½¬æ¢ä¸º Node-API èƒ½å¤Ÿè¯†åˆ«çš„ç±»å‹ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥åœ¨ Node.js ä¸­ä½¿ç”¨ C/C++ä»£ç å®šä¹‰çš„æ•°æ®äº†ã€‚</p><p>ä¾‹å¦‚ï¼š</p><ol><li>å‡è®¾ä½ æœ‰ä¸€ä¸ª C å‡½æ•°ï¼Œå®ƒè®¡ç®—ä¸¤ä¸ªæ•´æ•°çš„å’Œï¼Œå¹¶ä¸”è¿”å›ç»“æœã€‚ä¸ºäº†è®©è¿™ä¸ª C å‡½æ•°èƒ½å¤Ÿå’Œ Node.js äº¤äº’ï¼Œä½ éœ€è¦å°† C ä¸­çš„æ•´å‹ï¼ˆ<code>int</code>ï¼‰è½¬æ¢ä¸º Node-API ä¸­çš„æ•°å€¼ç±»å‹ï¼ˆ<code>napi_value</code>ï¼‰ï¼š</li></ol><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åŸå§‹çš„Cå‡½æ•°</span></span>
<span class="line"><span>int add(int a, int b) {</span></span>
<span class="line"><span>    return a + b;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¸ºNode.jså°è£…çš„å‡½æ•°</span></span>
<span class="line"><span>napi_value AddWrapped(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    size_t argc = 2;</span></span>
<span class="line"><span>    napi_value args[2];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–JavaScriptä¼ å…¥çš„å‚æ•°</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è½¬æ¢JavaScriptå‚æ•°åˆ°Cç±»å‹</span></span>
<span class="line"><span>    int value1, value2;</span></span>
<span class="line"><span>    status = napi_get_value_int32(env, args[0], &amp;value1);</span></span>
<span class="line"><span>    status = napi_get_value_int32(env, args[1], &amp;value2);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è°ƒç”¨åŸå§‹çš„Cå‡½æ•°</span></span>
<span class="line"><span>    int result = add(value1, value2);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†Cçš„ç»“æœè½¬æ¢å›Node-APIç±»å‹</span></span>
<span class="line"><span>    napi_value sum;</span></span>
<span class="line"><span>    status = napi_create_int32(env, result, &amp;sum);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return sum;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>napi_get_value_int32</code> å‡½æ•°ç”¨äºä» JavaScript ä¼ é€’çš„å‚æ•°ä¸­è·å– C çš„ <code>int</code> ç±»å‹å€¼ï¼Œè€Œ <code>napi_create_int32</code> åˆ™ç”¨æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ Node-API ç±»å‹çš„æ•´æ•°ã€‚</p><ol start="2"><li>å¦‚æœä½ æœ‰ä¸€ä¸ª C ç»“æ„ä½“ï¼Œè¡¨ç¤ºä¸€ä¸ªäºŒç»´çš„ç‚¹ï¼Œä½ ä¹Ÿå¯ä»¥å°†è¿™ä¸ªç»“æ„ä½“é€šè¿‡ Node-API æš´éœ²ç»™ JavaScriptï¼š</li></ol><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>typedef struct {</span></span>
<span class="line"><span>    double x;</span></span>
<span class="line"><span>    double y;</span></span>
<span class="line"><span>} Point;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ç›¸åº”çš„è½¬æ¢å‡½æ•°å¯èƒ½ä¼šè¿™æ ·å†™ï¼š</span></span>
<span class="line"><span>napi_value PointToNapiObject(napi_env env, Point* point) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value obj;</span></span>
<span class="line"><span>    napi_value x, y;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡</span></span>
<span class="line"><span>    status = napi_create_object(env, &amp;obj);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†Pointç»“æ„ä½“çš„xå’Œyå±æ€§è½¬æ¢ä¸ºnapi_value</span></span>
<span class="line"><span>    status = napi_create_double(env, point-&gt;x, &amp;x);</span></span>
<span class="line"><span>    status = napi_create_double(env, point-&gt;y, &amp;y);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è®¾ç½®JavaScriptå¯¹è±¡çš„å±æ€§</span></span>
<span class="line"><span>    status = napi_set_named_property(env, obj, &quot;x&quot;, x);</span></span>
<span class="line"><span>    status = napi_set_named_property(env, obj, &quot;y&quot;, y);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return obj;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼šåœ¨å®é™…ç¼–ç è¿‡ç¨‹ä¸­ï¼Œä½ åº”è¯¥æ€»æ˜¯æ£€æŸ¥ <code>napi_status</code> è¿”å›å€¼ä»¥ç¡®ä¿æ¯ä¸ª API è°ƒç”¨éƒ½æˆåŠŸäº†ã€‚</p><p>ä¸Šè¿°ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•å°† C è¯­è¨€æ•°æ®ç±»å‹è½¬æ¢ä¸º JavaScript å¯ä»¥ç†è§£çš„æ•°æ®ç±»å‹ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒNode.js å¯ä»¥ä¸åŸç”Ÿæ¨¡å—äº’æ“ä½œï¼ŒåŒæ—¶ Node-API æä¾›çš„æŠ½è±¡å±‚å¯ä»¥ä½¿å¾—æ¨¡å—ç¼–å†™æ›´ä¸ºç®€å•ï¼ŒåŒæ—¶è¿˜å…·å¤‡è·¨ Node.js ç‰ˆæœ¬çš„å…¼å®¹æ€§ã€‚</p><h4 id="napi-create-int32" tabindex="-1"><a class="header-anchor" href="#napi-create-int32"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_int32" target="_blank" rel="noopener noreferrer">napi_create_int32</a></span></a></h4><p>å½“ç„¶ï¼Œæˆ‘ä¹æ„å¸®åŠ©ä½ ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦äº†è§£å‡ ä¸ªå…³é”®ç‚¹ï¼š</p><ol><li><strong>Node.js</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ JavaScript è¯­è¨€æ¥ç¼–å†™æœåŠ¡å™¨ç«¯ç¨‹åºçš„å¹³å°ã€‚</li><li><strong>N-API</strong>ï¼šè¿™æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªåº•å±‚ APIï¼Œç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶ã€‚æœ¬åœ°æ’ä»¶æ˜¯ç”¨ C æˆ– C++ç­‰è¯­è¨€ç¼–å†™çš„æ¨¡å—ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ Node.js çš„å„ç§åŠŸèƒ½ã€‚</li></ol><p><code>napi_create_int32</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒç”¨äºåˆ›å»ºä¸€ä¸ªåŒ…å« 32 ä½æ•´æ•°å€¼çš„<code>N-API</code>å€¼ã€‚åœ¨ JavaScript ä¸­ï¼Œå½“æˆ‘ä»¬å¤„ç†æ•°å­—æ—¶ï¼Œé€šå¸¸ä¸éœ€è¦è€ƒè™‘æ•°å­—çš„å…·ä½“ç±»å‹ï¼Œä½†åœ¨ C æˆ– C++ç­‰ä½çº§è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®æŒ‡å®šä½¿ç”¨å“ªä¸€ç§ç±»å‹çš„æ•°å­—ï¼Œå› ä¸ºæ¯ç§ç±»å‹çš„æ•°å­—åœ¨å†…å­˜ä¸­å ç”¨çš„ç©ºé—´å’Œè¡¨è¾¾çš„èŒƒå›´éƒ½æœ‰æ‰€ä¸åŒã€‚<code>int32</code>æ˜¯æŒ‡ä¸€ä¸ª 32 ä½çš„æ•´æ•°ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ç»™å‡ºä¸€ä¸ªå®é™…çš„åœºæ™¯ï¼Œæ¯”å¦‚è¯´ä½ æƒ³è¦ç¼–å†™ä¸€ä¸ª Node.js æœ¬åœ°æ’ä»¶æ¥æ‰§è¡Œä¸€äº›æ€§èƒ½æ•æ„Ÿçš„æ•°å­¦è¿ç®—ã€‚æ­¤æ—¶ï¼Œä½ å¯èƒ½ä¼šé€‰æ‹©ä½¿ç”¨ C++æ¥å®ç°è¿™äº›è¿ç®—ï¼Œä»¥ä¾¿åˆ©ç”¨å®ƒçš„æ€§èƒ½ä¼˜åŠ¿ã€‚</p><p>åœ¨ C++ä»£ç ä¸­ï¼Œä½ å¸Œæœ›å»ºç«‹ä¸€ä¸ªä¸ JavaScript ä»£ç äº¤äº’çš„æ¡¥æ¢ï¼Œä»¥ä¾¿å°†è®¡ç®—ç»“æœä¼ é€’å› JavaScript ç¯å¢ƒã€‚<code>napi_create_int32</code>å°±æ˜¯åœ¨è¿™é‡Œå‘æŒ¥ä½œç”¨çš„å‡½æ•°ä¹‹ä¸€ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™ä¸ªå‡½æ•°å°†è¢«æš´éœ²ç»™JavaScriptï¼Œå¹¶ä¸”å®ƒè¿”å›ä¸€ä¸ªè®¡ç®—ç»“æœ</span></span>
<span class="line"><span>napi_value CalculateSomething(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    int32_t value = 123; // å‡è®¾è¿™æ˜¯é€šè¿‡æŸç§è®¡ç®—å¾—åˆ°çš„32ä½æ•´æ•°ç»“æœ</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ä½¿ç”¨napi_create_int32æ¥åˆ›å»ºä¸€ä¸ªN-APIè¡¨ç¤ºçš„32ä½æ•´æ•°</span></span>
<span class="line"><span>    napi_status status = napi_create_int32(env, value, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¦‚æœåˆ›å»ºå¤±è´¥ï¼ŒæŠ›å‡ºä¸€ä¸ªé”™è¯¯</span></span>
<span class="line"><span>        napi_throw_error(env, NULL, &quot;Failed to create int32 value&quot;);</span></span>
<span class="line"><span>        return nullptr;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›åˆ›å»ºå¥½çš„æ•´æ•°å€¼ç»™JavaScript</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å…¶ä»–å¿…è¦çš„æ³¨å†Œä»£ç ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<code>CalculateSomething</code>å‡½æ•°ï¼Œå®ƒé€šè¿‡<code>napi_create_int32</code>åˆ›å»ºäº†ä¸€ä¸ª 32 ä½æ•´æ•°çš„ N-API å€¼ï¼Œå¹¶è¿”å›ç»™ JavaScriptã€‚å¦‚æœæ“ä½œæˆåŠŸï¼ŒJavaScript ä»£ç å°±å¯ä»¥æ¥æ”¶åˆ°è¿™ä¸ªæ•´æ•°å€¼å¹¶åˆ©ç”¨å®ƒåšè¿›ä¸€æ­¥çš„å¤„ç†ã€‚å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œåˆ™ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚</p><p>åœ¨ JavaScript ç«¯ï¼Œè°ƒç”¨è¿™ä¸ªæœ¬åœ°æ¨¡å—å¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/native-addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> result</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">CalculateSomething</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">result</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: 123</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>nativeAddon.CalculateSomething()</code> è°ƒç”¨äº†æˆ‘ä»¬åˆšæ‰ç”¨ C++ç¼–å†™å¹¶æš´éœ²ç»™ JavaScript çš„å‡½æ•°ï¼Œå¹¶æ‰“å°å‡ºäº†ä» C++è¿”å›çš„æ•´æ•°<code>123</code>ã€‚</p><p>å¸Œæœ›è¿™ä¸ªè§£é‡Šå’Œä¾‹å­èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£<code>napi_create_int32</code>å‡½æ•°åœ¨ Node.js çš„ N-API ä¸­çš„è¿ç”¨ã€‚</p><h4 id="napi-create-uint32" tabindex="-1"><a class="header-anchor" href="#napi-create-uint32"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_uint32" target="_blank" rel="noopener noreferrer">napi_create_uint32</a></span></a></h4><p>Node.js çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIï¼Œå®ƒæä¾›äº†ä¸€ç»„ç”¨ C æˆ– C++ ç¼–å†™ä¸ JavaScript äº¤äº’çš„å‡½æ•°ã€‚åœ¨ Node.js ä¸­ï¼ŒåŸç”Ÿæ’ä»¶æ˜¯ä¸€ç§ä½¿ç”¨å…¶ä»–è¯­è¨€ç¼–å†™çš„æ¨¡å—ï¼Œèƒ½å¤Ÿç›´æ¥è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿçº§åˆ«ï¼Œé€šå¸¸ç”¨äºæ‰§è¡Œé‚£äº›å¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„ä»»åŠ¡ã€‚</p><p><code>napi_create_uint32</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå…¶ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªåŒ…å«æ— ç¬¦å· 32 ä½æ•´æ•°ï¼ˆuint32ï¼‰çš„ JavaScript æ•°å€¼ã€‚</p><p>ä»¥ä¸‹æ˜¯ <code>napi_create_uint32</code> å‡½æ•°çš„å®šä¹‰ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_create_uint32(napi_env env,</span></span>
<span class="line"><span>                                uint32_t value,</span></span>
<span class="line"><span>                                napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‚æ•°è¯´æ˜ï¼š</p><ul><li><code>env</code>ï¼šè¡¨ç¤ºå½“å‰çš„ N-API ç¯å¢ƒä¸Šä¸‹æ–‡ï¼Œè¿™é€šå¸¸åœ¨å‡½æ•°è°ƒç”¨æ—¶ç”± Node.js è‡ªåŠ¨ä¼ é€’ã€‚</li><li><code>value</code>ï¼šè¿™æ˜¯ä½ æƒ³è¦åˆ›å»ºçš„ JavaScript æ•°å€¼ä¸­å­˜å‚¨çš„å®é™…çš„æ— ç¬¦å· 32 ä½æ•´æ•°å€¼ã€‚</li><li><code>result</code>ï¼šè¿™æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>napi_value</code> çš„æŒ‡é’ˆï¼Œç”¨äºæ¥æ”¶åˆ›å»ºå‡ºæ¥çš„ JavaScript æ•°å€¼ã€‚</li></ul><p>è¿”å›å€¼ï¼š<br> è¿™ä¸ªå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªç±»å‹ä¸º <code>napi_status</code> çš„çŠ¶æ€ç ï¼Œè¡¨ç¤ºæ“ä½œæˆåŠŸæˆ–å¤±è´¥çš„çŠ¶æ€ã€‚å¦‚æœå‡½æ•°æ‰§è¡ŒæˆåŠŸï¼ŒçŠ¶æ€ç å°†ä¼šæ˜¯ <code>napi_ok</code>ã€‚</p><p>è®©æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜å®ƒçš„ä½œç”¨ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œéœ€è¦ä» C/C++ å±‚é¢è®¡ç®—æŸç§èµ„æºçš„æ•°é‡ï¼Œå¹¶å°†è¿™ä¸ªæ•°é‡ä¼ é€’ç»™ JavaScriptã€‚</p><p>åœ¨ C/C++ æ’ä»¶ä»£ç ä¸­ï¼Œä½ å¯èƒ½ä¼šæœ‰å¦‚ä¸‹çš„å‡½æ•°ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... å…¶ä»–å¿…è¦çš„å¤´æ–‡ä»¶å’Œä»£ç  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value GetResourceCount(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // å‡è®¾æˆ‘ä»¬é€šè¿‡æŸç§æ–¹å¼è®¡ç®—å¾—åˆ°äº†èµ„æºæ•°é‡</span></span>
<span class="line"><span>    uint32_t resourceCount = CalculateResourceCount();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ª JavaScript æ•°å€¼æ¥ä¿å­˜è¿™ä¸ªæ— ç¬¦å·32ä½æ•´æ•°</span></span>
<span class="line"><span>    napi_value jsResourceCount;</span></span>
<span class="line"><span>    napi_status status = napi_create_uint32(env, resourceCount, &amp;jsResourceCount);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ›å»º JavaScript æ•°å€¼</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œåˆ™æŠ›å‡ºé”™è¯¯</span></span>
<span class="line"><span>        napi_throw_error(env, NULL, &quot;Unable to create uint32 number&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›è¿™ä¸ª JavaScript æ•°å€¼</span></span>
<span class="line"><span>    return jsResourceCount;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œå‡½æ•°åˆ° Node.js</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value exportFn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, GetResourceCount, NULL, &amp;exportFn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;getResourceCount&quot;, exportFn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ JavaScript ä»£ç ä¸­ï¼Œä½ å¯ä»¥åŠ è½½å¹¶ä½¿ç”¨è¿™ä¸ªæ’ä»¶ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/native-addon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è·å–èµ„æºæ•°é‡</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> resourceCount</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getResourceCount</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">èµ„æºæ•°é‡:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> resourceCount</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä¾‹å­å±•ç¤ºäº†å¦‚ä½•åœ¨åŸç”Ÿæ’ä»¶ä¸­ä½¿ç”¨ <code>napi_create_uint32</code> æ¥åˆ›å»ºä¸€ä¸ªæ— ç¬¦å· 32 ä½æ•´æ•°å¹¶å°†å…¶ä»¥ JavaScript æ•°å€¼çš„å½¢å¼ä¼ é€’ç»™ JavaScript ä»£ç ã€‚è¿™ä½¿å¾—åŸç”Ÿä»£ç ä¸ JavaScript ä»£ç ä¹‹é—´çš„æ•°æ®äº¤æ¢å˜å¾—ç®€å•ã€å®‰å…¨ã€‚</p><h4 id="napi-create-int64" tabindex="-1"><a class="header-anchor" href="#napi-create-int64"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_int64" target="_blank" rel="noopener noreferrer">napi_create_int64</a></span></a></h4><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“æ‰§è¡Œ JavaScript ä»£ç çš„å¹³å°ã€‚è€Œ N-API åˆ™æ˜¯ Node.js æä¾›çš„ä¸€å¥— C APIï¼Œå…è®¸åŸç”Ÿæ’ä»¶çš„ä½œè€…ç¼–å†™ä¸ä¾èµ–äº JavaScript è¿è¡Œæ—¶ç‰ˆæœ¬çš„ä»£ç ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§æé«˜åŸç”Ÿæ¨¡å—çš„ç¨³å®šæ€§å’Œå…¼å®¹æ€§ã€‚</p><p><code>napi_create_int64</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒç”¨äºåœ¨åŸç”Ÿä»£ç ä¸­åˆ›å»ºä¸€ä¸ªè¡¨ç¤º 64 ä½æ•´æ•°çš„ JavaScript æ•°å€¼ã€‚åœ¨ JavaScript ä¸­è™½ç„¶æ‰€æœ‰æ•°å­—éƒ½æ˜¯ä»¥åŒç²¾åº¦æµ®ç‚¹æ•°çš„å½¢å¼å­˜å‚¨çš„ï¼Œä½†åœ¨ä¸æ“ä½œç³»ç»Ÿæˆ–è€…å…¶ä»–ä½çº§ç³»ç»Ÿäº¤äº’æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å¤„ç†æ•´æ•°å€¼ï¼Œå°¤å…¶æ˜¯èŒƒå›´è¾ƒå¤§çš„æ•´æ•°ï¼ˆæ¯”å¦‚æ–‡ä»¶å¤§å°ã€å†…å­˜åœ°å€ç­‰ï¼‰ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨åƒ <code>napi_create_int64</code> è¿™æ ·çš„ API æ¥ç¡®ä¿æ•°å­—çš„å‡†ç¡®æ€§ã€‚</p><p>ä¸‹é¢æˆ‘ä¼šç»™ä½ å±•ç¤ºä¸€ä¸ªä½¿ç”¨ <code>napi_create_int64</code> çš„ç®€å•ä¾‹å­ï¼š</p><p>å‡è®¾æˆ‘ä»¬æƒ³åœ¨ Node.js çš„åŸç”Ÿæ‰©å±•ä¸­åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä¼šæ¥æ”¶ä¸€ä¸ª 64 ä½æ•´æ•°ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›å®ƒçš„å€¼ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ C ä»£ç æ¥å®ç°è¿™ä¸ªåŸç”Ÿå‡½æ•°ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å®šä¹‰ä¸€ä¸ªåŸç”Ÿçš„ N-API å‡½æ•°</span></span>
<span class="line"><span>napi_value GetInt64Value(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value the_number;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å‡è®¾æˆ‘ä»¬è¦è¿”å›çš„ 64 ä½æ•´æ•°æ˜¯ 123456789012345</span></span>
<span class="line"><span>    int64_t my_int64 = 123456789012345;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ä½¿ç”¨ napi_create_int64 åˆ›å»ºä¸€ä¸ª JavaScript æ•°å€¼</span></span>
<span class="line"><span>    status = napi_create_int64(env, my_int64, &amp;the_number);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>        napi_throw_error(env, NULL, &quot;Failed to create 64-bit integer&quot;);</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›åˆ›å»ºçš„æ•´æ•°å€¼</span></span>
<span class="line"><span>    return the_number;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œæ³¨å†Œä¸Šé¢å®šä¹‰çš„ &#39;GetInt64Value&#39; å‡½æ•°</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ª JavaScript å‡½æ•°</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, GetInt64Value, NULL, &amp;fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç»™è¿™ä¸ªå‡½æ•°å‘½åä¸º &quot;getInt64Value&quot; å¹¶å¯¼å‡º</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;getInt64Value&quot;, fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ç¼–è¯‘è¿™ä¸ªåŸç”Ÿæ‰©å±•ä½¿ä¹‹æˆä¸º Node.js å¯ä»¥åŠ è½½çš„æ¨¡å—ã€‚ç¼–è¯‘åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ JavaScript ä»£ç ä¸­è¿™æ ·ä½¿ç”¨å®ƒï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// åŠ è½½åŸç”Ÿæ¨¡å—</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/native-addon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è°ƒç”¨æˆ‘ä»¬åˆšæ‰å®ç°çš„åŸç”Ÿæ–¹æ³•</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> int64Value</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getInt64Value</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">int64Value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºï¼š123456789012345</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç®€å•çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ª C å‡½æ•°ï¼Œé€šè¿‡ <code>napi_create_int64</code> åˆ›å»ºäº†ä¸€ä¸ª JavaScript èƒ½å¤Ÿè¯†åˆ«çš„ 64 ä½æ•´æ•°ï¼Œå¹¶å°†å…¶ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ã€‚ç„¶ååœ¨ JavaScript ä»£ç ä¸­ï¼Œæˆ‘ä»¬åŠ è½½å¹¶è°ƒç”¨äº†è¿™ä¸ªåŸç”Ÿæ¨¡å—å‡½æ•°ï¼Œæœ€ç»ˆæ‰“å°å‡ºè¿™ä¸ªæ•´æ•°çš„å€¼ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ°å¯¹ Node.js åŸç”Ÿæ¨¡å—å¼€å‘çš„ç†è§£ï¼ŒåŒ…æ‹¬ C/C++ ç¼–ç¨‹çŸ¥è¯†ã€æ„å»ºå·¥å…·ï¼ˆå¦‚ node-gypï¼‰çš„ä½¿ç”¨ï¼Œä»¥åŠ Node.js çš„ N-APIã€‚å¦‚æœä½ ä»…ä»…æ˜¯ JavaScript å¼€å‘è€…ï¼Œé€šå¸¸ä¸éœ€è¦æ·±å…¥äº†è§£è¿™ä¸€å±‚ï¼Œé™¤éä½ éœ€è¦ç¼–å†™æˆ–ç»´æŠ¤ Node.js çš„åŸç”Ÿæ‰©å±•ã€‚</p><h4 id="napi-create-double" tabindex="-1"><a class="header-anchor" href="#napi-create-double"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_double" target="_blank" rel="noopener noreferrer">napi_create_double</a></span></a></h4><p>åœ¨ Node.js ä¸­ï¼ŒN-API æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚åŸç”Ÿæ’ä»¶æ˜¯ç”¨ C æˆ– C++ç¼–å†™çš„æ¨¡å—ï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥è°ƒç”¨ Node.js æä¾›çš„ APIï¼Œå®ç°ä¸€äº› JavaScript éš¾ä»¥åšåˆ°çš„æ€§èƒ½ä¼˜åŒ–æˆ–ç›´æ¥ä¸æ“ä½œç³»ç»Ÿåº•å±‚äº¤äº’çš„åŠŸèƒ½ã€‚</p><p><code>napi_create_double</code>æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºåŒç²¾åº¦æµ®ç‚¹æ•°ï¼ˆdoubleï¼‰çš„ JavaScript æ•°å€¼ã€‚å½“ä½ åœ¨åŸç”Ÿæ’ä»¶ä¸­ä½¿ç”¨ C æˆ– C++å¤„ç†åŒç²¾åº¦æµ®ç‚¹æ•°æ—¶ï¼Œå¦‚æœä½ æƒ³å°†è¿™ä¸ªæ•°å€¼ä¼ é€’å› JavaScriptï¼Œå°±éœ€è¦æŠŠå®ƒè½¬æ¢æˆ JavaScript èƒ½å¤Ÿè¯†åˆ«å’Œå¤„ç†çš„æ•°å€¼ç±»å‹ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­è¯´æ˜å¦‚ä½•ä½¿ç”¨<code>napi_create_double</code>å‡½æ•°ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°æ˜¯C/C++æ‰©å±•æš´éœ²ç»™JavaScriptçš„ä¸€ä¸ªå‡½æ•°.</span></span>
<span class="line"><span>// å‡è®¾æˆ‘ä»¬è¦è®¡ç®—ä¸€ä¸ªCè¯­è¨€ä¸­çš„åŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™JavaScript.</span></span>
<span class="line"><span>napi_value CalculatePi(napi_env env, napi_callback_info args) {</span></span>
<span class="line"><span>  double pi = 3.14159265359; // åœ¨Cè¯­è¨€ä¸­å®šä¹‰ä¸€ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°pi</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å£°æ˜ä¸€ä¸ªnapi_valueå˜é‡ï¼Œè¿™å°†æ˜¯æˆ‘ä»¬åˆ›å»ºçš„JavaScriptæ•°å€¼çš„å¥æŸ„</span></span>
<span class="line"><span>  napi_value js_pi;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ä½¿ç”¨napi_create_doubleå°†Cè¯­è¨€ä¸­çš„piè½¬æ¢æˆJavaScriptæ•°å€¼</span></span>
<span class="line"><span>  napi_status status = napi_create_double(env, pi, &amp;js_pi);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ›å»ºäº†æ•°å€¼</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œè¿”å›é”™è¯¯</span></span>
<span class="line"><span>    napi_throw_error(env, NULL, &quot;Unable to create a double value&quot;);</span></span>
<span class="line"><span>    return NULL;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å¦‚æœæˆåŠŸï¼Œè¿”å›åˆ›å»ºçš„JavaScriptæ•°å€¼</span></span>
<span class="line"><span>  return js_pi;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œæ³¨å†ŒCalculatePiå‡½æ•°</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>  napi_value export_fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ªJavaScriptå‡½æ•°ï¼Œå½“JavaScriptä»£ç è°ƒç”¨å®ƒæ—¶ï¼Œä¼šæ‰§è¡ŒCalculatePi</span></span>
<span class="line"><span>  napi_create_function(env, &quot;calculatePi&quot;, NAPI_AUTO_LENGTH, CalculatePi, NULL, &amp;export_fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å°†è¿™ä¸ªå‡½æ•°ä½œä¸ºæ¨¡å—çš„å¯¼å‡º</span></span>
<span class="line"><span>  napi_set_named_property(env, exports, &quot;calculatePi&quot;, export_fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º<code>CalculatePi</code>çš„ C å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè®¡ç®—åœ†å‘¨ç‡ Ï€ çš„ä¸€ä¸ªè¿‘ä¼¼å€¼ï¼Œå¹¶é€šè¿‡ä½¿ç”¨<code>napi_create_double</code>å‡½æ•°å°†è¿™ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°å€¼å°è£…ä¸º JavaScript å¯ä»¥ç†è§£çš„æ•°å€¼ç±»å‹ã€‚ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ JavaScript ä»£ç ä¸­è°ƒç”¨è¿™ä¸ªå‡½æ•°å¹¶å¾—åˆ° Ï€ çš„å€¼ã€‚</p><p>ä¾‹å¦‚ï¼Œåœ¨ Node.js ä¸­ï¼Œä½ å¯ä»¥åƒè¿™æ ·ä½¿ç”¨è¿™ä¸ªæ‰©å±•ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> myAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/my_addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // æ›¿æ¢æˆä½ çš„æ‰©å±•å</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">myAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">calculatePi</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºï¼š3.14159265359</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ª JavaScript ä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åŠ è½½äº†æˆ‘ä»¬åˆšæ‰ç¼–å†™çš„åŸç”Ÿæ¨¡å—ï¼Œå¹¶è°ƒç”¨<code>calculatePi</code>æ–¹æ³•ï¼Œå®ƒä¼šè¾“å‡ºæˆ‘ä»¬ä» C æ‰©å±•ä¸­è·å–çš„ Ï€ å€¼ã€‚</p><h4 id="napi-create-bigint-int64" tabindex="-1"><a class="header-anchor" href="#napi-create-bigint-int64"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_bigint_int64" target="_blank" rel="noopener noreferrer">napi_create_bigint_int64</a></span></a></h4><p>Node.js ä¸­çš„<code>napi_create_bigint_int64</code>æ˜¯ä¸€ä¸ª N-API å‡½æ•°ï¼Œå®ƒå…è®¸ä½ åœ¨åŸç”Ÿæ’ä»¶ä»£ç ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ BigInt ç±»å‹çš„å˜é‡ã€‚è¿™ä¸ªå‡½æ•°ç‰¹åˆ«é€‚ç”¨äºéœ€è¦å¤„ç†å¤§æ•´æ•°ï¼ˆè¶…å‡º JavaScript Number èƒ½ç²¾ç¡®è¡¨ç¤ºçš„èŒƒå›´ï¼‰çš„æƒ…å†µã€‚</p><p>N-API æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç¨³å®šçš„ API å±‚ï¼Œå®ƒå…è®¸å¼€å‘è€…ç”¨ C æˆ– C++ç¼–å†™æ‰©å±•æ¨¡å—ï¼Œä¸ Node.js è¿›è¡Œäº¤äº’ã€‚ä½¿ç”¨ N-API ç¼–å†™çš„æ¨¡å—ä¸ä¾èµ–äºç‰¹å®šç‰ˆæœ¬çš„ V8 å¼•æ“ï¼Œè¿™æ„å‘³ç€æ¨¡å—æ›´å®¹æ˜“ä¿æŒè·¨ Node.js ç‰ˆæœ¬çš„å…¼å®¹æ€§ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬è¯¦ç»†è§£é‡Šä¸€ä¸‹<code>napi_create_bigint_int64</code>ï¼š</p><h3 id="å‡½æ•°ç­¾å-3" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°ç­¾å-3"><span>å‡½æ•°ç­¾å</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_create_bigint_int64(napi_env env,</span></span>
<span class="line"><span>                                      int64_t value,</span></span>
<span class="line"><span>                                      napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªå‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°ï¼š</p><ol><li><code>napi_env env</code>: å½“å‰çš„ç¯å¢ƒå¥æŸ„ï¼Œå®ƒä»£è¡¨äº†å½“å‰çš„æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚</li><li><code>int64_t value</code>: ä½ æƒ³è¦è½¬æ¢æˆ BigInt çš„ 64 ä½æ•´æ•°å€¼ã€‚</li><li><code>napi_value* result</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå‡½æ•°ä¼šæŠŠåˆ›å»ºçš„ BigInt èµ‹å€¼åˆ°è¿™é‡Œã€‚</li></ol><p>å‡½æ•°è¿”å›ä¸€ä¸ª<code>napi_status</code>ç±»å‹çš„å€¼ï¼Œè¿™ä»£è¡¨æ“ä½œçš„ç»“æœã€‚å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œè¿”å›<code>napi_ok</code>ã€‚</p><h3 id="å®é™…ä¾‹å­-5" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-5"><span>å®é™…ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åŸç”Ÿæ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—éœ€è¦å¤„ç†å¤§é‡çš„æ•°æ®ï¼Œä¾‹å¦‚åŠ å¯†æˆ–è€…æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€‚è€Œè¿™äº›æ“ä½œæ¶‰åŠåˆ°çš„æ•°å­—å¯èƒ½éå¸¸å¤§ï¼Œå¤§åˆ°ä¸èƒ½ç”¨æ ‡å‡†çš„ JavaScript æ•°å­—ç±»å‹ï¼ˆNumberï¼‰æ¥ç²¾ç¡®åœ°è¡¨ç¤ºã€‚</p><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºæ–‡ä»¶å¤§å°çš„ BigIntï¼Œæ–‡ä»¶å¤§å°ä¸º<code>9223372036854775807</code>å­—èŠ‚ï¼ˆè¿™ä¸ªå€¼æ¥è¿‘ 64 ä½æ•´å‹çš„æœ€å¤§å€¼ï¼‰ï¼Œä»¥ä¸‹æ˜¯åœ¨ C++ä¸­ä½¿ç”¨<code>napi_create_bigint_int64</code>çš„ç¤ºä¾‹ä»£ç ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™ä¸ªå‡½æ•°ä½œä¸ºä¸€ä¸ªåŸç”Ÿæ¨¡å—å¯¼å‡ºç»™JSè°ƒç”¨</span></span>
<span class="line"><span>napi_value GetFileSizeAsBigInt(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  // å­˜å‚¨æœ€ç»ˆBigIntç»“æœçš„å˜é‡</span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ–‡ä»¶å¤§å°</span></span>
<span class="line"><span>  int64_t fileSize = 9223372036854775807;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ›å»ºBigInt</span></span>
<span class="line"><span>  napi_status status = napi_create_bigint_int64(env, fileSize, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ›å»ºBigInt</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // åˆ›å»ºå¤±è´¥ï¼Œå¯èƒ½éœ€è¦å¤„ç†é”™è¯¯</span></span>
<span class="line"><span>    // ä¾‹å¦‚æŠ›å‡ºå¼‚å¸¸ç­‰</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›åˆ›å»ºå¥½çš„BigIntç»™JavaScript</span></span>
<span class="line"><span>  return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å…¶ä»–å°†å‡½æ•°å¯¼å‡ºåˆ°JSçš„ä»£ç ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ JavaScript ä»£ç è°ƒç”¨è¿™ä¸ªåŸç”Ÿæ¨¡å—æ—¶ï¼Œå®ƒå°†ä¼šå¾—åˆ°ä¸€ä¸ª BigInt å¯¹è±¡ï¼Œå¯ä»¥å®‰å…¨åœ°è¡¨ç¤ºå’Œæ“ä½œè¿™ä¸ªå·¨å¤§çš„æ•°å­—ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>napi_create_bigint_int64</code>åœ¨ Node.js çš„åŸç”Ÿæ¨¡å—å¼€å‘ä¸­ç”¨äºåˆ›å»ºèƒ½è¡¨ç¤ºè¶…å¤§æ•´æ•°çš„ BigInt å¯¹è±¡ï¼Œä»è€Œä½¿å¾—è¿™äº›æ¨¡å—èƒ½å¤Ÿå¤„ç†è¶…å‡º JavaScript Number ç±»å‹èƒ½åŠ›èŒƒå›´çš„æ•°æ®ã€‚</p><h4 id="napi-create-bigint-uint64" tabindex="-1"><a class="header-anchor" href="#napi-create-bigint-uint64"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_bigint_uint64" target="_blank" rel="noopener noreferrer">napi_create_bigint_uint64</a></span></a></h4><p>å½“ç„¶ï¼Œè®©æˆ‘æ¥è¯¦ç»†è§£é‡Šä¸€ä¸‹ Node.js ä¸­çš„ <code>napi_create_bigint_uint64</code> è¿™ä¸ªå‡½æ•°ã€‚</p><p>åœ¨ Node.js ä¸­ï¼ŒN-APIï¼ˆNode APIï¼‰æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶ï¼ˆnative addonsï¼‰çš„ API å±‚ï¼Œå®ƒå…è®¸ C å’Œ C++ä»£ç ä¸ JavaScript äº¤äº’ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ç”¨ C æˆ– C++ç¼–å†™ä¸€äº›æ€§èƒ½å¯†é›†æˆ–è€…ç³»ç»Ÿçº§åˆ«çš„æ“ä½œï¼Œå¹¶é€šè¿‡ N-API æš´éœ²ç»™ä½ çš„ Node.js åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚</p><p><code>napi_create_bigint_uint64</code> æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒç”¨äºåˆ›å»ºä¸€ä¸ªè¡¨ç¤ºå¤§æ•´æ•°ï¼ˆBigIntï¼‰çš„ JavaScript å€¼ã€‚ç”±äº JavaScript ä¸­çš„ Number ç±»å‹ä¸èƒ½å®‰å…¨åœ°è¡¨ç¤ºæ‰€æœ‰çš„ 64 ä½æ•´æ•°ï¼ˆå› ä¸ºå…¶åŒç²¾åº¦æµ®ç‚¹æ ¼å¼åªèƒ½ç²¾ç¡®è¡¨ç¤ºåˆ° 53 ä½ï¼‰ï¼ŒBigInt ç±»å‹å°±å‡ºç°äº†ï¼Œå®ƒå¯ä»¥è¡¨ç¤ºä»»æ„å¤§å°çš„æ•´æ•°ã€‚</p><h3 id="å‡½æ•°åŸå‹" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°åŸå‹"><span>å‡½æ•°åŸå‹ï¼š</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_create_bigint_uint64(</span></span>
<span class="line"><span>    napi_env env,</span></span>
<span class="line"><span>    uint64_t value,</span></span>
<span class="line"><span>    napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>: è¿™æ˜¯ N-API è°ƒç”¨çš„ç¯å¢ƒä¸Šä¸‹æ–‡ï¼Œç”¨äºä»£è¡¨å½“å‰çš„ Node.js ç¯å¢ƒã€‚</li><li><code>value</code>: è¿™æ˜¯ä½ æƒ³è¦è½¬æ¢ä¸º BigInt çš„æ— ç¬¦å· 64 ä½æ•´æ•°ï¼ˆuint64_tï¼‰ã€‚</li><li><code>result</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘ napi_value çš„æŒ‡é’ˆï¼Œè¯¥å‡½æ•°ä¼šå°†åˆ›å»ºçš„ BigInt å€¼å­˜å‚¨åœ¨è¿™é‡Œè¿”å›ã€‚</li></ul><h3 id="ä½¿ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯"><span>ä½¿ç”¨åœºæ™¯ï¼š</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js æœ¬åœ°æ’ä»¶ï¼Œéœ€è¦å¤„ç†éå¸¸å¤§çš„æ•´æ•°ï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿä¸­å¤§æ–‡ä»¶çš„å­—èŠ‚å¤§å°ï¼Œæˆ–è€…æŸäº›é«˜ç²¾åº¦æ—¶é—´æˆ³ç­‰ã€‚åœ¨ C/C++ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ 64 ä½æ•´æ•°æ¥ç²¾ç¡®è¡¨ç¤ºè¿™äº›å€¼ï¼Œä½†æ˜¯å¦‚æœä½ éœ€è¦å°†è¿™äº›å€¼ä¼ é€’ç»™ JavaScriptï¼Œå°±ä¼šé‡åˆ°ç²¾åº¦é—®é¢˜ã€‚ä½¿ç”¨ <code>napi_create_bigint_uint64</code> å‡½æ•°ï¼Œä½ å¯ä»¥å°† C/C++ä¸­çš„ 64 ä½æ•´æ•°å®‰å…¨åœ°è½¬æ¢ä¸º JavaScript çš„ BigIntã€‚</p><h3 id="å®é™…ä¾‹å­-6" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-6"><span>å®é™…ä¾‹å­ï¼š</span></a></h3><p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰ä¸€ä¸ª C å‡½æ•°ï¼Œå®ƒè¿”å›äº†ä¸€ä¸ªå¾ˆå¤§çš„æ–‡ä»¶çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œè¿™ä¸ªæ•°å­—å¯èƒ½ä¼šè¶…è¿‡ JavaScript Number ç±»å‹çš„å®‰å…¨æ•´æ•°èŒƒå›´ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>napi_create_bigint_uint64</code> å°†è¿™ä¸ªå€¼è½¬æ¢ä¸º BigIntï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™ä¸ªå‡½æ•°æ˜¯ä»æŸå¤„è·å–æ–‡ä»¶å¤§å°çš„</span></span>
<span class="line"><span>uint64_t get_large_file_size() {</span></span>
<span class="line"><span>    // è¿”å›ä¸€ä¸ªå¤§äº2^53çš„æ–‡ä»¶å¤§å°</span></span>
<span class="line"><span>    return (uint64_t)9007199254740993;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯æš´éœ²ç»™Node.jsçš„N-APIå‡½æ•°</span></span>
<span class="line"><span>napi_value GetFileSizeAsBigInt(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    uint64_t file_size = get_large_file_size();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºBigInt</span></span>
<span class="line"><span>    napi_value big_int_value;</span></span>
<span class="line"><span>    napi_status status = napi_create_bigint_uint64(env, file_size, &amp;big_int_value);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // é”™è¯¯å¤„ç†...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return big_int_value; // è¿”å›BigIntç»™JavaScript</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åï¼Œåœ¨ä½ çš„ Node.js ä»£ç ä¸­ï¼Œä½ å¯ä»¥è°ƒç”¨è¿™ä¸ªå‡½æ•°å¹¶è·å¾—ä¸€ä¸ªèƒ½å¤Ÿå®‰å…¨è¡¨ç¤ºå¤§æ•°å­—çš„ BigIntï¼š</p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/native-addon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è¿™å°†è°ƒç”¨æˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„Cå‡½æ•°å¹¶è¿”å›ä¸€ä¸ªBigInt</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fileSize</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">GetFileSizeAsBigInt</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">fileSize</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºç±»ä¼¼äºï¼š9007199254740993n</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼Œåœ¨ JavaScript ç«¯ï¼ŒBigInt å€¼æœ«å°¾ä¼šæœ‰ä¸€ä¸ª &quot;n&quot; æ¥è¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ª BigInt ç±»å‹ï¼Œè€Œä¸æ˜¯æ™®é€šçš„ Numberã€‚</p><h4 id="napi-create-bigint-words" tabindex="-1"><a class="header-anchor" href="#napi-create-bigint-words"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_bigint_words" target="_blank" rel="noopener noreferrer">napi_create_bigint_words</a></span></a></h4><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬æ¥èŠä¸€ä¸‹ Node.js ä¸­çš„<code>napi_create_bigint_words</code>è¿™ä¸ªåŠŸèƒ½ã€‚</p><p>é¦–å…ˆè§£é‡Šä¸€ä¸‹ï¼Œä»€ä¹ˆæ˜¯ N-APIã€‚N-API æ˜¯ä¸€ä¸ª C è¯­è¨€çš„ APIï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨ C æˆ–è€… C++ä»£ç ç¼–å†™æ‰©å±•ï¼Œè¿™äº›æ‰©å±•å¯ä»¥ç›´æ¥è¢« Node.js è°ƒç”¨ã€‚è¿™æœ‰åŠ©äºæé«˜æ€§èƒ½ï¼Œå¹¶å…è®¸é‡ç”¨å·²æœ‰çš„ C/C++åº“ã€‚</p><p>ç°åœ¨ï¼Œè°ˆåˆ°<code>napi_create_bigint_words</code>ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ N-API æä¾›çš„ä¸€éƒ¨åˆ†ï¼Œä¸“é—¨ç”¨æ¥åˆ›å»º JavaScript ä¸­çš„ BigInt ç±»å‹ã€‚åœ¨ JavaScript ä¸­ï¼ŒBigInt æ˜¯ä¸€ç§æ–°çš„æ•°å€¼ç±»å‹ï¼Œå®ƒå…è®¸ä½ å®‰å…¨åœ°å­˜å‚¨å’Œæ“ä½œå¤§æ•´æ•°ï¼Œç”šè‡³æ˜¯è¶…è¿‡äº† Number ç±»å‹èƒ½è¡¨ç¤ºçš„èŒƒå›´ã€‚</p><p>å…·ä½“åˆ°<code>napi_create_bigint_words</code>ï¼Œè¿™ä¸ªå‡½æ•°ä½¿å¾—ä½ å¯ä»¥ä» C/C++å±‚é¢åˆ›å»ºä¸€ä¸ª BigInt å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä» JavaScript åˆ›å»ºã€‚è¿™åœ¨æŸäº›æƒ…å†µä¸‹éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚å½“ä½ åœ¨ä¸€ä¸ª node æ‰©å±•ä¸­å¤„ç†å¤§æ•´æ•°æ—¶ï¼Œæˆ–è€…å½“ä½ æƒ³è¦å°†ä¸€ä¸ªåº•å±‚çš„æ•°å€¼åº“ç»“æœè½¬æ¢ä¸º BigInt ä½¿å…¶åœ¨ JavaScript ä¸­å¯ç”¨æ—¶ã€‚</p><p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯åˆ›å»ºä¸€ä¸ªä»£è¡¨2^64çš„BigInt</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CreateBigInt(napi_env env) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // BigIntç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šä½ä½(low word)å’Œé«˜ä½(high word)</span></span>
<span class="line"><span>    // é€šè¿‡äºŒè¿›åˆ¶å¯ä»¥è¡¨ç¤ºä¸º high_word `&lt;``&lt;` 64 | low_wordã€‚</span></span>
<span class="line"><span>    uint64_t low_word = 0; // åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œä½ä½æ˜¯0</span></span>
<span class="line"><span>    uint64_t high_word = 1; // é«˜ä½æ˜¯1ï¼Œå› ä¸º2^64ç›¸å½“äº1åé¢è·Ÿç€64ä¸ª0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªnapi_valueæ¥å­˜æ”¾æˆ‘ä»¬å³å°†åˆ›å»ºçš„BigInt</span></span>
<span class="line"><span>    napi_value big_int_value;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è°ƒç”¨napi_create_bigint_wordsæ¥åˆ›å»ºBigInt</span></span>
<span class="line"><span>    // å‚æ•°è§£è¯»ï¼š</span></span>
<span class="line"><span>    // env: å½“å‰çš„ç¯å¢ƒä¸Šä¸‹æ–‡</span></span>
<span class="line"><span>    // sign_bit: è¡¨ç¤ºnumberæ˜¯æ­£è¿˜æ˜¯è´Ÿï¼Œ0ä»£è¡¨æ­£æ•°</span></span>
<span class="line"><span>    // word_count: æˆ‘ä»¬ä¼ é€’çš„wordsæ•°é‡</span></span>
<span class="line"><span>    // words: æŒ‡å‘æˆ‘ä»¬æ•°å€¼çš„æŒ‡é’ˆ</span></span>
<span class="line"><span>    // result: è¾“å‡ºå‚æ•°ï¼Œåˆ›å»ºå¥½çš„BigIntå°†è¢«èµ‹å€¼åˆ°è¿™é‡Œ</span></span>
<span class="line"><span>    status = napi_create_bigint_words(env, 0, 1, &amp;high_word, &amp;big_int_value);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦åˆ›å»ºæˆåŠŸ</span></span>
<span class="line"><span>    if(status != napi_ok){</span></span>
<span class="line"><span>        napi_throw_error(env, NULL, &quot;Unable to create BigInt&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return big_int_value;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªè¡¨ç¤º 2^64 çš„ BigInt å¯¹è±¡ã€‚æˆ‘ä»¬é¦–å…ˆå£°æ˜äº† <code>low_word</code> å’Œ <code>high_word</code>ï¼Œç„¶åè°ƒç”¨<code>napi_create_bigint_words</code>æ¥å®é™…åˆ›å»º BigInt å¯¹è±¡ã€‚æ³¨æ„ï¼Œæˆ‘ä»¬çš„<code>sign_bit</code>è®¾ç½®ä¸º 0ï¼Œå› ä¸ºæˆ‘ä»¬è¦åˆ›å»ºçš„æ˜¯ä¸€ä¸ªæ­£æ•°ã€‚</p><p>å¦‚æœä½ åœ¨æ„å»ºæ›´å¤æ‚çš„ node æ‰©å±•ï¼Œåœ¨å¤„ç†å¤§æ•´æ•°é—®é¢˜æ—¶ï¼Œå°±å¯èƒ½ä¼šç”¨åˆ°è¿™ä¸ªå‡½æ•°ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½æ­£åœ¨å°è£…ä¸€ä¸ªé‡‘èè®¡ç®—åº“ï¼Œéœ€è¦å¤„ç†æ¯”æ ‡å‡† js Number ç±»å‹æ›´å¤§çš„æ•°å­—ï¼Œé‚£ä¹ˆä½ å°±ä¼šåœ¨ C/C++å±‚é¢ä½¿ç”¨<code>napi_create_bigint_words</code>æ¥åˆ›å»º BigIntï¼Œç„¶ååœ¨ä½ çš„ node åº”ç”¨ä¸­ä½¿ç”¨å®ƒã€‚</p><h4 id="napi-create-string-latin1" tabindex="-1"><a class="header-anchor" href="#napi-create-string-latin1"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_string_latin1" target="_blank" rel="noopener noreferrer">napi_create_string_latin1</a></span></a></h4><p>å¥½çš„ï¼Œæˆ‘æ¥è§£é‡Šä¸€ä¸‹ Node.js ä¸­çš„<code>napi_create_string_latin1</code>è¿™ä¸ªå‡½æ•°ã€‚</p><p>åœ¨ Node.js é‡Œï¼ŒN-API æä¾›äº†ä¸€ä¸ªä¸ JavaScript å¼•æ“æ— å…³çš„åŸç”Ÿï¼ˆnativeï¼‰APIï¼Œå®ƒå…è®¸ä½ ç¼–å†™å¯ä»¥åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸Šè¿è¡Œçš„ C/C++æ‰©å±•ã€‚<code>napi_create_string_latin1</code>æ˜¯ N-API ä¸­çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒå…è®¸ä½ ä» C/C++ä»£ç ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å­—ç¬¦ä¸²ã€‚</p><p>å½“ä½ åœ¨ C/C++ä¸­ä½¿ç”¨<code>napi_create_string_latin1</code>æ—¶ï¼Œä½ å¯ä»¥å°†ä¸€ä¸ªæ ‡å‡†çš„ä»¥ null ç»“å°¾çš„ C å­—ç¬¦ä¸²ï¼ˆä½¿ç”¨ Latin-1/ISO-8859-1 ç¼–ç ï¼‰è½¬åŒ–æˆä¸€ä¸ª JavaScript å­—ç¬¦ä¸²ã€‚Latin-1 ç¼–ç åŒ…æ‹¬è‹±æ–‡å­—ç¬¦å’Œæ¬§æ´²å¸¸ç”¨çš„å…¶ä»–ä¸€äº›å­—ç¬¦ã€‚</p><p>è¿™é‡Œæœ‰ä¸€äº›å‚æ•°éœ€è¦äº†è§£ï¼š</p><ul><li><code>env</code>: è¿™æ˜¯ä¸€ä¸ªè¡¨ç¤º N-API ç¯å¢ƒçš„å¥æŸ„ï¼Œå®ƒç”¨äºå¤§å¤šæ•° N-API è°ƒç”¨ä»¥æä¾› Node.js è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ã€‚</li><li><code>str</code>: æ˜¯ C å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼Œè¡¨ç¤ºè¦è½¬æ¢æˆ JavaScript å­—ç¬¦ä¸²çš„åŸå§‹ Latin-1 ç¼–ç çš„å­—ç¬¦åºåˆ—ã€‚</li><li><code>length</code>: è¿™æ˜¯å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå¦‚æœä½ ä¼ é€’<code>-1</code>ï¼Œå‡½æ•°å°†å‡å®šå­—ç¬¦ä¸²æ˜¯ä»¥ null ç»“å°¾çš„ï¼Œå¹¶è®¡ç®—é•¿åº¦ã€‚</li><li><code>result</code>: è¿™æ˜¯ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼Œç”¨äºæ¥æ”¶åˆ›å»ºçš„ JavaScript å­—ç¬¦ä¸²ã€‚</li></ul><p>ç°åœ¨ä¸¾ä¾‹è¯´æ˜ï¼š<br> å‡è®¾ä½ æƒ³åœ¨ C/C++æ‰©å±•ä¸­åˆ›å»ºä¸€ä¸ªè¡¨ç¤º&quot;hello&quot;çš„ JavaScript å­—ç¬¦ä¸²ã€‚ä¸‹é¢æ˜¯å¦‚ä½•ä½¿ç”¨<code>napi_create_string_latin1</code>å®ç°çš„ä¼ªä»£ç ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ä½ å·²ç»æœ‰äº†napi_env envå˜é‡</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¦è½¬æ¢æˆJavaScriptå­—ç¬¦ä¸²çš„Cå­—ç¬¦ä¸²</span></span>
<span class="line"><span>const char* c_str = &quot;hello&quot;;</span></span>
<span class="line"><span>size_t str_length = 5; // å­—ç¬¦ä¸²&quot;hello&quot;çš„é•¿åº¦</span></span>
<span class="line"><span>napi_value result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è°ƒç”¨napi_create_string_latin1æ¥åˆ›å»ºä¸€ä¸ªJavaScriptå­—ç¬¦ä¸²</span></span>
<span class="line"><span>napi_status status = napi_create_string_latin1(env, c_str, str_length, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ£€æŸ¥æ“ä½œæ˜¯å¦æˆåŠŸ</span></span>
<span class="line"><span>if (status == napi_ok) {</span></span>
<span class="line"><span>    // å¦‚æœæˆåŠŸï¼Œæ­¤æ—¶resultå°±æ˜¯ä¸€ä¸ªJavaScriptå­—ç¬¦ä¸²</span></span>
<span class="line"><span>    // å¯ä»¥åœ¨ä½ çš„N-APIå‡½æ•°ä¸­è¿”å›å®ƒï¼Œæˆ–è€…ç”¨å®ƒè¿›è¡Œå…¶ä»–æ“ä½œ</span></span>
<span class="line"><span>} else {</span></span>
<span class="line"><span>    // é”™è¯¯å¤„ç†</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ å¯èƒ½ä¼šåœ¨ä¸€ä¸ª N-API æ¨¡å—çš„å‡½æ•°å†…éƒ¨ä½¿ç”¨è¿™ç§æ–¹å¼æ¥åˆ›å»º JavaScript å­—ç¬¦ä¸²ï¼Œç„¶åå°†å…¶è¿”å›ç»™ JavaScript å±‚çš„ä»£ç ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªè¯»å–æŸä¸ªç¡¬ä»¶è®¾å¤‡çŠ¶æ€å¹¶è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²æè¿°çš„æ‰©å±•ï¼Œä½ å¯èƒ½ä¼šä»è¯¥è®¾å¤‡è¯»å–æ•°æ®ï¼Œç„¶åä½¿ç”¨<code>napi_create_string_latin1</code>æ¥åˆ›å»ºä¸€ä¸ªç›¸åº”çš„ JavaScript å­—ç¬¦ä¸²æ¥æè¿°é‚£ä¸ªçŠ¶æ€ã€‚</p><h4 id="node-api-create-external-string-latin1" tabindex="-1"><a class="header-anchor" href="#node-api-create-external-string-latin1"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#node_api_create_external_string_latin1" target="_blank" rel="noopener noreferrer">node_api_create_external_string_latin1</a></span></a></h4><p><code>node_api_create_external_string_latin1</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ª N-API å‡½æ•°ã€‚N-API æ˜¯ä¸€ç§ç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶çš„ APIï¼Œå®ƒæä¾›äº†ä¸åº•å±‚ Node.js JavaScript è¿è¡Œæ—¶è¿›è¡Œäº¤äº’çš„æ–¹æ³•ã€‚æ­¤å‡½æ•°ç‰¹åˆ«ç”¨äºåˆ›å»ºâ€œå¤–éƒ¨â€å­—ç¬¦ä¸²ï¼Œè¿™æ„å‘³ç€å®ƒå…è®¸ä½ å°†ç°æœ‰çš„å­—ç¬¦æ•°æ®ä½œä¸º Node.js ä¸­çš„ JavaScript å­—ç¬¦ä¸²ä½¿ç”¨ï¼Œè€Œä¸å¿…å¤åˆ¶æ•°æ®ã€‚</p><p>åœ¨è¯¦ç»†è§£é‡Šä¹‹å‰ï¼Œå…ˆæ¥ç†è§£å‡ ä¸ªæ¦‚å¿µï¼š</p><ul><li><strong>N-API</strong>: Node.js çš„ä¸€ä¸ªç¨³å®šã€ç‰ˆæœ¬æ— å…³çš„ APIï¼Œç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶ã€‚</li><li><strong>å¤–éƒ¨å­—ç¬¦ä¸²ï¼ˆExternal stringï¼‰</strong>: JavaScript ä¸­çš„å­—ç¬¦ä¸²ï¼Œå…¶å†…å­˜æ˜¯ç”±å¼€å‘è€…ç®¡ç†çš„ï¼Œè€Œéç”± JavaScript å¼•æ“ç®¡ç†ã€‚</li><li><strong>Latin1</strong>: ä¹Ÿç§°ä¸º ISO-8859-1ï¼Œæ˜¯ä¸€ä¸ª 8 ä½çš„å•å­—èŠ‚ç¼–ç æ–¹æ¡ˆï¼Œå¯ä»¥è¡¨ç¤ºè¥¿æ¬§è¯­ç³»ä¸­çš„å¤§å¤šæ•°å­—ç¬¦ã€‚</li></ul><h3 id="åŠŸèƒ½" tabindex="-1"><a class="header-anchor" href="#åŠŸèƒ½"><span>åŠŸèƒ½</span></a></h3><p><code>node_api_create_external_string_latin1</code> å…è®¸ä½ æŠŠå·²ç»å­˜åœ¨çš„ Latin1 ç¼–ç çš„å­—ç¬¦æ•°ç»„åˆ›å»ºæˆä¸€ä¸ª Node.js çš„å­—ç¬¦ä¸²ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯é¿å…äº†å°†ç°æœ‰å­—ç¬¦ä¸²å¤åˆ¶åˆ°æ–°çš„å†…å­˜ä½ç½®ï¼ŒèŠ‚çœäº†æ—¶é—´å’Œç©ºé—´ã€‚</p><h3 id="å‚æ•°" tabindex="-1"><a class="header-anchor" href="#å‚æ•°"><span>å‚æ•°</span></a></h3><p>è¿™ä¸ªå‡½æ•°æ¥æ”¶ä»¥ä¸‹å‚æ•°ï¼š</p><ul><li><code>env</code>: å½“å‰æ‰§è¡Œç¯å¢ƒçš„å¥æŸ„ï¼Œæä¾›ç»™æ‰€æœ‰ N-API è°ƒç”¨ã€‚</li><li><code>data</code>: æŒ‡å‘ä½ æƒ³è¦è½¬æ¢æˆ JavaScript å­—ç¬¦ä¸²çš„ Latin1 ç¼–ç æ•°æ®çš„æŒ‡é’ˆã€‚</li><li><code>length</code>: æ•°æ®çš„é•¿åº¦ï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚</li><li><code>result</code>: ç”¨æ¥å­˜æ”¾åˆ›å»ºå¥½çš„ JavaScript å­—ç¬¦ä¸²çš„å˜é‡ã€‚</li></ul><h3 id="ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹-1" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹-1"><span>ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹</span></a></h3><p>å‡è®¾ä½ åœ¨ C/C++æ‰©å±•æ¨¡å—ä¸­æœ‰ä¸€ä¸ªä»¥ Latin1 ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œå¹¶å¸Œæœ›å°†å®ƒä¼ é€’ç»™ Node.js ä¸­çš„ JavaScript ä»£ç ä½¿ç”¨ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ä½ æœ‰ä¸€ä¸ªLatin1ç¼–ç çš„å­—ç¬¦ä¸²æ•°æ®</span></span>
<span class="line"><span>const char* latin1_string = &quot;Hello, World!&quot;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°ä¼šè¢«è°ƒç”¨æ¥åˆ›å»ºä¸€ä¸ªNode.jsçš„String</span></span>
<span class="line"><span>napi_value CreateLatin1String(napi_env env) {</span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æŠŠå¤–éƒ¨Latin1ç¼–ç çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºNode.jså­—ç¬¦ä¸²</span></span>
<span class="line"><span>  napi_status status = node_api_create_external_string_latin1(</span></span>
<span class="line"><span>    env,</span></span>
<span class="line"><span>    latin1_string,</span></span>
<span class="line"><span>    NAPI_AUTO_LENGTH, // è‡ªåŠ¨è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦</span></span>
<span class="line"><span>    &amp;result</span></span>
<span class="line"><span>  );</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯æƒ…å†µ...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return result; // è¿”å›åˆ›å»ºçš„å­—ç¬¦ä¸²</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... æ¥ä¸‹æ¥ï¼Œä½ éœ€è¦å°†ä¸Šé¢çš„å‡½æ•°æš´éœ²ç»™Node.js ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>CreateLatin1String</code> çš„å‡½æ•°ï¼Œå®ƒä½¿ç”¨ <code>node_api_create_external_string_latin1</code> æ¥åˆ›å»ºä¸€ä¸ª Node.js çš„å­—ç¬¦ä¸²ã€‚æˆ‘ä»¬ä¼ å…¥äº†ä¸€ä¸ªæŒ‡å‘ Latin1 ç¼–ç å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼Œå‘Šè¯‰å‡½æ•°è‡ªåŠ¨è®¡ç®—å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ä¸ªç”¨äºå­˜æ”¾ç»“æœå­—ç¬¦ä¸²çš„å˜é‡ã€‚æˆåŠŸè°ƒç”¨åï¼Œ<code>result</code> å°†åŒ…å«ä¸€ä¸ª Node.js å­—ç¬¦ä¸²ï¼Œå¯ä»¥åƒä»»ä½•å…¶ä»–å­—ç¬¦ä¸²é‚£æ ·åœ¨ JavaScript ä¸­ä½¿ç”¨ã€‚</p><h3 id="æ³¨æ„äº‹é¡¹-2" tabindex="-1"><a class="header-anchor" href="#æ³¨æ„äº‹é¡¹-2"><span>æ³¨æ„äº‹é¡¹</span></a></h3><p>ä½¿ç”¨å¤–éƒ¨å­—ç¬¦ä¸²æ—¶ï¼Œéœ€è¦ç¡®ä¿åœ¨å­—ç¬¦ä¸²ä»ç„¶è¢«ä½¿ç”¨æ—¶ä¸è¦é‡Šæ”¾æˆ–ä¿®æ”¹åº•å±‚çš„å†…å­˜å—ã€‚å¦‚æœåº•å±‚çš„æ•°æ®è¢«æ”¹å˜æˆ–åˆ é™¤ï¼Œé‚£ä¹ˆ JavaScript ä¸­çš„å­—ç¬¦ä¸²ä¹Ÿä¼šå—åˆ°å½±å“ï¼Œå¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒæˆ–å‡ºç°ä¸å¯é¢„æµ‹çš„è¡Œä¸ºã€‚</p><p>æ€»ä¹‹ï¼Œ<code>node_api_create_external_string_latin1</code> æ˜¯ä¸€ä¸ªå¼ºå¤§çš„åŠŸèƒ½ï¼Œå®ƒèƒ½å¤Ÿé«˜æ•ˆåœ°å°†æœ¬åœ°ä»£ç ä¸­çš„å­—ç¬¦ä¸²æ•°æ®è½¬æ¢ä¸º JavaScript å­—ç¬¦ä¸²ï¼Œä½†å®ƒéœ€è¦å¼€å‘è€…åœ¨å†…å­˜ç®¡ç†æ–¹é¢è¿›è¡Œé¢å¤–çš„æ³¨æ„ã€‚</p><h4 id="napi-create-string-utf16" tabindex="-1"><a class="header-anchor" href="#napi-create-string-utf16"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_string_utf16" target="_blank" rel="noopener noreferrer">napi_create_string_utf16</a></span></a></h4><p>å½“ç„¶ï¼Œæˆ‘æ¥å¸®ä½ è§£é‡Šä¸€ä¸‹ <code>napi_create_string_utf16</code> è¿™ä¸ªå‡½æ•°ã€‚</p><p>åœ¨ Node.js ä¸­ï¼Œ<code>napi_create_string_utf16</code> æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼Œè€Œ N-API æ˜¯ä¸€ä¸ª C è¯­è¨€çš„æ¥å£ï¼Œè®©ä½ å¯ä»¥åˆ›å»ºæœ¬åœ°æ’ä»¶ã€‚è¿™äº›æ’ä»¶æ˜¯ç”¨ C æˆ– C++å†™çš„ï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥å’Œ Node.js çš„è¿è¡Œæ—¶è¿›è¡Œäº¤äº’ï¼Œé€šå¸¸ç”¨äºæ€§èƒ½æ•æ„Ÿçš„æ“ä½œæˆ–è€…æ˜¯è°ƒç”¨ç³»ç»Ÿçº§åˆ«ã€ç¡¬ä»¶ç›¸å…³çš„åº“ã€‚</p><p><code>napi_create_string_utf16</code> å‡½æ•°ç”¨äºåœ¨åŸç”Ÿä»£ç ä¸­åˆ›å»ºä¸€ä¸ª UTF-16 ç¼–ç çš„ JavaScript å­—ç¬¦ä¸²ã€‚UTF-16 æ˜¯ä¸€ç§å­—ç¬¦ç¼–ç æ–¹å¼ï¼Œå®ƒèƒ½è¡¨ç¤º Unicode æ ‡å‡†ä¸­çš„å¤§éƒ¨åˆ†å­—ç¬¦ï¼Œå¹¶ä¸”åœ¨ JavaScript å†…éƒ¨æ˜¯é»˜è®¤çš„å­—ç¬¦ä¸²ç¼–ç ã€‚</p><p>ä¸‹é¢æ˜¯è¿™ä¸ªå‡½æ•°å…·ä½“çš„æè¿°ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_create_string_utf16(napi_env env,</span></span>
<span class="line"><span>                                     const char16_t* str,</span></span>
<span class="line"><span>                                     size_t length,</span></span>
<span class="line"><span>                                     napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‡½æ•°å‚æ•°è§£é‡Šï¼š</p><ul><li><code>env</code>: å½“å‰ native API çš„ç¯å¢ƒå¥æŸ„ï¼Œå®ƒæ˜¯æ“ä½œ N-API çš„ä¸Šä¸‹æ–‡ã€‚</li><li><code>str</code>: æŒ‡å‘ UTF-16 ç¼–ç å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€‚</li><li><code>length</code>: å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œç”¨å­—ç¬¦æ•°è¡¨ç¤ºã€‚å¦‚æœé•¿åº¦è®¾ç½®ä¸º -1ï¼Œåˆ™å‡å®šå­—ç¬¦ä¸²ä»¥ null ç»ˆæ­¢ç¬¦ç»“æŸã€‚</li><li><code>result</code>: æ˜¯ä¸€ä¸ªå‡ºå‚ï¼Œç”¨äºè¿”å›åˆ›å»ºçš„ JavaScript å­—ç¬¦ä¸²ã€‚</li></ul><p>å‡½æ•°ä¼šè¿”å›ä¸€ä¸ª<code>napi_status</code>æšä¸¾å€¼ï¼Œè¡¨ç¤ºæ“ä½œæˆåŠŸä¸å¦ã€‚å¦‚æœå‡½æ•°æ‰§è¡ŒæˆåŠŸï¼Œ<code>result</code>å°†åŒ…å«å¯¹åº”çš„ JavaScript å­—ç¬¦ä¸²å€¼ã€‚</p><p>ä¾‹å­ï¼š</p><p>å‡è®¾æˆ‘ä»¬è¦åœ¨æœ¬åœ°æ’ä»¶ä¸­åˆ›å»ºä¸€ä¸ª JavaScript å­—ç¬¦ä¸² &quot;Hello, World!&quot; å¹¶è¿”å›ç»™ Node.jsã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªå­—ç¬¦ä¸²è½¬æ¢æˆ UTF-16 ç¼–ç ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CreateUtf16String(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  // UTF-16ç¼–ç çš„ &quot;Hello, World!&quot; å­—ç¬¦ä¸²</span></span>
<span class="line"><span>  // åœ¨Cè¯­è¨€ä¸­ï¼ŒUTF-16å­—ç¬¦ä¸²é€šå¸¸ä½¿ç”¨ char16_t ç±»å‹è¡¨ç¤º</span></span>
<span class="line"><span>  const char16_t str[] = u&quot;Hello, World!&quot;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æˆ‘ä»¬çŸ¥é“è¿™ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ä¼ å…¥ï¼Œ</span></span>
<span class="line"><span>  // å¦‚æœä¸çŸ¥é“ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç±»ä¼¼äºè®¡ç®—nullç»ˆæ­¢ç¬¦çš„æ–¹å¼æ¥è·å–é•¿åº¦</span></span>
<span class="line"><span>  size_t length = sizeof(str) / sizeof(char16_t) - 1; // å‡å»nullç»ˆæ­¢ç¬¦</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span>  // è°ƒç”¨å‡½æ•°åˆ›å»ºJSå­—ç¬¦ä¸²</span></span>
<span class="line"><span>  napi_status status = napi_create_string_utf16(env, str, length, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ£€æŸ¥æ˜¯å¦æˆåŠŸ</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯æƒ…å†µ...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›åˆ›å»ºçš„å­—ç¬¦ä¸²</span></span>
<span class="line"><span>  return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... å…¶ä»–ä»£ç ç”¨äºæ³¨å†Œè¯¥å‡½æ•°ï¼Œä½¿å¾—å®ƒå¯ä»¥ä»Node.jsä¸­è°ƒç”¨ ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ Node.js ä»£ç ä¸­ï¼Œä½ å¯èƒ½ä¼šè°ƒç”¨è¿™ä¸ªæœ¬åœ°æ’ä»¶æä¾›çš„å‡½æ•°åƒè¿™æ ·ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./path_to_native_addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">CreateUtf16String</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // åº”è¯¥æ‰“å°å‡º &quot;Hello, World!&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œæˆ‘ä»¬åœ¨ C ä»£ç ä¸­åˆ›å»ºäº†ä¸€ä¸ª Javascript å­—ç¬¦ä¸²ï¼Œç„¶ååœ¨ Node.js ä¸­æ‰“å°å‡ºæ¥ã€‚è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•åˆ©ç”¨<code>napi_create_string_utf16</code>å‡½æ•°åœ¨åŸç”Ÿæ¨¡å—ä¸­åˆ›å»ºå’Œè¿”å› JavaScript å­—ç¬¦ä¸²ã€‚</p><h4 id="node-api-create-external-string-utf16" tabindex="-1"><a class="header-anchor" href="#node-api-create-external-string-utf16"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#node_api_create_external_string_utf16" target="_blank" rel="noopener noreferrer">node_api_create_external_string_utf16</a></span></a></h4><p><code>node_api_create_external_string_utf16</code> å‡½æ•°æ˜¯ Node.js ä¸­ N-API æä¾›çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒå…è®¸ä½ åœ¨åŸç”Ÿæ’ä»¶ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å­—ç¬¦ä¸²ï¼Œè€Œè¿™ä¸ªå­—ç¬¦ä¸²çš„å†…å®¹å®é™…ä¸Šå­˜å‚¨åœ¨å¤–éƒ¨åˆ†é…çš„å†…å­˜ä¸­ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œä¸æ˜¯ç”± V8 ç®¡ç†çš„å†…å­˜ï¼‰ã€‚ä½¿ç”¨è¿™ä¸ªå‡½æ•°å¯ä»¥å¸®åŠ©ä½ é«˜æ•ˆåœ°åœ¨åŸç”Ÿä»£ç å’Œ JavaScript ä¹‹é—´ä¼ é€’å¤§é‡æ–‡æœ¬æ•°æ®ï¼Œè€Œæ— éœ€å¤åˆ¶å­—ç¬¦ä¸²æ•°æ®ã€‚</p><p>åœ¨äº†è§£å¦‚ä½•ä½¿ç”¨ <code>node_api_create_external_string_utf16</code> å‰ï¼Œä½ éœ€è¦çŸ¥é“å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š</p><ol><li><p><strong>UTF-16</strong>ï¼šè¿™æ˜¯ä¸€ç§ç¼–ç æ–¹å¼ï¼Œç”¨äºå°†å­—ç¬¦è¡¨ç¤ºä¸ºæ•°å­—ä»£ç ã€‚UTF-16 å¯ä»¥ç¼–ç ä¸–ç•Œä¸Šç»å¤§å¤šæ•°çš„å­—ç¬¦ï¼Œå¹¶ä¸”æ¯ä¸ªå­—ç¬¦ä½¿ç”¨ 2 ä¸ªæˆ–è€…æ›´å¤šçš„å­—èŠ‚æ¥è¡¨ç¤ºã€‚</p></li><li><p><strong>N-API</strong>ï¼šæ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç¨³å®šçš„ API å±‚ï¼Œè®©ä½ å¯ä»¥æ„å»ºåŸç”Ÿæ’ä»¶ï¼Œè¿™æ ·çš„æ’ä»¶å¯ä»¥ç›´æ¥è¿è¡Œåœ¨ Node.js çš„åº•å±‚å¼•æ“ V8 ä¹‹ä¸Šã€‚</p></li><li><p><strong>åŸç”Ÿæ’ä»¶</strong>ï¼šæ˜¯ä½¿ç”¨ C æˆ– C++ ç¼–å†™çš„æ¨¡å—ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡ Node.js çš„ N-API è¢«åŠ è½½å’Œæ‰§è¡Œï¼Œæä¾›æ¯”çº¯ JavaScript æ›´é«˜æ•ˆçš„æ€§èƒ½ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤§é‡æ•°æ®æ—¶ã€‚</p></li></ol><p>ä¸‹é¢æ˜¯ <code>node_api_create_external_string_utf16</code> å‡½æ•°çš„åŸºæœ¬ç”¨æ³•ç¤ºä¾‹å’Œè§£é‡Šï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª UTF-16 ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œå­˜åœ¨äºå¤–éƒ¨åˆ†é…çš„å†…å­˜ä¸­</span></span>
<span class="line"><span>const char16_t* external_data = u&quot;Hello, World!&quot;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°ä¼šè¢«ç”¨æ¥åœ¨åç»­æ¸…ç†å¤–éƒ¨åˆ†é…çš„å†…å­˜</span></span>
<span class="line"><span>void MyFinalizer(napi_env env, void* finalize_data, void* finalize_hint) {</span></span>
<span class="line"><span>    free(finalize_data);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CreateExternalStringUtf16(napi_env env) {</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ª JavaScript å­—ç¬¦ä¸²ï¼Œå…¶å†…å®¹é“¾æ¥åˆ°å¤–éƒ¨çš„ UTF-16 ç¼–ç æ•°æ®</span></span>
<span class="line"><span>    napi_status status = napi_create_external_string_utf16(</span></span>
<span class="line"><span>        env,</span></span>
<span class="line"><span>        external_data,</span></span>
<span class="line"><span>        NAPI_AUTO_LENGTH,   // è®© N-API è‡ªåŠ¨è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦</span></span>
<span class="line"><span>        &amp;result</span></span>
<span class="line"><span>    );</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦æ­£ç¡®æ‰§è¡Œ</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›åˆ›å»ºçš„ JavaScript å­—ç¬¦ä¸²</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåŒ…å«äº† <code>node_api.h</code> å¤´æ–‡ä»¶ï¼Œè¿™æ˜¯ä½¿ç”¨ N-API å¿…é¡»åšçš„ã€‚ç„¶åï¼Œæˆ‘ä»¬å£°æ˜äº†ä¸€ä¸ª UTF-16 ç¼–ç çš„å­—ç¬¦ä¸² <code>external_data</code> å’Œä¸€ä¸ªæ¸…ç†å‡½æ•° <code>MyFinalizer</code>ï¼Œå½“ JavaScript å­—ç¬¦ä¸²ä¸å†è¢«éœ€è¦æ—¶ï¼Œ<code>MyFinalizer</code> ä¼šè¢«è°ƒç”¨æ¥é‡Šæ”¾å¤–éƒ¨åˆ†é…çš„å†…å­˜ã€‚</p><p><code>CreateExternalStringUtf16</code> å‡½æ•°æ˜¯åˆ›å»ºå­—ç¬¦ä¸²çš„å®é™…å·¥ä½œåœ°æ–¹ã€‚æˆ‘ä»¬è°ƒç”¨äº† <code>napi_create_external_string_utf16</code>ï¼Œå‘å®ƒä¼ é€’ç¯å¢ƒå¥æŸ„ <code>env</code>ã€æŒ‡å‘å¤–éƒ¨æ•°æ®çš„æŒ‡é’ˆ <code>external_data</code>ã€ä½¿ç”¨ <code>NAPI_AUTO_LENGTH</code> è®© API è‡ªåŠ¨è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦ï¼Œæœ€åä¼ å…¥ä¸€ä¸ªæŒ‡å‘ <code>napi_value</code> å˜é‡çš„æŒ‡é’ˆæ¥æ¥æ”¶åˆ›å»ºå‡ºçš„ JavaScript å­—ç¬¦ä¸²ã€‚</p><p>æ³¨æ„ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ éœ€è¦ç¡®ä¿ä¼ é€’ç»™ <code>napi_create_external_string_utf16</code> çš„å†…å­˜åœ¨å­—ç¬¦ä¸²ä¸å†ä½¿ç”¨åå¾—åˆ°é‡Šæ”¾ï¼Œå¦åˆ™ä¼šäº§ç”Ÿå†…å­˜æ³„æ¼ã€‚è¿™é€šå¸¸æ˜¯é€šè¿‡æ³¨å†Œä¸€ä¸ªâ€œfinalizerâ€å‡½æ•°å®Œæˆçš„ï¼Œå°±åƒç¤ºä¾‹ä¸­çš„ <code>MyFinalizer</code> é‚£æ ·ã€‚</p><p>é€šè¿‡è¿™æ ·çš„æœºåˆ¶ï¼ŒNode.js çš„ N-API å…è®¸ä½ åœ¨åŸç”Ÿæ’ä»¶ä¸­å¤„ç†å­—ç¬¦ä¸²æ—¶ï¼Œæ—¢å¯ä»¥è¾¾åˆ°é«˜æ•ˆç‡ï¼Œåˆèƒ½å¤Ÿé˜²æ­¢å†…å­˜æ³„æ¼ã€‚</p><h4 id="napi-create-string-utf8" tabindex="-1"><a class="header-anchor" href="#napi-create-string-utf8"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_string_utf8" target="_blank" rel="noopener noreferrer">napi_create_string_utf8</a></span></a></h4><p><code>napi_create_string_utf8</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ª N-API å‡½æ•°ã€‚N-APIï¼ˆNode APIï¼‰æ˜¯ Node.js æä¾›çš„ä¸€å¥— C è¯­è¨€çš„ APIï¼Œä½¿å¾—åŸç”Ÿæ’ä»¶ï¼ˆé€šå¸¸ç”¨ C æˆ– C++ç¼–å†™ï¼‰èƒ½å¤Ÿä¸ JavaScript ä»£ç ç›¸äº’äº¤äº’ã€‚è¿™æ ·ï¼Œå¼€å‘è€…å°±å¯ä»¥åœ¨ Node.js ç¯å¢ƒä¸­ä½¿ç”¨ C æˆ– C++ ç¼–å†™é«˜æ€§èƒ½çš„æœ¬åœ°æ’ä»¶ã€‚</p><h3 id="è§£é‡Š-napi-create-string-utf8" tabindex="-1"><a class="header-anchor" href="#è§£é‡Š-napi-create-string-utf8"><span>è§£é‡Š <code>napi_create_string_utf8</code></span></a></h3><p><code>napi_create_string_utf8</code> çš„ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„ UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œå¹¶å°†å…¶è¡¨ç¤ºä¸º N-API ä¸­çš„ <code>napi_value</code> ç±»å‹ã€‚è¯¥å‡½æ•°å…è®¸ä½ æŠŠä¸€ä¸ª C è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²ï¼ˆchar* ç±»å‹ï¼‰ï¼Œè½¬æ¢æˆå¯ä»¥åœ¨ Node.js ä»£ç ä¸­ä½œä¸º JavaScript å­—ç¬¦ä¸²ä½¿ç”¨çš„å€¼ã€‚</p><h3 id="å‚æ•°-1" tabindex="-1"><a class="header-anchor" href="#å‚æ•°-1"><span>å‚æ•°</span></a></h3><p>è¯¥å‡½æ•°é€šå¸¸æ¥æ”¶ä»¥ä¸‹å‡ ä¸ªå‚æ•°ï¼š</p><ol><li><strong>env</strong>: è¿™æ˜¯ä¸€ä¸ª <code>napi_env</code> å¥æŸ„ï¼Œä»£è¡¨å½“å‰çš„ Node.js ç¯å¢ƒã€‚å®ƒæ˜¯æ‰§è¡Œ N-API è°ƒç”¨çš„ä¸Šä¸‹æ–‡ã€‚</li><li><strong>str</strong>: æŒ‡å‘ä»¥ null ç»“å°¾çš„ UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€‚</li><li><strong>length</strong>: å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚å¦‚æœé•¿åº¦æœªçŸ¥ï¼Œå¯ä»¥ä¼ é€’ <code>-1</code>ï¼Œå‡½æ•°ä¼šè‡ªåŠ¨è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦ã€‚</li><li><strong>result</strong>: æŒ‡å‘ <code>napi_value</code> çš„æŒ‡é’ˆï¼Œç”¨æ¥æ¥æ”¶åˆ›å»ºå¥½çš„ JavaScript å­—ç¬¦ä¸²ã€‚</li></ol><h3 id="è¿”å›å€¼-2" tabindex="-1"><a class="header-anchor" href="#è¿”å›å€¼-2"><span>è¿”å›å€¼</span></a></h3><p>è¯¥å‡½æ•°è¿”å›ä¸€ä¸ª <code>napi_status</code> æšä¸¾å€¼ï¼Œè¡¨ç¤ºæ“ä½œæˆåŠŸæˆ–å¤±è´¥çš„çŠ¶æ€ã€‚</p><h3 id="ä»£ç ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ä»£ç ç¤ºä¾‹"><span>ä»£ç ç¤ºä¾‹</span></a></h3><p>å‡è®¾ä½ å·²ç»æœ‰äº†ä¸€ä¸ª C æ’ä»¶ï¼Œå¹¶æƒ³è¦åˆ›å»ºä¸€ä¸ª JavaScript å­—ç¬¦ä¸²å¹¶è¿”å›ç»™ JavaScript ç«¯ï¼Œä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ <code>napi_create_string_utf8</code> çš„ä¾‹å­ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ç¤ºä¾‹å‡½æ•°ï¼Œç”¨äºåˆ›å»ºå­—ç¬¦ä¸²è¿”å›</span></span>
<span class="line"><span>napi_value CreateString(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value str;</span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ª UTF-8 ç¼–ç çš„ JavaScript å­—ç¬¦ä¸² &quot;Hello, World!&quot;</span></span>
<span class="line"><span>    napi_status status = napi_create_string_utf8(env, &quot;Hello, World!&quot;, NAPI_AUTO_LENGTH, &amp;str);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ›å»ºå­—ç¬¦ä¸²</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯</span></span>
<span class="line"><span>        // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ å¯èƒ½éœ€è¦è°ƒç”¨å¦ä¸€ä¸ª N-API å‡½æ•°æ¥æŠ›å‡ºé”™è¯¯</span></span>
<span class="line"><span>        return nullptr;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¦‚æœæˆåŠŸï¼Œè¿”å›åˆ›å»ºçš„å­—ç¬¦ä¸²</span></span>
<span class="line"><span>    return str;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œæ³¨å†Œä¸Šé¢çš„ç¤ºä¾‹å‡½æ•°åˆ° Node.js</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°† CreateString åŒ…è£…ä¸º JavaScript å¯è°ƒç”¨çš„å‡½æ•°</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, CreateString, NULL, &amp;fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†è¿™ä¸ªå‡½æ•°ä½œä¸ºæ¨¡å—å¯¼å‡º</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;createString&quot;, fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„å‡½æ•° <code>CreateString</code>ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥åœ¨ JavaScript ä¸­è¢«è°ƒç”¨ï¼Œè¿”å›ä¸€ä¸ª &quot;Hello, World!&quot; å­—ç¬¦ä¸²ã€‚<code>NAPI_MODULE</code> å®ç”¨äºæ³¨å†Œåˆå§‹åŒ–å‡½æ•°ï¼Œç¡®ä¿åœ¨æ¨¡å—è½½å…¥æ—¶è¿è¡Œ <code>Init</code> å‡½æ•°ï¼Œè¿™æ · <code>createString</code> å°±å¯ä»¥å¯¼å‡ºå¹¶åœ¨ Node.js ä»£ç ä¸­ä½¿ç”¨äº†ã€‚</p><p>åœ¨ JavaScript ç«¯ï¼Œä½ å¯ä»¥åƒä¸‹é¢è¿™æ ·è°ƒç”¨ <code>createString</code> å‡½æ•°ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> addon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">addon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createString</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // æ‰“å° &quot;Hello, World!&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·æ³¨æ„ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¤„ç† <code>napi_status</code> è¿”å›å€¼å’Œé”™è¯¯æ£€æŸ¥éå¸¸é‡è¦ï¼Œå› ä¸ºä»–ä»¬å¯ä»¥å¸®åŠ©è¯†åˆ«é—®é¢˜æ‰€åœ¨ã€‚æ­¤å¤–ï¼Œåœ¨å¼•å…¥å’Œä½¿ç”¨åŸç”Ÿæ¨¡å—å‰ï¼Œéœ€è¦å…ˆç¼–è¯‘å®ƒä»¬ï¼Œé€šå¸¸æ˜¯ä½¿ç”¨ node-gyp è¿™ç§å·¥å…·ã€‚</p><h4 id="node-api-create-property-key-utf16" tabindex="-1"><a class="header-anchor" href="#node-api-create-property-key-utf16"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#node_api_create_property_key_utf16" target="_blank" rel="noopener noreferrer">node_api_create_property_key_utf16</a></span></a></h4><p><code>node_api_create_property_key_utf16</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå±äº N-API çš„ä¸€éƒ¨åˆ†ã€‚N-APIï¼ˆNode APIï¼‰æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºåŸç”Ÿæ’ä»¶çš„ API å±‚ï¼Œå…è®¸ä½ ç”¨ C æˆ– C++ç¼–å†™å¯ä»¥ä¸ Node.js JavaScript ä»£ç ç›´æ¥äº’æ“ä½œçš„æ¨¡å—ã€‚</p><p>åœ¨ JavaScript ä¸­ï¼Œå¯¹è±¡é€šå¸¸ç”±é”®å€¼å¯¹ç»„æˆï¼Œå³æ¯ä¸ªå±æ€§éƒ½æœ‰ä¸€ä¸ªåç§°ï¼ˆé”®ï¼‰å’Œä¸ä¹‹å…³è”çš„å€¼ã€‚åœ¨ä½¿ç”¨åŸç”Ÿä»£ç ä¸ JavaScript äº¤äº’æ—¶ï¼Œæˆ‘ä»¬éœ€è¦èƒ½å¤Ÿåˆ›å»ºè¿™äº›é”®ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥è¯»å–å’Œè®¾ç½® JavaScript å¯¹è±¡ä¸Šçš„å±æ€§ã€‚</p><p>å‡½æ•° <code>node_api_create_property_key_utf16</code> å…·ä½“ç”¨é€”æ˜¯ï¼šåˆ›å»ºä¸€ä¸ª UTF-16 ç¼–ç çš„å­—ç¬¦ä¸²ä½œä¸ºå±æ€§åï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ° JavaScript è¿è¡Œæ—¶ç¯å¢ƒä¸­ï¼Œä½¿å¾—åŸç”Ÿæ¨¡å—å¯ä»¥ä½¿ç”¨è¿™ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå¯¹è±¡çš„å±æ€§é”®ã€‚</p><p>è¯¦ç»†è§£é‡Šï¼š</p><ul><li>UTF-16 æ˜¯ Unicode å­—ç¬¦é›†çš„ä¸€ç§ç¼–ç æ–¹å¼ï¼Œå®ƒé‡‡ç”¨ 2 ä¸ªå­—èŠ‚æˆ–è€…æ›´å¤šæ¥è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ã€‚</li><li>å½“ä½ æƒ³è¦ä»åŸç”Ÿæ¨¡å—ï¼ˆä¾‹å¦‚ C/C++æ¨¡å—ï¼‰ä¸­å®šä¹‰ä¸€ä¸ªæ–°çš„å±æ€§å¹¶ä¸”ç»™ JavaScript å¯¹è±¡èµ‹å€¼æ—¶ï¼Œä½ éœ€è¦ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥åˆ›å»ºå±æ€§åã€‚</li></ul><p>å®é™…åº”ç”¨ä¾‹å­ï¼š<br> å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œè¯¥æ¨¡å—éœ€è¦ç»™ JavaScript ä¸­çš„æŸä¸ªå¯¹è±¡æ·»åŠ ä¸€ä¸ªåä¸ºâ€œexamplePropertyâ€çš„æ–°å±æ€§ã€‚ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤ä½¿ç”¨ <code>node_api_create_property_key_utf16</code>ï¼š</p><ol><li>åœ¨ä½ çš„ C/C++ä»£ç ä¸­ï¼Œä½ é¦–å…ˆå®šä¹‰ä¸€ä¸ª UTF-16 ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºä½ è¦åˆ›å»ºçš„å±æ€§åã€‚</li><li>ç„¶åï¼Œä½ è°ƒç”¨ <code>node_api_create_property_key_utf16</code> å‡½æ•°ï¼Œä¼ å…¥ä½ çš„ N-API ç¯å¢ƒã€UTF-16 å­—ç¬¦ä¸²åŠå…¶é•¿åº¦ï¼Œè¯¥å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªç”¨äºæ ‡è¯†è¿™ä¸ªå±æ€§çš„ N-API å€¼ã€‚</li><li>æœ€åï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªå±æ€§é”®åœ¨ JavaScript å¯¹è±¡ä¸Šè®¾ç½®æˆ–è·å–å¯¹åº”çš„å±æ€§å€¼ã€‚</li></ol><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–çš„ä»£ç ç¤ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ <code>node_api_create_property_key_utf16</code> åˆ›å»ºå±æ€§é”®ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CreateExampleProperty(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  // å®šä¹‰UTF-16å­—ç¬¦ä¸²ï¼Œä»£è¡¨ä½ æƒ³è¦çš„å±æ€§åç§°ï¼Œæ¯”å¦‚â€œexamplePropertyâ€ã€‚</span></span>
<span class="line"><span>  const char16_t property_name[] = u&quot;exampleProperty&quot;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ªå±æ€§é”®å˜é‡ã€‚</span></span>
<span class="line"><span>  napi_value property_key;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è°ƒç”¨å‡½æ•°åˆ›å»ºå±æ€§é”®ã€‚</span></span>
<span class="line"><span>  napi_status status = napi_create_property_key_utf16(env,</span></span>
<span class="line"><span>                                                      property_name,</span></span>
<span class="line"><span>                                                      sizeof(property_name) - 1, // å‡å»å­—ç¬¦ä¸²ç»“æŸç¬¦ \0 çš„é•¿åº¦</span></span>
<span class="line"><span>                                                      &amp;property_key);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ›å»ºäº†å±æ€§é”®ã€‚</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯æƒ…å†µ...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿™é‡Œå‡è®¾ &quot;object&quot; æ˜¯å·²ç»åœ¨å…¶ä»–åœ°æ–¹åˆ›å»ºå¥½çš„JavaScriptå¯¹è±¡ã€‚</span></span>
<span class="line"><span>  napi_value object;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ä½¿ç”¨å±æ€§é”®åœ¨å¯¹è±¡ä¸Šè®¾ç½®å±æ€§ã€‚</span></span>
<span class="line"><span>  // è¿™é‡Œåªæ˜¯ç¤ºä¾‹æµç¨‹ï¼Œä½ è¿˜éœ€è¦åˆ›å»ºå®é™…çš„å€¼ï¼ˆvalueï¼‰å¹¶è®¾ç½®åˆ°å¯¹è±¡ä¸Šã€‚</span></span>
<span class="line"><span>  napi_value value;</span></span>
<span class="line"><span>  // ...åˆ›å»ºæˆ–è·å–value...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  status = napi_set_property(env, object, property_key, value);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯æƒ…å†µ...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›æ–°åˆ›å»ºçš„å±æ€§å€¼ï¼Œæˆ–è€…å…¶ä»–ä»€ä¹ˆä¸œè¥¿ã€‚</span></span>
<span class="line"><span>  return value;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼Œåœ¨å®é™…ç¼–å†™çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜éœ€è¦è€ƒè™‘é”™è¯¯å¤„ç†å’Œç¡®ä¿æ­£ç¡®è°ƒç”¨ N-API æä¾›çš„å…¶ä»–å‡½æ•°è¿›è¡Œå®Œæ•´çš„åŠŸèƒ½å®ç°ã€‚ä¸Šè¿°ä»£ç ä»…å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨<code>node_api_create_property_key_utf16</code>å‡½æ•°ã€‚</p><h3 id="functions-to-convert-from-node-api-to-c-types" tabindex="-1"><a class="header-anchor" href="#functions-to-convert-from-node-api-to-c-types"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#functions-to-convert-from-node-api-to-c-types" target="_blank" rel="noopener noreferrer">Functions to convert from Node-API to C types</a></span></a></h3><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œæ—¶ç¯å¢ƒã€‚å®ƒå…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚Node-APIï¼ˆä¹‹å‰ç§°ä¸º N-APIï¼‰æ˜¯ Node.js çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒæä¾›äº†ä¸€ç»„ APIï¼Œä½¿å¾—åŸç”Ÿæ¨¡å—ï¼ˆé€šå¸¸ç”¨ C æˆ– C++ç¼–å†™ï¼‰èƒ½å¤Ÿä¸ JavaScript ä»£ç è¿›è¡Œäº’æ“ä½œã€‚</p><p>åœ¨ Node-API ä¸­ï¼Œâ€œFunctions to convert from Node-API to C typesâ€æ„å‘³ç€æœ‰ä¸€ç»„ç‰¹å®šçš„å‡½æ•°å¯ä»¥å¸®åŠ©å¼€å‘è€…å°†ä» JavaScript æ¥æ”¶çš„æ•°æ®è½¬æ¢æˆ C è¯­è¨€ä¸­çš„æ•°æ®ç±»å‹ï¼Œä»¥ä¾¿åœ¨ C/C++ ç¼–å†™çš„åŸç”Ÿæ¨¡å—ä¸­ä½¿ç”¨ã€‚</p><p>è¿™äº›å‡½æ•°é€šå¸¸æ¶‰åŠä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><ol><li><strong>è½¬æ¢æ•°å­—</strong>ï¼šæ¯”å¦‚æŠŠ JavaScript ä¸­çš„ <code>Number</code> è½¬æ¢ä¸º C ä¸­çš„ <code>int</code>, <code>float</code>, <code>double</code> ç­‰ã€‚</li><li><strong>è½¬æ¢å­—ç¬¦ä¸²</strong>ï¼šå°† JavaScript å­—ç¬¦ä¸²è½¬æ¢æˆ C é£æ ¼çš„å­—ç¬¦ä¸²ï¼ˆå³ä»¥ null ç»“å°¾çš„å­—ç¬¦æ•°ç»„ï¼‰ã€‚</li><li><strong>è½¬æ¢å¯¹è±¡</strong>ï¼šå¦‚æœ JavaScript å¯¹è±¡éœ€è¦åœ¨ C ä»£ç ä¸­å¤„ç†ï¼Œå¯èƒ½éœ€è¦è½¬æ¢ä¸ºå¯¹åº”çš„ C ç»“æ„ä½“ã€‚</li><li><strong>è½¬æ¢å‡½æ•°</strong>ï¼šå°† JavaScript ä¸­çš„å‡½æ•°è½¬æ¢ä¸ºå¯ä»¥åœ¨ C ä»£ç ä¸­è°ƒç”¨çš„å›è°ƒã€‚</li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡ä¸€äº›ä¾‹å­æ¥è¯´æ˜å¦‚ä½•ä½¿ç”¨ Node-API è¿›è¡Œç±»å‹è½¬æ¢ã€‚</p><h3 id="ç¤ºä¾‹-1-è½¬æ¢æ•°å­—" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-1-è½¬æ¢æ•°å­—"><span>ç¤ºä¾‹ 1ï¼šè½¬æ¢æ•°å­—</span></a></h3><p>å‡è®¾æ‚¨çš„ JavaScript ä»£ç ä¼ é€’äº†ä¸€ä¸ªæ•°å­—ç»™åŸç”Ÿæ¨¡å—ï¼Œå¹¶ä¸”æ‚¨æƒ³è¦åœ¨ C ä»£ç ä¸­ä»¥ <code>double</code> ç±»å‹ä½¿ç”¨å®ƒã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value argv[1];</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    double number;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å– JavaScript ä¼ å…¥çš„å‚æ•°</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, argv, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†ç¬¬ä¸€ä¸ªå‚æ•°è½¬æ¢ä¸º C çš„ double ç±»å‹</span></span>
<span class="line"><span>    status = napi_get_value_double(env, argv[0], &amp;number);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç°åœ¨ä½ å¯ä»¥åœ¨ C ä»£ç ä¸­ä½¿ç”¨å˜é‡ number äº†</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›ç»“æœåˆ° JavaScript</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    status = napi_create_double(env, number * 2, &amp;result);</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ç¤ºä¾‹-2-è½¬æ¢å­—ç¬¦ä¸²" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-2-è½¬æ¢å­—ç¬¦ä¸²"><span>ç¤ºä¾‹ 2ï¼šè½¬æ¢å­—ç¬¦ä¸²</span></a></h3><p>å‡è®¾æ‚¨æ¥æ”¶åˆ°äº†ä¸€ä¸ª JavaScript å­—ç¬¦ä¸²ï¼Œå¹¶å¸Œæœ›åœ¨åŸç”Ÿæ¨¡å—ä¸­ä½œä¸º C å­—ç¬¦ä¸²å¤„ç†ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span>#include `&lt;`string.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value argv[1];</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    size_t str_length, str_length_in_bytes;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å– JavaScript ä¼ å…¥çš„å‚æ•°</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, argv, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç¬¬ä¸€æ­¥ï¼Œè·å–å­—ç¬¦ä¸²é•¿åº¦</span></span>
<span class="line"><span>    status = napi_get_value_string_utf8(env, argv[0], NULL, 0, &amp;str_length_in_bytes);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å‡†å¤‡è¶³å¤Ÿå¤§å°çš„ç¼“å†²åŒºæ¥å­˜å‚¨ C å­—ç¬¦ä¸²</span></span>
<span class="line"><span>    char* c_str = (char*)malloc(str_length_in_bytes + 1);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç¬¬äºŒæ­¥ï¼Œå®é™…å¤åˆ¶å­—ç¬¦ä¸²å†…å®¹</span></span>
<span class="line"><span>    status = napi_get_value_string_utf8(env, argv[0], c_str, str_length_in_bytes + 1, &amp;str_length);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨ c_str ä½œä¸º C å­—ç¬¦ä¸²</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ¸…ç†åˆ†é…çš„å†…å­˜</span></span>
<span class="line"><span>    free(c_str);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¤„ç†ç»“æŸåè¿”å› undefined ç»™ JavaScript</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    status = napi_get_undefined(env, &amp;result);</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ç¤ºä¾‹-3-è½¬æ¢å‡½æ•°-å›è°ƒ" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-3-è½¬æ¢å‡½æ•°-å›è°ƒ"><span>ç¤ºä¾‹ 3ï¼šè½¬æ¢å‡½æ•°ï¼ˆå›è°ƒï¼‰</span></a></h3><p>å¦‚æœ JavaScript ä¼ é€’äº†ä¸€ä¸ªå‡½æ•°ä½œä¸ºå›è°ƒç»™åŸç”Ÿæ¨¡å—ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›åœ¨æŸä¸ªäº‹ä»¶å‘ç”Ÿæ—¶è°ƒç”¨å®ƒã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void CallJavaScriptCallback(napi_env env, napi_value js_callback) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å‡è®¾æˆ‘ä»¬æƒ³è¦å›è°ƒ JavaScript å‡½æ•°å¹¶ä¼ é€’ä¸€ä¸ªå‚æ•°ç»™å®ƒ</span></span>
<span class="line"><span>    napi_value arg;</span></span>
<span class="line"><span>    status = napi_create_string_utf8(env, &quot;Hello from native!&quot;, NAPI_AUTO_LENGTH, &amp;arg);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_value global;</span></span>
<span class="line"><span>    status = napi_get_global(env, &amp;global);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    status = napi_call_function(env, global, js_callback, 1, &amp;arg, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å›è°ƒå‡½æ•°å·²è°ƒç”¨</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value argv[1];</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å– JavaScript ä¼ å…¥çš„å‚æ•°</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, argv, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç¡®ä¿ä¼ å…¥çš„å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°</span></span>
<span class="line"><span>    napi_valuetype valuetype;</span></span>
<span class="line"><span>    status = napi_typeof(env, argv[0], &amp;valuetype);</span></span>
<span class="line"><span>    if (valuetype != napi_function) {</span></span>
<span class="line"><span>        // æŠ›å‡ºé”™è¯¯</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å­˜å‚¨æˆ–ç›´æ¥ä½¿ç”¨ JavaScript æä¾›çš„å›è°ƒå‡½æ•°</span></span>
<span class="line"><span>    CallJavaScriptCallback(env, argv[0]);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¤„ç†ç»“æŸåè¿”å› undefined ç»™ JavaScript</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    status = napi_get_undefined(env, &amp;result);</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™äº›ä¾‹å­æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Node-API æä¾›çš„å‡½æ•°å°† JavaScript ä¸­çš„æ•°æ®ç±»å‹è½¬æ¢ä¸ºé€‚åˆ C/C++ ä½¿ç”¨çš„æ•°æ®ç±»å‹ã€‚è¿™æ˜¯åˆ›å»ºåŸç”Ÿæ’ä»¶å’Œæ¨¡å—æ—¶éå¸¸é‡è¦çš„ä¸€ä¸ªæ­¥éª¤ï¼Œå› ä¸ºè¿™æ ·æ‰èƒ½ç¡®ä¿æ•°æ®åœ¨ä¸åŒè¯­è¨€é—´æ­£ç¡®æ— è¯¯åœ°ä¼ é€’å’Œå¤„ç†ã€‚</p><h4 id="napi-get-array-length" tabindex="-1"><a class="header-anchor" href="#napi-get-array-length"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_array_length" target="_blank" rel="noopener noreferrer">napi_get_array_length</a></span></a></h4><p>å¥½çš„ï¼ŒNode.js çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„æ¥å£ã€‚N-API æ—¨åœ¨æä¾›ä¸€ä¸ªä¸ JavaScript è¿è¡Œæ—¶æ— å…³çš„æŠ½è±¡å±‚ï¼Œè¿™æ ·æ‚¨ç¼–å†™çš„ä»£ç å°±å¯ä»¥åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸­è¿è¡Œï¼Œè€Œæ— éœ€é‡æ–°ç¼–è¯‘ã€‚</p><p><code>napi_get_array_length</code> å‡½æ•°æ˜¯ N-API æä¾›çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒå…è®¸ä½ åœ¨åŸç”Ÿæ¨¡å—ä¸­è·å–ä¸€ä¸ª JavaScript æ•°ç»„çš„é•¿åº¦ã€‚å½“ä½ åœ¨ C æˆ– C++ ç¼–å†™çš„æ‰©å±•ä¸­ä¸ JavaScript æ•°ç»„æ‰“äº¤é“æ—¶ï¼Œä½ å¯èƒ½éœ€è¦çŸ¥é“æ•°ç»„æœ‰å¤šå°‘é¡¹ï¼Œè¿™ä¸ªå‡½æ•°æ­£æ˜¯ç”¨æ¥å¸®åŠ©ä½ è¿™ä¹ˆåšçš„ã€‚</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªç®€å•çš„ä¾‹å­è¯´æ˜ <code>napi_get_array_length</code> æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š</p><p>å‡è®¾ä½ æœ‰ä¸€ä¸ª JavaScript æ•°ç»„ï¼Œå¹¶ä¸”ä½ æƒ³é€šè¿‡ä¸€ä¸ªåŸç”Ÿæ’ä»¶æ¥å¤„ç†è¿™ä¸ªæ•°ç»„ã€‚åœ¨åŸç”Ÿæ’ä»¶çš„ä»£ç ä¸­ï¼Œä½ å°†è·å¾—ä¸€ä¸ª <code>napi_value</code> ç±»å‹çš„å¼•ç”¨ï¼ŒæŒ‡å‘è¿™ä¸ªæ•°ç»„ã€‚è¦è·å–è¯¥æ•°ç»„çš„é•¿åº¦ï¼Œä½ å°†ä½¿ç”¨ <code>napi_get_array_length</code> å‡½æ•°ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡½æ•°ç”¨äºè·å–æ•°ç»„é•¿åº¦</span></span>
<span class="line"><span>napi_status GetArrayLength(napi_env env, napi_value array, uint32_t* result) {</span></span>
<span class="line"><span>    return napi_get_array_length(env, array, result);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­:</p><ul><li><code>env</code> æ˜¯ä¸€ä¸ª <code>napi_env</code> å¥æŸ„ï¼Œå®ƒä»£è¡¨äº† N-API è°ƒç”¨ä¸Šä¸‹æ–‡ã€‚</li><li><code>array</code> æ˜¯ä¸€ä¸ª <code>napi_value</code>ï¼Œè¡¨ç¤ºä½ æƒ³è·å–é•¿åº¦çš„ JavaScript æ•°ç»„ã€‚</li><li><code>result</code> æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>uint32_t</code> å˜é‡çš„æŒ‡é’ˆï¼Œåœ¨è°ƒç”¨æ­¤å‡½æ•°åï¼Œå®ƒå°†è¢«è®¾ç½®ä¸ºæ•°ç»„çš„é•¿åº¦ã€‚</li></ul><p>å‡è®¾ä½ å·²ç»åœ¨ JavaScript ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ•°ç»„å¹¶ä¼ é€’ç»™äº†è¿™ä¸ªåŸç”Ÿå‡½æ•°:</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> myArray</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> [</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 3</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 4</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 5</span><span style="color:#D8DEE9FF;">]</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>å½“ä½ åœ¨åŸç”Ÿä»£ç ä¸­è°ƒç”¨ <code>GetArrayLength</code> å¹¶å°† <code>myArray</code> ä½œä¸ºå‚æ•°ä¼ é€’æ—¶ï¼Œ<code>result</code> å°†ä¼šè¢«è®¾ç½®ä¸º <code>5</code>ï¼Œå› ä¸º <code>myArray</code> åŒ…å«äº”ä¸ªå…ƒç´ ã€‚</p><p>è¯·æ³¨æ„ï¼Œè¿™åªæ˜¯å±•ç¤º <code>napi_get_array_length</code> åŠŸèƒ½çš„ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­ï¼Œå®é™…ä¸Šåœ¨åŸç”Ÿæ¨¡å—ä¸­ä½¿ç”¨æ—¶ï¼Œä½ è¿˜éœ€è¦è¿›è¡Œé”™è¯¯æ£€æŸ¥å’Œåˆé€‚çš„å¼‚å¸¸å¤„ç†æ¥ç¡®ä¿ä»£ç çš„å¥å£®æ€§ã€‚</p><h4 id="napi-get-arraybuffer-info" tabindex="-1"><a class="header-anchor" href="#napi-get-arraybuffer-info"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_arraybuffer_info" target="_blank" rel="noopener noreferrer">napi_get_arraybuffer_info</a></span></a></h4><p><code>napi_get_arraybuffer_info</code> æ˜¯ Node.js ä¸­çš„ Native APIï¼ˆN-APIï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå…è®¸åŸç”Ÿæ’ä»¶ä¸ JavaScript ä»£ç äº¤äº’ã€‚Node.js çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ç¨³å®šå±‚ï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥ä¸å— Node.js ç‰ˆæœ¬æ›´è¿­å½±å“çš„æƒ…å†µä¸‹ç¼–å†™å’Œç»´æŠ¤æ‰©å±•æ¨¡å—ã€‚</p><p>åœ¨è§£é‡Š <code>napi_get_arraybuffer_info</code> ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹ JavaScript ä¸­çš„ ArrayBuffer å¯¹è±¡ã€‚ArrayBuffer æ˜¯ä¸€ç§ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªå›ºå®šé•¿åº¦çš„äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºçš„å¯¹è±¡ï¼Œåœ¨è¿™ä¸ªç¼“å†²åŒºä¸­ï¼Œä½ å¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹çš„äºŒè¿›åˆ¶æ•°æ®ã€‚è¿™å¯¹äºå¤„ç†åƒæ–‡ä»¶ã€å›¾åƒæˆ–å…¶ä»–äºŒè¿›åˆ¶æµçš„æ•°æ®æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥è¯¦ç»†çœ‹çœ‹ <code>napi_get_arraybuffer_info</code> è¿™ä¸ªå‡½æ•°åšä»€ä¹ˆï¼š</p><p>å½“ä½ ä½¿ç”¨ N-API ç¼–å†™åŸç”Ÿä»£ç æ—¶ï¼ˆæ¯”å¦‚ C æˆ–è€… C++ï¼‰ï¼Œå¹¶ä¸”éœ€è¦æ“ä½œæˆ–è®¿é—®ç”± JavaScript ä»£ç åˆ›å»ºçš„ ArrayBuffer å¯¹è±¡æ—¶ï¼Œä½ å°±ä¼šç”¨åˆ° <code>napi_get_arraybuffer_info</code> è¿™ä¸ªå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°å¸®åŠ©ä½ ä»ä¸€ä¸ªç»™å®šçš„ N-API å€¼ä¸­æ£€ç´¢ ArrayBuffer ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶æä¾›å¯¹å®é™…çš„äºŒè¿›åˆ¶æ•°æ®çš„ç›´æ¥è®¿é—®æƒé™ã€‚</p><p>å‡½æ•°åŸå‹å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_get_arraybuffer_info(</span></span>
<span class="line"><span>    napi_env env,</span></span>
<span class="line"><span>    napi_value arraybuffer,</span></span>
<span class="line"><span>    void** data,</span></span>
<span class="line"><span>    size_t* length);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‚æ•°è¯´æ˜ï¼š</p><ul><li><code>env</code>: å½“å‰ç¯å¢ƒçš„å¥æŸ„ï¼Œå®ƒæ˜¯ N-API å‡½æ•°è¿›è¡Œäº¤äº’çš„ä¸Šä¸‹æ–‡ã€‚</li><li><code>arraybuffer</code>: ä¸€ä¸ª N-API å€¼ï¼Œä»£è¡¨ JavaScript ä¸­çš„ ArrayBuffer å¯¹è±¡ã€‚</li><li><code>data</code>: è¿™æ˜¯ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼Œç”¨æ¥æ¥æ”¶ç¼“å†²åŒºçš„æŒ‡é’ˆï¼Œå³ ArrayBuffer ä¸­æ•°æ®çš„å¼€å§‹åœ°å€ã€‚</li><li><code>length</code>: è¿™ä¹Ÿæ˜¯ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼Œç”¨æ¥æ¥æ”¶ ArrayBuffer çš„é•¿åº¦ï¼ˆå­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</li></ul><p>è¿”å›å€¼ï¼š</p><ul><li>è¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ª <code>napi_status</code> æšä¸¾ï¼Œè¡¨ç¤ºå‡½æ•°è°ƒç”¨æ˜¯å¦æˆåŠŸã€‚å¦‚æœè¿”å› <code>napi_ok</code>ï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰é”™è¯¯ã€‚</li></ul><h3 id="å®æˆ˜ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#å®æˆ˜ä¾‹å­"><span>å®æˆ˜ä¾‹å­</span></a></h3><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js æ’ä»¶ï¼Œè¯¥æ’ä»¶éœ€è¦è¯»å–é€šè¿‡ JavaScript ä¼ é€’è¿‡æ¥çš„äºŒè¿›åˆ¶å›¾åƒæ•°æ®ï¼Œå¹¶ä¸”æˆ‘ä»¬æƒ³è¦è·å–è¿™äº›æ•°æ®ä»¥åŠå®ƒä»¬çš„å¤§å°ï¼Œé‚£ä¹ˆ <code>napi_get_arraybuffer_info</code> å°±æ´¾ä¸Šäº†ç”¨åœºã€‚</p><p>é¦–å…ˆï¼ŒJavaScript ç«¯å¯èƒ½æœ‰ä»¥ä¸‹ä»£ç æ¥åˆ›å»ºä¸€ä¸ª ArrayBufferï¼Œå¹¶å°†å…¶ä¼ é€’ç»™åŸç”Ÿæ¨¡å—ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå›¾åƒæ–‡ä»¶</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> imageBuffer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">readFileSync</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path/to/image.png</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// åˆ›å»º ArrayBuffer</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> arrayBuffer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ArrayBuffer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">imageBuffer</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">length)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°† Node.js Buffer æ•°æ®å¤åˆ¶åˆ° ArrayBuffer</span></span>
<span class="line"><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> Uint8Array</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">arrayBuffer</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">set</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> Uint8Array</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">imageBuffer</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è°ƒç”¨åŸç”Ÿæ¨¡å—å¤„ç†å›¾åƒ</span></span>
<span class="line"><span style="color:#D8DEE9;">nativeModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">processImage</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">arrayBuffer</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶ååœ¨åŸç”Ÿæ¨¡å—ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè¿™æ ·ä½¿ç”¨ <code>napi_get_arraybuffer_info</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¸€ä¸ª N-API åº”ç”¨ç¨‹åºä¸­ç”± JavaScript è°ƒç”¨çš„å‡½æ•°</span></span>
<span class="line"><span>napi_value ProcessImage(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç¡®ä¿æˆ‘ä»¬è·å¾—äº†æ­£ç¡®çš„å‚æ•°æ•°ç›®</span></span>
<span class="line"><span>    if (status != napi_ok || argc `&lt;` 1) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    void* bufferData;</span></span>
<span class="line"><span>    size_t bufferLength;</span></span>
<span class="line"><span>    status = napi_get_arraybuffer_info(env, args[0], &amp;bufferData, &amp;bufferLength);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç¡®ä¿ ArrayBuffer æˆåŠŸè¢«è·å–</span></span>
<span class="line"><span>    if (status == napi_ok) {</span></span>
<span class="line"><span>        // åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ bufferData å’Œ bufferLength æ¥æ“ä½œå›¾åƒæ•°æ®</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›ä¸€äº›å€¼æˆ– `undefined`</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    status = napi_get_undefined(env, &amp;result);</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ¨¡å—åˆå§‹åŒ–ä»£ç ï¼Œæ³¨å†Œä¸Šè¿°å‡½æ•°...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª <code>ProcessImage</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°é¦–å…ˆä» JavaScript ä¼ é€’çš„å‚æ•°ä¸­è·å– ArrayBuffer å¯¹è±¡ï¼Œç„¶åç”¨ <code>napi_get_arraybuffer_info</code> æ¥è·å–æŒ‡å‘å®é™…æ•°æ®çš„æŒ‡é’ˆå’Œæ•°æ®çš„é•¿åº¦ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨åŸç”Ÿä»£ç ä¸­ç›´æ¥æ“ä½œè¿™äº›æ•°æ®äº†ã€‚</p><h4 id="napi-get-buffer-info" tabindex="-1"><a class="header-anchor" href="#napi-get-buffer-info"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_buffer_info" target="_blank" rel="noopener noreferrer">napi_get_buffer_info</a></span></a></h4><p>å½“ç„¶ï¼Œæˆ‘ä¼šè¯¦ç»†åœ°è§£é‡Š <code>napi_get_buffer_info</code> è¿™ä¸ªå‡½æ•°ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬äº†è§£ä¸‹ä»€ä¹ˆæ˜¯ N-API å’Œ Node.js ä¸­çš„ Bufferã€‚</p><p>N-API æ˜¯ Node.js çš„ä¸€ä¸ª C APIï¼Œå®ƒç”¨äºåˆ›å»ºæœ¬åœ°æ’ä»¶ã€‚è¿™æ„å‘³ç€å¦‚æœä½ æƒ³åœ¨ Node.js ä¸­ä½¿ç”¨ C/C++ç¼–å†™çš„ä»£ç ï¼Œä½ å¯èƒ½ä¼šä½¿ç”¨åˆ° N-APIã€‚Buffer åœ¨ Node.js ä¸­é€šå¸¸è¢«ç”¨æ¥å¤„ç†äºŒè¿›åˆ¶æ•°æ®æµï¼Œæ¯”å¦‚è¯»å–æ–‡ä»¶ã€ç½‘ç»œé€šä¿¡ç­‰åœºæ™¯ã€‚</p><p>ç°åœ¨ï¼Œè°ˆè°ˆ <code>napi_get_buffer_info</code> å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æ˜¯ N-API æä¾›çš„ä¸€ä¸ªæ¥å£ï¼Œå®ƒå…è®¸ä½ ä»ä¸€ä¸ª JavaScript Buffer å¯¹è±¡ä¸­è·å–åŸå§‹çš„å†…å­˜ä¿¡æ¯ã€‚å†…å­˜ä¿¡æ¯æŒ‡çš„æ˜¯æ•°æ®å­˜å‚¨çš„ä½ç½®ï¼ˆä¸€ä¸ªæŒ‡å‘å†…å­˜çš„æŒ‡é’ˆï¼‰å’Œæ•°æ®çš„é•¿åº¦ã€‚</p><p><code>napi_get_buffer_info</code> çš„å…·ä½“ä½œç”¨æ˜¯ï¼š</p><ul><li>å®ƒå¸®åŠ©ä½ ä» Node.js çš„ Buffer å¯¹è±¡è·å–åˆ°åº•å±‚çš„å­—èŠ‚æ•°æ®å’Œå¤§å°ã€‚</li><li>å®ƒé€šå¸¸åœ¨ç¼–å†™æœ¬åœ°æ’ä»¶æ—¶ä½¿ç”¨ï¼Œå½“éœ€è¦ç›´æ¥æ“ä½œæˆ–è®¿é—® Buffer å¯¹è±¡å†…éƒ¨æ•°æ®æ—¶ã€‚</li></ul><p>å‡½æ•°çš„ç­¾åå¤§è‡´å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_get_buffer_info(</span></span>
<span class="line"><span>  napi_env env,            // [in] N-APIç¯å¢ƒå¥æŸ„</span></span>
<span class="line"><span>  napi_value value,        // [in] è¦æ£€ç´¢ä¿¡æ¯çš„Bufferå¯¹è±¡</span></span>
<span class="line"><span>  void** data,             // [out] æŒ‡å‘Bufferæ•°æ®çš„æŒ‡é’ˆçš„æŒ‡é’ˆ</span></span>
<span class="line"><span>  size_t* length           // [out] Bufferæ•°æ®é•¿åº¦çš„æŒ‡é’ˆ</span></span>
<span class="line"><span>);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ä½ æœ‰ä¸€ä¸ª Node.js Buffer å¯¹è±¡ï¼Œä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªæœ¬åœ°æ’ä»¶ï¼Œå¹¶ä¸”æƒ³è¦å¾—åˆ°è¿™ä¸ª Buffer çš„æ•°æ®å’Œå®ƒçš„é•¿åº¦ï¼Œä»¥ä¾¿è¿›è¡Œä¸€äº›åº•å±‚çš„æ“ä½œã€‚</p><p>ä½ å¯ä»¥è¿™æ ·ä½¿ç”¨ <code>napi_get_buffer_info</code>ï¼š</p><ol><li>åˆ›å»ºä¸€ä¸ª Buffer å¯¹è±¡ï¼Œåœ¨ JavaScript ç¯å¢ƒä¸­ã€‚</li><li>åœ¨ä½ çš„ C/C++ æ’ä»¶ä»£ç ä¸­ï¼Œè°ƒç”¨ <code>napi_get_buffer_info</code>ã€‚</li><li><code>napi_get_buffer_info</code> å°†è¿”å›æŒ‡å‘ Buffer æ•°æ®çš„æŒ‡é’ˆå’Œæ•°æ®çš„é•¿åº¦ã€‚</li><li>ä½¿ç”¨è¿™äº›ä¿¡æ¯ï¼Œä½ å¯ä»¥åœ¨ä½ çš„æ’ä»¶ä¸­å¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚</li></ol><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ args[0] æ˜¯ä¼ é€’ç»™æœ¬åœ°å‡½æ•°çš„ Buffer å¯¹è±¡</span></span>
<span class="line"><span>napi_value SomeNativeFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  size_t argc = 1;</span></span>
<span class="line"><span>  napi_value args[1];</span></span>
<span class="line"><span>  napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  void* buffer_data;</span></span>
<span class="line"><span>  size_t buffer_length;</span></span>
<span class="line"><span>  napi_get_buffer_info(env, args[0], &amp;buffer_data, &amp;buffer_length);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ç°åœ¨æˆ‘ä»¬æ‹¿åˆ°äº† buffer_data æŒ‡é’ˆå’Œ buffer_lengthï¼Œ</span></span>
<span class="line"><span>  // å¯ä»¥è¿›è¡Œåç»­æ“ä½œï¼Œæ¯”å¦‚è¯»å–æ•°æ®æˆ–è€…ä¿®æ”¹æ•°æ®ã€‚</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return NULL; // æ ¹æ®æƒ…å†µè¿”å›ç›¸åº”çš„å€¼æˆ–å¯¹è±¡</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡è¿™æ®µä»£ç ï¼Œä½ å¯ä»¥æ“ä½œ JS å±‚é¢çš„ Buffer å¯¹è±¡åœ¨å†…å­˜ä¸­çš„æ•°æ®ã€‚è®°ä½ï¼Œç›´æ¥æ“ä½œå†…å­˜æ•°æ®å¯ä»¥æé«˜æ€§èƒ½ï¼Œå› ä¸ºé¿å…äº†ä¸å¿…è¦çš„å¤åˆ¶ï¼Œä½†åŒæ—¶ä¹Ÿéœ€è¦å°å¿ƒå¤„ç†ï¼Œé˜²æ­¢ç ´åæ•°æ®ç»“æ„ï¼Œå¼•å‘å®‰å…¨é—®é¢˜æˆ–é€ æˆå†…å­˜æ³„æ¼ã€‚</p><p><code>napi_get_buffer_info</code> æ˜¯ Node.js ä¸­ç”¨äºæœ¬åœ°æ’ä»¶å¼€å‘çš„é‡è¦å·¥å…·ï¼Œç‰¹åˆ«æ˜¯å½“å¤„ç†æ€§èƒ½æ•æ„Ÿå‹æ“ä½œæˆ–éœ€è¦å°†æ•°æ®åœ¨ Node.js å’Œæœ¬åœ°ä»£ç ä¹‹é—´ä¼ é€’æ—¶ã€‚</p><h4 id="napi-get-prototype" tabindex="-1"><a class="header-anchor" href="#napi-get-prototype"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_prototype" target="_blank" rel="noopener noreferrer">napi_get_prototype</a></span></a></h4><p>å½“ç„¶ï¼Œå¾ˆä¹æ„ä¸ºä½ è§£é‡Šã€‚N-APIï¼ˆNode.js APIï¼‰æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚åœ¨ Node.js ä¸­ï¼ŒåŸç”Ÿæ’ä»¶æŒ‡çš„æ˜¯ç”¨ C æˆ–è€… C++ç¼–å†™çš„æ¨¡å—ï¼Œè¿™äº›æ¨¡å—å¯ä»¥ç›´æ¥è°ƒç”¨ Node.js åº•å±‚ API ä»¥åŠ V8ï¼ˆNode.js çš„ JavaScript å¼•æ“ï¼‰æä¾›çš„åŠŸèƒ½ã€‚</p><p><code>napi_get_prototype</code>æ˜¯ N-API çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå…è®¸ä½ å–å¾—æŸä¸ª JavaScript å¯¹è±¡çš„åŸå‹ã€‚&quot;åŸå‹&quot;æ˜¯ JavaScript ä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œå‡ ä¹æ‰€æœ‰çš„ JavaScript å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å…³è”çš„åŸå‹å¯¹è±¡ï¼Œè¯¥åŸå‹å¯¹è±¡å®šä¹‰äº†ä¸€ç³»åˆ—å¯è¢«ç»§æ‰¿çš„å±æ€§å’Œæ–¹æ³•ã€‚</p><p>åœ¨ JavaScript ä¸­ï¼Œé€šå¸¸ä½¿ç”¨<code>object.__proto__</code>æˆ–è€…<code>Object.getPrototypeOf(object)</code>è·å–å¯¹è±¡çš„åŸå‹ã€‚ä½†æ˜¯åœ¨ C/C++ç¼–ç çš„åŸç”Ÿæ¨¡å—ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ N-API æä¾›çš„å‡½æ•°ï¼Œæ¯”å¦‚<code>napi_get_prototype</code>ï¼Œæ¥å®ç°ç›¸åŒçš„æ“ä½œã€‚</p><p>ä»¥ä¸‹æ˜¯<code>napi_get_prototype</code>å‡½æ•°çš„ç®€å•è¯´æ˜ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_get_prototype(napi_env env, napi_value js_object, napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>env</code>: è¿™æ˜¯è¡¨ç¤ºå½“å‰ N-API ç¯å¢ƒçš„å¥æŸ„ï¼Œå®ƒæ˜¯ä¸å½“å‰å›è°ƒç›¸å…³è”çš„ä¸Šä¸‹æ–‡ã€‚</li><li><code>js_object</code>: è¿™æ˜¯ä½ æƒ³è¦è·å–åŸå‹çš„ JavaScript å¯¹è±¡ã€‚</li><li><code>result</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘<code>napi_value</code>çš„æŒ‡é’ˆï¼Œå‡½æ•°æ‰§è¡ŒæˆåŠŸåï¼Œå®ƒä¼šæŒ‡å‘è¾“å…¥å¯¹è±¡çš„åŸå‹ã€‚</li></ul><p>å¦‚æœå‡½æ•°è°ƒç”¨æˆåŠŸï¼Œè¿”å›å€¼ä¼šæ˜¯<code>napi_ok</code>ï¼Œè¡¨æ˜æ²¡æœ‰é”™è¯¯å‘ç”Ÿã€‚</p><p>ç°åœ¨è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå‡è®¾çš„ä¾‹å­æ¥çœ‹<code>napi_get_prototype</code>æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š</p><p>å‡è®¾åœ¨ JavaScript ä¸­ï¼Œä½ æœ‰ä¸€ä¸ªåŸºäºç±»<code>Animal</code>åˆ›å»ºçš„å®ä¾‹<code>dog</code>ã€‚åœ¨è¿™ä¸ªç±»ä¸­ï¼Œæœ‰ä¸€ä¸ªæ–¹æ³•å«<code>makeSound</code>ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> Animal</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">  makeSound</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Some sound</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> dog</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Animal</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸€ä¸ªåŸç”Ÿ Node.js æ¨¡å—ä¸­ï¼Œä½ å¯èƒ½æƒ³è¦è·å–è¿™ä¸ª<code>dog</code>å¯¹è±¡çš„åŸå‹ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦å­˜åœ¨<code>makeSound</code>æ–¹æ³•ã€‚ä½ å¯ä»¥è¿™æ ·åšï¼š</p><ol><li>ä½ é¦–å…ˆä½¿ç”¨<code>napi_create_reference</code>å°†<code>dog</code>å¯¹è±¡åŒ…è£¹èµ·æ¥ï¼Œä½¿å…¶å¯ä»¥åœ¨åŸç”Ÿä»£ç ä¸­å®‰å…¨åœ°ä½¿ç”¨ã€‚</li><li>ç„¶åï¼Œä½ è°ƒç”¨<code>napi_get_prototype</code>æ¥è·å–<code>dog</code>å¯¹è±¡çš„åŸå‹ã€‚</li><li>æœ€åï¼Œä½ å¯èƒ½ä¼šä½¿ç”¨<code>napi_has_property</code>æ¥æ£€æŸ¥è¿™ä¸ªåŸå‹å¯¹è±¡ä¸Šæ˜¯å¦æœ‰<code>makeSound</code>è¿™ä¸ªæ–¹æ³•ã€‚</li></ol><p>åœ¨ C/C++ä»£ç ä¸­å¤§è‡´çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å‡è®¾ä½ å·²ç»ä»æŸå¤„è·å¾—äº† &#39;dog&#39; å¯¹è±¡çš„ napi_value è¡¨ç¤º.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value dog_prototype;</span></span>
<span class="line"><span>napi_status status = napi_get_prototype(env, dog, &amp;dog_prototype);</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>bool has_makeSound;</span></span>
<span class="line"><span>status = napi_has_property(env, dog_prototype, &quot;makeSound&quot;, &amp;has_makeSound);</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ç°åœ¨ you can do something with the information whether the prototype has makeSound method.</span></span>
<span class="line"><span>if (has_makeSound) {</span></span>
<span class="line"><span>    // Prototype has the makeSound method.</span></span>
<span class="line"><span>} else {</span></span>
<span class="line"><span>    // Prototype does not have the makeSound method.</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·æ³¨æ„ï¼Œè¿™åªæ˜¯ä¸€ä¸ªæŠ½è±¡çš„ä¾‹å­ï¼Œå®é™…ä¸Šä½ å¯èƒ½è¿˜éœ€è¦è¿›è¡Œæ›´å¤šçš„é”™è¯¯æ£€æŸ¥å’Œèµ„æºç®¡ç†ã€‚å¸Œæœ›è¿™ä¸ªè§£é‡Šå¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œè®©ä½ æ›´å¥½åœ°ç†è§£<code>napi_get_prototype</code>çš„ä½œç”¨å’Œå¦‚ä½•åœ¨åŸç”Ÿ Node.js æ¨¡å—ä¸­ä½¿ç”¨å®ƒã€‚</p><h4 id="napi-get-typedarray-info" tabindex="-1"><a class="header-anchor" href="#napi-get-typedarray-info"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_typedarray_info" target="_blank" rel="noopener noreferrer">napi_get_typedarray_info</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªåº•å±‚çš„ APIï¼Œå…è®¸ä½ ç”¨ C è¯­è¨€ç¼–å†™çš„ä»£ç ä¸ JavaScript ä»£ç è¿›è¡Œäº¤äº’ï¼Œè¿™åœ¨åˆ›å»ºæˆ–ä½¿ç”¨åŸç”Ÿæ’ä»¶æ—¶éå¸¸æœ‰ç”¨ã€‚<code>napi_get_typedarray_info</code>æ˜¯ N-API æä¾›çš„ä¸€ä¸ªå‡½æ•°ï¼Œè®©ä½ èƒ½å¤Ÿä» C è¯­è¨€çš„è§’åº¦è·å– JavaScript ä¸­çš„ TypedArrayï¼ˆç±»å‹åŒ–æ•°ç»„ï¼‰çš„ç›¸å…³ä¿¡æ¯ã€‚</p><p>åœ¨ JavaScript ä¸­ï¼ŒTypedArray æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ•°ç»„ï¼Œå®ƒå…è®¸ä½ ç”¨ä¸€ä¸ªå›ºå®šç±»å‹çš„æ•°æ®æ¥åˆ›å»ºä¸€ä¸ªæ•°ç»„ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª<code>Float32Array</code>å°±æ˜¯åªåŒ…å« 32 ä½æµ®ç‚¹æ•°çš„æ•°ç»„ã€‚è¿™å¯¹äºéœ€è¦é«˜æ€§èƒ½å¤„ç†å¦‚éŸ³é¢‘æ•°æ®ã€å›¾åƒå¤„ç†ç­‰åœºæ™¯éå¸¸æœ‰ç”¨ã€‚</p><p>ç°åœ¨ï¼Œå¦‚æœä½ åœ¨ä¸€ä¸ªåŸç”Ÿæ¨¡å—ä¸­éœ€è¦æ“ä½œä¸€ä¸ªä» JavaScript ä¼ é€’è¿‡æ¥çš„ TypedArrayï¼Œä½ å°±å¯ä»¥ä½¿ç”¨<code>napi_get_typedarray_info</code>å‡½æ•°æ¥äº†è§£è¿™ä¸ª TypedArray çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ¯”å¦‚å®ƒçš„ç±»å‹ã€é•¿åº¦ã€ä»¥åŠå†…å­˜ä¸­çš„ä½ç½®ã€‚</p><p>ä¸‹é¢æ˜¯<code>napi_get_typedarray_info</code>çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å‡è®¾ napi_env env å’Œ napi_value typed_array æ˜¯å·²ç»æä¾›çš„å‚æ•°ã€‚</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_status status;</span></span>
<span class="line"><span>napi_typedarray_type type;</span></span>
<span class="line"><span>size_t length;</span></span>
<span class="line"><span>void* data;</span></span>
<span class="line"><span>size_t byte_offset;</span></span>
<span class="line"><span>size_t byte_length;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>status = napi_get_typedarray_info(</span></span>
<span class="line"><span>  env,           // N-APIç¯å¢ƒå¥æŸ„</span></span>
<span class="line"><span>  typed_array,   // JavaScriptä¸­çš„ç±»å‹åŒ–æ•°ç»„</span></span>
<span class="line"><span>  &amp;type,         // è¿™é‡Œå°†è¿”å›ç±»å‹åŒ–æ•°ç»„çš„ç±»å‹</span></span>
<span class="line"><span>  &amp;length,       // è¿™é‡Œå°†è¿”å›å…ƒç´ çš„ä¸ªæ•°</span></span>
<span class="line"><span>  &amp;data,         // è¿™é‡Œå°†è¿”å›æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆ</span></span>
<span class="line"><span>  NULL,          // å¦‚æœä¸å…³å¿ƒ ArrayBufferï¼Œè¿™é‡Œå¯ä»¥ä¼  NULL</span></span>
<span class="line"><span>  &amp;byte_offset,  // æ•°æ®åœ¨ ArrayBuffer ä¸­çš„å­—èŠ‚åç§»é‡</span></span>
<span class="line"><span>  &amp;byte_length   // æ•°æ®çš„å­—èŠ‚é•¿åº¦</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (status == napi_ok) {</span></span>
<span class="line"><span>  // ç°åœ¨ä½ å¯ä»¥æ ¹æ® type æ¥çŸ¥é“æ•°ç»„ä¸­çš„æ•°æ®ç±»å‹ï¼Œ</span></span>
<span class="line"><span>  // ä½¿ç”¨ data æŒ‡é’ˆè®¿é—®æ•°ç»„ä¸­çš„å®é™…æ•°æ®ï¼Œ</span></span>
<span class="line"><span>  // å¹¶é€šè¿‡ length è·å–æ•°ç»„ä¸­å…ƒç´ çš„æ•°é‡ã€‚</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æ˜¯å‡ ä¸ªå®é™…çš„è¿ç”¨ä¾‹å­ï¼š</p><ol><li><p><strong>å¤„ç†å›¾å½¢æ•°æ®</strong>ï¼šå‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js çš„å›¾åƒå¤„ç†æ¨¡å—ï¼ŒJavaScript ä¼ é€’äº†ä¸€ä¸ªåŒ…å«å›¾åƒåƒç´ æ•°æ®çš„<code>Uint8Array</code>ç»™ä½ çš„åŸç”Ÿæ¨¡å—ã€‚ä½ å¯ä»¥ç”¨<code>napi_get_typedarray_info</code>æ¥è·å–è¿™ä¸ªæ•°ç»„çš„å…·ä½“ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œå›¾åƒå¤„ç†ç®—æ³•çš„åº”ç”¨ï¼Œå¦‚æ»¤é•œã€é¢œè‰²è°ƒæ•´ç­‰ã€‚</p></li><li><p><strong>éŸ³é¢‘ç¼–ç /è§£ç </strong>ï¼šå¦‚æœä½ çš„åŸç”Ÿæ¨¡å—æ˜¯ç”¨æ¥å¤„ç†éŸ³é¢‘æ•°æ®çš„ï¼ŒJavaScript å¯èƒ½ä¼šä¼ é€’ä¸€ä¸ª<code>Float32Array</code>åŒ…å«éŸ³é¢‘æ ·æœ¬ã€‚ä½ å¯ä»¥ç”¨<code>napi_get_typedarray_info</code>è·å¾—æ‰€éœ€ä¿¡æ¯å¹¶å¯¹éŸ³é¢‘æ•°æ®è¿›è¡Œç¼–ç æˆ–è§£ç å¤„ç†ã€‚</p></li><li><p><strong>ç§‘å­¦è®¡ç®—</strong>ï¼šç§‘å­¦è®¡ç®—å¾€å¾€éœ€è¦å¤„ç†å¤§é‡çš„æ•°å€¼æ•°æ®ï¼ŒJavaScript ç«¯å¯èƒ½ä¼šä¼ è¾“<code>Float64Array</code>ç±»å‹çš„ TypedArray ä½œä¸ºæ•°æ®é›†ã€‚ä½ çš„åŸç”Ÿæ¨¡å—å¯ä»¥ä½¿ç”¨<code>napi_get_typedarray_info</code>æ¥è®¿é—®è¿™äº›æ•°æ®æ‰§è¡Œå¤æ‚çš„æ•°å­¦è®¡ç®—ï¼Œå¦‚çŸ©é˜µè¿ç®—ã€ç»Ÿè®¡åˆ†æç­‰ã€‚</p></li></ol><h4 id="napi-get-dataview-info" tabindex="-1"><a class="header-anchor" href="#napi-get-dataview-info"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_dataview_info" target="_blank" rel="noopener noreferrer">napi_get_dataview_info</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIï¼Œå®ƒå…è®¸ JavaScript ä»£ç å’Œ C/C++ä»£ç ä¹‹é—´è¿›è¡Œäº¤äº’ã€‚è¿™æ ·ä½ å¯ä»¥åœ¨ Node.js ç¨‹åºä¸­ä½¿ç”¨ C/C++ç¼–å†™çš„é«˜æ€§èƒ½ä»£ç ã€‚<code>napi_get_dataview_info</code>æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒç”¨æ¥è·å–<code>DataView</code>å¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ã€‚</p><p>é‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯ DataView å‘¢ï¼Ÿåœ¨ JavaScript ä¸­ï¼Œ<code>ArrayBuffer</code>æ˜¯ä¸€ç§å­˜å‚¨äºŒè¿›åˆ¶æ•°æ®çš„æ–¹å¼ï¼Œè€Œ<code>DataView</code>æä¾›äº†ä¸€ä¸ªä½çº§åˆ«çš„æ¥å£æ¥è¯»å–å’Œå†™å…¥<code>ArrayBuffer</code>çš„ä¸åŒç±»å‹çš„æ•°æ®ã€‚</p><p>å‡½æ•°<code>napi_get_dataview_info</code>ä¼šå‘Šè¯‰æˆ‘ä»¬ä¸€ä¸ª<code>DataView</code>å¯¹è±¡é‡Œé¢æœ‰å…³äº<code>ArrayBuffer</code>çš„å“ªäº›ä¿¡æ¯ï¼š</p><ul><li><code>byte_offset</code>ï¼šè¿™æ˜¯<code>DataView</code>å¼€å§‹è¯»æ•°æ®çš„åœ°æ–¹åœ¨<code>ArrayBuffer</code>ä¸­çš„åç§»é‡ã€‚</li><li><code>byte_length</code>ï¼šè¿™æ˜¯<code>DataView</code>å¯ä»¥è¯»æ•°æ®çš„é•¿åº¦ã€‚</li><li><code>arraybuffer</code>ï¼šè¿™å®é™…ä¸Šå°±æ˜¯åº•å±‚çš„<code>ArrayBuffer</code>å¯¹è±¡ã€‚</li></ul><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡ä¾‹å­æ¥è¯´æ˜è¿™ä¸ªå‡½æ•°æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚</p><p>å‡è®¾ä½ åœ¨ C/C++æ‰©å±•æ¨¡å—ä¸­æœ‰ä»¥ä¸‹çš„ N-API å‡½æ•°ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æŸä¸ªå·²ç»ç»‘å®šå¥½çš„å‡½æ•°ï¼Œå½“ä»JSè°ƒç”¨æ—¶å€™æ‰§è¡Œ</span></span>
<span class="line"><span>napi_value GetDataviewInfo(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–DataViewç›¸å…³ä¿¡æ¯</span></span>
<span class="line"><span>    void* data;</span></span>
<span class="line"><span>    size_t byte_offset;</span></span>
<span class="line"><span>    size_t byte_length;</span></span>
<span class="line"><span>    napi_value arraybuffer;</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    status = napi_get_dataview_info(</span></span>
<span class="line"><span>        env,</span></span>
<span class="line"><span>        args[0], // è¿™é‡Œargs[0]æ˜¯ä»JSä¼ è¿›æ¥çš„DataViewå¯¹è±¡</span></span>
<span class="line"><span>        &amp;byte_length,</span></span>
<span class="line"><span>        &amp;data,</span></span>
<span class="line"><span>        &amp;arraybuffer,</span></span>
<span class="line"><span>        &amp;byte_offset</span></span>
<span class="line"><span>    );</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç¡®ä¿è°ƒç”¨æˆåŠŸ</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        napi_throw_error(env, NULL, &quot;Unable to get DataView information&quot;);</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ ¹æ®è·å–åˆ°çš„ä¿¡æ¯å¯ä»¥åšè¿›ä¸€æ­¥å¤„ç†ï¼Œæ¯”å¦‚è¯»å–æˆ–è€…å†™å…¥æ•°æ®</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›ç»“æœç»™JS...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œæ³¨å†ŒGetDataviewInfoåˆ°exportså¯¹è±¡</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value dataview_info_func;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, GetDataviewInfo, NULL, &amp;dataview_info_func);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;getDataviewInfo&quot;, dataview_info_func);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ JavaScript ä¸­ï¼Œä½ å¯èƒ½ä¼šè¿™æ ·ä½¿ç”¨è¿™ä¸ªæ‰©å±•æ¨¡å—æ¥è·å–<code>DataView</code>çš„ä¿¡æ¯ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> myAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/my-addon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ArrayBuffer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">16</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> view</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> DataView</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">buffer</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 16</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// è°ƒç”¨æˆ‘ä»¬çš„C/C++æ‰©å±•å‡½æ•°æ¥è·å–DataViewçš„ä¿¡æ¯</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> info</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> myAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getDataviewInfo</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">view</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">info</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¿™é‡Œå°†æ‰“å°å‡ºDataViewçš„åç§»é‡ã€é•¿åº¦ç­‰ä¿¡æ¯</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¾‹å­æ˜¾ç¤ºäº†å¦‚ä½•åœ¨ Node.js çš„ N-API ä¸­ä½¿ç”¨<code>napi_get_dataview_info</code>å‡½æ•°æ¥ä» JavaScript ä¼ é€’çš„<code>DataView</code>å¯¹è±¡ä¸­æå–ä¿¡æ¯ã€‚è¿™åœ¨ä½ éœ€è¦åœ¨æœ¬åœ°æ‰©å±•æ¨¡å—ä¸­å¤„ç†äºŒè¿›åˆ¶æ•°æ®æ—¶éå¸¸æœ‰ç”¨ã€‚</p><h4 id="napi-get-date-value" tabindex="-1"><a class="header-anchor" href="#napi-get-date-value"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_date_value" target="_blank" rel="noopener noreferrer">napi_get_date_value</a></span></a></h4><p>å¥½çš„ï¼Œæˆ‘æ¥è§£é‡Šä¸€ä¸‹ <code>napi_get_date_value</code> å‡½æ•°åœ¨ Node.js ä¸­çš„ä½œç”¨åŠå…¶è¿ç”¨ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ N-API æ˜¯ä»€ä¹ˆã€‚ç®€å•æ¥è¯´ï¼ŒN-API æ˜¯ Node.js æä¾›çš„ä¸€ä¸ª C è¯­è¨€ API å±‚ï¼Œå®ƒå…è®¸ä½ ç”¨ C æˆ–è€… C++ç¼–å†™ä»£ç æ¥æ„å»ºåŸç”Ÿæ’ä»¶ã€‚åŸç”Ÿæ’ä»¶æ˜¯æŒ‡ç›´æ¥ä¸åº•å±‚æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’çš„æ¨¡å—ï¼Œè¿™é€šå¸¸ç”¨äºæ€§èƒ½å…³é”®çš„æ“ä½œæˆ–è€…è°ƒç”¨ç³»ç»Ÿçº§åˆ«çš„ APIã€‚</p><p>ç°åœ¨ï¼Œä»‹ç» <code>napi_get_date_value</code> å‡½æ•°ï¼š</p><p>è¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯ä»ä¸€ä¸ª JavaScript Date å¯¹è±¡ä¸­æå–å‡ºè¡¨ç¤ºæ—¥æœŸå’Œæ—¶é—´çš„æ•°å€¼ã€‚åœ¨ JavaScript ä¸­ï¼Œæ—¥æœŸå’Œæ—¶é—´è¢«å­˜å‚¨ä¸ºè‡ª 1970 å¹´ 1 æœˆ 1 æ—¥ UTCï¼ˆåè°ƒä¸–ç•Œæ—¶ï¼‰ä»¥æ¥çš„æ¯«ç§’æ•°ï¼Œè¿™ä¹Ÿè¢«ç§°ä½œæ—¶é—´æˆ³ã€‚</p><p><code>napi_get_date_value</code> å‡½æ•°ä½œä¸º N-API çš„ä¸€éƒ¨åˆ†ï¼Œå…è®¸ä½ åœ¨ç¼–å†™æ‰©å±•ä»£ç æ—¶ï¼ˆæ¯”å¦‚ç”¨ C/C++ï¼‰ï¼Œè·å– JavaScript Date å¯¹è±¡æ‰€ä»£è¡¨çš„æ—¶é—´æˆ³ã€‚</p><p>å‡½æ•°çš„å®šä¹‰å¤§è‡´å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_get_date_value(napi_env env,</span></span>
<span class="line"><span>                                napi_value value,</span></span>
<span class="line"><span>                                double* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>ï¼šå½“å‰æ‰§è¡Œç¯å¢ƒçš„å¥æŸ„ã€‚</li><li><code>value</code>ï¼šä¸€ä¸ª napi_value ç±»å‹çš„å˜é‡ï¼Œå®ƒåº”è¯¥æ˜¯ä¸€ä¸ª JavaScript Date å¯¹è±¡ã€‚</li><li><code>result</code>ï¼šä¸€ä¸ªæŒ‡å‘ double ç±»å‹å˜é‡çš„æŒ‡é’ˆï¼Œå‡½æ•°ä¼šå°† Date å¯¹è±¡çš„æ—¶é—´æˆ³ä»¥æ¯«ç§’ä¸ºå•ä½å­˜å‚¨åœ¨è¿™ä¸ªå˜é‡é‡Œã€‚</li></ul><p>å¦‚æœå‡½æ•°æˆåŠŸæ‰§è¡Œï¼Œå®ƒä¼šè¿”å› <code>napi_ok</code>ã€‚</p><p>ç°åœ¨è®©æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¾‹å­ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js çš„åŸç”Ÿæ’ä»¶ï¼Œè¿™ä¸ªæ’ä»¶éœ€è¦å¤„ç† JavaScript ä¼ é€’è¿‡æ¥çš„æ—¥æœŸæ•°æ®ï¼Œç„¶åè¿›è¡Œä¸€äº›å¤æ‚çš„æ“ä½œï¼Œä¾‹å¦‚ä¸å…¶ä»–ç³»ç»Ÿçš„æ—¥æœŸ/æ—¶é—´äº¤äº’ï¼Œæˆ–è€…æ‰§è¡Œä¸€äº›æ€§èƒ½å¯†é›†å‹çš„æ—¥æœŸè®¡ç®—ã€‚</p><p>åœ¨ C++ä»£ç ä¸­ï¼Œä½ å¯èƒ½ä¼šè¿™æ ·ä½¿ç”¨ <code>napi_get_date_value</code>ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°è¢«å‡å®šä¸ºN-APIæš´éœ²ç»™JavaScriptçš„å‡½æ•°</span></span>
<span class="line"><span>napi_value ProcessDate(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è·å–JavaScriptä¼ é€’çš„å‚æ•°</span></span>
<span class="line"><span>  size_t argc = 1;</span></span>
<span class="line"><span>  napi_value args[1];</span></span>
<span class="line"><span>  status = napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ç¡®ä¿è·å¾—äº†ä¸€ä¸ªå‚æ•°ï¼Œå¹¶ä¸”è¯¥å‚æ•°æ˜¯ä¸€ä¸ªDateå¯¹è±¡</span></span>
<span class="line"><span>  if (status != napi_ok || argc `&lt;` 1) {</span></span>
<span class="line"><span>    // Handle error...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æå–Dateå¯¹è±¡çš„æ—¶é—´æˆ³</span></span>
<span class="line"><span>  double dateValue;</span></span>
<span class="line"><span>  status = napi_get_date_value(env, args[0], &amp;dateValue);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // Handle error...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥åˆ©ç”¨dateValueå˜é‡ï¼ˆå®ƒåŒ…å«äº†æ—¶é—´æˆ³ï¼‰æ¥æ‰§è¡Œä½ çš„æ“ä½œ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åšå®Œæ‰€æœ‰å¤„ç†åï¼Œè¿”å›ç»“æœåˆ°JavaScript</span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span>  status = napi_create_double(env, dateValue, &amp;result);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // Handle error...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šä»£ç å±•ç¤ºäº†å¦‚ä½•åœ¨ä¸€ä¸ª N-API å‡½æ•°å†…éƒ¨è·å– JavaScript ä¼ é€’çš„ Date å¯¹è±¡å‚æ•°ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºè¡¨ç¤ºæ—¶é—´æˆ³çš„æ•°å­—ï¼Œç„¶åç”¨è¿™ä¸ªå€¼åšè¿›ä¸€æ­¥çš„å¤„ç†ã€‚</p><p>åœ¨ JavaScript ç«¯çš„è°ƒç”¨å¯èƒ½ä¼šæ˜¯è¿™æ ·çš„ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/native-addon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> jsDate</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Date</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">2023-01-01T00:00:00Z</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> timestamp</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">ProcessDate</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">jsDate</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">timestamp</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºå¯¹åº”çš„æ—¶é—´æˆ³</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œ <code>native-addon</code> æ˜¯æˆ‘ä»¬å‡è®¾çš„åŸç”Ÿæ¨¡å—åå­—ï¼Œå®ƒé€šè¿‡ <code>ProcessDate</code> å‡½æ•°æš´éœ²ç»™ JavaScriptï¼ŒJavaScript ç«¯åˆ›å»ºäº†ä¸€ä¸ª Date å®ä¾‹å¹¶ä¼ é€’ç»™äº†è¿™ä¸ªå‡½æ•°ï¼Œç„¶åå¾—åˆ°äº†ç›¸åº”çš„æ—¶é—´æˆ³è¾“å‡ºã€‚</p><p>å¸Œæœ›è¿™ä¸ªè§£é‡Šå’Œä¾‹å­èƒ½å¤Ÿå¸®åŠ©ä½ ç†è§£ <code>napi_get_date_value</code> å‡½æ•°åœ¨ Node.js ä¸­çš„ç”¨æ³•ã€‚</p><h4 id="napi-get-value-bool" tabindex="-1"><a class="header-anchor" href="#napi-get-value-bool"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_value_bool" target="_blank" rel="noopener noreferrer">napi_get_value_bool</a></span></a></h4><p>å¥½çš„ï¼Œæˆ‘æ¥è§£é‡Šä¸€ä¸‹ Node.js ä¸­ <code>napi_get_value_bool</code> è¿™ä¸ª API çš„ä½œç”¨å’Œåº”ç”¨åœºæ™¯ã€‚</p><p>é¦–å…ˆï¼Œ<code>napi_get_value_bool</code> æ˜¯ Node.js çš„ N-API æ¥å£ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒç”¨äºå°†ä¸€ä¸ª JavaScript å€¼ä» JavaScript ç¯å¢ƒè½¬æ¢æˆ C æˆ–è€… C++ ç¯å¢ƒä¸­çš„åŸç”Ÿå¸ƒå°”å€¼ç±»å‹ï¼ˆå³ <code>bool</code> ç±»å‹ï¼‰ã€‚</p><p>åœ¨ JavaScript ä¸­ï¼Œæœ‰äº”ç§æ•°æ®ç±»å‹è¢«ç§°ä¸º &quot;Falsy&quot; å€¼ï¼Œå®ƒä»¬åŒ…æ‹¬ï¼š<code>false</code>, <code>0</code>, <code>-0</code>, <code>&quot;&quot;</code> (ç©ºå­—ç¬¦ä¸²), <code>null</code>, <code>undefined</code>, å’Œ <code>NaN</code>ã€‚é™¤è¿™äº›ä¹‹å¤–çš„å…¶ä»–æ‰€æœ‰å€¼éƒ½è¢«è§†ä¸º &quot;Truthy&quot; å€¼ï¼Œå³åœ¨å¸ƒå°”ä¸Šä¸‹æ–‡ä¸­ä¼šè¢«å½“ä½œçœŸå€¼å¤„ç†ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ <code>napi_get_value_bool</code> å‡½æ•°æ—¶ï¼ŒJavaScript ä¸­çš„å€¼ä¼šè¢«è½¬æ¢ä¸ºå®ƒå¯¹åº”çš„å¸ƒå°”å€¼ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥ç†è§£è¿™ä¸ªå‡½æ•°çš„å·¥ä½œåŸç†ã€‚</p><p>å‡è®¾ä½ æœ‰å¦‚ä¸‹çš„ JavaScript ä»£ç ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// åœ¨ JavaScript ä¸­å®šä¹‰äº†ä¸¤ä¸ªå˜é‡</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> jsTruthyValue</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 1</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¿™æ˜¯ä¸€ä¸ª Truthy å€¼</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> jsFalsyValue</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¿™æ˜¯ä¸€ä¸ª Falsy å€¼</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js çš„æ‰©å±•æ¨¡å—ï¼Œå¹¶å¸Œæœ›åœ¨ä½ çš„ C++ ä»£ç ä¸­è·å–è¿™äº› JavaScript å˜é‡çš„å¸ƒå°”å€¼è¡¨ç¤ºå½¢å¼ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>napi_get_value_bool</code> å‡½æ•°æ¥å®ç°ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¦‚ä½•åœ¨ C++ æ‰©å±•æ¨¡å—ä¸­ä½¿ç”¨ <code>napi_get_value_bool</code> å‡½æ•°çš„å¤§è‡´ç¤ºä¾‹ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ args[0] æ˜¯ä¼ é€’ç»™æˆ‘ä»¬æ‰©å±•å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°</span></span>
<span class="line"><span>napi_status status;</span></span>
<span class="line"><span>bool cBoolValue;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è·å– JavaScript ä¸­ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„å¸ƒå°”å€¼</span></span>
<span class="line"><span>status = napi_get_value_bool(env, args[0], &amp;cBoolValue);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ç°åœ¨ cBoolValue å°±åŒ…å«äº†ä¼ å…¥çš„ JavaScript å€¼çš„å¸ƒå°”å€¼è¡¨ç¤º</span></span>
<span class="line"><span>printf(&quot;The boolean value is: %s\n&quot;, cBoolValue ? &quot;true&quot; : &quot;false&quot;);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ° <code>napi_get_value_bool</code> æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚å®ƒæ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li><code>env</code>ï¼šå½“å‰çš„ N-API ç¯å¢ƒå¥æŸ„ã€‚</li><li><code>args[0]</code>ï¼šä½ æƒ³è½¬æ¢æˆå¸ƒå°”å€¼çš„ JavaScript å€¼ã€‚</li><li><code>&amp;cBoolValue</code>ï¼šä¸€ä¸ªæŒ‡å‘åŸç”Ÿ <code>bool</code> å˜é‡çš„æŒ‡é’ˆï¼Œå‡½æ•°æ‰§è¡ŒæˆåŠŸåï¼Œè¿™ä¸ªå˜é‡å°±ä¼šåŒ…å«è½¬æ¢åçš„å¸ƒå°”å€¼ã€‚</li></ul><p>ä¸€æ—¦è°ƒç”¨ <code>napi_get_value_bool</code> æˆåŠŸæ‰§è¡Œï¼ŒåŸç”Ÿçš„ <code>bool</code> å˜é‡ <code>cBoolValue</code> å°±ä¼šè¢«è®¾ç½®ä¸º <code>true</code> æˆ– <code>false</code>ï¼Œå–å†³äºä¼ å…¥çš„ JavaScript å€¼æ˜¯ Truthy è¿˜æ˜¯ Falsyã€‚</p><p>åœ¨ä½ çš„ Node.js é¡¹ç›®ä¸­ï¼Œå¦‚æœä½ éœ€è¦åœ¨åŸç”Ÿ C/C++ ä»£ç é‡Œæ­£ç¡®å¤„ç† JavaScript ç¯å¢ƒä¼ å…¥çš„å¸ƒå°”å€¼ï¼Œè¿™ä¸ªåŠŸèƒ½å°±éå¸¸é‡è¦ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥ç¡®ä¿ JavaScript å±‚é¢ä¸Šçš„é€»è¾‘åœ¨ C/C++ å±‚é¢ä¸Šå¾—åˆ°æ­£ç¡®çš„åæ˜ ï¼Œè¿›è€Œåœ¨æ‰©å±•æ¨¡å—ä¸­ä½¿ç”¨è¿™äº›å¸ƒå°”å€¼è¿›è¡Œé€»è¾‘æ§åˆ¶æˆ–é…ç½®ã€‚</p><h4 id="napi-get-value-double" tabindex="-1"><a class="header-anchor" href="#napi-get-value-double"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_value_double" target="_blank" rel="noopener noreferrer">napi_get_value_double</a></span></a></h4><p><code>napi_get_value_double</code> æ˜¯ Node.js ä¸­çš„ N-API å‡½æ•°ï¼ŒN-API æ˜¯ä¸€å¥—ç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶çš„ C APIã€‚Node.js å…è®¸ä½ ä½¿ç”¨ C, C++ ç­‰è¯­è¨€ç¼–å†™æ‰©å±•æ¨¡å—ï¼Œè¿™äº›æ‰©å±•æ¨¡å—å¯ä»¥ç›´æ¥æ“ä½œåº•å±‚èµ„æºæˆ–æ‰§è¡Œé«˜æ€§èƒ½è®¡ç®—ä»»åŠ¡ã€‚</p><p><code>napi_get_value_double</code> çš„ç›®çš„æ˜¯åœ¨ä¸€ä¸ªæœ¬åœ°æ’ä»¶ï¼ˆC/C++ä»£ç ï¼‰ä¸­ä» JavaScript ä¼ æ¥çš„ <code>Number</code> ç±»å‹çš„å€¼ä¸­æå–å‡ºåŒç²¾åº¦æµ®ç‚¹æ•°ï¼ˆå³ C/C++ ä¸­çš„ <code>double</code> ç±»å‹ï¼‰ã€‚å½“ä½ çš„æ’ä»¶ä» JavaScript æ¥æ”¶ä¸€ä¸ªæ•°å­—ï¼Œå¹¶å¸Œæœ›å°†å…¶ç”¨ä½œ C/C++ ä¸­çš„ <code>double</code> ç±»å‹æ—¶éœ€è¦ç”¨åˆ°å®ƒã€‚</p><p>å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_get_value_double(napi_env env, napi_value value, double* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>å‚æ•°è§£é‡Šï¼š</p><ul><li><code>env</code>: è¡¨ç¤ºå½“å‰çš„ç¯å¢ƒï¼Œé€šå¸¸æ˜¯æ¯ä¸ªå‡½æ•°éƒ½ä¼šæœ‰çš„ä¸Šä¸‹æ–‡å‚æ•°ã€‚</li><li><code>value</code>: æ˜¯ä¸€ä¸ª <code>napi_value</code> ç±»å‹ï¼Œå®ƒä»£è¡¨äº† JavaScript ä¸­çš„ä¸€ä¸ª Number å€¼ã€‚</li><li><code>result</code>: æ˜¯æŒ‡å‘ <code>double</code> å˜é‡çš„æŒ‡é’ˆï¼Œç”¨äºå­˜å‚¨è½¬æ¢åçš„åŒç²¾åº¦æµ®ç‚¹æ•°ã€‚</li></ul><p>è¿”å›å€¼ï¼š</p><ul><li>è¿”å› <code>napi_status</code>ï¼Œè¡¨ç¤ºå‡½æ•°è°ƒç”¨æˆåŠŸä¸å¦çš„çŠ¶æ€ç ã€‚å¦‚æœå‡½æ•°æ‰§è¡ŒæˆåŠŸï¼Œå®ƒé€šå¸¸ä¼šè¿”å› <code>napi_ok</code>ã€‚</li></ul><p>ä¸‹é¢ä¸¾ä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªæœ¬åœ°æ’ä»¶ï¼Œè¯¥æ’ä»¶éœ€è¦ä» JavaScript æ¥æ”¶ä¸€ä¸ªæ•°å­—ï¼Œç„¶åä½¿ç”¨è¿™ä¸ªæ•°å­—è¿›è¡Œä¸€äº›è®¡ç®—ã€‚</p><p>é¦–å…ˆï¼Œåœ¨ä½ çš„ C/C++ æºæ–‡ä»¶ä¸­ï¼Œä½ å¯èƒ½ä¼šæœ‰ç±»ä¼¼ä¸‹é¢çš„ä»£ç ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªæ˜¯ä½ çš„å‡½æ•°å®ç°ï¼Œå®ƒå°†è¢« JavaScript è°ƒç”¨</span></span>
<span class="line"><span>napi_value CalculateSomething(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    double number;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–JavaScriptä¼ é€’çš„å‚æ•°</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ä»args[0]ä¸­æå–doubleå€¼</span></span>
<span class="line"><span>    if (napi_get_value_double(env, args[0], &amp;number) != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ¥ä¸‹æ¥ä½ å¯ä»¥ä½¿ç”¨ number è¿›è¡Œè®¡ç®—</span></span>
<span class="line"><span>    double result = number * 2.0; // å‡è®¾æˆ‘ä»¬åªæ˜¯ç®€å•åœ°å°†å…¶ä¹˜ä»¥2</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æœ€åä½ éœ€è¦å°†è®¡ç®—ç»“æœè¿”å›ç»™ JavaScript</span></span>
<span class="line"><span>    napi_value returnValue;</span></span>
<span class="line"><span>    napi_create_double(env, result, &amp;returnValue);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return returnValue;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œå°†ä¸Šé¢çš„å‡½æ•°æš´éœ²ç»™ JavaScript</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, CalculateSomething, NULL, &amp;fn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;calculate&quot;, fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ JavaScript ç«¯ï¼Œä½ å¯ä»¥åƒè¿™æ ·è°ƒç”¨è¿™ä¸ªæ’ä»¶çš„å‡½æ•°ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/native-addon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">calculate</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">3.14</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: 6.28</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼ŒJavaScript ä»£ç è°ƒç”¨äº†æœ¬åœ°æ’ä»¶çš„ <code>calculate</code> å‡½æ•°ï¼Œå¹¶ä¼ å…¥äº†ä¸€ä¸ªæ•°å­— <code>3.14</code>ã€‚C/C++ æ’ä»¶æ¥æ”¶è¿™ä¸ªæ•°å­—ï¼Œé€šè¿‡ <code>napi_get_value_double</code> æå–ä¸º <code>double</code> ç±»å‹ï¼Œç„¶åå°†å…¶ä¹˜ä»¥ 2 åè¿”å›ç»“æœ <code>6.28</code> ç»™ JavaScriptã€‚</p><p>è¿™ç§æœºåˆ¶å…è®¸ Node.js æ‰©å±•å…¶åŠŸèƒ½å¹¶å¤„ç†é«˜æ€§èƒ½è®¡ç®—æˆ–æ›´ç›´æ¥åœ°ä¸ç³»ç»Ÿèµ„æºäº¤äº’ï¼ŒåŒæ—¶ä¿æŒ JavaScript ä»£ç çš„æ¸…æ™°å’Œç®€æ´ã€‚</p><h4 id="napi-get-value-bigint-int64" tabindex="-1"><a class="header-anchor" href="#napi-get-value-bigint-int64"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_value_bigint_int64" target="_blank" rel="noopener noreferrer">napi_get_value_bigint_int64</a></span></a></h4><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬æ¥ç®€å•æ·±å…¥åœ°äº†è§£ä¸€ä¸‹ Node.js ä¸­çš„<code>napi_get_value_bigint_int64</code>å‡½æ•°ã€‚</p><p>é¦–å…ˆï¼ŒN-API æ˜¯ Node.js çš„ä¸€ä¸ª C è¯­è¨€ APIï¼Œå®ƒç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶ã€‚æœ¬åœ°æ’ä»¶æ˜¯ç›´æ¥ä¸ Node.js è¿è¡Œæ—¶è¿›è¡Œäº¤äº’çš„åŠ¨æ€é“¾æ¥å…±äº«å¯¹è±¡ï¼Œé€šå¸¸ç”¨äºæ€§èƒ½æ•æ„Ÿçš„æ“ä½œæˆ–æ˜¯å¯¹å·²æœ‰ C/C++åº“çš„å°è£…ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬èšç„¦åœ¨<code>napi_get_value_bigint_int64</code>è¿™ä¸ªå…·ä½“çš„ N-API å‡½æ•°ä¸Šã€‚è¿™ä¸ªå‡½æ•°å…è®¸ä½ ä» JavaScript å±‚é¢ä¼ é€’çš„ä¸€ä¸ª BigInt å€¼è½¬æ¢ä¸º C è¯­è¨€å±‚é¢çš„ int64_t å€¼ã€‚BigInt æ˜¯ä¸€ä¸ª JavaScript çš„æ•°æ®ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºä»»æ„ç²¾åº¦çš„æ•´æ•°ã€‚è€Œåœ¨ C è¯­è¨€ä¸­ï¼Œint64_t åˆ™æ˜¯ä¸€ä¸ªå›ºå®šå¤§å°ï¼ˆ64 ä½ï¼‰çš„æ•´å‹æ•°æ®ç±»å‹ã€‚</p><p>è¿™æ˜¯<code>napi_get_value_bigint_int64</code>å‡½æ•°çš„åŸºæœ¬å£°æ˜ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_get_value_bigint_int64(napi_env env,</span></span>
<span class="line"><span>                                        napi_value value,</span></span>
<span class="line"><span>                                        int64_t* result,</span></span>
<span class="line"><span>                                        bool* lossless);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>: è¿™æ˜¯ä¸€ä¸ªä»£è¡¨ Node.js ç¯å¢ƒçš„å¥æŸ„ï¼Œæ‰€æœ‰çš„ N-API è°ƒç”¨éƒ½éœ€è¦è¿™ä¸ªå‚æ•°ã€‚</li><li><code>value</code>: è¿™æ˜¯ä¸€ä¸ªä»£è¡¨ JavaScript ä¸­ BigInt å€¼çš„<code>napi_value</code>ã€‚</li><li><code>result</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘<code>int64_t</code>å˜é‡çš„æŒ‡é’ˆï¼Œåœ¨å‡½æ•°æ‰§è¡Œåï¼Œè¯¥å˜é‡å°†å­˜å‚¨è½¬æ¢å¾—åˆ°çš„ 64 ä½æ•´æ•°å€¼ã€‚</li><li><code>lossless</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘å¸ƒå°”å€¼çš„æŒ‡é’ˆï¼Œå®ƒä¼šå‘Šè¯‰ä½ è½¬æ¢æ˜¯å¦â€œæ— æŸâ€ï¼Œå³ BigInt æ˜¯å¦å¯ä»¥å®Œå…¨ä¸ä¸¢å¤±ä»»ä½•ä¿¡æ¯åœ°è½¬æ¢ä¸º 64 ä½æ•´æ•°ã€‚</li></ul><p>å¦‚æœ BigInt å€¼å¤ªå¤§ï¼Œæ— æ³•ä»¥æ— æŸæ–¹å¼æ”¾å…¥ 64 ä½æ•´æ•°ï¼Œåˆ™<code>lossless</code>æŒ‡é’ˆæ‰€æŒ‡å‘çš„å€¼ä¼šè¢«è®¾ç½®ä¸º<code>false</code>ï¼Œå¹¶ä¸”ç»“æœå¯èƒ½æ˜¯æˆªæ–­åçš„å€¼ã€‚</p><p>ä»¥ä¸‹æ˜¯å¦‚ä½•åœ¨å®é™…çš„ C ä»£ç ä¸­ä½¿ç”¨è¯¥å‡½æ•°çš„ä¾‹å­ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æˆ‘ä»¬å·²ç»è·å¾—äº†ä»£è¡¨BigIntçš„napi_value, named js_bigint</span></span>
<span class="line"><span>napi_value js_bigint;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... js_bigint è¢«èµ‹å€¼çš„ä»£ç  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>int64_t my_number;</span></span>
<span class="line"><span>bool is_lossless;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è°ƒç”¨napi_get_value_bigint_int64æ¥è½¬æ¢BigIntåˆ°int64_t</span></span>
<span class="line"><span>napi_status status = napi_get_value_bigint_int64(env, js_bigint, &amp;my_number, &amp;is_lossless);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (status == napi_ok) {</span></span>
<span class="line"><span>    if (is_lossless) {</span></span>
<span class="line"><span>        // è½¬æ¢æˆåŠŸï¼Œå¹¶ä¸”æ˜¯æ— æŸçš„</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // è½¬æ¢æˆåŠŸï¼Œä½†æ˜¯æœ‰æŸçš„ï¼ŒBigIntå€¼å¤ªå¤§ï¼Œä¸èƒ½å®Œå…¨æ”¾å…¥int64_t</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>} else {</span></span>
<span class="line"><span>    // è°ƒç”¨å¤±è´¥ï¼Œå¤„ç†é”™è¯¯</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª<code>int64_t</code>ç±»å‹çš„å˜é‡<code>my_number</code>ï¼Œä»¥åŠä¸€ä¸ªå¸ƒå°”å˜é‡<code>is_lossless</code>ã€‚ç„¶åï¼Œæˆ‘ä»¬è°ƒç”¨äº†<code>napi_get_value_bigint_int64</code>å‡½æ•°ï¼ŒæœŸæœ›å°†ä¸€ä¸ª BigInt å€¼è½¬æ¢ä¸ºä¸€ä¸ª<code>int64_t</code>å€¼ï¼Œå¹¶é€šè¿‡<code>is_lossless</code>æ¥æ£€æµ‹è½¬æ¢æ˜¯å¦æ— æŸã€‚</p><p>è¯·æ³¨æ„ï¼ŒçœŸå®ä¸–ç•Œçš„æƒ…å†µå¯èƒ½æ›´å¤æ‚ï¼Œå› ä¸ºè¿˜æ¶‰åŠåˆ°ä» JavaScript ä¼ é€’ BigInt å€¼åˆ° C æ’ä»¶ç­‰è¿‡ç¨‹ï¼Œä½†ä¸Šè¿°ä»£ç å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨è¿™ä¸ªç‰¹å®šçš„ N-API å‡½æ•°è¿›è¡ŒåŸºæœ¬è½¬æ¢ã€‚</p><h4 id="napi-get-value-bigint-uint64" tabindex="-1"><a class="header-anchor" href="#napi-get-value-bigint-uint64"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_value_bigint_uint64" target="_blank" rel="noopener noreferrer">napi_get_value_bigint_uint64</a></span></a></h4><p>Node.js ä¸­çš„ <code>napi_get_value_bigint_uint64</code> æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ã€‚N-API æ˜¯ä¸€ä¸ª C è¯­è¨€çš„ APIï¼Œå…è®¸åŸç”Ÿæ’ä»¶ï¼ˆé€šå¸¸ç”¨ C æˆ– C++ç¼–å†™ï¼‰ä¸ JavaScript ä»£ç è¿›è¡Œäº¤äº’ï¼Œè€Œä¸å— Node.js ç‰ˆæœ¬å˜åŒ–çš„å½±å“ã€‚</p><p>åœ¨ JavaScript ä¸­ï¼Œ<code>BigInt</code>æ˜¯ä¸€ç§æ•°å€¼ç±»å‹ï¼Œå¯ä»¥è¡¨ç¤ºå¤§äº<code>Number.MAX_SAFE_INTEGER</code>çš„æ•´æ•°ã€‚ç›¸åï¼Œåœ¨ C/C++ç­‰è¯­è¨€ä¸­ï¼Œé€šå¸¸ä½¿ç”¨ç‰¹å®šçš„æ•°æ®ç±»å‹æ¥è¡¨ç¤ºå¤§æ•´æ•°ï¼Œä¾‹å¦‚<code>uint64_t</code>ï¼ˆä¸€ä¸ªæ— ç¬¦å·çš„ 64 ä½æ•´æ•°ï¼‰ã€‚</p><p>å‡½æ•°<code>napi_get_value_bigint_uint64</code>å…è®¸ä½ ä»ä¸€ä¸ª JavaScript <code>BigInt</code>å¯¹è±¡è·å–å…¶å€¼ï¼Œå¹¶å°†è¿™ä¸ªå€¼ä½œä¸ºä¸€ä¸ª 64 ä½æ— ç¬¦å·æ•´æ•°ï¼ˆ<code>uint64_t</code>ï¼‰å­˜æ”¾åˆ°åŸç”Ÿä»£ç å˜é‡ä¸­ã€‚</p><p>ä»¥ä¸‹æ˜¯<code>napi_get_value_bigint_uint64</code>å‡½æ•°çš„åŸºæœ¬ç”¨é€”ï¼š</p><ol><li>ä» JavaScript ä¼ é€’ä¸€ä¸ªå¤§æ•´æ•°åˆ°åŸç”Ÿæ’ä»¶ã€‚</li><li>åœ¨åŸç”Ÿæ’ä»¶ä¸­ï¼Œä½¿ç”¨<code>napi_get_value_bigint_uint64</code>æå–è¿™ä¸ªå¤§æ•´æ•°çš„å€¼ã€‚</li><li>ä½¿ç”¨è¿™ä¸ªå€¼è¿›è¡Œä¸€äº› C/C++å±‚é¢çš„æ“ä½œï¼Œæ¯”å¦‚ç®—æœ¯æ“ä½œã€äºŒè¿›åˆ¶æ“ä½œç­‰ã€‚</li></ol><p>ç°å®åº”ç”¨ç¤ºä¾‹ï¼š</p><ol><li><p><strong>æ–‡ä»¶ç³»ç»Ÿè®¿é—®</strong>ï¼šæƒ³è±¡ä¸€ä¸ª Node.js åº”ç”¨ï¼Œéœ€è¦å¤„ç†æ–‡ä»¶çš„å¤§å°ã€‚æœ‰æ—¶å€™ï¼Œæ–‡ä»¶å¯èƒ½éå¸¸å¤§ï¼Œè¶…è¿‡äº†æ ‡å‡† JavaScript æ•°å€¼èƒ½å¤Ÿå®‰å…¨è¡¨ç¤ºçš„èŒƒå›´ã€‚è¿™æ—¶ï¼Œä½ å¯èƒ½ä¼šç”¨åˆ°<code>BigInt</code>ã€‚å¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªæ‰©å±•æ¨¡å—æ¥ä¼˜åŒ–æ–‡ä»¶å¤§å°çš„æ£€ç´¢ï¼Œé‚£ä¹ˆä½ å¯èƒ½éœ€è¦ç”¨åˆ°<code>napi_get_value_bigint_uint64</code>æ¥æ­£ç¡®åœ°å¤„ç†è¿™äº›å¤§çš„æ•°å€¼ã€‚</p></li><li><p><strong>é«˜ç²¾åº¦æ—¶é—´æˆ³</strong>ï¼šæŸäº›åº”ç”¨ç¨‹åºå¯èƒ½éœ€è¦é«˜ç²¾åº¦æ—¶é—´æˆ³ï¼Œè¿™äº›æ—¶é—´æˆ³çš„ç²¾åº¦è¶…å‡ºäº† JavaScript æ™®é€šæ•°å­—ç±»å‹çš„èŒƒå›´ã€‚ä¾‹å¦‚ï¼Œå½“ä½ è¦ä¸ä¸€äº›éœ€è¦é«˜ç²¾åº¦è®¡æ—¶çš„ç¡¬ä»¶è®¾å¤‡äº¤äº’æ—¶ï¼Œå¯èƒ½ä¼šç”¨åˆ°<code>BigInt</code>æ¥è¡¨ç¤ºè¿™äº›æ—¶é—´æˆ³ã€‚åœ¨åŸç”Ÿæ¨¡å—ä¸­ï¼Œä½ å°†ä½¿ç”¨<code>napi_get_value_bigint_uint64</code>æ¥æ¥æ”¶å’Œå¤„ç†è¿™äº›é«˜ç²¾åº¦çš„å€¼ã€‚</p></li><li><p><strong>å¤§æ•´æ•°è¿ç®—</strong>ï¼šå‡å¦‚ä½ çš„åº”ç”¨éœ€è¦æ‰§è¡Œå¤§æ•´æ•°åŠ å¯†ç®—æ³•ï¼Œå¦‚ RSA åŠ å¯†ï¼Œè¿™é€šå¸¸æ¶‰åŠåˆ°å¾ˆå¤§çš„æ•°å€¼è¿ç®—ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒJavaScript çš„<code>BigInt</code>å¯ç”¨äºè¡¨ç¤ºè¿™äº›å¤§æ•°ï¼Œè€Œ<code>napi_get_value_bigint_uint64</code>åˆ™å¯ç”¨äºå°†å®ƒä»¬ä¼ é€’ç»™æ‰§è¡ŒåŠ å¯†ç®—æ³•çš„åŸç”Ÿæ’ä»¶ä»£ç ã€‚</p></li></ol><p>ä¸¾ä¸€ä¸ªç®€å•çš„ä»£ç ä¾‹å­ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™ä¸ªå‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œinfo[0] æ˜¯ä¸€ä¸ª BigInt å¯¹è±¡ã€‚</span></span>
<span class="line"><span>napi_value GetBigIntAsUint64(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  napi_status status;</span></span>
<span class="line"><span>  size_t argc = 1;</span></span>
<span class="line"><span>  napi_value args[1];</span></span>
<span class="line"><span>  uint64_t result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è·å– JavaScript å‡½æ•°ä¸­çš„å‚æ•°åˆ—è¡¨</span></span>
<span class="line"><span>  status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å°† BigInt è½¬æ¢ä¸º uint64_t</span></span>
<span class="line"><span>  bool lossless; // è¿™ä¸ªå˜é‡è¡¨ç¤ºè½¬æ¢æ˜¯å¦æŸå¤±ç²¾åº¦</span></span>
<span class="line"><span>  status = napi_get_value_bigint_uint64(env, args[0], &amp;result, &amp;lossless);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ç°åœ¨ result å˜é‡ä¸­åŒ…å«äº† BigInt çš„å€¼ï¼Œå¹¶å¯ä»¥åœ¨ C/C++ ä»£ç ä¸­ä½¿ç”¨å®ƒ</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ... ä½ çš„ä»£ç é€»è¾‘ ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›ä¸€ä¸ªæ–°çš„ BigInt ç»™ JavaScript</span></span>
<span class="line"><span>  napi_value new_bigint;</span></span>
<span class="line"><span>  status = napi_create_bigint_uint64(env, result, &amp;new_bigint);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return new_bigint;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°<code>GetBigIntAsUint64</code>ï¼Œå®ƒä» JavaScript æ¥æ”¶ä¸€ä¸ª<code>BigInt</code>å¯¹è±¡ï¼Œç„¶åä½¿ç”¨<code>napi_get_value_bigint_uint64</code>å°†å…¶è½¬æ¢ä¸º<code>uint64_t</code>ç±»å‹ï¼Œå¹¶å¯ä»¥åœ¨ C/C++ä¸­å¯¹å®ƒè¿›è¡Œæ“ä½œã€‚æœ€åï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„<code>BigInt</code>å¯¹è±¡ï¼Œå°†å…¶è¿”å›ç»™ JavaScriptã€‚</p><p>è¯·æ³¨æ„ï¼Œä¸ºäº†ç¡®ä¿ç±»å‹å®‰å…¨å’Œæ•°æ®ç²¾åº¦ï¼Œä½ éœ€è¦æ£€æŸ¥<code>lossless</code>å˜é‡ã€‚å¦‚æœ<code>lossless</code>ä¸º<code>false</code>ï¼Œè¯´æ˜è½¬æ¢è¿‡ç¨‹ä¸­æŸå¤±äº†ç²¾åº¦ï¼Œè¿™é€šå¸¸å‘ç”Ÿåœ¨<code>BigInt</code>å€¼è¶…å‡ºäº†<code>uint64_t</code>èƒ½å¤Ÿè¡¨ç¤ºçš„èŒƒå›´çš„æƒ…å†µã€‚</p><h4 id="napi-get-value-bigint-words" tabindex="-1"><a class="header-anchor" href="#napi-get-value-bigint-words"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_value_bigint_words" target="_blank" rel="noopener noreferrer">napi_get_value_bigint_words</a></span></a></h4><p><code>napi_get_value_bigint_words</code> æ˜¯ Node.js ä¸­ N-APIï¼ˆåŸç”Ÿ APIï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒè®©ä½ å¯ä»¥ä» JavaScript çš„ <code>BigInt</code> ç±»å‹ä¸­æå–æ•°æ®å¹¶åœ¨ C æˆ–è€… C++ åŸç”Ÿæ¨¡å—ä¸­ä½¿ç”¨ã€‚<code>BigInt</code> æ˜¯ JavaScript ä¸­ä¸€ç§å¯ä»¥è¡¨ç¤ºä»»æ„å¤§æ•´æ•°çš„æ•°æ®ç±»å‹ã€‚</p><p>åœ¨ Node.js v21.7.1 çš„æ–‡æ¡£ä¸­ï¼Œ<code>napi_get_value_bigint_words</code> å‡½æ•°å…è®¸ä½ å°†ä¸€ä¸ª JavaScript çš„ <code>BigInt</code> å¯¹è±¡è½¬æ¢æˆç”±å¤šä¸ªæ•°å­—ç»„æˆçš„æ•°ç»„ï¼ˆé€šå¸¸æ˜¯ 64 ä½é•¿æ•´æ•°ï¼‰ï¼Œè¿™æ ·ä½ å°±å¯ä»¥åœ¨åŸç”Ÿä»£ç ä¸­å¤„ç†éå¸¸å¤§çš„æ•´æ•°ã€‚</p><p>ä¸‹é¢æˆ‘ä¼šè¯¦ç»†è§£é‡Šè¿™ä¸ªå‡½æ•°æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå¹¶ç»™å‡ºä¸€ä¸ªå®é™…åº”ç”¨çš„ä¾‹å­ã€‚</p><h3 id="å‡½æ•°å£°æ˜" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°å£°æ˜"><span>å‡½æ•°å£°æ˜</span></a></h3><p>è¿™ä¸ªå‡½æ•°åœ¨ C æˆ– C++ä»£ç ä¸­çš„å£°æ˜ç±»ä¼¼äºï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_get_value_bigint_words(</span></span>
<span class="line"><span>    napi_env env,</span></span>
<span class="line"><span>    napi_value value,</span></span>
<span class="line"><span>    int* sign_bit,</span></span>
<span class="line"><span>    size_t* word_count,</span></span>
<span class="line"><span>    uint64_t* words);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>: å½“å‰çš„ N-API ç¯å¢ƒï¼Œå®ƒä»£è¡¨äº† Node.js è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ã€‚</li><li><code>value</code>: ä¸€ä¸ª <code>napi_value</code> ç±»å‹çš„å˜é‡ï¼Œå®ƒåŒ…è£…äº†ä¸€ä¸ª JavaScript çš„ <code>BigInt</code> å¯¹è±¡ã€‚</li><li><code>sign_bit</code>: æŒ‡å‘ä¸€ä¸ª <code>int</code> çš„æŒ‡é’ˆï¼Œå‡½æ•°ä¼šè®¾ç½®è¯¥å€¼ä¸º 0 æˆ– 1 æ¥è¡¨ç¤º <code>BigInt</code> çš„æ­£è´Ÿã€‚</li><li><code>word_count</code>: ä¸€ä¸ªæŒ‡å‘ <code>size_t</code> çš„æŒ‡é’ˆï¼Œåœ¨è°ƒç”¨å‡½æ•°ä¹‹å‰ï¼Œä½ éœ€è¦è®¾ç½®å®ƒä¸º <code>words</code> æ•°ç»„å¯ä»¥å®¹çº³çš„å…ƒç´ æ•°é‡ã€‚è°ƒç”¨åï¼Œå®ƒä¼šè¢«è®¾ç½®ä¸ºå®é™…éœ€è¦çš„å…ƒç´ æ•°é‡ã€‚</li><li><code>words</code>: æŒ‡å‘ä¸€ä¸ª <code>uint64_t</code> æ•°ç»„çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæ•°ç»„ç”¨æ¥å­˜å‚¨å¤§æ•´æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºã€‚</li></ul><h3 id="ç¤ºä¾‹-2" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-2"><span>ç¤ºä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œéœ€è¦æ“ä½œä¸€ä¸ªéå¸¸å¤§çš„æ•´æ•°ã€‚ä¸‹é¢æ˜¯å¦‚ä½•åœ¨ä½ çš„ C/C++ ä»£ç ä¸­è°ƒç”¨ <code>napi_get_value_bigint_words</code> çš„ä¸€ä¸ªç®€å•ä¾‹å­ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ &#39;bigIntValue&#39; æ˜¯ä¸€ä¸ªåŒ…å«äº† BigInt çš„ napi_value</span></span>
<span class="line"><span>napi_value bigIntValue;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åœ¨å…¶ä»–åœ°æ–¹è·å–åˆ°è¿™ä¸ª bigIntValue ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡†å¤‡ç”¨äºæå– BigInt ä¿¡æ¯çš„å˜é‡</span></span>
<span class="line"><span>int signBit;</span></span>
<span class="line"><span>size_t wordCount = 2; // å‡è®¾æˆ‘ä»¬çŸ¥é“ BigInt ä¸ä¼šè¶…è¿‡ 128 ä½</span></span>
<span class="line"><span>uint64_t words[2]; // ç”¨äºå­˜å‚¨ BigInt äºŒè¿›åˆ¶è¡¨ç¤ºçš„æ•°ç»„</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è°ƒç”¨å‡½æ•°æå– BigInt</span></span>
<span class="line"><span>napi_status status = napi_get_value_bigint_words(env, bigIntValue, &amp;signBit, &amp;wordCount, words);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ£€æŸ¥å‡½æ•°è°ƒç”¨æ˜¯å¦æˆåŠŸ</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>  // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// &#39;signBit&#39; ç°åœ¨ä»£è¡¨äº† BigInt çš„ç¬¦å· (0 ä¸ºæ­£, 1 ä¸ºè´Ÿ)</span></span>
<span class="line"><span>// &#39;wordCount&#39; å·²ç»è¢«è®¾ç½®ä¸ºå®é™…éœ€è¦çš„å…ƒç´ æ•°é‡</span></span>
<span class="line"><span>// &#39;words&#39; æ•°ç»„ç°åœ¨åŒ…å«äº† BigInt çš„äºŒè¿›åˆ¶è¡¨ç¤º</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½¿ç”¨ <code>napi_get_value_bigint_words</code> å‡½æ•°ï¼Œä½ å¯ä»¥åœ¨ C/C++ ä»£ç ä¸­è·å–åˆ° JavaScript <code>BigInt</code> çš„ç²¾ç¡®è¡¨ç¤ºï¼Œç„¶åè¿›è¡Œå„ç§è®¡ç®—ï¼Œæ¯”å¦‚åŠ å¯†ç®—æ³•ã€å¤§æ•°è¿ç®—ç­‰å¯¹å¤§æ•´æ•°æœ‰ç‰¹æ®Šéœ€æ±‚çš„åœºåˆã€‚</p><p>æ€»ç»“èµ·æ¥ï¼Œ<code>napi_get_value_bigint_words</code> æ˜¯ Node.js åŸç”Ÿç¼–ç¨‹æ¥å£ä¸­ä¸å¤§æ•´æ•°äº’æ“ä½œçš„é‡è¦å·¥å…·ï¼Œå®ƒè®©åŸç”Ÿæ¨¡å—èƒ½å¤Ÿå¤„ç†é‚£äº›è¶…å‡ºæ ‡å‡† JavaScript æ•°å­—èŒƒå›´çš„æ•´æ•°ã€‚</p><h4 id="napi-get-value-external" tabindex="-1"><a class="header-anchor" href="#napi-get-value-external"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_value_external" target="_blank" rel="noopener noreferrer">napi_get_value_external</a></span></a></h4><p>Node.js ä¸­çš„ N-APIï¼ˆNode.js APIï¼‰æ˜¯ä¸€ä¸ª C è¯­è¨€çº§åˆ«çš„ APIï¼Œå®ƒå…è®¸æœ¬åœ°æ’ä»¶ï¼ˆé€šå¸¸ç”¨ C æˆ– C++ç¼–å†™ï¼‰ä¸ JavaScript ä»£ç è¿›è¡Œäº’æ“ä½œã€‚<code>napi_get_value_external</code>æ˜¯ N-API æä¾›çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè¢«ç”¨äºä»ä¸€ä¸ª JavaScript å€¼ä¸­æ£€ç´¢ä¸€ä¸ªåœ¨ C ç¯å¢ƒä¸‹åˆ›å»ºçš„å¤–éƒ¨æ•°æ®æŒ‡é’ˆã€‚</p><p>å½“ä½ åœ¨ JavaScript å’Œ C/C++æ··åˆç¼–ç¨‹æ—¶ï¼Œå¹¶ä¸”éœ€è¦åœ¨ä¸¤è€…ä¹‹é—´ä¼ é€’æ•°æ®ï¼Œå°¤å…¶æ˜¯ä¸èƒ½ç›´æ¥åœ¨ JavaScript ä¸­åˆ›å»ºçš„é JS ç±»å‹æ•°æ®æ—¶ï¼Œè¿™ä¸ªåŠŸèƒ½å°±æ˜¾å¾—ç‰¹åˆ«é‡è¦ã€‚<code>napi_get_value_external</code>å‡½æ•°å…è®¸ä½ åœ¨ JavaScript å±‚é¢ä¸ŠæŒæœ‰å¹¶æ“ä½œ C/C++å±‚é¢çš„æ•°æ®å¯¹è±¡ã€‚</p><p>ä¸‹é¢é€šè¿‡å‡ ä¸ªæ­¥éª¤æ¥è§£é‡Šå®ƒçš„å·¥ä½œåŸç†ï¼š</p><ol><li><p><strong>åœ¨ C/C++å±‚é¢åˆ›å»ºæ•°æ®</strong>ï¼šé¦–å…ˆï¼Œåœ¨ C/C++æ’ä»¶ä¸­åˆ›å»ºä¸€ä¸ªæ•°æ®å¯¹è±¡ã€‚è¿™å¯èƒ½æ˜¯ä»»ä½•ç±»å‹çš„æ•°æ®ï¼Œæ¯”å¦‚ä¸€ä¸ªè‡ªå®šä¹‰çš„ç»“æ„ä½“æˆ–è€…ç±»çš„å®ä¾‹ã€‚</p></li><li><p><strong>å°†æ•°æ®åŒ…è£…ä¸º<code>napi_value</code></strong>ï¼šä½¿ç”¨<code>napi_create_external</code>ç­‰å‡½æ•°å°†è¿™ä¸ª C/C++å±‚é¢çš„æ•°æ®è½¬æ¢æˆä¸€ä¸ªå¯ä»¥åœ¨ JavaScript ä¸­ä½¿ç”¨çš„<code>napi_value</code>ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºâ€œå°è£…â€ï¼ˆwrappingï¼‰ã€‚</p></li><li><p><strong>åœ¨ JavaScript ä¸­ä½¿ç”¨è¿™ä¸ªå€¼</strong>ï¼šä¸€æ—¦æ•°æ®è¢«å°è£…ä¸º<code>napi_value</code>ï¼Œå®ƒå°±å¯ä»¥ä½œä¸ºä¸€ä¸ª JS å˜é‡ä¼ é€’åˆ° JavaScript ä»£ç ä¸­ï¼Œå¹¶åœ¨é‚£é‡Œè¢«å½“åšä¸€ä¸ªâ€œå¤–éƒ¨â€ç±»å‹çš„å€¼ä½¿ç”¨ã€‚</p></li><li><p><strong>ä» JavaScript å€¼ä¸­æ£€ç´¢æ•°æ®</strong>ï¼šå½“ä½ æƒ³è¦åœ¨ C/C++ä»£ç ä¸­å†æ¬¡è·å–åŸå§‹æ•°æ®æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>napi_get_value_external</code>å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°å°†ä¼šä» JS å±‚é¢è¡¨ç¤ºå¤–éƒ¨æ•°æ®çš„<code>napi_value</code>ä¸­æå–å‡º C/C++å±‚é¢çš„æŒ‡é’ˆã€‚</p></li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä»¥å…·ä½“çš„ç¤ºä¾‹è¯´æ˜è¿™ä¸€è¿‡ç¨‹ï¼š</p><h3 id="ç¤ºä¾‹-c-c-ä¾§" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-c-c-ä¾§"><span>ç¤ºä¾‹ - C/C++ä¾§</span></a></h3><p>å‡è®¾ä½ æœ‰ä¸€ä¸ª C++ç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>class MyData {</span></span>
<span class="line"><span>public:</span></span>
<span class="line"><span>    int value;</span></span>
<span class="line"><span>    // æ„é€ å‡½æ•°</span></span>
<span class="line"><span>    MyData(int val) : value(val) {}</span></span>
<span class="line"><span>};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åä½ åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶å°†å®ƒå°è£…ä¸º<code>napi_value</code>ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>MyData* myData = new MyData(42);</span></span>
<span class="line"><span>napi_value externalValue;</span></span>
<span class="line"><span>// å‡è®¾ `env` æ˜¯å½“å‰çš„napiç¯å¢ƒï¼Œ`myData` æ˜¯æˆ‘ä»¬è¦å°è£…çš„æŒ‡é’ˆ</span></span>
<span class="line"><span>napi_create_external(env, (void*)myData, nullptr, nullptr, &amp;externalValue);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ç¤ºä¾‹-javascript-ä¾§" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-javascript-ä¾§"><span>ç¤ºä¾‹ - JavaScript ä¾§</span></a></h3><p>ç°åœ¨ï¼Œåœ¨ JavaScript ä»£ç ä¸­ï¼Œä½ å¯ä»¥è·å¾—è¿™ä¸ª<code>externalValue</code>ï¼Œå®ƒä»£è¡¨äº†ä¸€ä¸ªå¤–éƒ¨æ•°æ®ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// è¿™ä¸ªexternalValueæ˜¯é€šè¿‡æŸç§æœºåˆ¶ä»C++ä¼ é€’åˆ°JSçš„</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">externalValue</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¿™å°†ä¸ä¼šæ˜¾ç¤ºå®é™…æ•°æ®ï¼Œå› ä¸ºå®ƒæ˜¯å¤–éƒ¨çš„</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ç¤ºä¾‹-é‡æ–°è·å–-c-c-æ•°æ®" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-é‡æ–°è·å–-c-c-æ•°æ®"><span>ç¤ºä¾‹ - é‡æ–°è·å– C/C++æ•°æ®</span></a></h3><p>æœ€åï¼Œå¦‚æœä½ å¸Œæœ›åœ¨ C/C++æ’ä»¶ä¸­å†æ¬¡è®¿é—®è¿™ä¸ªæ•°æ®ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>napi_get_value_external</code>ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>void* data;</span></span>
<span class="line"><span>// å†æ¬¡å‡è®¾ `env` æ˜¯å½“å‰çš„napiç¯å¢ƒ</span></span>
<span class="line"><span>napi_get_value_external(env, externalValue, &amp;data);</span></span>
<span class="line"><span>MyData* originalData = static_cast`&lt;`MyData*&gt;(data); // ç°åœ¨ä½ åˆå¾—åˆ°äº†åŸå§‹çš„C++å¯¹è±¡æŒ‡é’ˆ</span></span>
<span class="line"><span>std::cout `&lt;``&lt;` &quot;The value is: &quot; `&lt;``&lt;` originalData-&gt;value `&lt;``&lt;` std::endl; // å°†è¾“å‡ºï¼šThe value is: 42</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡è¿™ä¸ªè¿‡ç¨‹ï¼Œä½ å¯ä»¥åœ¨ JavaScript ä»£ç å’Œ C/C++ä»£ç ä¹‹é—´å®‰å…¨åœ°ä¼ é€’å¤æ‚çš„æ•°æ®ç»“æ„ï¼Œå¹¶åœ¨éœ€è¦æ—¶å¯¹å…¶è¿›è¡Œæ“ä½œã€‚è¿™ä½¿å¾— Node.js èƒ½å¤Ÿé€šè¿‡æœ¬åœ°æ‰©å±•æ¥æ‰§è¡Œé«˜æ€§èƒ½æˆ–ä½çº§æ“ä½œï¼ŒåŒæ—¶ä¿æŒ JS å±‚é¢ä¸Šçš„ç®€ä»‹å’Œæ˜“ç”¨æ€§ã€‚</p><h4 id="napi-get-value-int32" tabindex="-1"><a class="header-anchor" href="#napi-get-value-int32"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_value_int32" target="_blank" rel="noopener noreferrer">napi_get_value_int32</a></span></a></h4><p>åœ¨ Node.js ä¸­ï¼ŒN-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ API å±‚ã€‚åŸç”Ÿæ’ä»¶æ˜¯ç”¨ C æˆ– C++ç¼–å†™çš„æ¨¡å—ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ Node.js å†…éƒ¨å’Œ V8ï¼ˆJavaScript å¼•æ“ï¼‰çš„åŠŸèƒ½ã€‚N-API çš„ç›®çš„æ˜¯å‡å°‘åŸç”Ÿæ’ä»¶ä¸ Node.js ç‰ˆæœ¬ä¹‹é—´çš„å…¼å®¹æ€§é—®é¢˜ï¼Œå¹¶ç®€åŒ–åŸç”Ÿæ¨¡å—çš„ç¼–å†™ã€‚</p><p><code>napi_get_value_int32</code>å‡½æ•°å°±æ˜¯ N-API æä¾›çš„ä¸€ç§åŠŸèƒ½ï¼Œå…¶ä½œç”¨æ˜¯ä»ä¸€ä¸ª N-API çš„<code>napi_value</code>ç±»å‹ä¸­æå–å‡ºä¸€ä¸ª 32 ä½æ•´æ•°ï¼ˆå³ C è¯­è¨€ä¸­çš„<code>int32_t</code>ç±»å‹ï¼‰ã€‚<code>napi_value</code>æ˜¯è¡¨ç¤º JavaScript å€¼çš„ N-API ç»“æ„ä½“ï¼Œåœ¨æœ¬åœ°ä»£ç ä¸­ä¸èƒ½ç›´æ¥æ“ä½œ JavaScript å€¼ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡è¿™ç±»å‡½æ•°æ¥è¿›è¡Œè½¬æ¢ã€‚</p><h3 id="ä½¿ç”¨åœºæ™¯-1" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯-1"><span>ä½¿ç”¨åœºæ™¯</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åŸç”Ÿæ’ä»¶ï¼Œä½ æƒ³è¦åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ª JavaScript æ•°å­—å¹¶å°†å…¶ç¿»å€ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä½ éœ€è¦ä» JavaScript ä¼ å…¥çš„å‚æ•°ä¸­è·å–å®é™…çš„æ•°å­—å€¼ï¼Œå¹¶åœ¨ C/C++ä»£ç ä¸­ä½¿ç”¨è¿™ä¸ªå€¼ã€‚</p><h3 id="å‡½æ•°åŸå‹-1" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°åŸå‹-1"><span>å‡½æ•°åŸå‹</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_get_value_int32(napi_env env,</span></span>
<span class="line"><span>                                 napi_value value,</span></span>
<span class="line"><span>                                 int32_t* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>napi_env env</code>: å½“å‰ç¯å¢ƒçš„å¥æŸ„ï¼Œä»£è¡¨äº†å½“å‰çš„ Node.js ç¯å¢ƒã€‚</li><li><code>napi_value value</code>: ä½ æƒ³è¦è½¬æ¢çš„ JavaScript å€¼ã€‚</li><li><code>int32_t* result</code>: è¿™æ˜¯ç»“æœå‚æ•°çš„æŒ‡é’ˆï¼Œåœ¨å‡½æ•°æ‰§è¡Œåï¼Œæ•´æ•°å€¼ä¼šè¢«å­˜å‚¨åœ¨è¿™é‡Œã€‚</li></ul><h3 id="è¿”å›å€¼-3" tabindex="-1"><a class="header-anchor" href="#è¿”å›å€¼-3"><span>è¿”å›å€¼</span></a></h3><p>è¯¥å‡½æ•°è¿”å›<code>napi_status</code>æšä¸¾å€¼ï¼Œå‘Šè¯‰æˆ‘ä»¬å‡½æ•°è°ƒç”¨æ˜¯å¦æˆåŠŸã€‚å¦‚æœè¿”å›å€¼ä¸æ˜¯<code>napi_ok</code>ï¼Œåˆ™æ„å‘³ç€æœ‰é”™è¯¯å‘ç”Ÿã€‚</p><h3 id="å®ä¾‹ä»£ç " tabindex="-1"><a class="header-anchor" href="#å®ä¾‹ä»£ç "><span>å®ä¾‹ä»£ç </span></a></h3><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ä¸€ä¸ª Native æ’ä»¶çš„å‡½æ•°ä¸­ä½¿ç”¨<code>napi_get_value_int32</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åŸç”Ÿå‡½æ•°ï¼Œå°†è¾“å…¥çš„JavaScriptæ•´æ•°ç¿»å€</span></span>
<span class="line"><span>napi_value DoubleInt(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    int32_t number;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–JavaScriptä¼ é€’çš„å‚æ•°</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // é”™è¯¯å¤„ç†</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†ç¬¬ä¸€ä¸ªå‚æ•°è½¬æ¢ä¸ºint32</span></span>
<span class="line"><span>    status = napi_get_value_int32(env, args[0], &amp;number);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // é”™è¯¯å¤„ç†</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è®¡ç®—ç¿»å€åçš„å€¼</span></span>
<span class="line"><span>    int32_t doubledNumber = number * 2;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›ç»“æœç»™JavaScript</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    status = napi_create_int32(env, doubledNumber, &amp;result);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // é”™è¯¯å¤„ç†</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œæ³¨å†ŒDoubleIntåˆ°exportså¯¹è±¡</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°</span></span>
<span class="line"><span>    status = napi_create_function(env, NULL, 0, DoubleInt, NULL, &amp;fn);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // é”™è¯¯å¤„ç†</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è®¾ç½®å¯¼å‡ºçš„å±æ€§</span></span>
<span class="line"><span>    status = napi_set_named_property(env, exports, &quot;doubleInt&quot;, fn);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // é”™è¯¯å¤„ç†</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º<code>DoubleInt</code>çš„å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ª JavaScript ä¼ çš„æ•´æ•°å‚æ•°ï¼Œå°†å…¶ç¿»å€ï¼Œå¹¶è¿”å›ç»“æœã€‚<code>napi_get_value_int32</code>å°±æ˜¯ç”¨äºè·å–ä¼ å…¥å‚æ•°å¹¶å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªæœ¬åœ°çš„<code>int32_t</code>ç±»å‹çš„æ•´æ•°å€¼ã€‚</p><p>å¼€å‘è€…éœ€è¦æ˜ç™½çš„æ˜¯ï¼Œå½“ä½¿ç”¨ N-API ç¼–å†™åŸç”Ÿæ’ä»¶æ—¶ï¼Œä»–ä»¬é€šå¸¸éœ€è¦å¤„ç†ç±»å‹è½¬æ¢ï¼Œå› ä¸º JavaScript ä¸­çš„æ•°æ®ç±»å‹å’Œ C/C++ä¸­çš„æ•°æ®ç±»å‹æ˜¯ä¸åŒçš„ã€‚è€Œ<code>napi_get_value_int32</code>æ­£æ˜¯å¸®åŠ©æˆ‘ä»¬è¿›è¡Œè¿™ç§ç±»å‹è½¬æ¢çš„å·¥å…·ä¹‹ä¸€ã€‚</p><h4 id="napi-get-value-int64" tabindex="-1"><a class="header-anchor" href="#napi-get-value-int64"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_value_int64" target="_blank" rel="noopener noreferrer">napi_get_value_int64</a></span></a></h4><p>å½“ç„¶ï¼Œæˆ‘ä¼šå°½åŠ›è§£é‡Šå¾—é€šä¿—æ˜“æ‡‚ã€‚</p><h3 id="node-js-ä¸­çš„-napi-get-value-int64" tabindex="-1"><a class="header-anchor" href="#node-js-ä¸­çš„-napi-get-value-int64"><span>Node.js ä¸­çš„ <code>napi_get_value_int64</code></span></a></h3><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 JavaScript å¼•æ“çš„ JavaScript è¿è¡Œæ—¶ã€‚å®ƒå…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚Node.js æä¾›äº†ä¸€å¥—ä¸°å¯Œçš„ API æ¥ä¸æ“ä½œç³»ç»Ÿäº¤äº’ï¼Œè¿™äº› API é›†åˆç§°ä¸º N-APIã€‚N-API æ˜¯ Node.js çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå…è®¸ä½ ç”¨ C æˆ– C++ ç¼–å†™æ‰©å±•æ¨¡å—ã€‚è¿™äº›æ‰©å±•æ¨¡å—å¯ä»¥ç›´æ¥è°ƒç”¨ Node.js æä¾›çš„å„ç§åº•å±‚ APIï¼Œä»¥æ­¤æ¥åˆ›å»ºé«˜æ€§èƒ½çš„åº”ç”¨ç¨‹åºã€‚</p><h4 id="napi-get-value-int64-æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#napi-get-value-int64-æ˜¯ä»€ä¹ˆ"><span><code>napi_get_value_int64</code> æ˜¯ä»€ä¹ˆï¼Ÿ</span></a></h4><p><code>napi_get_value_int64</code> æ˜¯ Node.js æä¾›çš„ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå…è®¸ä½ å°†ä¸€ä¸ª JavaScript æ•°å€¼ï¼ˆNumberï¼‰è½¬æ¢æˆä¸€ä¸ª C è¯­è¨€ä¸­çš„ <code>int64_t</code> ç±»å‹ã€‚<code>int64_t</code> æ˜¯ä¸€ä¸ªè¡¨ç¤º 64 ä½æ•´æ•°çš„æ•°æ®ç±»å‹ï¼Œåœ¨ C/C++ ä¸­å°±ç›¸å½“äºé•¿æ•´å‹ï¼ˆlong integerï¼‰ï¼Œå®ƒèƒ½å¤Ÿå­˜å‚¨éå¸¸å¤§æˆ–éå¸¸å°çš„æ•´æ•°å€¼ã€‚</p><h4 id="napi-get-value-int64-ä½¿ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#napi-get-value-int64-ä½¿ç”¨åœºæ™¯"><span><code>napi_get_value_int64</code> ä½¿ç”¨åœºæ™¯ï¼š</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js æ‰©å±•ï¼Œéœ€è¦å¤„ç†æ¥è‡ª JavaScript ç«¯çš„å¤§æ•´æ•°ï¼Œå¹¶ä¸”è¦åœ¨ C/C++ æ’ä»¶ä¸­è¿›è¡Œä¸€äº›å¤æ‚çš„è®¡ç®—æˆ–è€…ç³»ç»Ÿè°ƒç”¨ï¼Œé‚£ä¹ˆä½ å¯èƒ½å°±éœ€è¦ä½¿ç”¨ <code>napi_get_value_int64</code> å‡½æ•°ã€‚</p><h4 id="ç¤ºä¾‹ä»£ç " tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹ä»£ç "><span>ç¤ºä¾‹ä»£ç ï¼š</span></a></h4><p>å‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ª JavaScript ä¸­çš„æ•°å­—ï¼Œæˆ‘ä»¬è¦åœ¨æ‰©å±•æ¨¡å—ä¸­å¤„ç†å®ƒã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­ï¼š</p><p>JavaScript ç«¯è°ƒç”¨æ‰©å±•æ¨¡å—çš„ç¤ºä¾‹ä»£ç ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> myExtension</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my-native-extension</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> bigNumber</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 1234567890123456789</span><span style="color:#81A1C1;">n;</span><span style="color:#616E88;"> // å‡è®¾è¿™æ˜¯ä¸€ä¸ªå¤§æ•´æ•°</span></span>
<span class="line"><span style="color:#D8DEE9;">myExtension</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">processLargeNumber</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">bigNumber</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>C/C++ æ‰©å±•æ¨¡å—ä¸­çš„ç›¸å…³éƒ¨åˆ†ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°å°±æ˜¯è¢« JavaScript è°ƒç”¨çš„</span></span>
<span class="line"><span>napi_value ProcessLargeNumber(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å– JavaScript è°ƒç”¨ä¼ é€’çš„å‚æ•°</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    int64_t number;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°† JavaScript çš„ Number è½¬æ¢ä¸º C çš„ int64_t</span></span>
<span class="line"><span>    status = napi_get_value_int64(env, args[0], &amp;number);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ª C è¯­è¨€ä¸­çš„ int64_t ç±»å‹çš„æ•´æ•°ï¼Œå¯ä»¥è¿›è¡Œå¤„ç†äº†</span></span>
<span class="line"><span>    // ... åšä¸€äº›å¤„ç†ï¼Œä¾‹å¦‚ï¼š</span></span>
<span class="line"><span>    printf(&quot;Received number from JS: %lld\n&quot;, number);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›å¤„ç†ç»“æœç»™ JavaScript</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å’Œæ³¨å†Œ ProcessLargeNumber å‡½æ•°</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, ProcessLargeNumber, NULL, &amp;fn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;processLargeNumber&quot;, fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º <code>ProcessLargeNumber</code> çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä» JavaScript ç«¯æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œå¹¶ä½¿ç”¨ <code>napi_get_value_int64</code> è½¬æ¢è¯¥å‚æ•°ä¸º <code>int64_t</code> ç±»å‹çš„å˜é‡ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ C/C++ ä»£ç ä¸­å¤„ç†è¿™ä¸ªå¤§æ•´æ•°ã€‚</p><p>è¯·è®°ä½ï¼Œè¿™åªæ˜¯ä¸€ä¸ªéå¸¸ç®€åŒ–çš„ä¾‹å­ï¼Œå®é™…ç¼–å†™ Node.js çš„ C/C++ æ‰©å±•æ¶‰åŠå¾ˆå¤šå…¶ä»–çš„æ³¨æ„äº‹é¡¹å’Œæ­¥éª¤ã€‚ä¸è¿‡ï¼Œå¸Œæœ›è¿™ä¸ªä¾‹å­èƒ½å¤Ÿå¸®åŠ©ä½ ç†è§£ <code>napi_get_value_int64</code> åœ¨ Node.js æ‰©å±•ä¸­çš„åº”ç”¨ã€‚</p><h4 id="napi-get-value-string-latin1" tabindex="-1"><a class="header-anchor" href="#napi-get-value-string-latin1"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_value_string_latin1" target="_blank" rel="noopener noreferrer">napi_get_value_string_latin1</a></span></a></h4><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒã€‚å®ƒå…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚Node.js æä¾›äº†ä¸€ç»„æ ¸å¿ƒçš„åº“ï¼Œç”¨äºå¤„ç†æ–‡ä»¶ã€ç½‘ç»œé€šä¿¡ç­‰åŠŸèƒ½ã€‚</p><p>N-APIï¼ˆNode.js APIï¼‰æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç¨³å®šä¸”ç‹¬ç«‹äº JavaScript è¿è¡Œæ—¶çš„ C API å±‚ï¼Œå®ƒç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶ã€‚åŸç”Ÿæ’ä»¶æ˜¯ç”¨ C æˆ– C++ å†™çš„æ¨¡å—ï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥ä¸ Node.js çš„åº•å±‚ API äº¤äº’ï¼Œæä¾›æ¯”æ™®é€š JavaScript æ›´æ¥è¿‘ç³»ç»Ÿåº•å±‚çš„æ€§èƒ½å’ŒåŠŸèƒ½ã€‚</p><p><code>napi_get_value_string_latin1</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒç”¨äºå°† JavaScript å­—ç¬¦ä¸²è½¬æ¢æˆä¸€ä¸ªä»¥ Latin-1 ç¼–ç ï¼ˆä¹Ÿç§°ä¸º ISO-8859-1ï¼‰çš„ C å­—ç¬¦ä¸²ã€‚Latin-1 ç¼–ç æ˜¯ä¸€ç§å•å­—èŠ‚ç¼–ç æ–¹æ¡ˆï¼Œèƒ½å¤Ÿè¡¨ç¤º Western Europeanï¼ˆè¥¿æ¬§ï¼‰è¯­è¨€ä¸­çš„å­—ç¬¦ã€‚</p><p>å½“ä½ æœ‰ä¸€ä¸ª JavaScript å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”éœ€è¦åœ¨åŸç”Ÿæ’ä»¶ä¸­ä½¿ç”¨è¿™ä¸ªå­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œä½ å¯èƒ½ä¼šä½¿ç”¨ <code>napi_get_value_string_latin1</code> å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ä¼šæŠŠ JavaScript å­—ç¬¦ä¸²å†…çš„å­—ç¬¦æŒ‰ç…§ Latin-1 ç¼–ç å¤åˆ¶åˆ°ä¸€ä¸ªç”±ä½ åˆ†é…çš„ç¼“å†²åŒºï¼ˆbufferï¼‰ä¸­ã€‚</p><p>ä¸¾ä¾‹æ¥è¯´ï¼š</p><p>å‡è®¾ä½ åœ¨ Node.js ä¸­åˆ›å»ºäº†ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œå®ƒéœ€è¦ä» JavaScript æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°å¹¶ä»¥æŸç§æ–¹å¼å¤„ç†è¿™ä¸ªå­—ç¬¦ä¸²ã€‚åœ¨ C/C++ çš„åŸç”Ÿæ’ä»¶ä»£ç ä¸­ï¼Œä½ å¯èƒ½ä¼šè¿™æ ·ä½¿ç”¨ <code>napi_get_value_string_latin1</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... å…¶ä»–å¿…è¦çš„å¤´æ–‡ä»¶å’Œä»£ç  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯ä¸€ä¸ªè¢«æš´éœ²ç»™ JavaScript çš„å‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°</span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value argv[1];</span></span>
<span class="line"><span>    napi_value thisArg;</span></span>
<span class="line"><span>    void* data;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–å‡½æ•°å‚æ•°</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, argv, &amp;thisArg, &amp;data);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç¡®ä¿æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªå­—ç¬¦ä¸²</span></span>
<span class="line"><span>    napi_valuetype valuetype;</span></span>
<span class="line"><span>    napi_typeof(env, argv[0], &amp;valuetype);</span></span>
<span class="line"><span>    if (valuetype != napi_string) {</span></span>
<span class="line"><span>        napi_throw_type_error(env, NULL, &quot;Argument must be a string.&quot;);</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // é¢„å…ˆè·å–å­—ç¬¦ä¸²é•¿åº¦</span></span>
<span class="line"><span>    size_t str_length;</span></span>
<span class="line"><span>    napi_get_value_string_latin1(env, argv[0], NULL, 0, &amp;str_length);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ†é…è¶³å¤Ÿå¤§å°çš„ç¼“å†²åŒºæ¥å­˜å‚¨ Latin-1 å­—ç¬¦ä¸²</span></span>
<span class="line"><span>    char* c_str = (char*) malloc((str_length + 1) * sizeof(char));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°† JavaScript å­—ç¬¦ä¸²å¤åˆ¶åˆ°ç¼“å†²åŒº</span></span>
<span class="line"><span>    napi_get_value_string_latin1(env, argv[0], c_str, str_length + 1, &amp;str_length);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // c_str åŒ…å«äº†è½¬æ¢åçš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥è¿›è¡Œå¤„ç†</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¤„ç†å®Œæˆåè®°å¾—é‡Šæ”¾åˆ†é…çš„å†…å­˜</span></span>
<span class="line"><span>    free(c_str);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›ç»“æœæˆ–è€… undefined...</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    napi_get_undefined(env, &amp;result);</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... æ³¨å†Œ MyFunction ä½¿å…¶èƒ½å¤Ÿåœ¨ JavaScript ä¸­è°ƒç”¨ ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>MyFunction</code> æ˜¯ä¸€ä¸ªåŸç”Ÿå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ã€‚åœ¨å‡½æ•°å†…éƒ¨ï¼Œå®ƒå…ˆæ£€æŸ¥ç¡®ä¿ä¼ å…¥çš„å‚æ•°ç¡®å®æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç„¶åè®¡ç®—è¿™ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œä¹‹åä¸ºè¿™ä¸ªå­—ç¬¦ä¸²åˆ†é…è¶³å¤Ÿçš„å†…å­˜ï¼Œå¹¶ä½¿ç”¨ <code>napi_get_value_string_latin1</code> å‡½æ•°å°† JavaScript å­—ç¬¦ä¸²çš„å€¼å¤åˆ¶åˆ°åˆ†é…çš„å†…å­˜ä¸­ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨åŸç”Ÿä»£ç ä¸­æ“ä½œè¿™ä¸ªå­—ç¬¦ä¸²äº†ã€‚</p><p>è¯·æ³¨æ„ï¼Œå› ä¸º Latin-1 åªèƒ½è¡¨ç¤ºèŒƒå›´æœ‰é™çš„å­—ç¬¦ï¼Œå¦‚æœä½ çš„ JavaScript å­—ç¬¦ä¸²åŒ…å«ä¸èƒ½ç”¨ Latin-1 ç¼–ç è¡¨ç¤ºçš„å­—ç¬¦ï¼Œé‚£ä¹ˆè¿™äº›å­—ç¬¦å°†è¢«æ›¿æ¢ä¸ºä¸€ä¸ªç‰¹æ®Šçš„æ›¿æ¢å­—ç¬¦ï¼Œé€šå¸¸æ˜¯ <code>?</code>ã€‚å› æ­¤ï¼Œåœ¨å¤„ç†å¤šç§å­—ç¬¦é›†æˆ–è€…éœ€è¦ Unicode æ”¯æŒçš„åº”ç”¨ç¨‹åºä¸­ï¼Œä½ å¯èƒ½éœ€è¦ä½¿ç”¨å…¶ä»–å‡½æ•°æ¥è·å– UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ã€‚</p><h4 id="napi-get-value-string-utf8" tabindex="-1"><a class="header-anchor" href="#napi-get-value-string-utf8"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_value_string_utf8" target="_blank" rel="noopener noreferrer">napi_get_value_string_utf8</a></span></a></h4><p>å¥½çš„ï¼ŒNode.js ä¸­ <code>napi_get_value_string_utf8</code> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå±äº Node.js çš„ N-APIï¼ˆåŸç”Ÿ APIï¼‰åº“ã€‚N-API æä¾›äº†ä¸€ç»„ç”¨ C è¯­è¨€å†™çš„æ¥å£ï¼Œå…è®¸ä½ åˆ›å»ºå¯ä»¥ç›´æ¥ä¸ JavaScript äº¤äº’çš„æœ¬åœ°æ’ä»¶ï¼ˆnative addonsï¼‰ã€‚</p><p>åœ¨è§£é‡Š <code>napi_get_value_string_utf8</code> ä¹‹å‰ï¼Œæœ‰å¿…è¦äº†è§£ä»¥ä¸‹å‡ ä¸ªæ¦‚å¿µï¼š</p><ol><li><strong>Native Addons</strong>: è¿™æ˜¯æŒ‡ä½¿ç”¨ C æˆ– C++ç­‰è¯­è¨€ç¼–å†™çš„æ¨¡å—ï¼Œå®ƒä»¬å¯ä»¥è¢« Node.js åŠ è½½ï¼Œå¹¶æä¾›æ¯” JavaScript æ›´é«˜æ€§èƒ½çš„æ“ä½œã€‚</li><li><strong>N-API</strong>: æ˜¯ä¸€ç§ç¨³å®šçš„ Node.js API å±‚ï¼Œä½¿å¾—åŸç”Ÿæ¨¡å—ï¼ˆnative addonsï¼‰éš”ç¦»äºåº•å±‚çš„ V8 å¼•æ“ï¼Œè¿™æ ·å³ä½¿ V8 æœ‰æ›´æ–°ï¼ŒåŸç”Ÿæ¨¡å—ä¹Ÿä¸éœ€è¦é‡æ–°ç¼–è¯‘ã€‚</li><li><strong>JavaScript Values and N-API</strong>: åœ¨ä½¿ç”¨ N-API å·¥ä½œæ—¶ï¼Œä½ é€šå¸¸éœ€è¦å¤„ç†ä» JavaScript ä¼ é€’åˆ° C å±‚çš„å€¼ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²ã€æ•°å­—ç­‰ã€‚</li></ol><p>ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹ <code>napi_get_value_string_utf8</code> å‡½æ•°ï¼š</p><h3 id="napi-get-value-string-utf8-1" tabindex="-1"><a class="header-anchor" href="#napi-get-value-string-utf8-1"><span>napi_get_value_string_utf8</span></a></h3><p><strong>åŠŸèƒ½</strong>ï¼šè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å°†ä¸€ä¸ª N-API ç±»å‹çš„å­—ç¬¦ä¸²ï¼ˆ<code>napi_value</code>ï¼‰ï¼Œè½¬æ¢æˆ UTF-8 ç¼–ç çš„ C å­—ç¬¦ä¸²ã€‚</p><p><strong>å‚æ•°</strong>ï¼š</p><ul><li><code>env</code>: ä»£è¡¨ N-API ç¯å¢ƒçš„å¥æŸ„ï¼Œå®ƒæ˜¯æ¯æ¬¡è°ƒç”¨ N-API å‡½æ•°æ—¶å¿…é¡»æä¾›çš„ã€‚</li><li><code>value</code>: è¦è¯»å–çš„ N-API å­—ç¬¦ä¸²ç±»å‹çš„å€¼ã€‚</li><li><code>buf</code>: æŒ‡å‘é¢„å…ˆåˆ†é…çš„ç¼“å†²åŒºçš„æŒ‡é’ˆï¼Œç”¨æ¥å­˜æ”¾ UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ã€‚</li><li><code>bufsize</code>: ç¼“å†²åŒºçš„å¤§å°ï¼ˆå­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</li><li><code>result</code>: å®é™…å¤åˆ¶åˆ°ç¼“å†²åŒºçš„å­—èŠ‚æ•°ã€‚</li></ul><p><strong>è¿”å›å€¼</strong>ï¼šå¦‚æœå‡½æ•°æˆåŠŸæ‰§è¡Œï¼Œåˆ™è¿”å› <code>napi_ok</code>ï¼Œå¦åˆ™è¿”å›é”™è¯¯ç ã€‚</p><h3 id="ä¾‹å­-1" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1"><span>ä¾‹å­</span></a></h3><p>å‡è®¾ä½ åœ¨ JavaScript ä¸­æœ‰ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½ æƒ³åœ¨ C å±‚å¤„ç†è¿™ä¸ªå­—ç¬¦ä¸²ã€‚é¦–å…ˆä½ éœ€è¦åˆ›å»ºä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œç„¶ååœ¨è¿™ä¸ªæ¨¡å—é‡Œä½¿ç”¨ <code>napi_get_value_string_utf8</code> æ¥è·å– UTF-8 ç¼–ç çš„ C å­—ç¬¦ä¸²ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ä½ å·²ç»å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°è¦ä»JSä¸­è·å–å­—ç¬¦ä¸²</span></span>
<span class="line"><span>napi_value GetStringFromJS(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–å‚æ•°æ•°é‡å’Œå‚æ•°æ•°ç»„</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value argv[1];</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, argv, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç¡®ä¿è·å–çŠ¶æ€æ­£ç¡®å¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªå‚æ•°</span></span>
<span class="line"><span>    if (status != napi_ok || argc `&lt;` 1) {</span></span>
<span class="line"><span>        // é”™è¯¯å¤„ç†...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–å­—ç¬¦ä¸²é•¿åº¦</span></span>
<span class="line"><span>    size_t str_length;</span></span>
<span class="line"><span>    status = napi_get_value_string_utf8(env, argv[0], NULL, 0, &amp;str_length);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // é”™è¯¯å¤„ç†...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ†é…å†…å­˜æ¥å­˜å‚¨å­—ç¬¦ä¸²</span></span>
<span class="line"><span>    char* buf = (char*)malloc(str_length + 1); // åŠ 1ä¸ºäº†null-terminator</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    size_t copied_length;</span></span>
<span class="line"><span>    status = napi_get_value_string_utf8(env, argv[0], buf, str_length + 1, &amp;copied_length);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        free(buf);</span></span>
<span class="line"><span>        // é”™è¯¯å¤„ç†...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ­¤æ—¶bufä¸­æœ‰äº†ä»JSä¼ é€’è¿‡æ¥çš„å­—ç¬¦ä¸²å†…å®¹</span></span>
<span class="line"><span>    // å¯ä»¥ç»§ç»­è¿›è¡Œå…¶ä»–æ“ä½œ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æœ€ååˆ«å¿˜è®°é‡Šæ”¾åˆ†é…çš„å†…å­˜</span></span>
<span class="line"><span>    free(buf);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›ä¸€ä¸ªundefinedç±»å‹çš„å€¼åˆ°JS</span></span>
<span class="line"><span>    napi_value undefined;</span></span>
<span class="line"><span>    napi_get_undefined(env, &amp;undefined);</span></span>
<span class="line"><span>    return undefined;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æ­¤ä¾‹ä¸­ï¼Œé¦–å…ˆç¡®å®šäº†ä¼ å…¥çš„å‚æ•°æ•°é‡å’Œç±»å‹ï¼Œç„¶åé€šè¿‡ <code>napi_get_value_string_utf8</code> å‡½æ•°è·å–äº†ä¸€ä¸ª JavaScript å­—ç¬¦ä¸²çš„ UTF-8 è¡¨ç¤ºå½¢å¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸ºäº†è·å¾—å­—ç¬¦ä¸²å®é™…å­—ç¬¦æ•°ï¼Œé¦–å…ˆè°ƒç”¨äº†ä¸€æ¬¡è¯¥å‡½æ•°å¹¶ä¼ é€’ NULL ä½œä¸ºç¼“å†²åŒºï¼Œè¿™æ ·å°±å¯ä»¥å¾—åˆ°å­—ç¬¦ä¸²é•¿åº¦ï¼Œç„¶åå†è¿›è¡Œå®é™…çš„å†…å­˜åˆ†é…ã€‚</p><p>è¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨äºå½“ä½ ç¼–å†™åŸç”Ÿæ¨¡å—éœ€è¦å¤„ç† JavaScript å±‚ä¼ é€’çš„å­—ç¬¦ä¸²æ•°æ®æ—¶ã€‚é€šè¿‡è½¬æ¢æˆ C å­—ç¬¦ä¸²ï¼Œä½ å°±å¯ä»¥åº”ç”¨å„ç§ C è¯­è¨€çš„æ“ä½œæ¥å¤„ç†è¿™äº›æ•°æ®ã€‚</p><h4 id="napi-get-value-string-utf16" tabindex="-1"><a class="header-anchor" href="#napi-get-value-string-utf16"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_value_string_utf16" target="_blank" rel="noopener noreferrer">napi_get_value_string_utf16</a></span></a></h4><p>Node.js ä¸­çš„ <code>napi_get_value_string_utf16</code> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå±äº Node.js çš„ N-APIï¼ˆåŸç”Ÿ APIï¼‰ã€‚N-API æä¾›äº†ä¸€ç»„åº•å±‚çš„ APIï¼Œä½¿å¾— C/C++çš„æ’ä»¶æ¨¡å—ç¼–å†™è€…å¯ä»¥ä¸ç”¨å…³å¿ƒå…·ä½“çš„ V8 æˆ– Chakra å¼•æ“çš„ç‰ˆæœ¬å·®å¼‚ï¼Œç¼–å†™å‡ºå…¼å®¹æ€§æ›´å¼ºã€ç¨³å®šæ€§æ›´é«˜çš„åŸç”Ÿæ¨¡å—ã€‚</p><p><code>napi_get_value_string_utf16</code> å‡½æ•°çš„ä½œç”¨æ˜¯å°†ä¸€ä¸ª JavaScript å­—ç¬¦ä¸²è½¬æ¢ä¸º UTF-16 ç¼–ç çš„å­—ç¬¦æ•°ç»„ã€‚UTF-16 æ˜¯ä¸€ç§å­—ç¬¦ç¼–ç æ–¹å¼ï¼Œå®ƒå¯ä»¥ç”¨æ¥è¡¨ç¤ºä¸–ç•Œä¸Šå¤§éƒ¨åˆ†çš„ä¹¦é¢è¯­è¨€ã€‚</p><p>åœ¨ Node.js çš„åŸç”Ÿæ¨¡å—ä¸­ä½¿ç”¨æ­¤å‡½æ•°é€šå¸¸éœ€è¦å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li>æ¥æ”¶ä¸€ä¸ªä» JavaScript ä¼ é€’è¿‡æ¥çš„å­—ç¬¦ä¸²å‚æ•°ã€‚</li><li>ä½¿ç”¨ <code>napi_get_value_string_utf16</code> å‡½æ•°å°†è¿™ä¸ªå­—ç¬¦ä¸²å‚æ•°è½¬æ¢æˆ C/C++ ä¸­çš„ UTF-16 ç¼–ç çš„å­—ç¬¦æ•°ç»„ã€‚</li><li>åœ¨ C/C++ ä»£ç ä¸­å¤„ç†è¿™ä¸ªå­—ç¬¦æ•°ç»„ã€‚</li><li>å¯èƒ½è¿˜éœ€è¦å°†å¤„ç†åçš„ç»“æœè¿”å›ç»™ JavaScriptã€‚</li></ol><p>ä¸‹é¢æˆ‘ä¼šé€šè¿‡ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥è§£é‡Šå¦‚ä½•ä½¿ç”¨ <code>napi_get_value_string_utf16</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™ä¸ªå‡½æ•°æ˜¯ä» JavaScript è°ƒç”¨çš„åŸç”Ÿå‡½æ•°</span></span>
<span class="line"><span>napi_value MyNativeFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–ä» JavaScript ä¼ é€’è¿‡æ¥çš„å‚æ•°</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦æœ‰ä¸€ä¸ªå‚æ•°ï¼Œå¹¶ä¸”å‚æ•°æ˜¯å­—ç¬¦ä¸²</span></span>
<span class="line"><span>    if (status == napi_ok &amp;&amp; argc == 1) {</span></span>
<span class="line"><span>        napi_valuetype valuetype;</span></span>
<span class="line"><span>        napi_typeof(env, args[0], &amp;valuetype);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        if (valuetype == napi_string) {</span></span>
<span class="line"><span>            // é¦–å…ˆè·å–å­—ç¬¦ä¸²çš„é•¿åº¦</span></span>
<span class="line"><span>            size_t str_length;</span></span>
<span class="line"><span>            status = napi_get_value_string_utf16(env, args[0], NULL, 0, &amp;str_length);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            if (status == napi_ok) {</span></span>
<span class="line"><span>                // åˆ†é…è¶³å¤Ÿçš„ç©ºé—´ä¿å­˜ UTF-16 å­—ç¬¦ä¸²</span></span>
<span class="line"><span>                u_char16_t* buf = new u_char16_t[str_length + 1];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                // å°† JavaScript å­—ç¬¦ä¸²è½¬æ¢ä¸º UTF-16 ç¼–ç çš„å­—ç¬¦æ•°ç»„</span></span>
<span class="line"><span>                size_t copied;</span></span>
<span class="line"><span>                status = napi_get_value_string_utf16(env, args[0], buf, str_length + 1, &amp;copied);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                if (status == napi_ok) {</span></span>
<span class="line"><span>                    // è¿™é‡Œå¯ä»¥å¯¹ buf ä¸­çš„ UTF-16 ç¼–ç çš„å­—ç¬¦æ•°ç»„è¿›è¡Œå¤„ç†</span></span>
<span class="line"><span>                    // ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                    // å¤„ç†å®Œæ¯•åè¦é‡Šæ”¾ä¹‹å‰åˆ†é…çš„å†…å­˜</span></span>
<span class="line"><span>                    delete[] buf;</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å› undefined</span></span>
<span class="line"><span>    napi_value undef;</span></span>
<span class="line"><span>    napi_get_undefined(env, &amp;undef);</span></span>
<span class="line"><span>    return undef;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void Initialize(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_value my_function;</span></span>
<span class="line"><span>    // ... åˆ›å»ºå’Œå¯¼å‡º MyNativeFunction å‡½æ•° ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Initialize)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>MyNativeFunction</code> æ˜¯ä¸€ä¸ªåŸç”Ÿå‡½æ•°ï¼Œå®ƒä¼šè¢« JavaScript ä»£ç è°ƒç”¨ã€‚è¿™ä¸ªå‡½æ•°é¦–å…ˆç¡®å®šè¢«è°ƒç”¨æ—¶ä¼ å…¥äº†ä¸€ä¸ªå‚æ•°ï¼Œå¹¶ä¸”è¿™ä¸ªå‚æ•°æ˜¯å­—ç¬¦ä¸²ã€‚ç„¶åï¼Œå®ƒä½¿ç”¨ <code>napi_get_value_string_utf16</code> å‡½æ•°æ¥è·å–å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå¹¶åˆ†é…ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ç¼“å†²åŒºæ¥å­˜å‚¨ UTF-16 ç¼–ç çš„å­—ç¬¦ä¸²ã€‚æ¥ç€ï¼Œå†æ¬¡è°ƒç”¨ <code>napi_get_value_string_utf16</code> å‡½æ•°å®é™…è¯»å–å­—ç¬¦ä¸²å¹¶å°†å…¶æ‹·è´åˆ°ä¹‹å‰åˆ†é…çš„ç¼“å†²åŒºä¸­ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ C/C++ ä¸­å¤„ç†è¿™ä¸ªå­—ç¬¦ä¸²äº†ã€‚å¤„ç†å®Œæˆåï¼Œè®°å¾—é‡Šæ”¾åˆ†é…çš„å†…å­˜ä»¥é¿å…å†…å­˜æ³„éœ²ã€‚</p><p>è¿™ä¸ªå‡½æ•°åœ¨å¼€å‘ Node.js åŸç”Ÿæ‰©å±•æ—¶éå¸¸æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯å½“ä½ éœ€è¦å¤„ç†ä¸æ–‡æœ¬ç›¸å…³çš„æ“ä½œæ—¶ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥åœ¨ C/C++ å±‚é¢ä¸Šæ“ä½œ JavaScript å­—ç¬¦ä¸²ï¼Œä»¥é«˜æ•ˆåœ°æ‰§è¡Œå„ç§ä»»åŠ¡ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²åˆ†æã€è½¬æ¢æˆ–å…¶ä»–è®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€‚</p><h4 id="napi-get-value-uint32" tabindex="-1"><a class="header-anchor" href="#napi-get-value-uint32"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_value_uint32" target="_blank" rel="noopener noreferrer">napi_get_value_uint32</a></span></a></h4><p>å½“ç„¶ï¼Œè®©æˆ‘ä¸ºä½ è§£é‡Šä¸€ä¸‹ Node.js ä¸­çš„<code>napi_get_value_uint32</code>å‡½æ•°ã€‚</p><p>åœ¨ Node.js ä¸­ï¼ŒN-API æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºæœ¬åœ°æ’ä»¶çš„ API å±‚ã€‚å®ƒå…è®¸ä½ ä½¿ç”¨ C æˆ– C++ä»£ç ä¸ Node.js è¿›è¡Œäº¤äº’ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥ç¼–å†™èƒ½å¤Ÿä»¥æœºå™¨ä»£ç é€Ÿåº¦è¿è¡Œçš„ JavaScript æ‰©å±•ï¼Œè¿™å¯¹äºæ€§èƒ½æ•æ„Ÿçš„åº”ç”¨ç¨‹åºæ¥è¯´éå¸¸é‡è¦ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬è°ˆåˆ°äº†<code>napi_get_value_uint32</code>ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒè¢«ç”¨æ¥å°†ä¸€ä¸ª JavaScript æ•°å€¼è½¬æ¢æˆ C è¯­è¨€ä¸­çš„æ— ç¬¦å· 32 ä½æ•´æ•°ï¼ˆå³<code>uint32_t</code>ç±»å‹çš„å€¼ï¼‰ã€‚</p><p>ä½¿ç”¨<code>napi_get_value_uint32</code>æ—¶ï¼Œéœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼š</p><ol><li><code>napi_env env</code>: è¿™æ˜¯ N-API ç¯å¢ƒçš„å¥æŸ„ï¼Œå®ƒä»£è¡¨äº† Node.js è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡å’ŒçŠ¶æ€ã€‚æ¯æ¬¡ N-API å‡½æ•°è°ƒç”¨éƒ½éœ€è¦è¿™ä¸ªå‚æ•°ã€‚</li><li><code>napi_value value</code>: è¿™æ˜¯ä¸€ä¸ª N-API å€¼çš„å¥æŸ„ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ª JavaScript å€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æœŸæœ›è¿™ä¸ª JavaScript å€¼æ˜¯ä¸€ä¸ªæ•°å€¼ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³æŠŠå®ƒè½¬æ¢æˆä¸€ä¸ª<code>uint32_t</code>æ•´æ•°ã€‚</li></ol><p>å‡½æ•°è¿˜éœ€è¦ä¸€ä¸ªåœ°æ–¹æ¥å­˜æ”¾è½¬æ¢åçš„<code>uint32_t</code>å€¼ã€‚æˆ‘ä»¬é€šå¸¸ä¼šæä¾›ä¸€ä¸ªæŒ‡å‘<code>uint32_t</code>å˜é‡çš„æŒ‡é’ˆä½œä¸ºè¾“å‡ºå‚æ•°ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­è¯´æ˜å¦‚ä½•ä½¿ç”¨<code>napi_get_value_uint32</code>ï¼š</p><p>å‡è®¾ä½ æœ‰ä¸€ä¸ª Node.js çš„æœ¬åœ°æ’ä»¶å‡½æ•°ï¼Œä½ æƒ³ä» JavaScript ä¼ é€’ä¸€ä¸ªæ•°å­—ç»™è¿™ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”åœ¨ C å±‚å°†å…¶è¯»å–ä¸ºä¸€ä¸ª<code>uint32_t</code>ç±»å‹çš„å€¼ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™æ˜¯ä½ çš„æœ¬åœ°æ’ä»¶å‡½æ•°</span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    uint32_t number;</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–JavaScriptä¼ å…¥çš„å‚æ•°</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆåº”è¯¥æ˜¯ä¸€ä¸ªJavaScriptæ•°å€¼ï¼‰è½¬æ¢ä¸ºuint32_t</span></span>
<span class="line"><span>    status = napi_get_value_uint32(env, args[0], &amp;number);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç°åœ¨å¯ä»¥ä½¿ç”¨numberå˜é‡ï¼Œå®ƒåŒ…å«äº†ä»JavaScriptä¼ è¿‡æ¥çš„æ•°å€¼</span></span>
<span class="line"><span>    // æ‰§è¡Œä¸€äº›æ“ä½œ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›undefinedç»™JavaScript</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    status = napi_get_undefined(env, &amp;result);</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œä¸Šé¢çš„å‡½æ•°åˆ°Node.js</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, MyFunction, NULL, &amp;fn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;myFunction&quot;, fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>MyFunction</code>æ˜¯ä¸€ä¸ªå°†è¦æš´éœ²ç»™ JavaScript çš„æœ¬åœ°æ’ä»¶å‡½æ•°ã€‚å®ƒå°è¯•è¯»å–ä¼ é€’ç»™å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªæ— ç¬¦å· 32 ä½æ•´æ•°ã€‚å¦‚æœè½¬æ¢æˆåŠŸï¼Œä½ å°±å¯ä»¥åœ¨ C/C++ä»£ç ä¸­ä½¿ç”¨è¿™ä¸ªå€¼äº†ã€‚æœ€åï¼Œå¦‚æœæ²¡æœ‰é”™è¯¯å‘ç”Ÿï¼Œå‡½æ•°ä¼šè¿”å› undefined ç»™ JavaScriptï¼ˆè¿™æ˜¯ Node.js ä¸­å‡½æ•°ä¸è¿”å›ä»»ä½•å€¼çš„æ ‡å‡†æ–¹å¼ï¼‰ã€‚</p><p>è¯·è®°ä½ï¼Œè¿™é‡Œåªæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå®é™…æƒ…å†µå¯èƒ½æ›´åŠ å¤æ‚ï¼Œè€Œä¸”ä¼šæ¶‰åŠåˆ°æ›´å¤šçš„é”™è¯¯æ£€æŸ¥å’Œå¤„ç†ã€‚å¸Œæœ›è¿™æœ‰åŠ©äºä½ ç†è§£<code>napi_get_value_uint32</code>çš„ä½œç”¨å’Œå¦‚ä½•åœ¨å®è·µä¸­ä½¿ç”¨å®ƒã€‚</p><h3 id="functions-to-get-global-instances" tabindex="-1"><a class="header-anchor" href="#functions-to-get-global-instances"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#functions-to-get-global-instances" target="_blank" rel="noopener noreferrer">Functions to get global instances</a></span></a></h3><p>Node.js çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ API å±‚ï¼Œå®ƒæä¾›äº†ä¸€ç§åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¹‹é—´ä¿æŒå…¼å®¹æ€§çš„æ–¹å¼ã€‚N-API æ˜¯åŸç”Ÿæ¨¡å—å’Œ Node.js è¿è¡Œæ—¶ä¹‹é—´çš„æ¡¥æ¢ï¼Œå…è®¸å¼€å‘è€…ä½¿ç”¨ C æˆ– C++ ç¼–å†™å¯ä»¥ç›´æ¥ä¸ JavaScript äº¤äº’çš„ä»£ç ã€‚</p><p>åœ¨ Node.js v21.7.1 çš„æ–‡æ¡£ä¸­ï¼Œ&quot;Functions to get global instances&quot; æŒ‡çš„æ˜¯ä¸€ç»„ç‰¹å®šçš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å…è®¸ä½ è·å–å…¨å±€å¯¹è±¡çš„å¼•ç”¨ï¼Œæ¯”å¦‚ <code>global</code> å¯¹è±¡æœ¬èº«æˆ–è€…æŸäº›åƒ <code>ArrayBuffer</code> è¿™æ ·çš„å…¨å±€æ„é€ å‡½æ•°ã€‚å…¨å±€å¯¹è±¡æ˜¯åœ¨æ‰€æœ‰æ¨¡å—ä¸­å§‹ç»ˆå¯ç”¨çš„é¡¶çº§å¯¹è±¡ã€‚</p><p>è¿™äº›å‡½æ•°é€šå¸¸åœ¨ç¼–å†™éœ€è¦ä¸å…¨å±€å¯¹è±¡ç›´æ¥äº¤äº’çš„åŸç”Ÿæ¨¡å—æ—¶ä½¿ç”¨ã€‚ä¸‹é¢æˆ‘ä¼šè§£é‡Šä¸€äº›è¿™æ ·çš„å‡½æ•°ï¼Œå¹¶æä¾›ä¸€äº›å®é™…åº”ç”¨çš„ä¾‹å­ï¼š</p><h3 id="napi-get-global" tabindex="-1"><a class="header-anchor" href="#napi-get-global"><span>napi_get_global</span></a></h3><p>è¿™ä¸ªå‡½æ•°ç”¨æ¥è·å–å¯¹ JavaScript å…¨å±€å¯¹è±¡çš„å¼•ç”¨ã€‚åœ¨ Node.js ä¸­ï¼Œå…¨å±€å¯¹è±¡åŒ…å«äº†åƒ <code>console</code>, <code>process</code> ç­‰å…¨å±€å¯ç”¨çš„å˜é‡å’Œå‡½æ•°ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value global;</span></span>
<span class="line"><span>napi_status status = napi_get_global(env, &amp;global);</span></span>
<span class="line"><span>// æ¥ä¸‹æ¥å¯ä»¥ä½¿ç”¨globalå˜é‡æ¥è°ƒç”¨å…¨å±€æ–¹æ³•æˆ–è®¿é—®å…¨å±€å±æ€§ã€‚</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="napi-get-constructor" tabindex="-1"><a class="header-anchor" href="#napi-get-constructor"><span>napi_get_constructor</span></a></h3><p>è¿™ä¸ªå‡½æ•°å¯ä»¥ç”¨æ¥è·å– JavaScript ä¸­æŸä¸ªå†…ç½®å¯¹è±¡ï¼ˆæ¯”å¦‚<code>Array</code>æˆ–<code>Object</code>ï¼‰çš„æ„é€ å‡½æ•°çš„å¼•ç”¨ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value constructor;</span></span>
<span class="line"><span>napi_status status = napi_get_constructor(env, object, &amp;constructor);</span></span>
<span class="line"><span>// object æ˜¯ä¸€ä¸ªæŒ‡å‘ JavaScript å¯¹è±¡çš„å¼•ç”¨ï¼Œæ¯”å¦‚ ArrayBuffer å®ä¾‹ã€‚</span></span>
<span class="line"><span>// æ„é€ å‡½æ•°å¯ä»¥ç”¨æ¥åˆ›å»ºæ–°çš„å®ä¾‹æˆ–è€…è°ƒç”¨ä¸æ„é€ å‡½æ•°ç›¸å…³çš„é™æ€æ–¹æ³•ã€‚</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åº”ç”¨ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨ä¾‹å­"><span>åº”ç”¨ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œè¯¥æ¨¡å—éœ€è¦åœ¨ JavaScript ç¯å¢ƒä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>ArrayBuffer</code> å¯¹è±¡ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>napi_get_global</code> å‡½æ•°è·å–å…¨å±€å¯¹è±¡ï¼Œç„¶åä½¿ç”¨ <code>napi_get_named_property</code> æ¥è·å¾— <code>ArrayBuffer</code> æ„é€ å‡½æ•°çš„å¼•ç”¨ï¼Œæ¥ç€å°±å¯ä»¥é€šè¿‡è¿™ä¸ªæ„é€ å‡½æ•°åˆ›å»º <code>ArrayBuffer</code> å®ä¾‹ã€‚</p><p>ä»¥ä¸‹æ˜¯ C/C++ä»£ç çš„ç®€åŒ–ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ N-API åˆ›å»ºä¸€ä¸ªæ–°çš„ ArrayBuffer å®ä¾‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CreateArrayBuffer(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  napi_value global, arrayBufferConstructor, arrayBufferInstance;</span></span>
<span class="line"><span>  size_t byteLength = 64; // å‡è®¾æˆ‘ä»¬æƒ³åˆ›å»ºä¸€ä¸ª64å­—èŠ‚é•¿åº¦çš„ArrayBuffer</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è·å–å…¨å±€å¯¹è±¡</span></span>
<span class="line"><span>  napi_get_global(env, &amp;global);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è·å–ArrayBufferçš„æ„é€ å‡½æ•°</span></span>
<span class="line"><span>  napi_get_named_property(env, global, &quot;ArrayBuffer&quot;, &amp;arrayBufferConstructor);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ä½¿ç”¨æ„é€ å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ArrayBufferå®ä¾‹</span></span>
<span class="line"><span>  napi_create_arraybuffer(env, byteLength, NULL, &amp;arrayBufferInstance);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return arrayBufferInstance;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¹‹åä½ éœ€è¦æ³¨å†Œè¿™ä¸ªå‡½æ•°åˆ°ä½ çš„æ¨¡å—å¯¼å‡ºä¸­ï¼Œä»¥ä¾¿JavaScriptå¯ä»¥è°ƒç”¨å®ƒã€‚</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ Node.js ä¸­ä½¿ç”¨è¿™ä¸ªåŸç”Ÿæ¨¡å—çš„ JavaScript ä»£ç å¯èƒ½å¦‚ä¸‹ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeModule</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">your-native-module</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> arrayBuffer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> nativeModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">CreateArrayBuffer</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">arrayBuffer</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">byteLength</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: 64</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™åªæ˜¯ä¸€ä¸ªéå¸¸åŸºæœ¬çš„ä¾‹å­ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œä½¿ç”¨ N-API å’ŒåŸç”Ÿæ¨¡å—å¯ä»¥æ‰§è¡Œæ›´å¤æ‚çš„æ“ä½œï¼Œæ¯”å¦‚æ€§èƒ½ä¼˜åŒ–ã€ç›´æ¥ä¸æ“ä½œç³»ç»Ÿ API äº¤äº’ã€å¤„ç†å›¾å½¢å’ŒéŸ³é¢‘æ•°æ®ç­‰ã€‚</p><h4 id="napi-get-boolean" tabindex="-1"><a class="header-anchor" href="#napi-get-boolean"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_boolean" target="_blank" rel="noopener noreferrer">napi_get_boolean</a></span></a></h4><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome çš„ V8 JavaScript å¼•æ“æ„å»ºçš„å¹³å°ï¼Œå®ƒå…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScriptã€‚N-API æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç¨³å®šçš„ API å±‚ï¼Œä½¿å¾—åŸç”Ÿæ¨¡å—ï¼ˆç”¨ C æˆ– C++ å†™çš„æ‰©å±•ï¼‰å¯ä»¥ä¸å— Node.js ç‰ˆæœ¬å½±å“çš„æƒ…å†µä¸‹ç¼–è¯‘å’Œè¿è¡Œã€‚</p><p>åœ¨ Node.js v21.7.1 çš„æ–‡æ¡£ä¸­ï¼Œ<code>napi_get_boolean</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨åŸç”Ÿä»£ç ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å¸ƒå°”å€¼ã€‚</p><p>è¿™ä¸ªå‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_get_boolean(napi_env env, bool value, napi_value* result)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>env</code>ï¼šè¿™æ˜¯ä¸€ä¸ªè¡¨ç¤º N-API ç¯å¢ƒçš„å¥æŸ„ï¼Œä½ åœ¨è°ƒç”¨ä»»ä½• N-API å‡½æ•°æ—¶éƒ½éœ€è¦æä¾›è¿™ä¸ªå‚æ•°ã€‚</li><li><code>value</code>ï¼šè¿™æ˜¯ä½ æƒ³è¦åˆ›å»ºçš„å¸ƒå°”å€¼ï¼Œç”¨ C è¯­è¨€ä¸­çš„ <code>true</code> æˆ– <code>false</code> è¡¨ç¤ºã€‚</li><li><code>result</code>ï¼šè¿™æ˜¯ä¸€ä¸ªæŒ‡å‘ napi_value çš„æŒ‡é’ˆï¼Œnapi_get_boolean å‡½æ•°ä¼šå°†åˆ›å»ºå¥½çš„ JavaScript å¸ƒå°”å€¼å­˜æ”¾åœ¨å…¶ä¸­ã€‚</li></ul><p>å¦‚æœå‡½æ•°æ‰§è¡ŒæˆåŠŸï¼Œå®ƒä¼šè¿”å› <code>napi_ok</code>ï¼Œè¿™è¡¨ç¤ºæ“ä½œæˆåŠŸå®Œæˆã€‚</p><p>ä¸‹é¢æ˜¯å¦‚ä½•åœ¨ä¸€ä¸ªåŸç”Ÿæ¨¡å—ä¸­ä½¿ç”¨ <code>napi_get_boolean</code> çš„ä¾‹å­ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ç¤ºä¾‹å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ª JS å¸ƒå°”å€¼å¹¶è¿”å›ç»™ JavaScript</span></span>
<span class="line"><span>napi_value GetTrueValue(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value true_value;</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è°ƒç”¨ napi_get_boolean æ¥åˆ›å»ºä¸€ä¸ªè¡¨ç¤º true çš„ JavaScript å¸ƒå°”å€¼</span></span>
<span class="line"><span>    status = napi_get_boolean(env, true, &amp;true_value);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦è°ƒç”¨æˆåŠŸ</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›åˆ›å»ºçš„å¸ƒå°”å€¼</span></span>
<span class="line"><span>    return true_value;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨æ¨¡å—åŠ è½½æ—¶è®¾ç½®å¯¼å‡º</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°å¯¹è±¡</span></span>
<span class="line"><span>    status = napi_create_function(env, NULL, 0, GetTrueValue, NULL, &amp;fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†æ–°åˆ›å»ºçš„å‡½æ•°ä½œä¸ºæ¨¡å—çš„å¯¼å‡º</span></span>
<span class="line"><span>    status = napi_set_named_property(env, exports, &quot;getTrue&quot;, fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å®šä¹‰æ¨¡å—</span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>GetTrueValue</code> çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°ä½¿ç”¨ <code>napi_get_boolean</code> åˆ›å»ºä¸€ä¸ªè¡¨ç¤º <code>true</code> çš„ JavaScript å¸ƒå°”å€¼ï¼Œå¹¶è¿”å›ç»™è°ƒç”¨å®ƒçš„ JavaScript ä»£ç ã€‚ç„¶åæˆ‘ä»¬åœ¨ <code>Init</code> å‡½æ•°ä¸­å°† <code>GetTrueValue</code> ä½œä¸ºæ¨¡å—çš„å¯¼å‡ºï¼Œè¿™æ · JavaScript ä»£ç å°±å¯ä»¥é€šè¿‡ <code>require</code> åŠ è½½è¿™ä¸ªæ¨¡å—ï¼Œå¹¶è°ƒç”¨ <code>getTrue</code> å‡½æ•°æ¥è·å–ä¸€ä¸ª JavaScript ä¸­çš„ <code>true</code> å€¼ã€‚</p><p>æœ€ç»ˆï¼Œå½“è¿™ä¸ªåŸç”Ÿæ¨¡å—è¢«åŠ è½½åˆ° Node.js åº”ç”¨ä¸­æ—¶ï¼ŒJavaScript å¼€å‘è€…å¯ä»¥åƒè¿™æ ·ä½¿ç”¨å®ƒï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> myNativeModule</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my-native-module</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">myNativeModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getTrue</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: true</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œ <code>&#39;my-native-module&#39;</code> æ˜¯å‡è®¾çš„åŸç”Ÿæ¨¡å—åç§°ï¼Œåœ¨å®é™…åº”ç”¨ä¸­åº”æ›¿æ¢ä¸ºç›¸åº”æ¨¡å—çš„çœŸå®åç§°ã€‚</p><h4 id="napi-get-global-1" tabindex="-1"><a class="header-anchor" href="#napi-get-global-1"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_global" target="_blank" rel="noopener noreferrer">napi_get_global</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºæœ¬åœ°æ’ä»¶ï¼ˆnative addonsï¼‰çš„ APIã€‚æœ¬åœ°æ’ä»¶æ˜¯ç”¨ Cã€C++ç­‰ç¼–ç¨‹è¯­è¨€ç¼–å†™çš„ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ Node.js è¿è¡Œæ—¶å’Œ V8 JavaScript å¼•æ“çš„åŠŸèƒ½ï¼Œé€šå¸¸ç”¨äºæ€§èƒ½å…³é”®å‹ä»»åŠ¡æˆ–è€…è°ƒç”¨ç³»ç»Ÿçº§åˆ«çš„ APIã€‚</p><p>å½“ä½ ä½¿ç”¨ N-API ç¼–å†™æœ¬åœ°æ’ä»¶æ—¶ï¼Œç»å¸¸éœ€è¦å’Œ JavaScript çš„å…¨å±€å¯¹è±¡è¿›è¡Œäº¤äº’ã€‚JavaScript ä¸­çš„å…¨å±€å¯¹è±¡ç±»ä¼¼äºä¸€ä¸ªå¤§å®¹å™¨ï¼Œå®ƒåŒ…å«äº† JavaScript ç¯å¢ƒä¸­æ‰€æœ‰çš„å…¨å±€å˜é‡ã€å‡½æ•°ç­‰ã€‚åœ¨æµè§ˆå™¨ä¸­ï¼Œè¿™ä¸ªå…¨å±€å¯¹è±¡å°±æ˜¯<code>window</code>ï¼›è€Œåœ¨ Node.js ä¸­ï¼Œè¿™ä¸ªå…¨å±€å¯¹è±¡é€šå¸¸æŒ‡çš„æ˜¯<code>global</code>ã€‚</p><p><code>napi_get_global</code>æ˜¯ N-API æä¾›çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºè·å–å½“å‰ç¯å¢ƒçš„å…¨å±€å¯¹è±¡ã€‚ä½ å¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆè¦é€šè¿‡ N-API æ¥è·å–å…¨å±€å¯¹è±¡å‘¢ï¼Ÿå› ä¸º N-API ä¿æŠ¤äº†ä»£ç ä¸å— V8 å¼•æ“ç‰ˆæœ¬æ›´æ–°çš„å½±å“ï¼Œå¢åŠ äº†ä»£ç çš„å…¼å®¹æ€§å’Œç¨³å®šæ€§ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªå¦‚ä½•ä½¿ç”¨<code>napi_get_global</code>çš„ç®€å•ä¾‹å­ï¼š</p><p>å‡è®¾æˆ‘ä»¬æƒ³è¦ä» C++ä»£ç ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å‡½æ•°ï¼Œå¹¶å°†å…¶æŒ‚è½½åˆ°å…¨å±€å¯¹è±¡ä¸Šï¼Œè®© JavaScript ä»£ç å¯ä»¥ç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</p><p>é¦–å…ˆï¼Œåœ¨ C++æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åŒ…å«å¿…è¦çš„å¤´æ–‡ä»¶å¹¶å®šä¹‰æˆ‘ä»¬çš„æ–¹æ³•ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªæ˜¯æˆ‘ä»¬è¦æš´éœ²ç»™JavaScriptçš„å‡½æ•°</span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // åœ¨è¿™é‡Œå®ç°ä½ çš„åŠŸèƒ½</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–æ–¹æ³•ï¼Œç”¨æ¥è®¾ç½®å¯¼å‡ºå‡½æ•°</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    // é¦–å…ˆè·å–å…¨å±€å¯¹è±¡</span></span>
<span class="line"><span>    napi_value global;</span></span>
<span class="line"><span>    napi_status status = napi_get_global(env, &amp;global);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°</span></span>
<span class="line"><span>    napi_value myFunction;</span></span>
<span class="line"><span>    status = napi_create_function(env, NULL, 0, MyFunction, NULL, &amp;myFunction);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†å‡½æ•°æŒ‚è½½åˆ°å…¨å±€å¯¹è±¡ä¸Š</span></span>
<span class="line"><span>    status = napi_set_named_property(env, global, &quot;myGlobalFunction&quot;, myFunction);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œæ¨¡å—</span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ<code>Init</code>å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ª JavaScript å‡½æ•°<code>MyFunction</code>ï¼Œç„¶åé€šè¿‡è°ƒç”¨<code>napi_get_global</code>è·å¾—å…¨å±€å¯¹è±¡ï¼Œå¹¶é€šè¿‡<code>napi_set_named_property</code>å°†<code>MyFunction</code>è®¾ç½®ä¸ºå…¨å±€å¯¹è±¡çš„å±æ€§ã€‚è¿™æ ·ä¸€æ¥ï¼Œå½“è¿™ä¸ªæœ¬åœ°æ’ä»¶è¢«åŠ è½½è¿› Node.js æ—¶ï¼ŒJavaScript ä»£ç å°±å¯ä»¥ç›´æ¥é€šè¿‡<code>myGlobalFunction()</code>æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°äº†ã€‚</p><p>æœ€åï¼Œåœ¨ JavaScript æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥åƒè¿™æ ·è°ƒç”¨ C++å‡½æ•°ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// å‡è®¾ä½ çš„æœ¬åœ°æ’ä»¶å«åš&#39;addon&#39;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> addon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ç›´æ¥ä½¿ç”¨åœ¨å…¨å±€å¯¹è±¡ä¸ŠæŒ‚è½½çš„å‡½æ•°</span></span>
<span class="line"><span style="color:#88C0D0;">myGlobalFunction</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™åªæ˜¯ä¸€ä¸ªç®€åŒ–ç¤ºä¾‹ï¼ŒçœŸå®æƒ…å†µä¸‹ä½ å¯èƒ½éœ€è¦å¤„ç†æ›´å¤šçš„è¾¹ç¼˜æƒ…å†µå’Œé”™è¯¯ã€‚ä½†å¸Œæœ›é€šè¿‡è¿™ä¸ªä¾‹å­ï¼Œä½ èƒ½ç†è§£<code>napi_get_global</code>åœ¨ Node.js ä¸­çš„ä½œç”¨åŠå…¶åŸºæœ¬ç”¨æ³•ã€‚</p><h4 id="napi-get-null" tabindex="-1"><a class="header-anchor" href="#napi-get-null"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_null" target="_blank" rel="noopener noreferrer">napi_get_null</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIï¼Œå®ƒæä¾›äº†ä¸€ç»„ç”¨ C è¯­è¨€ç¼–å†™çš„ APIï¼Œå…è®¸ä½ åˆ›å»ºå¯ä»¥ç›´æ¥ä¸ JavaScript è¿è¡Œæ—¶äº¤äº’çš„æœ¬åœ°ä»£ç ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯èƒ½å¤Ÿåœ¨æœ¬åœ°ä»£ç ä¸­æ‰§è¡Œé«˜æ€§èƒ½æˆ–æ›´åº•å±‚æ“ä½œï¼ŒåŒæ—¶ä¿æŒè·¨ä¸åŒç‰ˆæœ¬ Node.js çš„å…¼å®¹æ€§ã€‚</p><p><code>napi_get_null</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒç”¨äºè·å– JavaScript çš„ <code>null</code> å€¼çš„å¼•ç”¨ã€‚åœ¨ç¼–å†™åŸç”Ÿæ’ä»¶æ—¶ï¼Œå¯èƒ½éœ€è¦è¿”å›ä¸€ä¸ª <code>null</code> å€¼ç»™ JavaScript ç¯å¢ƒï¼Œ<code>napi_get_null</code> å…è®¸ä½ åšåˆ°è¿™ä¸€ç‚¹ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ <code>napi_get_null</code> å‡½æ•°çš„ç®€å•ä¾‹å­ï¼š</p><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œè¯¥æ¨¡å—åŒ…å«ä¸€ä¸ªå‡½æ•°ï¼Œå½“æŸä¸ªæ¡ä»¶æ»¡è¶³æ—¶è¦è¿”å› <code>null</code> ç»™ JavaScriptï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯æˆ‘ä»¬å°†æš´éœ²ç»™JavaScriptçš„å‡½æ•°</span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æŸä¸ªæ¡ä»¶æ˜¯å¦æ»¡è¶³</span></span>
<span class="line"><span>    bool condition = true; // å‡è®¾æ¡ä»¶ä¸ºçœŸ</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (condition) {</span></span>
<span class="line"><span>        // å¦‚æœæ¡ä»¶æ»¡è¶³ï¼Œæˆ‘ä»¬æƒ³è¦è¿”å› null ç»™ JavaScriptã€‚</span></span>
<span class="line"><span>        napi_status status = napi_get_null(env, &amp;result);</span></span>
<span class="line"><span>        if (status != napi_ok) {</span></span>
<span class="line"><span>            // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>            napi_throw_error(env, NULL, &quot;Unable to create null value&quot;);</span></span>
<span class="line"><span>            return NULL;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œæˆ‘ä»¬è¿”å›å…¶ä»–å€¼ï¼Œæ¯”å¦‚æ•°å­—0</span></span>
<span class="line"><span>        napi_create_int32(env, 0, &amp;result);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œä¸Šé¢çš„å‡½æ•°ï¼Œä½¿å…¶å¯ä»¥ä» JavaScript ä»£ç ä¸­è°ƒç”¨</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªJavaScriptå‡½æ•°</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, MyFunction, NULL, &amp;fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†è¿™ä¸ªå‡½æ•°è®¾ç½®ä¸ºå¯¼å‡ºå¯¹è±¡çš„å±æ€§</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;myFunction&quot;, fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œå¦‚æœ <code>condition</code> ä¸ºçœŸï¼Œåˆ™ <code>MyFunction</code> å‡½æ•°å°†è¿”å› JavaScript ä¸­çš„ <code>null</code>; å¦‚æœä¸ä¸ºçœŸï¼Œåˆ™ä¼šè¿”å›æ•°å­— 0ã€‚</p><p>è¦æ³¨æ„çš„æ˜¯ï¼Œä»¥ä¸Šä»£ç æ˜¯ C/C++ ä»£ç ï¼Œå®ƒå¿…é¡»ä¸ Node.js é…åˆä½¿ç”¨å¹¶é€šè¿‡ç‰¹å®šçš„æ­¥éª¤æ¥ç¼–è¯‘å’Œç»‘å®šã€‚åˆ›å»ºå®Œæ•´çš„åŸç”Ÿæ¨¡å—éœ€è¦ä¸€äº›é¢å¤–çš„é…ç½®å’Œå·¥å…·ï¼Œä¾‹å¦‚ <code>node-gyp</code> æ¥ç¼–è¯‘æ¨¡å—ï¼Œä»¥åŠåœ¨é¡¹ç›®ä¸­å£°æ˜å¯¹ N-API ç‰ˆæœ¬çš„ä¾èµ–ã€‚</p><p>å¸Œæœ›è¿™ä¸ªè§£é‡Šå’Œä¾‹å­å¸®åŠ©æ‚¨ç†è§£ <code>napi_get_null</code> åœ¨ Node.js ä¸­çš„ä½œç”¨å’Œå¦‚ä½•ä½¿ç”¨ï¼</p><h4 id="napi-get-undefined" tabindex="-1"><a class="header-anchor" href="#napi-get-undefined"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_undefined" target="_blank" rel="noopener noreferrer">napi_get_undefined</a></span></a></h4><p>å½“ç„¶ï¼Œæˆ‘å¾ˆä¹æ„å¸®åŠ©ä½ ç†è§£<code>napi_get_undefined</code>è¿™ä¸ªå‡½æ•°ã€‚</p><p>N-API æ˜¯ Node.js çš„ä¸€ä¸ª APIï¼Œå®ƒå…è®¸ C å’Œ C++ä»£ç ä¸ Node.js äº¤äº’ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæä¾›äº†ä¸€ç³»åˆ—çš„å·¥å…·ï¼Œä½¿å¾—åŸç”Ÿæ¨¡å—ï¼ˆé€šå¸¸ç”¨ C æˆ– C++ç¼–å†™ï¼‰èƒ½å¤Ÿä¸ JavaScript ä»£ç æ²Ÿé€šã€‚<code>napi_get_undefined</code>æ˜¯å…¶ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯è·å– JavaScript ä¸­çš„<code>undefined</code>å€¼ã€‚</p><p>åœ¨ JavaScript é‡Œï¼Œ<code>undefined</code>æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å€¼ï¼Œè¡¨ç¤ºå˜é‡æ²¡æœ‰è¢«èµ‹å€¼ã€‚åœ¨ Native Addonï¼ˆåŸç”Ÿæ‰©å±•æ¨¡å—ï¼‰ä¸­ï¼Œç»å¸¸éœ€è¦åˆ›å»º JavaScript å€¼ä»¥ä¾¿äºä¼ é€’æ•°æ®æˆ–è€…å’Œ JavaScript å±‚é¢çš„ä»£ç è¿›è¡Œäº’åŠ¨ã€‚<code>napi_get_undefined</code>å‡½æ•°å°±æ˜¯ç”¨æ¥åˆ›å»ºè¿™æ ·ä¸€ä¸ª<code>undefined</code>å€¼çš„ã€‚</p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª C++çš„æ‰©å±•æ¨¡å—ï¼Œä½ å¯èƒ½ä¼šéœ€è¦åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œåœ¨æŸäº›æ¡ä»¶ä¸‹è¿”å›<code>undefined</code>ç»™ JavaScriptã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°å°†ä¼šè¢«æš´éœ²ç»™JavaScriptï¼Œå¹¶åœ¨è¢«è°ƒç”¨æ—¶è¿”å›undefined</span></span>
<span class="line"><span>napi_value GetUndefinedExample(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  // å®šä¹‰ä¸€ä¸ªç”¨äºå­˜æ”¾ç»“æœçš„napi_valueå˜é‡</span></span>
<span class="line"><span>  napi_value undefined;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è°ƒç”¨napi_get_undefinedè·å–JavaScriptçš„undefinedå€¼</span></span>
<span class="line"><span>  napi_status status = napi_get_undefined(env, &amp;undefined);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ£€æŸ¥è°ƒç”¨æ˜¯å¦æˆåŠŸ</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¦‚æœæœ‰é”™è¯¯å‘ç”Ÿï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µå¤„ç†é”™è¯¯</span></span>
<span class="line"><span>    // è¿™é‡Œæˆ‘ä»¬ç®€å•åœ°è¿”å›ç©ºå€¼</span></span>
<span class="line"><span>    return nullptr;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›undefinedå€¼ç»™JavaScript</span></span>
<span class="line"><span>  return undefined;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œæ³¨å†ŒGetUndefinedExampleå‡½æ•°åˆ°exportså¯¹è±¡ä¸Š</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>  napi_status status;</span></span>
<span class="line"><span>  napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ªJavaScriptå‡½æ•°</span></span>
<span class="line"><span>  status = napi_create_function(env, nullptr, 0, GetUndefinedExample, nullptr, &amp;fn);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    return nullptr;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å°†è¿™ä¸ªå‡½æ•°ä½œä¸º&quot;getUndefined&quot;å±æ€§æ·»åŠ åˆ°exportså¯¹è±¡</span></span>
<span class="line"><span>  status = napi_set_named_property(env, exports, &quot;getUndefined&quot;, fn);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    return nullptr;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šè¿°çš„ C++ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<code>GetUndefinedExample</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä½¿ç”¨äº†<code>napi_get_undefined</code>æ¥è·å–ä¸€ä¸ª undefined å€¼ï¼Œå¹¶å°†å…¶è¿”å›ç»™è°ƒç”¨å®ƒçš„ JavaScript ä»£ç ã€‚</p><p>åœ¨ JavaScript ç«¯ï¼Œä½ èƒ½å¤Ÿåƒè¿™æ ·ä½¿ç”¨è¿™ä¸ªæ¨¡å—ï¼š</p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/nativeAddon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getUndefined</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºï¼šundefined</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™æ®µ JavaScript ä»£ç é‡Œï¼Œæˆ‘ä»¬é¦–å…ˆåŠ è½½äº†æˆ‘ä»¬åˆšæ‰å†™çš„åŸç”Ÿæ¨¡å—ï¼Œç„¶åè°ƒç”¨äº†<code>getUndefined</code>å‡½æ•°ï¼Œå¹¶æ‰“å°äº†å®ƒçš„è¿”å›å€¼ï¼Œå®ƒåº”è¯¥æ˜¯<code>undefined</code>ã€‚</p><h2 id="working-with-javascript-values-and-abstract-operations" tabindex="-1"><a class="header-anchor" href="#working-with-javascript-values-and-abstract-operations"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#working-with-javascript-values-and-abstract-operations" target="_blank" rel="noopener noreferrer">Working with JavaScript values and abstract operations</a></span></a></h2><p>Node.js æ˜¯ä¸€ä¸ªèƒ½è®©ä½ ä½¿ç”¨ JavaScript æ¥ç¼–å†™æœåŠ¡å™¨ç«¯ä»£ç çš„å¹³å°ã€‚å®ƒå…·å¤‡éé˜»å¡ I/O å’Œäº‹ä»¶é©±åŠ¨çš„ç‰¹ç‚¹ï¼Œè¿™æ„å‘³ç€ Node.js å¾ˆæ“…é•¿å¤„ç†å¤§é‡å¹¶å‘çš„æ•°æ®äº¤äº’ï¼Œæ¯”å¦‚ç½‘ç»œåº”ç”¨æˆ–å®æ—¶ç³»ç»Ÿã€‚</p><p>N-APIï¼ˆNode APIï¼‰æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç¨³å®šä¸”ç‰ˆæœ¬æ— å…³çš„ APIï¼Œå…è®¸åŸç”Ÿæ’ä»¶å¼€å‘è€…ç¼–è¯‘åªéœ€ä¸€æ¬¡å³å¯åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸Šè¿è¡Œã€‚è¿™å°±å‡å°‘äº†å›  Node.js å‡çº§å¯¼è‡´çš„æ’ä»¶å…¼å®¹æ€§é—®é¢˜ã€‚</p><p>åœ¨ Node.js v21.7.1 çš„æ–‡æ¡£ä¸­ï¼Œâ€œWorking with JavaScript values and abstract operationsâ€éƒ¨åˆ†æè¿°äº†å¦‚ä½•é€šè¿‡ N-API åœ¨åŸç”Ÿä»£ç ä¸­åˆ›å»ºå’Œæ“ä½œ JavaScript å€¼ï¼Œä»¥åŠæ‰§è¡Œä¸€äº›æŠ½è±¡æ“ä½œã€‚æˆ‘ä»¬æ¥é€ä¸ªçœ‹ä¸€äº›åŸºæœ¬æ¦‚å¿µå’Œä¾‹å­ï¼š</p><h3 id="javascript-å€¼-values" tabindex="-1"><a class="header-anchor" href="#javascript-å€¼-values"><span>JavaScript å€¼ (Values)</span></a></h3><p>JavaScript ä¸­çš„å€¼å¯ä»¥æ˜¯æ•°å­—ã€å­—ç¬¦ä¸²ã€å¯¹è±¡ã€æ•°ç»„ç­‰ã€‚åœ¨åŸç”Ÿæ¨¡å—ä¸­ä¸è¿™äº›å€¼è¿›è¡Œäº¤äº’éœ€è¦ä½¿ç”¨ N-API æä¾›çš„å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³ä» C/C++ ä»£ç ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript æ•°å­—ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>napi_create_number</code> å‡½æ•°ã€‚</p><h4 id="å®ä¾‹-åˆ›å»ºä¸€ä¸ª-javascript-æ•°å­—" tabindex="-1"><a class="header-anchor" href="#å®ä¾‹-åˆ›å»ºä¸€ä¸ª-javascript-æ•°å­—"><span>å®ä¾‹ï¼šåˆ›å»ºä¸€ä¸ª JavaScript æ•°å­—</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CreateNumber(napi_env env) {</span></span>
<span class="line"><span>    napi_value num;</span></span>
<span class="line"><span>    napi_status status = napi_create_double(env, 123.456, &amp;num);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    return num; // è¿™æ˜¯ä¸€ä¸ª JavaScript æ•°å­—</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æŠ½è±¡æ“ä½œ-abstract-operations" tabindex="-1"><a class="header-anchor" href="#æŠ½è±¡æ“ä½œ-abstract-operations"><span>æŠ½è±¡æ“ä½œ (Abstract Operations)</span></a></h3><p>â€œæŠ½è±¡æ“ä½œâ€æ˜¯æŒ‡é‚£äº›å®šä¹‰åœ¨ ECMAScript è§„èŒƒé‡Œï¼Œå¯¹ JavaScript å€¼è¿›è¡Œæ“ä½œçš„æ­¥éª¤ã€‚åœ¨ N-API ä¸­ï¼Œæœ‰å¾ˆå¤šå‡½æ•°è¢«æä¾›å‡ºæ¥ä»¥æ”¯æŒè¿™äº›æ“ä½œã€‚</p><h4 id="å®ä¾‹-è°ƒç”¨-javascript-å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#å®ä¾‹-è°ƒç”¨-javascript-å‡½æ•°"><span>å®ä¾‹ï¼šè°ƒç”¨ JavaScript å‡½æ•°</span></a></h4><p>å¦‚æœä½ æœ‰ä¸€ä¸ª JavaScript å‡½æ•°ï¼Œæƒ³è¦ä» C/C++ ä»£ç ä¸­è°ƒç”¨å®ƒï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>napi_call_function</code>ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void CallJsFunction(napi_env env, napi_value jsFunction) {</span></span>
<span class="line"><span>    // å‡è®¾æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ª &#39;env&#39; ç¯å¢ƒæ ‡è¯†ç¬¦å’Œä¸€ä¸ª &#39;jsFunction&#39; è¡¨ç¤º JavaScript å‡½æ•°çš„å€¼</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ª JavaScript å­—ç¬¦ä¸²å‚æ•°</span></span>
<span class="line"><span>    napi_value arg;</span></span>
<span class="line"><span>    napi_status status = napi_create_string_utf8(env, &quot;Hello from native code!&quot;, -1, &amp;arg);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è°ƒç”¨ JavaScript å‡½æ•°ï¼Œä¼ é€’ä¸€ä¸ªå‚æ•°</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    status = napi_call_function(env, global, jsFunction, 1, &amp;arg, &amp;result);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // &#39;result&#39; ç°åœ¨åŒ…å«äº† JavaScript å‡½æ•°çš„è¿”å›å€¼</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªè¡¨ç¤º JavaScript å­—ç¬¦ä¸²çš„ <code>napi_value</code>ï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨ JavaScript å‡½æ•°ï¼Œå¹¶å°†åˆ›å»ºçš„å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ƒã€‚</p><p>è®°ä½ï¼Œæ¯å½“ä½ ä» C/C++ ä»£ç ä¸­æ“ä½œ JavaScript å¯¹è±¡æ—¶ï¼Œéƒ½éœ€è¦æ£€æŸ¥è¿”å›çš„ <code>napi_status</code>ã€‚è¿™æ˜¯å› ä¸ºæ‰€æœ‰çš„ N-API å‡½æ•°å‡ ä¹éƒ½ä¼šè¿”å›çŠ¶æ€ç ï¼Œå‘Šè¯‰ä½ æ“ä½œæ˜¯å¦æˆåŠŸï¼Œæˆ–è€…æ˜¯å¦æœ‰é”™è¯¯å‘ç”Ÿã€‚å¦‚æœæœ‰é”™è¯¯å‘ç”Ÿï¼Œä½ é€šå¸¸éœ€è¦é‡‡å–æŸç§æªæ–½æ¥å¤„ç†å®ƒï¼Œæ¯”å¦‚æŠ›å‡ºä¸€ä¸ªé”™è¯¯æˆ–è€…åœæ­¢å½“å‰æ“ä½œã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼ŒNode.js ä¸­çš„ N-API è®©ä½ èƒ½å¤Ÿåœ¨åŸç”Ÿæ¨¡å—ä¸­å®‰å…¨åœ°åˆ›å»ºå’Œæ“ä½œ JavaScript å€¼ï¼Œå¹¶æ‰§è¡ŒæŠ½è±¡æ“ä½œã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œä½ å¯ä»¥æ„å»ºæ›´é«˜æ•ˆã€è·¨ Node.js ç‰ˆæœ¬å…¼å®¹çš„åŸç”Ÿæ’ä»¶ã€‚</p><h3 id="napi-coerce-to-bool" tabindex="-1"><a class="header-anchor" href="#napi-coerce-to-bool"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_coerce_to_bool" target="_blank" rel="noopener noreferrer">napi_coerce_to_bool</a></span></a></h3><p>Node.js ä¸­çš„ <code>napi_coerce_to_bool</code> æ˜¯ N-APIï¼ˆåŸç”Ÿ APIï¼‰çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒç”¨äºå°†ä¸€ä¸ª JavaScript å€¼è½¬æ¢æˆä¸€ä¸ªå¸ƒå°”å€¼ã€‚åœ¨ JavaScript ä¸­ï¼Œå¾ˆå¤šç±»å‹çš„å€¼éƒ½å¯ä»¥æœ‰ä¸€ä¸ªâ€œçœŸå€¼â€æˆ–â€œå‡å€¼â€çš„æ¦‚å¿µï¼Œè¿™å°±æ˜¯æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„ truthy æˆ– falsy å€¼ã€‚</p><h3 id="å¦‚ä½•ç†è§£-bool" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ç†è§£-bool"><span>å¦‚ä½•ç†è§£ bool</span></a></h3><p>åœ¨ JavaScript ä¸­ï¼Œä»¥ä¸‹å€¼è¢«è®¤ä¸ºæ˜¯ falsyï¼Œä¹Ÿå°±æ˜¯å®ƒä»¬ä¼šè¢«è½¬æ¢æˆå¸ƒå°”å€¼ <code>false</code>ï¼š</p><ul><li><code>false</code></li><li><code>0</code></li><li><code>-0</code></li><li><code>0n</code> ï¼ˆBigInt çš„é›¶ï¼‰</li><li><code>&quot;&quot;</code> ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰</li><li><code>null</code></li><li><code>undefined</code></li><li><code>NaN</code></li></ul><p>å…¶ä»–æ‰€æœ‰å€¼éƒ½è¢«è®¤ä¸ºæ˜¯ truthyï¼Œå³è½¬æ¢æˆå¸ƒå°”å€¼ <code>true</code>ã€‚ä¾‹å¦‚ï¼š<code>true</code>, <code>1</code>, <code>&quot;hello&quot;</code>, <code>[]</code> ï¼ˆç©ºæ•°ç»„ï¼‰, <code>{}</code> ï¼ˆç©ºå¯¹è±¡ï¼‰ç­‰ã€‚</p><h3 id="napi-coerce-to-bool-çš„ä½œç”¨" tabindex="-1"><a class="header-anchor" href="#napi-coerce-to-bool-çš„ä½œç”¨"><span><code>napi_coerce_to_bool</code> çš„ä½œç”¨</span></a></h3><p>å½“ä½ åœ¨ä½¿ç”¨ Node.js çš„ N-API ç¼–å†™åŸç”Ÿæ’ä»¶æ—¶ï¼Œä½ å¯èƒ½ä¼šå¤„ç†æ¥è‡ª JavaScript ç¯å¢ƒçš„å€¼ã€‚<code>napi_coerce_to_bool</code> å…è®¸ä½ æŠŠè¿™äº›å€¼è½¬æ¢æˆä¸€ä¸ªç¡®åˆ‡çš„å¸ƒå°”å€¼ï¼Œè¿™æ ·ä½ å°±å¯ä»¥åœ¨ C æˆ– C++ ä»£ç ä¸­æ›´å®¹æ˜“åœ°æ ¹æ®è¿™ä¸ªå¸ƒå°”å€¼è¿›è¡Œé€»è¾‘å¤„ç†ã€‚</p><h3 id="ä½¿ç”¨-napi-coerce-to-bool" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-napi-coerce-to-bool"><span>ä½¿ç”¨ <code>napi_coerce_to_bool</code></span></a></h3><p>ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ Node.js çš„åŸç”Ÿæ¨¡å—ä¸­ï¼Œä½ å¯èƒ½æ¥æ”¶åˆ°äº†ä¸€ä¸ª JavaScript å€¼ï¼Œå¹¶å¸Œæœ›æ£€æŸ¥å®ƒæ˜¯å¦ä¸º &quot;truthy&quot; æˆ– &quot;falsy&quot;ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>napi_coerce_to_bool</code> æ¥æ‰§è¡Œè¿™ä¸ªæ“ä½œï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ `env` æ˜¯ napi_env ç±»å‹çš„å˜é‡ï¼Œä»£è¡¨N-APIç¯å¢ƒã€‚</span></span>
<span class="line"><span>// `value` æ˜¯ napi_value ç±»å‹çš„å˜é‡ï¼Œä»£è¡¨JavaScriptä¼ é€’ç»™åŸç”Ÿå‡½æ•°çš„å€¼ã€‚</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value result;</span></span>
<span class="line"><span>napi_status status = napi_coerce_to_bool(env, value, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ç°åœ¨ `result` åŒ…å«äº†è½¬æ¢åçš„å¸ƒå°”å€¼</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ<code>value</code> æ˜¯ä¸€ä¸ªä» JavaScript ä¼ è¿‡æ¥çš„ä»»æ„ç±»å‹çš„å€¼ï¼Œ<code>napi_coerce_to_bool</code> å‡½æ•°ä¼šå°è¯•å°†å…¶è½¬åŒ–ä¸ºä¸€ä¸ªå¸ƒå°”å€¼ã€‚è½¬æ¢ç»“æœå­˜æ”¾åœ¨ <code>result</code> ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ª <code>napi_value</code> ç±»å‹çš„å˜é‡ï¼Œå®ƒä»£è¡¨äº†ä¸€ä¸ª node.js ä¸­çš„å¸ƒå°”å€¼ã€‚</p><p>å¦‚æœè½¬æ¢æˆåŠŸï¼Œä½ å°±å¯ä»¥ç»§ç»­ä½¿ç”¨è¿™ä¸ªå¸ƒå°”å€¼è¿›è¡Œé€»è¾‘åˆ¤æ–­ã€‚å¦åˆ™ï¼Œå¦‚æœå‡ºç°äº†é”™è¯¯ï¼ˆæ¯”å¦‚ä¼ å…¥çš„ä¸æ˜¯æœ‰æ•ˆçš„ JavaScript å€¼ï¼‰ï¼Œ<code>status</code> å˜é‡ä¼šåŒ…å«è¡¨ç¤ºé”™è¯¯çŠ¶æ€çš„ä»£ç ï¼Œä½ å¯ä»¥æ ¹æ®è¿™ä¸ªæ¥è¿›è¡Œç›¸åº”çš„é”™è¯¯å¤„ç†ã€‚</p><h3 id="å®é™…è¿ç”¨ç¤ºä¾‹-3" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-3"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h3><p>å¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªéœ€è¦éªŒè¯ JavaScript å‚æ•°å¹¶åŸºäºè¯¥å‚æ•°å†³å®šè¡Œä¸ºçš„åŸç”Ÿæ¨¡å—ï¼Œä½ å¯èƒ½ä¼šåƒè¿™æ ·ä½¿ç”¨ <code>napi_coerce_to_bool</code>ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value MyNativeFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è½¬æ¢ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå¸ƒå°”å€¼</span></span>
<span class="line"><span>    napi_coerce_to_bool(env, args[0], &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åŸºäºå¸ƒå°”å€¼çš„ç»“æœæ‰§è¡Œä¸åŒçš„æ“ä½œ</span></span>
<span class="line"><span>    bool c_result;</span></span>
<span class="line"><span>    napi_get_value_bool(env, result, &amp;c_result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (c_result) {</span></span>
<span class="line"><span>        // å¦‚æœæ˜¯ true, æ‰§è¡ŒæŸäº›æ“ä½œ</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // å¦‚æœæ˜¯ false, æ‰§è¡Œå…¶ä»–æ“ä½œ</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›ä¸€äº›ç»“æœç»™ JavaScript ç«¯</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>MyNativeFunction</code> æ˜¯ä¸€ä¸ªä¼šè¢« JavaScript è°ƒç”¨çš„å‡½æ•°ã€‚æˆ‘ä»¬è·å–äº†è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ä¼ é€’çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆ<code>args[0]</code>ï¼‰ï¼Œå¹¶å°è¯•å°†å…¶å¼ºåˆ¶è½¬æ¢ä¸ºå¸ƒå°”å€¼ã€‚ç„¶åæˆ‘ä»¬æ ¹æ®è½¬æ¢å¾—åˆ°çš„å¸ƒå°”å€¼æ¥å†³å®šæ¥ä¸‹æ¥çš„è¡Œä¸ºï¼Œå¹¶æœ€ç»ˆè¿”å›ä¸€ä¸ªç»“æœç»™ JavaScriptã€‚</p><h3 id="napi-coerce-to-number" tabindex="-1"><a class="header-anchor" href="#napi-coerce-to-number"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_coerce_to_number" target="_blank" rel="noopener noreferrer">napi_coerce_to_number</a></span></a></h3><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIï¼Œå®ƒä¸ä¾èµ–äº JavaScript å¼•æ“ï¼ˆå¦‚ V8ï¼‰çš„å˜åŒ–ï¼Œå› æ­¤å¯ä»¥ä¿æŒå‘åå…¼å®¹æ€§ã€‚<code>napi_coerce_to_number</code> æ˜¯å…¶ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†ä»»ä½• JavaScript å€¼è½¬æ¢æˆæ•°å­—ç±»å‹ã€‚</p><p>åœ¨ JavaScript ä¸­ï¼Œä½ å¯ä»¥æœ‰å¾ˆå¤šä¸åŒç±»å‹çš„å€¼ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ã€å¯¹è±¡ç­‰ã€‚æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›æŠŠè¿™äº›å€¼è½¬æ¢æˆæ•°å­—è¿›è¡Œè®¡ç®—æˆ–æ¯”è¾ƒã€‚è¿™å°±æ˜¯ <code>napi_coerce_to_number</code> å‡½æ•°å­˜åœ¨çš„æ„ä¹‰ã€‚å½“ä½ åˆ›å»ºä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œå¹¶å¸Œæœ›æ¥å—ä¸€ä¸ª JavaScript å€¼å¹¶ç¡®ä¿å®ƒä¸ºæ•°å­—æ—¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šç‰¹åˆ«æœ‰ç”¨ã€‚</p><p><strong>ä¸¾å‡ ä¸ªä¾‹å­ï¼š</strong></p><ol><li><p><strong>å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—</strong><br> å‡è®¾ä½ åœ¨ JavaScript ä¸­è°ƒç”¨äº†ä¸€ä¸ªåŸç”Ÿæ’ä»¶çš„å‡½æ•°ï¼Œä¼ é€’äº†ä¸€ä¸ªè¡¨ç¤ºæ•°å­—çš„å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚ <code>&quot;123&quot;</code>ã€‚åœ¨åŸç”Ÿæ’ä»¶ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>napi_coerce_to_number</code> æ¥ç¡®ä¿ä½ å¾—åˆ°ä¸€ä¸ªæ•°å­—ç±»å‹çš„å€¼ã€‚</p></li><li><p><strong>å°†å¸ƒå°”å€¼è½¬æ¢ä¸ºæ•°å­—</strong><br> åœ¨ JavaScript ä¸­ï¼Œå¸ƒå°”å€¼ <code>true</code> å’Œ <code>false</code> å¯ä»¥è¢«éšå¼åœ°è½¬æ¢ä¸ºæ•°å­— <code>1</code> å’Œ <code>0</code>ã€‚å¦‚æœä½ ä¼ é€’äº†ä¸€ä¸ªå¸ƒå°”å€¼åˆ°åŸç”Ÿæ’ä»¶ï¼Œä½ å¯èƒ½éœ€è¦ä½¿ç”¨ <code>napi_coerce_to_number</code> æŠŠå®ƒè½¬æ¢ä¸ºæ•°å­—ï¼Œç„¶åå†è¿›è¡Œåç»­å¤„ç†ã€‚</p></li><li><p><strong>å¤„ç† uncertain ç±»å‹æ•°æ®</strong><br> å¦‚æœä½ çš„åŸç”Ÿæ’ä»¶åŠŸèƒ½æ˜¯åšæ•°å­¦è¿ç®—ï¼Œä½†ä½ ä¸ç¡®å®šç”¨æˆ·ä¼šä¼ é€’ä»€ä¹ˆç±»å‹çš„æ•°æ®ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>napi_coerce_to_number</code> æ¥å°è¯•å°†ä¼ å…¥çš„å€¼è½¬æ¢ä¸ºæ•°å­—ï¼Œè€Œä¸ç”¨æ‹…å¿ƒå®ƒå®é™…ä¸Šæ˜¯ä¸æ˜¯æ•°å­—ã€‚</p></li></ol><p><strong>ä»£ç ç¤ºä¾‹</strong>:</p><p>å‡è®¾æˆ‘ä»¬è¦ç¼–å†™ä¸€ä¸ªç®€å•çš„åŸç”Ÿæ’ä»¶å‡½æ•° <code>add</code>, å®ƒæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼ŒæŠŠå®ƒä»¬éƒ½è½¬æ¢ä¸ºæ•°å­—ï¼Œç„¶åç›¸åŠ ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value Add(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    size_t argc = 2;</span></span>
<span class="line"><span>    napi_value args[2];</span></span>
<span class="line"><span>    double value1, value2;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–JavaScriptä¼ é€’çš„å‚æ•°</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¼ºåˆ¶è½¬æ¢ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ•°å­—</span></span>
<span class="line"><span>    napi_value numberValue1;</span></span>
<span class="line"><span>    status = napi_coerce_to_number(env, args[0], &amp;numberValue1);</span></span>
<span class="line"><span>    status = napi_get_value_double(env, numberValue1, &amp;value1);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¼ºåˆ¶è½¬æ¢ç¬¬äºŒä¸ªå‚æ•°ä¸ºæ•°å­—</span></span>
<span class="line"><span>    napi_value numberValue2;</span></span>
<span class="line"><span>    status = napi_coerce_to_number(env, args[1], &amp;numberValue2);</span></span>
<span class="line"><span>    status = napi_get_value_double(env, numberValue2, &amp;value2);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ‰§è¡ŒåŠ æ³•è¿ç®—</span></span>
<span class="line"><span>    napi_value sum;</span></span>
<span class="line"><span>    status = napi_create_double(env, value1 + value2, &amp;sum);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return sum;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œæ³¨å†Œ `Add` å‡½æ•°</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value add_function;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, Add, NULL, &amp;add_function);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;add&quot;, add_function);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡ <code>napi_get_cb_info</code> è·å– JavaScript ä¼ é€’æ¥çš„å‚æ•°ï¼Œç„¶ååˆ†åˆ«ä½¿ç”¨ <code>napi_coerce_to_number</code> å°†è¿™ä¸¤ä¸ªå‚æ•°å¼ºåˆ¶è½¬æ¢ä¸ºæ•°å­—ã€‚éšåï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>napi_get_value_double</code> è·å–å®ƒä»¬çš„æ•°å€¼ï¼Œæ‰§è¡ŒåŠ æ³•æ“ä½œï¼Œå¹¶æœ€ç»ˆè¿”å›ç»“æœã€‚</p><p>è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ£€æŸ¥ <code>status</code> ç¡®ä¿æ¯æ­¥æ“ä½œéƒ½æˆåŠŸæ‰§è¡Œï¼Œä»¥åŠå¤„ç†å¯èƒ½å‡ºç°çš„é”™è¯¯ï¼Œä½†ä¸ºäº†ç®€æ˜èµ·è§ï¼Œè¿™é‡Œçœç•¥äº†è¿™äº›æ­¥éª¤ã€‚</p><h3 id="napi-coerce-to-object" tabindex="-1"><a class="header-anchor" href="#napi-coerce-to-object"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_coerce_to_object" target="_blank" rel="noopener noreferrer">napi_coerce_to_object</a></span></a></h3><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬è¯¦ç»†äº†è§£ä¸€ä¸‹ Node.js ä¸­çš„<code>napi_coerce_to_object</code>è¿™ä¸ªå‡½æ•°ã€‚</p><p>é¦–å…ˆï¼Œ<code>napi</code>ä»£è¡¨çš„æ˜¯ Node.js çš„åŸç”Ÿ API (N-API)ï¼Œå®ƒå…è®¸ä½ ç”¨ C æˆ– C++ç¼–å†™å¯åŠ è½½åˆ° Node.js ç¯å¢ƒä¸­çš„æ‰©å±•ã€‚è¿™æ ·åšçš„ä¼˜ç‚¹æ˜¯å¯ä»¥æ„å»ºæ€§èƒ½æ›´é«˜çš„æ¨¡å—ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥ä½¿ç”¨ç³»ç»Ÿçº§åˆ«çš„èµ„æºæˆ–è€…å…¶ä»–é JavaScript èµ„æºã€‚</p><p><code>napi_coerce_to_object</code>æ˜¯ N-API æä¾›çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†ä¸€ä¸ª JavaScript å€¼å¼ºåˆ¶è½¬æ¢æˆä¸€ä¸ª JavaScript å¯¹è±¡ã€‚åœ¨ JavaScript ä¸­ï¼ŒåŸºæœ¬ç±»å‹ï¼ˆå¦‚æ•°å­—ã€å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ï¼‰ä¸å¯¹è±¡æ˜¯æœ‰åŒºåˆ«çš„ã€‚ä½†æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å°†åŸºæœ¬ç±»å‹å½“ä½œå¯¹è±¡æ¥å¤„ç†ã€‚ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬æƒ³è°ƒç”¨æŸä¸ªåŸºæœ¬ç±»å‹çš„æ–¹æ³•æ—¶ï¼Œå°±éœ€è¦å°†å…¶è½¬ä¸ºå¯¹è±¡ã€‚</p><p>åœ¨ Node.js çš„ N-API ä¸­ï¼Œ<code>napi_coerce_to_object</code>å‡½æ•°å¯ä»¥å¸®åŠ©æˆ‘ä»¬åšè¿™æ ·çš„è½¬æ¢ã€‚è¿™ä¸ªå‡½æ•°çš„ç­¾åå¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_coerce_to_object(napi_env env, napi_value value, napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>env</code>ï¼šè¡¨ç¤ºå½“å‰çš„ N-API ç¯å¢ƒã€‚</li><li><code>value</code>ï¼šæ˜¯è¦è¢«è½¬æ¢çš„ JavaScript å€¼ã€‚</li><li><code>result</code>ï¼šæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘è½¬æ¢åçš„ JavaScript å¯¹è±¡ã€‚</li></ul><p>ç°åœ¨æˆ‘æ¥ä¸¾å‡ ä¸ªå®ä¾‹è¯´æ˜å®ƒçš„ä½¿ç”¨ï¼š</p><h3 id="å®ä¾‹-1-å°†æ•°å­—è½¬æ¢ä¸ºå¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#å®ä¾‹-1-å°†æ•°å­—è½¬æ¢ä¸ºå¯¹è±¡"><span>å®ä¾‹ 1ï¼šå°†æ•°å­—è½¬æ¢ä¸ºå¯¹è±¡</span></a></h3><p>å‡è®¾åœ¨ JavaScript ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæ•°å­— 3.14ï¼Œæˆ‘ä»¬æƒ³è°ƒç”¨å®ƒçš„<code>toFixed()</code>æ–¹æ³•ï¼Œå°†å®ƒæ ¼å¼åŒ–ä¸º 2 ä½å°æ•°çš„å­—ç¬¦ä¸²ã€‚åœ¨çº¯ JavaScript æ“ä½œä¸­ï¼Œä½ å¯ä»¥ç›´æ¥è°ƒç”¨<code>3.14.toFixed(2)</code>ï¼Œè€Œåœ¨ C++æ‰©å±•ä¸­ï¼Œå¦‚æœä½ æ‹¥æœ‰çš„æ˜¯ä¸€ä¸ª<code>napi_value</code>ç±»å‹çš„æ•°å­—ï¼Œä½ å¯èƒ½éœ€è¦å…ˆå°†å®ƒè½¬ä¸ºå¯¹è±¡æ‰èƒ½å¯¹å…¶è¿›è¡Œæ“ä½œã€‚</p><p>åœ¨ C++æ‰©å±•ä¸­çš„ä»£ç å¯èƒ½ä¼šåƒè¿™æ ·ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status status;</span></span>
<span class="line"><span>napi_value number_value;</span></span>
<span class="line"><span>napi_value number_object;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾number_valueå·²ç»æ˜¯ä¸€ä¸ªåŒ…å«æ•°å­—3.14çš„napi_value</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ç°åœ¨å°†è¿™ä¸ªæ•°å­—å¼ºåˆ¶è½¬æ¢ä¸ºJSå¯¹è±¡</span></span>
<span class="line"><span>status = napi_coerce_to_object(env, number_value, &amp;number_object);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (status == napi_ok) {</span></span>
<span class="line"><span>    // è½¬æ¢æˆåŠŸï¼Œnumber_objectç°åœ¨æ˜¯ä¸€ä¸ªå°è£…äº†æ•°å­—3.14çš„JSå¯¹è±¡</span></span>
<span class="line"><span>} else {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å®ä¾‹-2-å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#å®ä¾‹-2-å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡"><span>å®ä¾‹ 2ï¼šå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡</span></a></h3><p>åŒç†ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ª JavaScript çš„å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”ä½ å¸Œæœ›ä»¥å¯¹è±¡çš„å½¢å¼å·¥ä½œäºå®ƒï¼Œæ¯”å¦‚è·å–å­—ç¬¦é•¿åº¦æˆ–è€…ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œåˆ™å¯ä»¥ä½¿ç”¨<code>napi_coerce_to_object</code>å°†å…¶è½¬ä¸ºå¯¹è±¡ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status status;</span></span>
<span class="line"><span>napi_value string_value;</span></span>
<span class="line"><span>napi_value string_object;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾string_valueå·²ç»æ˜¯ä¸€ä¸ªåŒ…å«å­—ç¬¦ä¸²&quot;hello&quot;çš„napi_value</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ç°åœ¨å°†è¿™ä¸ªå­—ç¬¦ä¸²å¼ºåˆ¶è½¬æ¢ä¸ºJSå¯¹è±¡</span></span>
<span class="line"><span>status = napi_coerce_to_object(env, string_value, &amp;string_object);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (status == napi_ok) {</span></span>
<span class="line"><span>    // è½¬æ¢æˆåŠŸï¼Œstring_objectç°åœ¨æ˜¯ä¸€ä¸ªå°è£…äº†å­—ç¬¦ä¸²&quot;hello&quot;çš„JSå¯¹è±¡</span></span>
<span class="line"><span>} else {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ€»ä¹‹ï¼Œ<code>napi_coerce_to_object</code>å‡½æ•°åœ¨ä½ éœ€è¦å°† N-API ä¸­çš„åŸºæœ¬ç±»å‹è½¬æ¢ä¸º JavaScript å¯¹è±¡æ—¶éå¸¸æœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯å½“ä½ éœ€è¦å¯¹è¿™äº›å€¼æ‰§è¡Œä¸€äº›åªæœ‰å¯¹è±¡æ‰èƒ½æ‰§è¡Œçš„æ“ä½œï¼ˆå¦‚è°ƒç”¨æ–¹æ³•æˆ–è®¿é—®å±æ€§ï¼‰æ—¶ã€‚é€šè¿‡ä¸Šè¿°ä¾‹å­ï¼Œæˆ‘å¸Œæœ›ä½ èƒ½æ›´å¥½åœ°ç†è§£è¿™ä¸ªå‡½æ•°çš„ä½œç”¨å’Œå¦‚ä½•åœ¨å®é™…ä¸­ä½¿ç”¨å®ƒã€‚</p><h3 id="napi-coerce-to-string" tabindex="-1"><a class="header-anchor" href="#napi-coerce-to-string"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_coerce_to_string" target="_blank" rel="noopener noreferrer">napi_coerce_to_string</a></span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œ<code>napi_coerce_to_string</code>æ˜¯ N-API æ¡†æ¶çš„ä¸€éƒ¨åˆ†ï¼ŒN-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶çš„ APIã€‚<code>napi_coerce_to_string</code>è¿™ä¸ªå‡½æ•°è¢«ç”¨æ¥å°†å…¶ä»–ç±»å‹çš„å˜é‡è½¬æ¢ä¸ºå­—ç¬¦ä¸²ç±»å‹ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œå½“ä½ åœ¨ç¼–å†™æœ¬åœ°æ’ä»¶æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°éœ€è¦å¤„ç†æ¥è‡ª JavaScript å±‚é¢çš„å„ç§ç±»å‹çš„æ•°æ®ï¼Œä¾‹å¦‚æ•°å­—ã€å¸ƒå°”å€¼æˆ–è€…å¯¹è±¡ã€‚æœ‰æ—¶å€™ï¼Œä¸ºäº†æ“ä½œæ–¹ä¾¿æˆ–è€…æ»¡è¶³ç‰¹å®šçš„éœ€æ±‚ï¼Œä½ éœ€è¦å°†è¿™äº›æ•°æ®è½¬æ¢æˆå­—ç¬¦ä¸²ã€‚</p><p><code>napi_coerce_to_string</code>å‡½æ•°å°±æ˜¯ç”¨äºæ‰§è¡Œè¿™ç§è½¬æ¢çš„ã€‚å½“ä½ è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ª N-API å€¼ï¼ˆä»£è¡¨ä»»æ„ JavaScript å€¼ï¼‰ï¼Œå®ƒä¼šå°è¯•æŠŠè¿™ä¸ªå€¼è½¬æ¢ä¸ºä¸€ä¸ª N-API å­—ç¬¦ä¸²ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨<code>napi_coerce_to_string</code>çš„ä¾‹å­ï¼š</p><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js æœ¬åœ°æ’ä»¶ï¼Œè¯¥æ’ä»¶æä¾›äº†ä¸€ä¸ªæ–¹æ³•<code>printValueAsString</code>ï¼Œè¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œå¹¶å°†å…¶æ‰“å°å‡ºæ¥ï¼Œä½†æ˜¯æ— è®ºä¼ å…¥å‚æ•°çš„å®é™…ç±»å‹å¦‚ä½•ï¼Œéƒ½è¦ä½œä¸ºå­—ç¬¦ä¸²è¿›è¡Œæ‰“å°ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯æˆ‘ä»¬å°†è¦æ³¨å†Œçš„Nativeæ–¹æ³•</span></span>
<span class="line"><span>napi_value PrintValueAsString(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–JavaScriptä¼ é€’ç»™è¯¥æ–¹æ³•çš„å‚æ•°</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†å‚æ•°å¼ºåˆ¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²</span></span>
<span class="line"><span>    napi_coerce_to_string(env, args[0], &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å‡è®¾æˆ‘ä»¬æƒ³è¦æ‰“å°è½¬æ¢åçš„å­—ç¬¦ä¸²</span></span>
<span class="line"><span>    // é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥ä»napi_valueæå–Cå­—ç¬¦ä¸²ï¼Œç„¶åä½¿ç”¨printf</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return result; // è¿”å›è½¬åŒ–åçš„å­—ç¬¦ä¸²</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œæ³¨å†Œæˆ‘ä»¬çš„nativeæ–¹æ³•</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, PrintValueAsString, NULL, &amp;fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è®¾ç½®å¯¼å‡ºå¯¹è±¡çš„å±æ€§</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;printValueAsString&quot;, fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œæ¨¡å—</span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ JavaScript ä¸­ä½¿ç”¨è¿™ä¸ªæ’ä»¶å¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/native-addon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printValueAsString</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">123</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // æ‰“å°: &#39;123&#39;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printValueAsString</span><span style="color:#D8DEE9FF;">(</span><span style="color:#81A1C1;">true</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // æ‰“å°: &#39;true&#39;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printValueAsString</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> foo</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">bar</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // æ‰“å°: &#39;[object Object]&#39; æˆ–è€…æ›´å…·ä½“çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œè¿™å–å†³äºå¯¹è±¡çš„toString()æ–¹æ³•</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œä¸ç®¡æˆ‘ä»¬ä¼ ç»™<code>printValueAsString</code>å‡½æ•°ä»€ä¹ˆç±»å‹çš„å‚æ•°ï¼Œå®ƒéƒ½ä¼šå°è¯•å°†å…¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²å†è¿”å›ã€‚è¿™å°±æ˜¯<code>napi_coerce_to_string</code>åœ¨å®é™…åº”ç”¨ä¸­çš„ä¸€ä¸ªå…¸å‹ç”¨æ³•ã€‚</p><h3 id="napi-typeof" tabindex="-1"><a class="header-anchor" href="#napi-typeof"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_typeof" target="_blank" rel="noopener noreferrer">napi_typeof</a></span></a></h3><p><code>napi_typeof</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå±äº N-APIï¼ˆNode.js APIï¼‰çš„ä¸€éƒ¨åˆ†ã€‚N-API æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºåŸç”Ÿæ’ä»¶çš„ APIï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨ C æˆ– C++ ä»£ç ç¼–å†™å¯ç›´æ¥ä¸ JavaScript äº¤äº’çš„æ‰©å±•ã€‚</p><p>åœ¨è§£é‡Š <code>napi_typeof</code> ä¹‹å‰ï¼Œæˆ‘ä»¬å¾—å…ˆç†è§£ JavaScript ä¸­çš„ç±»å‹ç³»ç»Ÿã€‚JavaScript æ˜¯ä¸€ç§åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œè¿™æ„å‘³ç€å˜é‡æ²¡æœ‰å›ºå®šçš„ç±»å‹ï¼ŒåŒä¸€ä¸ªå˜é‡å¯ä»¥è¢«èµ‹äºˆä¸åŒç±»å‹çš„å€¼ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå˜é‡å¯ä»¥å¼€å§‹æ—¶æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œç„¶ååˆè¢«èµ‹å€¼ä¸ºå­—ç¬¦ä¸²ã€‚ä½†åœ¨åº•å±‚ï¼ŒJavaScript å¼•æ“éœ€è¦çŸ¥é“ä¸€ä¸ªå€¼å…·ä½“æ˜¯ä»€ä¹ˆç±»å‹çš„æ•°æ®ã€‚</p><p>å½“å¼€å‘è€…ä½¿ç”¨ N-API ç¼–å†™åŸç”Ÿæ’ä»¶æ—¶ï¼Œä»–ä»¬ç»å¸¸éœ€è¦çŸ¥é“ä» JavaScript ä»£ç ä¼ é€’è¿‡æ¥çš„å€¼æ˜¯ä»€ä¹ˆç±»å‹ã€‚è¿™æ—¶å€™ <code>napi_typeof</code> å‡½æ•°å°±æ´¾ä¸Šç”¨åœºäº†ã€‚è¿™ä¸ªå‡½æ•°å¯ä»¥å¸®åŠ©å¼€å‘è€…ç¡®å®šä¸€ä¸ªç»™å®šçš„ <code>napi_value</code>ï¼ˆè¡¨ç¤º JavaScript å€¼çš„ C ç±»å‹ï¼‰æ˜¯å“ªç§ JavaScript æ•°æ®ç±»å‹ã€‚</p><p>ä¸‹é¢æ˜¯å‡ ä¸ªæ•°æ®ç±»å‹çš„ä¾‹å­ï¼š</p><ul><li>Number: è¡¨ç¤ºæ•°å­—ï¼Œæ¯”å¦‚ <code>42</code> æˆ– <code>3.14159</code>ã€‚</li><li>String: è¡¨ç¤ºæ–‡æœ¬ï¼Œæ¯”å¦‚ <code>&quot;hello world&quot;</code>ã€‚</li><li>Boolean: è¡¨ç¤ºé€»è¾‘çœŸæˆ–å‡ï¼Œå³ <code>true</code> æˆ– <code>false</code>ã€‚</li><li>Object: è¡¨ç¤ºå¯¹è±¡ï¼Œå¯ä»¥åŒ…å«å¤šä¸ªé”®å€¼å¯¹ã€‚</li><li>Function: è¡¨ç¤ºå‡½æ•°ï¼Œå¯ä»¥è¢«è°ƒç”¨ã€‚</li></ul><p>è€Œ <code>napi_typeof</code> å‡½æ•°æ­£æ˜¯ç”¨æ¥æ£€æŸ¥è¿™äº›ç±»å‹ã€‚</p><p>ä¸¾ä¸ªå®é™…ä¾‹å­ï¼Œå‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œè¯¥æ’ä»¶æä¾›äº†ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œå¹¶æ ¹æ®è¿™ä¸ªå‚æ•°çš„ç±»å‹æ‰§è¡Œä¸åŒçš„æ“ä½œï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯ä¸€ä¸ª N-API è°ƒç”¨çš„ä¾‹å­</span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å– JavaScript ä¼ å…¥çš„å‚æ•°</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥å‚æ•°çš„ç±»å‹</span></span>
<span class="line"><span>    napi_valuetype arg_type;</span></span>
<span class="line"><span>    napi_typeof(env, args[0], &amp;arg_type);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (arg_type == napi_string) {</span></span>
<span class="line"><span>        // å‚æ•°æ˜¯å­—ç¬¦ä¸²</span></span>
<span class="line"><span>        // ... å¤„ç†å­—ç¬¦ä¸²é€»è¾‘ ...</span></span>
<span class="line"><span>    } else if (arg_type == napi_number) {</span></span>
<span class="line"><span>        // å‚æ•°æ˜¯æ•°å­—</span></span>
<span class="line"><span>        // ... å¤„ç†æ•°å­—é€»è¾‘ ...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    // ... å…¶ä»–ç±»å‹çš„å¤„ç† ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›ä¸€ä¸ª JavaScript çš„ undefined å€¼</span></span>
<span class="line"><span>    napi_value undefined_value;</span></span>
<span class="line"><span>    napi_get_undefined(env, &amp;undefined_value);</span></span>
<span class="line"><span>    return undefined_value;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>//æ–‡æ›¸ã¯æ¡œèŒ¶ã‹ã‚‰æ¥ã¦ã„ã¾ã™ã€‚å•†ç”¨ç›®çš„ã§ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚</span></span>
<span class="line"><span>// æ³¨å†Œå‡½æ•°åˆ° N-API</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, MyFunction, NULL, &amp;fn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;myFunction&quot;, fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡ <code>napi_get_cb_info</code> è·å–åˆ° JavaScript ä¼ é€’ç»™è¿™ä¸ªå‡½æ•°çš„å‚æ•°ã€‚ç„¶åæˆ‘ä»¬ä½¿ç”¨ <code>napi_typeof</code> æ¥åˆ¤æ–­è¿™ä¸ªå‚æ•°çš„ç±»å‹æ˜¯å¦ä¸ºå­—ç¬¦ä¸²ï¼ˆ<code>napi_string</code>ï¼‰æˆ–æ•°å­—ï¼ˆ<code>napi_number</code>ï¼‰ã€‚æ ¹æ®å‚æ•°çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥å†³å®šæ‰§è¡Œä¸åŒçš„ä»£ç é€»è¾‘ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬çš„å‡½æ•°è¿”å›äº†ä¸€ä¸ª <code>undefined</code> å€¼ç»™ JavaScript ç¯å¢ƒï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰æŒ‡å®šå…¶ä»–çš„è¿”å›å€¼ã€‚</p><p>é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œ<code>napi_typeof</code> è®©æˆ‘ä»¬èƒ½å¤Ÿåœ¨åŸç”Ÿæ’ä»¶ä¸­æ›´å¥½åœ°ä¸ JavaScript äº¤äº’ï¼Œå¹¶å®‰å…¨åœ°å¤„ç†ä¸åŒç±»å‹çš„æ•°æ®ã€‚</p><h3 id="napi-instanceof" tabindex="-1"><a class="header-anchor" href="#napi-instanceof"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_instanceof" target="_blank" rel="noopener noreferrer">napi_instanceof</a></span></a></h3><p><code>napi_instanceof</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ª N-API å‡½æ•°ï¼Œå®ƒç”¨æ¥åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æ˜¯æŸä¸ªæ„é€ å‡½æ•°çš„å®ä¾‹ã€‚N-API æ˜¯ä¸€ä¸ª C å±‚é¢çš„ APIï¼Œå…è®¸åŸç”Ÿæ’ä»¶ä¸ Node.js è¿›è¡Œäº¤äº’ï¼Œä¸å—åˆ°ç‰¹å®šç‰ˆæœ¬ Node.js çš„é™åˆ¶ã€‚</p><p>è¦ç†è§£ <code>napi_instanceof</code>ï¼Œé¦–å…ˆå¾—çŸ¥é“ JavaScript ä¸­çš„ <code>instanceof</code> æ“ä½œç¬¦åšä»€ä¹ˆã€‚åœ¨ JavaScript ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>instanceof</code> æ¥æ£€æŸ¥ä¸€ä¸ªå¯¹è±¡æ˜¯å¦ä¸ºç‰¹å®šæ„é€ å‡½æ•°åˆ›å»ºçš„å®ä¾‹ï¼Œä¾‹å¦‚ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> Car</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">make</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> model</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">make</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> make</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">  this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">model</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> model</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> myCar</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Car</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Toyota</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Corolla</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">myCar</span><span style="color:#81A1C1;"> instanceof</span><span style="color:#D8DEE9FF;"> Car)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºï¼štrue</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">myCar</span><span style="color:#81A1C1;"> instanceof</span><span style="color:#D8DEE9FF;"> Object)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºï¼štrue</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">myCar</span><span style="color:#81A1C1;"> instanceof</span><span style="color:#D8DEE9FF;"> Array)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºï¼šfalse</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ<code>myCar</code> æ˜¯ä½¿ç”¨ <code>Car</code> æ„é€ å‡½æ•°åˆ›å»ºçš„ï¼Œæ‰€ä»¥ <code>myCar instanceof Car</code> è¿”å› <code>true</code>ã€‚ç”±äºæ‰€æœ‰çš„ JavaScript å¯¹è±¡éƒ½é»˜è®¤ç»§æ‰¿è‡ª <code>Object</code>ï¼Œ<code>myCar instanceof Object</code> ä¹Ÿè¿”å› <code>true</code>ã€‚ä½†æ˜¯ <code>myCar</code> ä¸æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥ <code>myCar instanceof Array</code> è¿”å› <code>false</code>ã€‚</p><p>ç°åœ¨ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ Node.js çš„ N-API ç¼–å†™æœ¬åœ°æ’ä»¶æ—¶ï¼Œæˆ‘ä»¬ä¼šç”¨åˆ° C æˆ–è€… C++ã€‚åœ¨è¿™äº›è¯­è¨€ä¸­ï¼Œä½ ä¸èƒ½ç›´æ¥ä½¿ç”¨ JavaScript çš„ <code>instanceof</code> æ“ä½œç¬¦ã€‚è€Œæ˜¯éœ€è¦ä½¿ç”¨ <code>napi_instanceof</code> å‡½æ•°æ¥å®Œæˆç›¸åŒçš„ä»»åŠ¡ã€‚</p><p><code>napi_instanceof</code> å‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_instanceof(napi_env env,</span></span>
<span class="line"><span>                            napi_value object,</span></span>
<span class="line"><span>                            napi_value constructor,</span></span>
<span class="line"><span>                            bool* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œçš„å‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li><code>env</code>: <code>napi_env</code> ç±»å‹ï¼Œä»£è¡¨ Node.js çš„è¿è¡Œç¯å¢ƒï¼Œé€šè¿‡è¿™ä¸ªç¯å¢ƒå¯ä»¥è¿›è¡Œ API è°ƒç”¨ã€‚</li><li><code>object</code>: <code>napi_value</code> ç±»å‹ï¼Œè¦æ£€æŸ¥çš„ JavaScript å¯¹è±¡ã€‚</li><li><code>constructor</code>: <code>napi_value</code> ç±»å‹ï¼Œç”¨ä½œæ¯”è¾ƒçš„æ„é€ å‡½æ•°ã€‚</li><li><code>result</code>: <code>bool*</code> ç±»å‹ï¼ŒæŒ‡å‘å¸ƒå°”å€¼çš„æŒ‡é’ˆï¼Œå‡½æ•°è°ƒç”¨åï¼Œè¯¥ä½ç½®çš„å€¼ä¼šæ›´æ–°ä¸ºæ£€æŸ¥ç»“æœï¼ˆ<code>true</code> æˆ– <code>false</code>ï¼‰ã€‚</li></ul><p>å½“ä½ è°ƒç”¨ <code>napi_instanceof</code> åï¼Œå¦‚æœ <code>object</code> æ˜¯ <code>constructor</code> çš„å®ä¾‹ï¼Œ<code>result</code> æ‰€æŒ‡å‘çš„å¸ƒå°”å€¼å°†è¢«è®¾ç½®ä¸º <code>true</code>ï¼Œå¦åˆ™ä¸º <code>false</code>ã€‚</p><p>è®©æˆ‘ä»¬ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬å·²ç»æœ‰äº† <code>Car</code> æ„é€ å‡½æ•°å’Œä¸€ä¸ª <code>carObject</code> å®ä¾‹ï¼Œæˆ‘ä»¬æƒ³åœ¨ C/C++ çš„ N-API æ’ä»¶ä¸­æ£€æŸ¥å®ƒï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾åœ¨æŸå¤„å®šä¹‰äº† carObject å’Œ CarConstructor çš„ napi_value</span></span>
<span class="line"><span></span></span>
<span class="line"><span>bool isInstanceOf;</span></span>
<span class="line"><span>napi_status status = napi_instanceof(env, carObject, CarConstructor, &amp;isInstanceOf);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (status == napi_ok &amp;&amp; isInstanceOf) {</span></span>
<span class="line"><span>    // carObject æ˜¯ CarConstructor åˆ›å»ºçš„å®ä¾‹</span></span>
<span class="line"><span>} else {</span></span>
<span class="line"><span>    // carObject ä¸æ˜¯ CarConstructor åˆ›å»ºçš„å®ä¾‹æˆ–è€…æ£€æŸ¥å¤±è´¥</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šè¿° C ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ£€æŸ¥ <code>carObject</code> æ˜¯å¦æ˜¯ <code>CarConstructor</code> çš„å®ä¾‹ï¼Œå¹¶æ ¹æ®ç»“æœæ‰§è¡Œç›¸åº”æ“ä½œã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>napi_instanceof</code> å…è®¸ä½ åœ¨ç¼–å†™ Node.js åŸç”Ÿæ’ä»¶æ—¶ï¼Œåœ¨ C/C++ ä»£ç ä¸­æ‰§è¡Œä¸ JavaScript ä¸­ <code>instanceof</code> ç±»ä¼¼çš„æ“ä½œã€‚é€šè¿‡ N-APIï¼Œä½ èƒ½å¤Ÿå®‰å…¨åœ°è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œä»è€Œä¿è¯ä½ çš„æ’ä»¶å¯ä»¥æ­£ç¡®å¤„ç†ä¼ å…¥çš„ JavaScript å¯¹è±¡ã€‚</p><h3 id="napi-is-array" tabindex="-1"><a class="header-anchor" href="#napi-is-array"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_is_array" target="_blank" rel="noopener noreferrer">napi_is_array</a></span></a></h3><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚åŸç”Ÿæ’ä»¶æ˜¯æŒ‡ç›´æ¥ä½¿ç”¨ Cã€C++ç­‰è¯­è¨€ç¼–å†™ï¼Œç„¶åå¯ä»¥åœ¨ Node.js ä»£ç ä¸­è°ƒç”¨çš„æ¨¡å—ã€‚è¿™ä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿåœ¨æ€§èƒ½å…³é”®çš„åœºåˆä¸‹åˆ©ç”¨æœ¬åœ°åº“çš„é«˜æ•ˆæ€§èƒ½ã€‚</p><p><code>napi_is_array</code> æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæä¾›äº†ä¸€ç§æ–¹æ³•æ¥ç¡®å®šä¸€ä¸ª <code>napi_value</code> æ˜¯å¦è¡¨ç¤ºä¸€ä¸ª JavaScript æ•°ç»„ã€‚<code>napi_value</code> æ˜¯ N-API ä¸­ç”¨æ¥è¡¨ç¤º JavaScript å€¼çš„ä¸€ä¸ªæŠ½è±¡ç±»å‹ï¼Œä¸ç®¡è¿™ä¸ªå€¼æ˜¯æ•°å­—ã€å¯¹è±¡ã€å‡½æ•°è¿˜æ˜¯æ•°ç»„ã€‚</p><p>ä¸‹é¢çš„æ­¥éª¤å°†ä¼šè¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨åŸç”Ÿæ’ä»¶ä¸­ä½¿ç”¨ <code>napi_is_array</code> å‡½æ•°ï¼Œå¹¶ä¸”ç»™å‡ºä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><h3 id="ä½¿ç”¨-napi-is-array-å‡½æ•°çš„æ­¥éª¤" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-napi-is-array-å‡½æ•°çš„æ­¥éª¤"><span>ä½¿ç”¨ <code>napi_is_array</code> å‡½æ•°çš„æ­¥éª¤</span></a></h3><ol><li><p><strong>è·å– napi_env</strong>ï¼šä¸ºäº†ä½¿ç”¨ä»»æ„ N-API å‡½æ•°ï¼Œä½ éœ€è¦æœ‰ä¸€ä¸ª <code>napi_env</code> ç¯å¢ƒå˜é‡ã€‚è¿™ä¸ªç¯å¢ƒå˜é‡é€šå¸¸æ˜¯ä½œä¸ºåŸç”Ÿå‡½æ•°çš„å‚æ•°ä¼ å…¥çš„ï¼Œä»£è¡¨å½“å‰çš„ Node.js è¿è¡Œæ—¶ç¯å¢ƒã€‚</p></li><li><p><strong>å‡†å¤‡ napi_value</strong>ï¼šä½ éœ€è¦æ‹¥æœ‰æˆ–å¾—åˆ°ä¸€ä¸ª <code>napi_value</code>ï¼Œå®ƒä»£è¡¨æƒ³è¦æ£€æŸ¥çš„ JavaScript å€¼ã€‚</p></li><li><p><strong>è°ƒç”¨ napi_is_array</strong>ï¼šä½¿ç”¨ <code>napi_is_array</code> æ¥åˆ¤æ–­è¿™ä¸ª <code>napi_value</code> æ˜¯å¦è¡¨ç¤ºä¸€ä¸ªæ•°ç»„ã€‚å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼æ¥å‘ŠçŸ¥ä½ ç»“æœã€‚</p></li><li><p><strong>å¤„ç†ç»“æœ</strong>ï¼šæ ¹æ®è¿”å›çš„å¸ƒå°”å€¼ï¼Œæ‰§è¡Œç›¸åº”çš„é€»è¾‘ã€‚</p></li></ol><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-6" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-6"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h3><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°éœ€è¦æ£€æŸ¥ä¼ å…¥çš„ JavaScript å‚æ•°æ˜¯å¦ä¸ºæ•°ç»„ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å®šä¹‰ä¸€ä¸ªåŸç”Ÿå‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªå‚æ•°å¹¶åˆ¤æ–­è¿™ä¸ªå‚æ•°æ˜¯å¦ä¸ºæ•°ç»„ã€‚</span></span>
<span class="line"><span>napi_value IsArray(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // å®šä¹‰å¿…è¦çš„å˜é‡</span></span>
<span class="line"><span>    napi_value argv[1]; // ç”¨äºå­˜æ”¾å‚æ•°çš„æ•°ç»„</span></span>
<span class="line"><span>    size_t argc = 1;    // å‚æ•°çš„æ•°é‡</span></span>
<span class="line"><span>    bool is_array = false;</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è§£æå‚æ•°</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, argv, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è°ƒç”¨ napi_is_array åˆ¤æ–­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦ä¸ºæ•°ç»„</span></span>
<span class="line"><span>    napi_is_array(env, argv[0], &amp;is_array);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ ¹æ® is_array çš„å€¼åˆ›å»ºä¸€ä¸ª JavaScript å¸ƒå°”å€¼</span></span>
<span class="line"><span>    napi_get_boolean(env, is_array, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›è¿™ä¸ªå¸ƒå°”å€¼</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ¨¡å—åˆå§‹åŒ–å‡½æ•°</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    // å®šä¹‰ä¸€ä¸ªå±æ€§æè¿°ç¬¦ï¼Œè®© JavaScript èƒ½å¤Ÿè°ƒç”¨ IsArray å‡½æ•°</span></span>
<span class="line"><span>    napi_property_descriptor desc = { &quot;isArray&quot;, 0, IsArray, 0, 0, 0, napi_default, 0 };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°† IsArray å‡½æ•°ç»‘å®šåˆ°å¯¼å‡ºå¯¹è±¡ä¸Š</span></span>
<span class="line"><span>    napi_define_properties(env, exports, 1, &amp;desc);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å®šä¹‰æ¨¡å—</span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ C ä»£ç ç¤ºä¾‹å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>IsArray</code> çš„å‡½æ•°ï¼Œå®ƒæ£€æŸ¥ä¼ å…¥çš„å‚æ•°æ˜¯å¦ä¸ºæ•°ç»„ï¼Œå¹¶è¿”å› true æˆ– falseã€‚è¿™ä¸ªå‡½æ•°ä¹‹åè¢«æš´éœ²ç»™ JavaScript ä»£ç ï¼Œå› æ­¤ JavaScript ä»£ç å¯ä»¥åƒè°ƒç”¨æ™®é€šçš„ JavaScript å‡½æ•°é‚£æ ·è°ƒç”¨å®ƒã€‚</p><p>JavaScript ä»£ç å¯èƒ½é•¿è¿™æ ·ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/native-addon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">isArray</span><span style="color:#D8DEE9FF;">([</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 3</span><span style="color:#D8DEE9FF;">]))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºï¼štrue</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">isArray</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> foo</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">bar</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºï¼šfalse</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ JavaScript ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡ <code>require</code> å¼•å…¥äº†æ„å»ºå¥½çš„åŸç”Ÿæ’ä»¶æ¨¡å—ã€‚ç„¶åæˆ‘ä»¬è°ƒç”¨äº† <code>nativeAddon.isArray</code> æ–¹æ³•ï¼Œå¹¶å‘å®ƒä¼ é€’äº†ä¸åŒç±»å‹çš„å‚æ•°è¿›è¡Œæµ‹è¯•ã€‚</p><p>é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œæˆ‘ä»¬å®ç°äº†ä» JavaScript åˆ°åŸç”Ÿä»£ç å†å›åˆ° JavaScript çš„é€šä¿¡å’Œæ“ä½œï¼Œè€Œ <code>napi_is_array</code> åœ¨æ­¤è¿‡ç¨‹ä¸­æ‰®æ¼”äº†åˆ¤æ–­æ•°ç»„çš„å…³é”®è§’è‰²ã€‚</p><h3 id="napi-is-arraybuffer" tabindex="-1"><a class="header-anchor" href="#napi-is-arraybuffer"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_is_arraybuffer" target="_blank" rel="noopener noreferrer">napi_is_arraybuffer</a></span></a></h3><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œæ—¶ï¼Œå®ƒå…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚N-APIï¼ˆNode.js APIï¼‰æ˜¯ Node.js æä¾›çš„ä¸€å¥—ç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIï¼Œä½¿å¾—ä½ å¯ä»¥ç”¨ C æˆ– C++ è¯­è¨€æ¥å†™æ‰©å±•æ¨¡å—ï¼Œå¹¶ä¸”è¿™äº›æ¨¡å—åœ¨ Node.js çš„ä¸åŒç‰ˆæœ¬ä¸­ä¿æŒå…¼å®¹ã€‚</p><p><code>napi_is_arraybuffer</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒç”¨æ¥æ£€æŸ¥ä¸€ä¸ªç»™å®šçš„ <code>napi_value</code> æ˜¯å¦æ˜¯ä¸€ä¸ª ArrayBufferã€‚ArrayBuffer æ˜¯ JavaScript ä¸­çš„ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œç”¨äºè¡¨ç¤ºé€šç”¨çš„ã€å›ºå®šé•¿åº¦çš„åŸå§‹äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºã€‚ä½ ä¸èƒ½ç›´æ¥æ“ä½œ ArrayBuffer çš„å†…å®¹ï¼›ç›¸åï¼Œä½ ä½¿ç”¨ç±»å‹åŒ–æ•°ç»„æˆ– DataView å¯¹è±¡æ¥å¤„ç†åŸå§‹ç¼“å†²åŒºçš„æ•°æ®ã€‚</p><p>è¿™é‡Œæ˜¯ <code>napi_is_arraybuffer</code> å‡½æ•°çš„ç®€è¦è¯´æ˜ï¼š</p><ul><li>å‚æ•°ï¼šè¯¥å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç¯å¢ƒå¥æŸ„ <code>env</code>ï¼Œå®ƒä»£è¡¨äº†å½“å‰çš„ N-API è°ƒç”¨ç¯å¢ƒã€‚ç¬¬äºŒä¸ªå‚æ•° <code>value</code> æ˜¯è¦æ£€æŸ¥çš„ <code>napi_value</code>ã€‚</li><li>è¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œé€šè¿‡ç¬¬ä¸‰ä¸ªå‚æ•° <code>result</code> è¿”å›ã€‚å¦‚æœ <code>value</code> æ˜¯ä¸€ä¸ª ArrayBufferï¼Œåˆ™ <code>*result</code> è®¾ç½®ä¸º <code>true</code>ï¼›å¦åˆ™è®¾ç½®ä¸º <code>false</code>ã€‚</li></ul><p>å®é™…åº”ç”¨ç¤ºä¾‹ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åŸç”Ÿæ’ä»¶ï¼Œéœ€è¦æ£€æŸ¥ä» JavaScript ä¼ é€’è¿‡æ¥çš„å‚æ•°æ˜¯å¦æ˜¯ä¸€ä¸ª ArrayBufferã€‚</p><p>C/C++ ä»£ç ç¤ºä¾‹:</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... å…¶ä»–å¿…è¦çš„åˆå§‹åŒ–ä»£ç  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CheckIfArrayBuffer(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  size_t argc = 1;</span></span>
<span class="line"><span>  napi_value args[1];</span></span>
<span class="line"><span>  napi_value returnValue;</span></span>
<span class="line"><span>  bool is_arraybuffer;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è§£æå‚æ•°</span></span>
<span class="line"><span>  napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ£€æŸ¥ args[0] æ˜¯å¦æ˜¯ ArrayBuffer</span></span>
<span class="line"><span>  napi_status status = napi_is_arraybuffer(env, args[0], &amp;is_arraybuffer);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (status == napi_ok &amp;&amp; is_arraybuffer) {</span></span>
<span class="line"><span>    // æ˜¯ ArrayBuffer</span></span>
<span class="line"><span>    napi_get_boolean(env, true, &amp;returnValue);</span></span>
<span class="line"><span>  } else {</span></span>
<span class="line"><span>    // ä¸æ˜¯ ArrayBuffer</span></span>
<span class="line"><span>    napi_get_boolean(env, false, &amp;returnValue);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return returnValue;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... æ³¨å†Œå‡½æ•°ç­‰å…¶ä»–ä»£ç  ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç ä¸­çš„ <code>CheckIfArrayBuffer</code> å‡½æ•°ä¼šè¢«æ³¨å†Œåˆ° Node.js ç¯å¢ƒä¸­ï¼Œå¹¶ç”± JavaScript è°ƒç”¨ã€‚å®ƒä¼šæ£€æŸ¥ä¼ å…¥çš„å‚æ•°æ˜¯å¦æ˜¯ ArrayBuffer å¹¶è¿”å›ç›¸åº”çš„å¸ƒå°”å€¼ã€‚</p><p>JavaScript è°ƒç”¨ç¤ºä¾‹:</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/native-addon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> buffer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ArrayBuffer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">10</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> notBuffer</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> {}</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">CheckIfArrayBuffer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">buffer</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºåº”è¯¥æ˜¯ true</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">CheckIfArrayBuffer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">notBuffer</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºåº”è¯¥æ˜¯ false</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·æ³¨æ„ï¼Œå¯èƒ½éœ€è¦å®‰è£…å’Œé…ç½®é¢å¤–çš„å·¥å…·å’Œåº“æ‰èƒ½ç¼–è¯‘å’Œæ„å»ºåŸç”Ÿæ’ä»¶ï¼Œæ¯”å¦‚ node-gypã€‚ä¸Šé¢çš„ä¾‹å­åªæ˜¯å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>napi_is_arraybuffer</code> å‡½æ•°ï¼Œæ²¡æœ‰åŒ…æ‹¬å…¨éƒ¨å¿…è¦çš„æ„å»ºæ­¥éª¤ã€‚</p><h3 id="napi-is-buffer" tabindex="-1"><a class="header-anchor" href="#napi-is-buffer"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_is_buffer" target="_blank" rel="noopener noreferrer">napi_is_buffer</a></span></a></h3><p><code>napi_is_buffer</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ª N-API å‡½æ•°ï¼Œç”¨æ¥åˆ¤æ–­ä¼ å…¥çš„ <code>napi_value</code> æ˜¯å¦æ˜¯ä¸€ä¸ª Node.js Buffer å¯¹è±¡ã€‚Node.js Buffer ç±»æ˜¯ç”¨æ¥å¤„ç†äºŒè¿›åˆ¶æ•°æ®æµçš„ç±»ï¼Œåœ¨ Node.js ä¸­ç»å¸¸è¢«ç”¨æ¥è¯»å†™æ•°æ®ï¼Œæ¯”å¦‚æ–‡ä»¶ã€ç½‘ç»œé€šä¿¡ç­‰ã€‚</p><p>åœ¨äº†è§£ <code>napi_is_buffer</code> ä¹‹å‰ï¼Œé¦–å…ˆè¦çŸ¥é“ N-APIï¼ˆNode.js APIï¼‰æ˜¯ Node.js æä¾›çš„ä¸€å¥—ç”¨ C æˆ– C++ ç¼–å†™æ‰©å±•çš„ APIï¼Œè¿™äº› API æ˜¯ç‹¬ç«‹äº V8 å¼•æ“ï¼Œå¯ä»¥ä½¿å¾—ç¼–å†™çš„æœ¬åœ°æ’ä»¶å¯ä»¥è·¨ä¸åŒç‰ˆæœ¬çš„ Node.js è¿è¡Œã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥å…·ä½“çœ‹ä¸€ä¸‹ <code>napi_is_buffer</code> å‡½æ•°ï¼š</p><p>å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_is_buffer(napi_env env, napi_value value, bool* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>env</code> æ˜¯è¡¨ç¤ºå½“å‰æ‰§è¡Œç¯å¢ƒçš„å¥æŸ„ã€‚</li><li><code>value</code> æ˜¯ä½ æƒ³è¦æ£€æµ‹æ˜¯å¦ä¸º Buffer çš„ JavaScript å€¼ã€‚</li><li><code>result</code> æ˜¯ä¸€ä¸ªæŒ‡å‘å¸ƒå°”å€¼çš„æŒ‡é’ˆï¼Œå‡½æ•°ä¼šå°†æ£€æµ‹ç»“æœå­˜å‚¨åœ¨è¿™ä¸ªå¸ƒå°”å€¼ä¸­ã€‚</li></ul><p>å½“ä½ è°ƒç”¨ <code>napi_is_buffer</code> åï¼Œå¦‚æœ <code>value</code> æ˜¯ä¸€ä¸ª Buffer å¯¹è±¡ï¼Œé‚£ä¹ˆåœ¨ <code>result</code> æŒ‡å‘çš„å¸ƒå°”å€¼ä¼šè¢«è®¾ç½®ä¸º <code>true</code>ï¼Œå¦åˆ™ä¼šè¢«è®¾ç½®ä¸º <code>false</code>ã€‚</p><p>è¿™é‡Œæ˜¯ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ä¸€ä¸ª N-API æ‰©å±•ä¸­ä½¿ç”¨ <code>napi_is_buffer</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//... åœ¨å…¶ä»–ä»£ç ä¸­</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void SomeFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_value arg = args[0];</span></span>
<span class="line"><span>    bool isBuffer;</span></span>
<span class="line"><span>    napi_status status = napi_is_buffer(env, arg, &amp;isBuffer);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†å¯èƒ½å‘ç”Ÿçš„é”™è¯¯</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (isBuffer) {</span></span>
<span class="line"><span>        // å¦‚æœæ˜¯ Buffer, åˆ™æ‰§è¡Œç›¸å…³æ“ä½œ</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // å¦‚æœä¸æ˜¯ Buffer, åˆ™æ‰§è¡Œå…¶ä»–é€»è¾‘æˆ–è¿”å›é”™è¯¯</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//... å…¶ä»–ä»£ç å’Œæ¨¡å—å¯¼å‡ºé€»è¾‘</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œ<code>SomeFunction</code> ä½œä¸ºä¸€ä¸ª N-API å‡½æ•°å¯èƒ½ä¼šè¢« JavaScript è°ƒç”¨ï¼Œå®ƒæ¥æ”¶å‚æ•°å¹¶åˆ¤æ–­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦æ˜¯ Bufferã€‚å¦‚æœæ˜¯ Buffer ç±»å‹ï¼Œä½ å¯ä»¥è¿›è¡Œå¦‚è¯»å–æ•°æ®ã€å¤„ç†äºŒè¿›åˆ¶ä¿¡æ¯ç­‰æ“ä½œï¼›å¦‚æœä¸æ˜¯ï¼Œåˆ™å¯ä»¥é€‰æ‹©æŠ›å‡ºé”™è¯¯æˆ–è€…è¿›è¡Œå…¶å®ƒé€»è¾‘å¤„ç†ã€‚</p><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯èƒ½è¦å¤„ç†ä»æ–‡ä»¶è¯»å–æ•°æ®ã€æ¥æ”¶ç½‘ç»œè¯·æ±‚çš„æ•°æ®ç­‰æƒ…å†µï¼Œè¿™æ—¶å€™ç”¨ <code>napi_is_buffer</code> æ¥ç¡®ä¿æ¥æ”¶åˆ°çš„æ•°æ®æ˜¯æ­£ç¡®çš„ Buffer å¯¹è±¡éå¸¸æœ‰ç”¨ã€‚è¿™æ ·çš„æ£€æŸ¥èƒ½å¤Ÿè®©ä½ çš„æœ¬åœ°æ‰©å±•æ›´åŠ å¥å£®ï¼Œé¿å…å› ç±»å‹é”™è¯¯è€Œå¼•å‘çš„é—®é¢˜ã€‚</p><h3 id="napi-is-date" tabindex="-1"><a class="header-anchor" href="#napi-is-date"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_is_date" target="_blank" rel="noopener noreferrer">napi_is_date</a></span></a></h3><p><code>napi_is_date</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å±äº N-APIï¼ˆNode APIï¼‰ï¼Œä¸€ä¸ªç”¨æ¥æ„å»ºåŸç”Ÿæ’ä»¶çš„æ¥å£ã€‚N-API æä¾›äº†ä¸€å¥—ä¸ JavaScript è¿è¡Œæ—¶ç›¸å…³çš„ APIï¼Œè¿™äº› API å…è®¸ä½ åˆ›å»ºå¯ä»¥ç›´æ¥ä¸ Node.js äº¤äº’çš„æœ¬åœ°æ’ä»¶ã€‚</p><p>åœ¨ Node.js ä¸­ï¼ŒJavaScript å¯ä»¥ä½¿ç”¨ Date å¯¹è±¡æ¥å¤„ç†æ—¶é—´å’Œæ—¥æœŸã€‚ä½†æ˜¯å½“æˆ‘ä»¬åœ¨ C æˆ– C++ çš„åŸç”Ÿæ’ä»¶ä»£ç ä¸­å·¥ä½œæ—¶ï¼Œéœ€è¦ä¸€ç§æ–¹æ³•æ¥åˆ¤æ–­ä¸€ä¸ªä» JavaScript ä¼ é€’è¿‡æ¥çš„å€¼æ˜¯å¦ä¸ºä¸€ä¸ª Date å¯¹è±¡ã€‚è¿™å°±æ˜¯ <code>napi_is_date</code> å‡½æ•°çš„ç”¨é€”ã€‚</p><p>ç®€å•åœ°è¯´ï¼Œ<code>napi_is_date</code> å‡½æ•°èƒ½å¤Ÿå¸®åŠ©ä½ æ£€æŸ¥ä¸€ä¸ªä¼ å…¥çš„ <code>napi_value</code>ï¼ˆè¿™æ˜¯ä¸€ä¸ªä»£è¡¨ JavaScript å€¼çš„æŠ½è±¡ç±»å‹ï¼‰æ˜¯å¦æ˜¯ä¸€ä¸ª JavaScript Date å¯¹è±¡ã€‚</p><p>ä¸‹é¢æ˜¯å¦‚ä½•ä½¿ç”¨ <code>napi_is_date</code> å‡½æ•°çš„ä¾‹å­ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œéœ€è¦åˆ¤æ–­ JavaScript ä¼ é€’çš„å‚æ•°æ˜¯å¦æ˜¯ä¸€ä¸ª Date å¯¹è±¡ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°å°†ä¼šè¢«ç»‘å®šåˆ° JavaScript ä¸­ï¼Œå¹¶å¯ä»é‚£é‡Œè°ƒç”¨</span></span>
<span class="line"><span>napi_value IsDateExample(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    bool is_date;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–ä¼ é€’ç»™è¯¥å‡½æ•°çš„ JavaScript å‚æ•°</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ¤æ–­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦ä¸º Date ç±»å‹</span></span>
<span class="line"><span>    status = napi_is_date(env, args[0], &amp;is_date);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†ç»“æœè½¬æ¢å› JavaScript çš„å¸ƒå°”å€¼å¹¶è¿”å›</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    status = napi_get_boolean(env, is_date, &amp;result);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return result; // è¿”å›ç»“æœç»™ JavaScript è°ƒç”¨æ–¹</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–æ¨¡å—ï¼Œæ³¨å†Œ IsDateExample å‡½æ•°</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°å¯¹è±¡</span></span>
<span class="line"><span>    status = napi_create_function(env, NULL, 0, IsDateExample, NULL, &amp;fn);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†è¿™ä¸ªå‡½æ•°è®¾ç½®ä¸ºå¯¼å‡ºçš„å±æ€§</span></span>
<span class="line"><span>    status = napi_set_named_property(env, exports, &quot;isDateExample&quot;, fn);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶ååœ¨ JavaScript ä¸­ï¼Œä½ å¯ä»¥åƒä¸‹é¢è¿™æ ·è°ƒç”¨æ­¤å‡½æ•°ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/native-addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> date</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Date</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> notADate</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> {}</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">isDateExample</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">date</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // åº”è¯¥è¾“å‡ºï¼štrue</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">isDateExample</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">notADate</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // åº”è¯¥è¾“å‡ºï¼šfalse</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šè¿°çš„ C ä»£ç ç¤ºä¾‹ä¸­ï¼Œå‡½æ•° <code>IsDateExample</code> ä¼šæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œç„¶ååˆ©ç”¨ <code>napi_is_date</code> æ¥æ£€æŸ¥è¿™ä¸ªå‚æ•°æ˜¯å¦ä¸ºä¸€ä¸ª JavaScript çš„ Date å¯¹è±¡ã€‚å¦‚æœæ˜¯ï¼Œå®ƒä¼šè¿”å› <code>true</code>ï¼Œå¦åˆ™è¿”å› <code>false</code>ã€‚è€Œåœ¨ JavaScript ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡åŠ è½½è¿™ä¸ªåŸç”Ÿæ¨¡å—æ¥è°ƒç”¨ <code>isDateExample</code> æ–¹æ³•ï¼Œåˆ†åˆ«ä¼ å…¥çœŸæ­£çš„ Date å¯¹è±¡ä»¥åŠä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œç„¶åæ‰“å°å‡ºç»“æœã€‚</p><h3 id="napi-is-error-2" tabindex="-1"><a class="header-anchor" href="#napi-is-error-2"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_is_error_1" target="_blank" rel="noopener noreferrer">napi_is_error</a></span></a></h3><p><code>napi_is_error</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå±äº N-APIï¼ˆNode APIï¼‰ï¼Œè¿™æ˜¯ä¸€ç»„ç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ C APIã€‚åŸç”Ÿæ’ä»¶æ˜¯ç”¨ Cã€C++ç­‰è¯­è¨€ç¼–å†™çš„æ¨¡å—ï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥ä¸ Node.js çš„ V8 å¼•æ“äº¤äº’ï¼Œæä¾›æ¯” JavaScript æ›´é«˜æ•ˆçš„æ€§èƒ½ï¼Œæˆ–å®ç°ä¸€äº›åœ¨çº¯ JavaScript ä¸­ä¸å¯èƒ½æˆ–å›°éš¾çš„åŠŸèƒ½ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œ<code>napi_is_error</code> å‡½æ•°ç”¨äºæ£€æŸ¥ä¸€ä¸ª <code>napi_value</code> æ˜¯å¦è¡¨ç¤ºä¸€ä¸ª JavaScript é”™è¯¯å¯¹è±¡ã€‚åœ¨ Node.js ä¸­ï¼ŒJavaScript é”™è¯¯å¯¹è±¡é€šå¸¸ç”¨äºæ•è·å’Œå¤„ç†è¿è¡Œæ—¶é”™è¯¯ã€‚</p><h3 id="å‚æ•°è§£é‡Š" tabindex="-1"><a class="header-anchor" href="#å‚æ•°è§£é‡Š"><span>å‚æ•°è§£é‡Š</span></a></h3><ul><li><code>env</code>: è¡¨ç¤ºå½“å‰çš„ napi ç¯å¢ƒï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼ŒåŒ…å«äº†å½“å‰æ­£åœ¨è¿è¡Œçš„ Node.js å®ä¾‹çš„ä¿¡æ¯ã€‚</li><li><code>value</code>: æ˜¯è¦æ£€æŸ¥çš„ <code>napi_value</code>ï¼Œå³ä½ æƒ³çŸ¥é“å®ƒæ˜¯å¦ä¸ºä¸€ä¸ªé”™è¯¯å¯¹è±¡çš„å€¼ã€‚</li><li><code>result</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘å¸ƒå°”å€¼çš„æŒ‡é’ˆï¼Œå‡½æ•°å°†åœ¨è¿™é‡Œè®¾ç½®ç»“æœã€‚å¦‚æœ <code>value</code> æ˜¯ä¸€ä¸ªé”™è¯¯å¯¹è±¡ï¼Œåˆ™è¿™ä¸ªå¸ƒå°”å€¼ä¼šè¢«è®¾ç½®ä¸º <code>true</code>ï¼›å¦åˆ™ï¼Œå®ƒä¼šè¢«è®¾ç½®ä¸º <code>false</code>ã€‚</li></ul><h3 id="ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹-2" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹-2"><span>ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶çš„åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½è°ƒç”¨äº†å¦ä¸€ä¸ªå¯èƒ½ä¼šæŠ›å‡ºé”™è¯¯çš„å‡½æ•°ã€‚åœ¨è¿”å›ç»™ JavaScript ä¹‹å‰ï¼Œä½ æƒ³æ£€æŸ¥ç»“æœæ˜¯å¦æ˜¯ä¸€ä¸ªé”™è¯¯å¯¹è±¡ï¼Œå¹¶æ®æ­¤é‡‡å–ä¸åŒçš„è¡ŒåŠ¨ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æœ‰ä¸€ä¸ªå‡½æ•°å¯èƒ½ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯å¯¹è±¡</span></span>
<span class="line"><span>napi_value SomeFunctionThatMayThrow(napi_env env) {</span></span>
<span class="line"><span>    // ... ä¸€äº›æ“ä½œå¯èƒ½ä¼šå¤±è´¥å¹¶è¿”å›é”™è¯¯å¯¹è±¡</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void MyNativeFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // è°ƒç”¨å¯èƒ½ä¼šæŠ›å‡ºé”™è¯¯çš„å‡½æ•°</span></span>
<span class="line"><span>    napi_value result = SomeFunctionThatMayThrow(env);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥ç»“æœæ˜¯å¦æ˜¯ä¸€ä¸ªé”™è¯¯å¯¹è±¡</span></span>
<span class="line"><span>    bool is_error;</span></span>
<span class="line"><span>    napi_status status = napi_is_error(env, result, &amp;is_error);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (status == napi_ok &amp;&amp; is_error) {</span></span>
<span class="line"><span>        // å¦‚æœæ˜¯é”™è¯¯å¯¹è±¡ï¼Œå¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>        // ...</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // å¦‚æœä¸æ˜¯é”™è¯¯å¯¹è±¡ï¼Œç»§ç»­æ­£å¸¸é€»è¾‘</span></span>
<span class="line"><span>        // ...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰äº†ä¸€ä¸ªå‡½æ•° <code>SomeFunctionThatMayThrow</code>ï¼Œå®ƒåœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯å¯¹è±¡ã€‚ç„¶åï¼Œæˆ‘ä»¬æœ‰äº†å¦ä¸€ä¸ªå‡½æ•° <code>MyNativeFunction</code>ï¼Œå®ƒè°ƒç”¨äº† <code>SomeFunctionThatMayThrow</code> å¹¶ä½¿ç”¨ <code>napi_is_error</code> æ¥æ£€æŸ¥è¿”å›çš„å€¼æ˜¯å¦æ˜¯ä¸€ä¸ªé”™è¯¯å¯¹è±¡ã€‚æ ¹æ®æ£€æŸ¥ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥å†³å®šå¦‚ä½•å¤„ç†è¿™ç§æƒ…å†µï¼šå¦‚æœæ˜¯ä¸€ä¸ªé”™è¯¯å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡å–é€‚å½“çš„é”™è¯¯å¤„ç†æªæ–½ï¼Œå¦åˆ™ï¼Œæˆ‘ä»¬ç»§ç»­æ­£å¸¸çš„é€»è¾‘å¤„ç†ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>napi_is_error</code> æœ¬èº«ä¹Ÿä¼šè¿”å›ä¸€ä¸ªçŠ¶æ€ç ï¼ˆ<code>napi_status</code>ï¼‰ï¼Œå¦‚æœè°ƒç”¨æˆåŠŸä¸”æœªå‘ç”Ÿé”™è¯¯ï¼Œåˆ™è¿”å› <code>napi_ok</code>ã€‚æ‰€ä»¥åœ¨æ£€æŸ¥æ˜¯å¦ä¸ºé”™è¯¯å¯¹è±¡ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜åº”è¯¥æ£€æŸ¥ <code>napi_is_error</code> è°ƒç”¨è‡ªèº«æ˜¯å¦æˆåŠŸã€‚</p><h3 id="napi-is-typedarray" tabindex="-1"><a class="header-anchor" href="#napi-is-typedarray"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_is_typedarray" target="_blank" rel="noopener noreferrer">napi_is_typedarray</a></span></a></h3><p><code>napi_is_typedarray</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå±äº N-APIï¼ˆNode APIï¼‰ï¼Œè¿™æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚N-API æ˜¯ä¸€ä¸ªç¨³å®šä¸”ä¸ Node.js ç‰ˆæœ¬æ— å…³çš„ C çº§åˆ«çš„ APIï¼Œä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿä¸ç”¨æ‹…å¿ƒ Node.js å‡çº§åå¯¼è‡´çš„æ’ä»¶å…¼å®¹æ€§é—®é¢˜ã€‚</p><p>åœ¨è§£é‡Š <code>napi_is_typedarray</code> ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯ TypedArrayã€‚TypedArray æ˜¯ JavaScript ä¸­çš„ä¸€ç§ç‰¹æ®Šç±»å‹çš„æ•°ç»„ï¼Œå®ƒæä¾›äº†ä¸€ç§è¯»å†™äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºçš„æœºåˆ¶ã€‚å’Œæ™®é€šçš„ JavaScript æ•°ç»„ä¸åŒï¼ŒTypedArray å·¥ä½œåœ¨ ArrayBuffer ä¸Šï¼Œå¹¶ä¸”å…¶å…ƒç´ ç±»å‹æ˜¯å›ºå®šçš„ï¼Œæ¯”å¦‚ Int8Array, Uint8Array, Float32Array ç­‰ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ <code>napi_is_typedarray</code>ï¼š</p><h3 id="napi-is-typedarray-1" tabindex="-1"><a class="header-anchor" href="#napi-is-typedarray-1"><span><code>napi_is_typedarray</code></span></a></h3><p>è¿™ä¸ªå‡½æ•°ç”¨æ¥æ£€æŸ¥ç»™å®šçš„ N-API å€¼æ˜¯å¦ä¸ºä¸€ä¸ª TypedArrayã€‚å¦‚æœæ˜¯ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¿”å› <code>true</code>ï¼Œå¦åˆ™è¿”å› <code>false</code>ã€‚</p><h4 id="å‚æ•°-2" tabindex="-1"><a class="header-anchor" href="#å‚æ•°-2"><span>å‚æ•°</span></a></h4><ol><li><code>env</code>: è¿™æ˜¯å½“å‰æ‰§è¡Œç¯å¢ƒçš„å¥æŸ„ï¼Œå®ƒæä¾›äº† Node.js ç¯å¢ƒçš„ä¸Šä¸‹æ–‡ã€‚</li><li><code>value</code>: è¿™æ˜¯ä½ æƒ³è¦æ£€æŸ¥çš„ N-API å€¼ã€‚</li><li><code>result</code>: è¿™æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼çš„æŒ‡é’ˆï¼Œå‡½æ•°é€šè¿‡å®ƒè¿”å›æ£€æŸ¥ç»“æœã€‚</li></ol><h4 id="è¿”å›å€¼-4" tabindex="-1"><a class="header-anchor" href="#è¿”å›å€¼-4"><span>è¿”å›å€¼</span></a></h4><p>å¦‚æœè°ƒç”¨æˆåŠŸï¼Œè¯¥å‡½æ•°ä¼šè¿”å› <code>napi_ok</code>ï¼Œè¡¨ç¤ºæ²¡æœ‰é”™è¯¯å‘ç”Ÿã€‚å› æ­¤ï¼Œä½ éœ€è¦æ£€æŸ¥<code>result</code>æŒ‡å‘çš„å¸ƒå°”å€¼æ¥ç¡®å®šç»™å®šçš„å€¼æ˜¯å¦ä¸º TypedArrayã€‚</p><h4 id="å®é™…è¿ç”¨çš„ä¾‹å­-7" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-7"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h4><p>è®¾æƒ³ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js çš„åŸç”Ÿæ’ä»¶ï¼Œè¿™ä¸ªæ’ä»¶éœ€è¦å¤„ç†å›¾åƒæˆ–éŸ³é¢‘æ•°æ®ã€‚ä½ å¯èƒ½ä¼šä» JavaScript ä»£ç æ¥æ”¶ä¸€ä¸ªæ•°ç»„ï¼Œè€Œä½ å¸Œæœ›ç¡®è®¤å®ƒæ˜¯ä¸€ä¸ªç‰¹å®šç±»å‹çš„ TypedArrayï¼Œè¿™æ ·å°±å¯ä»¥ä»¥äºŒè¿›åˆ¶å½¢å¼ç›´æ¥è¯»å–æ•°æ®ï¼Œè€Œä¸éœ€è¦é¢å¤–çš„ç±»å‹è½¬æ¢ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>napi_is_typedarray</code> æ¥æ£€æŸ¥è¿™ä¸€ç‚¹ã€‚</p><p>è¿™é‡Œæ˜¯ä¸€ä¸ªè™šæ„çš„ä¾‹å­ä»£ç ç‰‡æ®µï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ä¸€ä¸ªåŸç”Ÿæ’ä»¶ä¸­ä½¿ç”¨ <code>napi_is_typedarray</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... å…¶ä»–å¿…éœ€çš„å¤´æ–‡ä»¶å’Œä»£ç </span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value MyNativeFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦åªä¼ é€’äº†ä¸€ä¸ªå‚æ•°å¹¶ä¸”è¿™ä¸ªå‚æ•°æ˜¯ TypedArray</span></span>
<span class="line"><span>    bool isTypedArray = false;</span></span>
<span class="line"><span>    napi_status status = napi_is_typedarray(env, args[0], &amp;isTypedArray);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (status != napi_ok || !isTypedArray) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯æˆ–æŠ›å‡ºå¼‚å¸¸</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¦‚æœæ˜¯ TypedArrayï¼Œæ‰§è¡Œåç»­çš„æ“ä½œ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... å…¶ä»–å¿…éœ€çš„ä»£ç æ¥æ³¨å†Œè¿™ä¸ªå‡½æ•°</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>MyNativeFunction</code> çš„åŸç”Ÿå‡½æ•°ï¼Œå®ƒæ£€æŸ¥ä¼ é€’ç»™å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦ä¸º TypedArrayã€‚é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>napi_get_cb_info</code> è·å–å‚æ•°ï¼Œç„¶åè°ƒç”¨ <code>napi_is_typedarray</code> æ¥è¿›è¡Œæ£€æŸ¥ã€‚å¦‚æœè¿™ä¸ªå‚æ•°ç¡®å®æ˜¯ TypedArrayï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†ç»§ç»­æ‰§è¡Œæ‰€éœ€çš„æ“ä½œï¼›å¦‚æœä¸æ˜¯ï¼Œæˆ‘ä»¬å°†å¤„ç†é”™è¯¯æˆ–æŠ›å‡ºå¼‚å¸¸ã€‚</p><p>æ€»ç»“èµ·æ¥ï¼Œ<code>napi_is_typedarray</code> æ˜¯ N-API ä¸‹ç”¨æ¥æ£€æŸ¥ä¸€ä¸ªå€¼æ˜¯å¦ä¸º TypedArray çš„å·¥å…·å‡½æ•°ï¼Œå¯¹äºå¤„ç†äºŒè¿›åˆ¶æ•°æ®çš„åŸç”Ÿæ¨¡å—å¼€å‘éå¸¸æœ‰ç”¨ã€‚</p><h3 id="napi-is-dataview" tabindex="-1"><a class="header-anchor" href="#napi-is-dataview"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_is_dataview" target="_blank" rel="noopener noreferrer">napi_is_dataview</a></span></a></h3><p><code>napi_is_dataview</code>æ˜¯ Node.js ä¸­ä¸€ä¸ª C API çš„å‡½æ•°ï¼Œè¿™ä¸ª API å±äº N-APIï¼Œæ˜¯ Node.js ç”¨æ¥æ„å»ºåŸç”Ÿæ’ä»¶çš„ä¸€ä¸ªæ¥å£ã€‚N-API æä¾›äº†ä¸€å¥—ä¸ JavaScript å¼•æ“æ— å…³çš„ C è¯­è¨€ APIï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿåˆ›å»ºå¯ä»¥åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸­è¿è¡Œè€Œä¸éœ€è¦é‡æ–°ç¼–è¯‘çš„åŸç”Ÿæ’ä»¶ã€‚</p><p>åœ¨è§£é‡Š<code>napi_is_dataview</code>ä¹‹å‰ï¼Œæˆ‘é¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹ DataViewã€‚åœ¨ JavaScript ä¸­ï¼ŒDataView æ˜¯ä¸€ç§ç”¨äºæ“ä½œäºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºï¼ˆArrayBufferï¼‰å†…å®¹çš„ä½çº§æ¥å£ã€‚å®ƒå…è®¸ä½ åœ¨ ArrayBuffer ä¸­è¯»å–å’Œå†™å…¥å¤šç§æ•°å€¼ç±»å‹ï¼Œæ— è®ºå®ƒä»¬çš„å­—èŠ‚é¡ºåºæ˜¯å¤§ç«¯ï¼ˆbig endianï¼‰è¿˜æ˜¯å°ç«¯ï¼ˆlittle endianï¼‰ã€‚</p><p>å¥½äº†ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹<code>napi_is_dataview</code>ï¼š</p><h3 id="napi-is-dataview-1" tabindex="-1"><a class="header-anchor" href="#napi-is-dataview-1"><span><code>napi_is_dataview</code></span></a></h3><p>è¿™ä¸ªå‡½æ•°ç”¨æ¥æ£€æŸ¥æŸä¸ª N-API å€¼æ˜¯å¦æ˜¯ä¸€ä¸ª DataView å¯¹è±¡ã€‚å…¶ä½œç”¨ç±»ä¼¼äº JavaScript ä¸­çš„<code>instanceof</code>æ“ä½œç¬¦ï¼Œä½†æ˜¯å®ƒæ˜¯ç”¨åœ¨åŸç”Ÿæ’ä»¶çš„ C ä»£ç ä¸­ã€‚</p><h4 id="å‚æ•°-3" tabindex="-1"><a class="header-anchor" href="#å‚æ•°-3"><span>å‚æ•°ï¼š</span></a></h4><ul><li><code>env</code>: è¿™æ˜¯è¡¨ç¤ºå½“å‰æ‰§è¡Œç¯å¢ƒçš„<code>napi_env</code>ã€‚</li><li><code>value</code>: è¦æ£€æŸ¥çš„ N-API å€¼ã€‚</li><li><code>result</code>: ä¸€ä¸ªæŒ‡å‘å¸ƒå°”å€¼çš„æŒ‡é’ˆï¼Œç”¨äºå­˜å‚¨æ£€æŸ¥ç»“æœï¼šå¦‚æœ<code>value</code>æ˜¯ DataViewï¼Œåˆ™è®¾ä¸º<code>true</code>ï¼›å¦åˆ™ï¼Œè®¾ä¸º<code>false</code>ã€‚</li></ul><h4 id="è¿”å›å€¼-5" tabindex="-1"><a class="header-anchor" href="#è¿”å›å€¼-5"><span>è¿”å›å€¼ï¼š</span></a></h4><p>è¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ª<code>napi_status</code>å€¼ï¼Œè¡¨ç¤ºæ“ä½œæˆåŠŸæˆ–å¤±è´¥çš„çŠ¶æ€ã€‚å¦‚æœå‡½æ•°è°ƒç”¨æˆåŠŸï¼Œä½ å¯ä»¥æ£€æŸ¥<code>result</code>æŒ‡å‘çš„å€¼æ¥ç¡®å®šä¼ å…¥çš„<code>value</code>æ˜¯å¦ä¸º DataViewã€‚</p><h4 id="ä¾‹å­-2" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2"><span>ä¾‹å­</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åŸç”Ÿæ’ä»¶ï¼Œå¹¶ä¸”ä½ æƒ³ç¡®å®šä» JavaScript ä¼ é€’ç»™ä½ çš„ N-API å‡½æ•°çš„ä¸€ä¸ªå‚æ•°æ˜¯å¦æ˜¯ä¸€ä¸ª DataViewã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™æ˜¯ä¸€ä¸ªåŸç”Ÿå‡½æ•°ï¼Œå°†è¢«JavaScriptè°ƒç”¨</span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  size_t argc = 1;</span></span>
<span class="line"><span>  napi_value args[1];</span></span>
<span class="line"><span>  napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ£€æŸ¥ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦æ˜¯DataView</span></span>
<span class="line"><span>  bool is_data_view;</span></span>
<span class="line"><span>  napi_is_dataview(env, args[0], &amp;is_data_view);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (is_data_view) {</span></span>
<span class="line"><span>    // å‚æ•°æ˜¯DataViewï¼Œå¤„ç†DataViewé€»è¾‘...</span></span>
<span class="line"><span>  } else {</span></span>
<span class="line"><span>    // å‚æ•°ä¸æ˜¯DataViewï¼Œå¯èƒ½æŠ›å‡ºé”™è¯¯æˆ–è€…è¿›è¡Œå…¶ä»–å¤„ç†...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ...å‡½æ•°çš„å…¶ä»–é€»è¾‘...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span>  // å‡è®¾åˆ›å»ºä¸€ä¸ªè¿”å›å€¼</span></span>
<span class="line"><span>  napi_get_undefined(env, &amp;result);</span></span>
<span class="line"><span>  return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>MyFunction</code>æ˜¯ä¸€ä¸ªåŸç”Ÿå‡½æ•°ï¼Œå®ƒæœŸæœ›æ¥æ”¶ä¸€ä¸ª DataView ä½œä¸ºå‚æ•°ã€‚æˆ‘ä»¬ä½¿ç”¨<code>napi_get_cb_info</code>å–å¾—ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°ï¼Œç„¶åä½¿ç”¨<code>napi_is_dataview</code>æ¥æ£€æŸ¥è¿™ä¸ªå‚æ•°æ˜¯å¦ç¡®å®æ˜¯ä¸€ä¸ª DataViewã€‚æ ¹æ®æ£€æŸ¥ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥å†³å®šå¦‚ä½•å¤„ç†è¿™ä¸ªå‚æ•°ã€‚</p><p>è®°å¾—åœ¨å®é™…ä»£ç ä¸­ï¼Œä½ åº”è¯¥æ€»æ˜¯æ£€æŸ¥<code>napi_is_dataview</code>çš„è¿”å›å€¼ä»¥ç¡®å®šæ“ä½œæ˜¯å¦æˆåŠŸï¼Œå¹¶ç›¸åº”åœ°å¤„ç†é”™è¯¯æƒ…å†µã€‚</p><h3 id="napi-strict-equals" tabindex="-1"><a class="header-anchor" href="#napi-strict-equals"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_strict_equals" target="_blank" rel="noopener noreferrer">napi_strict_equals</a></span></a></h3><p>Node.js ä¸­çš„ <code>napi_strict_equals</code> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå±äº N-APIï¼ˆNode.js APIï¼‰çš„ä¸€éƒ¨åˆ†ã€‚N-API æ˜¯ Node.js æä¾›çš„ç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ä¸€å¥—ç¨³å®šçš„ C APIã€‚åŸç”Ÿæ’ä»¶æ˜¯æŒ‡ç”¨ C æˆ– C++ å†™çš„æ¨¡å—ï¼Œå®ƒä»¬å¯ä»¥è¢« JavaScript ä»£ç ç›´æ¥è°ƒç”¨ã€‚è¿™äº›åŠŸèƒ½å¯¹äºæå‡æ€§èƒ½å’Œ/æˆ–ä½¿ Node.js èƒ½å¤Ÿè®¿é—®æ“ä½œç³»ç»Ÿçº§åˆ«çš„åŠŸèƒ½éå¸¸æœ‰ç”¨ã€‚</p><p>ç°åœ¨ï¼Œæ¥å…·ä½“çœ‹çœ‹ <code>napi_strict_equals</code> è¿™ä¸ªå‡½æ•°ã€‚å¦‚åç§°æ‰€ç¤ºï¼Œè¯¥å‡½æ•°ç”¨äºæ¯”è¾ƒä¸¤ä¸ª JavaScript å€¼æ˜¯å¦ä¸¥æ ¼ç›¸ç­‰ï¼Œè¿™æ„å‘³ç€å®ƒä¸ä¼šè¿›è¡Œç±»å‹è½¬æ¢ã€‚åœ¨ JavaScript ä¸­ï¼Œä½¿ç”¨ <code>===</code> æ“ä½œç¬¦å¯ä»¥æ‰§è¡Œä¸¥æ ¼ç›¸ç­‰æ€§æ£€æŸ¥ã€‚è€Œ <code>napi_strict_equals</code> åˆ™æ˜¯è¿™ç§æ“ä½œçš„ C å±‚é¢çš„ç­‰æ•ˆå®ç°ã€‚</p><p>ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦è¿™æ ·çš„å‡½æ•°ï¼Ÿå½“ä½ ç¼–å†™åŸç”Ÿæ¨¡å—æ—¶ï¼Œå¯èƒ½éœ€è¦åˆ¤æ–­ JavaScript ä¼ å…¥çš„å‚æ•°æ˜¯å¦ä¸æŸä¸ªç‰¹å®šå€¼å®Œå…¨ç›¸åŒã€‚ç”±äºä½ åœ¨ C æˆ– C++ çš„ç¯å¢ƒä¸­å·¥ä½œï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ä½¿ç”¨ JavaScript çš„ <code>===</code>ã€‚è¿™æ—¶å€™ï¼Œ<code>napi_strict_equals</code> å°±æˆäº†åˆ¤æ–­è¿™ç§ä¸¥æ ¼ç›¸ç­‰æ€§çš„å·¥å…·ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­æ¥å±•ç¤º <code>napi_strict_equals</code> çš„åŸºæœ¬ç”¨æ³•ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æœ‰ä¸€ä¸ªå‡½æ•°å«åš &quot;StrictEquals&quot; ç»‘å®šåˆ°äº† JS</span></span>
<span class="line"><span>napi_value StrictEquals(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // è·å–å‡½æ•°å‚æ•°</span></span>
<span class="line"><span>    size_t argc = 2;</span></span>
<span class="line"><span>    napi_value args[2];</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥å‚æ•°æ•°é‡æ˜¯å¦æ­£ç¡®</span></span>
<span class="line"><span>    if (argc `&lt;` 2) {</span></span>
<span class="line"><span>        napi_throw_type_error(env, NULL, &quot;Function expects two arguments.&quot;);</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ä½¿ç”¨ napi_strict_equals æ¯”è¾ƒä¸¤ä¸ªå‚æ•°æ˜¯å¦ä¸¥æ ¼ç›¸ç­‰</span></span>
<span class="line"><span>    bool result;</span></span>
<span class="line"><span>    napi_strict_equals(env, args[0], args[1], &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æŠŠç»“æœè½¬æ¢ä¸º JavaScript çš„å¸ƒå°”å€¼è¿”å›ç»™ JS</span></span>
<span class="line"><span>    napi_value jsResult;</span></span>
<span class="line"><span>    napi_get_boolean(env, result, &amp;jsResult);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return jsResult;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void Initialize(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    // ... åˆå§‹åŒ–ä»£ç ï¼Œå¹¶æŠŠä¸Šé¢çš„å‡½æ•°ç»‘å®šç»™ JS è°ƒç”¨ ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Initialize)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>StrictEquals</code> çš„å‡½æ•°ï¼Œå®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œå¹¶ä½¿ç”¨ <code>napi_strict_equals</code> æ¥åˆ¤æ–­å®ƒä»¬æ˜¯å¦ä¸¥æ ¼ç›¸åŒã€‚å‡½æ•°çš„ç»“æœæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºä¸¤ä¸ªå‚æ•°æ˜¯å¦ç›¸ç­‰ã€‚</p><p>åœ¨ JavaScript ç«¯ï¼Œä½ å¯ä»¥åƒè¿™æ ·ä½¿ç”¨è¿™ä¸ªå‡½æ•°ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeModule</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/native-module.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">StrictEquals</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">5</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 5</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º true</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">StrictEquals</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">5</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 5</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º falseï¼Œå› ä¸ºç±»å‹ä¸åŒ</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ JavaScript ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>require</code> å¼•å…¥äº† C/C++ ç¼–å†™å¹¶ç¼–è¯‘å¥½çš„åŸç”Ÿæ¨¡å—ï¼Œç„¶åä½¿ç”¨ <code>.StrictEquals</code> å‡½æ•°æ¥è¿›è¡Œä¸¥æ ¼æ¯”è¾ƒæ“ä½œã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>napi_strict_equals</code> åœ¨ Node.js åŸç”Ÿæ¨¡å—å¼€å‘ä¸­ä½¿ç”¨ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªåœ¨åŸç”Ÿä»£ç ä¸­æ‰§è¡Œä¸¥æ ¼ç›¸ç­‰æ€§æ¯”è¾ƒçš„èƒ½åŠ›ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥åœ¨æ‰©å±• Node.js åŠŸèƒ½æ—¶å¯¹ JavaScript å€¼è¿›è¡Œæ›´ç²¾ç¡®çš„æ“ä½œã€‚</p><h3 id="napi-detach-arraybuffer" tabindex="-1"><a class="header-anchor" href="#napi-detach-arraybuffer"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_detach_arraybuffer" target="_blank" rel="noopener noreferrer">napi_detach_arraybuffer</a></span></a></h3><p><code>napi_detach_arraybuffer</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ª N-API å‡½æ•°ï¼Œå®ƒç”¨äºç®¡ç† JavaScript ArrayBuffer å¯¹è±¡ä¸å…¶åº•å±‚çš„äºŒè¿›åˆ¶æ•°æ®ä¹‹é—´çš„å…³è”ã€‚åœ¨è§£é‡Šè¿™ä¸ªå‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä¼šå…ˆç®€å•ä»‹ç»ä¸€äº›ç›¸å…³æ¦‚å¿µã€‚</p><h3 id="arraybuffer-ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#arraybuffer-ç®€ä»‹"><span>ArrayBuffer ç®€ä»‹</span></a></h3><p><code>ArrayBuffer</code> æ˜¯ JavaScript ä¸­çš„ä¸€ç§æ•°æ®ç±»å‹ï¼Œå®ƒè¡¨ç¤ºä¸€å—å›ºå®šå¤§å°çš„åŸå§‹äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºã€‚ä½ å¯ä»¥é€šè¿‡ Typed Arrays æˆ– DataView æ¥è¯»å†™ ArrayBuffer ä¸­çš„æ•°æ®ã€‚è¿™å¯¹äºå¤„ç†å¦‚æ–‡ä»¶æ•°æ®ã€ç½‘ç»œé€šä¿¡ç­‰éœ€è¦é«˜æ•ˆæ“ä½œäºŒè¿›åˆ¶æ•°æ®çš„åœºæ™¯ç‰¹åˆ«æœ‰ç”¨ã€‚</p><h3 id="n-api-ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#n-api-ç®€ä»‹"><span>N-API ç®€ä»‹</span></a></h3><p>N-API æ˜¯ Node.js æä¾›çš„ä¸€ç»„ C APIï¼Œå…è®¸æœ¬åœ°æ’ä»¶ï¼ˆç”¨ C æˆ– C++ç¼–å†™çš„æ¨¡å—ï¼‰ä¸ JavaScript ä»£ç æ— ç¼äº¤äº’ï¼ŒåŒæ—¶ä¿æŒä¸ Node.js ç‰ˆæœ¬çš„å‘åå…¼å®¹æ€§ã€‚æœ¬åœ°æ’ä»¶å¯ä»¥åˆ©ç”¨ N-API åˆ›å»ºå’Œæ“ä½œ JavaScript å€¼ï¼Œå¹¶é€šè¿‡å®ƒä»¬æ‰©å±• Node.js çš„åŠŸèƒ½ã€‚</p><h3 id="napi-detach-arraybuffer-1" tabindex="-1"><a class="header-anchor" href="#napi-detach-arraybuffer-1"><span>napi_detach_arraybuffer</span></a></h3><p>å½“æˆ‘ä»¬åœ¨æœ¬åœ°æ’ä»¶ä¸­ä½¿ç”¨ <code>ArrayBuffer</code> æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸€ç§æƒ…å†µï¼šæˆ‘ä»¬å¸Œæœ›æŠŠ ArrayBuffer ä¸­çš„æ•°æ®ã€Œåˆ†ç¦»ã€å‡ºæ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè®© ArrayBuffer ä¸å†å¼•ç”¨é‚£éƒ¨åˆ†å†…å­˜ã€‚è¿™æ ·ï¼ŒJavaScript çš„åƒåœ¾å›æ”¶æœºåˆ¶å°±ä¸ä¼šç®¡ç†é‚£éƒ¨åˆ†å†…å­˜äº†ï¼Œè€Œæ˜¯ç•™ç»™æˆ‘ä»¬è‡ªå·±ç®¡ç†ã€‚</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>napi_detach_arraybuffer</code> å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°å°† ArrayBuffer å¯¹è±¡æ ‡è®°ä¸º &quot;detached&quot; çŠ¶æ€ï¼Œå³è¯¥ ArrayBuffer ä¸å†æŒ‡å‘ä»»ä½•çš„æ•°æ®ã€‚è¿™æ ·åšçš„ä¸€ä¸ªå¸¸è§ç†ç”±æ˜¯ä¸ºäº†é¿å…æ•°æ®çš„é‡å¤æ‹·è´ï¼Œæå‡æ€§èƒ½ï¼šæˆ‘ä»¬å¯èƒ½å…ˆé€šè¿‡ JavaScript åˆ›å»ºäº†ä¸€ä¸ª ArrayBufferï¼Œç„¶åä¼ é€’åˆ°æœ¬åœ°æ’ä»¶è¿›è¡Œå¡«å……ï¼›å¡«å……å®Œæ¯•åï¼Œä¸ºäº†è®©å…¶ä»–åŸç”Ÿåº“ç›´æ¥æ“ä½œè¿™å—å†…å­˜ï¼Œæˆ‘ä»¬å°±ä¼šå°†å…¶åˆ†ç¦»ã€‚</p><h3 id="å®é™…ä¾‹å­-7" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-7"><span>å®é™…ä¾‹å­</span></a></h3><p>å‡è®¾ä½ åœ¨å¼€å‘ä¸€ä¸ªå›¾åƒå¤„ç†çš„ Node.js æ’ä»¶ã€‚ç”¨æˆ·å°†é€šè¿‡ JavaScript åˆ›å»ºä¸€ä¸ª ArrayBufferï¼ŒæœŸæœ›ä½ çš„æ’ä»¶å°†å›¾åƒæ•°æ®å¡«å……è¿›å»ã€‚ä¸€æ—¦ä½ å®Œæˆäº†å¡«å……ï¼Œä½ å¯èƒ½æƒ³è¦è°ƒç”¨ä¸€ä¸ªä¸“é—¨çš„å›¾åƒå¤„ç†åº“ï¼Œå®ƒå¹¶ä¸çŸ¥é“ JavaScript çš„å­˜åœ¨ï¼Œåªä¼šå¤„ç†çº¯ç²¹çš„å†…å­˜æ•°æ®ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€åŒ–çš„ä»£ç æµç¨‹ï¼š</p><ol><li>ç”¨æˆ·åœ¨ JS ä¾§åˆ›å»º ArrayBufferã€‚</li><li>ç”¨æˆ·è°ƒç”¨æ’ä»¶çš„æ–¹æ³•ï¼Œå°† ArrayBuffer ä¼ å…¥ã€‚</li><li>æ’ä»¶æ¥æ”¶ ArrayBufferï¼Œå¹¶ä½¿ç”¨ <code>napi_create_external_arraybuffer</code> æˆ–å…¶ä»–æ–¹æ³•æ¥å…³è”æœ¬åœ°æ•°æ®ã€‚</li><li>æ’ä»¶æ‰§è¡Œæ“ä½œï¼Œæ¯”å¦‚å¡«å……å›¾åƒæ•°æ®ã€‚</li><li>æ’ä»¶è°ƒç”¨ <code>napi_detach_arraybuffer</code> æ¥åˆ†ç¦» ArrayBufferï¼Œè¿™æ ·å›¾åƒå¤„ç†åº“å°±å¯ä»¥å®‰å…¨åœ°å¤„ç†è¿™å—å†…å­˜äº†ã€‚</li></ol><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æ­¤å‡½æ•°ç”±å›¾åƒå¤„ç†åº“æä¾›ï¼Œç”¨äºå¤„ç†å†…å­˜ä¸­çš„å›¾åƒæ•°æ®</span></span>
<span class="line"><span>void process_image_data(void* data, size_t length);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value DetachArrayBuffer(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ†ç¦» ArrayBuffer</span></span>
<span class="line"><span>    napi_detach_arraybuffer(env, args[0]);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å– ArrayBuffer çš„æ•°æ®æŒ‡é’ˆ</span></span>
<span class="line"><span>    void* data;</span></span>
<span class="line"><span>    size_t length;</span></span>
<span class="line"><span>    napi_get_arraybuffer_info(env, args[0], &amp;data, &amp;length);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è°ƒç”¨å›¾åƒå¤„ç†å‡½æ•°</span></span>
<span class="line"><span>    process_image_data(data, length);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return NULL;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... å…¶ä½™æ’ä»¶åˆå§‹åŒ–ä»£ç  ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·æ³¨æ„ï¼Œè¿™é‡Œçš„ä¾‹å­éå¸¸ç®€åŒ–ï¼Œå®é™…ä½¿ç”¨ä¸­è¿˜éœ€è¦è¿›è¡Œé”™è¯¯æ£€æŸ¥å’Œèµ„æºç®¡ç†ç­‰å·¥ä½œã€‚ä½†å®ƒå±•ç¤ºäº† <code>napi_detach_arraybuffer</code> åœ¨å®è·µä¸­æ˜¯å¦‚ä½•è¢«ç”¨æ¥ä¼˜åŒ–æ€§èƒ½å’Œä¸æœ¬åœ°åº“äº¤äº’çš„ã€‚</p><h3 id="napi-is-detached-arraybuffer" tabindex="-1"><a class="header-anchor" href="#napi-is-detached-arraybuffer"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_is_detached_arraybuffer" target="_blank" rel="noopener noreferrer">napi_is_detached_arraybuffer</a></span></a></h3><p><code>napi_is_detached_arraybuffer</code> æ˜¯ Node.js ä¸­ N-API (Native API) çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè®©ä½ å¯ä»¥æ£€æŸ¥ä¸€ä¸ª <code>ArrayBuffer</code> æ˜¯å¦å·²ç»è¢« &quot;detach&quot;ï¼ˆåˆ†ç¦»ï¼‰ã€‚åœ¨ JavaScript ä¸­ï¼Œ<code>ArrayBuffer</code> æ˜¯ä¸€ç§ç”¨æ¥è¡¨ç¤ºä¸€å—åŸå§‹äºŒè¿›åˆ¶æ•°æ®çš„æ–¹æ³•ï¼›ä½ å¯ä»¥æƒ³è±¡æˆå®ƒå°±åƒæ˜¯ä¸€ä¸ªå¯ä»¥å­˜å‚¨å­—èŠ‚çš„å®¹å™¨ã€‚</p><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç‰¹åˆ«æ˜¯åœ¨ä¸ WebAssembly æˆ–è€…å…¶ä»–åº•å±‚æ“ä½œæ‰“äº¤é“æ—¶ï¼Œå¯èƒ½ä¼šéœ€è¦ &quot;detach&quot; ä¸€ä¸ª ArrayBufferã€‚&quot;detach&quot; æ“ä½œåŸºæœ¬ä¸Šæ˜¯æŒ‡ä½¿è¿™ä¸ª ArrayBuffer çš„å†…å®¹å˜å¾—ä¸å¯è®¿é—®ï¼Œè¿™æ ·åšçš„ä¸€ä¸ªåŸå› å¯èƒ½æ˜¯ä¸ºäº†é‡Šæ”¾å†…å­˜æˆ–è€…é˜²æ­¢åç»­çš„ JavaScript ä»£ç é”™è¯¯åœ°ä½¿ç”¨äº†è¿™æ®µå†…å­˜ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡å‡ ä¸ªç®€å•çš„ä¾‹å­æ¥ç†è§£ <code>napi_is_detached_arraybuffer</code> å‡½æ•°çš„ä½œç”¨ã€‚</p><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-8" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-8"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h3><p><strong>æ³¨æ„ï¼š</strong> ä¸‹é¢çš„ä»£ç æ˜¯åœ¨ Node.js çš„ C/C++ æ’ä»¶ä¸­ä½¿ç”¨çš„ï¼Œè€Œéçº¯ JavaScript ç¯å¢ƒã€‚</p><ol><li><strong>æ£€æŸ¥ ArrayBuffer æ˜¯å¦å·²ç» Detach</strong></li></ol><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js çš„æ‰©å±•æ¨¡å—ï¼Œä½ æœ‰ä¸€ä¸ªä» JavaScript ä¼ é€’è¿‡æ¥çš„ <code>ArrayBuffer</code> å¯¹è±¡ï¼Œä½ æƒ³æ£€æŸ¥å®ƒæ˜¯å¦å·²ç»è¢« detachã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°å°†è¢«æš´éœ²ç»™ JavaScriptï¼Œç”¨äºæ£€æŸ¥ ArrayBuffer æ˜¯å¦ detach</span></span>
<span class="line"><span>napi_value IsDetached(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥å‚æ•°æ•°é‡æ˜¯å¦æ­£ç¡®</span></span>
<span class="line"><span>    if (argc `&lt;` 1) {</span></span>
<span class="line"><span>        napi_throw_type_error(env, NULL, &quot;Function expects an ArrayBuffer.&quot;);</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_value arrayBuffer = args[0];</span></span>
<span class="line"><span>    bool is_detached = false;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è°ƒç”¨ napi_is_detached_arraybuffer æ¥æ£€æŸ¥ ArrayBuffer æ˜¯å¦ detach</span></span>
<span class="line"><span>    napi_status status = napi_is_detached_arraybuffer(env, arrayBuffer, &amp;is_detached);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        napi_throw_error(env, NULL, &quot;Failed to check if ArrayBuffer is detached.&quot;);</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    napi_get_boolean(env, is_detached, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ¨¡å—åˆå§‹åŒ–ä»£ç ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª <code>IsDetached</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥è¢« JavaScript è°ƒç”¨ï¼Œå¹¶ä¸”å®ƒæ¥å—ä¸€ä¸ª <code>ArrayBuffer</code> å‚æ•°ï¼Œç„¶åä½¿ç”¨ <code>napi_is_detached_arraybuffer</code> æ£€æŸ¥è¯¥ <code>ArrayBuffer</code> æ˜¯å¦å·²ç»è¢« detachã€‚å‡½æ•°è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå‘Šè¯‰è°ƒç”¨è€… <code>ArrayBuffer</code> æ˜¯å¦ detachã€‚</p><ol start="2"><li><strong>åœ¨å®é™…æ“ä½œå‰ç¡®è®¤ ArrayBuffer çš„çŠ¶æ€</strong></li></ol><p>åœ¨å¤„ç† <code>ArrayBuffer</code> è¿›è¡Œå†…å­˜æ“ä½œä¹‹å‰ï¼Œå…ˆç¡®è®¤å®ƒæ²¡æœ‰è¢« detach æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ï¼Œå¯ä»¥é¿å…æ½œåœ¨çš„é”™è¯¯ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å‡è®¾ä½ æœ‰ä¸€ä¸ªç”¨äºå¤„ç† ArrayBuffer æ•°æ®çš„å‡½æ•°</span></span>
<span class="line"><span>void ProcessArrayBufferData(napi_env env, napi_value arrayBuffer) {</span></span>
<span class="line"><span>    bool is_detached = false;</span></span>
<span class="line"><span>    napi_is_detached_arraybuffer(env, arrayBuffer, &amp;is_detached);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (is_detached) {</span></span>
<span class="line"><span>        // å¦‚æœ ArrayBuffer å·²ç»è¢« detachï¼Œåˆ™ä¸è¿›è¡Œæ“ä½œ</span></span>
<span class="line"><span>        // å¯ä»¥æŠ›å‡ºé”™è¯¯æˆ–è€…ç›´æ¥é€€å‡º</span></span>
<span class="line"><span>        napi_throw_error(env, NULL, &quot;The ArrayBuffer is detached and cannot be used.&quot;);</span></span>
<span class="line"><span>        return;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ­£å¸¸å¤„ç† ArrayBuffer æ•°æ®...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åœ¨å¯¹ <code>ArrayBuffer</code> è¿›è¡Œä»»ä½•å¤„ç†ä¹‹å‰ï¼Œå…ˆä½¿ç”¨ <code>napi_is_detached_arraybuffer</code> å‡½æ•°æ£€æŸ¥å®ƒçš„çŠ¶æ€ã€‚å¦‚æœå‘ç°å·²ç» detachï¼Œå°±ä¸å†è¿›è¡Œåç»­æ“ä½œï¼Œä»¥æ­¤æ¥ä¿è¯ç¨‹åºçš„å®‰å…¨æ€§å’Œç¨³å®šæ€§ã€‚</p><p>å¸Œæœ›è¿™äº›ä¾‹å­èƒ½å¤Ÿå¸®åŠ©ä½ ç†è§£ <code>napi_is_detached_arraybuffer</code> åœ¨ Node.js N-API ä¸­çš„ä½¿ç”¨å’Œé‡è¦æ€§ã€‚åœ¨ç¼–å†™æ¶‰åŠåŸå§‹äºŒè¿›åˆ¶æ•°æ®æ“ä½œçš„æ‰©å±•æ¨¡å—æ—¶ï¼Œæ­£ç¡®æ£€æŸ¥ <code>ArrayBuffer</code> çš„çŠ¶æ€æ˜¯éå¸¸å…³é”®çš„ã€‚</p><h2 id="working-with-javascript-properties" tabindex="-1"><a class="header-anchor" href="#working-with-javascript-properties"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#working-with-javascript-properties" target="_blank" rel="noopener noreferrer">Working with JavaScript properties</a></span></a></h2><p>å½“æˆ‘ä»¬åœ¨ Node.js ä¸­ä½¿ç”¨ N-APIï¼ˆNode.js çš„åŸç”Ÿ API æ¥å£ï¼‰ä¸ JavaScript å±æ€§æ‰“äº¤é“æ—¶ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å‡ ä¸ªæ–¹é¢ï¼šåˆ›å»ºå±æ€§ã€è·å–å±æ€§å€¼ã€è®¾ç½®å±æ€§å€¼ä»¥åŠæ“ä½œå¯¹è±¡çš„å±æ€§ã€‚æˆ‘ä¼šç”¨ç®€å•çš„ä¾‹å­æ¥è§£é‡Šè¿™äº›æ¦‚å¿µã€‚</p><h3 id="åˆ›å»ºå±æ€§" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºå±æ€§"><span>åˆ›å»ºå±æ€§</span></a></h3><p>åœ¨ JavaScript ä¸­ï¼Œä½ å¯ä»¥ç›´æ¥ä¸ºå¯¹è±¡æ·»åŠ æ–°å±æ€§ã€‚ä¾‹å¦‚ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> obj</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> {}</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">obj</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">myProperty</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 123</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½†æ˜¯åœ¨ä½¿ç”¨ N-API çš„ C/C++ æ’ä»¶ä¸­ï¼Œä½ éœ€è¦é€šè¿‡ç‰¹å®šçš„å‡½æ•°æ¥å®ç°ç±»ä¼¼çš„åŠŸèƒ½ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¦‚ä½•åœ¨ N-API ä¸­åˆ›å»ºå±æ€§çš„ä¾‹å­ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status status;</span></span>
<span class="line"><span>napi_value my_property_name;</span></span>
<span class="line"><span>napi_value my_property_value;</span></span>
<span class="line"><span>napi_value object;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ env å’Œ object å·²ç»è¢«æ­£ç¡®åˆå§‹åŒ–ã€‚</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ›å»ºä¸€ä¸ª JavaScript å­—ç¬¦ä¸²ä½œä¸ºå±æ€§åã€‚</span></span>
<span class="line"><span>status = napi_create_string_utf8(env, &quot;myProperty&quot;, NAPI_AUTO_LENGTH, &amp;my_property_name);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ›å»ºä¸€ä¸ª JavaScript æ•°å­—ä½œä¸ºå±æ€§å€¼ã€‚</span></span>
<span class="line"><span>status = napi_create_double(env, 123, &amp;my_property_value);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å°†åˆ›å»ºçš„å±æ€§å’Œå€¼æ·»åŠ åˆ°å¯¹è±¡ä¸Šã€‚</span></span>
<span class="line"><span>status = napi_set_property(env, object, my_property_name, my_property_value);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è·å–å±æ€§å€¼" tabindex="-1"><a class="header-anchor" href="#è·å–å±æ€§å€¼"><span>è·å–å±æ€§å€¼</span></a></h3><p>åœ¨ JavaScript ä¸­ï¼Œè¦è·å–å¯¹è±¡å±æ€§çš„å€¼éå¸¸ç›´æ¥ï¼Œå°±åƒè¿™æ ·ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> obj</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> {</span><span style="color:#88C0D0;"> myProperty</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 123</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> value</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> obj</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">myProperty</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: 123</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ N-API ä¸­ï¼Œè·å–å±æ€§ä¹Ÿéœ€è¦è°ƒç”¨ç‰¹å®šçš„å‡½æ•°ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status status;</span></span>
<span class="line"><span>napi_value my_property_value;</span></span>
<span class="line"><span>napi_value object;</span></span>
<span class="line"><span>napi_value result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ env å’Œ object å·²ç»è¢«æ­£ç¡®åˆå§‹åŒ–ï¼Œå¹¶ä¸”objectä¸Šæœ‰myPropertyå±æ€§ã€‚</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è·å– myProperty å±æ€§çš„å€¼ã€‚</span></span>
<span class="line"><span>status = napi_get_named_property(env, object, &quot;myProperty&quot;, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾å±æ€§å€¼æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œè½¬æ¢ç»“æœå¹¶è¾“å‡ºã€‚</span></span>
<span class="line"><span>double value;</span></span>
<span class="line"><span>status = napi_get_value_double(env, result, &amp;value);</span></span>
<span class="line"><span>printf(&quot;The property value is: %f\n&quot;, value); // è¾“å‡ºå°†ç±»ä¼¼äº: The property value is: 123.000000</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è®¾ç½®å±æ€§å€¼" tabindex="-1"><a class="header-anchor" href="#è®¾ç½®å±æ€§å€¼"><span>è®¾ç½®å±æ€§å€¼</span></a></h3><p>åœ¨ JavaScript ä¸­ä¿®æ”¹å±æ€§å€¼åŒæ ·å¾ˆç®€å•ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> obj</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> {</span><span style="color:#88C0D0;"> myProperty</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 123</span><span style="color:#ECEFF4;"> }</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">obj</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">myProperty</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 456</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // ä¿®æ”¹å±æ€§å€¼</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä½¿ç”¨ N-API æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¦‚ä¸‹è®¾ç½®å±æ€§å€¼ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status status;</span></span>
<span class="line"><span>napi_value my_property_value;</span></span>
<span class="line"><span>napi_value object;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ env å’Œ object å·²ç»è¢«æ­£ç¡®åˆå§‹åŒ–ï¼Œå¹¶ä¸”objectä¸Šæœ‰myPropertyå±æ€§ã€‚</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript æ•°å­—ä½œä¸ºæ–°çš„å±æ€§å€¼ã€‚</span></span>
<span class="line"><span>status = napi_create_double(env, 456, &amp;my_property_value);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ›´æ–°å±æ€§å€¼ã€‚</span></span>
<span class="line"><span>status = napi_set_named_property(env, object, &quot;myProperty&quot;, my_property_value);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ“ä½œå¯¹è±¡çš„å±æ€§" tabindex="-1"><a class="header-anchor" href="#æ“ä½œå¯¹è±¡çš„å±æ€§"><span>æ“ä½œå¯¹è±¡çš„å±æ€§</span></a></h3><p>åœ¨ JavaScript ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>delete</code> æ¥åˆ é™¤å±æ€§ï¼Œæˆ–è€…ä½¿ç”¨ <code>Object.keys()</code> æ¥åˆ—å‡ºå¯¹è±¡çš„æ‰€æœ‰å±æ€§ç­‰ã€‚å¯¹äº N-APIï¼Œæˆ‘ä»¬åŒæ ·æœ‰å‡½æ•°æ¥å¤„ç†è¿™äº›æ“ä½œã€‚</p><p>åˆ é™¤å±æ€§çš„ä¾‹å­ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status status;</span></span>
<span class="line"><span>napi_value object;</span></span>
<span class="line"><span>bool result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ env å’Œ object å·²ç»è¢«æ­£ç¡®åˆå§‹åŒ–ï¼Œå¹¶ä¸”objectä¸Šæœ‰myPropertyå±æ€§ã€‚</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ é™¤è¯¥å±æ€§ã€‚</span></span>
<span class="line"><span>status = napi_delete_property(env, object, &quot;myProperty&quot;, &amp;result);</span></span>
<span class="line"><span>// result ç°åœ¨ä¸º true è¡¨ç¤ºåˆ é™¤æˆåŠŸã€‚</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šå°±æ˜¯ Node.js ä¸­ N-API å¤„ç† JavaScript å±æ€§çš„åŸºç¡€çŸ¥è¯†å’Œä¸€äº›ç®€å•ä¾‹å­ã€‚è¿™äº›ä¾‹å­å±•ç¤ºäº†å¦‚ä½•åœ¨ç¼–å†™ C/C++ æ’ä»¶æ—¶ä¸ JavaScript å¯¹è±¡çš„å±æ€§è¿›è¡Œäº¤äº’ã€‚è®°å¾—åœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œæ¯æ¬¡è°ƒç”¨åéƒ½éœ€è¦æ£€æŸ¥ <code>napi_status</code> çš„è¿”å›å€¼ï¼Œç¡®ä¿æ“ä½œæˆåŠŸã€‚</p><h3 id="structures" tabindex="-1"><a class="header-anchor" href="#structures"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#structures" target="_blank" rel="noopener noreferrer">Structures</a></span></a></h3><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 JavaScript å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥ç”¨ JavaScript æ¥ç¼–å†™åç«¯ä»£ç ã€‚è€Œ N-APIï¼ˆNode.js APIï¼‰åˆ™æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç”¨æ¥æ„å»ºæœ¬åœ°æ’ä»¶çš„ APIã€‚</p><p>åœ¨ç†è§£ Node.js çš„ N-API æ–‡æ¡£ä¸­çš„ &quot;Structures&quot; ä¸€èŠ‚æ—¶ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ &quot;Structures&quot; åœ¨è¿™é‡ŒæŒ‡çš„æ˜¯ C è¯­è¨€ä¸­çš„ç»“æ„ä½“ï¼ˆstructsï¼‰ã€‚ç»“æ„ä½“æ˜¯ä¸€ç§ç”¨æˆ·è‡ªå®šä¹‰çš„æ•°æ®ç±»å‹ï¼Œå…è®¸ä½ å°†å¤šä¸ªä¸åŒçš„æ•°æ®é¡¹ç»„åˆæˆå•ä¸ªå¤åˆæ•°æ®ç±»å‹ã€‚åœ¨ N-API ä¸­ï¼Œè¿™äº›ç»“æ„ä½“è¢«ç”¨ä½œå’Œ JavaScript è¿è¡Œæ—¶äº¤äº’çš„æ¥å£ã€‚</p><p>ä¸‹é¢æ˜¯å¯¹ &quot;Structures&quot; éƒ¨åˆ†å†…å®¹çš„ç®€è¦è§£é‡Šå’Œå®é™…åº”ç”¨ä¾‹å­ï¼š</p><ol><li><code>napi_property_descriptor</code>ï¼š<br> è¿™æ˜¯ä¸€ä¸ªç»“æ„ï¼Œåœ¨åˆ›å»ºæˆ–å®šä¹‰å¯¹è±¡çš„å±æ€§æ—¶ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³å‘ä¸€ä¸ª JavaScript å¯¹è±¡æ·»åŠ ä¸€ä¸ªæ–°çš„å±æ€§æˆ–æ–¹æ³•ï¼Œä½ å°±ä¼šä½¿ç”¨è¿™ä¸ªç»“æ„ä½“ã€‚</li></ol><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å®šä¹‰ä¸€ä¸ª napi_property_descriptor</span></span>
<span class="line"><span>napi_property_descriptor desc = {</span></span>
<span class="line"><span>    &quot;myProperty&quot;,  // å±æ€§å</span></span>
<span class="line"><span>    NULL,</span></span>
<span class="line"><span>    MyPropertyGetter,  // getter å‡½æ•°</span></span>
<span class="line"><span>    MyPropertySetter,  // setter å‡½æ•°</span></span>
<span class="line"><span>    NULL,</span></span>
<span class="line"><span>    NULL,</span></span>
<span class="line"><span>    napi_default,</span></span>
<span class="line"><span>    NULL</span></span>
<span class="line"><span>};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ<code>MyPropertyGetter</code> å’Œ <code>MyPropertySetter</code> æ˜¯ C å‡½æ•°ï¼Œå½“ä» JavaScript è®¿é—®æˆ–ä¿®æ”¹ <code>myProperty</code>å±æ€§æ—¶ä¼šè°ƒç”¨å®ƒä»¬ã€‚</p><ol start="2"><li><p><code>napi_callback_info</code>ï¼š<br> å½“ä¸€ä¸ªåŸç”Ÿå‡½æ•°ï¼ˆå³ç”± C/C++ ç¼–å†™çš„å‡½æ•°ï¼‰è¢« JavaScript ä»£ç è°ƒç”¨æ—¶ï¼Œ<code>napi_callback_info</code> ç»“æ„ä¼šåŒ…å«è°ƒç”¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ¯”å¦‚ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°ç­‰ã€‚</p></li><li><p><code>napi_ref</code>ï¼š<br> è¿™ä¸ªç»“æ„ä»£è¡¨äº†ä¸€ä¸ªå¯¹ JavaScript å¯¹è±¡çš„å¼ºå¼•ç”¨ã€‚å¦‚æœä½ æœ‰ä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œå¹¶ä¸”ä½ ä¸å¸Œæœ›å®ƒåœ¨æŸä¸ªæ—¶å€™è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>napi_ref</code> æ¥ç¡®ä¿å¯¹è±¡ä¿æŒæ´»è·ƒã€‚</p></li><li><p><code>napi_value</code>ï¼š<br> è¡¨ç¤ºä¸€ä¸ª ECMAScriptï¼ˆJavaScript çš„è§„èŒƒï¼‰å€¼ã€‚æ— è®ºä½•æ—¶ä½ éœ€è¦ä» C/C++ ä»£ç ä¸ JavaScript æ›´åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼ˆå¦‚å­—ç¬¦ä¸²ã€æ•°å­—ã€å¯¹è±¡ç­‰ï¼‰è¿›è¡Œäº¤äº‘ï¼Œéƒ½ä¼šç”¨åˆ° <code>napi_value</code>ã€‚</p></li></ol><p>ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js æ’ä»¶ï¼Œè¯¥æ’ä»¶æä¾›äº†ä¸€ä¸ªåä¸º <code>addNumbers</code> çš„å‡½æ•°ï¼Œç”¨äºè®¡ç®—ä¸¤ä¸ªæ•°çš„å’Œï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åŸç”Ÿ addNumbers å‡½æ•°</span></span>
<span class="line"><span>napi_value AddNumbers(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    size_t argc = 2;</span></span>
<span class="line"><span>    napi_value args[2];</span></span>
<span class="line"><span>    double value1, value2;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å– JavaScript è°ƒç”¨æä¾›çš„å‚æ•°</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç¡®ä¿æ²¡æœ‰å‡ºé”™å¹¶ä¸”æ¥å—äº†ä¸¤ä¸ªå‚æ•°</span></span>
<span class="line"><span>    if (status == napi_ok &amp;&amp; argc == 2) {</span></span>
<span class="line"><span>        // å°† napi_values ï¼ˆJavaScript å€¼ï¼‰è½¬æ¢ä¸º C ç±»å‹çš„ double</span></span>
<span class="line"><span>        status = napi_get_value_double(env, args[0], &amp;value1);</span></span>
<span class="line"><span>        status = napi_get_value_double(env, args[1], &amp;value2);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // è®¡ç®—ä¸¤æ•°ä¹‹å’Œ</span></span>
<span class="line"><span>        double sum = value1 + value2;</span></span>
<span class="line"><span>        napi_value result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // å°† C ç±»å‹çš„å’Œè½¬æ¢å› napi_value</span></span>
<span class="line"><span>        status = napi_create_double(env, sum, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // è¿”å›ç»“æœç»™ JavaScript</span></span>
<span class="line"><span>        return result;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¦‚æœå‡ºç°é”™è¯¯ï¼Œè¿”å› undefined</span></span>
<span class="line"><span>    napi_value undefined;</span></span>
<span class="line"><span>    napi_get_undefined(env, &amp;undefined);</span></span>
<span class="line"><span>    return undefined;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ¨¡å—åˆå§‹åŒ–å‡½æ•°</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªè¡¨ç¤º addNumbers å‡½æ•°çš„ napi_value</span></span>
<span class="line"><span>    status = napi_create_function(env, NULL, 0, AddNumbers, NULL, &amp;fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æŠŠ addNumbers å‡½æ•°ä½œä¸ºæ¨¡å—å¯¼å‡ºçš„å±æ€§</span></span>
<span class="line"><span>    status = napi_set_named_property(env, exports, &quot;addNumbers&quot;, fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œæ¨¡å—</span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª <code>AddNumbers</code> å‡½æ•°ï¼Œå®ƒä½¿ç”¨ <code>napi_get_cb_info</code> æ¥è·å– JavaScript ä¼ é€’çš„å‚æ•°ï¼Œå¹¶ä½¿ç”¨ <code>napi_create_double</code> å’Œ <code>napi_get_value_double</code> æ¥åœ¨ JavaScript çš„æ•°å€¼å’Œ C çš„æ•°å€¼ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚æœ€åï¼Œæˆ‘ä»¬é€šè¿‡ <code>napi_create_function</code> åˆ›å»ºå‡½æ•°å¹¶é€šè¿‡ <code>napi_set_named_property</code> æŠŠå®ƒç»‘å®šåˆ°æ¨¡å—çš„å¯¼å‡ºå¯¹è±¡ä¸Šã€‚</p><p>è¿™æ ·ï¼Œå½“ JavaScript ä»£ç é€šè¿‡ <code>require</code> å¯¼å…¥è¿™ä¸ªæ¨¡å—åï¼Œå°±èƒ½å¤Ÿè°ƒç”¨ <code>addNumbers</code> å‡½æ•°ï¼Œå¹¶ä¸”åœ¨åº•å±‚æ‰§è¡Œæˆ‘ä»¬çš„ C ä»£ç è¿›è¡ŒåŠ æ³•è¿ç®—äº†ã€‚</p><h4 id="napi-property-attributes" tabindex="-1"><a class="header-anchor" href="#napi-property-attributes"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_property_attributes" target="_blank" rel="noopener noreferrer">napi_property_attributes</a></span></a></h4><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ¬æœºæ’ä»¶ï¼ˆnative addonsï¼‰çš„åº•å±‚æ¥å£ï¼Œè¿™äº›æœ¬æœºæ’ä»¶æ˜¯ä½¿ç”¨ C/C++ç¼–å†™çš„ï¼Œç”¨æ¥ç›´æ¥ä¸ Node.js çš„ V8 å¼•æ“è¿›è¡Œäº¤äº’ã€‚<code>napi_property_attributes</code>æ˜¯ N-API ä¸­å®šä¹‰å±æ€§ç‰¹æ€§çš„æšä¸¾ç±»å‹ï¼Œç”¨äºè®¾ç½® JavaScript å¯¹è±¡å±æ€§çš„ä¸€äº›ç‰¹å¾ã€‚</p><p>åœ¨ JavaScript ä¸­ï¼Œå¯¹è±¡çš„å±æ€§å¯ä»¥å…·æœ‰å‡ ä¸ªç‰¹å¾ï¼Œæ¯”å¦‚å®ƒä»¬æ˜¯å¦å¯å†™ï¼ˆwritableï¼‰ã€æ˜¯å¦å¯æšä¸¾ï¼ˆenumerableï¼‰ã€æ˜¯å¦å¯é…ç½®ï¼ˆconfigurableï¼‰ã€‚ç†è§£è¿™äº›ç‰¹å¾å¯¹äºåˆ›å»ºè¡Œä¸ºåƒæ™®é€š JavaScript å¯¹è±¡å±æ€§çš„æœ¬æœºæ’ä»¶éå¸¸é‡è¦ã€‚</p><p><code>napi_property_attributes</code>æšä¸¾ä¸­åŒ…å«ä»¥ä¸‹å€¼ï¼š</p><ul><li><code>napi_default</code>: è¿™æ˜¯é»˜è®¤é€‰é¡¹ï¼Œç­‰åŒäº JavaScript ä¸­æ™®é€šå±æ€§çš„é»˜è®¤è¡Œä¸ºï¼Œå³å±æ€§æ˜¯å¯å†™ã€å¯æšä¸¾ã€å¯é…ç½®çš„ã€‚</li><li><code>napi_readonly</code>: è®¾ç½®è¯¥å±æ€§æ ‡å¿—åï¼Œå±æ€§å°†ä¸å¯å†™ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ ä¸èƒ½æ›´æ”¹å±æ€§çš„å€¼ã€‚</li><li><code>napi_dont_enum</code>: è®¾ç½®è¯¥å±æ€§æ ‡å¿—åï¼Œå±æ€§åœ¨å¯¹è±¡çš„æšä¸¾å±æ€§åˆ—è¡¨ä¸­ä¸ä¼šå‡ºç°ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸ä¼šå‡ºç°åœ¨<code>for...in</code>å¾ªç¯æˆ–<code>Object.keys()</code>çš„è¾“å‡ºä¸­ã€‚</li><li><code>napi_fixed</code>: ç›¸å½“äºåŒæ—¶è®¾ç½®äº†<code>napi_readonly</code>å’Œ<code>napi_dont_delete</code>ï¼Œä½¿å±æ€§æ—¢ä¸å¯å†™ä¹Ÿä¸å¯åˆ é™¤ã€‚</li><li><code>napi_static</code>: è¡¨ç¤ºå±æ€§æ˜¯é™æ€çš„ã€‚</li></ul><p>è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨å®é™…ä¸­ä½¿ç”¨è¿™äº›å±æ€§ï¼š</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" data-title="c++" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²</span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value greeting;</span></span>
<span class="line"><span>    napi_create_string_utf8(env, &quot;Hello World&quot;, NAPI_AUTO_LENGTH, &amp;greeting);</span></span>
<span class="line"><span>    return greeting;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨æ¨¡å—åŠ è½½æ—¶è°ƒç”¨</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    // å®šä¹‰ä¸€ä¸ªæ–°çš„å‡½æ•°å±æ€§</span></span>
<span class="line"><span>    napi_property_descriptor desc = {</span></span>
<span class="line"><span>        &quot;myFunction&quot;,             // å±æ€§åç§°</span></span>
<span class="line"><span>        NULL,                     // å±æ€§çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆSymbolï¼‰ï¼Œè¿™é‡Œæ²¡æœ‰ä½¿ç”¨</span></span>
<span class="line"><span>        MyFunction,               // æŒ‡å‘ä¸Šé¢å®šä¹‰çš„å‡½æ•°çš„æŒ‡é’ˆ</span></span>
<span class="line"><span>        NULL,                     // getter å‡½æ•°ï¼Œè¿™é‡Œä¸éœ€è¦</span></span>
<span class="line"><span>        NULL,                     // setter å‡½æ•°ï¼Œè¿™é‡Œä¸éœ€è¦</span></span>
<span class="line"><span>        NULL,                     // value, å› ä¸ºå·²ç»æŒ‡å®šäº†æ–¹æ³•ï¼Œæ‰€ä»¥ä¸éœ€è¦è®¾ç½®å€¼</span></span>
<span class="line"><span>        napi_default,             // è®¾ç½®å±æ€§ç‰¹æ€§ä¸ºé»˜è®¤</span></span>
<span class="line"><span>        NULL                      // ä»»ä½•ä¸å±æ€§ç›¸å…³çš„æ•°æ®</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åœ¨exportså¯¹è±¡ä¸Šå®šä¹‰å±æ€§</span></span>
<span class="line"><span>    napi_define_properties(env, exports, 1, &amp;desc);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„æœ¬æœºæ’ä»¶ï¼Œå®ƒæš´éœ²äº†ä¸€ä¸ªå‡½æ•°<code>myFunction</code>ã€‚å½“ä½ åœ¨ JavaScript ä¸­è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œå®ƒå°†è¿”å›å­—ç¬¦ä¸²&quot;Hello World&quot;ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨<code>napi_define_properties</code>å‡½æ•°æ¥æŠŠ<code>myFunction</code>æ·»åŠ åˆ°æ¨¡å—çš„å¯¼å‡ºå¯¹è±¡ä¸Šï¼Œå¹¶ä¸”æˆ‘ä»¬è®¾ç½®äº†å±æ€§ç‰¹æ€§ä¸º<code>napi_default</code>ï¼Œè¿™æ„å‘³ç€åœ¨ JavaScript ä»£ç ä¸­ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯å¯å†™çš„ã€å¯æšä¸¾çš„ã€å¯é…ç½®çš„ã€‚</p><p>å¦‚æœæˆ‘ä»¬æƒ³è®©è¿™ä¸ªå‡½æ•°æˆä¸ºåªè¯»çš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨<code>napi_property_descriptor</code>ç»“æ„ä½“ä¸­å°†<code>napi_default</code>æ”¹ä¸º<code>napi_readonly</code>ï¼š</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" data-title="c++" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_property_descriptor desc = {</span></span>
<span class="line"><span>    &quot;myFunction&quot;,</span></span>
<span class="line"><span>    NULL,</span></span>
<span class="line"><span>    MyFunction,</span></span>
<span class="line"><span>    NULL,</span></span>
<span class="line"><span>    NULL,</span></span>
<span class="line"><span>    NULL,</span></span>
<span class="line"><span>    napi_readonly,  // è®¾ç½®å±æ€§ç‰¹æ€§ä¸ºåªè¯»</span></span>
<span class="line"><span>    NULL</span></span>
<span class="line"><span>};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·è®¾ç½®ä¹‹åï¼Œåœ¨ JavaScript ä»£ç ä¸­å°è¯•ä¿®æ”¹<code>myFunction</code>å±æ€§å°†ä¼šå¤±è´¥ã€‚</p><h4 id="napi-property-descriptor" tabindex="-1"><a class="header-anchor" href="#napi-property-descriptor"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_property_descriptor" target="_blank" rel="noopener noreferrer">napi_property_descriptor</a></span></a></h4><p><code>napi_property_descriptor</code> æ˜¯ Node.js ä¸­ N-API çš„ä¸€éƒ¨åˆ†ï¼ŒN-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ API å±‚ã€‚åŸç”Ÿæ’ä»¶æ˜¯ç”¨ C æˆ–è€… C++ å†™çš„æ¨¡å—ï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥è°ƒç”¨ç³»ç»Ÿçº§åˆ«çš„ APIï¼Œé€šå¸¸ç”¨äºæé«˜æ€§èƒ½æˆ–è€…è®¿é—®ä¸€äº› JavaScript æ²¡æœ‰ç›´æ¥æ”¯æŒçš„ä½å±‚åŠŸèƒ½ã€‚</p><p>åœ¨ä»‹ç» <code>napi_property_descriptor</code> ä¹‹å‰ï¼Œéœ€è¦æ˜ç™½åŸç”Ÿæ’ä»¶ä¸­ç»å¸¸éœ€è¦å’Œ JavaScript å¯¹è±¡äº¤äº’ã€‚JavaScript å¯¹è±¡ç”±å±æ€§ç»„æˆï¼Œè¿™äº›å±æ€§å¯ä»¥æ˜¯å€¼ï¼ˆå¦‚å­—ç¬¦ä¸²ã€æ•°å­—ç­‰ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯å‡½æ•°ã€‚<code>napi_property_descriptor</code> å°±æ˜¯ç”¨æ¥å®šä¹‰ä¸€ä¸ªå±æ€§åŠå…¶ç‰¹æ€§çš„ç»“æ„ä½“ï¼ˆC ç»“æ„ä½“ï¼‰ï¼Œå½“ä½ æƒ³è¦åœ¨åŸç”Ÿä»£ç ä¸­åˆ›å»ºæ–°çš„ JavaScript å¯¹è±¡æˆ–è€…ç»™å¯¹è±¡æ·»åŠ å±æ€§æ—¶ä¼šç”¨åˆ°å®ƒã€‚</p><p><code>napi_property_descriptor</code> åŒ…å«ä»¥ä¸‹å­—æ®µï¼š</p><ul><li><code>utf8name</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘å­—ç¬¦æ•°ç»„çš„æŒ‡é’ˆï¼Œä»£è¡¨å±æ€§çš„åå­—ã€‚</li><li><code>name</code>: ä¸€ä¸ª <code>napi_value</code> ç±»å‹ï¼Œè¡¨ç¤ºå±æ€§çš„åç§°ï¼Œç”¨äºå®‰å…¨åœ°å¤„ç†å¯èƒ½åŒ…å«é ASCII å­—ç¬¦çš„å±æ€§åã€‚</li><li><code>method</code>: å¦‚æœè¿™ä¸ªå±æ€§æ˜¯ä¸€ä¸ªå‡½æ•°çš„è¯ï¼Œ<code>method</code> æ˜¯ä¸€ä¸ªæŒ‡å‘è¯¥å‡½æ•°åŸç”Ÿå®ç°çš„æŒ‡é’ˆã€‚</li><li><code>getter</code>: å¦‚æœè¿™ä¸ªå±æ€§æ˜¯é€šè¿‡ getter å‡½æ•°è·å¾—çš„ï¼Œ<code>getter</code> å°±æ˜¯æŒ‡å‘è¯¥ getter å‡½æ•°çš„æŒ‡é’ˆã€‚</li><li><code>setter</code>: å¦‚æœè¿™ä¸ªå±æ€§å¯ä»¥è¢«è®¾ç½®ï¼Œå¹¶ä¸”æœ‰ setter å‡½æ•°ï¼Œ<code>setter</code> å°±æ˜¯æŒ‡å‘è¯¥ setter å‡½æ•°çš„æŒ‡é’ˆã€‚</li><li><code>value</code>: å¦‚æœè¿™ä¸ªå±æ€§æ˜¯ä¸€ä¸ªç®€å•çš„å€¼ï¼Œé‚£ä¹ˆ <code>value</code> å°±ä¼šåŒ…å«è¿™ä¸ªå€¼çš„ <code>napi_value</code> è¡¨ç¤ºã€‚</li><li><code>attributes</code>: è¿™æ˜¯ä¸€ä¸ªä½æ©ç ï¼Œç”¨æ¥å®šä¹‰å±æ€§çš„ç‰¹æ€§ï¼Œæ¯”å¦‚æ˜¯å¦å¯å†™ (<code>napi_writable</code>)ï¼Œæ˜¯å¦å¯æšä¸¾ (<code>napi_enumerable</code>)ï¼Œæ˜¯å¦å¯é…ç½® (<code>napi_configurable</code>) ç­‰ã€‚</li><li><code>data</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘ä»»æ„æ•°æ®çš„æŒ‡é’ˆï¼Œé€šå¸¸ç”¨äºä¸å±æ€§ç›¸å…³è”çš„æ•°æ®ã€‚</li></ul><p>ç°åœ¨ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ <code>napi_property_descriptor</code>ï¼š</p><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œæˆ‘ä»¬å¸Œæœ›æš´éœ²ä¸€ä¸ª JavaScript å¯¹è±¡ç»™ Node.jsï¼Œè¿™ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªå«åš <code>version</code> çš„åªè¯»å±æ€§å’Œä¸€ä¸ªå«åš <code>sayHello</code> çš„æ–¹æ³•ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°å°†ä¼šæˆä¸º sayHello æ–¹æ³•çš„åŸç”Ÿå®ç°</span></span>
<span class="line"><span>napi_value SayHelloMethod(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ª JS å­—ç¬¦ä¸² &quot;Hello, world!&quot;</span></span>
<span class="line"><span>    napi_value greeting;</span></span>
<span class="line"><span>    napi_create_string_utf8(env, &quot;Hello, world!&quot;, NAPI_AUTO_LENGTH, &amp;greeting);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return greeting; // è¿”å›è¿™ä¸ªå­—ç¬¦ä¸²</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// Getter å‡½æ•°ç”¨äºè·å– version å±æ€§</span></span>
<span class="line"><span>napi_value GetVersionValue(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value version_value;</span></span>
<span class="line"><span>    napi_create_double(env, 1.0, &amp;version_value); // å‡è®¾ç‰ˆæœ¬å·æ˜¯ 1.0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return version_value; // è¿”å›ç‰ˆæœ¬å·</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåœ¨æ¨¡å—åŠ è½½æ—¶è¢«è°ƒç”¨</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    // å®šä¹‰ sayHello å±æ€§</span></span>
<span class="line"><span>    napi_property_descriptor say_hello_desc = {</span></span>
<span class="line"><span>        .utf8name = &quot;sayHello&quot;,</span></span>
<span class="line"><span>        .method = SayHelloMethod,</span></span>
<span class="line"><span>        .attributes = napi_default</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å®šä¹‰ version å±æ€§</span></span>
<span class="line"><span>    napi_property_descriptor version_desc = {</span></span>
<span class="line"><span>        .utf8name = &quot;version&quot;,</span></span>
<span class="line"><span>        .getter = GetVersionValue,</span></span>
<span class="line"><span>        .attributes = napi_default | napi_read_only</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç»™ exports å¯¹è±¡æ·»åŠ  sayHello å’Œ version å±æ€§</span></span>
<span class="line"><span>    napi_define_properties(env, exports, 1, &amp;say_hello_desc);</span></span>
<span class="line"><span>    napi_define_properties(env, exports, 1, &amp;version_desc);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ª <code>napi_property_descriptor</code>ï¼š<code>say_hello_desc</code> å’Œ <code>version_desc</code>ï¼Œç„¶ååˆ†åˆ«é€šè¿‡ <code>napi_define_properties</code> æŠŠå®ƒä»¬æ·»åŠ åˆ°å¯¼å‡ºçš„å¯¹è±¡ä¸Šã€‚å½“ JavaScript ä»£ç  <code>require</code> è¿™ä¸ªåŸç”Ÿæ¨¡å—æ—¶ï¼Œå°±å¯ä»¥ç›´æ¥è°ƒç”¨ <code>sayHello()</code> æ–¹æ³•å’Œè®¿é—® <code>version</code> å±æ€§äº†ã€‚</p><p>è¿™å°±æ˜¯ <code>napi_property_descriptor</code> åœ¨ Node.js N-API ä¸­çš„åŸºæœ¬ç”¨æ³•ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥æ„å»ºä¸°å¯Œçš„åŸç”Ÿæ’ä»¶ï¼Œå¹¶æŠŠå®ƒä»¬æ— ç¼é›†æˆåˆ° Node.js åº”ç”¨ç¨‹åºä¸­ã€‚</p><h3 id="functions" tabindex="-1"><a class="header-anchor" href="#functions"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#functions" target="_blank" rel="noopener noreferrer">Functions</a></span></a></h3><p>Node.js ä¸­çš„ N-APIï¼ˆNode.js APIï¼‰æ˜¯ä¸€ä¸ªç”¨ C è¯­è¨€ç¼–å†™çš„æ¥å£ï¼Œå®ƒå…è®¸ä½ åˆ›å»ºå¯ä»¥ç›´æ¥ä¸ Node.js çš„è¿è¡Œæ—¶äº¤äº’çš„æœ¬åœ°æ’ä»¶ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ç”¨åƒ C æˆ– C++è¿™æ ·çš„ä½çº§è¯­è¨€ç¼–å†™æ€§èƒ½æ•æ„Ÿçš„ä»£ç ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ Node.js ä¸­ä½œä¸ºæ¨¡å—è°ƒç”¨ã€‚</p><p>åœ¨ Node.js v21.7.1 ç‰ˆæœ¬çš„æ–‡æ¡£ä¸­ï¼Œâ€œFunctionsâ€éƒ¨åˆ†æŒ‡çš„æ˜¯ N-API æä¾›çš„ä¸€ç³»åˆ—å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å…è®¸å¼€å‘è€…åœ¨æœ¬åœ°æ’ä»¶ä¸­æ‰§è¡Œå„ç§æ“ä½œï¼Œæ¯”å¦‚åˆ›å»ºå¯¹è±¡ã€è°ƒç”¨ JavaScript å‡½æ•°ã€å¤„ç†å¼‚å¸¸ç­‰ã€‚</p><p>æˆ‘ä¼šç”¨å‡ ä¸ªä¾‹å­æ¥è§£é‡Šè¿™ä¸€ç‚¹ï¼š</p><h3 id="_1-åˆ›å»ºåŸç”Ÿå¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#_1-åˆ›å»ºåŸç”Ÿå¯¹è±¡"><span>1. åˆ›å»ºåŸç”Ÿå¯¹è±¡</span></a></h3><p>å‡è®¾ä½ æƒ³è¦åœ¨æœ¬åœ°æ’ä»¶ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å¯¹è±¡ï¼Œå¹¶å°†å…¶è¿”å›ç»™ Node.js çš„ç¯å¢ƒã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CreateObject(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  napi_status status;</span></span>
<span class="line"><span>  napi_value myObject;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡ã€‚</span></span>
<span class="line"><span>  status = napi_create_object(env, &amp;myObject);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return myObject;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œå‡½æ•°ï¼Œä½¿å…¶å¯ä»¥ä»Node.jsè°ƒç”¨ã€‚</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>  napi_status status;</span></span>
<span class="line"><span>  napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ªæ–°å‡½æ•°ã€‚</span></span>
<span class="line"><span>  status = napi_create_function(env, NULL, 0, CreateObject, NULL, &amp;fn);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è®¾ç½®å¯¼å‡ºçš„å‡½æ•°ä¸º &quot;CreateObject&quot;</span></span>
<span class="line"><span>  status = napi_set_named_property(env, exports, &quot;CreateObject&quot;, fn);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-è°ƒç”¨-javascript-å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_2-è°ƒç”¨-javascript-å‡½æ•°"><span>2. è°ƒç”¨ JavaScript å‡½æ•°</span></a></h3><p>å¦‚æœä½ çš„æœ¬åœ°æ’ä»¶æ¥æ”¶åˆ°äº†ä¸€ä¸ª JavaScript å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå¹¶å¸Œæœ›åœ¨æœ¬åœ°ä»£ç ä¸­è°ƒç”¨å®ƒã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CallJsFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  napi_status status;</span></span>
<span class="line"><span>  size_t argc = 1;</span></span>
<span class="line"><span>  napi_value args[1];</span></span>
<span class="line"><span>  napi_value global, jsFunction, result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è·å–JavaScriptä¼ é€’çš„å‚æ•°ã€‚</span></span>
<span class="line"><span>  status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ç¡®ä¿æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªå‡½æ•°ã€‚</span></span>
<span class="line"><span>  napi_valuetype valuetype;</span></span>
<span class="line"><span>  status = napi_typeof(env, args[0], &amp;valuetype);</span></span>
<span class="line"><span>  if (status != napi_ok || valuetype != napi_function) {</span></span>
<span class="line"><span>    // æŠ›å‡ºé”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  jsFunction = args[0];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è·å–å…¨å±€å¯¹è±¡ã€‚</span></span>
<span class="line"><span>  status = napi_get_global(env, &amp;global);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è°ƒç”¨JavaScriptå‡½æ•°ï¼Œæ²¡æœ‰å‚æ•°å’Œè¿”å›å€¼ã€‚</span></span>
<span class="line"><span>  status = napi_call_function(env, global, jsFunction, 0, NULL, &amp;result);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™äº›ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ N-API æä¾›çš„å‡½æ•°æ¥åˆ›å»ºå¯¹è±¡å’Œè°ƒç”¨å‡½æ•°ã€‚å½“ç„¶ï¼ŒN-API æä¾›çš„åŠŸèƒ½è¿œä¸æ­¢è¿™äº›ï¼Œä½†æ˜¯ä¸Šé¢æä¾›äº†ä¸€ä¸ªåŸºæœ¬çš„äº†è§£ã€‚</p><p>è¿™äº›æ¦‚å¿µå¯èƒ½å¯¹äºç¼–ç¨‹æ–°æ‰‹æ¥è¯´æœ‰ç‚¹å¤æ‚ï¼Œå› ä¸ºå®ƒä»¬æ¶‰åŠäº†è·¨è¶Š JavaScript å’Œ C/C++ä¸¤ç§ä¸åŒç¼–ç¨‹è¯­è¨€ç•Œé™çš„ç¼–ç¨‹ç†å¿µã€‚å¦‚æœä½ åˆšå¼€å§‹å­¦ä¹ ç¼–ç¨‹ï¼Œå¹¶ä¸”ä¸“æ³¨äº JavaScriptï¼Œä½ å¯èƒ½ä¸éœ€è¦ç«‹å³æ·±å…¥äº†è§£ N-APIã€‚è¿™æ›´å¤šæ˜¯ä¸ºéœ€è¦é«˜æ€§èƒ½è®¡ç®—å’Œå¯¹ Node.js è¿è¡Œæ—¶æœ‰ç‰¹åˆ«éœ€æ±‚çš„é«˜çº§ç”¨æˆ·æä¾›çš„åŠŸèƒ½ã€‚</p><h4 id="napi-get-property-names" tabindex="-1"><a class="header-anchor" href="#napi-get-property-names"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_property_names" target="_blank" rel="noopener noreferrer">napi_get_property_names</a></span></a></h4><p><code>napi_get_property_names</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ª N-API å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºæœ¬åœ°æ’ä»¶çš„ APIã€‚ç®€å•æ¥è¯´ï¼ŒN-API å…è®¸ä½ ç”¨ C æˆ–è€… C++ç¼–å†™ä»£ç ï¼Œè¿™äº›ä»£ç å¯ä»¥ç›´æ¥ä¸ Node.js çš„ JavaScript å¼•æ“ V8 äº¤äº’ã€‚</p><p>ç°åœ¨æ¥è§£é‡Šä¸€ä¸‹<code>napi_get_property_names</code>çš„ä½œç”¨ã€‚å½“ä½ åœ¨ JavaScript å¯¹è±¡ä¸Šä½¿ç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œå®ƒä¼šè¿”å›é‚£ä¸ª JavaScript å¯¹è±¡çš„æ‰€æœ‰å¯æšä¸¾å±æ€§åç§°çš„åˆ—è¡¨ã€‚æ‰€è°“â€œå¯æšä¸¾â€çš„å±æ€§ï¼ŒæŒ‡çš„æ˜¯é‚£äº›å¯ä»¥é€šè¿‡å¸¸è§„å¾ªç¯å¦‚<code>for...in</code>æ¥è®¿é—®çš„å±æ€§ã€‚</p><p>åœ¨ C æˆ– C++ä¸­ä½¿ç”¨<code>napi_get_property_names</code>çš„ä¼ªä»£ç å¤§è‡´å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status status;</span></span>
<span class="line"><span>napi_value object; // å‡è®¾è¿™æ˜¯ä½ æƒ³è¦è·å–å…¶å±æ€§çš„JSå¯¹è±¡</span></span>
<span class="line"><span>napi_value property_names_array;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è°ƒç”¨napi_get_property_namesæ¥è·å–å±æ€§æ•°ç»„</span></span>
<span class="line"><span>status = napi_get_property_names(env, object, &amp;property_names_array);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ£€æŸ¥æ˜¯å¦è°ƒç”¨æˆåŠŸ</span></span>
<span class="line"><span>if (status == napi_ok) {</span></span>
<span class="line"><span>  // ä½¿ç”¨property_names_array</span></span>
<span class="line"><span>} else {</span></span>
<span class="line"><span>  // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®é™…åº”ç”¨ä¾‹å­ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js æœ¬åœ°æ’ä»¶ï¼Œä½ éœ€è¦åˆ†æä¸€ä¸ªä» JavaScript ä¼ æ¥çš„é…ç½®å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  host</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">localhost</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  port</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 8080</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  username</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">admin</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  password</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">passwd</span><span style="color:#ECEFF4;">&#39;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½ æƒ³åœ¨ä½ çš„ C/C++æ’ä»¶ä¸­æ‰¾å‡ºæ‰€æœ‰çš„é…ç½®é¡¹ã€‚ä½ å¯ä»¥ä½¿ç”¨<code>napi_get_property_names</code>è¿™æ ·åšï¼š</p><ol><li>å½“ JavaScript è°ƒç”¨ä½ çš„æœ¬åœ°æ’ä»¶æ—¶ï¼Œå®ƒä¼šä¼ é€’ä¸Šè¿°é…ç½®å¯¹è±¡ã€‚</li><li>åœ¨ä½ çš„æ’ä»¶ä»£ç ä¸­ï¼Œä½ ä½¿ç”¨<code>napi_get_property_names</code>è·å–è¿™ä¸ªå¯¹è±¡çš„æ‰€æœ‰å±æ€§åç§°ã€‚</li><li>ç„¶åï¼Œä½ å¯ä»¥éå†è¿”å›çš„å±æ€§åç§°æ•°ç»„ï¼Œå¹¶å¯¹æ¯ä¸ªå±æ€§è¿›è¡Œæ“ä½œï¼Œä¾‹å¦‚è¯»å–å€¼ã€è¿›è¡Œæ ¡éªŒç­‰ã€‚</li></ol><p>è¿™ç§æ–¹å¼å¯ä»¥å¸®åŠ©ä½ çš„ C/C++ä»£ç æ›´æ–¹ä¾¿åœ°äº†è§£å’Œæ“ä½œ JavaScript ä¼ å…¥çš„å¯¹è±¡ï¼Œä½¿å¾—æœ¬åœ°æ’ä»¶èƒ½å¤Ÿæ›´ç´§å¯†åœ°ä¸ JavaScript ä»£ç é›†æˆã€‚</p><h4 id="napi-get-all-property-names" tabindex="-1"><a class="header-anchor" href="#napi-get-all-property-names"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_all_property_names" target="_blank" rel="noopener noreferrer">napi_get_all_property_names</a></span></a></h4><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œæ—¶ç¯å¢ƒï¼Œå®ƒå…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚N-API æ˜¯ Node.js çš„ä¸€ä¸ª C API å±‚ï¼Œå®ƒæä¾›äº†æ„å»ºåŸç”Ÿæ’ä»¶çš„æ¥å£ï¼Œè®©å¼€å‘è€…å¯ä»¥ä¸ç”¨ç›´æ¥ä½¿ç”¨åº•å±‚çš„ V8 APIã€‚</p><p><code>napi_get_all_property_names</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºè·å– JavaScript å¯¹è±¡ä¸Šçš„æ‰€æœ‰å±æ€§åç§°ï¼ˆåŒ…æ‹¬è‡ªèº«çš„å’Œç»§æ‰¿çš„å±æ€§ï¼‰ã€‚è¿™ä¸ªå‡½æ•°æ˜¯ä¸ºäº†ä½¿å¾—åŸç”Ÿæ¨¡å—çš„å¼€å‘è€…èƒ½å¤Ÿä» C/C++ ä»£ç ä¸­æ£€ç´¢å‡º JavaScript å¯¹è±¡çš„å±æ€§ååˆ—è¡¨ã€‚</p><h3 id="å‡½æ•°ç­¾å-4" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°ç­¾å-4"><span>å‡½æ•°ç­¾å</span></a></h3><p>å‡½æ•°çš„ç­¾åå¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_get_all_property_names(</span></span>
<span class="line"><span>    napi_env env,</span></span>
<span class="line"><span>    napi_value object,</span></span>
<span class="line"><span>    napi_key_collection_mode key_mode,</span></span>
<span class="line"><span>    napi_key_filter key_filter,</span></span>
<span class="line"><span>    napi_key_conversion key_conversion,</span></span>
<span class="line"><span>    napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>: å½“å‰è°ƒç”¨çš„ç¯å¢ƒã€‚</li><li><code>object</code>: è¦æ£€ç´¢å±æ€§çš„ JavaScript å¯¹è±¡ã€‚</li><li><code>key_mode</code>: æŒ‡å®šè¦è¿”å›å“ªäº›ç±»å‹çš„é”®ï¼Œä¾‹å¦‚åªè¿”å›è‡ªæœ‰å±æ€§æˆ–è¿˜åŒ…æ‹¬åŸå‹é“¾ä¸Šçš„å±æ€§ã€‚</li><li><code>key_filter</code>: ç”¨äºè¿‡æ»¤é”®çš„æ¡ä»¶ï¼Œä¾‹å¦‚æ˜¯å¦æ’é™¤ä¸å¯æšä¸¾çš„å±æ€§ã€‚</li><li><code>key_conversion</code>: é”®çš„è½¬æ¢æ–¹å¼ï¼Œæ¯”å¦‚è¿”å›å­—ç¬¦ä¸²å½¢å¼è¿˜æ˜¯ç¬¦å·ã€‚</li><li><code>result</code>: è¿”å›æ‰¾åˆ°çš„å±æ€§åç§°æ•°ç»„ã€‚</li></ul><h3 id="å‚æ•°è§£é‡Š-1" tabindex="-1"><a class="header-anchor" href="#å‚æ•°è§£é‡Š-1"><span>å‚æ•°è§£é‡Š</span></a></h3><p><code>key_mode</code>, <code>key_filter</code>, å’Œ <code>key_conversion</code> æ˜¯ç‰¹æ®Šçš„æšä¸¾å€¼ï¼Œåˆ†åˆ«ç”¨æ¥æŒ‡æ˜ï¼š</p><ul><li><strong>key_mode</strong>: åº”è¯¥æ£€ç´¢å¯¹è±¡è‡ªå·±çš„å±æ€§ (<code>napi_key_own</code>), è¿˜æ˜¯è¿åŒåŸå‹é“¾ä¸Šçš„å±æ€§ä¸€èµ· (<code>napi_key_include_prototypes</code>).</li><li><strong>key_filter</strong>: å®šä¹‰äº†å“ªäº›å±æ€§å°†è¢«åŒ…æ‹¬åœ¨å†… â€”â€” å¯æšä¸¾çš„ï¼ˆ<code>napi_key_enumerable</code>ï¼‰ã€å¯é…ç½®çš„ï¼ˆ<code>napi_key_configurable</code>ï¼‰ã€å¯å†™çš„ï¼ˆ<code>napi_key_writable</code>ï¼‰ç­‰ã€‚</li><li><strong>key_conversion</strong>: é€šå¸¸è®¾ç½®ä¸º <code>napi_key_keep_numbers</code> è¡¨ç¤ºä¿æŒæ•°å­—å±æ€§ä½œä¸ºæ•°å­—ç±»å‹ï¼Œè€Œä¸æ˜¯è½¬æ¢æˆå­—ç¬¦ä¸²ã€‚</li></ul><h3 id="å®é™…åº”ç”¨ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ç¤ºä¾‹"><span>å®é™…åº”ç”¨ç¤ºä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿçš„ Node.js æ¨¡å—ï¼Œå¹¶å¸Œæœ›æ£€ç´¢ä¸€ä¸ªç»™å®š JavaScript å¯¹è±¡çš„æ‰€æœ‰å¯æšä¸¾å±æ€§åç§°ã€‚ä¸‹é¢æ˜¯å¦‚ä½•ä½¿ç”¨ <code>napi_get_all_property_names</code> æ¥å®Œæˆè¿™é¡¹ä»»åŠ¡çš„ä¼ªä»£ç ä¾‹å­ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ä½ å·²ç»æœ‰äº†ä¸€ä¸ª napi_env env å’Œä¸€ä¸ªè¦æ£€ç´¢å±æ€§çš„ napi_value jsObject.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value propertyNames;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è·å–æ‰€æœ‰è‡ªæœ‰çš„ã€å¯æšä¸¾çš„å±æ€§åç§°ã€‚</span></span>
<span class="line"><span>napi_status status = napi_get_all_property_names(</span></span>
<span class="line"><span>    env,</span></span>
<span class="line"><span>    jsObject,</span></span>
<span class="line"><span>    napi_key_own,             // åªè€ƒè™‘å¯¹è±¡è‡ªèº«çš„å±æ€§</span></span>
<span class="line"><span>    napi_key_enumerable_only, // åªé€‰å–å¯æšä¸¾çš„å±æ€§</span></span>
<span class="line"><span>    napi_key_keep_strings,    // é”®ä½œä¸ºå­—ç¬¦ä¸²è¿”å›</span></span>
<span class="line"><span>    &amp;propertyNames            // è¿™æ˜¯è¾“å‡ºå‚æ•°ï¼Œå°†è¿”å›å±æ€§åæ•°ç»„</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (status == napi_ok) {</span></span>
<span class="line"><span>    // å¦‚æœè°ƒç”¨æˆåŠŸï¼Œä½ ç°åœ¨å¯ä»¥å¤„ç† propertyNames æ•°ç»„äº†ã€‚</span></span>
<span class="line"><span>    // ä¾‹å¦‚ï¼Œä½ å¯ä»¥éå†è¿™äº›å±æ€§åå¹¶åšè¿›ä¸€æ­¥å¤„ç†ã€‚</span></span>
<span class="line"><span>} else {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤æ®µä»£ç å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ <code>napi_get_all_property_names</code> è·å–ä¸€ä¸ª JS å¯¹è±¡è‡ªèº«æ‰€æœ‰å¯æšä¸¾å±æ€§çš„åç§°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®é™…ä»£ç ä¸­åº”å½“æ·»åŠ æ›´å¤šçš„é”™è¯¯æ£€æŸ¥å’Œå¤„ç†é€»è¾‘ã€‚</p><p>è¯·è®°ä½ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦åœ¨ç¼–å†™æ¶‰åŠä¸ JavaScript å¯¹è±¡äº¤äº’çš„åŸç”Ÿæ‰©å±•æ—¶ä½¿ç”¨ï¼Œå¹¶ä¸å¸¸è§äºæ—¥å¸¸çš„ Node.js åº”ç”¨ç¨‹åºå¼€å‘ä¸­ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ ä¼šç›´æ¥ä½¿ç”¨ JavaScript æœ¬èº«æä¾›çš„åå°„ APIï¼Œä¾‹å¦‚ <code>Object.keys()</code> æˆ– <code>Object.getOwnPropertyNames()</code> ç­‰ã€‚</p><h4 id="napi-set-property" tabindex="-1"><a class="header-anchor" href="#napi-set-property"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_set_property" target="_blank" rel="noopener noreferrer">napi_set_property</a></span></a></h4><p>å½“ç„¶ï¼Œå¾ˆé«˜å…´å¸®åŠ©æ‚¨ç†è§£ Node.js ä¸­çš„<code>napi_set_property</code>è¿™ä¸ªå‡½æ•°ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ N-API æ˜¯ä»€ä¹ˆã€‚N-API æ˜¯ Node.js æä¾›çš„ä¸€ä¸ª C è¯­è¨€æ¥å£ï¼Œå®ƒå…è®¸ä½ ç”¨ C æˆ– C++ç¼–å†™æ’ä»¶ï¼ˆç§°ä¸ºæœ¬æœºæ¨¡å—ï¼‰ï¼Œè¿™äº›æ’ä»¶å¯ä»¥ç›´æ¥ä¸ Node.js è¿è¡Œæ—¶ç¯å¢ƒäº¤äº’ã€‚ä½¿ç”¨ N-API ç¼–å†™çš„æœ¬æœºæ¨¡å—ä¸å— Node.js ç‰ˆæœ¬æ›´è¿­çš„å½±å“ï¼Œæ„å‘³ç€å®ƒä»¬æœ‰å¾ˆå¥½çš„å…¼å®¹æ€§å’Œç¨³å®šæ€§ã€‚</p><p><code>napi_set_property</code>æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒç”¨äºå°†ä¸€ä¸ª JavaScript å€¼è®¾ç½®ä¸ºå¯¹è±¡çš„å±æ€§ã€‚è¿™ä¸ªå‡½æ•°åœ¨ C/C++ä»£ç ä¸­æ“ä½œ JavaScript å¯¹è±¡æ—¶éå¸¸æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯å½“ä½ åˆ›å»ºæˆ–ä¿®æ”¹ JavaScript å¯¹è±¡ï¼Œå¹¶æƒ³æŠŠå®ƒä¼ å›ç»™ JavaScript ä»£ç æ—¶ã€‚</p><p>ä½¿ç”¨<code>napi_set_property</code>ä¹‹å‰ï¼Œä½ éœ€è¦æŒæ¡ä»¥ä¸‹æ¦‚å¿µï¼š</p><ul><li><code>napi_env</code>: ä»£è¡¨ N-API ç¯å¢ƒçš„ä¸Šä¸‹æ–‡ï¼Œå‡ ä¹æ‰€æœ‰ N-API å‡½æ•°éƒ½ä¼šç”¨åˆ°å®ƒã€‚</li><li><code>napi_value</code>: è¡¨ç¤º JavaScript å€¼çš„æŠ½è±¡è¡¨ç¤ºï¼Œå¯ä»¥æ˜¯æ•°å­—ã€å­—ç¬¦ä¸²ã€å¯¹è±¡ç­‰ã€‚</li></ul><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>napi_set_property</code>çš„å‡½æ•°ç­¾åï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_set_property(napi_env env,</span></span>
<span class="line"><span>                              napi_value object,</span></span>
<span class="line"><span>                              napi_value key,</span></span>
<span class="line"><span>                              napi_value value);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>: N-API çš„æ‰§è¡Œç¯å¢ƒã€‚</li><li><code>object</code>: ä½ è¦è®¾ç½®å±æ€§çš„ JavaScript å¯¹è±¡ã€‚</li><li><code>key</code>: JavaScript å¯¹è±¡çš„å±æ€§åç§°ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆä¹Ÿå¯ä»¥æ˜¯ Symbolï¼‰ã€‚</li><li><code>value</code>: ä½ æƒ³è¦è®¾ç½®çš„å€¼ã€‚</li></ul><p>ä¸¾ä¾‹æ¥è¯´ï¼Œå‡è®¾ä½ ç”¨ C++å†™äº†ä¸€ä¸ªå‡½æ•°ï¼Œä½ æƒ³è¦åˆ›å»ºä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œç„¶åæ·»åŠ ä¸€ä¸ªå±æ€§<code>name</code>ï¼Œå…¶å€¼ä¸º<code>&quot;Node.js&quot;</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ä½ å·²ç»æœ‰äº†ä¸€ä¸ªnapi_env envå˜é‡</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void CreateObjectWithProperty() {</span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºå¯¹è±¡</span></span>
<span class="line"><span>    napi_value js_object;</span></span>
<span class="line"><span>    napi_create_object(env, &amp;js_object);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºå­—ç¬¦ä¸²&#39;Node.js&#39;</span></span>
<span class="line"><span>    napi_value js_string;</span></span>
<span class="line"><span>    napi_create_string_utf8(env, &quot;Node.js&quot;, NAPI_AUTO_LENGTH, &amp;js_string);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºå±æ€§é”®çš„å­—ç¬¦ä¸²&#39;name&#39;</span></span>
<span class="line"><span>    napi_value js_key;</span></span>
<span class="line"><span>    napi_create_string_utf8(env, &quot;name&quot;, NAPI_AUTO_LENGTH, &amp;js_key);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ä½¿ç”¨napi_set_propertyå°†&#39;name&#39;å±æ€§è®¾ç½®åˆ°å¯¹è±¡ä¸Š</span></span>
<span class="line"><span>    napi_set_property(env, js_object, js_key, js_string);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // js_object ç°åœ¨æ˜¯ä¸€ä¸ªæ‹¥æœ‰ { name: &#39;Node.js&#39; } çš„JavaScriptå¯¹è±¡</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªç©ºçš„ JavaScript å¯¹è±¡<code>js_object</code>ï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ªè¡¨ç¤ºå­—ç¬¦ä¸²<code>&quot;Node.js&quot;</code>çš„<code>napi_value</code>ã€‚æ¥ç€ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªè¡¨ç¤ºå±æ€§é”®<code>&quot;name&quot;</code>çš„<code>napi_value</code>ã€‚æœ€åï¼Œæˆ‘ä»¬è°ƒç”¨<code>napi_set_property</code>å°†è¿™ä¸ªå±æ€§æ·»åŠ åˆ°äº†å¯¹è±¡ä¸Šã€‚</p><p>ç°åœ¨ï¼Œå¦‚æœè¿™ä¸ª C++å‡½æ•°è¢«ç»‘å®šå¹¶ä» JavaScript ä»£ç ä¸­è°ƒç”¨ï¼ŒJavaScript ä»£ç å°±èƒ½æ¥æ”¶åˆ°ä¸€ä¸ªåŒ…å«<code>{ name: &#39;Node.js&#39; }</code>çš„å¯¹è±¡ã€‚</p><p>æ³¨æ„ï¼Œæ‰€æœ‰ N-API å‡½æ•°éƒ½è¿”å›ä¸€ä¸ª<code>napi_status</code>æšä¸¾å€¼ï¼Œè¿™ä¸ªå€¼è¡¨ç¤ºæ“ä½œæ˜¯å¦æˆåŠŸã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œä½ åº”è¯¥æ£€æŸ¥æ¯æ¬¡ N-API è°ƒç”¨çš„è¿”å›å€¼ï¼Œç¡®ä¿æ²¡æœ‰é”™è¯¯å‘ç”Ÿã€‚</p><h4 id="napi-get-property" tabindex="-1"><a class="header-anchor" href="#napi-get-property"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_property" target="_blank" rel="noopener noreferrer">napi_get_property</a></span></a></h4><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome çš„ V8 JavaScript å¼•æ“è¿è¡Œçš„ JavaScript ç¯å¢ƒã€‚å®ƒè®©ä½ å¯ä»¥ç”¨ JavaScript ç¼–å†™æœåŠ¡å™¨ç«¯ä»£ç ï¼Œä»¥åŠåœ¨éæµè§ˆå™¨ç¯å¢ƒä¸‹è¿è¡Œ JavaScriptã€‚N-API æ˜¯ Node.js æä¾›çš„ä¸€ä¸ª API å±‚ï¼Œè¿™ä¸ª API å±‚çš„ç›®æ ‡æ˜¯ä¸ºäº†å‡å°‘åŸç”Ÿæ¨¡å—ç¼–å†™è€…ä¸ Node.js å¼•æ“ä¹‹é—´çš„è€¦åˆï¼Œå¹¶ä¸”è·¨ä¸åŒç‰ˆæœ¬çš„ Node.js æä¾›å…¼å®¹æ€§ã€‚</p><p><code>napi_get_property</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå…è®¸åŸç”Ÿæ¨¡å—ä»£ç ï¼ˆé€šå¸¸æ˜¯ç”¨ C æˆ– C++ å†™çš„ï¼‰è®¿é—® JavaScript å¯¹è±¡çš„å±æ€§ã€‚å½“ä½ æƒ³ä»åŸç”Ÿä»£ç ä¸­è¯»å– JavaScript å¯¹è±¡ä¸Šçš„æŸä¸€ä¸ªå±æ€§æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‡½æ•°ã€‚</p><p>ä¸‹é¢æˆ‘å°†é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è¯´æ˜ <code>napi_get_property</code> çš„ç”¨æ³•ï¼š</p><p>å‡è®¾ä½ æœ‰ä¸€ä¸ª JavaScript å¯¹è±¡å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> user</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">  name</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Alice</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#88C0D0;">  age</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 25</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œå¹¶ä¸”ä½ æƒ³è®¿é—®è¿™ä¸ª <code>user</code> å¯¹è±¡çš„ <code>name</code> å±æ€§ï¼Œä½ ä¼šéœ€è¦é€šè¿‡ N-API è°ƒç”¨ <code>napi_get_property</code> å‡½æ•°ã€‚</p><p>C/C++ åŸç”Ÿä»£ç çš„å¤§è‡´ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... å‡è®¾ä½ å·²æœ‰ napi_env env å’Œ napi_value object å‚æ•°ï¼Œå…¶ä¸­ object æŒ‡å‘äº†æˆ‘ä»¬çš„ user å¯¹è±¡</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_status status;</span></span>
<span class="line"><span>napi_value name_key, name_value;</span></span>
<span class="line"><span>napi_value result;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// é¦–å…ˆåˆ›å»ºä¸€ä¸ªè¡¨ç¤ºå±æ€§åï¼ˆ&quot;name&quot; å­—ç¬¦ä¸²ï¼‰çš„ napi_value</span></span>
<span class="line"><span>status = napi_create_string_utf8(env, &quot;name&quot;, NAPI_AUTO_LENGTH, &amp;name_key);</span></span>
<span class="line"><span>// æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ›å»ºå­—ç¬¦ä¸²</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>  // å¤„ç†é”™è¯¯</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ç„¶åä½¿ç”¨ napi_get_property è·å–å±æ€§å€¼</span></span>
<span class="line"><span>status = napi_get_property(env, object, name_key, &amp;name_value);</span></span>
<span class="line"><span>// æ£€æŸ¥æ“ä½œæ˜¯å¦æˆåŠŸ</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>  // å¤„ç†é”™è¯¯</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å¦‚æœæ“ä½œæˆåŠŸï¼Œç°åœ¨ name_value å°†åŒ…å« user å¯¹è±¡çš„ name å±æ€§å€¼</span></span>
<span class="line"><span>// ä½ å¯ä»¥ç»§ç»­ä½¿ç”¨å…¶ä»– N-API å‡½æ•°æ¥å¤„ç†è¿™ä¸ªå€¼ï¼Œæ¯”å¦‚è½¬æ¢æˆ C å­—ç¬¦ä¸²ç­‰</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•åœ¨ N-API ä¸­åˆ›å»ºä¸€ä¸ªæŒ‡å‘å±æ€§åçš„ <code>napi_value</code>ï¼ˆè¿™é‡Œæ˜¯ &quot;name&quot;ï¼‰ï¼Œç„¶åå¦‚ä½•ä½¿ç”¨ <code>napi_get_property</code> æ¥è·å–å¯¹è±¡ä¸Šè¯¥å±æ€§çš„å€¼ã€‚</p><p>è¯·æ³¨æ„ï¼Œå®é™…ä¸Šåœ¨ç¼–å†™åŸç”Ÿæ‰©å±•æ—¶ï¼Œä½ ä¼šéœ€è¦å¤„ç†å„ç§é”™è¯¯æƒ…å†µï¼Œè¯¸å¦‚æ£€æŸ¥ <code>napi_status</code> è¿”å›å€¼ç¡®ä¿æ¯æ­¥æ“ä½œéƒ½æˆåŠŸæ‰§è¡Œï¼Œå¹¶ä¸”å¯èƒ½éœ€è¦ä¸ JavaScript ä»£ç æ›´ç´§å¯†åœ°äº¤äº’ï¼Œæ¯”å¦‚æ¥æ”¶å‚æ•°æˆ–è¿”å›ç»“æœç»™ JavaScript ç«¯ã€‚ä¸è¿‡ä¸Šè¿°ä¾‹å­æ¶µç›–äº† <code>napi_get_property</code> çš„æ ¸å¿ƒç”¨æ³•ã€‚</p><h4 id="napi-has-property" tabindex="-1"><a class="header-anchor" href="#napi-has-property"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_has_property" target="_blank" rel="noopener noreferrer">napi_has_property</a></span></a></h4><p><code>napi_has_property</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ª N-APIï¼ˆNode.js APIï¼‰å‡½æ•°ï¼Œç”¨æ¥æ£€æŸ¥ JavaScript å¯¹è±¡æ˜¯å¦æ‹¥æœ‰æŸä¸ªå±æ€§ã€‚N-API æ˜¯ä¸€å¥— C è¯­è¨€çš„ APIï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨ C æˆ– C++ æ¥ç¼–å†™å¯ä» JavaScript ä»£ç ä¸­è°ƒç”¨çš„åŸç”Ÿæ‰©å±•æ¨¡å—ã€‚</p><p>ä¸ºäº†æ›´å¥½åœ°ç†è§£è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬é¦–å…ˆè¦äº†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š</p><ol><li><p><strong>JavaScript å¯¹è±¡</strong>ï¼šåœ¨ JavaScript ä¸­ï¼Œå¯¹è±¡æ˜¯é”®å€¼å¯¹çš„é›†åˆã€‚ä¾‹å¦‚ï¼Œ<code>{ name: &quot;Alice&quot;, age: 25 }</code> æ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå±æ€§ <code>name</code> å’Œ <code>age</code> çš„å¯¹è±¡ã€‚</p></li><li><p><strong>å±æ€§</strong>ï¼šå¯¹è±¡ä¸­çš„æ¯ä¸ªé”®ï¼ˆå¦‚ <code>name</code> æˆ– <code>age</code>ï¼‰è¢«ç§°ä¸ºå±æ€§ã€‚</p></li><li><p><strong>åŸç”Ÿæ‰©å±•</strong>ï¼šè¿™æ˜¯ç›´æ¥ç”¨ C/C++ ç¼–å†™çš„ä»£ç ï¼Œå®ƒè¿›è¡Œä¸ JavaScript æ ¸å¿ƒå¼•æ“çš„äº¤äº’ï¼Œé€šå¸¸ç”¨æ¥æ‰§è¡Œä¸èƒ½ç›´æ¥ç”¨ JavaScript å®Œæˆæˆ–è€…æ€§èƒ½è¾ƒå·®çš„ä»»åŠ¡ã€‚</p></li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ <code>napi_has_property</code> å‡½æ•°çš„å®šä¹‰ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_has_property(napi_env env,</span></span>
<span class="line"><span>                              napi_value object,</span></span>
<span class="line"><span>                              napi_value key,</span></span>
<span class="line"><span>                              bool* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>: è¿™æ˜¯ä¸€ä¸ªä»£è¡¨ N-API ç¯å¢ƒçš„å¥æŸ„ã€‚å®ƒæ˜¯å¤§å¤šæ•° N-API å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç”¨äºç®¡ç†å’Œç»´æŠ¤ä¸ Node.js å¼•æ“çš„äº¤äº’ã€‚</li><li><code>object</code>: è¿™æ˜¯è¦æ£€æŸ¥å±æ€§çš„ JavaScript å¯¹è±¡ã€‚</li><li><code>key</code>: è¿™æ˜¯è¦æ£€æŸ¥çš„å±æ€§åç§°ã€‚å®ƒä¹Ÿæ˜¯ä¸€ä¸ª JavaScript å€¼ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–ç¬¦å·ï¼ˆSymbolï¼‰ã€‚</li><li><code>result</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘å¸ƒå°”å€¼çš„æŒ‡é’ˆï¼Œå‡½æ•°ä¼šå°†ç»“æœå­˜å…¥è¿™ä¸ªåœ°å€ã€‚å¦‚æœå±æ€§å­˜åœ¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼ä¼šè®¾ç½®ä¸º <code>true</code>ï¼›å¦åˆ™ï¼Œä¸º <code>false</code>ã€‚</li></ul><p><code>napi_has_property</code> çš„è¿”å›å€¼æ˜¯ <code>napi_status</code> ç±»å‹ï¼Œå…¶ä¸­åŒ…å«äº†æ“ä½œçš„çŠ¶æ€ä¿¡æ¯ï¼Œä¾‹å¦‚æ˜¯å¦æˆåŠŸæ‰§è¡Œæˆ–é‡åˆ°äº†é”™è¯¯ã€‚</p><h3 id="å®é™…è¿ç”¨ä¾‹å­-3" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-3"><span>å®é™…è¿ç”¨ä¾‹å­</span></a></h3><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ‰©å±•ï¼Œéœ€è¦æ£€æŸ¥ä¼ å…¥çš„ JavaScript å¯¹è±¡æ˜¯å¦å…·æœ‰ <code>username</code> å±æ€§ã€‚ä»¥ä¸‹æ˜¯ä¸€æ®µå¯èƒ½çš„ C/C++ ä»£ç ç¤ºä¾‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ...å…¶ä»–å¿…è¦çš„ä»£ç ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CheckProperty(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_value thisArg;</span></span>
<span class="line"><span>    void* data;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–å‡½æ•°å‚æ•°</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, &amp;thisArg, &amp;data);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦æä¾›äº†è¶³å¤Ÿçš„å‚æ•°</span></span>
<span class="line"><span>    if (argc `&lt;` 1) {</span></span>
<span class="line"><span>        napi_throw_type_error(env, NULL, &quot;Wrong number of arguments&quot;);</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºå±æ€§å &quot;username&quot; çš„ JavaScript å­—ç¬¦ä¸²</span></span>
<span class="line"><span>    napi_value key;</span></span>
<span class="line"><span>    napi_create_string_utf8(env, &quot;username&quot;, NAPI_AUTO_LENGTH, &amp;key);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥å¯¹è±¡æ˜¯å¦å«æœ‰è¿™ä¸ªå±æ€§</span></span>
<span class="line"><span>    bool hasProperty;</span></span>
<span class="line"><span>    napi_has_property(env, args[0], key, &amp;hasProperty);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ ¹æ®ç»“æœè¿”å› JavaScript å€¼ true æˆ– false</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    napi_get_boolean(env, hasProperty, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ...å…¶ä»–å¿…è¦çš„ä»£ç ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>CheckProperty</code> çš„å‡½æ•°ï¼Œå®ƒæ£€æŸ¥ä¼ é€’ç»™å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆä¸€ä¸ª JavaScript å¯¹è±¡ï¼‰æ˜¯å¦æœ‰ <code>username</code> å±æ€§ï¼Œå¹¶è¿”å›ä¸€ä¸ªè¡¨ç¤ºç»“æœçš„å¸ƒå°”å€¼ã€‚</p><p>è¯·æ³¨æ„ï¼Œä¸ºäº†å®é™…åœ¨ Node.js ä¸­ä½¿ç”¨è¿™ä¸ªåŸç”Ÿæ‰©å±•ï¼Œä½ è¿˜éœ€è¦ç¼–å†™é¢å¤–çš„ä»£ç æ¥æ³¨å†Œæ‰©å±•æ¨¡å—ã€æ–¹æ³•å’Œåˆå§‹åŒ–å®ƒä»¬ã€‚ä»¥ä¸Šåªæ˜¯å…³äº <code>napi_has_property</code> å¦‚ä½•ä½¿ç”¨çš„ç®€å•æ¼”ç¤ºã€‚</p><h4 id="napi-delete-property" tabindex="-1"><a class="header-anchor" href="#napi-delete-property"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_delete_property" target="_blank" rel="noopener noreferrer">napi_delete_property</a></span></a></h4><p>å½“ç„¶ï¼Œè®©æˆ‘ä»¬æ¥èŠä¸€èŠ Node.js ä¸­çš„ <code>napi_delete_property</code> å‡½æ•°ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ N-API æ˜¯ä»€ä¹ˆï¼šN-API æ˜¯ä¸€ä¸ª C è¯­è¨€çš„ APIï¼Œå®ƒæ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç¨³å®šçš„æŠ½è±¡å±‚ï¼Œå…è®¸ä½ ç¼–å†™å¯è·¨ä¸åŒç‰ˆæœ¬ Node.js è¿è¡Œçš„æœ¬åœ°æ’ä»¶ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·±å…¥åˆ° <code>napi_delete_property</code> è¿™ä¸ªå‡½æ•°ï¼š</p><h3 id="napi-delete-property-1" tabindex="-1"><a class="header-anchor" href="#napi-delete-property-1"><span>napi_delete_property</span></a></h3><p>è¿™ä¸ªå‡½æ•°ç”¨äºä»ä¸€ä¸ª JavaScript å¯¹è±¡ä¸­åˆ é™¤ä¸€ä¸ªå±æ€§ã€‚å®ƒæ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”æ¥å—å‡ ä¸ªå‚æ•°æ¥å®Œæˆæ“ä½œã€‚</p><h4 id="å‚æ•°-4" tabindex="-1"><a class="header-anchor" href="#å‚æ•°-4"><span>å‚æ•°ï¼š</span></a></h4><ul><li><code>env</code>: è¿™æ˜¯è¡¨ç¤º N-API ç¯å¢ƒçš„ä¸€ä¸ªå¥æŸ„ï¼Œå®ƒæä¾›äº†å¤§é‡çš„ N-API è°ƒç”¨æ‰€éœ€çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li><li><code>object</code>: è¿™æ˜¯ä½ æƒ³è¦åˆ é™¤å±æ€§çš„é‚£ä¸ª JavaScript å¯¹è±¡ã€‚</li><li><code>key</code>: è¿™ä»£è¡¨äº†è¦è¢«åˆ é™¤çš„å±æ€§çš„åç§°æˆ–è€… Symbolã€‚</li></ul><h4 id="è¿”å›å€¼-6" tabindex="-1"><a class="header-anchor" href="#è¿”å›å€¼-6"><span>è¿”å›å€¼ï¼š</span></a></h4><ul><li>å¦‚æœæ“ä½œæˆåŠŸï¼Œå®ƒå°†è¿”å› <code>napi_ok</code>ï¼Œè¿™è¡¨æ˜å±æ€§å·²ç»è¢«æˆåŠŸåˆ é™¤ã€‚</li><li>å¦‚æœæœ‰é”™è¯¯å‘ç”Ÿï¼Œå®ƒå°†è¿”å›ä¸€ä¸ªä»£è¡¨ç›¸åº”é”™è¯¯ç±»å‹çš„æšä¸¾å€¼ã€‚</li></ul><h3 id="å®é™…è¿ç”¨ä¾‹å­-4" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ä¾‹å­-4"><span>å®é™…è¿ç”¨ä¾‹å­ï¼š</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js çš„æœ¬åœ°æ’ä»¶ï¼Œè€Œä½ å¸Œæœ›åˆ é™¤ä¸€ä¸ªå¯¹è±¡ä¸­çš„æŸä¸ªå±æ€§ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª JavaScript å¯¹è±¡å¦‚ä¸‹ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> myObject</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">  a</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#88C0D0;">  b</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#88C0D0;">  c</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 3</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ï¼Œä½ æƒ³åœ¨ä½ çš„æœ¬åœ°æ’ä»¶ä¸­åˆ é™¤å±æ€§ <code>b</code>ã€‚</p><p>ä½¿ç”¨ <code>napi_delete_property</code> çš„ C ä»£ç å¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value DeletePropertyExample(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_value object_to_delete_property_from;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–ä¼ é€’ç»™å‡½æ•°çš„ JavaScript å¯¹è±¡</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    object_to_delete_property_from = args[0]; // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬çš„å¯¹è±¡</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºå±æ€§ &#39;b&#39; çš„å­—ç¬¦ä¸²</span></span>
<span class="line"><span>    napi_value key;</span></span>
<span class="line"><span>    status = napi_create_string_utf8(env, &quot;b&quot;, NAPI_AUTO_LENGTH, &amp;key);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ é™¤å±æ€§ &#39;b&#39;</span></span>
<span class="line"><span>    bool result;</span></span>
<span class="line"><span>    status = napi_delete_property(env, object_to_delete_property_from, key, &amp;result);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (result) {</span></span>
<span class="line"><span>        // å±æ€§ &#39;b&#39; å·²è¢«åˆ é™¤</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // å±æ€§ &#39;b&#39; æ²¡æœ‰è¢«åˆ é™¤ï¼ˆå¯èƒ½è¯¥å±æ€§ä¸å­˜åœ¨æˆ–ä¸å¯é…ç½®ï¼‰</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›undefinedï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°ä¸éœ€è¦è¿”å›ä»»ä½•å€¼</span></span>
<span class="line"><span>    napi_value undef;</span></span>
<span class="line"><span>    status = napi_get_undefined(env, &amp;undef);</span></span>
<span class="line"><span>    return undef;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œè¿™ä¸ªå‡½æ•°ä»¥ä¾¿åœ¨JavaScriptä¸­å¯ä»¥è°ƒç”¨</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value deleteFn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, DeletePropertyExample, NULL, &amp;deleteFn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;deletePropertyExample&quot;, deleteFn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ JavaScript é‡Œï¼Œä½ å¯ä»¥è¿™æ ·è°ƒç”¨è¿™ä¸ªæœ¬åœ°å‡½æ•°ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">path-to-your-native-addon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">deletePropertyExample</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">myObject</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">myObject</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // { a: 1, c: 3 }, å±æ€§ &#39;b&#39; å·²ç»è¢«åˆ é™¤</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šå°±æ˜¯ <code>napi_delete_property</code> çš„åŸºç¡€ä»‹ç»å’Œä¸€ä¸ªç®€å•çš„ä½¿ç”¨ç¤ºä¾‹ã€‚å¸Œæœ›èƒ½å¸®åŠ©ä½ ç†è§£è¿™ä¸ªå‡½æ•°å¦‚ä½•åœ¨å®é™…ä¸­åº”ç”¨ï¼</p><h4 id="napi-has-own-property" tabindex="-1"><a class="header-anchor" href="#napi-has-own-property"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_has_own_property" target="_blank" rel="noopener noreferrer">napi_has_own_property</a></span></a></h4><p><code>napi_has_own_property</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ Node.js çš„ N-APIï¼ˆNode.js APIï¼‰çš„ä¸€éƒ¨åˆ†ã€‚N-API æ˜¯ä¸€ä¸ª C å±‚é¢çš„ APIï¼Œè®©ä½ å¯ä»¥åˆ›å»ºåŸç”Ÿçš„æ’ä»¶ï¼Œè¿™äº›æ’ä»¶å¯ä»¥ç›´æ¥å’Œ Node.js äº¤äº’ï¼Œé€šå¸¸ç”¨æ¥æå‡æ€§èƒ½æˆ–è€…è®© Node.js èƒ½å¤Ÿä½¿ç”¨é‚£äº›åªæœ‰ C/C++åº“æ‰æœ‰çš„åŠŸèƒ½ã€‚</p><p>åœ¨è§£é‡Š <code>napi_has_own_property</code> å‰ï¼Œè®©æˆ‘ä»¬å…ˆç†è§£ä¸€ä¸‹ JavaScript ä¸­çš„å¯¹è±¡å±æ€§ã€‚åœ¨ JavaScript ä¸­ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€äº›å±æ€§ï¼Œå®ƒä»¬å¯ä»¥æ˜¯ç›´æ¥å®šä¹‰åœ¨è¯¥å¯¹è±¡ä¸Šçš„ï¼ˆä¹Ÿå°±æ˜¯&quot;è‡ªæœ‰å±æ€§&quot;ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯ä»å®ƒçš„åŸå‹é“¾ä¸­ç»§æ‰¿è€Œæ¥çš„ã€‚æ£€æŸ¥ä¸€ä¸ªå±æ€§æ˜¯å¦ä¸ºå¯¹è±¡çš„è‡ªæœ‰å±æ€§å¾ˆé‡è¦ï¼Œå› ä¸ºè¿™å…³ç³»åˆ°äº†å±æ€§çš„æšä¸¾ã€éå†å’Œæƒé™æ§åˆ¶ç­‰é—®é¢˜ã€‚</p><p>ç°åœ¨å›åˆ° <code>napi_has_own_property</code> å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å‘Šè¯‰æˆ‘ä»¬ä¸€ä¸ªç»™å®šçš„å±æ€§æ˜¯å¦æ˜¯ JavaScript å¯¹è±¡çš„è‡ªæœ‰å±æ€§ã€‚å®ƒæ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤åœ¨ C æˆ– C++ä¸­ç¼–å†™çš„ä»£ç ä¸­è¢«ä½¿ç”¨ï¼Œä¸æ˜¯åœ¨å¸¸è§„çš„ JavaScript ä»£ç ä¸­ã€‚</p><p>å‡½æ•°åŸå‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_has_own_property(napi_env env,</span></span>
<span class="line"><span>                                  napi_value object,</span></span>
<span class="line"><span>                                  napi_value key,</span></span>
<span class="line"><span>                                  bool* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å‚æ•°è§£é‡Šï¼š</strong></p><ul><li><code>env</code>: è¿™æ˜¯è¡¨ç¤º N-API è°ƒç”¨çš„ä¸Šä¸‹æ–‡çš„ç¯å¢ƒå¥æŸ„ã€‚</li><li><code>object</code>: è¿™æ˜¯æˆ‘ä»¬è¦æ£€æŸ¥å±æ€§çš„ JavaScript å¯¹è±¡ã€‚</li><li><code>key</code>: è¡¨ç¤ºæˆ‘ä»¬æƒ³è¦æ£€æŸ¥çš„å±æ€§çš„åç§°æˆ–è€… Symbolã€‚</li><li><code>result</code>: æŒ‡å‘å¸ƒå°”å€¼çš„æŒ‡é’ˆï¼Œå‡½æ•°æ‰§è¡Œåä¼šå°†ç»“æœå­˜å‚¨åœ¨è¿™ä¸ªå¸ƒå°”å€¼ä¸­ã€‚å¦‚æœå±æ€§ç¡®å®å­˜åœ¨å¹¶ä¸”æ˜¯è‡ªæœ‰å±æ€§ï¼Œåˆ™ç»“æœä¸º trueï¼›å¦åˆ™ä¸º falseã€‚</li></ul><p><strong>å‡½æ•°è¿”å›å€¼ï¼š</strong></p><ul><li>è¿”å›ä¸€ä¸ªç±»å‹ä¸º <code>napi_status</code> çš„å€¼ï¼Œè¿™ä¸ªå€¼è¡¨ç¤ºå‡½æ•°è°ƒç”¨æ˜¯å¦æˆåŠŸã€‚å¦‚æœæˆåŠŸï¼Œè¿”å› <code>napi_ok</code>ï¼Œå¦åˆ™è¿”å›é”™è¯¯ç ã€‚</li></ul><p><strong>ä½¿ç”¨åœºæ™¯ä¾‹å­ï¼š</strong></p><p>å‡è®¾ä½ åˆ›å»ºäº†ä¸€ä¸ª Node.js åŸç”Ÿæ¨¡å—ï¼Œéœ€è¦å¯¹ä¼ å…¥çš„ JavaScript å¯¹è±¡è¿›è¡Œæ“ä½œï¼Œå¹¶ä¸”ä½ éœ€è¦åˆ¤æ–­è¿™ä¸ªå¯¹è±¡æ˜¯å¦å…·æœ‰ç‰¹å®šçš„å±æ€§ï¼Œè€Œä¸”è¿™ä¸ªå±æ€§å¿…é¡»æ˜¯è¯¥å¯¹è±¡è‡ªå·±ç‹¬æœ‰çš„ï¼Œä¸æ˜¯ä»åŸå‹ç»§æ‰¿æ¥çš„ã€‚</p><p>C ä»£ç ç¤ºä¾‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–JavaScriptä¼ é€’çš„å‚æ•°</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ ¡éªŒå‚æ•°å¹¶æ‰§è¡Œç›¸å…³æ“ä½œ</span></span>
<span class="line"><span>    if (status == napi_ok &amp;&amp; argc == 1) {</span></span>
<span class="line"><span>        napi_value objectToCheck = args[0];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // æˆ‘ä»¬è¦æ£€æŸ¥çš„å±æ€§</span></span>
<span class="line"><span>        napi_value key;</span></span>
<span class="line"><span>        status = napi_create_string_utf8(env, &quot;myProperty&quot;, NAPI_AUTO_LENGTH, &amp;key);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // æ£€æŸ¥å±æ€§</span></span>
<span class="line"><span>        bool hasOwnProperty;</span></span>
<span class="line"><span>        status = napi_has_own_property(env, objectToCheck, key, &amp;hasOwnProperty);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // æ ¹æ®ç»“æœè¿›è¡Œå¤„ç†</span></span>
<span class="line"><span>        if (status == napi_ok &amp;&amp; hasOwnProperty) {</span></span>
<span class="line"><span>            // å¦‚æœæœ‰è¿™ä¸ªè‡ªæœ‰å±æ€§ï¼Œæ‰§è¡Œä¸€äº›æ“ä½œ...</span></span>
<span class="line"><span>        } else {</span></span>
<span class="line"><span>            // å¦‚æœæ²¡æœ‰è¿™ä¸ªå±æ€§æˆ–è€…å‡ºé”™äº†ï¼Œæ‰§è¡Œå…¶ä»–æ“ä½œ...</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›ä¸€äº›å€¼ç»™JavaScript</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    napi_get_undefined(env, &amp;result);</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆè·å–äº†é€šè¿‡ JavaScript ä¼ é€’è¿‡æ¥çš„å‚æ•°ï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ªå­—ç¬¦ä¸²é”®æ¥è¡¨ç¤ºæˆ‘ä»¬è¦æ£€æŸ¥çš„å±æ€§ <code>&quot;myProperty&quot;</code>ã€‚ä½¿ç”¨ <code>napi_has_own_property()</code> å‡½æ•°æ£€æŸ¥è¿™ä¸ªå±æ€§æ˜¯å¦ä¸ºå¯¹è±¡çš„è‡ªæœ‰å±æ€§ï¼Œæœ€åæ ¹æ®ç»“æœæ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚</p><p>æ€»ç»“èµ·æ¥ï¼Œ<code>napi_has_own_property</code> åœ¨ Node.js çš„ N-API ä¸­ç”¨äºåŸç”Ÿæ¨¡å—å¼€å‘ï¼Œå®ƒå¸®åŠ©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸ªå±æ€§æ˜¯å¦æ˜¯ JavaScript å¯¹è±¡çš„è‡ªæœ‰å±æ€§ã€‚è¿™å¯¹äºè¿›è¡Œæœ‰æ•ˆçš„å±æ€§ç®¡ç†å’Œæ­£ç¡®çš„å†…å­˜æ“ä½œéå¸¸é‡è¦ï¼Œå°¤å…¶æ˜¯åœ¨æ¶‰åŠåŸç”Ÿèµ„æºæ—¶ã€‚</p><h4 id="napi-set-named-property" tabindex="-1"><a class="header-anchor" href="#napi-set-named-property"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_set_named_property" target="_blank" rel="noopener noreferrer">napi_set_named_property</a></span></a></h4><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 JavaScript å¼•æ“çš„ JavaScript è¿è¡Œæ—¶ç¯å¢ƒã€‚å®ƒè®©æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨ JavaScript æ¥ç¼–å†™æœåŠ¡å™¨ç«¯çš„ä»£ç ã€‚N-API åˆ™æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚</p><p>åœ¨ Node.js ä¸­ï¼Œä½ å¯ä»¥ç”¨ JavaScript å†™å¤§éƒ¨åˆ†çš„åŠŸèƒ½ï¼Œä½†æœ‰æ—¶å€™ä½ å¯èƒ½éœ€è¦ç›´æ¥ä½¿ç”¨ C æˆ–è€… C++æ¥å†™ä¸€äº›æ€§èƒ½å…³é”®å‹çš„ä»£ç æˆ–è€…ä¸æ“ä½œç³»ç»Ÿäº¤äº’ã€‚è¿™äº›ç”¨ C æˆ– C++å†™çš„æ¨¡å—ç§°ä¸ºâ€œåŸç”Ÿæ’ä»¶â€ã€‚</p><p><code>napi_set_named_property</code>å‡½æ•°å°±æ˜¯è¿™æ ·ä¸€ä¸ª N-API çš„å‡½æ•°ï¼Œå®ƒå…è®¸åŸç”Ÿæ’ä»¶ï¼ˆC/C++ä»£ç ï¼‰ç»™ä¸€ä¸ª JavaScript å¯¹è±¡è®¾ç½®å±æ€§ã€‚</p><p>è¿™ä¸ªå‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_set_named_property(napi_env env,</span></span>
<span class="line"><span>                                    napi_value object,</span></span>
<span class="line"><span>                                    const char* utf8name,</span></span>
<span class="line"><span>                                    napi_value value);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‚æ•°è§£é‡Šï¼š</p><ul><li><code>env</code>ï¼šä»£è¡¨å½“å‰çš„ N-API ç¯å¢ƒä¸Šä¸‹æ–‡ã€‚</li><li><code>object</code>ï¼šæ˜¯è¦æ·»åŠ å±æ€§çš„ JavaScript å¯¹è±¡ã€‚</li><li><code>utf8name</code>ï¼šæ˜¯ä¸€ä¸ªä»¥ null ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºä½ æƒ³è¦è®¾ç½®çš„å±æ€§çš„åç§°ã€‚</li><li><code>value</code>ï¼šæ˜¯ä¸€ä¸ª<code>napi_value</code>ï¼Œè¡¨ç¤ºå±æ€§çš„å€¼ï¼Œå®ƒå¯ä»¥ä»£è¡¨ä»»ä½• JavaScript æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚ä¸€ä¸ªæ•°å­—ã€å­—ç¬¦ä¸²ã€å¯¹è±¡ç­‰ã€‚</li></ul><p>è¿”å›å€¼ï¼š<code>napi_status</code>ï¼Œå®ƒè¡¨ç¤ºæ“ä½œæˆåŠŸè¿˜æ˜¯å¤±è´¥ç­‰çŠ¶æ€ä¿¡æ¯ã€‚</p><p>ç°åœ¨ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ä½ æ­£åœ¨å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œä½ æƒ³è¦åˆ›å»ºä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œå¹¶ä¸”ç»™å®ƒæ·»åŠ ä¸€ä¸ªå±æ€§å«<code>version</code>ï¼Œå…¶å€¼ä¸ºå­—ç¬¦ä¸²<code>&quot;1.0.0&quot;</code>ã€‚ä¸‹é¢æ˜¯ä½ å¯èƒ½ä¼šæ€ä¹ˆåšçš„ C ä»£ç ç¤ºä¾‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°è¢«æš´éœ²ç»™JavaScriptï¼Œå› æ­¤å¯ä»Node.jsä¸­è°ƒç”¨</span></span>
<span class="line"><span>napi_value CreateObject(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value myObject;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºå¯¹è±¡</span></span>
<span class="line"><span>    status = napi_create_object(env, &amp;myObject);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªJavaScriptå­—ç¬¦ä¸²ï¼Œä½œä¸ºå±æ€§çš„å€¼</span></span>
<span class="line"><span>    napi_value versionString;</span></span>
<span class="line"><span>    status = napi_create_string_utf8(env, &quot;1.0.0&quot;, NAPI_AUTO_LENGTH, &amp;versionString);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è®¾ç½®å¯¹è±¡çš„&quot;version&quot;å±æ€§</span></span>
<span class="line"><span>    status = napi_set_named_property(env, myObject, &quot;version&quot;, versionString);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›åˆ›å»ºçš„å¯¹è±¡</span></span>
<span class="line"><span>    return myObject;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ¨¡å—åˆå§‹åŒ–å‡½æ•°ï¼Œæ­¤å¤„å°†CreateObjectå…³è”åˆ°åä¸º&quot;createObject&quot;çš„å¯¼å‡ºé¡¹</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value exportFunc;</span></span>
<span class="line"><span>    napi_status status = napi_create_function(env, NULL, 0, CreateObject, NULL, &amp;exportFunc);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    return exportFunc;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ä» Node.js ä»£ç ä¸­è°ƒç”¨è¿™ä¸ªæ¨¡å—çš„<code>createObject</code>æ–¹æ³•æ—¶ï¼Œå®ƒå°±ä¼šè¿”å›æˆ‘ä»¬åˆšåˆšåˆ›å»ºå¹¶è®¾ç½®å±æ€§çš„å¯¹è±¡ã€‚</p><p>åœ¨ JavaScript ä¸­ï¼Œä½ å¯èƒ½ä¼šè¿™æ ·ä½¿ç”¨å®ƒï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> addon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> obj</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> addon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createObject</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">obj</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">version</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å°†è¾“å‡º: 1.0.0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å°±èƒ½åœ¨ C/C++ä¸­æ„å»ºå¤æ‚çš„æ•°æ®ç»“æ„ï¼Œç„¶åæŠŠå®ƒä»¬ä¼ é€’ç»™ Node.js çš„ JavaScript ç¯å¢ƒï¼Œéå¸¸æ–¹ä¾¿åœ°è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚</p><h4 id="napi-get-named-property" tabindex="-1"><a class="header-anchor" href="#napi-get-named-property"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_named_property" target="_blank" rel="noopener noreferrer">napi_get_named_property</a></span></a></h4><p>å½“ç„¶ï¼Œæˆ‘å¾ˆä¹æ„å¸®åŠ©ä½ ç†è§£è¿™ä¸ªæ¦‚å¿µã€‚</p><p>Node.js çš„ N-API æ˜¯ä¸€ä¸ª APIï¼Œå®ƒå…è®¸ä½ ç¼–å†™æœ¬åœ°æ’ä»¶ã€‚æ‰€è°“æœ¬åœ°æ’ä»¶ï¼Œå°±æ˜¯ç”¨ C æˆ–è€… C++ å†™çš„ä»£ç ï¼Œè¿™äº›ä»£ç å¯ä»¥ç›´æ¥è°ƒç”¨ Node.js çš„åŠŸèƒ½ã€æˆ–è€…åè¿‡æ¥è¢« Node.js è°ƒç”¨ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥åˆ©ç”¨ C/C++ çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œæˆ–è€…ä½¿ç”¨å·²ç»å­˜åœ¨çš„ C/C++ åº“ã€‚</p><p><code>napi_get_named_property</code> è¿™ä¸ªå‡½æ•°æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºä» JavaScript å¯¹è±¡ä¸­è·å–å±æ€§çš„å€¼ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¦‚æœä½ æœ‰ä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œè€Œä½ åˆåœ¨ C/C++ ä»£ç ä¸­å·¥ä½œï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥è¯»å– JavaScript å¯¹è±¡çš„å±æ€§ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªè¿™æ ·çš„ JavaScript å¯¹è±¡ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> person</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">  name</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Alice</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#88C0D0;">  age</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 25</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæˆ‘ä»¬æƒ³åœ¨ C/C++ æ’ä»¶ä¸­è·å–è¿™ä¸ªå¯¹è±¡çš„ <code>name</code> å±æ€§çš„å€¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ <code>napi_get_named_property</code> å‡½æ•°ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ C/C++ ä¸­ä½¿ç”¨è¿™ä¸ªå‡½æ•°ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ env æ˜¯ napi_env ç±»å‹çš„å˜é‡ï¼Œobj æ˜¯ napi_value ç±»å‹çš„å˜é‡ï¼Œ</span></span>
<span class="line"><span>// è¡¨ç¤ºä¸Šé¢æåˆ°çš„ person å¯¹è±¡</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value name_value;</span></span>
<span class="line"><span>napi_status status = napi_get_named_property(env, obj, &quot;name&quot;, &amp;name_value);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (status == napi_ok) {</span></span>
<span class="line"><span>  // å¦‚æœæˆåŠŸï¼Œname_value ç°åœ¨åŒ…å«äº† name å±æ€§çš„å€¼</span></span>
<span class="line"><span>  // ç„¶åä½ å¯ä»¥æŠŠå®ƒè½¬æ¢æˆ C/C++ å­—ç¬¦ä¸²æˆ–å…¶ä»–ä½ éœ€è¦çš„æ ¼å¼</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ<code>env</code> æ˜¯ä¸€ä¸ªè¡¨ç¤ºå½“å‰ç¯å¢ƒçš„å˜é‡ï¼Œæ‰€æœ‰çš„ N-API è°ƒç”¨éƒ½éœ€è¦å®ƒã€‚<code>obj</code> æ˜¯ä¸€ä¸ª <code>napi_value</code> ç±»å‹çš„å˜é‡ï¼Œè¡¨ç¤ºæˆ‘ä»¬è¦æ“ä½œçš„ JavaScript å¯¹è±¡ã€‚<code>&quot;name&quot;</code> æ˜¯æˆ‘ä»¬æƒ³è¦è¯»å–çš„å±æ€§åï¼Œ<code>name_value</code> å°†ä¼šå¾—åˆ°å±æ€§çš„å€¼ï¼ˆä¹Ÿæ˜¯ä¸€ä¸ª <code>napi_value</code> ç±»å‹ï¼Œå› ä¸ºåœ¨ N-API ä¸­ï¼ŒJavaScript å€¼éƒ½ç”±è¿™ä¸ªç±»å‹è¡¨ç¤ºï¼‰ã€‚</p><p>ä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå‡½æ•°åªè·å–å±æ€§çš„å€¼ï¼Œå¹¶ä¸æ‰§è¡Œä»»ä½• JavaScript ä»£ç ã€‚è¿™æ„å‘³ç€å¦‚æœå±æ€§æ˜¯ getter å‡½æ•°ï¼Œå®ƒä¸ä¼šè¢«è°ƒç”¨ã€‚</p><p>è¿™ç§æœºåˆ¶åœ¨ä¸ JavaScript äº¤äº’æ—¶éå¸¸æœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯å½“ä½ éœ€è¦é«˜æ€§èƒ½å¤„ç†æˆ–è€…éœ€è¦å°†ç°æœ‰çš„ C/C++ ä»£ç é›†æˆåˆ° Node.js åº”ç”¨ç¨‹åºä¸­æ—¶ã€‚</p><h4 id="napi-has-named-property" tabindex="-1"><a class="header-anchor" href="#napi-has-named-property"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_has_named_property" target="_blank" rel="noopener noreferrer">napi_has_named_property</a></span></a></h4><p><code>napi_has_named_property</code> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥è‡ª Node.js çš„ N-APIï¼ˆNode.js APIï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„æ¥å£ã€‚N-API æä¾›äº†ä¸€ç³»åˆ—çš„ C è¯­è¨€ APIï¼Œå…è®¸æœ¬åœ°ä»£ç ä¸ JavaScript ä»£ç è¿›è¡Œäº¤äº’ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>napi_has_named_property</code> å…è®¸ä½ æ£€æŸ¥ä¸€ä¸ª JavaScript å¯¹è±¡æ˜¯å¦æœ‰ä¸€ä¸ªç‰¹å®šåç§°çš„å±æ€§ã€‚</p><h3 id="ä½¿ç”¨åœºæ™¯è§£é‡Š" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯è§£é‡Š"><span>ä½¿ç”¨åœºæ™¯è§£é‡Šï¼š</span></a></h3><p>å½“ä½ åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼ˆé€šå¸¸æ˜¯ç”¨ C æˆ–è€… C++ å†™çš„ï¼‰æ—¶ï¼Œä½ å¯èƒ½éœ€è¦æ£€æŸ¥ä¸€ä¸ªä» JavaScript ä¼ é€’è¿‡æ¥çš„å¯¹è±¡æ˜¯å¦æ‹¥æœ‰æŸä¸ªå±æ€§ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªå¤„ç†é…ç½®å¯¹è±¡çš„æ¨¡å—ï¼Œé‚£ä¹ˆä½ å¯èƒ½æƒ³è¦æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æä¾›äº†æŸäº›å¿…è¦çš„è®¾ç½®ã€‚</p><h3 id="å‡½æ•°ç­¾å-5" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°ç­¾å-5"><span>å‡½æ•°ç­¾åï¼š</span></a></h3><p>è¿™ä¸ªå‡½æ•°çš„å£°æ˜å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_has_named_property(napi_env env, napi_value object, const char* utf8name, bool* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>env</code>: è¡¨ç¤ºä¸€ä¸ª N-API è°ƒç”¨ç¯å¢ƒï¼Œå®ƒè´¯ç©¿æ•´ä¸ª N-API çš„ä½¿ç”¨å‘¨æœŸã€‚</li><li><code>object</code>: æ˜¯æŒ‡å‘ä½ æƒ³è¦æ£€æŸ¥å±æ€§çš„ JavaScript å¯¹è±¡çš„å¼•ç”¨ã€‚</li><li><code>utf8name</code>: æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºä½ è¦æ£€æŸ¥çš„å±æ€§åã€‚</li><li><code>result</code>: æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼çš„æŒ‡é’ˆï¼Œåœ¨å‡½æ•°æ‰§è¡Œåï¼Œ*result ä¼šè¢«è®¾ç½®ä¸º <code>true</code> å¦‚æœè¯¥å±æ€§å­˜åœ¨ï¼Œå¦åˆ™ä¸º <code>false</code>ã€‚</li></ul><h3 id="è¿”å›å€¼-7" tabindex="-1"><a class="header-anchor" href="#è¿”å›å€¼-7"><span>è¿”å›å€¼ï¼š</span></a></h3><p>è¿™ä¸ªå‡½æ•°ä¼šè¿”å›ä¸€ä¸ª <code>napi_status</code> å€¼ï¼Œå‘Šè¯‰ä½ è°ƒç”¨æ˜¯å¦æˆåŠŸã€‚<code>napi_status</code> æ˜¯ä¸€ä¸ªæšä¸¾ï¼ŒåŒ…å«äº†å¤šç§çŠ¶æ€ï¼Œæ¯”å¦‚ <code>napi_ok</code> è¡¨ç¤ºæ“ä½œæˆåŠŸå®Œæˆã€‚</p><h3 id="å®é™…ä¾‹å­-8" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-8"><span>å®é™…ä¾‹å­ï¼š</span></a></h3><p>å‡è®¾æˆ‘ä»¬åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—éœ€è¦ç”¨æˆ·ä¼ é€’ä¸€ä¸ªåŒ…å« <code>config</code> å±æ€§çš„å¯¹è±¡ï¼š</p><p>JavaScript ä¾§ä»£ç å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeModule</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">your-native-module</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">nativeModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">process</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#88C0D0;">  config</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    //... é…ç½®ä¿¡æ¯</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä½ çš„åŸç”Ÿæ¨¡å—ä¸­ï¼Œä½ å¯èƒ½éœ€è¦è¿™æ ·åˆ¤æ–­ <code>process</code> æ–¹æ³•æ¥æ”¶åˆ°çš„å¯¹è±¡æ˜¯å¦å«æœ‰ <code>config</code> å±æ€§ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ object æ˜¯ä» JS ä¼ è¿‡æ¥çš„å‚æ•°</span></span>
<span class="line"><span>napi_value object;</span></span>
<span class="line"><span>bool hasConfig;</span></span>
<span class="line"><span>napi_status status = napi_has_named_property(env, object, &quot;config&quot;, &amp;hasConfig);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>  // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (hasConfig) {</span></span>
<span class="line"><span>  // ç»§ç»­å¤„ç†å­˜åœ¨ config å±æ€§çš„é€»è¾‘...</span></span>
<span class="line"><span>} else {</span></span>
<span class="line"><span>  // æŠ›å‡ºå¼‚å¸¸æˆ–å¤„ç†ä¸å­˜åœ¨ config å±æ€§çš„æƒ…å½¢...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>napi_has_named_property</code> æ¥ç¡®è®¤ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å…·æœ‰ <code>config</code> å±æ€§ï¼Œå¹¶æ®æ­¤è¿›è¡Œä¸åŒçš„å¤„ç†ç­–ç•¥ã€‚å¦‚æœå‘ç°æ²¡æœ‰ <code>config</code> å±æ€§ï¼Œå¯ä»¥æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå‘Šè¯‰ JS ä»£ç ç¼ºå°‘å¿…è¦çš„é…ç½®ã€‚</p><h4 id="napi-set-element" tabindex="-1"><a class="header-anchor" href="#napi-set-element"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_set_element" target="_blank" rel="noopener noreferrer">napi_set_element</a></span></a></h4><p><code>napi_set_element</code>æ˜¯ Node.js ä¸­ N-API çš„ä¸€éƒ¨åˆ†ï¼ŒN-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ API å±‚ã€‚ç®€å•æ¥è¯´ï¼ŒåŸç”Ÿæ’ä»¶å…è®¸ä½ ç”¨ C æˆ– C++ç¼–å†™ä»£ç ï¼Œè¿™äº›ä»£ç å¯ä»¥ç›´æ¥åœ¨ Node.js è¿è¡Œæ—¶ç¯å¢ƒä¸­æ‰§è¡Œï¼Œæä¾›æ€§èƒ½ä¸Šçš„ä¼˜åŠ¿ï¼Œç‰¹åˆ«æ˜¯å¯¹äºéœ€è¦å¤§é‡è®¡ç®—çš„ä»»åŠ¡ã€‚</p><p><code>napi_set_element</code>å…·ä½“æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒç”¨äºè®¾ç½® JavaScript æ•°ç»„ä¸­æŒ‡å®šç´¢å¼•ä½ç½®çš„å…ƒç´ å€¼ã€‚å½“ä½ ç”¨ C æˆ– C++ç¼–å†™ä¸ Node.js äº¤äº’çš„ä»£ç æ—¶ï¼Œä½ å¯èƒ½éœ€è¦æ“ä½œ JavaScript å¯¹è±¡å’Œæ•°ç»„ã€‚è¿™ä¸ªå‡½æ•°å°±æ˜¯ç”¨æ¥å®Œæˆæ•°ç»„æ“ä½œçš„éƒ¨åˆ†å·¥ä½œã€‚</p><h3 id="å‡½æ•°ç­¾å-6" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°ç­¾å-6"><span>å‡½æ•°ç­¾å</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_set_element(</span></span>
<span class="line"><span>    napi_env env,</span></span>
<span class="line"><span>    napi_value array,</span></span>
<span class="line"><span>    uint32_t index,</span></span>
<span class="line"><span>    napi_value value</span></span>
<span class="line"><span>);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>ï¼šè¡¨ç¤ºå½“å‰çš„ N-API ç¯å¢ƒï¼Œé€šå¸¸æ˜¯ä½ åœ¨æ¯ä¸ª N-API å‡½æ•°ä¸­éƒ½ä¼šè§åˆ°çš„å‚æ•°ã€‚ä»»ä½•ä½¿ç”¨ N-API çš„å‡½æ•°å‡ ä¹æ€»æ˜¯éœ€è¦è¿™ä¸ªç¯å¢ƒå˜é‡ã€‚</li><li><code>array</code>ï¼šè¿™æ˜¯ä½ æƒ³è¦ä¿®æ”¹çš„ JavaScript æ•°ç»„çš„å¼•ç”¨ã€‚</li><li><code>index</code>ï¼šä½ å¸Œæœ›è®¾ç½®çš„æ•°ç»„å…ƒç´ çš„ç´¢å¼•ï¼ˆä½ç½®ï¼‰ã€‚</li><li><code>value</code>ï¼šè¿™æ˜¯ä½ æƒ³è¦æ”¾ç½®åœ¨æ•°ç»„ä¸­çš„é‚£ä¸ªç´¢å¼•å¤„çš„å€¼çš„å¼•ç”¨ã€‚</li></ul><h3 id="å®é™…ä¾‹å­-9" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-9"><span>å®é™…ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æœ‰ä¸€ä¸ª JavaScript æ•°ç»„ï¼Œå¹¶ä¸”ä½ æƒ³è¦åœ¨ C++æ‰©å±•ä¸­æ›´æ”¹ç¬¬äºŒä¸ªå…ƒç´ çš„å€¼ã€‚åœ¨ Node.js ä»£ç ä¸­ï¼Œä½ å¯èƒ½ä¼šè¿™æ ·åšï¼š</p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> myArray</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> [</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 3</span><span style="color:#D8DEE9FF;">]</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">myArray</span><span style="color:#D8DEE9FF;">[</span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">] </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 20</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è®¾ç½®æ•°ç»„çš„ç¬¬äºŒä¸ªå…ƒç´ ä¸º20</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½†æ˜¯åœ¨ C++çš„ N-API ä¸­ï¼Œä½ ä¼šä½¿ç”¨<code>napi_set_element</code>æ¥è¾¾åˆ°åŒæ ·çš„ç›®çš„ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value SetElementExample(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æå‰å®šä¹‰å¥½ä½ å°†ç”¨åˆ°çš„N-APIå˜é‡</span></span>
<span class="line"><span>    napi_value myArray;</span></span>
<span class="line"><span>    napi_value valToSet;</span></span>
<span class="line"><span>    uint32_t index = 1; // æˆ‘ä»¬æƒ³è¦è®¾ç½®çš„ç´¢å¼•</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„JavaScriptæ•°ç»„</span></span>
<span class="line"><span>    status = napi_create_array(env, &amp;myArray);</span></span>
<span class="line"><span>    if (status != napi_ok) return nullptr;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è®©æˆ‘ä»¬å‡è®¾è¦è®¾ç½®çš„å€¼æ˜¯20</span></span>
<span class="line"><span>    status = napi_create_int32(env, 20, &amp;valToSet);</span></span>
<span class="line"><span>    if (status != napi_ok) return nullptr;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è®¾ç½®æ•°ç»„çš„ç¬¬äºŒä¸ªå…ƒç´ ï¼ˆindex=1ï¼Œå› ä¸ºç´¢å¼•æ˜¯ä»0å¼€å§‹çš„ï¼‰</span></span>
<span class="line"><span>    status = napi_set_element(env, myArray, index, valToSet);</span></span>
<span class="line"><span>    if (status != napi_ok) return nullptr;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›å·²è¢«ä¿®æ”¹çš„æ•°ç»„</span></span>
<span class="line"><span>    return myArray;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ç„¶åä½ è¿˜éœ€è¦æ³¨å†Œè¿™ä¸ªå‡½æ•°ï¼Œä»¥ä¾¿å®ƒå¯ä»¥ä»Node.jsè°ƒç”¨ï¼Œ</span></span>
<span class="line"><span>// è¿™é€šå¸¸åœ¨N-APIæ¨¡å—çš„åˆå§‹åŒ–å‡½æ•°ä¸­å®Œæˆã€‚</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä¾‹å­æ¼”ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªæ•°ç»„å¹¶è®¾ç½®å…¶ç‰¹å®šç´¢å¼•å¤„çš„å€¼ã€‚è¿™åªæ˜¯<code>napi_set_element</code>çš„ä¸€ä¸ªç®€å•åº”ç”¨å®ä¾‹ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œä½ å¯èƒ½éœ€è¦å¤„ç†æ›´å¤æ‚çš„æ•°æ®ç»“æ„å’Œé”™è¯¯æ£€æŸ¥æµç¨‹ã€‚</p><h4 id="napi-get-element" tabindex="-1"><a class="header-anchor" href="#napi-get-element"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_element" target="_blank" rel="noopener noreferrer">napi_get_element</a></span></a></h4><p><code>napi_get_element</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ª N-API å‡½æ•°ï¼Œç”¨äºä» JavaScript æ•°ç»„ä¸­è·å–æŒ‡å®šç´¢å¼•å¤„çš„å€¼ã€‚N-API æ˜¯ Node.js æä¾›çš„ä¸€å¥— C APIï¼Œä½¿å¾—æœ¬åœ°æ’ä»¶ï¼ˆé€šå¸¸æ˜¯ C æˆ– C++ç¼–å†™çš„æ¨¡å—ï¼‰èƒ½å¤Ÿä¸ JavaScript ä»£ç äº¤äº’ï¼Œå¹¶ä¸”ä¸å— Node.js ç‰ˆæœ¬å˜åŠ¨çš„å½±å“ã€‚</p><p><strong>åŸºæœ¬æ¦‚å¿µï¼š</strong></p><ul><li><strong>N-API</strong>ï¼šä¸€ç»„å›ºå®šçš„ APIï¼Œç‹¬ç«‹äºåº•å±‚çš„ JavaScript è¿è¡Œæ—¶ï¼ˆå¦‚ V8ï¼‰ï¼Œæ—¨åœ¨ä¿æŒäºŒè¿›åˆ¶å…¼å®¹æ€§ï¼Œå³ä½¿ Node.js çš„ç‰ˆæœ¬å‡çº§ä¹Ÿä¸éœ€è¦å¯¹æœ¬åœ°æ’ä»¶é‡æ–°ç¼–è¯‘ã€‚</li><li><strong>JavaScript æ•°ç»„</strong>ï¼šåœ¨ JavaScript ä¸­ï¼Œæ•°ç»„æ˜¯ä¸€ç§ç”¨æ¥å­˜å‚¨å¤šä¸ªå€¼çš„å•ä¸€å˜é‡ã€‚</li></ul><p><strong><code>napi_get_element</code>å‡½æ•°çš„ä½œç”¨ï¼š</strong><br> è¿™ä¸ªå‡½æ•°ç”¨äºè®¿é—® JavaScript ä¸­çš„æ•°ç»„å…ƒç´ ã€‚å®ƒçš„ç­¾åå¤§è‡´å¦‚ä¸‹(ä½¿ç”¨ C è¯­è¨€):</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_get_element(napi_env env,</span></span>
<span class="line"><span>                             napi_value array,</span></span>
<span class="line"><span>                             uint32_t index,</span></span>
<span class="line"><span>                             napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>ï¼šè¡¨ç¤º N-API è°ƒç”¨çš„ä¸Šä¸‹æ–‡ã€‚</li><li><code>array</code>ï¼šä¸€ä¸ª <code>napi_value</code>ï¼Œä»£è¡¨ JavaScript ä¸­çš„æ•°ç»„ã€‚</li><li><code>index</code>ï¼šè¦è®¿é—®æ•°ç»„çš„å“ªä¸ªä½ç½®çš„å…ƒç´ ï¼Œä»¥ 0 å¼€å§‹çš„ç´¢å¼•å€¼ã€‚</li><li><code>result</code>ï¼šç”¨æ¥æ¥æ”¶ä½äºæä¾›ç´¢å¼•çš„æ•°ç»„å…ƒç´ çš„ <code>napi_value</code>ã€‚</li></ul><p>å‡½æ•°è¿”å›ä¸€ä¸ª <code>napi_status</code> å€¼ï¼Œè¡¨ç¤ºæ“ä½œæˆåŠŸä¸å¦ã€‚</p><p><strong>å®é™…åº”ç”¨ä¾‹å­ï¼š</strong></p><p>å‡è®¾æœ‰å¦‚ä¸‹ JavaScript æ•°ç»„ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> numbers</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> [</span><span style="color:#B48EAD;">10</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 20</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 30</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 40</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 50</span><span style="color:#D8DEE9FF;">]</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ä½ æƒ³é€šè¿‡ä¸€ä¸ª C/C++çš„ Node.js æ’ä»¶è·å–è¿™ä¸ªæ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ ï¼ˆ30ï¼‰ã€‚ä½ çš„ C ä»£ç ä¼šåƒè¿™æ ·ä½¿ç”¨<code>napi_get_element</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°è¢«å‡å®šä¸ºå·²ç»è®¾ç½®å¥½ä¸JavaScriptç¯å¢ƒç›¸è”ç³»</span></span>
<span class="line"><span>void GetThirdElementExample(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_value this_arg;</span></span>
<span class="line"><span>    void* data;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–JavaScriptä¼ é€’ç»™è¿™ä¸ªCå‡½æ•°çš„å‚æ•°</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, &amp;this_arg, &amp;data);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // args[0] åº”è¯¥æ˜¯æˆ‘ä»¬çš„JavaScriptæ•°ç»„</span></span>
<span class="line"><span>    napi_value array = args[0];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æˆ‘ä»¬æƒ³è¦è·å–ç¬¬ä¸‰ä¸ªå…ƒç´ ï¼Œç´¢å¼•å€¼ä¸º2</span></span>
<span class="line"><span>    uint32_t index = 2;</span></span>
<span class="line"><span>    napi_value thirdElementValue;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è°ƒç”¨napi_get_elementè·å–æ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ </span></span>
<span class="line"><span>    napi_status status = napi_get_element(env, array, index, &amp;thirdElementValue);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç¡®ä¿æ“ä½œæˆåŠŸ</span></span>
<span class="line"><span>    if (status == napi_ok) {</span></span>
<span class="line"><span>        // å¦‚æœæ“ä½œæˆåŠŸï¼ŒthirdElementValue ç°åœ¨å°±åŒ…å«äº†æ•°å­—30</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // ä»¥ä¸‹ä»£ç å¯ä»¥å°†napi_valueè½¬æ¢ä¸ºCç±»å‹çš„å€¼ï¼Œæ¯”å¦‚int</span></span>
<span class="line"><span>        int thirdElement;</span></span>
<span class="line"><span>        napi_get_value_int32(env, thirdElementValue, &amp;thirdElement);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // ç°åœ¨ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªå€¼åšè¿›ä¸€æ­¥çš„æ“ä½œäº†</span></span>
<span class="line"><span>        // ...</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // é”™è¯¯å¤„ç†ï¼šå¯ä»¥é€šè¿‡statusæ¥åˆ¤æ–­å‘ç”Ÿäº†ä»€ä¹ˆé”™è¯¯</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç æ¼”ç¤ºäº†å¦‚ä½•ä» Node.js ä¼ é€’åˆ°åŸç”Ÿæ’ä»¶çš„æ•°ç»„ä¸­è·å–ç‰¹å®šå…ƒç´ çš„å€¼ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸º C è¯­è¨€ä¸­çš„æ•´æ•°ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œä½ å¯ä»¥åœ¨ C/C++ä»£ç ä¸­å®ç°å¤æ‚çš„é€»è¾‘å¤„ç†ï¼ŒåŒæ—¶åˆ©ç”¨ JavaScript è¿›è¡Œé«˜å±‚æ¬¡çš„åº”ç”¨ç¨‹åºå¼€å‘ã€‚</p><h4 id="napi-has-element" tabindex="-1"><a class="header-anchor" href="#napi-has-element"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_has_element" target="_blank" rel="noopener noreferrer">napi_has_element</a></span></a></h4><p><code>napi_has_element</code> æ˜¯ Node.js ä¸­ N-API (Native API) çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæä¾›äº†ä¸€ç§åœ¨åŸç”Ÿæ¨¡å—ä¸­ä¸ JavaScript äº¤äº’çš„ç¨³å®šã€è·¨ç‰ˆæœ¬çš„æ¥å£ã€‚</p><p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æ£€æŸ¥ä¸€ä¸ª JavaScript å¯¹è±¡æ˜¯å¦å…·æœ‰ç»™å®šçš„ç´¢å¼•å±æ€§ã€‚åœ¨ JavaScript ä¸­ï¼Œä½ å¯ä»¥æŠŠå¯¹è±¡å½“ä½œæ•°ç»„æ¥ä½¿ç”¨ï¼Œè®¿é—®å®ƒçš„å…ƒç´ é€šè¿‡ç´¢å¼•ï¼ˆæ¯”å¦‚ <code>obj[0]</code>, <code>obj[1]</code>ï¼‰ï¼Œè€Œ <code>napi_has_element</code> å°±æ˜¯ç”¨æ¥åˆ¤æ–­æŒ‡å®šç´¢å¼•çš„å…ƒç´ æ˜¯å¦å­˜åœ¨ã€‚</p><p>ä¸‹é¢å°†è¯¦ç»†è§£é‡Š <code>napi_has_element</code> çš„ç”¨æ³•ï¼Œå¹¶ç»™å‡ºä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><h3 id="å‡½æ•°åŸå‹-2" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°åŸå‹-2"><span>å‡½æ•°åŸå‹ï¼š</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_has_element(napi_env env,</span></span>
<span class="line"><span>                             napi_value object,</span></span>
<span class="line"><span>                             uint32_t index,</span></span>
<span class="line"><span>                             bool* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>: <code>napi_env</code> å¯¹è±¡ï¼Œå®ƒä»£è¡¨äº† Node.js çš„è¿è¡Œç¯å¢ƒï¼Œä½ å¯ä»¥é€šè¿‡è¿™ä¸ªç¯å¢ƒæ¥è°ƒç”¨å…¶ä»– N-API å‡½æ•°ã€‚</li><li><code>object</code>: <code>napi_value</code> ç±»å‹ï¼Œè¡¨ç¤ºä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œæˆ‘ä»¬å°†æ£€æŸ¥è¿™ä¸ªå¯¹è±¡æ˜¯å¦å«æœ‰ç‰¹å®šç´¢å¼•çš„å…ƒç´ ã€‚</li><li><code>index</code>: ä¸€ä¸ª <code>uint32_t</code> æ•´æ•°ï¼Œè¡¨ç¤ºè¦æ£€æŸ¥çš„ç´¢å¼•å€¼ã€‚</li><li><code>result</code>: æŒ‡å‘å¸ƒå°”ç±»å‹çš„æŒ‡é’ˆï¼Œå‡½æ•°ä¼šè®¾ç½®è¿™ä¸ªå€¼ä»¥æŒ‡ç¤ºå¯¹è±¡æ˜¯å¦æœ‰è¯¥ç´¢å¼•çš„å…ƒç´ ã€‚</li></ul><h3 id="è¿”å›å€¼-8" tabindex="-1"><a class="header-anchor" href="#è¿”å›å€¼-8"><span>è¿”å›å€¼ï¼š</span></a></h3><p><code>napi_has_element</code> è¿”å› <code>napi_status</code> ç±»å‹çš„å€¼ï¼Œè¿™è¡¨æ˜æ“ä½œæ˜¯å¦æˆåŠŸã€‚å¦‚æœå‡½æ•°è°ƒç”¨æˆåŠŸï¼Œè¿”å› <code>napi_ok</code>ï¼›å¦‚æœå‡ºç°é”™è¯¯ï¼Œåˆ™è¿”å›ä¸åŒçš„é”™è¯¯ç ï¼Œè¡¨æ˜å‘ç”Ÿäº†ä»€ä¹ˆé—®é¢˜ã€‚</p><h3 id="å®é™…ä½¿ç”¨ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#å®é™…ä½¿ç”¨ä¾‹å­"><span>å®é™…ä½¿ç”¨ä¾‹å­ï¼š</span></a></h3><p>å‡è®¾æˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œåœ¨è¿™ä¸ªæ¨¡å—ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦æ£€æŸ¥æŸä¸ª JavaScript æ•°ç»„æˆ–è€…ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡æ˜¯å¦æœ‰ä½äºç¬¬äºŒä¸ªä½ç½®çš„å…ƒç´ ï¼ˆç´¢å¼•ä¸º 1ï¼‰ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... å®šä¹‰å…¶ä»–å¿…è¦çš„å˜é‡å’Œåˆå§‹åŒ–ä»£ç  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value MyNativeFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å‡è®¾ args[0] æ˜¯ä¼ å…¥çš„ JavaScript å¯¹è±¡</span></span>
<span class="line"><span>    bool hasElement;</span></span>
<span class="line"><span>    napi_status status = napi_has_element(env, args[0], 1, &amp;hasElement);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¦‚æœå‡ºç°é”™è¯¯ï¼Œå¤„ç†é”™è¯¯é€»è¾‘</span></span>
<span class="line"><span>        // ...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ ¹æ®æŸ¥è¯¢ç»“æœæ‰§è¡Œä¸åŒçš„é€»è¾‘</span></span>
<span class="line"><span>    if (hasElement) {</span></span>
<span class="line"><span>        // å¯¹è±¡ä¸­æœ‰ç´¢å¼•ä¸º 1 çš„å…ƒç´ </span></span>
<span class="line"><span>        // ...</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // å¯¹è±¡ä¸­æ²¡æœ‰ç´¢å¼•ä¸º 1 çš„å…ƒç´ </span></span>
<span class="line"><span>        // ...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›ä¸€äº›å€¼æˆ– undefined</span></span>
<span class="line"><span>    napi_value undefined;</span></span>
<span class="line"><span>    napi_get_undefined(env, &amp;undefined);</span></span>
<span class="line"><span>    return undefined;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†ŒåŸç”Ÿå‡½æ•°ç­‰å…¶ä»–ç›¸å…³ä»£ç ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåŸç”Ÿå‡½æ•° <code>MyNativeFunction</code>ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªå‚æ•°å¹¶ä¸”è°ƒç”¨ <code>napi_has_element</code> æ¥æ£€æŸ¥è¯¥å‚æ•°æ˜¯å¦æœ‰ç´¢å¼•ä¸º 1 çš„å…ƒç´ ã€‚æ ¹æ®æ£€æŸ¥çš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥å†³å®šæ‰§è¡Œä¸åŒçš„é€»è¾‘ã€‚æœ€åï¼Œè¿™ä¸ªå‡½æ•°è¿”å›äº† <code>undefined</code> æˆ–è€…å…¶å®ƒä¸€äº›å€¼ï¼Œå–å†³äºå…·ä½“å®ç°ã€‚</p><h4 id="napi-delete-element" tabindex="-1"><a class="header-anchor" href="#napi-delete-element"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_delete_element" target="_blank" rel="noopener noreferrer">napi_delete_element</a></span></a></h4><p>åœ¨ Node.js ä¸­ï¼Œ<code>napi_delete_element</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå±äº N-APIï¼ˆNode APIï¼‰ï¼Œè¿™æ˜¯ä¸€å¥—ç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶çš„ APIã€‚N-API è®¾è®¡çš„ç›®çš„æ˜¯ä¸ºäº†è®© C æˆ– C++ç¼–å†™çš„æ’ä»¶èƒ½å¤Ÿåœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸­è¿è¡Œè€Œä¸éœ€è¦é‡æ–°ç¼–è¯‘ï¼Œæé«˜æ¨¡å—çš„ç¨³å®šæ€§å’Œå…¼å®¹æ€§ã€‚</p><p><code>napi_delete_element</code>å‡½æ•°çš„ä½œç”¨æ˜¯ä» JavaScript å¯¹è±¡ä¸­åˆ é™¤ä¸€ä¸ªå±æ€§ï¼Œä¸ JavaScript ä¸­çš„<code>delete object[property]</code>æ“ä½œç›¸ä¼¼ã€‚ä½†è¿™é‡Œçš„å¯¹è±¡æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå› æ­¤è¯¥å‡½æ•°ç‰¹æŒ‡ä»æ•°ç»„ä¸­ç§»é™¤ç´¢å¼•å¤„çš„å…ƒç´ ã€‚</p><p>æˆ‘ä»¬ç°åœ¨æ¥è¯¦ç»†è§£é‡Šä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼š</p><h3 id="å‡½æ•°ç­¾å-7" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°ç­¾å-7"><span>å‡½æ•°ç­¾å</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_delete_element(napi_env env, napi_value object, uint32_t index, bool* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>napi_env env</code>: è¿™æ˜¯è¡¨ç¤º N-API ç¯å¢ƒçš„å¥æŸ„ã€‚å®ƒæ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œæä¾›äº†è®¸å¤š N-API è°ƒç”¨æ‰€éœ€çš„ä¿¡æ¯ã€‚</li><li><code>napi_value object</code>: è¿™æ˜¯æ•°ç»„å¯¹è±¡çš„å¥æŸ„ï¼Œè¡¨ç¤ºè¦æ“ä½œçš„æ•°ç»„ã€‚</li><li><code>uint32_t index</code>: è¿™æ˜¯ä½ æƒ³è¦åˆ é™¤çš„æ•°ç»„å…ƒç´ çš„ç´¢å¼•ã€‚</li><li><code>bool* result</code>: è¿™ä¸ªå‚æ•°ä¼šè¿”å›æ“ä½œæ˜¯å¦æˆåŠŸã€‚å¦‚æœåˆ é™¤æˆåŠŸï¼Œå®ƒä¼šè¢«è®¾ç½®ä¸º<code>true</code>ï¼›å¦åˆ™ä¸º<code>false</code>ã€‚</li></ul><h3 id="è¿”å›å€¼-9" tabindex="-1"><a class="header-anchor" href="#è¿”å›å€¼-9"><span>è¿”å›å€¼</span></a></h3><p>è¿”å›ä¸€ä¸ª<code>napi_status</code>æšä¸¾å€¼ï¼Œä»£è¡¨å‡½æ•°æ‰§è¡Œçš„çŠ¶æ€ã€‚å¦‚æœè¿”å›<code>napi_ok</code>ï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰é”™è¯¯å‘ç”Ÿã€‚</p><h3 id="ä¸¾ä¾‹è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#ä¸¾ä¾‹è¯´æ˜"><span>ä¸¾ä¾‹è¯´æ˜</span></a></h3><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª Node.js çš„æœ¬åœ°æ’ä»¶ï¼Œåœ¨ C/C++ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›åˆ é™¤ä¸€ä¸ª JavaScript æ•°ç»„ä¸­çš„ç‰¹å®šå…ƒç´ ã€‚æˆ‘ä»¬çš„ä»£ç å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™ä¸ªå‡½æ•°æ˜¯ä¸ºäº†ä»ç»™å®šçš„JavaScriptæ•°ç»„ä¸­åˆ é™¤ç‰¹å®šç´¢å¼•å¤„çš„å…ƒç´ </span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value DeleteElementFromJSArray(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 2;</span></span>
<span class="line"><span>    napi_value args[2];</span></span>
<span class="line"><span>    napi_value this_arg;</span></span>
<span class="line"><span>    void* data;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è§£æä¼ å…¥çš„å‚æ•°</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, &amp;this_arg, &amp;data);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // args[0] åº”è¯¥æ˜¯ä¸€ä¸ªæ•°ç»„</span></span>
<span class="line"><span>    napi_value js_array = args[0];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // args[1] åº”è¯¥æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œè¡¨ç¤ºæ•°ç»„ä¸­è¦åˆ é™¤çš„å…ƒç´ ç´¢å¼•</span></span>
<span class="line"><span>    uint32_t index;</span></span>
<span class="line"><span>    napi_get_value_uint32(env, args[1], &amp;index);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ‰§è¡Œåˆ é™¤æ“ä½œ</span></span>
<span class="line"><span>    bool result;</span></span>
<span class="line"><span>    napi_status status = napi_delete_element(env, js_array, index, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ“ä½œæ˜¯å¦æˆåŠŸ</span></span>
<span class="line"><span>    if (status == napi_ok &amp;&amp; result) {</span></span>
<span class="line"><span>        // åˆ é™¤æˆåŠŸ</span></span>
<span class="line"><span>        return nullptr; // æˆ–è¿”å›ä¸€ä¸ªè¡¨ç¤ºæˆåŠŸçš„JavaScriptå€¼</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // åˆ é™¤å¤±è´¥ï¼Œå¯ä»¥æ ¹æ®å…·ä½“æƒ…å†µå¤„ç†é”™è¯¯</span></span>
<span class="line"><span>        return nullptr; // æˆ–è¿”å›ä¸€ä¸ªè¡¨ç¤ºå¤±è´¥çš„JavaScriptå€¼</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å°†ä¸Šé¢çš„å‡½æ•°æš´éœ²ä¸ºæ¨¡å—çš„å¯¼å‡º</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, DeleteElementFromJSArray, NULL, &amp;fn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;deleteElement&quot;, fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<code>DeleteElementFromJSArray</code>å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªæ˜¯ JavaScript æ•°ç»„ï¼Œç¬¬äºŒä¸ªæ˜¯è¦åˆ é™¤çš„å…ƒç´ ç´¢å¼•ã€‚ä½¿ç”¨<code>napi_get_cb_info</code>è·å– JavaScript ä¼ é€’çš„å‚æ•°ï¼Œç„¶åè°ƒç”¨<code>napi_delete_element</code>æ‰§è¡Œåˆ é™¤æ“ä½œã€‚æœ€åï¼Œæ ¹æ®æ“ä½œç»“æœè¿”å›ç›¸åº”çš„ JavaScript å€¼ã€‚</p><p>è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™åªæ˜¯ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­ï¼Œå®é™…ä¸Šè¿˜éœ€è¦è¿›è¡Œæ›´å¤šçš„é”™è¯¯æ£€æŸ¥å’Œè¾¹ç•Œæ£€æŸ¥ç­‰æ“ä½œã€‚</p><h4 id="napi-define-properties" tabindex="-1"><a class="header-anchor" href="#napi-define-properties"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_define_properties" target="_blank" rel="noopener noreferrer">napi_define_properties</a></span></a></h4><p><code>napi_define_properties</code> æ˜¯ Node.js ä¸­ N-API çš„ä¸€éƒ¨åˆ†ï¼ŒN-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚åŸç”Ÿæ’ä»¶æ˜¯ç”¨ C æˆ– C++ç¼–å†™çš„ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ Node.js åº•å±‚ APIï¼Œé€šå¸¸ç”¨äºæå‡æ€§èƒ½æˆ–å®ç° Node.js æœ¬èº«æ— æ³•ç›´æ¥å®ç°çš„åŠŸèƒ½ã€‚</p><p>åœ¨ä»‹ç» <code>napi_define_properties</code> ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£å‡ ä¸ªæ¦‚å¿µï¼š</p><ol><li><p><strong>N-API</strong>: Node.js çš„ Native APIï¼Œä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿä¸ä¾èµ–äº V8 å¼•æ“çš„å†…éƒ¨ç»“æ„æ¥æ„å»ºæ‰©å±•æ¨¡å—ã€‚è¿™æ„å‘³ç€ä½¿ç”¨ N-API çš„æ‰©å±•æ¨¡å—ä¸ Node.js çš„ç‰ˆæœ¬æ— å…³ï¼Œå¯ä»¥åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸­è¿è¡Œè€Œæ— éœ€é‡æ–°ç¼–è¯‘ã€‚</p></li><li><p><strong>å¯¹è±¡å±æ€§</strong>: åœ¨ JavaScript ä¸­ï¼Œå¯¹è±¡ç”±å±æ€§ç»„æˆï¼Œæ¯ä¸ªå±æ€§éƒ½æœ‰ä¸€ä¸ªé”®ï¼ˆkeyï¼‰å’Œç›¸åº”çš„å€¼ï¼ˆvalueï¼‰ã€‚å±æ€§è¿˜å¯ä»¥åŒ…å«å¦‚æ˜¯å¦å¯å†™ã€æ˜¯å¦å¯æšä¸¾ç­‰ç‰¹æ€§ã€‚</p></li><li><p><strong>napi_value</strong>: è¿™æ˜¯ä¸€ä¸ªä»£è¡¨ JavaScript å€¼çš„æŠ½è±¡å¥æŸ„ï¼Œåœ¨ N-API å‡½æ•°ä¸­ç”¨æ¥è¡¨ç¤ºå„ç§ç±»å‹çš„å€¼ï¼Œæ¯”å¦‚æ•°å­—ã€å­—ç¬¦ä¸²ã€å¯¹è±¡ç­‰ã€‚</p></li><li><p><strong>napi_property_descriptor</strong>: è¿™æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œç”¨æ¥æè¿°å¯¹è±¡çš„å±æ€§ï¼ŒåŒ…æ‹¬å±æ€§åç§°ã€å±æ€§ç‰¹æ€§ç­‰ã€‚</p></li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ <code>napi_define_properties</code> å‡½æ•°ã€‚å®ƒç”¨äºåœ¨ä¸€ä¸ªå·²å­˜åœ¨çš„ JavaScript å¯¹è±¡ä¸Šå®šä¹‰æ–°çš„å±æ€§ã€‚è¿™ä¸ªå‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_define_properties(napi_env env,</span></span>
<span class="line"><span>                                   napi_value object,</span></span>
<span class="line"><span>                                   size_t properties_count,</span></span>
<span class="line"><span>                                   const napi_property_descriptor* properties);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‚æ•°è§£é‡Šï¼š</p><ul><li><code>env</code>: å½“å‰æ‰§è¡Œç¯å¢ƒã€‚</li><li><code>object</code>: è¦å®šä¹‰å±æ€§çš„ JavaScript å¯¹è±¡ã€‚</li><li><code>properties_count</code>: è¦å®šä¹‰çš„å±æ€§æ•°é‡ã€‚</li><li><code>properties</code>: æŒ‡å‘<code>napi_property_descriptor</code>æ•°ç»„çš„æŒ‡é’ˆï¼Œæ¯ä¸ªå…ƒç´ æè¿°ä¸€ä¸ªå±æ€§ã€‚</li></ul><p>ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œä½ é¦–å…ˆåˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª <code>napi_property_descriptor</code> ç»“æ„ä½“æ¥è¡¨ç¤ºä½ æƒ³åœ¨ JavaScript å¯¹è±¡ä¸Šå®šä¹‰çš„å±æ€§ï¼Œç„¶åé€šè¿‡ <code>napi_define_properties</code> å°†å®ƒä»¬æ·»åŠ åˆ°å¯¹è±¡ä¸Šã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œéœ€è¦åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šå®šä¹‰ä¸¤ä¸ªå±æ€§ï¼šä¸€ä¸ªæ˜¯å¯è¯»å†™çš„ <code>myNumber</code>ï¼Œå¦ä¸€ä¸ªæ˜¯åªè¯»çš„ <code>myString</code>ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>  // å®šä¹‰å±æ€§æè¿°ç¬¦æ•°ç»„</span></span>
<span class="line"><span>  napi_property_descriptor properties[] = {</span></span>
<span class="line"><span>    { &quot;myNumber&quot;, NULL, 0, 0, 0, 0, napi_default, 0 },</span></span>
<span class="line"><span>    { &quot;myString&quot;, NULL, 0, 0, 0, 0, napi_default, (void*)&quot;this is a string&quot; }</span></span>
<span class="line"><span>  };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºå¯¹è±¡</span></span>
<span class="line"><span>  napi_value myObject;</span></span>
<span class="line"><span>  napi_create_object(env, &amp;myObject);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å®šä¹‰myNumberä¸ºä¸€ä¸ªå¯è¯»å†™çš„å±æ€§ï¼Œé»˜è®¤å€¼æ˜¯42</span></span>
<span class="line"><span>  napi_value numberValue;</span></span>
<span class="line"><span>  napi_create_double(env, 42, &amp;numberValue);</span></span>
<span class="line"><span>  properties[0].value = numberValue;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å®šä¹‰myStringä¸ºä¸€ä¸ªåªè¯»çš„å±æ€§</span></span>
<span class="line"><span>  properties[1].getter = [](napi_env env, napi_callback_info info) -&gt; napi_value {</span></span>
<span class="line"><span>    void* data;</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, NULL, NULL, NULL, &amp;data);</span></span>
<span class="line"><span>    napi_value stringValue;</span></span>
<span class="line"><span>    napi_create_string_utf8(env, static_cast`&lt;`char*&gt;(data), NAPI_AUTO_LENGTH, &amp;stringValue);</span></span>
<span class="line"><span>    return stringValue;</span></span>
<span class="line"><span>  };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å°†å±æ€§æ·»åŠ åˆ°å¯¹è±¡ä¸Š</span></span>
<span class="line"><span>  napi_define_properties(env, myObject, sizeof(properties) / sizeof(properties[0]), properties);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å¯¼å‡ºè¿™ä¸ªå¯¹è±¡</span></span>
<span class="line"><span>  napi_set_named_property(env, exports, &quot;myModule&quot;, myObject);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ JavaScript å¯¹è±¡ï¼Œå¹¶ä¸ºå®ƒå®šä¹‰äº†ä¸¤ä¸ªå±æ€§ã€‚<code>myNumber</code> å±æ€§è¢«è®¾ç½®ä¸ºåˆå§‹å€¼ 42ï¼Œå¹¶ä¸”æ˜¯å¯è¯»å†™çš„ã€‚<code>myString</code> å±æ€§é€šè¿‡ä¸€ä¸ª getter å‡½æ•°å®šä¹‰ï¼Œå½“åœ¨ JavaScript ä¸­è®¿é—®è¿™ä¸ªå±æ€§æ—¶ï¼Œgetter å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²&quot;this is a string&quot;ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬å°†è¿™ä¸ªå¯¹è±¡å¯¼å‡ºä¸ºæ¨¡å—çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ ·åœ¨ JavaScript ä»£ç ä¸­å°±å¯ä»¥é€šè¿‡ require åŠ è½½å¹¶ä½¿ç”¨è¿™ä¸ªå¯¹è±¡åŠå…¶å®šä¹‰çš„å±æ€§äº†ã€‚</p><h4 id="napi-object-freeze" tabindex="-1"><a class="header-anchor" href="#napi-object-freeze"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_object_freeze" target="_blank" rel="noopener noreferrer">napi_object_freeze</a></span></a></h4><p>Node.js æ˜¯ä¸€ä¸ªååˆ†æµè¡Œçš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œå®ƒå…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚N-API æ˜¯ Node.js æä¾›çš„ä¸€å¥—ç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚åŸç”Ÿæ’ä»¶æ˜¯ä½¿ç”¨åƒ C æˆ–è€… C++è¿™æ ·çš„è¯­è¨€ç¼–å†™çš„æ¨¡å—ï¼Œå¯ä»¥ç›´æ¥å’Œ Node.js çš„åº•å±‚ API è¿›è¡Œäº¤äº’ã€‚</p><p><code>napi_object_freeze</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå…¶ç›®çš„åœ¨äºè®©ä¸€ä¸ª JavaScript å¯¹è±¡å˜å¾—ä¸å¯ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦ä¸€ä¸ªå¯¹è±¡è¢«å†»ç»“ï¼ˆfreezeï¼‰ï¼Œå°±ä¸èƒ½å†å‘å®ƒæ·»åŠ æ–°çš„å±æ€§ï¼Œä¹Ÿä¸èƒ½åˆ é™¤æˆ–ä¿®æ”¹å·²æœ‰çš„å±æ€§ï¼Œç”šè‡³ç°æœ‰çš„å±æ€§ä¹Ÿä¸èƒ½è¢«é‡æ–°é…ç½®ï¼ˆæ¯”å¦‚æ”¹å˜å®ƒä»¬çš„å¯æšä¸¾æ€§ã€å¯é…ç½®æ€§ç­‰ï¼‰ã€‚è¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼äº JavaScript ä¸­ <code>Object.freeze()</code> æ–¹æ³•çš„åŠŸèƒ½ã€‚</p><p>è¿™é‡Œæ˜¯ <code>napi_object_freeze</code> å‡½æ•°çš„ä¸€èˆ¬ç”¨æ³•ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_object_freeze(napi_env env,</span></span>
<span class="line"><span>                               napi_value object);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>å‚æ•°è§£é‡Šï¼š</p><ul><li><code>env</code>: è¿™æ˜¯è¡¨ç¤ºå½“å‰ç¯å¢ƒçš„å¥æŸ„ï¼Œå®ƒæ˜¯æ‰€æœ‰ N-API è°ƒç”¨çš„ä¸Šä¸‹æ–‡ã€‚</li><li><code>object</code>: è¿™æ˜¯ä½ æƒ³è¦å†»ç»“çš„ JavaScript å¯¹è±¡ã€‚</li></ul><p>è¿”å›å€¼æ˜¯ <code>napi_status</code> ç±»å‹ï¼Œå®ƒä¼šå‘Šè¯‰ä½ æ“ä½œæ˜¯å¦æˆåŠŸå®Œæˆã€‚</p><p>ç°åœ¨è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥ç†è§£å¦‚ä½•ä½¿ç”¨ <code>napi_object_freeze</code>:</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åŸç”Ÿæ‰©å±•ï¼Œä½ å¸Œæœ›æä¾›ä¸€ä¸ªå¯¹è±¡ç»™ JavaScript ä¾§ï¼Œä½†ä½ ä¸æƒ³è®©ç”¨æˆ·èƒ½å¤Ÿæ›´æ”¹è¿™ä¸ªå¯¹è±¡ã€‚</p><p>é¦–å…ˆï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ <code>napi_object_freeze</code> å‡½æ•°è¿›è¡Œå†»ç»“ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ C è¯­è¨€ç¼–å†™çš„ç¤ºä¾‹ä»£ç ç‰‡æ®µï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ...å…¶ä»–å¿…è¦çš„ä»£ç ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CreateFrozenObject(napi_env env) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value my_object;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºå¯¹è±¡</span></span>
<span class="line"><span>    status = napi_create_object(env, &amp;my_object);</span></span>
<span class="line"><span>    if (status != napi_ok) return nullptr;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åœ¨è¿™é‡Œä½ å¯èƒ½ä¼šç»™å¯¹è±¡æ·»åŠ ä¸€äº›åˆå§‹å±æ€§</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å†»ç»“å¯¹è±¡ä»¥é˜²æ­¢æ›´æ”¹</span></span>
<span class="line"><span>    status = napi_object_freeze(env, my_object);</span></span>
<span class="line"><span>    if (status != napi_ok) return nullptr;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›å†»ç»“åçš„å¯¹è±¡</span></span>
<span class="line"><span>    return my_object;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ...æ›´å¤šä»£ç ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä½ çš„åŸç”Ÿæ¨¡å—ä¸­è°ƒç”¨ <code>CreateFrozenObject</code> å‡½æ•°å°±ä¼šè¿”å›ä¸€ä¸ªè¢«å†»ç»“çš„å¯¹è±¡ï¼ŒJavaScript ä»£ç å°è¯•å»ä¿®æ”¹è¿™ä¸ªå¯¹è±¡å°†ä¼šå¤±è´¥ï¼Œå¹¶å¯èƒ½æŠ›å‡ºå¼‚å¸¸ã€‚</p><p>è®°ä½ï¼Œå½“ä½ åœ¨å®é™…å¼€å‘ä¸­ä½¿ç”¨ <code>napi_object_freeze</code> æ—¶ï¼Œæ€»æ˜¯è¦æ£€æŸ¥è¿”å›çŠ¶æ€ç¡®ä¿æ“ä½œæˆåŠŸã€‚å¦‚æœ <code>napi_object_freeze</code> è°ƒç”¨å¤±è´¥äº†ï¼Œä½ åº”è¯¥å¦¥å–„å¤„ç†é”™è¯¯æƒ…å†µã€‚</p><h4 id="napi-object-seal" tabindex="-1"><a class="header-anchor" href="#napi-object-seal"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_object_seal" target="_blank" rel="noopener noreferrer">napi_object_seal</a></span></a></h4><p><code>napi_object_seal</code> æ˜¯ Node.js ä¸­çš„ N-APIï¼ˆåŸç”Ÿ APIï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªä¸ JavaScript V8 å¼•æ“çš„ç›´æ¥äº¤äº’å±‚ã€‚è¿™ä¸ªå‡½æ•°ç”¨äºä½¿ä¸€ä¸ª JavaScript å¯¹è±¡å˜ä¸ºâ€œå¯†å°â€çš„ï¼ˆsealedï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å¯¹è±¡è¢«å¯†å°ä¹‹åï¼Œä½ å°†ä¸èƒ½å†å‘è¿™ä¸ªå¯¹è±¡æ·»åŠ æ–°çš„å±æ€§ï¼Œå·²æœ‰çš„å±æ€§ä¹Ÿä¸èƒ½è¢«åˆ é™¤ï¼Œä½†æ˜¯ä½ ä»ç„¶å¯ä»¥ä¿®æ”¹å·²æœ‰å±æ€§çš„å€¼ï¼ˆåªè¦è¿™äº›å±æ€§ä¸æ˜¯å¯å†™çš„ï¼‰ã€‚</p><p>åœ¨ç°å®ä¸­ï¼Œå¯†å°ä¸€ä¸ªå¯¹è±¡å¯èƒ½åœ¨ä½ æƒ³å›ºåŒ–æŸä¸ªå¯¹è±¡çš„ç»“æ„æ—¶éå¸¸æœ‰ç”¨ï¼Œç¡®ä¿æ²¡æœ‰å…¶ä»–ä»£ç å¯ä»¥ç»™å¯¹è±¡æ·»åŠ æˆ–ç§»é™¤å±æ€§ï¼Œè¿™æ ·å¯ä»¥æä¾›æ›´ç¨³å®šçš„æ¥å£ã€‚</p><p>ç°åœ¨è®©æˆ‘ä»¬ä»¥ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è¯´æ˜<code>napi_object_seal</code>å¦‚ä½•å·¥ä½œï¼š</p><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js çš„åŸç”Ÿæ’ä»¶ï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ª JavaScript å¯¹è±¡å¹¶ä¸”ä¸å…è®¸ç”¨æˆ·å¯¹è¿™ä¸ªå¯¹è±¡è¿›è¡Œä¿®æ”¹ã€‚</p><p>é¦–å…ˆï¼Œä½ éœ€è¦åŒ…å« N-API çš„å¤´æ–‡ä»¶ï¼Œå¹¶å®šä¹‰ä½ çš„åŸç”Ÿå‡½æ•°ï¼Œæ¯”å¦‚<code>SealObject</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™æ˜¯ä½ çš„N-APIåˆå§‹åŒ–æ–¹æ³•å†…éƒ¨çš„ä¸€ä¸ªå‡½æ•°å®ç°</span></span>
<span class="line"><span>napi_value SealObject(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  napi_status status;</span></span>
<span class="line"><span>  napi_value object;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºå¯¹è±¡</span></span>
<span class="line"><span>  status = napi_create_object(env, &amp;object);</span></span>
<span class="line"><span>  if (status != napi_ok) return nullptr;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ç»™å¯¹è±¡è®¾ç½®ä¸€äº›å±æ€§</span></span>
<span class="line"><span>  napi_value value;</span></span>
<span class="line"><span>  status = napi_create_string_utf8(env, &quot;value&quot;, NAPI_AUTO_LENGTH, &amp;value);</span></span>
<span class="line"><span>  if (status != napi_ok) return nullptr;</span></span>
<span class="line"><span>  status = napi_set_named_property(env, object, &quot;key&quot;, value);</span></span>
<span class="line"><span>  if (status != napi_ok) return nullptr;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å¯†å°è¿™ä¸ªå¯¹è±¡</span></span>
<span class="line"><span>  status = napi_object_seal(env, object);</span></span>
<span class="line"><span>  if (status != napi_ok) return nullptr;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›è¿™ä¸ªå¯†å°çš„å¯¹è±¡</span></span>
<span class="line"><span>  return object;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ JavaScript å¯¹è±¡ï¼Œç„¶åç»™å®ƒè®¾ç½®äº†åä¸º&quot;key&quot;çš„å±æ€§ï¼Œå…¶å¯¹åº”çš„å€¼ä¸º&quot;value&quot;ã€‚ç„¶åé€šè¿‡<code>napi_object_seal</code>å‡½æ•°ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªå¯¹è±¡å¯†å°èµ·æ¥ï¼Œè¿™æ ·åœ¨è¿”å›ç»™ JavaScript åï¼Œå°±æ— æ³•å†ç»™è¿™ä¸ªå¯¹è±¡æ·»åŠ æ–°çš„å±æ€§äº†ã€‚</p><p>åœ¨ä½ çš„ JavaScript ä»£ç ä¸­ï¼Œå½“ä½ è°ƒç”¨è¿™ä¸ªåŸç”Ÿæ¨¡å—ä¸­çš„<code>SealObject</code>æ–¹æ³•æ—¶ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªå¯†å°çš„å¯¹è±¡ã€‚å¦‚æœä½ å°è¯•ç»™è¿™ä¸ªå¯¹è±¡æ·»åŠ æ–°çš„å±æ€§ï¼ŒJavaScript è¿è¡Œæ—¶å°†ä¼šæŠ›å‡ºé”™è¯¯ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> myNativeModule</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my-native-module</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> sealedObject</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> myNativeModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">SealObject</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">sealedObject</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">key</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: value</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°è¯•æ·»åŠ æ–°çš„å±æ€§ï¼Œå°†å¤±è´¥</span></span>
<span class="line"><span style="color:#D8DEE9;">sealedObject</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">newKey</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">new value</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // æŠ›å‡ºé”™è¯¯</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä¿®æ”¹ç°æœ‰çš„å±æ€§å€¼æ˜¯å¯ä»¥çš„</span></span>
<span class="line"><span style="color:#D8DEE9;">sealedObject</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">key</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">new value</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¿™æ˜¯æœ‰æ•ˆçš„ï¼Œå‰ææ˜¯è¯¥å±æ€§æ˜¯å¯å†™çš„</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å°è¯•åˆ é™¤å±æ€§ï¼Œå°†å¤±è´¥</span></span>
<span class="line"><span style="color:#81A1C1;">delete</span><span style="color:#D8DEE9;"> sealedObject</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">key</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // æŠ›å‡ºé”™è¯¯</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·æ³¨æ„ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸç”Ÿæ’ä»¶çš„ç¤ºä¾‹ï¼Œé€šå¸¸ï¼Œä½ éœ€è¦ç¼–è¯‘ C/C++ä»£ç æˆä¸º.node æ–‡ä»¶ï¼Œç„¶åæ‰èƒ½åœ¨ Node.js ç¯å¢ƒä¸­ä½¿ç”¨å®ƒã€‚è€Œä½¿ç”¨<code>napi_object_seal</code>å±äºè¾ƒé«˜çº§çš„æ“ä½œï¼Œå¯¹äºç¼–ç¨‹æ–°æ‰‹è€Œè¨€ï¼Œç†è§£ JavaScript å±‚é¢çš„å¯¹è±¡æ“ä½œå¯èƒ½ä¼šæ›´åŠ ç›´æ¥å’Œå®¹æ˜“ã€‚</p><h2 id="working-with-javascript-functions" tabindex="-1"><a class="header-anchor" href="#working-with-javascript-functions"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#working-with-javascript-functions" target="_blank" rel="noopener noreferrer">Working with JavaScript functions</a></span></a></h2><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ª C è¯­è¨€çš„ APIï¼Œå®ƒå…è®¸ä½ ç¼–å†™èƒ½å¤Ÿä¸ JavaScript ä»£ç äº¤äº’çš„æœ¬åœ°æ’ä»¶ã€‚åœ¨ N-API ä¸­â€œWorking with JavaScript functionsâ€é€šå¸¸æ„å‘³ç€ä½ å°†ä¼šä½¿ç”¨ C æˆ– C++ä»£ç æ¥è°ƒç”¨ JavaScript ä¸­çš„å‡½æ•°ï¼Œæˆ–è€…åˆ›å»ºæ–°çš„ JavaScript å‡½æ•°è®© JavaScript ä»£ç å»è°ƒç”¨ã€‚</p><p>è¿™é‡Œæ˜¯ä¸€äº›åŸºæœ¬çš„æ“ä½œï¼Œä½ å¯èƒ½ä¼šæ‰§è¡Œå½“ä½ ä½¿ç”¨ N-API å·¥ä½œæ—¶ï¼š</p><h3 id="è°ƒç”¨-javascript-å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#è°ƒç”¨-javascript-å‡½æ•°"><span>è°ƒç”¨ JavaScript å‡½æ•°ï¼š</span></a></h3><p>å½“ä½ æƒ³ä» C/C++ä»£ç è°ƒç”¨ä¸€ä¸ªç°æœ‰çš„ JavaScript å‡½æ•°æ—¶ï¼Œä½ éœ€è¦å…ˆè·å–åˆ°è¿™ä¸ªå‡½æ•°çš„å¼•ç”¨ï¼Œç„¶åä½¿ç”¨é€‚å½“çš„ N-API å‡½æ•°è°ƒç”¨å®ƒã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ª JavaScript å‡½æ•°<code>hello</code>ï¼Œä½ æƒ³ä»ä½ çš„ C/C++æ’ä»¶å†…éƒ¨è°ƒç”¨å®ƒï¼Œä½ çš„ä»£ç å¯èƒ½ä¼šåƒè¿™æ ·ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å‡è®¾ `napi_value js_hello_function` æ˜¯ä¹‹å‰è·å–çš„JavaScriptå‡½æ•°å¼•ç”¨</span></span>
<span class="line"><span>napi_value result;</span></span>
<span class="line"><span>napi_call_function(env, global, js_hello_function, 0, NULL, &amp;result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ<code>env</code>æ˜¯ä¸€ä¸ªè¡¨ç¤ºå½“å‰ N-API ç¯å¢ƒçš„å˜é‡ï¼Œè€Œ<code>global</code>æ˜¯å…¨å±€å¯¹è±¡çš„å¼•ç”¨ã€‚è¿™è¡Œä»£ç å®é™…ä¸Šå°±æ˜¯è°ƒç”¨äº†<code>hello</code>å‡½æ•°ï¼Œå¹¶ä¸”æ²¡æœ‰ä¼ é€’ä»»ä½•å‚æ•°ï¼ˆå› ä¸º args æ•°é‡æ˜¯ 0ï¼Œargs æ•°ç»„æ˜¯ NULLï¼‰ã€‚</p><h3 id="åˆ›å»ºæ–°çš„-javascript-å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºæ–°çš„-javascript-å‡½æ•°"><span>åˆ›å»ºæ–°çš„ JavaScript å‡½æ•°ï¼š</span></a></h3><p>å¦‚æœä½ æƒ³åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°å¹¶å°†å…¶æš´éœ²ç»™ JavaScript ä»£ç ä½¿ç”¨ï¼Œä½ å¯ä»¥é€šè¿‡å®šä¹‰ä¸€ä¸ª C/C++å‡½æ•°ï¼Œç„¶åå‘Šè¯‰ N-API å®ƒåº”è¯¥è¢«è§†ä¸º JavaScript å‡½æ•°ã€‚</p><p>è¿™æ˜¯å¦‚ä½•å®Œæˆçš„ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// è¿™æ˜¯Cå‡½æ•°ï¼Œæˆ‘ä»¬æƒ³åœ¨JavaScriptä¸­ä»¥å‡½æ•°å½¢å¼è°ƒç”¨</span></span>
<span class="line"><span>napi_value MyNativeFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // åœ¨è¿™é‡Œå¤„ç†å‡½æ•°è°ƒç”¨</span></span>
<span class="line"><span>    return some_result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œå‡½æ•°ä½¿å…¶åœ¨JavaScriptä¸­å¯ç”¨</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_value my_function;</span></span>
<span class="line"><span>    napi_create_function(env, &quot;myFunction&quot;, NAPI_AUTO_LENGTH, MyNativeFunction, NULL, &amp;my_function);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†ç”Ÿæˆçš„å‡½æ•°æ·»åŠ åˆ°exportså¯¹è±¡ä¸­ï¼Œä½¿å…¶å¯ä»¥è¢«JavaScriptæ¨¡å—å¯¼å‡ºå’Œè®¿é—®</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;myFunction&quot;, my_function);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­ï¼Œ<code>MyNativeFunction</code>æ˜¯ C å‡½æ•°ã€‚é€šè¿‡è°ƒç”¨<code>napi_create_function</code>ï¼Œæˆ‘ä»¬è¯´â€œå˜¿ Node.jsï¼Œè¯·å°†æ­¤ C å‡½æ•°è§†ä¸º JavaScript å‡½æ•°â€ï¼Œå¹¶ä¸” Node.js åšäº†ç›¸åº”çš„å†…éƒ¨è¿æ¥ã€‚</p><p>ç°åœ¨ï¼Œæ¥è‡ª JavaScript ä¸–ç•Œçš„äººå¯ä»¥è¿™æ ·è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> myAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">myAddon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">myAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">myFunction</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è°ƒç”¨æˆ‘ä»¬åˆšåˆšå®šä¹‰çš„å‡½æ•°</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä¼ é€’å‚æ•°ç»™-javascript-å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#ä¼ é€’å‚æ•°ç»™-javascript-å‡½æ•°"><span>ä¼ é€’å‚æ•°ç»™ JavaScript å‡½æ•°ï¼š</span></a></h3><p>å¦‚æœä½ éœ€è¦å‘ JavaScript å‡½æ•°ä¼ é€’å‚æ•°ï¼Œä½ å¯ä»¥æ„å»ºä¸€ä¸ªåŒ…å«<code>napi_value</code>ç±»å‹å‚æ•°çš„æ•°ç»„ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™<code>napi_call_function</code>ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ æƒ³ä¼ é€’ä¸€ä¸ªå­—ç¬¦ä¸²å’Œä¸€ä¸ªæ•°å­—ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value arg1, arg2;</span></span>
<span class="line"><span>napi_create_string_utf8(env, &quot;Hello&quot;, NAPI_AUTO_LENGTH, &amp;arg1);</span></span>
<span class="line"><span>napi_create_double(env, 123, &amp;arg2);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value args[] = {arg1, arg2};</span></span>
<span class="line"><span>napi_value result;</span></span>
<span class="line"><span>napi_call_function(env, global, js_hello_function, 2, args, &amp;result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šåªæ˜¯ N-API ä¸­ä¸ JavaScript å‡½æ•°æ“ä½œç›¸å…³çš„åŸºç¡€æ¦‚å¿µå’Œä¾‹å­ã€‚è¿™äº›æ“ä½œèƒ½å¤Ÿè®©ä½ çš„æœ¬åœ°æ’ä»¶ä¸ JavaScript ä»£ç æ— ç¼ååŒå·¥ä½œã€‚è®°å¾—æ¯æ¬¡æ“ä½œéƒ½éœ€è¦æ£€æŸ¥è¿”å›å€¼ï¼Œç¡®ä¿æ²¡æœ‰å‘ç”Ÿé”™è¯¯ã€‚</p><h3 id="napi-call-function" tabindex="-1"><a class="header-anchor" href="#napi-call-function"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_call_function" target="_blank" rel="noopener noreferrer">napi_call_function</a></span></a></h3><p><code>napi_call_function</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ª N-API å‡½æ•°ï¼Œå®ƒå…è®¸ä½ åœ¨ JavaScript ç¯å¢ƒä¸­è°ƒç”¨å·²å­˜åœ¨çš„ JavaScript å‡½æ•°ã€‚Node.js çš„ N-API æ˜¯ä¸€ä¸ª C APIï¼Œå®ƒæä¾›äº†ä»åŸç”Ÿä»£ç ï¼ˆå¦‚ C æˆ– C++æ’ä»¶ï¼‰ä¸ JavaScript ä»£ç è¿›è¡Œäº¤äº’çš„èƒ½åŠ›ã€‚</p><p>ä¸ºäº†ç†è§£ <code>napi_call_function</code> çš„ä½œç”¨ï¼Œé¦–å…ˆéœ€è¦çŸ¥é“ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li><strong>N-API</strong> ï¼ˆNode APIï¼‰æ˜¯ç”¨æ¥æ„å»ºåŸç”Ÿæ’ä»¶çš„ APIï¼Œä½¿å¾—ä½ å¯ä»¥åœ¨ä¸ç›´æ¥ä½¿ç”¨ JavaScript ä½†æƒ³è¦ä¸ Node.js äº¤äº’çš„åœ°æ–¹ä½¿ç”¨å®ƒã€‚</li><li><strong>åŸç”Ÿæ’ä»¶</strong> æ˜¯ä½¿ç”¨ C/C++ç­‰ç¼–å†™çš„æ¨¡å—ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡ N-API ä¸ Node.js é€šä¿¡ã€‚</li><li><strong>JavaScript å‡½æ•°è°ƒç”¨</strong> æŒ‡çš„æ˜¯åœ¨ JavaScript ä»£ç ä¸­æ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”ç»™è¿™ä¸ªå‡½æ•°ä¼ é€’å‚æ•°ï¼Œå½“ç„¶å‡½æ•°æœ¬èº«å¯èƒ½ä¼šè¿”å›ä¸€äº›å€¼ã€‚</li></ol><p>ç°åœ¨ï¼Œå…·ä½“åˆ° <code>napi_call_function</code> å‡½æ•°ï¼Œå…¶ç›®çš„å°±æ˜¯è®©ä½ ä» C/C++ä»£ç ä¸­è°ƒç”¨ JavaScript å‡½æ•°ã€‚å®ƒçš„åŸºæœ¬æ­¥éª¤åŒ…æ‹¬ï¼š</p><ul><li>ç¡®ä¿ä½ æœ‰ä¸€ä¸ª <code>napi_env</code> ç¯å¢ƒå˜é‡ã€‚è¿™ä¸ªç¯å¢ƒå˜é‡ä»£è¡¨äº†ä¸€ä¸ªæ´»è·ƒçš„ Node.js ç¯å¢ƒï¼Œç”¨äº N-API è°ƒç”¨ã€‚</li><li>è·å¾—ä¸€ä¸ªæŒ‡å‘ JavaScript å‡½æ•°çš„ <code>napi_value</code> å¼•ç”¨ã€‚</li><li>å‡†å¤‡ä½ æƒ³è¦ä¼ é€’ç»™ JavaScript å‡½æ•°çš„å‚æ•°ï¼Œæ¯ä¸ªå‚æ•°éƒ½æ˜¯ä¸€ä¸ª <code>napi_value</code>ã€‚</li><li>ä½¿ç”¨ <code>napi_call_function</code> æ¥å®é™…è°ƒç”¨è¯¥å‡½æ•°ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨å¦ä¸€ä¸ª <code>napi_value</code> ä¸­ã€‚</li></ul><p>å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_call_function(napi_env env,</span></span>
<span class="line"><span>                               napi_value recv,</span></span>
<span class="line"><span>                               napi_value func,</span></span>
<span class="line"><span>                               size_t argc,</span></span>
<span class="line"><span>                               const napi_value* argv,</span></span>
<span class="line"><span>                               napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‚æ•°æè¿°ï¼š</p><ul><li><code>env</code>: å½“å‰çš„ N-API ç¯å¢ƒã€‚</li><li><code>recv</code>: è¿™æ˜¯è°ƒç”¨å‡½æ•°æ—¶çš„ <code>this</code> å€¼ï¼Œå¦‚æœå‡½æ•°ä¸æ˜¯å¯¹è±¡çš„æ–¹æ³•ï¼Œåˆ™å¯ä»¥ä¼ é€’ <code>undefined</code> æˆ–å…¨å±€å¯¹è±¡ã€‚</li><li><code>func</code>: ä¸€ä¸ªå¼•ç”¨äº†ä½ æƒ³è¦è°ƒç”¨çš„ JavaScript å‡½æ•°çš„ <code>napi_value</code>ã€‚</li><li><code>argc</code>: ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°æ•°é‡ã€‚</li><li><code>argv</code>: å‚æ•°åˆ—è¡¨çš„æ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª <code>napi_value</code>ã€‚</li><li><code>result</code>: ä¸€ä¸ªæŒ‡å‘ <code>napi_value</code> çš„æŒ‡é’ˆï¼Œç”¨æ¥æ¥æ”¶å‡½æ•°è°ƒç”¨çš„è¿”å›å€¼ã€‚</li></ul><p>ä¸¾ä¸ªç®€å•ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª JavaScript å‡½æ•° <code>add</code> å¦‚ä¸‹:</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> add</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">a</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> b</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  return</span><span style="color:#D8DEE9;"> a</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9;"> b</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ C/C++ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦è°ƒç”¨è¿™ä¸ªå‡½æ•°å¹¶ä¼ å…¥ä¸¤ä¸ªæ•°å­—ä½œä¸ºå‚æ•°ã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨ <code>napi_call_function</code> çš„å¤§è‡´ä»£ç ç¤ºä¾‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ...çœç•¥å…¶ä»–æ‰€éœ€çš„N-APIå¼•å¯¼ä»£ç ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value addFunc; // å‡è®¾è¿™æ˜¯æˆ‘ä»¬å·²ç»è·å–çš„JavaScriptå‡½æ•° &#39;add&#39; çš„N-APIå¼•ç”¨</span></span>
<span class="line"><span>napi_value result;</span></span>
<span class="line"><span>napi_value args[2];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾nå’Œmæ˜¯æˆ‘ä»¬æƒ³è¦ç›¸åŠ çš„ä¸¤ä¸ªæ•°å­—</span></span>
<span class="line"><span>double n = 1.0;</span></span>
<span class="line"><span>double m = 2.0;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ›å»ºä¸¤ä¸ªnapi_valueè¡¨ç¤ºæˆ‘ä»¬è¦ä¼ é€’ç»™addå‡½æ•°çš„å‚æ•°</span></span>
<span class="line"><span>napi_create_double(env, n, &amp;args[0]);</span></span>
<span class="line"><span>napi_create_double(env, m, &amp;args[1]);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è°ƒç”¨å‡½æ•°</span></span>
<span class="line"><span>napi_status status = napi_call_function(env, global, addFunc, 2, args, &amp;result);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å¤„ç†å¯èƒ½å‡ºç°çš„é”™è¯¯</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>    // é”™è¯¯å¤„ç†</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾å‡½æ•°æ‰§è¡ŒæˆåŠŸï¼Œç°åœ¨resultå˜é‡ä¸­å­˜å‚¨äº†è¿”å›å€¼</span></span>
<span class="line"><span>double sum;</span></span>
<span class="line"><span>napi_get_value_double(env, result, &amp;sum);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// sum ç°åœ¨åº”è¯¥ç­‰äº 3.0ï¼Œå› ä¸º 1.0 + 2.0 = 3.0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µ C/C++ä»£ç å±•ç¤ºäº†å¦‚ä½•è®¾ç½®å‚æ•°ï¼Œå¦‚ä½•è°ƒç”¨ JavaScript å‡½æ•°ï¼Œä»¥åŠå¦‚ä½•è·å–è¿”å›å€¼ã€‚è¿™åªæ˜¯ä¸€ä¸ªéå¸¸åŸºç¡€çš„ä¾‹å­ï¼Œå®é™…ä¸Šï¼Œåœ¨çœŸæ­£çš„åŸç”Ÿæ’ä»¶å¼€å‘ä¸­ï¼Œä½ å¯èƒ½è¿˜éœ€è¦å¤„ç†å¾ˆå¤šé¢å¤–çš„è¾¹ç•Œæ¡ä»¶ï¼Œæ¯”å¦‚å¼‚å¸¸å¤„ç†ç­‰ã€‚</p><h3 id="napi-create-function" tabindex="-1"><a class="header-anchor" href="#napi-create-function"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_function" target="_blank" rel="noopener noreferrer">napi_create_function</a></span></a></h3><p><code>napi_create_function</code>æ˜¯ Node.js ä¸­çš„ä¸€ä¸ª API å‡½æ•°ï¼Œç”¨äºåœ¨åŸç”Ÿæ¨¡å—ï¼ˆé€šå¸¸æ˜¯ç”¨ C æˆ– C++ç¼–å†™çš„æ‰©å±•ï¼‰ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript å‡½æ•°ã€‚è¿™ä¸ª API å±äº N-APIï¼Œå®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹äº JavaScript è¿è¡Œæ—¶çš„æ¥å£ï¼Œå…è®¸ä½ æ„å»ºå¯ä»¥è·¨ä¸åŒç‰ˆæœ¬çš„ Node.js è¿è¡Œçš„åŸç”Ÿæ’ä»¶ã€‚</p><p>N-API æ—¨åœ¨å‡å°‘ç»´æŠ¤æˆæœ¬ï¼Œå¹¶ä¸”é€šè¿‡æä¾›ä¸ Node.js æ ¸å¿ƒæ— å…³çš„ç¨³å®š API å±‚æ¥æé«˜æ¨¡å—çš„å…¼å®¹æ€§ã€‚</p><p>ä¸‹é¢æˆ‘å°†è§£é‡Šä¸€ä¸‹<code>napi_create_function</code>çš„ä½¿ç”¨æ–¹å¼ï¼Œå¹¶ç»™å‡ºä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ã€‚</p><h3 id="åŸºæœ¬ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä½¿ç”¨"><span>åŸºæœ¬ä½¿ç”¨</span></a></h3><p>å½“ä½ æƒ³è¦åœ¨åŸç”Ÿæ¨¡å—ä¸­å®šä¹‰ä¸€ä¸ªå¯ä»¥ä» JavaScript ä»£ç è°ƒç”¨çš„å‡½æ•°æ—¶ï¼Œä½ ä¼šä½¿ç”¨<code>napi_create_function</code>ã€‚</p><p>è¿™ä¸ªå‡½æ•°çš„åŸºæœ¬ç­¾åå¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_create_function(napi_env env,</span></span>
<span class="line"><span>                                 const char* utf8name,</span></span>
<span class="line"><span>                                 size_t length,</span></span>
<span class="line"><span>                                 napi_callback cb,</span></span>
<span class="line"><span>                                 void* data,</span></span>
<span class="line"><span>                                 napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‚æ•°è§£é‡Šï¼š</p><ul><li><code>env</code>: è¿™æ˜¯ä¸€ä¸ªè¡¨ç¤º N-API ç¯å¢ƒçš„å¥æŸ„ï¼Œå®ƒåœ¨å¾ˆå¤š N-API è°ƒç”¨ä¸­éƒ½è¢«ä½¿ç”¨ã€‚</li><li><code>utf8name</code>: è¿™æ˜¯ä½ æƒ³è¦åˆ›å»ºçš„ JavaScript å‡½æ•°çš„åç§°ï¼Œè¡¨ç¤ºä¸º UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ã€‚</li><li><code>length</code>: è¿™æ˜¯ä¸Šé¢åç§°å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå¦‚æœä½ ä¼ é€’<code>NAPI_AUTO_LENGTH</code>ï¼Œåˆ™å‡½æ•°ä¼šè‡ªåŠ¨è®¡ç®—é•¿åº¦ã€‚</li><li><code>cb</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘ä½ çš„åŸç”Ÿå‡½æ•°çš„æŒ‡é’ˆï¼Œå½“ JavaScript ä»£ç è°ƒç”¨ä½ çš„å‡½æ•°æ—¶ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°ä¼šè¢«æ‰§è¡Œã€‚</li><li><code>data</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘ä»»æ„æ•°æ®çš„æŒ‡é’ˆï¼Œä½ å¯ä»¥å°†å®ƒè®¾ä¸º NULL æˆ–è€…ä¼ é€’ä¸€äº›ä½ çš„å‡½æ•°å¯èƒ½éœ€è¦çš„æ•°æ®ã€‚</li><li><code>result</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘æ–°åˆ›å»ºçš„ JavaScript å‡½æ•°çš„æŒ‡é’ˆï¼Œå‡½æ•°è°ƒç”¨æˆåŠŸåï¼Œåœ¨æ­¤è¿”å›æ–°å‡½æ•°ã€‚</li></ul><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-9" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-9"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h3><p>å‡è®¾æˆ‘ä»¬æƒ³åœ¨åŸç”Ÿæ¨¡å—ä¸­åˆ›å»ºä¸€ä¸ªåä¸º&quot;hello&quot;çš„å‡½æ•°ï¼Œå½“ä» JavaScript è°ƒç”¨æ—¶ï¼Œå®ƒè¿”å›å­—ç¬¦ä¸²&quot;Hello from native module!&quot;ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰åŸç”Ÿå‡½æ•°çš„å®ç°ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value HelloFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value greeting;</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²å€¼ï¼Œç”¨äºè¿”å›</span></span>
<span class="line"><span>    status = napi_create_string_utf8(env, &quot;Hello from native module!&quot;, NAPI_AUTO_LENGTH, &amp;greeting);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return greeting;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åï¼Œåœ¨æ¨¡å—åˆå§‹åŒ–æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>napi_create_function</code>æ¥åˆ›å»º&quot;hello&quot;å‡½æ•°å¹¶å°†å…¶æš´éœ²ç»™ JavaScriptï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºå‡½æ•°</span></span>
<span class="line"><span>    status = napi_create_function(env, &quot;hello&quot;, NAPI_AUTO_LENGTH, HelloFunction, NULL, &amp;fn);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†åˆ›å»ºçš„å‡½æ•°ä½œä¸ºæ¨¡å—exportsçš„å±æ€§</span></span>
<span class="line"><span>    status = napi_set_named_property(env, exports, &quot;hello&quot;, fn);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·ï¼Œå½“æˆ‘ä»¬çš„åŸç”Ÿæ¨¡å—è¢«åŠ è½½åˆ° Node.js ä¸­æ—¶ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªåä¸º&quot;hello&quot;çš„å‡½æ•°å¯ä¾› JavaScript ä»£ç è°ƒç”¨ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeModule</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/native-module.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">hello</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: Hello from native module!</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨<code>napi_create_function</code>åœ¨åŸç”Ÿæ¨¡å—ä¸­åˆ›å»ºä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œä»¥åŠå¦‚ä½•å°†è¯¥å‡½æ•°å…¬å¼€ç»™ Node.js ç¯å¢ƒã€‚</p><h3 id="napi-get-cb-info" tabindex="-1"><a class="header-anchor" href="#napi-get-cb-info"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_cb_info" target="_blank" rel="noopener noreferrer">napi_get_cb_info</a></span></a></h3><p><code>napi_get_cb_info</code> æ˜¯ Node.js ä¸­ N-APIï¼ˆåŸç”Ÿ APIï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œæ—¨åœ¨ä¸ºæ„å»ºåŸç”Ÿæ’ä»¶æä¾›ä¸€ä¸ªç¨³å®šçš„ ABIï¼ˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£ï¼‰ã€‚è¿™æ„å‘³ç€ä½¿ç”¨ N-API ç¼–å†™çš„æ’ä»¶ä¸ä¼šå› ä¸º Node.js ç‰ˆæœ¬çš„å‡çº§è€Œéœ€è¦é‡æ–°ç¼–è¯‘ï¼Œä»è€Œä½¿å¾—æ’ä»¶æ›´åŠ ç¨³å®šã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œ<code>napi_get_cb_info</code> å‡½æ•°ç”¨äºä»åŸç”Ÿæ‰©å±•ä¸­çš„å‡½æ•°è°ƒç”¨è·å–ä¿¡æ¯ã€‚å½“ JavaScript è°ƒç”¨ä¸€ä¸ª C/C++ æ‰©å±•æ¨¡å—ä¸­çš„å‡½æ•°æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>napi_get_cb_info</code> æ¥è·å–ä¼ é€’ç»™è¯¥å‡½æ•°çš„å‚æ•°ã€‚</p><p>è¿™ä¸ªå‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_get_cb_info(</span></span>
<span class="line"><span>    napi_env env,                // [in] ç¯å¢ƒå¥æŸ„</span></span>
<span class="line"><span>    napi_callback_info cb_info,  // [in] å›è°ƒä¿¡æ¯</span></span>
<span class="line"><span>    size_t* argc,                // [in,out] å‚æ•°æ•°é‡</span></span>
<span class="line"><span>    napi_value* argv,            // [out] å‚æ•°æ•°ç»„</span></span>
<span class="line"><span>    napi_value* this_arg,        // [out] this æŒ‡å‘çš„å¯¹è±¡</span></span>
<span class="line"><span>    void** data                  // [out] å…³è”çš„æ•°æ®æŒ‡é’ˆ</span></span>
<span class="line"><span>);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™é‡Œï¼š</p><ul><li><code>env</code> æ˜¯è¡¨ç¤ºå½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡ç¯å¢ƒçš„å¥æŸ„ã€‚</li><li><code>cb_info</code> æ˜¯ä¸€ä¸ªå›è°ƒä¿¡æ¯ç±»å‹çš„å€¼ï¼ŒåŒ…å«äº†å…³äºå½“å‰å‡½æ•°è°ƒç”¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li><li><code>argc</code> åˆå§‹æ—¶åº”è¯¥è®¾ç½®ä¸ºä½ å‡†å¤‡æ¥æ”¶çš„å‚æ•°çš„æœ€å¤§æ•°é‡ã€‚å‡½æ•°æ‰§è¡Œå®Œåï¼Œå®ƒå°†è¢«è®¾ç½®ä¸ºå®é™…ä¼ é€’çš„å‚æ•°æ•°é‡ã€‚</li><li><code>argv</code> æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºæ¥æ”¶å‡½æ•°çš„å‚æ•°å€¼ã€‚æ•°ç»„çš„å¤§å°åº”è‡³å°‘ä¸ <code>argc</code> çš„åˆå§‹å€¼ä¸€æ ·å¤§ã€‚</li><li><code>this_arg</code> å°†è¢«è®¾ç½®ä¸ºè°ƒç”¨å‡½æ•°æ—¶çš„ <code>this</code> å€¼ã€‚</li><li><code>data</code> æ˜¯æŒ‡å‘ä¸å½“å‰å›è°ƒç›¸å…³è”çš„ä»»ä½•æ•°æ®çš„æŒ‡é’ˆã€‚</li></ul><p>ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js çš„åŸç”Ÿæ‰©å±•ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå‡½æ•° <code>MyFunction</code> éœ€è¦ä» JavaScript ä»£ç ä¸­è·å–ä¸¤ä¸ªå‚æ•°ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// JavaScript è°ƒç”¨</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> addon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> result</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> addon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">MyFunction</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">5</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 10</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ C++ ä¸­ï¼Œä½ å¯èƒ½ä¼šè¿™æ ·å®ç° <code>MyFunction</code>ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 2;                       // æˆ‘ä»¬æœŸæœ›æ¥æ”¶ä¸¤ä¸ªå‚æ•°</span></span>
<span class="line"><span>    napi_value argv[2];                    // åˆ›å»ºä¸€ä¸ªæ•°ç»„æ¥å­˜å‚¨è¿™äº›å‚æ•°</span></span>
<span class="line"><span>    napi_value this_arg;</span></span>
<span class="line"><span>    void* data;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–å‡½æ•°è°ƒç”¨çš„è¯¦ç»†ä¿¡æ¯</span></span>
<span class="line"><span>    napi_status status = napi_get_cb_info(env, info, &amp;argc, argv, &amp;this_arg, &amp;data);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–å‚æ•°</span></span>
<span class="line"><span>    if (status != napi_ok || argc `&lt;` 2) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯æƒ…å†µ...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ä½¿ç”¨å‚æ•°è¿›è¡Œè®¡ç®—æˆ–å…¶ä»–æ“ä½œ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›ç»“æœç»™ JavaScript</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    // ... çœç•¥åˆ›å»ºå’Œè¿”å›ç»“æœçš„ä»£ç  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œå‡½æ•°ä»¥ä¾¿åœ¨ JS ä¸­å¯ä»¥è°ƒç”¨</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, MyFunction, NULL, &amp;fn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;MyFunction&quot;, fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>MyFunction</code> é€šè¿‡ <code>napi_get_cb_info</code> è·å–äº† JavaScript ä¼ é€’ç»™å®ƒçš„ä¸¤ä¸ªå‚æ•°ã€‚ç„¶åï¼Œä½ å¯ä»¥å¤„ç†è¿™äº›å‚æ•°å¹¶è¿”å›æŸä¸ªç»“æœã€‚è¿™ä¸ªæœºåˆ¶å…è®¸å°† C/C++ åŠŸèƒ½æš´éœ²ç»™ JavaScript ä»£ç ï¼Œæ˜¯æ„å»ºé«˜æ€§èƒ½ Node.js æ’ä»¶çš„åŸºç¡€ã€‚</p><h3 id="napi-get-new-target" tabindex="-1"><a class="header-anchor" href="#napi-get-new-target"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_new_target" target="_blank" rel="noopener noreferrer">napi_get_new_target</a></span></a></h3><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨ C è¯­è¨€ç¼–å†™çš„åº•å±‚ APIï¼Œå®ƒå…è®¸ä½ åˆ›å»ºåŸç”Ÿæ’ä»¶ã€‚è¿™äº›åŸç”Ÿæ’ä»¶å¯ä»¥ç›´æ¥ä¸ Node.js çš„ V8 å¼•æ“äº¤äº’ï¼Œæä¾›æ¯” JavaScript æ›´å¿«çš„æ€§èƒ½æˆ–è®¿é—®ç³»ç»Ÿèµ„æºå’Œç¬¬ä¸‰æ–¹åº“ã€‚</p><p><code>napi_get_new_target</code> å‡½æ•°æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒç”¨æ¥ç¡®å®šä¸€ä¸ªå‡½æ•°æ˜¯å¦è¢«å½“ä½œæ„é€ å‡½æ•°ï¼ˆä½¿ç”¨ <code>new</code> å…³é”®å­—ï¼‰è°ƒç”¨ã€‚</p><p>åœ¨ JavaScript ä¸­ï¼Œä½ å¯ä»¥æœ‰ä¸¤ç§æ–¹å¼è°ƒç”¨å‡½æ•°ï¼š</p><ol><li>æ™®é€šè°ƒç”¨ï¼š<code>myFunction()</code></li><li>æ„é€ å‡½æ•°è°ƒç”¨ï¼š<code>new MyConstructor()</code></li></ol><p>å½“ä½ ä½¿ç”¨ <code>new</code> è°ƒç”¨å‡½æ•°æ—¶ï¼ŒJavaScript å¼•æ“ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¹¶å°†è¯¥å¯¹è±¡ä½œä¸ºå‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ <code>this</code> ä¸Šä¸‹æ–‡ã€‚å¦‚æœæ²¡æœ‰ä½¿ç”¨ <code>new</code>ï¼Œé€šå¸¸ <code>this</code> ä¼šå¼•ç”¨åˆ°å…¨å±€å¯¹è±¡æˆ–è€…æ˜¯ undefinedï¼ˆåœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼‰ã€‚</p><p><code>napi_get_new_target</code> å…è®¸åŸç”Ÿæ’ä»¶æ£€æŸ¥ä¸€ä¸ªå‡½æ•°æ˜¯å¦é€šè¿‡ <code>new</code> å…³é”®å­—è¢«è°ƒç”¨ã€‚å¦‚æœæ˜¯é€šè¿‡ <code>new</code> è¢«è°ƒç”¨ï¼Œé‚£ä¹ˆå®ƒä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘æ–°åˆ›å»ºå¯¹è±¡çš„å¼•ç”¨ï¼›å¦‚æœä¸æ˜¯ï¼Œå®ƒå°†è¿”å› <code>NULL</code>ã€‚</p><p>è¯·çœ‹ä¸€ä¸ªç¤ºä¾‹ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹çš„ C++ ä»£ç ä½œä¸º Node.js æ’ä»¶ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value new_target;</span></span>
<span class="line"><span>    napi_status status = napi_get_new_target(env, info, &amp;new_target);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦é€šè¿‡ &quot;new&quot; è¢«è°ƒç”¨</span></span>
<span class="line"><span>    bool is_constructor_call = (status == napi_ok &amp;&amp; new_target != nullptr);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (is_constructor_call) {</span></span>
<span class="line"><span>        // è¿™æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°è°ƒç”¨</span></span>
<span class="line"><span>        // å¯ä»¥ç»§ç»­æ“ä½œ new_target</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // è¿™æ˜¯ä¸€ä¸ªæ™®é€šå‡½æ•°è°ƒç”¨</span></span>
<span class="line"><span>        // ç›¸åº”åœ°å¤„ç†è¿™ç§æƒ…å†µ...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›ä¸€ä¸ªå€¼...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªå‡½æ•°</span></span>
<span class="line"><span>    napi_create_function(env, nullptr, 0, MyFunction, nullptr, &amp;fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†å‡½æ•°æš´éœ²ç»™æ¨¡å—å¯¼å‡º</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;myFunction&quot;, fn);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªæ’ä»¶ä¸­ï¼š</p><ul><li>æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>MyFunction</code> çš„å‡½æ•°ï¼Œå®ƒå¯ä»¥ç”¨ä½œæ„é€ å‡½æ•°ã€‚</li><li>åœ¨å‡½æ•°å†…éƒ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>napi_get_new_target</code> æ£€æŸ¥å®ƒæ˜¯å¦è¢«å½“ä½œæ„é€ å‡½æ•°è°ƒç”¨ã€‚</li><li>æ ¹æ®æ˜¯å¦é€šè¿‡ <code>new</code> è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥å†³å®šå¦‚ä½•å¤„ç†è¿™æ¬¡å‡½æ•°è°ƒç”¨ã€‚</li></ul><p>ä½ éœ€è¦åœ¨ JavaScript ä¸­åŠ è½½å’Œä½¿ç”¨è¿™ä¸ªæ’ä»¶ï¼Œå°±åƒè¿™æ ·ï¼š</p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> myModule</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">myModule</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä½¿ç”¨ new è°ƒç”¨</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> obj</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#D8DEE9;"> myModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">myFunction</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// ä¸ä½¿ç”¨ new è°ƒç”¨</span></span>
<span class="line"><span style="color:#D8DEE9;">myModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">myFunction</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨å‰è€…çš„æƒ…å†µä¸­ï¼Œ<code>MyFunction</code> å†…éƒ¨çš„ <code>is_constructor_call</code> ä¼šæ˜¯ <code>true</code>ï¼Œè€Œåœ¨åè€…çš„æƒ…å†µä¸­ï¼Œåˆ™æ˜¯ <code>false</code>ã€‚</p><p>æ€»ç»“èµ·æ¥ï¼Œ<code>napi_get_new_target</code> æ˜¯ä¸€ä¸ªç”¨äºåŒºåˆ†å‡½æ•°è°ƒç”¨æ–¹å¼çš„å·¥å…·ï¼Œè¿™åœ¨åˆ›å»ºå¯ä»¥åŒæ—¶ä½œä¸ºæ™®é€šå‡½æ•°å’Œæ„é€ å‡½æ•°çš„åŸç”Ÿæ’ä»¶æ—¶éå¸¸æœ‰ç”¨ã€‚</p><h3 id="napi-new-instance" tabindex="-1"><a class="header-anchor" href="#napi-new-instance"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_new_instance" target="_blank" rel="noopener noreferrer">napi_new_instance</a></span></a></h3><p><code>napi_new_instance</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ª N-API å‡½æ•°ï¼Œå®ƒç”¨äºåˆ›å»º JavaScript ä¸­çš„æ–°å¯¹è±¡å®ä¾‹ã€‚N-API æ˜¯ Node.js æä¾›çš„ä¸€ä¸ª C API å±‚ï¼Œä½¿å¾—åŸç”Ÿæ¨¡å—ï¼ˆä½¿ç”¨ C æˆ– C++ç¼–å†™ï¼‰èƒ½å¤Ÿä¸ JavaScript ä»£ç æ— ç¼äº¤äº’ï¼Œä¸å— Node.js ç‰ˆæœ¬å˜åŒ–çš„å½±å“ã€‚</p><p>åœ¨è§£é‡Šè¿™ä¸ªå‡½æ•°ä¹‹å‰ï¼Œè®©æˆ‘ä»¬ç®€å•äº†è§£å‡ ä¸ªç›¸å…³æ¦‚å¿µï¼š</p><ol><li><strong>åŸç”Ÿæ¨¡å—</strong>ï¼šæŒ‡çš„æ˜¯ç”¨ C æˆ– C++ç­‰ç¼–ç¨‹è¯­è¨€ç¼–å†™å¹¶å¯ä»¥ç›´æ¥è°ƒç”¨ Node.js æˆ– V8 å¼•æ“æä¾› API çš„æ¨¡å—ã€‚</li><li><strong>JavaScript å®ä¾‹</strong>ï¼šåœ¨ JavaScript ä¸­ï¼Œå½“ä½ é€šè¿‡<code>new</code>å…³é”®å­—è°ƒç”¨æ„é€ å‡½æ•°æ—¶ï¼Œä½ ä¼šåˆ›å»ºè¯¥æ„é€ å‡½æ•°çš„ä¸€ä¸ªå®ä¾‹ï¼ˆå³ä¸€ä¸ªå¯¹è±¡ï¼‰ã€‚</li><li><strong>N-API</strong>ï¼šNode.js æä¾›çš„ä¸€ç»„ç”¨ C ç¼–å†™çš„ APIï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥æ„å»ºåŸç”Ÿæ’ä»¶ï¼Œå¹¶ä¿è¯è·¨ Node.js ç‰ˆæœ¬çš„ç¨³å®šæ€§ã€‚</li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬è¯¦ç»†äº†è§£<code>napi_new_instance</code>å‡½æ•°ã€‚</p><h3 id="napi-new-instance-1" tabindex="-1"><a class="header-anchor" href="#napi-new-instance-1"><span>napi_new_instance</span></a></h3><p>è¿™ä¸ªå‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªç”±åŸç”Ÿæ¨¡å—å®šä¹‰çš„æ„é€ å‡½æ•°çš„æ–°å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ª C++ç±»å¹¶ä¸”æƒ³è¦ä» JavaScript ä»£ç ä¸­åˆ›å»ºå®ƒçš„å®ä¾‹ï¼Œå°±å¯ä»¥ä½¿ç”¨<code>napi_new_instance</code>æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</p><h4 id="å‡½æ•°ç­¾å-8" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°ç­¾å-8"><span>å‡½æ•°ç­¾å</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_new_instance(napi_env env,</span></span>
<span class="line"><span>                              napi_value constructor,</span></span>
<span class="line"><span>                              size_t argc,</span></span>
<span class="line"><span>                              const napi_value* argv,</span></span>
<span class="line"><span>                              napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>: å½“å‰çš„ N-API ç¯å¢ƒå¥æŸ„ã€‚</li><li><code>constructor</code>: JavaScript ä¸­çš„å‡½æ•°ï¼Œé€šå¸¸æ˜¯ä½ æƒ³è¦å®ä¾‹åŒ–çš„æ„é€ å‡½æ•°ã€‚</li><li><code>argc</code>: ä¼ é€’ç»™æ„é€ å‡½æ•°çš„å‚æ•°æ•°é‡ã€‚</li><li><code>argv</code>: æŒ‡å‘ä¼ é€’ç»™æ„é€ å‡½æ•°çš„å‚æ•°æ•°ç»„çš„æŒ‡é’ˆã€‚</li><li><code>result</code>: æ­¤å‡½æ•°è°ƒç”¨å®Œæˆåï¼Œå°†åˆ›å»ºçš„æ–°å®ä¾‹çš„å¥æŸ„å†™å…¥æ­¤ä½ç½®ã€‚</li></ul><h4 id="è¿”å›å€¼-10" tabindex="-1"><a class="header-anchor" href="#è¿”å›å€¼-10"><span>è¿”å›å€¼</span></a></h4><p>è¿”å›<code>napi_status</code>ï¼Œè¿™è¡¨æ˜å‡½æ•°è°ƒç”¨æˆåŠŸè¿˜æ˜¯å¤±è´¥ã€‚å¦‚æœæˆåŠŸï¼Œæ–°åˆ›å»ºçš„å®ä¾‹å°†è¢«èµ‹å€¼ç»™<code>result</code>å‚æ•°ã€‚</p><h4 id="å®é™…è¿ç”¨ç¤ºä¾‹-4" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨ç¤ºä¾‹-4"><span>å®é™…è¿ç”¨ç¤ºä¾‹</span></a></h4><p>å‡è®¾ä½ æœ‰ä¸€ä¸ª C++ç±»å«<code>MyObject</code>ï¼Œå®ƒæœ‰ä¸€ä¸ªæ„é€ å‡½æ•°å¯ä»¥æ¥æ”¶ä¸€ä¸ªæ•´æ•°ã€‚ä½ å¸Œæœ›åœ¨ Node.js ä¸­åˆ›å»º<code>MyObject</code>çš„å®ä¾‹ï¼Œå¹¶ä¼ é€’ä¸€ä¸ªæ•°å­—ä½œä¸ºå‚æ•°ã€‚</p><p>é¦–å…ˆï¼Œä½ ä¼šåˆ›å»ºä¸€ä¸ª N-API çš„åŒ…è£…å™¨ï¼Œä»¥ä¾¿ JavaScript å¯ä»¥è°ƒç”¨å®ƒï¼š</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" data-title="c++" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// C++ ç«¯çš„ MyObject ç±»</span></span>
<span class="line"><span>class MyObject {</span></span>
<span class="line"><span>public:</span></span>
<span class="line"><span>    MyObject(int value) : value_(value) {}</span></span>
<span class="line"><span>    int GetValue() const { return value_; }</span></span>
<span class="line"><span>private:</span></span>
<span class="line"><span>    int value_;</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åŒ…è£…å™¨å‡½æ•°ï¼ŒJavaScript ä¸­å¯ä»¥è°ƒç”¨å®ƒæ¥åˆ›å»º MyObject å®ä¾‹</span></span>
<span class="line"><span>napi_value CreateMyObjectInstance(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_value thisArg;</span></span>
<span class="line"><span>    void* data;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–JavaScriptè°ƒç”¨æ—¶ä¼ é€’çš„å‚æ•°</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, &amp;thisArg, &amp;data);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å‡è®¾æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªæŒ‡å‘MyObjectæ„é€ å‡½æ•°çš„napi_value &#39;constructor&#39;</span></span>
<span class="line"><span>    napi_value instance;</span></span>
<span class="line"><span>    napi_status status = napi_new_instance(env, constructor, argc, args, &amp;instance);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return instance; // è¿”å›æ–°åˆ›å»ºçš„MyObjectå®ä¾‹</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åï¼Œåœ¨ JavaScript ä¸­ï¼Œä½ å¯ä»¥è¿™æ ·ä½¿ç”¨å®ƒï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> myModule</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">native-addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // åŠ è½½åŸç”Ÿæ¨¡å—</span></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> myObject</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> myModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createMyObjectInstance</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">42</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // åˆ›å»ºä¸€ä¸ªMyObjectå®ä¾‹</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>createMyObjectInstance</code>ä¼šå¯¹åº”äº C++ç«¯çš„<code>CreateMyObjectInstance</code>å‡½æ•°ã€‚å½“ä½ ä» JavaScript è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œå®ƒä¼šä½¿ç”¨ç»™å®šçš„å‚æ•°ï¼ˆåœ¨è¿™é‡Œæ˜¯æ•°å­— 42ï¼‰åˆ›å»ºä¸€ä¸ªæ–°çš„<code>MyObject</code>å®ä¾‹ã€‚</p><h2 id="object-wrap" tabindex="-1"><a class="header-anchor" href="#object-wrap"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#object-wrap" target="_blank" rel="noopener noreferrer">Object wrap</a></span></a></h2><p>Node.js ä¸­çš„<code>Object Wrap</code>æ˜¯æŒ‡ä½¿ç”¨ N-APIï¼ˆä¸€ç»„ C è¯­è¨€ APIï¼‰æ¥ç»‘å®š C++å¯¹è±¡ä¸ JavaScript å¯¹è±¡ã€‚å®ƒå…è®¸ä½ åˆ›å»ºä¸€ä¸ª C++å¯¹è±¡ï¼Œå¹¶åœ¨ JavaScript ä»£ç ä¸­æ“ä½œè¿™ä¸ªå¯¹è±¡ï¼Œå°±å¥½åƒå®ƒæ˜¯ä¸€ä¸ªæ™®é€šçš„ JavaScript å¯¹è±¡ä¸€æ ·ã€‚</p><p>åœ¨ Node.js ä¸­åˆ›å»ºæ‰©å±•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ä» JavaScript è°ƒç”¨ C++ä»£ç ä»¥åˆ©ç”¨å…¶æ€§èƒ½ä¼˜åŠ¿æˆ–è€…è®¿é—®ç³»ç»Ÿèµ„æºã€‚ä½†å› ä¸º JavaScript å’Œ C++æ˜¯ä¸¤ç§ä¸åŒçš„ç¼–ç¨‹è¯­è¨€ï¼Œç›´æ¥äº¤äº’å¹¶éæ˜“äº‹ã€‚ä¸ºæ­¤ï¼ŒNode.js æä¾›äº† N-API è¿™æ ·çš„æ¡¥æ¢ï¼Œä½¿å¾—è¿™ä¸¤ç§è¯­è¨€èƒ½å¤Ÿäº’ç›¸æ²Ÿé€šã€‚</p><h3 id="object-wrap-çš„åŸºæœ¬åŸç†" tabindex="-1"><a class="header-anchor" href="#object-wrap-çš„åŸºæœ¬åŸç†"><span>Object Wrap çš„åŸºæœ¬åŸç†ï¼š</span></a></h3><ol><li><strong>C++ä¾§åˆ›å»ºç±»</strong>ï¼šé¦–å…ˆåœ¨ C++ä¾§å®šä¹‰ä¸€ä¸ªç±»ï¼Œå¹¶ä¸”ä¸ºè¿™ä¸ªç±»å®šä¹‰æ„é€ å‡½æ•°ã€ææ„å‡½æ•°å’Œä¸€äº›æ–¹æ³•ã€‚</li><li><strong>åŒ…è£… C++å¯¹è±¡</strong>ï¼šç„¶åé€šè¿‡ Object Wrap å°†è¿™ä¸ª C++ç±»çš„å®ä¾‹å…³è”åˆ°ä¸€ä¸ªæ–°å»ºçš„ JavaScript å¯¹è±¡ä¸Šã€‚</li><li><strong>åœ¨ JavaScript ä¸­è°ƒç”¨</strong>ï¼šJavaScript ä»£ç å¯ä»¥åˆ›å»ºå’Œä½¿ç”¨è¿™ä¸ªå¯¹è±¡ï¼Œè°ƒç”¨å…¶æ–¹æ³•ï¼Œè€Œå®é™…ä¸Šè¿è¡Œçš„æ˜¯ C++ä»£ç ã€‚</li></ol><h3 id="ä¸¾ä¾‹è¯´æ˜-1" tabindex="-1"><a class="header-anchor" href="#ä¸¾ä¾‹è¯´æ˜-1"><span>ä¸¾ä¾‹è¯´æ˜ï¼š</span></a></h3><p>å‡è®¾æˆ‘ä»¬è¦åœ¨ Node.js ä¸­åˆ›å»ºä¸€ä¸ªç®€å•çš„ C++ <code>Counter</code> ç±»ï¼Œè¯¥ç±»æœ‰å¢åŠ ï¼ˆ<code>increment</code>ï¼‰ã€å‡å°‘ï¼ˆ<code>decrement</code>ï¼‰å’Œè·å–å€¼ï¼ˆ<code>getValue</code>ï¼‰çš„åŠŸèƒ½ã€‚</p><ol><li><strong>å®šä¹‰ C++ç±»</strong>:</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`napi.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>class Counter : public Napi::ObjectWrap`&lt;`Counter&gt; {</span></span>
<span class="line"><span>public:</span></span>
<span class="line"><span>    static Napi::Object Init(Napi::Env env, Napi::Object exports); // åˆå§‹åŒ–å‡½æ•°</span></span>
<span class="line"><span>    Counter(const Napi::CallbackInfo&amp; info); // æ„é€ å‡½æ•°</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private:</span></span>
<span class="line"><span>    static Napi::FunctionReference constructor; // æ„é€ å‡½æ•°å¼•ç”¨</span></span>
<span class="line"><span>    double value_; // ç§æœ‰å˜é‡ï¼Œè®¡æ•°å™¨çš„å€¼</span></span>
<span class="line"><span>    Napi::Value Increment(const Napi::CallbackInfo&amp; info); // å®ç°å¢åŠ </span></span>
<span class="line"><span>    Napi::Value Decrement(const Napi::CallbackInfo&amp; info); // å®ç°å‡å°‘</span></span>
<span class="line"><span>    Napi::Value GetValue(const Napi::CallbackInfo&amp; info); // è·å–å½“å‰å€¼</span></span>
<span class="line"><span>};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong>å®ç°æ–¹æ³•</strong>:</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// æ­¤å¤„çœç•¥åŒ…è£…æ–¹æ³•åˆå§‹åŒ–å’Œæ„é€ å‡½æ•°çš„å…·ä½“å®ç°</span></span>
<span class="line"><span>//...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Napi::Value Counter::Increment(const Napi::CallbackInfo&amp; info) {</span></span>
<span class="line"><span>    value_ += 1;</span></span>
<span class="line"><span>    return Napi::Number::New(info.Env(), value_);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Napi::Value Counter::Decrement(const Napi::CallbackInfo&amp; info) {</span></span>
<span class="line"><span>    value_ -= 1;</span></span>
<span class="line"><span>    return Napi::Number::New(info.Env(), value_);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Napi::Value Counter::GetValue(const Napi::CallbackInfo&amp; info) {</span></span>
<span class="line"><span>    return Napi::Number::New(info.Env(), value_);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><strong>åˆ›å»ºå’Œå¯¼å‡ºæ¨¡å—</strong>:</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>Napi::Object Init(Napi::Env env, Napi::Object exports) {</span></span>
<span class="line"><span>    Counter::Init(env, exports);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NODE_API_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li><strong>åœ¨ JavaScript ä¸­ä½¿ç”¨</strong>:</li></ol><p>ä»¥ä¸Š C++ä»£ç ç¼–è¯‘æˆ Node.js æ‰©å±•åï¼Œä½ å¯ä»¥åœ¨ JavaScript ä¸­è¿™æ ·ä½¿ç”¨å®ƒï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> counterAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/counter-addon.node</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> myCounter</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#D8DEE9;"> counterAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Counter</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">0</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">myCounter</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getValue</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º0</span></span>
<span class="line"><span style="color:#D8DEE9;">myCounter</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">increment</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">myCounter</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getValue</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º1</span></span>
<span class="line"><span style="color:#D8DEE9;">myCounter</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">decrement</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">myCounter</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getValue</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª C++çš„<code>Counter</code>ç±»ï¼Œå¹¶ä¸”å®ƒæœ‰ä¸‰ä¸ªæ–¹æ³•ã€‚å½“æˆ‘ä»¬åœ¨ JavaScript ä¸­è°ƒç”¨è¿™äº›æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨ C++å±‚é¢æ‰§è¡Œç›¸å…³æ“ä½œçš„ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ C++çš„æ€§èƒ½å’Œç‰¹æ€§æ¥æ‰©å±• Node.js çš„åŠŸèƒ½ã€‚</p><p>è®°ä½ï¼ŒN-API æ˜¯ç¨³å®šçš„è·¨ç‰ˆæœ¬çš„ API é›†åˆï¼Œæ„å‘³ç€ç”¨å®ƒå†™çš„æ‰©å±•å¯ä»¥åœ¨æœªæ¥çš„ Node.js ç‰ˆæœ¬ä¸­æ— éœ€é‡æ–°ç¼–è¯‘ã€‚è¿™ä½¿å¾—ç»´æŠ¤å’Œå‡çº§ Node.js æ‰©å±•å˜å¾—æ›´åŠ å®¹æ˜“ã€‚</p><h3 id="napi-define-class" tabindex="-1"><a class="header-anchor" href="#napi-define-class"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_define_class" target="_blank" rel="noopener noreferrer">napi_define_class</a></span></a></h3><p><code>napi_define_class</code> æ˜¯ Node.js ä¸­ N-APIï¼ˆåŸç”Ÿ APIï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒè®©ä½ èƒ½å¤Ÿåˆ›å»ºå’Œå®šä¹‰ä¸€ä¸ªæ–°çš„ JavaScript ç±»ï¼Œè¯¥ç±»å¯ä»¥é“¾æ¥åˆ° C æˆ–è€… C++ çš„ä»£ç ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ä½ å¯ä»¥åœ¨ Node.js ä¸­ä½¿ç”¨æ€§èƒ½æ›´é«˜ã€æ›´æ¥è¿‘ç¡¬ä»¶å±‚é¢çš„ç¼–ç¨‹è¯­è¨€å†™çš„ä»£ç ã€‚</p><p>å½“æˆ‘ä»¬è¯´â€œå®šä¹‰ä¸€ä¸ªç±»â€æ—¶ï¼ŒæŒ‡çš„æ˜¯åœ¨ JavaScript ä¸­åˆ›å»ºä¸€ä¸ªå¯ä»¥è¢«å®ä¾‹åŒ–ï¼ˆå³åˆ›å»ºå…·ä½“å¯¹è±¡ï¼‰çš„è“å›¾ã€‚è¿™ä¸ªç±»å¯ä»¥æœ‰è‡ªå·±çš„å±æ€§ï¼ˆpropertiesï¼‰å’Œæ–¹æ³•ï¼ˆmethodsï¼‰ï¼Œå°±åƒå…¶ä»–ä»»ä½• JavaScript ç±»ä¸€æ ·ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†è§£é‡Šä¸€ä¸‹ <code>napi_define_class</code> å‡½æ•°ï¼Œå¹¶ä¸¾å‡ ä¸ªä¾‹å­æ¥è¯´æ˜å®ƒçš„è¿ç”¨ã€‚</p><p>é¦–å…ˆï¼Œè¿™ä¸ªå‡½æ•°çš„åŸºæœ¬å½¢å¼æ˜¯ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_define_class(</span></span>
<span class="line"><span>    napi_env env,</span></span>
<span class="line"><span>    const char* utf8name,</span></span>
<span class="line"><span>    size_t length,</span></span>
<span class="line"><span>    napi_callback constructor,</span></span>
<span class="line"><span>    void* data,</span></span>
<span class="line"><span>    size_t property_count,</span></span>
<span class="line"><span>    const napi_property_descriptor* properties,</span></span>
<span class="line"><span>    napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œå„ä¸ªå‚æ•°çš„å«ä¹‰æ˜¯ï¼š</p><ul><li><code>env</code>: å½“å‰çš„ N-API ç¯å¢ƒå¥æŸ„ã€‚</li><li><code>utf8name</code>: æ–°ç±»çš„åç§°ï¼Œå®ƒæ˜¯ä¸€ä¸ª UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ã€‚</li><li><code>length</code>: è¿™ä¸ªåç§°çš„é•¿åº¦ï¼Œå¦‚æœæ˜¯ä»¥ null ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œåˆ™å¯ä»¥ä¼ é€’ <code>NAPI_AUTO_LENGTH</code>ã€‚</li><li><code>constructor</code>: ä¸€ä¸ªæŒ‡å‘æ„é€ å‡½æ•°çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæ„é€ å‡½æ•°ä¼šåœ¨ä½ é€šè¿‡ <code>new</code> å…³é”®å­—åˆ›å»ºç±»çš„å®ä¾‹æ—¶è°ƒç”¨ã€‚</li><li><code>data</code>: å¯é€‰çš„æ•°æ®ï¼Œå¯ä»¥å’Œæ„é€ å‡½æ•°ä¸€èµ·ä¼ é€’ï¼Œé€šå¸¸ç”¨äºä¿å­˜æ„é€ å‡½æ•°éœ€è¦çš„çŠ¶æ€æˆ–ä¿¡æ¯ã€‚</li><li><code>property_count</code>: ç±»å±æ€§çš„æ•°é‡ã€‚</li><li><code>properties</code>: ç±»å±æ€§æè¿°ç¬¦æ•°ç»„ï¼Œæ¯ä¸ªå±æ€§éƒ½å¯¹åº”ä¸€ä¸ª <code>napi_property_descriptor</code> ç»“æ„ä½“ï¼Œç”¨äºå®šä¹‰å±æ€§çš„åå­—ã€å±æ€§å­˜åœ¨çš„ä½ç½®ã€ä»¥åŠå±æ€§çš„è®¿é—®å™¨ç­‰ã€‚</li><li><code>result</code>: è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå­˜æ”¾ç»“æœçš„åœ°æ–¹ï¼Œé€šå¸¸æ˜¯æ–°å®šä¹‰ç±»çš„å¼•ç”¨ã€‚</li></ul><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><p>æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬è¦åœ¨ Node.js ä¸­åˆ›å»ºä¸€ä¸ªåŸç”Ÿæ‰©å±•ï¼Œè¡¨ç¤ºä¸€ä¸ªç®€å•çš„ &quot;Rectangle&quot; ï¼ˆçŸ©å½¢ï¼‰ç±»ã€‚è¿™ä¸ªç±»å°†æ‹¥æœ‰é•¿åº¦å’Œå®½åº¦ä½œä¸ºå±æ€§ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªæ–¹æ³•æ¥è®¡ç®—é¢ç§¯ã€‚</p><p>åœ¨ C/C++ ä»£ç ä¸­ï¼Œä½ å¯èƒ½ä¼šè¿™æ ·å®šä¹‰ Rectangle ç±»ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ„é€ å‡½æ•°</span></span>
<span class="line"><span>napi_value RectangleConstructor(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // ... åˆ›å»ºå’Œåˆå§‹åŒ– Rectangle å¯¹è±¡ ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è®¡ç®—é¢ç§¯çš„æ–¹æ³•</span></span>
<span class="line"><span>napi_value CalculateArea(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // ... è®¡ç®—é¢ç§¯çš„ä»£ç  ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œç”¨äºåˆ›å»ºç±»å’Œå¯¼å‡ºç›¸å…³åŠŸèƒ½</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å±æ€§æè¿°ç¬¦ï¼šlength å’Œ width</span></span>
<span class="line"><span>    napi_property_descriptor properties[] = {</span></span>
<span class="line"><span>        { &quot;length&quot;, 0, 0, 0, 0, 0, napi_default, 0 },</span></span>
<span class="line"><span>        { &quot;width&quot;, 0, 0, 0, 0, 0, napi_default, 0 }</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å®šä¹‰ Rectangle ç±»</span></span>
<span class="line"><span>    napi_value rectangle_class;</span></span>
<span class="line"><span>    status = napi_define_class(env, &quot;Rectangle&quot;, NAPI_AUTO_LENGTH, RectangleConstructor, nullptr, 2, properties, &amp;rectangle_class);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°† Rectangle ç±»å¯¼å‡ºç»™ JavaScript ä½¿ç”¨</span></span>
<span class="line"><span>    if (status == napi_ok) {</span></span>
<span class="line"><span>        status = napi_set_named_property(env, exports, &quot;Rectangle&quot;, rectangle_class);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç ä¸ºäº†ç®€æ´å¹¶æœªåŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œå®é™…çš„å±æ€§/æ–¹æ³•å®ç°ç»†èŠ‚ï¼Œä½†å®ƒå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>napi_define_class</code> æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ç±»ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ éœ€è¦å®ç°æ„é€ å‡½æ•°ã€é¢ç§¯è®¡ç®—æ–¹æ³•ï¼Œå¹¶ç¡®ä¿æ‰€æœ‰çš„å±æ€§å’Œæ–¹æ³•éƒ½æ­£ç¡®å…³è”åˆ°å¯¹åº”çš„ C/C++ å‡½æ•°ã€‚</p><p>æœ€åï¼Œå½“ä½ ç¼–è¯‘å¹¶åŠ è½½äº†è¿™ä¸ªæ‰©å±•ä¹‹åï¼Œåœ¨ Node.js ä¸­å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> myNativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my-native-addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> Rectangle</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> myNativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Rectangle</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">let</span><span style="color:#D8DEE9;"> rect</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Rectangle</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">rect</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">length </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">rect</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">width</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 5</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">rect</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">CalculateArea</span><span style="color:#D8DEE9FF;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºçŸ©å½¢çš„é¢ç§¯</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™å°±æ˜¯ <code>napi_define_class</code> åœ¨ Node.js v21.7.1 ç‰ˆæœ¬ä¸­çš„ä½œç”¨å’Œä¸€ä¸ªåŸºç¡€çš„ç¤ºä¾‹ã€‚</p><h3 id="napi-wrap" tabindex="-1"><a class="header-anchor" href="#napi-wrap"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_wrap" target="_blank" rel="noopener noreferrer">napi_wrap</a></span></a></h3><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬æ¥è°ˆè°ˆ Node.js ä¸­çš„ <code>napi_wrap</code>ã€‚</p><p>åœ¨ Node.js ä¸­ï¼Œ<code>N-API</code>ï¼ˆNode.js APIï¼‰æ˜¯ä¸€ä¸ªä½å±‚æ¬¡çš„ APIï¼Œå®ƒå…è®¸ä½ ç¼–å†™æœ¬åœ°æ’ä»¶ï¼Œå³ç”¨ C æˆ–è€… C++ ç­‰è¯­è¨€ç¼–å†™çš„æ¨¡å—ã€‚è¿™äº›æœ¬åœ°æ’ä»¶å¯ä»¥ç›´æ¥æ“ä½œ JavaScript å€¼å’Œå¯¹è±¡ï¼Œä»¥åŠä¸ JavaScript ä»£ç äº¤äº’ã€‚</p><p><code>napi_wrap</code> æ˜¯ N-API æ‰€æä¾›çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†ä¸€ä¸ª JavaScript å¯¹è±¡ä¸ä¸€ä¸ªæœ¬åœ°å¯¹è±¡ï¼ˆé€šå¸¸æ˜¯ç”¨ C/C++ ç¼–å†™çš„å¯¹è±¡ï¼‰å…³è”èµ·æ¥ã€‚é€šè¿‡è¿™ç§å…³è”ï¼Œä½ å¯ä»¥åœ¨æœ¬åœ°ä»£ç ä¸­ä¿å­˜ç§æœ‰æ•°æ®ï¼Œå¹¶ä¸”ç¡®ä¿å½“ JavaScript å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶ï¼Œç›¸å…³çš„æœ¬åœ°èµ„æºä¹Ÿèƒ½å¾—åˆ°æ¸…ç†ã€‚</p><p>ç°åœ¨è®©æˆ‘ä»¬è¯¦ç»†äº†è§£ä¸€ä¸‹ <code>napi_wrap</code> çš„å‚æ•°å’Œä½¿ç”¨æ–¹æ³•ï¼š</p><h3 id="å‡½æ•°åŸå‹-3" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°åŸå‹-3"><span>å‡½æ•°åŸå‹</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_wrap(</span></span>
<span class="line"><span>    napi_env env,</span></span>
<span class="line"><span>    napi_value js_object,</span></span>
<span class="line"><span>    void* native_object,</span></span>
<span class="line"><span>    napi_finalize finalize_cb,</span></span>
<span class="line"><span>    void* finalize_hint,</span></span>
<span class="line"><span>    napi_ref* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>: è¿™æ˜¯è¡¨ç¤ºå½“å‰æ‰§è¡Œç¯å¢ƒçš„ <code>napi_env</code> å¥æŸ„ã€‚</li><li><code>js_object</code>: è¿™æ˜¯è¦å…³è”æœ¬åœ°å¯¹è±¡çš„ JavaScript å¯¹è±¡ã€‚</li><li><code>native_object</code>: è¿™æ˜¯è¦é™„åŠ åˆ° JavaScript å¯¹è±¡ä¸Šçš„æœ¬åœ°å¯¹è±¡çš„æŒ‡é’ˆã€‚</li><li><code>finalize_cb</code>: å½“ JavaScript å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶è°ƒç”¨çš„å›è°ƒå‡½æ•°ï¼Œç”¨æ¥æ¸…ç† <code>native_object</code>ã€‚</li><li><code>finalize_hint</code>: ä¼ é€’ç»™ <code>finalize_cb</code> å›è°ƒçš„å¯é€‰æ•°æ®ã€‚</li><li><code>result</code>: è¿”å›åˆ›å»ºçš„å¼•ç”¨ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯é€‰å‚æ•°ã€‚</li></ul><h3 id="ä½¿ç”¨åœºæ™¯-2" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯-2"><span>ä½¿ç”¨åœºæ™¯</span></a></h3><p>å‡è®¾ä½ æƒ³åˆ›å»ºä¸€ä¸ª JavaScript ç±»ï¼Œç§°ä¸º <code>MyNativeObject</code>ï¼Œå®ƒèƒŒåæœ‰ä¸€ä¸ª C++ ç±» <code>NativeObject</code> æä¾›æ”¯æŒã€‚ä½ å¯èƒ½ä¼šè¿™æ ·ä½¿ç”¨ <code>napi_wrap</code>:</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™æ˜¯ä½ çš„ C++ å¯¹è±¡çš„ç±»</span></span>
<span class="line"><span>class NativeObject {</span></span>
<span class="line"><span>public:</span></span>
<span class="line"><span>    // æ„é€ å‡½æ•°ã€ææ„å‡½æ•°å’Œå…¶ä»–æ–¹æ³•</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å½“ JS å¯¹è±¡è¢«å›æ”¶æ—¶éœ€è¦è°ƒç”¨çš„æ¸…ç†å‡½æ•°</span></span>
<span class="line"><span>void FinalizeCallback(napi_env env, void* finalize_data, void* finalize_hint) {</span></span>
<span class="line"><span>    // è½¬æ¢ finalize_data ä¸º NativeObject æŒ‡é’ˆå¹¶åˆ é™¤å®ƒ</span></span>
<span class="line"><span>    NativeObject* obj = static_cast`&lt;`NativeObject*&gt;(finalize_data);</span></span>
<span class="line"><span>    delete obj;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ›å»ºæ–°çš„ MyNativeObject å®ä¾‹çš„å‡½æ•°</span></span>
<span class="line"><span>napi_value CreateMyNativeObject(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ä» JavaScript ç«¯æ¥æ”¶çš„å‚æ•°ç­‰</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    status = napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä½ çš„ C++ å¯¹è±¡</span></span>
<span class="line"><span>    NativeObject* obj = new NativeObject();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªæ–°çš„ç©º JavaScript å¯¹è±¡</span></span>
<span class="line"><span>    napi_value js_object;</span></span>
<span class="line"><span>    status = napi_create_object(env, &amp;js_object);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†ä½ çš„æœ¬åœ°å¯¹è±¡ä¸ JavaScript å¯¹è±¡å…³è”èµ·æ¥</span></span>
<span class="line"><span>    status = napi_wrap(env, js_object, obj, FinalizeCallback, nullptr, nullptr);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›æ–°åˆ›å»ºçš„ JavaScript å¯¹è±¡</span></span>
<span class="line"><span>    return js_object;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œè®¾ç½® MyNativeObject</span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è®¾ç½® CreateMyNativeObject ä¸ºå¯¼å‡ºå‡½æ•°</span></span>
<span class="line"><span>    napi_value new_function;</span></span>
<span class="line"><span>    status = napi_create_function(env, &quot;&quot;, NAPI_AUTO_LENGTH, CreateMyNativeObject, nullptr, &amp;new_function);</span></span>
<span class="line"><span>    status = napi_set_named_property(env, exports, &quot;createMyNativeObject&quot;, new_function);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å®šä¹‰æ¨¡å—</span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šå°±æ˜¯ <code>napi_wrap</code> çš„ä¸€ä¸ªå®é™…åº”ç”¨ç¤ºä¾‹ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª C++ ç±» <code>NativeObject</code> å¹¶åœ¨ JavaScript ç¯å¢ƒä¸­åˆ›å»ºäº†ä¸€ä¸ªå¯¹åº”çš„ç±» <code>MyNativeObject</code>ã€‚æ¯å½“åœ¨ JavaScript ä¸­åˆ›å»º <code>MyNativeObject</code> çš„å®ä¾‹æ—¶ï¼Œéƒ½ä¼šåœ¨åº•å±‚åˆ›å»ºä¸€ä¸ª <code>NativeObject</code> å®ä¾‹å¹¶å°†å…¶ä¸ JavaScript å¯¹è±¡å…³è”èµ·æ¥ã€‚å½“ JavaScript å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶ï¼Œ<code>FinalizeCallback</code> å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå®ƒå°†è´Ÿè´£æ¸…ç† C++ å¯¹è±¡ï¼Œé˜²æ­¢å†…å­˜æ³„éœ²ã€‚</p><h3 id="napi-unwrap" tabindex="-1"><a class="header-anchor" href="#napi-unwrap"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_unwrap" target="_blank" rel="noopener noreferrer">napi_unwrap</a></span></a></h3><p><code>napi_unwrap</code>æ˜¯ Node.js ä¸­ N-APIï¼ˆNode APIï¼‰çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä½¿å¾—åŸç”Ÿæ¨¡å—å¼€å‘äººå‘˜èƒ½å¤ŸæŠŠ JavaScript å¯¹è±¡ä¸ C/C++çš„åŸç”Ÿå¯¹è±¡ç›¸å…³è”å¹¶ä¸”ç®¡ç†è¿™ç§å…³è”ã€‚æ¢å¥è¯è¯´ï¼Œä½ å¯ä»¥åœ¨ä¸€ä¸ª JavaScript å¯¹è±¡ä¸­éšè—ä¸€ä¸ªæŒ‡å‘ C/C++å¯¹è±¡çš„æŒ‡é’ˆï¼Œå¹¶ä¸”å½“éœ€è¦æ—¶ï¼Œå†ä» JavaScript å¯¹è±¡ä¸­æ£€ç´¢å‡ºè¿™ä¸ªæŒ‡é’ˆã€‚è¿™ç§æŠ€æœ¯ç»å¸¸ç”¨äºåˆ›å»ºå’Œç»´æŠ¤ JavaScript å¯¹è±¡ä¸ C/C++èµ„æºä¹‹é—´çš„è”ç³»ã€‚</p><p>ä½¿ç”¨<code>napi_unwrap</code>çš„å…¸å‹åœºæ™¯æ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li>ä½¿ç”¨<code>napi_wrap</code>å°†ä¸€ä¸ª C/C++å¯¹è±¡ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªç±»çš„å®ä¾‹ï¼‰ä¸ä¸€ä¸ªæ–°åˆ›å»ºçš„æˆ–è€…å·²æœ‰çš„ JavaScript å¯¹è±¡å…³è”èµ·æ¥ã€‚</li><li>åœ¨ JavaScript ä»£ç æ‰§è¡ŒæœŸé—´ï¼Œå½“éœ€è¦è®¿é—®è¿™ä¸ª C/C++å¯¹è±¡æ—¶ï¼Œå¯ä»¥è°ƒç”¨<code>napi_unwrap</code>æ¥è·å–ä¹‹å‰å­˜å‚¨çš„æŒ‡é’ˆã€‚</li><li>ä½¿ç”¨è¿™ä¸ªæŒ‡é’ˆï¼Œä½ å¯ä»¥åœ¨åŸç”Ÿä»£ç ä¸­æ“ä½œå¯¹åº”çš„ C/C++å¯¹è±¡ã€‚</li></ol><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­ï¼Œè¯´æ˜äº†å¦‚ä½•ä½¿ç”¨<code>napi_unwrap</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å‡è®¾ä½ æœ‰ä¸€ä¸ªC++ç±» MyObject</span></span>
<span class="line"><span>class MyObject {</span></span>
<span class="line"><span>  public:</span></span>
<span class="line"><span>    void DoSomething() {</span></span>
<span class="line"><span>      // ... å®é™…çš„æ“ä½œ ...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯ä¸€ä¸ªN-APIå‡½æ•°ï¼Œå®ƒå°†JavaScriptå¯¹è±¡ä¸C++å¯¹è±¡å…³è”èµ·æ¥</span></span>
<span class="line"><span>napi_value CreateMyObject(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ªC++å¯¹è±¡</span></span>
<span class="line"><span>  MyObject* obj = new MyObject();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è·å–JavaScriptä¸Šä¸‹æ–‡å’Œä¼ é€’ç»™å‡½æ•°çš„å‚æ•°ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰</span></span>
<span class="line"><span>  size_t argc = 0;</span></span>
<span class="line"><span>  napi_value thisArg;</span></span>
<span class="line"><span>  napi_get_cb_info(env, info, &amp;argc, nullptr, &amp;thisArg, nullptr);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å°†C++å¯¹è±¡ä¸JavaScriptå¯¹è±¡å…³è”èµ·æ¥</span></span>
<span class="line"><span>  napi_wrap(env, thisArg, obj, MyObjectFinalizer, nullptr, nullptr);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›JavaScriptå¯¹è±¡</span></span>
<span class="line"><span>  return thisArg;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™éƒ¨åˆ†å±•ç¤ºäº†å¦‚ä½•åœ¨å¦ä¸€ä¸ªå‡½æ•°ä¸­è§£æå‡ºC++å¯¹è±¡</span></span>
<span class="line"><span>napi_value CallDoSomething(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  size_t argc = 0;</span></span>
<span class="line"><span>  napi_value thisArg;</span></span>
<span class="line"><span>  napi_get_cb_info(env, info, &amp;argc, nullptr, &amp;thisArg, nullptr);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è§£æå‡ºC++å¯¹è±¡</span></span>
<span class="line"><span>  MyObject* obj;</span></span>
<span class="line"><span>  napi_unwrap(env, thisArg, reinterpret_cast`&lt;`void**&gt;(&amp;obj));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è°ƒç”¨C++å¯¹è±¡çš„æ–¹æ³•</span></span>
<span class="line"><span>  obj-&gt;DoSomething();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›undefinedï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°ä¸éœ€è¦è¿”å›å€¼</span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span>  napi_get_undefined(env, &amp;result);</span></span>
<span class="line"><span>  return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå«ä½œ<code>MyObject</code>çš„ C++ç±»ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ªæ–¹æ³•<code>DoSomething</code>ã€‚æˆ‘ä»¬æƒ³è¦è®© JavaScript ä»£ç èƒ½å¤Ÿåˆ›å»ºè¿™ä¸ªç±»çš„å®ä¾‹ï¼Œå¹¶ä¸”è°ƒç”¨å…¶<code>DoSomething</code>æ–¹æ³•ã€‚</p><ul><li>åœ¨<code>CreateMyObject</code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª<code>MyObject</code>çš„å®ä¾‹ï¼Œå¹¶ä½¿ç”¨<code>napi_wrap</code>å°†å…¶ä¸ JavaScript çš„<code>thisArg</code>å¯¹è±¡å…³è”ã€‚</li><li>ç„¶åï¼Œåœ¨<code>CallDoSomething</code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>napi_unwrap</code>ä»<code>thisArg</code>ä¸­å–å›ä¹‹å‰å­˜å‚¨çš„<code>MyObject</code>å®ä¾‹çš„æŒ‡é’ˆï¼Œç„¶åè°ƒç”¨å…¶<code>DoSomething</code>æ–¹æ³•ã€‚</li></ul><p>æ³¨æ„è¿™é‡Œåªæ˜¯å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨è¿™ä¸¤ä¸ª APIï¼Œè¯¦ç»†å®ç°ä¼šæ¶‰åŠé”™è¯¯å¤„ç†ã€èµ„æºæ¸…ç†ç­‰å…¶ä»–è€ƒè™‘ã€‚</p><p>é‡è¦çš„æ˜¯è¦è®°ä½ï¼Œ<code>napi_wrap</code>å’Œ<code>napi_unwrap</code>ä¸»è¦è¢«ç”¨äºç®¡ç† JavaScript å¯¹è±¡å’Œ C/C++èµ„æºä¹‹é—´çš„ç”Ÿå‘½å‘¨æœŸå’Œå…³ç³»ã€‚ ç»“åˆä½¿ç”¨è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œå¯ä»¥ç¡®ä¿å½“ JavaScript å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶ï¼Œç›¸åº”çš„ C/C++èµ„æºä¹Ÿå¾—åˆ°é€‚å½“çš„é‡Šæ”¾ã€‚</p><h3 id="napi-remove-wrap" tabindex="-1"><a class="header-anchor" href="#napi-remove-wrap"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_remove_wrap" target="_blank" rel="noopener noreferrer">napi_remove_wrap</a></span></a></h3><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªåº•å±‚çš„ APIï¼Œä½¿å¾—ä½ å¯ä»¥ç”¨ C æˆ–è€… C++ ç¼–å†™æ‰©å±•ã€‚è¿™äº›æ‰©å±•å¯ä»¥å’Œ Node.js è¿›è¡Œäº¤äº’ï¼Œè®©ä½ èƒ½å¤Ÿä»¥éå¸¸é«˜æ•ˆçš„æ–¹å¼æ‰§è¡Œä¸€äº›ä¸èƒ½æˆ–ä¸æ–¹ä¾¿ç›´æ¥ç”¨ JavaScript å®ç°çš„ä»»åŠ¡ã€‚</p><p><code>napi_remove_wrap</code> æ˜¯ N-API çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯ç§»é™¤ä¹‹å‰ä½¿ç”¨ <code>napi_wrap</code> å¯¹ä¸€ä¸ª JavaScript å¯¹è±¡æ‰€é™„åŠ çš„åŸç”Ÿï¼ˆnativeï¼‰æŒ‡é’ˆã€‚åœ¨è¯¦ç»†è§£é‡Šè¿™ä¸ªæ¦‚å¿µä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£å‡ ä¸ªå’Œ N-API ç›¸å…³çš„æ¦‚å¿µï¼š</p><ol><li><strong>Native æŒ‡é’ˆï¼ˆåŸç”ŸæŒ‡é’ˆï¼‰</strong>: è¿™é€šå¸¸æ˜¯ä¸€ä¸ªæŒ‡å‘ C/C++ æ•°æ®ç»“æ„çš„æŒ‡é’ˆã€‚</li><li><strong>Wrapï¼ˆåŒ…è£¹ï¼‰</strong>: åœ¨ N-API ä¸­ï¼Œâ€œåŒ…è£¹â€ä¸€ä¸ªå¯¹è±¡æ˜¯æŒ‡å°†ä¸€ä¸ª Native æŒ‡é’ˆå’Œä¸€ä¸ª JavaScript å¯¹è±¡ç›¸å…³è”ã€‚è¿™æ ·åšå¯ä»¥è®© JavaScript å¯¹è±¡ä¸ C/C++ ä»£ç å…±äº«çŠ¶æ€ã€‚</li><li><strong>Unwrapï¼ˆè§£åŒ…ï¼‰</strong>: è§£åŒ…åˆ™æ˜¯å–å›ä¹‹å‰åŒ…è£¹çš„åŸç”ŸæŒ‡é’ˆã€‚</li></ol><p>ç°åœ¨ï¼Œæ¥çœ‹<code>napi_remove_wrap</code>è¿™ä¸ªå‡½æ•°ã€‚å½“ä½ åœ¨ JavaScript å’Œ C/C++ æ··åˆç¼–ç¨‹æ—¶ï¼Œä½ å¯èƒ½ä¼šåˆ›å»ºä¸€äº›å¤æ‚çš„å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡åœ¨ JavaScript å±‚é¢ä¸Šçœ‹èµ·æ¥åªæ˜¯æ™®é€šçš„å¯¹è±¡ï¼Œä½†å®é™…ä¸Šå®ƒä»¬èƒŒåæœ‰ç€ C/C++ çš„åŸç”Ÿèµ„æºï¼ˆæ¯”å¦‚å†…å­˜ã€æ–‡ä»¶æè¿°ç¬¦ç­‰ï¼‰ã€‚é€šè¿‡ <code>napi_wrap</code> å‡½æ•°ï¼Œä½ å¯ä»¥å°†è¿™äº›åŸç”Ÿèµ„æºå’Œ JavaScript å¯¹è±¡å…³è”èµ·æ¥ï¼Œè¿™ç§°ä¸ºâ€œåŒ…è£¹â€ã€‚</p><p>ç„¶è€Œï¼Œæœ‰æ—¶å€™ä½ å¸Œæœ›é‡Šæ”¾è¿™äº›åŸç”Ÿèµ„æºï¼Œä¾‹å¦‚ï¼Œå½“å¯¹è±¡ä¸å†éœ€è¦æ—¶ï¼Œæˆ–è€…ä½ æƒ³é‡æ–°åˆ†é…èµ„æºåˆ°å¦ä¸€ä¸ªå¯¹è±¡ä¸Šã€‚è¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ°<code>napi_remove_wrap</code>ã€‚è°ƒç”¨<code>napi_remove_wrap</code>ä¼šåšä¸¤ä»¶äº‹æƒ…ï¼š</p><ol><li>å®ƒä¼šç§»é™¤ JavaScript å¯¹è±¡å’ŒåŸç”ŸæŒ‡é’ˆä¹‹é—´çš„å…³è”ã€‚</li><li>å®ƒå…è®¸ä½ è·å–é‚£ä¸ªåŸç”ŸæŒ‡é’ˆï¼Œè¿™æ ·ä½ å°±å¯ä»¥é€‚å½“åœ°ç®¡ç†å®ƒï¼Œæ¯”å¦‚é‡Šæ”¾å®ƒå ç”¨çš„å†…å­˜ã€‚</li></ol><h3 id="ä¾‹å­-3" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-3"><span>ä¾‹å­</span></a></h3><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª C++ ç±» <code>MyObject</code>ï¼Œå¹¶ä¸”æˆ‘ä»¬æƒ³è¦ä» JavaScript è®¿é—®å®ƒçš„å®ä¾‹ã€‚æˆ‘ä»¬é¦–å…ˆä¼šç”¨ <code>napi_wrap</code> å°† <code>MyObject</code> çš„å®ä¾‹ï¼ˆåŸç”ŸæŒ‡é’ˆï¼‰åŒ…è£¹åˆ°ä¸€ä¸ªæ–°çš„ JavaScript å¯¹è±¡ä¸­ã€‚ç¨åï¼Œå¦‚æœæˆ‘ä»¬æƒ³åˆ é™¤è¯¥å¯¹è±¡ï¼Œå¹¶ä¸”æ¸…ç†åå°çš„ C++ èµ„æºï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ <code>napi_remove_wrap</code> æ¥å–å¾—åŸç”ŸæŒ‡é’ˆï¼Œç„¶ååˆ é™¤å®ƒã€‚</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>class MyObject {</span></span>
<span class="line"><span>public:</span></span>
<span class="line"><span>    MyObject() { /* æ„é€ å‡½æ•°é€»è¾‘ */ }</span></span>
<span class="line"><span>    ~MyObject() { /* ææ„å‡½æ•°é€»è¾‘ï¼Œè´Ÿè´£é‡Šæ”¾èµ„æº */ }</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åŒ…è£¹ MyObject å®ä¾‹åˆ°ä¸€ä¸ª JavaScript å¯¹è±¡</span></span>
<span class="line"><span>napi_status WrapMyObject(napi_env env, MyObject* obj, napi_value jsObj) {</span></span>
<span class="line"><span>    return napi_wrap(env, jsObj, obj, MyObject::Destructor, nullptr, nullptr);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¹‹åæŸä¸ªæ—¶é—´ï¼Œæˆ‘ä»¬æƒ³è¦ç§»é™¤åŒ…è£¹å¹¶ä¸”æ¸…ç†èµ„æº</span></span>
<span class="line"><span>napi_status RemoveWrapMyObject(napi_env env, napi_value jsObj) {</span></span>
<span class="line"><span>    MyObject* obj;</span></span>
<span class="line"><span>    napi_status status = napi_remove_wrap(env, jsObj, reinterpret_cast`&lt;`void**&gt;(&amp;obj));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (status == napi_ok) {</span></span>
<span class="line"><span>        delete obj; // è°ƒç”¨ MyObject çš„ææ„å‡½æ•°æ¥æ¸…ç†</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return status;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·è®°ä½ï¼Œä»¥ä¸Šçš„ä¾‹å­åªæ˜¯ä¸€ä¸ªç®€åŒ–çš„æ¼”ç¤ºï¼Œå®é™…å½“ä¸­å¤„ç†é”™è¯¯æƒ…å†µå’Œç”Ÿå‘½å‘¨æœŸç®¡ç†ä¼šæ›´åŠ å¤æ‚ã€‚æ­¤å¤–ï¼Œåœ¨ Node.js é¡¹ç›®ä¸­ç›´æ¥ç¼–è¾‘ C++ ä»£ç å¹¶ä¸å¸¸è§ï¼Œå› ä¸º Node.js çš„æ ¸å¿ƒä¼˜åŠ¿åœ¨äºå…¶äº‹ä»¶é©±åŠ¨å’Œéé˜»å¡çš„ I/O æ¨¡å‹ï¼Œå¹¶ä¸”å¤§å¤šæ•°å¸¸è§ä»»åŠ¡éƒ½å¯ä»¥ç›´æ¥ç”¨ JavaScript å®Œæˆã€‚ä¸è¿‡ï¼Œäº†è§£è¿™äº›èƒ½åŠ›å¯¹äºæ€§èƒ½ä¼˜åŒ–å’Œç¼–å†™æ›´å¤æ‚çš„æ‰©å±•å¯èƒ½æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚</p><h3 id="napi-type-tag-object" tabindex="-1"><a class="header-anchor" href="#napi-type-tag-object"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_type_tag_object" target="_blank" rel="noopener noreferrer">napi_type_tag_object</a></span></a></h3><p>å½“ç„¶ï¼Œæˆ‘ä¼šå°½é‡ç”¨ç®€å•æ˜“æ‡‚çš„è¯­è¨€æ¥è§£é‡Šã€‚<code>napi_type_tag_object</code> æ˜¯ Node.js ä¸­ N-APIï¼ˆåŸç”Ÿ APIï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå…è®¸ä½ åœ¨ JavaScript ä¸åŸç”Ÿ C/C++ æ’ä»¶ä¹‹é—´å®‰å…¨åœ°ä¼ é€’å¯¹è±¡ã€‚</p><p>ä¸ºäº†ç†è§£ <code>napi_type_tag_object</code> çš„ä½œç”¨ï¼Œé¦–å…ˆéœ€è¦æ˜ç™½åœ¨ Node.js ä¸­ï¼ŒJavaScript ä»£ç å¯ä»¥è°ƒç”¨ C/C++ ç¼–å†™çš„åŸç”Ÿæ¨¡å—ï¼Œè¿™ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ°æ•°æ®ç±»å‹çš„è½¬æ¢ã€‚å› ä¸º JavaScript å’Œ C/C++ ä½¿ç”¨ä¸åŒçš„ç±»å‹ç³»ç»Ÿï¼Œæ‰€ä»¥åœ¨å®ƒä»¬ä¹‹é—´ä¼ é€’å¤æ‚çš„æ•°æ®ï¼ˆæ¯”å¦‚å¯¹è±¡ï¼‰æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ä¼ é€’çš„æ˜¯æ­£ç¡®çš„ç±»å‹ï¼Œé˜²æ­¢å‘ç”Ÿæ„å¤–çš„è¡Œä¸ºæˆ–è€…å®‰å…¨é—®é¢˜ã€‚</p><p><code>napi_type_tag_object</code> å°±æ˜¯ç”¨æ¥å¸®åŠ©æ ‡è¯†å’ŒéªŒè¯å¯¹è±¡ç±»å‹çš„ã€‚é€šè¿‡ç»™å¯¹è±¡æ·»åŠ ä¸€ä¸ªå”¯ä¸€çš„â€œç±»å‹æ ‡ç­¾â€ï¼Œä½ å¯ä»¥åœ¨åç»­çš„ä»£ç ä¸­æ£€æŸ¥ä¼ å…¥çš„å¯¹è±¡æ˜¯å¦æ‹¥æœ‰æ­£ç¡®çš„ç±»å‹æ ‡ç­¾ï¼Œè¿™æ ·å°±å¯ä»¥ç¡®è®¤å®ƒæ˜¯ä»é¢„æœŸçš„æºå¤´ä¼ å…¥çš„ï¼Œè€Œä¸æ˜¯å…¶ä»–å¯èƒ½é€ æˆé—®é¢˜çš„å¯¹è±¡ã€‚</p><p>æ¥ä¸¾å‡ ä¸ªä¾‹å­ï¼š</p><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªåŸç”Ÿçš„ C/C++æ’ä»¶ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªå‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªç‰¹å®šç±»å‹çš„å¯¹è±¡ï¼Œæ¯”å¦‚è¡¨ç¤ºä¸€ä¸ªç½‘ç»œè¿æ¥çš„å¯¹è±¡ã€‚ä½ å¯ä»¥ä½¿ç”¨<code>napi_type_tag_object</code>æ¥æ ‡è®°è¿™ä¸ªå¯¹è±¡ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value connection_object;</span></span>
<span class="line"><span>napi_create_object(env, &amp;connection_object);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ç±»å‹æ ‡ç­¾</span></span>
<span class="line"><span>napi_type_tag type_tag;</span></span>
<span class="line"><span>napi_create_type_tag(env, &amp;type_tag);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å°†ç±»å‹æ ‡ç­¾é™„åŠ åˆ°åˆšåˆšåˆ›å»ºçš„å¯¹è±¡ä¸Š</span></span>
<span class="line"><span>napi_type_tag_object(env, connection_object, &amp;type_tag);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶ååœ¨å¦ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œä½ å¯èƒ½æƒ³æ“ä½œè¿™ä¸ªç½‘ç»œè¿æ¥å¯¹è±¡ã€‚ä½†æ˜¯ä½ éœ€è¦ç¡®ä¿ä¼ è¿›æ¥çš„å¯¹è±¡ç¡®å®æ˜¯ä¸€ä¸ªç½‘ç»œè¿æ¥å¯¹è±¡ï¼Œè€Œä¸æ˜¯éšä¾¿å“ªä¸ª JS å¯¹è±¡ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status status = napi_check_object_type_tag(env, args[0], &amp;type_tag, &amp;matches);</span></span>
<span class="line"><span>if (status == napi_ok &amp;&amp; matches) {</span></span>
<span class="line"><span>    // ç¡®è®¤ args[0] å°±æ˜¯æˆ‘ä»¬é¢„æœŸçš„é‚£ç§ç½‘ç»œè¿æ¥å¯¹è±¡</span></span>
<span class="line"><span>    // å¯ä»¥å®‰å…¨åœ°è¿›è¡Œè¿›ä¸€æ­¥çš„æ“ä½œ</span></span>
<span class="line"><span>} else {</span></span>
<span class="line"><span>    // æŠ›å‡ºé”™è¯¯ï¼Œå‘Šè¯‰è°ƒç”¨è€…ä¼ å…¥çš„ä¸æ˜¯æœ‰æ•ˆçš„ç½‘ç»œè¿æ¥å¯¹è±¡</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·ï¼Œå³ä½¿ JavaScript ç”¨æˆ·å°è¯•ä¼ å…¥ä¸€ä¸ªæ™®é€šçš„ JavaScript å¯¹è±¡æ¥æ¬ºéª—ä½ çš„æ’ä»¶ï¼Œç”±äºæ²¡æœ‰åŒ¹é…çš„ç±»å‹æ ‡ç­¾ï¼Œä½ çš„æ’ä»¶èƒ½è¯†åˆ«å¹¶æ‹’ç»è¿™ç§é”™è¯¯çš„ä½¿ç”¨æ–¹å¼ï¼Œä¿æŠ¤äº†ä»£ç çš„å®‰å…¨æ€§ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>napi_type_tag_object</code> æ˜¯ Node.js N-API æä¾›çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œç”¨äºåŸç”Ÿæ¨¡å—å¼€å‘ä¸­æ›´å®‰å…¨åœ°å¤„ç†å’ŒéªŒè¯ JavaScript å¯¹è±¡ã€‚é€šè¿‡ç»™å¯¹è±¡æ·»åŠ å’Œæ ¡éªŒç±»å‹æ ‡ç­¾ï¼Œç¨‹åºå‘˜å¯ä»¥ç¡®ä¿ä»–ä»¬çš„åŸç”Ÿå‡½æ•°åªå¤„ç†é‚£äº›è¢«æ ‡è®°ä¸ºæ­£ç¡®ç±»å‹çš„å¯¹è±¡ï¼Œé¿å…äº†æ½œåœ¨çš„ç±»å‹é”™è¯¯å’Œå®‰å…¨é—®é¢˜ã€‚</p><h3 id="napi-check-object-type-tag" tabindex="-1"><a class="header-anchor" href="#napi-check-object-type-tag"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_check_object_type_tag" target="_blank" rel="noopener noreferrer">napi_check_object_type_tag</a></span></a></h3><p>å¥½çš„ï¼ŒNode.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºæœ¬åœ°æ’ä»¶çš„ APIï¼Œå®ƒå…è®¸ä½ åœ¨ Node.js ç¯å¢ƒä¸­ä½¿ç”¨ C æˆ– C++ ä»£ç ã€‚é€šè¿‡ N-APIï¼Œå¼€å‘è€…å¯ä»¥ç¼–å†™èƒ½å¤Ÿä¸ JavaScript ä»£ç äº’æ“ä½œçš„é«˜æ€§èƒ½æœ¬åœ°æ¨¡å—ã€‚</p><p><code>napi_check_object_type_tag</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå…¶ä½œç”¨æ˜¯å¸®åŠ©ä½ éªŒè¯ä¸€ä¸ª JavaScript å¯¹è±¡æ˜¯å¦æ‹¥æœ‰ä¸€ä¸ªç‰¹å®šçš„æ ‡è®°ï¼ˆtagï¼‰ã€‚åœ¨è¿™é‡Œï¼Œâ€œæ ‡è®°â€æ˜¯ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨ä»¥åŒºåˆ†ä¸åŒç±»å‹çš„å¯¹è±¡ï¼Œç¡®ä¿ä½ å¤„ç†çš„æ˜¯æ­£ç¡®ç±»å‹çš„å¯¹è±¡ã€‚</p><h3 id="å‡½æ•°åŸå‹-4" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°åŸå‹-4"><span>å‡½æ•°åŸå‹ï¼š</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_check_object_type_tag(napi_env env,</span></span>
<span class="line"><span>                                       napi_value object,</span></span>
<span class="line"><span>                                       const napi_type_tag* type_tag,</span></span>
<span class="line"><span>                                       bool* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>napi_env env</code>: å½“å‰çš„ N-API ç¯å¢ƒå¥æŸ„ã€‚</li><li><code>napi_value object</code>: å¾…æ£€æŸ¥çš„ JavaScript å¯¹è±¡ã€‚</li><li><code>const napi_type_tag* type_tag</code>: æŒ‡å‘ä½ ä¹‹å‰å®šä¹‰çš„ <code>napi_type_tag</code> ç»“æ„ä½“çš„æŒ‡é’ˆã€‚</li><li><code>bool* result</code>: å‡½æ•°æ‰§è¡Œåï¼Œé€šè¿‡è¿™ä¸ªæŒ‡é’ˆè¿”å›æ£€æŸ¥ç»“æœï¼ˆ<code>true</code> æˆ– <code>false</code>ï¼‰ã€‚</li></ul><h3 id="ä½¿ç”¨åœºæ™¯-3" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯-3"><span>ä½¿ç”¨åœºæ™¯ï¼š</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªæœ¬åœ°æ¨¡å—ï¼Œè¯¥æ¨¡å—æä¾›äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„æ–‡ä»¶è¯»å–å™¨ï¼Œä½ å¸Œæœ›ç¡®ä¿ç”¨æˆ·ä¼ é€’ç»™ä½ çš„å¯¹è±¡æ˜¯ä½ è®¤å¯çš„â€œæ–‡ä»¶è¯»å–å™¨å¯¹è±¡â€ã€‚</p><p>é¦–å…ˆï¼Œä½ ä¼šåœ¨ä½ çš„æ¨¡å—åˆå§‹åŒ–æ—¶ä¸ºä½ çš„â€œæ–‡ä»¶è¯»å–å™¨å¯¹è±¡â€å®šä¹‰ä¸€ä¸ª <code>napi_type_tag</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_type_tag file_reader_type_tag = {0};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>å½“åˆ›å»ºæ–°çš„â€œæ–‡ä»¶è¯»å–å™¨å¯¹è±¡â€æ—¶ï¼Œä½ ä¼šå°†è¿™ä¸ªæ ‡è®°å’Œå¯¹è±¡å…³è”èµ·æ¥ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value create_file_reader(napi_env env) {</span></span>
<span class="line"><span>    // åˆ›å»ºå¯¹è±¡...</span></span>
<span class="line"><span>    napi_value file_reader;</span></span>
<span class="line"><span>    // ...åˆ›å»ºå¯¹è±¡çš„ä»£ç ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å…³è”æ ‡è®°åˆ°å¯¹è±¡ä¸Š</span></span>
<span class="line"><span>    napi_status status = napi_type_tag_object(env, file_reader, &amp;file_reader_type_tag);</span></span>
<span class="line"><span>    // å¤„ç†çŠ¶æ€ä»£ç ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return file_reader;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹‹åï¼Œå½“è¦åœ¨å¦ä¸€ä¸ªå‡½æ•°ä¸­ä½¿ç”¨è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>napi_check_object_type_tag</code> æ¥éªŒè¯å¯¹è±¡æ˜¯å¦æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„â€œæ–‡ä»¶è¯»å–å™¨å¯¹è±¡â€ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status read_file(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_value this_arg;</span></span>
<span class="line"><span>    void* data;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–JavaScriptæä¾›çš„å‚æ•°</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, &amp;this_arg, &amp;data);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥ä¼ å…¥çš„å¯¹è±¡æ˜¯å¦æ˜¯æˆ‘ä»¬æœŸå¾…çš„æ–‡ä»¶è¯»å–å™¨å¯¹è±¡</span></span>
<span class="line"><span>    bool is_file_reader;</span></span>
<span class="line"><span>    napi_check_object_type_tag(env, args[0], &amp;file_reader_type_tag, &amp;is_file_reader);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (!is_file_reader) {</span></span>
<span class="line"><span>        // å¦‚æœä¸æ˜¯ï¼ŒæŠ›å‡ºé”™è¯¯æˆ–è¿›è¡Œå…¶ä»–å¤„ç†...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ˜¯æ–‡ä»¶è¯»å–å™¨å¯¹è±¡ï¼Œç»§ç»­æ‰§è¡Œè¯»å–æ–‡ä»¶çš„æ“ä½œ...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šå°±æ˜¯ <code>napi_check_object_type_tag</code> çš„åŸºæœ¬ç”¨æ³•ã€‚æ³¨æ„ï¼Œè¿™ç§ç±»å‹æ£€æŸ¥ä¸»è¦ç”¨äºå¢å¼ºæœ¬åœ°æ¨¡å—çš„å®‰å…¨æ€§å’Œå¥å£®æ€§ï¼Œä»¥ç¡®ä¿ API çš„ä½¿ç”¨è€…æŒ‰ç…§é¢„æœŸä¼ é€’äº†æ­£ç¡®ç±»å‹çš„å¯¹è±¡ã€‚</p><h3 id="napi-add-finalizer" tabindex="-1"><a class="header-anchor" href="#napi-add-finalizer"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_add_finalizer" target="_blank" rel="noopener noreferrer">napi_add_finalizer</a></span></a></h3><p>Node.js ä¸­çš„ <code>napi_add_finalizer</code> å‡½æ•°æ˜¯ä¸€ä¸ªå±äº N-API çš„ APIï¼Œç”¨æ¥æ·»åŠ ä¸ä¸€ä¸ª JavaScript å¯¹è±¡ç›¸å…³è”çš„æœ¬åœ°èµ„æºçš„ç»ˆç»“å™¨ï¼ˆæˆ–ç§°ä¸ºææ„å‡½æ•°ï¼‰ã€‚å½“è¿™ä¸ª JavaScript å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªç»ˆç»“å™¨å‡½æ•°æ¥æ¸…ç†ä¸ä¹‹å…³è”çš„æœ¬åœ°èµ„æºã€‚</p><p>N-API æ˜¯ Node.js æä¾›çš„ä¸€å¥— C APIï¼Œå®ƒå…è®¸åŸç”Ÿæ¨¡å—çš„ä½œè€…ç¼–å†™ç‹¬ç«‹äº Node.js ç‰ˆæœ¬çš„ä»£ç ã€‚ä½¿ç”¨ N-API åˆ›å»ºçš„åŸç”Ÿæ¨¡å—å¯ä»¥åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¹‹é—´æ— éœ€é‡æ–°ç¼–è¯‘å°±èƒ½è¿è¡Œï¼Œå¤§å¤§æé«˜äº†æ¨¡å—çš„å…¼å®¹æ€§å’Œç¨³å®šæ€§ã€‚</p><p>å…ˆè§£é‡Šå‡ ä¸ªæ¦‚å¿µï¼š</p><ol><li><strong>JavaScript å¯¹è±¡</strong>ï¼šåœ¨ JavaScript ä¸­åˆ›å»ºçš„å¯¹è±¡ï¼Œå¯ä»¥å­˜å‚¨æ•°æ®å’ŒåŠŸèƒ½ã€‚</li><li><strong>æœ¬åœ°èµ„æº</strong>ï¼šä½¿ç”¨ C æˆ– C++ ç­‰è¯­è¨€åˆ†é…çš„èµ„æºï¼Œå¦‚å†…å­˜ã€æ–‡ä»¶å¥æŸ„æˆ–å…¶ä»–ç³»ç»Ÿèµ„æºã€‚</li><li><strong>ç»ˆç»“å™¨ï¼ˆFinalizerï¼‰</strong>ï¼šä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°ï¼Œå®ƒè¢«è®¾è®¡ä¸ºåœ¨å¯¹è±¡ä¸å†éœ€è¦æ—¶æ‰§è¡Œï¼Œç”¨äºé‡Šæ”¾å¯¹è±¡æ‰€å ç”¨çš„èµ„æºã€‚</li></ol><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ <code>napi_add_finalizer</code> çš„ä½œç”¨ä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒã€‚</p><h3 id="ä½œç”¨" tabindex="-1"><a class="header-anchor" href="#ä½œç”¨"><span>ä½œç”¨:</span></a></h3><p><code>napi_add_finalizer</code> çš„ä¸»è¦ä½œç”¨æ˜¯ç¡®ä¿å½“ä¸€ä¸ªä¸åŸç”Ÿèµ„æºç›¸å…³è”çš„ JavaScript å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶ï¼Œè¿™äº›åŸç”Ÿèµ„æºä¹Ÿå¾—åˆ°é€‚å½“çš„æ¸…ç†å’Œé‡Šæ”¾ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ç­‰é—®é¢˜ã€‚</p><h3 id="ä½¿ç”¨åœºæ™¯ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯ç¤ºä¾‹"><span>ä½¿ç”¨åœºæ™¯ç¤ºä¾‹:</span></a></h3><h4 id="ç¤ºä¾‹-1-æ¸…ç†åŠ¨æ€åˆ†é…çš„å†…å­˜" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-1-æ¸…ç†åŠ¨æ€åˆ†é…çš„å†…å­˜"><span>ç¤ºä¾‹ 1: æ¸…ç†åŠ¨æ€åˆ†é…çš„å†…å­˜</span></a></h4><p>å‡è®¾ä½ åœ¨åˆ›å»ºä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—éœ€è¦åœ¨ C++ ä¸­åˆ†é…ä¸€å—åŠ¨æ€å†…å­˜ç»™ä¸€ä¸ª JavaScript å¯¹è±¡ä½¿ç”¨ã€‚</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void* dynamicMemory;</span></span>
<span class="line"><span>size_t memorySize = 1024; // å‡è®¾æˆ‘ä»¬è¦åˆ†é… 1024 å­—èŠ‚</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ†é…å†…å­˜</span></span>
<span class="line"><span>dynamicMemory = malloc(memorySize);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™é‡Œä½ å¯èƒ½ä¼šæŠŠ dynamicMemory ä¼ é€’åˆ° JavaScript å±‚é¢çš„æŸä¸ªå¯¹è±¡ä¸­</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸ºäº†ç¡®ä¿å½“ JavaScript å¯¹è±¡ä¸å†ä½¿ç”¨æ—¶ï¼Œè¿™å—å†…å­˜èƒ½å¤Ÿè¢«æ­£ç¡®åœ°é‡Šæ”¾ï¼Œä½ éœ€è¦å®šä¹‰ä¸€ä¸ªç»ˆç»“å™¨å‡½æ•°ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>void finalize_callback(napi_env env, void* finalize_data, void* finalize_hint) {</span></span>
<span class="line"><span>    // æ¸…ç†åŠ¨æ€åˆ†é…çš„å†…å­˜</span></span>
<span class="line"><span>    free(finalize_data);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åä½ ä¼šä½¿ç”¨ <code>napi_add_finalizer</code> å°†è¿™ä¸ªç»ˆç»“å™¨å‡½æ•°å…³è”åˆ°ç›¸åº”çš„ JavaScript å¯¹è±¡ä¸Šï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value jsObject;</span></span>
<span class="line"><span>// ... åˆ›å»ºæˆ–è·å–ä¸€ä¸ª jsObject ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ·»åŠ ç»ˆç»“å™¨</span></span>
<span class="line"><span>napi_add_finalizer(env, jsObject, dynamicMemory, finalize_callback, nullptr, nullptr);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ <code>jsObject</code> è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶æ—¶ï¼Œ<code>finalize_callback</code> å‡½æ•°å°†è¢«è‡ªåŠ¨è°ƒç”¨ï¼Œä»è€Œé‡Šæ”¾ä¹‹å‰åˆ†é…çš„å†…å­˜ã€‚</p><h4 id="ç¤ºä¾‹-2-æ¸…ç†æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-2-æ¸…ç†æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦"><span>ç¤ºä¾‹ 2: æ¸…ç†æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦</span></a></h4><p>å¦‚æœä½ çš„æ¨¡å—æ‰“å¼€äº†æ–‡ä»¶ï¼Œå¹¶ä¸”å°†æ–‡ä»¶æè¿°ç¬¦ä¿å­˜åœ¨äº†ä¸€ä¸ª JavaScript å¯¹è±¡ä¸­ï¼Œä½ åŒæ ·éœ€è¦ç¡®ä¿æ–‡ä»¶æœ€ç»ˆè¢«å…³é—­ã€‚</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>int fileDescriptor = open(&quot;somefile.txt&quot;, O_RDONLY);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ fileDescriptor è¢«ä¿å­˜åˆ°äº†æŸä¸ª jsObject ä¸­</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½ éœ€è¦å®šä¹‰ä¸€ä¸ªé€‚å½“çš„ç»ˆç»“å™¨æ¥å…³é—­è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>void finalize_file_descriptor(napi_env env, void* finalize_data, void* finalize_hint) {</span></span>
<span class="line"><span>    int fd = *(int*)finalize_data;</span></span>
<span class="line"><span>    close(fd); // å…³é—­æ–‡ä»¶æè¿°ç¬¦</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åï¼Œå¦‚åŒå†…å­˜çš„ä¾‹å­é‚£æ ·ï¼Œä½¿ç”¨ <code>napi_add_finalizer</code> å…³è”ç»ˆç»“å™¨ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// æ·»åŠ ç»ˆç»“å™¨</span></span>
<span class="line"><span>napi_add_finalizer(env, jsObject, &amp;fileDescriptor, finalize_file_descriptor, nullptr, nullptr);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·ï¼Œå½“åŒ…å«æ–‡ä»¶æè¿°ç¬¦çš„ JavaScript å¯¹è±¡è¢«å›æ”¶æ—¶ï¼Œ<code>finalize_file_descriptor</code> å°†è¢«è°ƒç”¨ï¼Œæ–‡ä»¶å°†è¢«å…³é—­ï¼Œé¿å…äº†æ–‡ä»¶æè¿°ç¬¦æ³„æ¼ã€‚</p><h3 id="æ³¨æ„äº‹é¡¹-3" tabindex="-1"><a class="header-anchor" href="#æ³¨æ„äº‹é¡¹-3"><span>æ³¨æ„äº‹é¡¹:</span></a></h3><ul><li>å½“ä½¿ç”¨ <code>napi_add_finalizer</code> æ—¶ï¼Œä½ éœ€è¦ç¡®ä¿æ­£ç¡®åœ°ç®¡ç†æœ¬åœ°èµ„æºçš„ç”Ÿå‘½å‘¨æœŸï¼Œç¡®ä¿ä¸ä¼šåœ¨èµ„æºè¢«æ¸…ç†åå°è¯•è®¿é—®å®ƒä»¬ã€‚</li><li>ä½¿ç”¨ N-API éœ€è¦å¯¹ C/C++ å’Œ Node.js çš„å†…éƒ¨æœºåˆ¶æœ‰ä¸€å®šçš„ç†è§£ã€‚</li></ul><p>å¸Œæœ›è¿™ä¸ªè§£é‡Šæœ‰åŠ©äºä½ ç†è§£ <code>napi_add_finalizer</code> åœ¨ Node.js ä¸­çš„ä½œç”¨å’Œä½¿ç”¨æ–¹å¼ã€‚</p><h4 id="node-api-post-finalizer" tabindex="-1"><a class="header-anchor" href="#node-api-post-finalizer"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#node_api_post_finalizer" target="_blank" rel="noopener noreferrer">node_api_post_finalizer</a></span></a></h4><p><code>node_api_post_finalizer</code> æ˜¯ Node.js ä¸­çš„ N-APIï¼ˆåŸç”Ÿ APIï¼‰åŠŸèƒ½ï¼Œå®ƒå…è®¸å¼€å‘è€…åœ¨åˆ›å»ºå’Œä½¿ç”¨åŸç”Ÿæ‰©å±•æ—¶ï¼Œç¡®ä¿èµ„æºèƒ½å¤Ÿè¢«å¦¥å–„æ¸…ç†ã€‚ä¸ºäº†è§£é‡Šè¿™ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸€äº›èƒŒæ™¯çŸ¥è¯†ã€‚</p><p>åœ¨ Node.js ä¸­ï¼Œä½ å¯ä»¥ç¼–å†™ JavaScript æ¥æ‰§è¡Œå„ç§ä»»åŠ¡ï¼Œä½†æœ‰æ—¶å€™ä½ å¯èƒ½éœ€è¦æ›´ç›´æ¥åœ°è®¿é—®åº•å±‚ç³»ç»Ÿèµ„æºæˆ–è€…è¿›è¡Œæ›´é«˜æ€§èƒ½çš„æ“ä½œã€‚è¿™æ—¶ï¼Œä½ å°±å¯ä»¥é€šè¿‡ç¼–å†™ C æˆ– C++ çš„ä»£ç æ¥åˆ›å»ºæ‰€è°“çš„â€œåŸç”Ÿæ¨¡å—â€ï¼Œè¿™æ ·å°±èƒ½åœ¨ Node.js é¡¹ç›®ä¸­ä½¿ç”¨è¿™äº›åº•å±‚èƒ½åŠ›ã€‚</p><p>å½“ä½¿ç”¨è¿™äº›åŸç”Ÿæ¨¡å—æ—¶ï¼Œç»å¸¸ä¼šåœ¨åŸç”Ÿä»£ç ä¸­åˆ†é…ä¸€äº›ç³»ç»Ÿèµ„æºï¼Œæ¯”å¦‚å†…å­˜ã€æ–‡ä»¶æè¿°ç¬¦æˆ–ç½‘ç»œå¥—æ¥å­—ç­‰ã€‚æ­£ç¡®åœ°ç®¡ç†è¿™äº›èµ„æºéå¸¸å…³é”®ï¼Œå› ä¸ºå¦‚æœä¸é€‚å½“åœ°é‡Šæ”¾èµ„æºï¼Œå°±å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼æˆ–å…¶ä»–é—®é¢˜ï¼Œå½±å“åº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚</p><p>è¿™é‡Œçš„ <code>node_api_post_finalizer</code> å°±æ˜¯ä¸€ä¸ªå¸®åŠ©å‡½æ•°ï¼Œå®ƒä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿæ³¨å†Œä¸€ä¸ªâ€œç»ˆç»“å™¨â€ï¼ˆfinalizerï¼‰ï¼Œä¹Ÿå°±æ˜¯å½“ä¸€ä¸ªåŸç”Ÿå¯¹è±¡å³å°†è¢«åƒåœ¾å›æ”¶æ—¶å°†è°ƒç”¨çš„å‡½æ•°ã€‚è¿™ä¸ªç»ˆç»“å™¨è´Ÿè´£æ¸…ç†ä¸åŸç”Ÿå¯¹è±¡ç›¸å…³è”çš„èµ„æºã€‚</p><p>ä¸‹é¢æˆ‘ä¸¾ä¸€ä¸ªå®é™…ä¾‹å­æ¥è¯´æ˜å¦‚ä½•ä½¿ç”¨ <code>node_api_post_finalizer</code>ï¼š</p><p>å‡è®¾ä½ åœ¨åˆ›å»ºä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œè¯¥æ¨¡å—éœ€è¦æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶åœ¨æ“ä½œå®Œæ¯•åå…³é—­æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä½ ä¼šåœ¨åŸç”Ÿä»£ç ä¸­åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºæ–‡ä»¶çš„å¯¹è±¡ï¼Œå¹¶ä¸”å¸Œæœ›åœ¨è¿™ä¸ªå¯¹è±¡ä¸å†éœ€è¦æ—¶è‡ªåŠ¨å…³é—­æ–‡ä»¶ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å‡è®¾è¿™æ˜¯æˆ‘ä»¬çš„åŸç”Ÿå¯¹è±¡ç»“æ„ä½“</span></span>
<span class="line"><span>typedef struct {</span></span>
<span class="line"><span>  FILE* file;</span></span>
<span class="line"><span>} MyFileHandle;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯æˆ‘ä»¬çš„ç»ˆç»“å™¨å‡½æ•°</span></span>
<span class="line"><span>void Finalizer(napi_env env, void* finalize_data, void* finalize_hint) {</span></span>
<span class="line"><span>  MyFileHandle* handle = (MyFileHandle*)finalize_data;</span></span>
<span class="line"><span>  fclose(handle-&gt;file); // å…³é—­æ–‡ä»¶</span></span>
<span class="line"><span>  free(handle); // é‡Šæ”¾åˆ†é…çš„å†…å­˜</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ›å»ºä¸€ä¸ªæ–°çš„ MyFileHandle å¯¹è±¡å¹¶ä¸ JavaScript å¯¹è±¡å…³è”</span></span>
<span class="line"><span>napi_value CreateMyFileHandle(napi_env env) {</span></span>
<span class="line"><span>  napi_value js_object;</span></span>
<span class="line"><span>  MyFileHandle* my_file_handle = (MyFileHandle*)malloc(sizeof(MyFileHandle));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ‰“å¼€æ–‡ä»¶ï¼Œåªæ˜¯ä¸¾ä¾‹ï¼Œå…·ä½“å‚æ•°éœ€æ ¹æ®å®é™…æƒ…å†µå¡«å†™</span></span>
<span class="line"><span>  my_file_handle-&gt;file = fopen(&quot;example.txt&quot;, &quot;r&quot;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºå¯¹è±¡</span></span>
<span class="line"><span>  napi_create_object(env, &amp;js_object);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å°†æˆ‘çš„æ–‡ä»¶å¤„ç†å¯¹è±¡ä¸ JavaScript å¯¹è±¡å…³è”ï¼Œå¹¶æŒ‡å®šç»ˆç»“å™¨</span></span>
<span class="line"><span>  napi_wrap(env,</span></span>
<span class="line"><span>            js_object,</span></span>
<span class="line"><span>            (void*)my_file_handle,</span></span>
<span class="line"><span>            Finalizer,</span></span>
<span class="line"><span>            NULL, // å¯é€‰çš„æç¤ºæ•°æ®</span></span>
<span class="line"><span>            NULL); // ä¸éœ€è¦æ­¤å¤„çš„è¿”å›å€¼</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return js_object;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>node_api_post_finalizer</code>ï¼ˆåœ¨ç¤ºä¾‹ä¸­è¡¨ç°ä¸º <code>napi_wrap</code> å‡½æ•°çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚è¿™ä¸ªå‡½æ•°ç¡®ä¿å½“ JavaScript å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶ï¼Œæˆ‘ä»¬çš„ç»ˆç»“å™¨å‡½æ•° <code>Finalizer</code> å°†è¢«è°ƒç”¨ï¼Œä»è€Œå…³é—­æ–‡ä»¶å¹¶é‡Šæ”¾åˆ†é…çš„å†…å­˜ï¼Œé¿å…èµ„æºæ³„æ¼ã€‚</p><p>è¯·æ³¨æ„ï¼Œæœ¬ä¾‹ä¸­æ²¡æœ‰ç›´æ¥ä½¿ç”¨ <code>node_api_post_finalizer</code> å‡½æ•°ï¼Œå› ä¸ºé€šå¸¸å®ƒæ˜¯é€šè¿‡ <code>napi_wrap</code> éšå¼è°ƒç”¨çš„ã€‚<code>napi_wrap</code> ç”¨äºå°†åŸç”Ÿèµ„æºåŒ…è£…åˆ° JavaScript å¯¹è±¡ä¸­ï¼ŒåŒæ—¶æ³¨å†Œä¸€ä¸ªç»ˆç»“å™¨ä»¥ä¾¿èµ„æºå¯ä»¥åœ¨ä¸éœ€è¦æ—¶é‡Šæ”¾ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>node_api_post_finalizer</code> å®é™…ä¸Šæ˜¯ Node.js æ–‡æ¡£ä¸­çš„ä¸€ä¸ªå‘½åé”™è¯¯æˆ–è€…è¯´æ˜¯ç¬”è¯¯ï¼Œæ­£ç¡®çš„åç§°åº”è¯¥æ˜¯ <code>napi_add_finalizer</code>ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´æ··æ·†ï¼Œæ‰€ä»¥å¼€å‘è€…åº”è¯¥æŸ¥æ‰¾æœ€æ–°çš„å®˜æ–¹æ–‡æ¡£æ¥ç¡®è®¤æ­£ç¡®çš„ API åç§°å’Œä½¿ç”¨æ–¹æ³•ã€‚</p><h2 id="simple-asynchronous-operations" tabindex="-1"><a class="header-anchor" href="#simple-asynchronous-operations"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#simple-asynchronous-operations" target="_blank" rel="noopener noreferrer">Simple asynchronous operations</a></span></a></h2><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶ï¼ˆä¹Ÿå°±æ˜¯ä½¿ç”¨ C æˆ– C++ç¼–å†™çš„æ‰©å±•æ¨¡å—ï¼‰çš„ APIã€‚åœ¨ Node.js v21.7.1 çš„æ–‡æ¡£ä¸­ï¼Œ&quot;Simple asynchronous operations&quot;éƒ¨åˆ†è§£é‡Šäº†å¦‚ä½•ä½¿ç”¨ N-API æ‰§è¡Œå¼‚æ­¥æ“ä½œã€‚</p><p>å¼‚æ­¥æ“ä½œæ˜¯æŒ‡ç¨‹åºå¯ä»¥å¯åŠ¨ä¸€ä¸ªä»»åŠ¡ï¼Œåœ¨ç­‰å¾…è¿™ä¸ªä»»åŠ¡å®Œæˆçš„åŒæ—¶ç»§ç»­æ‰§è¡Œå…¶ä»–ä»£ç ï¼Œè€Œä¸æ˜¯åœä¸‹æ¥ç­‰å¾…ç»“æœã€‚è¿™å¯¹äºä¸é˜»å¡ Node.js ä¸»çº¿ç¨‹ç‰¹åˆ«é‡è¦ï¼Œå› ä¸º Node.js æ˜¯å•çº¿ç¨‹çš„ï¼Œé•¿æ—¶é—´é˜»å¡ä¼šå¯¼è‡´æ•´ä¸ªåº”ç”¨ç¨‹åºæ— æ³•å“åº”å…¶ä»–ä»»åŠ¡ã€‚</p><p>åœ¨ N-API ä¸­å®ç°ç®€å•çš„å¼‚æ­¥æ“ä½œä¸€èˆ¬éœ€è¦ä»¥ä¸‹å‡ æ­¥ï¼š</p><ol><li><p><strong>å®šä¹‰å·¥ä½œç»“æ„</strong>: é¦–å…ˆï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ª<code>napi_work</code>çš„å®ä¾‹ï¼Œè¿™ä»£è¡¨äº†ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ã€‚</p></li><li><p><strong>åˆ›å»ºå¼‚æ­¥å·¥ä½œ</strong>: ä½¿ç”¨<code>napi_create_async_work</code>å‡½æ•°åˆ›å»ºå¼‚æ­¥å·¥ä½œï¼Œå…¶ä¸­ä½ å°†æŒ‡å®šå®Œæˆè¿™é¡¹ä»»åŠ¡æ—¶è¦è°ƒç”¨çš„å‡½æ•°å’Œé”€æ¯èµ„æºæ—¶è¦è°ƒç”¨çš„å‡½æ•°ã€‚</p></li><li><p><strong>å°†å·¥ä½œæ’é˜Ÿ</strong>: ä½¿ç”¨<code>napi_queue_async_work</code>å‡½æ•°å°†å®šä¹‰çš„å·¥ä½œæ·»åŠ åˆ°äº‹ä»¶å¾ªç¯ä¸­ï¼Œä½¿å…¶åœ¨æœªæ¥æŸä¸ªæ—¶é—´ç‚¹æ‰§è¡Œã€‚</p></li><li><p><strong>å·¥ä½œæ‰§è¡Œ</strong>: Node.js ä¼šåœ¨åå°çº¿ç¨‹æ± ä¸­æ‰§è¡Œæ­¤å·¥ä½œï¼Œè€Œä¸ä¼šå½±å“ä¸»çº¿ç¨‹çš„æ‰§è¡Œã€‚</p></li><li><p><strong>å·¥ä½œå®Œæˆ</strong>: ä¸€æ—¦åå°ä»»åŠ¡å®Œæˆï¼Œç›¸å…³è”çš„å®Œæˆå›è°ƒå‡½æ•°å°†è¢«åŠ å…¥åˆ°äº‹ä»¶å¾ªç¯ä¸­ï¼Œå¹¶åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚</p></li><li><p><strong>é”€æ¯å·¥ä½œ</strong>: å®Œæˆè¯¥å·¥ä½œåï¼Œä½ éœ€è¦ä½¿ç”¨<code>napi_delete_async_work</code>æ¸…ç†åˆ†é…çš„èµ„æºã€‚</p></li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä¸¾ä¸€ä¸ªå®é™…çš„ä¾‹å­ã€‚å‡è®¾ä½ åœ¨å¼€å‘ä¸€ä¸ª Node.js çš„æœ¬åœ°æ’ä»¶ï¼Œè¯¥æ’ä»¶éœ€è¦è¿›è¡Œæ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œï¼Œä¾‹å¦‚è¯»å–ä¸€ä¸ªå¤§æ–‡ä»¶ã€‚æ–‡ä»¶è¯»å–æ˜¯ä¸€ä¸ªè€—æ—¶çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥ä½ å¸Œæœ›ä»¥å¼‚æ­¥æ–¹å¼æ¥å¤„ç†å®ƒï¼Œä»¥å…é˜»å¡ä¸»çº¿ç¨‹ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¼ªä»£ç  - æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡çš„å‡½æ•°</span></span>
<span class="line"><span>void Execute(napi_env env, void* data) {</span></span>
<span class="line"><span>    // è¿™é‡Œä½ å¯ä»¥æ‰§è¡Œç±»ä¼¼è¯»å–å¤§æ–‡ä»¶çš„æ“ä½œ</span></span>
<span class="line"><span>    // æ³¨æ„è¿™ä¸ªå‡½æ•°æ˜¯åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œçš„ï¼Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¼ªä»£ç  - å¼‚æ­¥ä»»åŠ¡å®Œæˆåçš„å›è°ƒå‡½æ•°</span></span>
<span class="line"><span>void Complete(napi_env env, napi_status status, void* data) {</span></span>
<span class="line"><span>    // è¿™é‡Œä½ å¯ä»¥å¤„ç†æ‰§è¡Œç»“æœï¼Œæ¯”å¦‚å°†æ–‡ä»¶å†…å®¹ä¼ ç»™JavaScript</span></span>
<span class="line"><span>    // è¿™ä¸ªå‡½æ•°ä¼šåœ¨ä¸»çº¿ç¨‹ä¸­è¢«è°ƒç”¨</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¼ªä»£ç  - å¯åŠ¨å¼‚æ­¥ä»»åŠ¡çš„JSç»‘å®šå‡½æ•°</span></span>
<span class="line"><span>napi_value StartAsyncTask(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value work_name;</span></span>
<span class="line"><span>    napi_create_string_utf8(env, &quot;workName&quot;, NAPI_AUTO_LENGTH, &amp;work_name);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_async_work work;</span></span>
<span class="line"><span>    napi_create_async_work(env, NULL, work_name, Execute, Complete, NULL, &amp;work);</span></span>
<span class="line"><span>    napi_queue_async_work(env, work);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return NULL;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨åŠ è½½æ’ä»¶æ—¶è°ƒç”¨</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value asyncTaskFunction;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, StartAsyncTask, NULL, &amp;asyncTaskFunction);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;startAsyncTask&quot;, asyncTaskFunction);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<code>StartAsyncTask</code>å‡½æ•°ï¼Œå®ƒä¼šå¯åŠ¨ä¸€ä¸ªå¼‚æ­¥æ“ä½œæ¥æ‰§è¡Œè€—æ—¶çš„ä»»åŠ¡ï¼ˆä¾‹å¦‚è¯»å–å¤§æ–‡ä»¶ï¼‰ã€‚å½“ä»»åŠ¡å¼€å§‹æ—¶ï¼Œä¼šç«‹å³è¿”å›ï¼Œä»è€Œä¸é˜»å¡ Node.js çš„ä¸»çº¿ç¨‹ã€‚å®Œæˆåï¼Œä¼šè°ƒç”¨<code>Complete</code>å‡½æ•°æ¥å¤„ç†ç»“æœï¼Œæ¯”å¦‚å°†è¯»å–çš„æ•°æ®é€šè¿‡äº‹ä»¶æˆ–å›è°ƒä¼ é€’ç»™ JavaScript å±‚é¢çš„ä»£ç ã€‚</p><p>è¿™æ ·ï¼Œä½ å°±å¯ä»¥åœ¨ Node.js ä¸­åˆ©ç”¨ N-API è¿›è¡Œé«˜æ•ˆçš„å¼‚æ­¥æ“ä½œï¼Œè€Œä¸ä¼šå½±å“åº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œå“åº”æ€§ã€‚</p><h3 id="napi-create-async-work" tabindex="-1"><a class="header-anchor" href="#napi-create-async-work"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_async_work" target="_blank" rel="noopener noreferrer">napi_create_async_work</a></span></a></h3><p>å½“ä½ ä½¿ç”¨ Node.js ç¼–ç¨‹æ—¶ï¼Œæœ‰æ—¶å€™ä½ ä¼šéœ€è¦æ‰§è¡Œä¸€äº›è€—æ—¶çš„æ“ä½œï¼Œæ¯”å¦‚è®¿é—®æ–‡ä»¶ç³»ç»Ÿã€è¿›è¡Œç½‘ç»œé€šä¿¡æˆ–è€…åšä¸€äº›å¤æ‚çš„è®¡ç®—ã€‚å¦‚æœè¿™äº›æ“ä½œåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå®ƒä»¬ä¼šé˜»å¡å…¶ä»–ä»£ç è¿è¡Œï¼Œå› ä¸º JavaScript æ˜¯å•çº¿ç¨‹çš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒNode.js æä¾›äº†å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ã€‚</p><p>å…¶ä¸­ä¸€ä¸ªå·¥å…·å°±æ˜¯ N-API ä¸­çš„<code>napi_create_async_work</code>å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°å…è®¸ä½ åˆ›å»ºä¸€ä¸ªå¯ä»¥åœ¨åå°æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¿™æ ·ä½ çš„ç¨‹åºå°±å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œè€Œä¸å¿…ç­‰å¾…è¿™ä¸ªè€—æ—¶ä»»åŠ¡å®Œæˆã€‚</p><h3 id="å¦‚ä½•ä½¿ç”¨-napi-create-async-work" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ä½¿ç”¨-napi-create-async-work"><span>å¦‚ä½•ä½¿ç”¨ <code>napi_create_async_work</code></span></a></h3><p>è¦ä½¿ç”¨<code>napi_create_async_work</code>ï¼Œä½ éœ€è¦å‡†å¤‡ä»¥ä¸‹å‡ ä¸ªä¸œè¥¿ï¼š</p><ol><li><strong>Execute Function</strong>: è¿™ä¸ªå‡½æ•°åŒ…å«äº†ä½ æƒ³è¦å¼‚æ­¥æ‰§è¡Œçš„ä»£ç ã€‚</li><li><strong>Complete Function</strong>: å½“å¼‚æ­¥æ‰§è¡Œå®Œæˆåï¼Œè¿™ä¸ªå‡½æ•°å°†è¢«è°ƒç”¨ã€‚</li><li><strong>Data</strong>: ä¸€ä¸ªæŒ‡å‘ä½ çš„æ•°æ®çš„æŒ‡é’ˆï¼Œè¿™äº›æ•°æ®å°†è¢«ä¼ é€’ç»™ Execute Function å’Œ Complete Functionã€‚</li><li><strong>Async Work</strong>: ä¸€ä¸ªå¼•ç”¨ï¼Œä»£è¡¨äº†è¿™ä¸ªå¼‚æ­¥ä»»åŠ¡ã€‚</li></ol><p>åˆ›å»ºå¼‚æ­¥ä»»åŠ¡å¤§è‡´çš„ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ‰§è¡Œå‡½æ•°ï¼Œå°†åœ¨åå°çº¿ç¨‹ä¸Šè¿è¡Œ</span></span>
<span class="line"><span>void Execute(napi_env env, void* data) {</span></span>
<span class="line"><span>    // ...è€—æ—¶çš„æ“ä½œ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å®Œæˆå‡½æ•°ï¼Œå½“ä»»åŠ¡å®Œæˆæ—¶ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸Šè¿è¡Œ</span></span>
<span class="line"><span>void Complete(napi_env env, napi_status status, void* data) {</span></span>
<span class="line"><span>    // ...æ¸…ç†å·¥ä½œæˆ–è€…å›è°ƒJavaScriptä»£ç ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ›å»ºå¼‚æ­¥å·¥ä½œ</span></span>
<span class="line"><span>napi_value CreateAsyncWork(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value work_name;</span></span>
<span class="line"><span>    napi_create_string_utf8(env, &quot;MyWork&quot;, NAPI_AUTO_LENGTH, &amp;work_name);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_async_work work;</span></span>
<span class="line"><span>    napi_create_async_work(env, NULL, work_name,</span></span>
<span class="line"><span>                           Execute, Complete, NULL, &amp;work);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†å¼‚æ­¥å·¥ä½œé˜Ÿåˆ—åŒ–</span></span>
<span class="line"><span>    napi_queue_async_work(env, work);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return NULL;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æ˜¯ä¸€ä¸ªæ›´å®é™…çš„ä¾‹å­ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js æ‰©å±•ï¼Œéœ€è¦åœ¨ C++å±‚é¢è¯»å–ä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œå¹¶ä¸”å¸Œæœ›è¿™ä¸ªæ“ä½œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å‡è®¾ä½ å·²ç»åŒ…å«äº†æ‰€éœ€çš„å¤´æ–‡ä»¶å’Œè®¾ç½®å¥½äº†ç¯å¢ƒ</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä½ å¯èƒ½å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“æ¥ä¿å­˜ä½ çš„æ•°æ®</span></span>
<span class="line"><span>typedef struct {</span></span>
<span class="line"><span>    char* filename;</span></span>
<span class="line"><span>    char* fileContents;</span></span>
<span class="line"><span>} FileReadData;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void Execute(napi_env env, void* data) {</span></span>
<span class="line"><span>    FileReadData* readData = (FileReadData*)data;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿™é‡Œä¼ªä»£ç è¡¨ç¤ºæ‰“å¼€æ–‡ä»¶å¹¶è¯»å–å†…å®¹</span></span>
<span class="line"><span>    readData-&gt;fileContents = ReadFile(readData-&gt;filename);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void Complete(napi_env env, napi_status status, void* data) {</span></span>
<span class="line"><span>    FileReadData* readData = (FileReadData*)data;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ä¼ªä»£ç è¡¨ç¤ºå°†è¯»å–åˆ°çš„å†…å®¹ä¼ é€’ç»™JavaScriptçš„å›è°ƒå‡½æ•°</span></span>
<span class="line"><span>    PassToJSCallback(env, readData-&gt;fileContents);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ¸…ç†å·¥ä½œ</span></span>
<span class="line"><span>    free(readData-&gt;fileContents);</span></span>
<span class="line"><span>    free(readData);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°ä¼šè¢«JavaScriptä»£ç è°ƒç”¨ä»¥å¯åŠ¨å¼‚æ­¥æ–‡ä»¶è¯»å–</span></span>
<span class="line"><span>napi_value StartAsyncFileRead(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–æ–‡ä»¶åï¼ˆJavaScriptå­—ç¬¦ä¸²å‚æ•°ï¼‰</span></span>
<span class="line"><span>    size_t filename_length;</span></span>
<span class="line"><span>    napi_get_value_string_utf8(env, args[0], NULL, 0, &amp;filename_length);</span></span>
<span class="line"><span>    char* filename = malloc(filename_length + 1);</span></span>
<span class="line"><span>    napi_get_value_string_utf8(env, args[0], filename, filename_length + 1, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è®¾ç½®æˆ‘ä»¬çš„æ•°æ®</span></span>
<span class="line"><span>    FileReadData* readData = malloc(sizeof(FileReadData));</span></span>
<span class="line"><span>    readData-&gt;filename = filename;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºå¼‚æ­¥å·¥ä½œ</span></span>
<span class="line"><span>    napi_value async_resource_name;</span></span>
<span class="line"><span>    napi_create_string_utf8(env, &quot;asyncFileRead&quot;, NAPI_AUTO_LENGTH, &amp;async_resource_name);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_async_work work;</span></span>
<span class="line"><span>    napi_create_async_work(env, NULL, async_resource_name,</span></span>
<span class="line"><span>                           Execute, Complete, readData, &amp;work);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // é˜Ÿåˆ—åŒ–å¼‚æ­¥å·¥ä½œ</span></span>
<span class="line"><span>    napi_queue_async_work(env, work);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return NULL;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å½“ä½ åŠ è½½è¿™ä¸ªæ‰©å±•æ¨¡å—æ—¶ï¼Œä½ éœ€è¦æ³¨å†ŒStartAsyncFileReadå‡½æ•°</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value asyncFileReadFunction;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, StartAsyncFileRead, NULL, &amp;asyncFileReadFunction);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;startAsyncFileRead&quot;, asyncFileReadFunction);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒJavaScript ä»£ç å¯ä»¥è°ƒç”¨<code>startAsyncFileRead</code>å‡½æ•°ï¼Œå¹¶ä¼ é€’ä¸€ä¸ªæ–‡ä»¶åï¼Œç„¶åè¿™ä¸ªæ¨¡å—å°†å¼€å§‹å¼‚æ­¥åœ°è¯»å–æ–‡ä»¶å†…å®¹ï¼Œè€Œä¸ä¼šé˜»å¡å…¶ä»– JavaScript ä»£ç çš„æ‰§è¡Œã€‚æ–‡ä»¶è¯»å–å®Œæ¯•åï¼Œä¼šè°ƒç”¨ Complete å‡½æ•°ï¼Œç„¶åä½ å¯ä»¥åœ¨è¿™é‡Œå¤„ç†è¯»å–åˆ°çš„æ•°æ®ï¼Œä¾‹å¦‚ï¼Œè§¦å‘ä¸€ä¸ª JavaScript äº‹ä»¶ï¼Œæˆ–è€…è°ƒç”¨ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚</p><p>é€šè¿‡ä½¿ç”¨<code>napi_create_async_work</code>ï¼Œä½ å¯ä»¥åˆ›å»ºå¼ºå¤§çš„ Node.js æ‰©å±•ï¼Œèƒ½å¤Ÿæ‰§è¡Œå¤æ‚çš„ã€è€—æ—¶çš„ä»»åŠ¡ï¼ŒåŒæ—¶ä¿æŒåº”ç”¨ç¨‹åºçš„å“åº”æ€§ã€‚</p><h3 id="napi-delete-async-work" tabindex="-1"><a class="header-anchor" href="#napi-delete-async-work"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_delete_async_work" target="_blank" rel="noopener noreferrer">napi_delete_async_work</a></span></a></h3><p>åœ¨ Node.js ä¸­ï¼ŒN-API æ˜¯ä¸€ä¸ªä¸ JavaScript è¿è¡Œæ—¶å’Œå¼•æ“æ— å…³çš„ API å±‚ï¼Œå®ƒå…è®¸ä½ åˆ›å»ºåŸç”Ÿæ’ä»¶ã€‚ä½¿ç”¨ N-APIï¼Œä½ å¯ä»¥ç¼–å†™ç”¨ C æˆ– C++ ç¼–å†™çš„ä»£ç ï¼Œè¿™äº›ä»£ç å¯ä»¥ç›´æ¥ä¸ Node.js äº¤äº’ã€‚</p><p><code>napi_delete_async_work</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒç”¨äºåˆ é™¤ä»¥å‰åˆ›å»ºçš„å¼‚æ­¥å·¥ä½œã€‚åœ¨è§£é‡Š <code>napi_delete_async_work</code> ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š</p><ol><li><p><strong>å¼‚æ­¥ç¼–ç¨‹</strong>ï¼šåœ¨ Node.js ä¸­ï¼Œå¾ˆå¤šæ“ä½œéƒ½æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œæ¯”å¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œè¯·æ±‚ç­‰ï¼Œè¿™æ„å‘³ç€å®ƒä»¬ä¸ä¼šç«‹å³å®Œæˆï¼Œè€Œæ˜¯åœ¨æœªæ¥çš„æŸä¸ªæ—¶é—´ç‚¹å®Œæˆã€‚è¿™æ ·å¯ä»¥é¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼Œæé«˜ç¨‹åºçš„æ•ˆç‡ã€‚</p></li><li><p><strong>å¼‚æ­¥å·¥ä½œ</strong>ï¼šåœ¨ä½¿ç”¨ N-API åˆ›å»ºåŸç”Ÿæ’ä»¶æ—¶ï¼Œä½ å¯èƒ½éœ€è¦æ‰§è¡Œä¸€äº›è€—æ—¶çš„ä»»åŠ¡ï¼Œæ¯”å¦‚è®¿é—®æ•°æ®åº“æˆ–è€…å¤§é‡æ•°æ®çš„å¤„ç†ã€‚è¿™äº›ä»»åŠ¡é€šå¸¸åœ¨åå°çš„çº¿ç¨‹ä¸Šå¼‚æ­¥æ‰§è¡Œï¼Œä»¥é¿å…é˜»å¡ Node.js çš„ä¸»äº‹ä»¶å¾ªç¯ã€‚</p></li><li><p><strong>napi_create_async_work</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºå¼‚æ­¥å·¥ä½œçš„å‡½æ•°ã€‚å½“ä½ æœ‰ä¸€ä¸ªè€—æ—¶çš„ä»»åŠ¡æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‡½æ•°å°†ä»»åŠ¡æ”¾åˆ°åå°çº¿ç¨‹å»æ‰§è¡Œï¼ŒåŒæ—¶ä½ éœ€è¦ä¼ é€’ä¸€äº›å›è°ƒå‡½æ•°ï¼Œå®ƒä»¬å®šä¹‰äº†ä»»åŠ¡å¼€å§‹ã€æ‰§è¡Œå’Œå®Œæˆæ—¶åº”è¯¥åšä»€ä¹ˆã€‚</p></li></ol><p>ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹ <code>napi_delete_async_work</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_delete_async_work(napi_env env,</span></span>
<span class="line"><span>                                   napi_async_work work);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>napi_delete_async_work</code> çš„ä½œç”¨æ˜¯åˆ é™¤é€šè¿‡ <code>napi_create_async_work</code> åˆ›å»ºå‡ºæ¥çš„å¼‚æ­¥å·¥ä½œå¯¹è±¡ã€‚å½“ä½ çš„å¼‚æ­¥ä»»åŠ¡å®Œæˆå¹¶ä¸”ç›¸å…³çš„å›è°ƒè¢«è°ƒç”¨ä¹‹åï¼Œä½ åº”è¯¥ä½¿ç”¨ <code>napi_delete_async_work</code> æ¥æ¸…ç†å†…å­˜ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚</p><p>å‚æ•°è¯´æ˜ï¼š</p><ul><li><code>env</code>ï¼šè¿™æ˜¯ä»£è¡¨ N-API ç¯å¢ƒçš„å¥æŸ„ï¼Œæ¯ä¸ª N-API å‡½æ•°éƒ½ä¼šç”¨åˆ°å®ƒï¼Œå®ƒè´¯ç©¿æ•´ä¸ª N-API ä½¿ç”¨å‘¨æœŸã€‚</li><li><code>work</code>ï¼šè¿™æ˜¯ä½ å¸Œæœ›åˆ é™¤çš„å¼‚æ­¥å·¥ä½œå¯¹è±¡çš„å¥æŸ„ï¼Œå®ƒæ˜¯ä¹‹å‰é€šè¿‡ <code>napi_create_async_work</code> åˆ›å»ºå‡ºæ¥çš„ã€‚</li></ul><p>ä¾‹å­ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå‡½æ•°éœ€è¦åšå¤§é‡çš„è®¡ç®—ï¼Œä½ æƒ³è¦å°†è¿™éƒ¨åˆ†å·¥ä½œç§»åˆ°åå°çº¿ç¨‹å»æ‰§è¡Œï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ç¤ºä¾‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å£°æ˜ä¸€ä¸ªæ‰§è¡Œå¤§é‡è®¡ç®—çš„å‡½æ•°</span></span>
<span class="line"><span>void ExecuteWork(napi_env env, void* data) {</span></span>
<span class="line"><span>    // ... åœ¨è¿™é‡Œæ‰§è¡Œè®¡ç®— ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å£°æ˜ä¸€ä¸ªå½“å·¥ä½œå®Œæˆæ—¶ä¼šè¢«è°ƒç”¨çš„å‡½æ•°</span></span>
<span class="line"><span>void WorkComplete(napi_env env, napi_status status, void* data) {</span></span>
<span class="line"><span>    // è·å–å¼‚æ­¥å·¥ä½œå¥æŸ„</span></span>
<span class="line"><span>    napi_async_work work = (napi_async_work)data;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ é™¤å¼‚æ­¥å·¥ä½œå¯¹è±¡ä»¥é‡Šæ”¾èµ„æº</span></span>
<span class="line"><span>    napi_delete_async_work(env, work);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ... è¿™é‡Œè¿˜å¯ä»¥å‘é€ç»“æœç»™JavaScript ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ¥ä¸‹æ¥æ˜¯æš´éœ²ç»™ JavaScript çš„å‡½æ•°ï¼Œå®ƒä¼šå¯åŠ¨å¼‚æ­¥å·¥ä½œ</span></span>
<span class="line"><span>napi_value StartAsyncWork(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value work_name;</span></span>
<span class="line"><span>    napi_async_work work;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ª JavaScript å­—ç¬¦ä¸²ä½œä¸ºå·¥ä½œåç§°</span></span>
<span class="line"><span>    napi_create_string_utf8(env, &quot;Heavy computation&quot;, NAPI_AUTO_LENGTH, &amp;work_name);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºå¼‚æ­¥å·¥ä½œå¯¹è±¡</span></span>
<span class="line"><span>    napi_create_async_work(env, NULL, work_name, ExecuteWork, WorkComplete, NULL, &amp;work);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†å·¥ä½œæ’å…¥é˜Ÿåˆ—</span></span>
<span class="line"><span>    napi_queue_async_work(env, work);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å› undefined ç»™ JavaScript</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    napi_get_undefined(env, &amp;result);</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>StartAsyncWork</code> æ˜¯æš´éœ²ç»™ JavaScript çš„å‡½æ•°ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªåä¸º &quot;Heavy computation&quot; çš„å¼‚æ­¥å·¥ä½œï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚<code>ExecuteWork</code> æ˜¯åœ¨åå°çº¿ç¨‹ä¸Šå®é™…æ‰§è¡Œå·¥ä½œçš„å‡½æ•°ï¼Œè€Œ <code>WorkComplete</code> åˆ™æ˜¯å·¥ä½œå®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå›è°ƒä¸­æˆ‘ä»¬ä½¿ç”¨ <code>napi_delete_async_work</code> æ¥åˆ é™¤å¼‚æ­¥å·¥ä½œå¯¹è±¡ï¼Œé‡Šæ”¾èµ„æºã€‚</p><p>è¿™æ ·ï¼Œå³ä½¿åœ¨æ‰§è¡Œå¤§é‡çš„è®¡ç®—æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¸ä¼šé˜»å¡ Node.js çš„ä¸»äº‹ä»¶å¾ªç¯ï¼Œä»è€Œä¿è¯äº†åº”ç”¨ç¨‹åºçš„å“åº”æ€§èƒ½ã€‚</p><h3 id="napi-queue-async-work" tabindex="-1"><a class="header-anchor" href="#napi-queue-async-work"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_queue_async_work" target="_blank" rel="noopener noreferrer">napi_queue_async_work</a></span></a></h3><p>å½“ç„¶å¯ä»¥ï¼Œé¦–å…ˆè®©æˆ‘ä»¬äº†è§£ä¸€ä¸‹ Node.js æ˜¯ä»€ä¹ˆã€‚</p><p>Node.js æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œå®ƒèƒ½è®©å¼€å‘è€…ä½¿ç”¨ JavaScript æ¥ç¼–å†™æœåŠ¡å™¨ç«¯çš„ä»£ç ã€‚Node.js ä½¿ç”¨éé˜»å¡ã€äº‹ä»¶é©±åŠ¨çš„æ¨¡å‹ï¼Œè¿™ä½¿å¾—å®ƒéå¸¸é€‚åˆæ„å»ºé«˜æ•ˆã€å¯æ‰©å±•çš„ç½‘ç»œåº”ç”¨ç¨‹åºã€‚</p><p>ç°åœ¨æˆ‘ä»¬æ¥è°ˆè°ˆ N-API å’Œ <code>napi_queue_async_work</code>ã€‚</p><p>N-API æ˜¯ Node.js çš„ä¸€ä¸ª C APIï¼Œå®ƒå…è®¸ native addons ä¸ Node.js è¿›è¡Œäº¤äº’ã€‚native addons æ˜¯ç”¨ C æˆ– C++ ç¼–å†™çš„æ¨¡å—ï¼Œå¯ä»¥é€šè¿‡ Node.js çš„ N-API è¢«ç›´æ¥é›†æˆåˆ° Node.js åº”ç”¨ç¨‹åºä¸­ã€‚é€šè¿‡è¿™æ ·åšï¼Œä½ å¯ä»¥åœ¨ Node.js ä¸­æ‰§è¡Œé‚£äº› JavaScript ä¸æ“…é•¿çš„ CPU å¯†é›†å‹ä»»åŠ¡ï¼ŒåŒæ—¶é¿å… Node.js åœ¨æ‰§è¡Œè¿™äº›ä»»åŠ¡æ—¶è¢«é˜»å¡ã€‚</p><p><code>napi_queue_async_work</code> æ˜¯ N-API æä¾›çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå…è®¸ä½ å°†å¼‚æ­¥å·¥ä½œï¼ˆå¦‚æ–‡ä»¶è¯»å†™ã€æ•°æ®åº“æ“ä½œæˆ–å…¶ä»–éœ€è¦å¤§é‡è®¡ç®—çš„ä»»åŠ¡ï¼‰æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶ååœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä»è€Œä¸ä¼šé˜»å¡ä¸» JavaScript çº¿ç¨‹ã€‚å½“è¿™ä¸ªå·¥ä½œå®Œæˆæ—¶ï¼Œå®ƒä¼šå°†ä¸€ä¸ªå›è°ƒå‡½æ•°æ”¾å›åˆ° JavaScript çš„äº‹ä»¶å¾ªç¯ä¸­ï¼Œä»è€Œè®©ä½ èƒ½å¤Ÿå¤„ç†ç»“æœã€‚</p><p>ä¸¾ä¸€ä¸ªä¾‹å­ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åº”ç”¨ç¨‹åºï¼Œè¯¥ç¨‹åºéœ€è¦å¤„ç†å›¾åƒï¼Œæ¯”å¦‚è½¬æ¢å›¾ç‰‡æ ¼å¼ï¼Œè¿™æ˜¯ä¸€ä¸ª CPU å¯†é›†å‹ä»»åŠ¡ã€‚å¦‚æœä½ åœ¨ Node.js ä¸»çº¿ç¨‹ä¸­è¿›è¡Œå›¾åƒå¤„ç†ï¼Œé‚£ä¹ˆåœ¨å¤„ç†æœŸé—´ï¼Œä½ çš„æœåŠ¡å™¨å°±æ— æ³•å“åº”ä»»ä½•å…¶ä»–è¯·æ±‚ï¼Œå› ä¸ºäº‹ä»¶å¾ªç¯è¢«é˜»å¡äº†ã€‚è¿™æ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„æƒ…å†µã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½ å¯ä»¥ç¼–å†™ä¸€ä¸ª native addonï¼Œå¹¶ä½¿ç”¨ <code>napi_queue_async_work</code> å°†å›¾åƒå¤„ç†ä»»åŠ¡æ”¾åˆ°åå°çº¿ç¨‹ä¸­å»æ‰§è¡Œã€‚è¿™æ ·ï¼Œä¸»çº¿ç¨‹å°±å¯ä»¥ç»§ç»­å¤„ç†å…¶ä»–è¯·æ±‚ï¼Œè€Œå›¾åƒå¤„ç†åœ¨åå°è¿›è¡Œã€‚å¤„ç†å®Œæˆåï¼Œé€šè¿‡è®¾ç½®çš„å›è°ƒå‡½æ•°ï¼Œä½ çš„ JavaScript ä»£ç å¯ä»¥è·å–åˆ°é€šçŸ¥ï¼Œå¹¶å¯¹å¤„ç†ç»“æœè¿›è¡Œç›¸åº”çš„æ“ä½œã€‚</p><p>ä¸‹é¢æ˜¯ä½¿ç”¨ <code>napi_queue_async_work</code> çš„ä¸€ä¸ªç®€åŒ–æµç¨‹ï¼š</p><ol><li>å®šä¹‰ä½ éœ€è¦åœ¨åå°æ‰§è¡Œçš„ä»»åŠ¡ã€‚</li><li>åˆ›å»ºä¸€ä¸ª <code>napi_async_work</code> å¥æŸ„ï¼Œå®ƒä»£è¡¨äº†è¿™ä¸ªä»»åŠ¡ã€‚</li><li>ä½¿ç”¨ <code>napi_queue_async_work</code> å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—å¹¶å¼€å§‹æ‰§è¡Œã€‚</li><li>å½“ä»»åŠ¡å®Œæˆæ—¶ï¼ŒNode.js ä¼šè‡ªåŠ¨å°†ä¸€ä¸ªå›è°ƒäº‹ä»¶æ”¾å…¥äº‹ä»¶å¾ªç¯ä¸­ï¼Œè®©ä½ å¯ä»¥åœ¨ JavaScript å±‚é¢å¤„ç†ç»“æœã€‚</li></ol><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œé€šå¸¸å¼€å‘è€…å¹¶ä¸éœ€è¦ç›´æ¥ä½¿ç”¨ N-API å’Œ <code>napi_queue_async_work</code> å‡½æ•°ï¼Œé™¤éä»–ä»¬æ­£åœ¨ç¼–å†™ native addonsã€‚å¯¹äºå¤§å¤šæ•°æƒ…å†µï¼ŒNode.js æ ¸å¿ƒ API æˆ–è€…é€šè¿‡ npm å®‰è£…çš„æ¨¡å—å·²ç»è¶³å¤Ÿç”¨äºå¤„ç†å„ç§å¼‚æ­¥ä»»åŠ¡ã€‚</p><h3 id="napi-cancel-async-work" tabindex="-1"><a class="header-anchor" href="#napi-cancel-async-work"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_cancel_async_work" target="_blank" rel="noopener noreferrer">napi_cancel_async_work</a></span></a></h3><p>å¥½çš„ï¼ŒNode.js ä¸­çš„ N-APIï¼ˆNode.js APIï¼‰æ˜¯ä¸€ä¸ªç”¨æ¥ç¼–å†™æœ¬åœ°æ’ä»¶çš„ APIã€‚è¿™äº›æœ¬åœ°æ’ä»¶æ˜¯ç”¨ C æˆ– C++ç­‰è¯­è¨€ç¼–å†™çš„ï¼Œå®ƒä»¬èƒ½å¤Ÿç›´æ¥ä¸ Node.js çš„è¿è¡Œæ—¶äº¤äº’ã€‚N-API æ—¨åœ¨æä¾›ä¸€ä¸ªç‹¬ç«‹äº JavaScript å¼•æ“çš„æŠ½è±¡å±‚ï¼Œè¿™æ„å‘³ç€ç¼–å†™çš„ä»£ç ä¸ä¾èµ–äºç‰¹å®šçš„ç‰ˆæœ¬çš„ Node.js æˆ– V8 å¼•æ“ï¼Œå¯ä»¥æ›´ç¨³å®šåœ°è·¨ç‰ˆæœ¬å·¥ä½œã€‚</p><p><code>napi_cancel_async_work</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºå–æ¶ˆä¹‹å‰é€šè¿‡<code>napi_create_async_work</code>åˆ›å»ºå¹¶é€šè¿‡<code>napi_queue_async_work</code>æ’é˜Ÿæ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡ã€‚å®é™…ä¸Šï¼Œå½“ä½ éœ€è¦åœæ­¢ä¸€ä¸ªè¿˜æ²¡æœ‰å¼€å§‹æˆ–è€…æ­£åœ¨æ‰§è¡Œä½†æ˜¯å¸Œæœ›æå‰ç»ˆæ­¢çš„å¼‚æ­¥æ“ä½œæ—¶ï¼Œä½ å¯ä»¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</p><p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><p>å‡è®¾ä½ åˆ›å»ºäº†ä¸€ä¸ªæœ¬åœ°æ’ä»¶ï¼Œè¯¥æ’ä»¶ä¸­æœ‰ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„è®¡ç®—ä»»åŠ¡ï¼Œä½†æ˜¯åœ¨æŸäº›æ¡ä»¶ä¸‹ï¼Œæ¯”å¦‚ç”¨æˆ·å–æ¶ˆæ“ä½œï¼Œæˆ–è€…è¶…å‡ºä¸€å®šçš„ç­‰å¾…æ—¶é—´åï¼Œä½ æƒ³è¦å–æ¶ˆè¿™ä¸ªä»»åŠ¡ã€‚</p><p>é¦–å…ˆï¼Œä½ ä¼šåˆ›å»ºä¸€ä¸ªå¼‚æ­¥å·¥ä½œé¡¹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value async_work;</span></span>
<span class="line"><span>napi_create_async_work(env, NULL, resource_name, execute, complete, data, &amp;async_work);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­ï¼Œ<code>execute</code> æ˜¯åœ¨å¼‚æ­¥çº¿ç¨‹æ± ä¸­è¿è¡Œçš„å‡½æ•°ï¼Œè€Œ <code>complete</code> æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œçš„ï¼Œ<code>data</code> æ˜¯ä¼ é€’ç»™å®ƒä»¬çš„æ•°æ®ã€‚</p><p>ç„¶åï¼Œä½ å°†è¿™ä¸ªå·¥ä½œé¡¹åŠ å…¥åˆ°å¼‚æ­¥é˜Ÿåˆ—ä¸­ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_queue_async_work(env, async_work);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ç°åœ¨å‡è®¾ä½ çš„åº”ç”¨ç¨‹åºé‡åˆ°äº†æŸç§æƒ…å†µï¼Œéœ€è¦å–æ¶ˆè¿™ä¸ªå¼‚æ­¥ä»»åŠ¡ã€‚è¿™æ—¶å€™ä½ å°±å¯ä»¥è°ƒç”¨ <code>napi_cancel_async_work</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_cancel_async_work(env, async_work);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>è¿™å°†å°è¯•å–æ¶ˆæ’é˜Ÿçš„å·¥ä½œã€‚å¦‚æœå·¥ä½œå·²ç»å¼€å§‹æ‰§è¡Œï¼Œé‚£ä¹ˆå®ƒä¼šåœ¨ä¸‹ä¸€ä¸ªå¯èƒ½çš„æœºä¼šç‚¹è¢«å–æ¶ˆã€‚å–æ¶ˆæˆåŠŸåï¼Œ<code>complete</code> å›è°ƒä»ç„¶ä¼šè¢«è°ƒç”¨ï¼Œä½ å¯ä»¥åœ¨è¿™ä¸ªå›è°ƒä¸­æ¸…ç†èµ„æºï¼Œä½†æ˜¯ <code>execute</code> å‡½æ•°çš„å½±å“å°†ä¸ä¼šç”Ÿæ•ˆã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå–æ¶ˆä¸€ä¸ªå¼‚æ­¥å·¥ä½œå¹¶ä¸ä¿è¯èƒ½ç«‹åˆ»åœæ­¢å®ƒï¼Œå› ä¸ºå¦‚æœè¯¥å·¥ä½œå·²ç»å¼€å§‹ï¼Œåœ¨å®ƒçš„æ‰§è¡Œè¿‡ç¨‹ä¸­æ²¡æœ‰æ£€æŸ¥å–æ¶ˆçŠ¶æ€ï¼Œåˆ™å®ƒå°†ç»§ç»­è¿è¡Œç›´åˆ°å®Œæˆã€‚åªæœ‰åœ¨å·¥ä½œæ”¯æŒå–æ¶ˆæ“ä½œï¼Œå¹¶ä¸”æ­£ç¡®åœ°æ£€æŸ¥äº†å¼‚æ­¥å·¥ä½œçš„å–æ¶ˆçŠ¶æ€æ—¶ï¼Œå®ƒæ‰ä¼šè¢«çœŸæ­£åœ°å–æ¶ˆæ‰ã€‚</p><p>ä½¿ç”¨ <code>napi_cancel_async_work</code> æä¾›äº†ä¸€ç§æœºåˆ¶æ¥å¤„ç†é‚£äº›éœ€è¦é•¿æ—¶é—´è¿è¡Œçš„æ“ä½œï¼ŒåŒæ—¶ä¹Ÿç»™äºˆäº†å¼€å‘è€…æ§åˆ¶æƒï¼Œä»¥åœ¨å¿…è¦æ—¶æå‰ç»ˆæ­¢è¿™äº›æ“ä½œï¼Œè¿™å¯¹äºåˆ›å»ºå“åº”å¼è‰¯å¥½çš„åº”ç”¨ç¨‹åºéå¸¸é‡è¦ã€‚</p><h2 id="custom-asynchronous-operations" tabindex="-1"><a class="header-anchor" href="#custom-asynchronous-operations"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#custom-asynchronous-operations" target="_blank" rel="noopener noreferrer">Custom asynchronous operations</a></span></a></h2><p>Node.js çš„ N-APIï¼ˆNative APIï¼‰æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„æ¥å£ã€‚åŸç”Ÿæ’ä»¶æ˜¯ç”¨ C æˆ– C++ç¼–å†™çš„æ¨¡å—ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ Node.js åº•å±‚ APIã€‚N-API æ—¨åœ¨éš”ç¦»æ’ä»¶ä¸ Node.js å¼•æ“çš„å˜åŠ¨ï¼Œä½¿å¾—ç¼–å†™çš„æ’ä»¶å¯ä»¥æ— éœ€ä¿®æ”¹å°±èƒ½é€‚åº”æ–°ç‰ˆæœ¬çš„ Node.jsã€‚</p><p>åœ¨ Node.js v21.7.1 ä¸­ï¼Œâ€œCustom asynchronous operationsâ€æŒ‡çš„æ˜¯é€šè¿‡ N-API åˆ›å»ºè‡ªå®šä¹‰çš„å¼‚æ­¥æ“ä½œã€‚è¿™å…è®¸ä½ æ‰§è¡Œå¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´å®Œæˆçš„ä»»åŠ¡ï¼ˆæ¯”å¦‚è¯»å–å¤§æ–‡ä»¶ã€è¿›è¡Œå¯†é›†è®¡ç®—ç­‰ï¼‰ï¼Œè€Œä¸ä¼šé˜»å¡ Node.js çš„äº‹ä»¶å¾ªç¯ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒå¯ä»¥å¸®åŠ©ä½ æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œå“åº”é€Ÿåº¦ï¼Œå› ä¸ºä¸»çº¿ç¨‹å¯ä»¥ç»§ç»­å¤„ç†å…¶ä»–äº‹ä»¶ï¼Œè€Œä¸å¿…ç­‰å¾…è€—æ—¶æ“ä½œå®Œæˆã€‚</p><h3 id="å®é™…åº”ç”¨ä¾‹å­-1" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ä¾‹å­-1"><span>å®é™…åº”ç”¨ä¾‹å­</span></a></h3><p>å‡è®¾æˆ‘ä»¬è¦å¼€å‘ä¸€ä¸ªåŸç”Ÿ Node.js æ’ä»¶ï¼Œè¯¥æ’ä»¶éœ€è¦æ‰§è¡Œä¸€ä¸ªè€—æ—¶çš„å›¾åƒå¤„ç†æ“ä½œï¼Œä¾‹å¦‚å°†å›¾ç‰‡è½¬æ¢ä¸ºé»‘ç™½è‰²ã€‚é€šå¸¸ï¼Œè¿™ç§æ“ä½œå¦‚æœåœ¨ Node.js çš„ä¸»çº¿ç¨‹ä¸ŠåŒæ­¥æ‰§è¡Œï¼Œä¼šå¯¼è‡´åº”ç”¨ç¨‹åºçš„æ‰€æœ‰å…¶ä»–æ´»åŠ¨æš‚åœï¼ŒåŒ…æ‹¬å“åº”ç”¨æˆ·è¯·æ±‚ã€‚</p><p>ä½¿ç”¨ N-API åˆ›å»ºçš„è‡ªå®šä¹‰å¼‚æ­¥æ“ä½œå¯ä»¥å°†å›¾åƒå¤„ç†å·¥ä½œç§»è‡³å•ç‹¬çš„çº¿ç¨‹ä¸­ã€‚ä»¥ä¸‹æ˜¯å®ç°è¯¥åŠŸèƒ½çš„é«˜çº§æ­¥éª¤ï¼š</p><ol><li><p><strong>å®šä¹‰å¼‚æ­¥å·¥ä½œç»“æ„</strong>ï¼šä½¿ç”¨<code>napi_create_async_work</code>å‡½æ•°åˆ›å»ºå¼‚æ­¥å·¥ä½œè¯·æ±‚ï¼Œå¹¶å®šä¹‰è¦åœ¨åå°æ‰§è¡Œçš„å‡½æ•°ã€‚</p></li><li><p><strong>å¯åŠ¨å¼‚æ­¥å·¥ä½œ</strong>ï¼šé€šè¿‡<code>napi_queue_async_work</code>å‡½æ•°å°†å¼‚æ­¥å·¥ä½œæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œè¿™æ ·å®ƒå°±ä¼šåœ¨å•ç‹¬çš„çº¿ç¨‹ä¸Šè¿è¡Œã€‚</p></li><li><p><strong>å®Œæˆå¤„ç†</strong>ï¼šä¸€æ—¦åå°æ“ä½œå®Œæˆï¼Œä¼šè°ƒç”¨ä¸€ä¸ªå®Œæˆå›è°ƒå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­ä½ å¯ä»¥å°†ç»“æœä¼ å› JavaScript ä»£ç ã€‚</p></li></ol><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¼ªä»£ç ç¤ºä¾‹ï¼Œå±•ç¤ºäº†è¿™äº›æ­¥éª¤å¦‚ä½•ç»“åˆèµ·æ¥ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å›¾åƒå¤„ç†å‡½æ•°ï¼Œè¿è¡Œåœ¨å•ç‹¬çš„çº¿ç¨‹ä¸Š</span></span>
<span class="line"><span>void ProcessImageInBackground(napi_env env, void* data) {</span></span>
<span class="line"><span>    // è¿™é‡Œè¿›è¡Œè€—æ—¶çš„å›¾åƒå¤„ç†æ“ä½œ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å®Œæˆå›è°ƒå‡½æ•°ï¼Œè¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸Šï¼Œè´Ÿè´£è¿”å›ç»“æœç»™JavaScript</span></span>
<span class="line"><span>void OnImageProcessed(napi_env env, napi_status status, void* data) {</span></span>
<span class="line"><span>    // é€šçŸ¥JavaScriptå›¾åƒå¤„ç†å·²å®Œæˆ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// JavaScriptè°ƒç”¨çš„å‡½æ•°ï¼Œå¯åŠ¨å¼‚æ­¥å›¾åƒå¤„ç†</span></span>
<span class="line"><span>napi_value ConvertImageToBlackAndWhite(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // åˆ›å»ºå¼‚æ­¥å·¥ä½œè¯·æ±‚...</span></span>
<span class="line"><span>    napi_value work_name;</span></span>
<span class="line"><span>    napi_create_string_utf8(env, &quot;ConvertImage&quot;, NAPI_AUTO_LENGTH, &amp;work_name);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_async_work work;</span></span>
<span class="line"><span>    napi_create_async_work(env, NULL, work_name,</span></span>
<span class="line"><span>                           ProcessImageInBackground,</span></span>
<span class="line"><span>                           OnImageProcessed, NULL, &amp;work);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†å·¥ä½œåŠ å…¥é˜Ÿåˆ—...</span></span>
<span class="line"><span>    napi_queue_async_work(env, work);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›undefinedï¼Œè¡¨ç¤ºå‡½æ•°å·²éé˜»å¡æ–¹å¼è°ƒç”¨</span></span>
<span class="line"><span>    return NULL;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ¨¡å—åˆå§‹åŒ–ä»£ç </span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value convert_fn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, ConvertImageToBlackAndWhite, NULL, &amp;convert_fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;convertImageToBlackAndWhite&quot;, convert_fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼š</p><ul><li><code>ProcessImageInBackground</code> æ˜¯åœ¨åå°æ‰§è¡Œçš„è€—æ—¶æ“ä½œã€‚</li><li><code>OnImageProcessed</code> æ˜¯å¼‚æ­¥æ“ä½œå®Œæˆåè°ƒç”¨çš„å›è°ƒå‡½æ•°ã€‚</li><li><code>ConvertImageToBlackAndWhite</code> æ˜¯ä» JavaScript ä»£ç ä¸­è°ƒç”¨ä»¥å¯åŠ¨æ•´ä¸ªå¼‚æ­¥è¿‡ç¨‹çš„å‡½æ•°ã€‚</li></ul><p>è™½ç„¶è¿™åªæ˜¯ä¸€ä¸ªå¤§æ¦‚çš„æ¡†æ¶ï¼Œå®ƒè¯´æ˜äº†å¦‚ä½•ä½¿ç”¨ Node.js N-API åˆ›å»ºè‡ªå®šä¹‰çš„å¼‚æ­¥æ“ä½œã€‚å¯¹äºç¼–ç¨‹æ–°æ‰‹æ¥è¯´ï¼Œç†è§£è¿™äº›æ¦‚å¿µå¯èƒ½éœ€è¦æ—¶é—´ï¼Œä½†è¿™æ˜¯ Node.js é«˜æ€§èƒ½åŸç”Ÿæ‰©å±•ç¼–ç¨‹çš„åŸºç¡€çŸ¥è¯†ä¹‹ä¸€ã€‚</p><h3 id="napi-async-init" tabindex="-1"><a class="header-anchor" href="#napi-async-init"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_async_init" target="_blank" rel="noopener noreferrer">napi_async_init</a></span></a></h3><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚å®ƒæä¾›äº†ä¸€äº›å‡½æ•°ï¼Œå¯ä»¥è®©ä½ åœ¨ C æˆ– C++ä»£ç ä¸­ä½¿ç”¨ JavaScript åŠŸèƒ½ã€‚<code>napi_async_init</code>æ˜¯ N-API é‡Œçš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥åˆå§‹åŒ–å¼‚æ­¥æ“ä½œã€‚</p><p>å½“ä½ æƒ³åœ¨ Node.js çš„åŸç”Ÿæ’ä»¶ä¸­æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œæ¯”å¦‚è¯»å–æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚æˆ–è€…ä¸€äº›é•¿æ—¶é—´è¿è¡Œçš„è®¡ç®—ï¼Œä½ éœ€è¦é€šè¿‡æ­£ç¡®çš„æ–¹å¼å‘Šè¯‰ Node.js çš„äº‹ä»¶å¾ªç¯è¿™ä¸ªä»»åŠ¡æ˜¯å¼‚æ­¥çš„ã€‚è¿™æ ·åšå¯ä»¥è®© Node.js çš„ä¸»çº¿ç¨‹ç»§ç»­å¤„ç†å…¶ä»–äº‹ä»¶ï¼Œæ¯”å¦‚ç”¨æˆ·çš„è¾“å…¥ã€æœåŠ¡å™¨çš„è¯·æ±‚ç­‰ï¼Œè€Œä¸ä¼šå› ä¸ºç­‰å¾…æŸä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡å®Œæˆè€Œé˜»å¡ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬è¯¦ç»†è§£é‡Šä¸€ä¸‹<code>napi_async_init</code>ï¼š</p><h3 id="napi-async-init-1" tabindex="-1"><a class="header-anchor" href="#napi-async-init-1"><span>napi_async_init</span></a></h3><p><strong>è¯­æ³•ï¼š</strong></p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_async_init(napi_env env,</span></span>
<span class="line"><span>                            napi_value async_resource,</span></span>
<span class="line"><span>                            napi_value async_resource_name,</span></span>
<span class="line"><span>                            napi_async_context* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>env</strong>: è¿™æ˜¯è¡¨ç¤º N-API ç¯å¢ƒçš„å¥æŸ„ã€‚æ¯æ¬¡ N-API å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œéƒ½ä¼šä¼ é€’è¿™ä¸ªç¯å¢ƒå¥æŸ„ã€‚</li><li><strong>async_resource</strong>: è¿™é€šå¸¸æ˜¯ä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œå®ƒä¸å¼‚æ­¥æ“ä½œç›¸å…³è”ã€‚è¿™ä¸ªå¯¹è±¡åœ¨å¼‚æ­¥æ“ä½œæœŸé—´ä¿æŒæ´»åŠ¨çŠ¶æ€ï¼Œå¯ä»¥ç”¨æ¥å­˜å‚¨ä¿¡æ¯ã€‚</li><li><strong>async_resource_name</strong>: è¿™æ˜¯ä¸€ä¸ª JavaScript å­—ç¬¦ä¸²ï¼Œå®ƒç»™å‡ºäº†<code>async_resource</code>çš„åç§°ï¼Œç”¨äºè°ƒè¯•ã€‚</li><li><strong>result</strong>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘å¼‚æ­¥ä¸Šä¸‹æ–‡å¥æŸ„çš„æŒ‡é’ˆï¼Œåœ¨è°ƒç”¨<code>napi_async_init</code>åï¼Œè¿™ä¸ªå¥æŸ„å¯ä»¥ç”¨äºå…¶ä»–å¼‚æ­¥æ“ä½œ APIã€‚</li></ul><h3 id="ä½¿ç”¨åœºæ™¯å’Œä¾‹å­" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯å’Œä¾‹å­"><span>ä½¿ç”¨åœºæ™¯å’Œä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js çš„åŸç”Ÿæ’ä»¶ï¼Œä½ éœ€è¦ä»ä¸€ä¸ªç¡¬ä»¶è®¾å¤‡ä¸­å¼‚æ­¥è¯»å–æ•°æ®ã€‚ä½ å¯èƒ½ä¼šå†™ä¸€ä¸ª C å‡½æ•°æ¥å¯åŠ¨è¯»å–è¿‡ç¨‹ï¼Œå¹¶ä¸”å½“è¯»å–å®Œæ¯•æ—¶ï¼Œä½ å¸Œæœ›èƒ½å¤Ÿé€šçŸ¥ Node.jsã€‚</p><ol><li><p>é¦–å…ˆï¼Œä½ ä½¿ç”¨<code>napi_async_init</code>æ¥åˆå§‹åŒ–ä¸€ä¸ªå¼‚æ­¥ä¸Šä¸‹æ–‡ã€‚è¿™ä¸ªä¸Šä¸‹æ–‡å°†ç”¨äºç¨ååœ¨å¼‚æ­¥æ“ä½œå®Œæˆæ—¶é€šçŸ¥ Node.jsã€‚</p></li><li><p>æ¥ç€ï¼Œä½ å¼€å¯è¯»å–æ•°æ®çš„ç¡¬ä»¶æ“ä½œï¼Œè¿™éƒ¨åˆ†é€šå¸¸æ¶‰åŠå‘ç¡¬ä»¶å‘é€å‘½ä»¤ï¼Œç„¶åç­‰å¾…ç¡¬ä»¶çš„å›åº”ã€‚</p></li><li><p>å½“ç¡¬ä»¶æœ‰æ•°æ®è¿”å›æ—¶ï¼Œä½ å°†ä½¿ç”¨å¦ä¸€ä¸ª N-API å‡½æ•°ï¼ˆæ¯”å¦‚<code>napi_make_callback</code>ï¼‰æ¥å°†æ•°æ®ä¼ å›ç»™ Node.jsï¼ŒåŒæ—¶åˆ©ç”¨ä¹‹å‰åˆ›å»ºçš„å¼‚æ­¥ä¸Šä¸‹æ–‡ã€‚</p></li><li><p>æœ€åï¼Œå½“æ‰€æœ‰å¼‚æ­¥æ“ä½œéƒ½å®Œæˆæ—¶ï¼Œä½ åº”è¯¥ä½¿ç”¨<code>napi_async_destroy</code>æ¥æ¸…ç†ä½ åˆ›å»ºçš„å¼‚æ­¥ä¸Šä¸‹æ–‡ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚</p></li></ol><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€åŒ–çš„ç¤ºä¾‹ä»£ç ç‰‡æ®µï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨<code>napi_async_init</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æœ‰ä¸€ä¸ªå¼‚æ­¥æ“ä½œå‡½æ•°</span></span>
<span class="line"><span>void read_data_from_hardware(/* å‚æ•° */) {</span></span>
<span class="line"><span>    // ... ä¸ç¡¬ä»¶äº¤äº’çš„ä»£ç  ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value InitiateAsyncOperation(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span>    napi_async_context context;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆå§‹åŒ–å¼‚æ­¥ä¸Šä¸‹æ–‡</span></span>
<span class="line"><span>    status = napi_async_init(env, NULL, NULL, &amp;context);</span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦æˆåŠŸ</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¯åŠ¨ç¡¬ä»¶è¯»å–æ“ä½œï¼Œæ­¤æ“ä½œå°†åœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»å®Œæˆ</span></span>
<span class="line"><span>    read_data_from_hardware(/* å‚æ•° */);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ... å…¶ä»–ä»£ç  ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›ç»“æœç»™JavaScript</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    status = napi_get_undefined(env, &amp;result);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œè¿™ä¸ªå‡½æ•°åˆ°Node.js</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, InitiateAsyncOperation, NULL, &amp;fn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;initiateAsyncOperation&quot;, fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·æ³¨æ„ï¼Œä¸Šè¿°ä»£ç åªæ˜¯ä¸€ä¸ªæ¦‚å¿µæ€§å±•ç¤ºï¼Œå®é™…çš„å¼‚æ­¥æ“ä½œéœ€è¦ä½¿ç”¨äº‹ä»¶å¾ªç¯å’Œå›è°ƒå‡½æ•°æ¥æ­£ç¡®åœ°è¿›è¡Œã€‚</p><h3 id="napi-async-destroy" tabindex="-1"><a class="header-anchor" href="#napi-async-destroy"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_async_destroy" target="_blank" rel="noopener noreferrer">napi_async_destroy</a></span></a></h3><p><code>napi_async_destroy</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå±äº N-APIï¼ˆNode APIï¼‰çš„ä¸€éƒ¨åˆ†ã€‚N-API æ˜¯ä¸€å¥— C è¯­è¨€çš„ APIï¼Œå®ƒå…è®¸ä½ åˆ›å»ºå¯ä»¥ä¸ Node.js JavaScript è¿è¡Œæ—¶äº¤äº’çš„æœ¬åœ°æ’ä»¶ã€‚è¿™äº›æœ¬åœ°æ’ä»¶é€šå¸¸æ˜¯ç”¨ C æˆ– C++ ç¼–å†™çš„ï¼Œç›®çš„æ˜¯ä¸ºäº†æä¾›ä¸€äº› JavaScript éš¾ä»¥å®ç°æˆ–è€…æ€§èƒ½ä¸è¶³çš„åŠŸèƒ½ã€‚</p><h3 id="napi-async-destroy-çš„ä½œç”¨" tabindex="-1"><a class="header-anchor" href="#napi-async-destroy-çš„ä½œç”¨"><span>napi_async_destroy çš„ä½œç”¨</span></a></h3><p>åœ¨è§£é‡Š <code>napi_async_destroy</code> ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£å…¶ä¸­æ¶‰åŠçš„å‡ ä¸ªæ¦‚å¿µï¼š</p><ol><li><p><strong>å¼‚æ­¥æ“ä½œ</strong>ï¼šåœ¨ Node.js ä¸­ï¼Œå¾ˆå¤šæ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œæ¯”å¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œè¯·æ±‚ç­‰ã€‚è¿™æ„å‘³ç€è¿™äº›æ“ä½œä¼šåœ¨åå°æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæ¯•åé€šè¿‡å›è°ƒå‡½æ•°æ¥é€šçŸ¥ç»“æœï¼Œä»è€Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚</p></li><li><p><strong>async_hooks</strong>ï¼šè¿™æ˜¯ Node.js ä¸­ç”¨æ¥è¿½è¸ªå¼‚æ­¥èµ„æºç”Ÿå‘½å‘¨æœŸçš„æ¨¡å—ã€‚æ¯å½“åˆ›å»ºä¸€ä¸ªå¼‚æ­¥æ“ä½œæ—¶ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¼‚æ­¥èµ„æºï¼Œå¹¶ä¸”è¿™ä¸ªèµ„æºä¼šæœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ã€‚</p></li><li><p><strong>napi_async_context</strong>ï¼šè¿™æ˜¯ N-API ä¸­çš„ä¸€ä¸ªç»“æ„ä½“ï¼Œä»£è¡¨äº†ä¸ç‰¹å®šå¼‚æ­¥æ“ä½œç›¸å…³è”çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚å½“ä½ ä½¿ç”¨ N-API åˆ›å»ºä¸€ä¸ªå¼‚æ­¥æ“ä½œæ—¶ï¼Œä½ éœ€è¦åˆ›å»ºè¿™æ ·ä¸€ä¸ªä¸Šä¸‹æ–‡ã€‚</p></li></ol><p>ç°åœ¨æ¥çœ‹ <code>napi_async_destroy</code>ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯é”€æ¯ä¸€ä¸ªå·²ç»ä¸å†éœ€è¦çš„ <code>napi_async_context</code>ã€‚å½“ä½ åˆ›å»ºäº†ä¸€ä¸ª <code>napi_async_context</code> åï¼Œåœ¨å¼‚æ­¥æ“ä½œå®Œæˆå¹¶ä¸”ä¸å†éœ€è¦è¿™ä¸ªä¸Šä¸‹æ–‡æ—¶ï¼Œä½ åº”è¯¥è°ƒç”¨ <code>napi_async_destroy</code> æ¥æ¸…ç†å®ƒã€‚å¦‚æœä¸è¿™æ ·åšï¼Œå¯èƒ½ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚</p><h3 id="ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹-3" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹-3"><span>ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªæœ¬åœ°æ’ä»¶ï¼Œè¯¥æ’ä»¶éœ€è¦åœ¨åå°è¿›è¡Œä¸€äº›è€—æ—¶çš„è®¡ç®—ï¼Œå¹¶åœ¨è®¡ç®—å®Œæˆåå°†ç»“æœè¿”å›ç»™ JavaScriptã€‚ä½ å¯èƒ½ä¼šè¿™æ ·åšï¼š</p><ol><li>åœ¨æ’ä»¶åˆå§‹åŒ–æ—¶ï¼Œåˆ›å»ºä¸€ä¸ª <code>napi_async_context</code>ã€‚</li></ol><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status status;</span></span>
<span class="line"><span>napi_async_context async_context;</span></span>
<span class="line"><span>status = napi_async_init(env, NULL, &quot;example_async_context&quot;, &amp;async_context);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><p>åœ¨å¼€å§‹å¼‚æ­¥æ“ä½œæ—¶ï¼Œä¼ é€’è¿™ä¸ªä¸Šä¸‹æ–‡åˆ°ä¸€ä¸ªå¼‚æ­¥å·¥ä½œé˜Ÿåˆ—ä¸­ã€‚</p></li><li><p>å½“å¼‚æ­¥æ“ä½œå®Œæˆæ—¶ï¼Œä½¿ç”¨è¿™ä¸ªä¸Šä¸‹æ–‡æ¥è§¦å‘å›è°ƒã€‚</p></li><li><p>åœ¨æ’ä»¶è¢«æ¸…ç†æˆ–è€…ä¸å†éœ€è¦å¤„ç†å¼‚æ­¥æ“ä½œæ—¶ï¼Œé”€æ¯è¿™ä¸ªä¸Šä¸‹æ–‡ã€‚</p></li></ol><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status status;</span></span>
<span class="line"><span>status = napi_async_destroy(env, async_context);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œä½ ç¡®ä¿äº†å³ä½¿æ˜¯åœ¨ C/C++ å±‚é¢è¿›è¡Œå¼‚æ­¥æ“ä½œï¼Œä¹Ÿèƒ½å¤Ÿæ­£ç¡®åœ°ç®¡ç†èµ„æºå’Œå†…å­˜ï¼Œå¹¶ä¸”èƒ½å¤Ÿå’Œ JavaScript çš„äº‹ä»¶å¾ªç¯æ— ç¼é›†æˆã€‚</p><p>è®°ä½ï¼Œ<code>napi_async_destroy</code> åº”è¯¥åœ¨ç¡®ä¿æ‰€æœ‰ä½¿ç”¨äº†è¿™ä¸ªä¸Šä¸‹æ–‡çš„å¼‚æ­¥æ“ä½œéƒ½å·²ç»å®Œæˆä¹‹åè°ƒç”¨ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´æ— æ³•é¢„æ–™çš„è¡Œä¸ºã€‚</p><h3 id="napi-make-callback" tabindex="-1"><a class="header-anchor" href="#napi-make-callback"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_make_callback" target="_blank" rel="noopener noreferrer">napi_make_callback</a></span></a></h3><p>Node.js çš„ <code>N-API</code> æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ¬æœºæ’ä»¶ï¼ˆnative addonsï¼‰çš„ API å±‚ï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨ C æˆ– C++ ä»£ç ä¸ Node.js è¿è¡Œæ—¶äº¤äº’ã€‚è¿™ä¸ªæ¥å£è®¾è®¡å¾—è¶³å¤Ÿç¨³å®šï¼Œä½¿å¾—å¯¹ Node.js ç‰ˆæœ¬çš„å‡çº§ä¸ä¼šç ´åä½¿ç”¨ N-API ç¼–å†™çš„æ¨¡å—ã€‚</p><p><code>napi_make_callback</code> æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¢«ç”¨æ¥ä»åŸç”Ÿä»£ç ï¼ˆC/C++ æ’ä»¶ï¼‰ä¸­è°ƒç”¨ JavaScript å‡½æ•°ï¼Œå¹¶ä¸”æ­£ç¡®åœ°å¤„ç† Node.js çš„äº‹ä»¶å¾ªç¯å’Œå¼‚æ­¥æ“ä½œã€‚</p><p>åœ¨è¯¦ç»†è§£é‡Š <code>napi_make_callback</code> ä¹‹å‰ï¼Œéœ€è¦äº†è§£ä¸¤ä¸ªæ¦‚å¿µï¼šNode.js äº‹ä»¶å¾ªç¯å’Œå›è°ƒå‡½æ•°ã€‚</p><ol><li><p><strong>äº‹ä»¶å¾ªç¯</strong>:<br> Node.js ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¨¡å‹æ¥å¤„ç†å¹¶å‘ï¼Œå…¶ä¸­ä¸»è¦ç»„æˆéƒ¨åˆ†å°±æ˜¯äº‹ä»¶å¾ªç¯ã€‚äº‹ä»¶å¾ªç¯è´Ÿè´£ç›‘å¬äº‹ä»¶ï¼ˆä¾‹å¦‚ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™å®Œæˆç­‰ï¼‰ï¼Œå¹¶å°†å¯¹åº”çš„å›è°ƒå‡½æ•°æ’é˜Ÿè¿›è¡Œæ‰§è¡Œã€‚</p></li><li><p><strong>å›è°ƒå‡½æ•°</strong>:<br> åœ¨ JavaScript ä¸­ï¼Œä¸€ä¸ªå›è°ƒå‡½æ•°æ˜¯ä¼ é€’ç»™å…¶ä»–å‡½æ•°ä½œä¸ºå‚æ•°çš„å‡½æ•°ï¼Œç„¶ååœ¨æŸä¸ªäº‹ä»¶æˆ–æ¡ä»¶ä¸‹è¢«è°ƒç”¨ã€‚Node.js å¤§é‡ä¾èµ–å›è°ƒå‡½æ•°æ¥å¤„ç†éé˜»å¡çš„å¼‚æ­¥æ“ä½œã€‚</p></li></ol><p><code>napi_make_callback</code> å…·ä½“åšä»€ä¹ˆï¼Ÿ</p><p>å½“ä½ åœ¨æœ¬æœºæ’ä»¶ä¸­æ‰§è¡Œä¸€äº›å¼‚æ­¥æ“ä½œï¼Œå¹¶å¸Œæœ›åœ¨è¿™äº›æ“ä½œå®Œæˆæ—¶è°ƒç”¨ JavaScript ä¸­å®šä¹‰çš„å›è°ƒå‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨ <code>napi_make_callback</code>ã€‚å®ƒç¡®ä¿å›è°ƒå‡½æ•°çš„è°ƒç”¨éµå¾ª Node.js äº‹ä»¶å¾ªç¯çš„è§„åˆ™ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†åµŒå¥—è°ƒç”¨æˆ–å¤šä¸ªå¼‚æ­¥äº‹ä»¶æ—¶ã€‚</p><p>å¦‚ä½•ä½¿ç”¨ <code>napi_make_callback</code>? ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­ï¼š</p><p>å‡è®¾ä½ åœ¨ C++ æ’ä»¶ä¸­æœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œä½ æƒ³åœ¨è¯»å–å®Œæ–‡ä»¶åæ‰§è¡Œ JavaScript ä¸­çš„å›è°ƒå‡½æ•°ï¼Œä½ å¯èƒ½ä¼šè¿™æ ·å†™ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>void OnFileReadComplete(napi_env env, napi_status status, void* data) {</span></span>
<span class="line"><span>    // æ„é€ ä¸€ä¸ªJavaScriptå‡½æ•°çš„å›è°ƒ</span></span>
<span class="line"><span>    napi_value callback;</span></span>
<span class="line"><span>    napi_value global;</span></span>
<span class="line"><span>    napi_get_global(env, &amp;global);</span></span>
<span class="line"><span>    napi_get_reference_value(env, (napi_ref)data, &amp;callback);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å‡è®¾æˆ‘ä»¬æƒ³è¦ä¼ é€’ä¸€ä¸ªå­—ç¬¦ä¸² &#39;Hello world!&#39; ç»™å›è°ƒ</span></span>
<span class="line"><span>    napi_value argv[1];</span></span>
<span class="line"><span>    napi_create_string_utf8(env, &quot;Hello world!&quot;, NAPI_AUTO_LENGTH, &amp;argv[0]);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è°ƒç”¨JavaScriptçš„å›è°ƒå‡½æ•°ï¼ŒåŒæ—¶éµå¾ªäº‹ä»¶å¾ªç¯çš„è§„åˆ™</span></span>
<span class="line"><span>    napi_value result;</span></span>
<span class="line"><span>    napi_make_callback(env, nullptr, global, callback, 1, argv, &amp;result);</span></span>
<span class="line"><span>    // ...çœç•¥æ¸…ç†å¼•ç”¨å’Œé”™è¯¯å¤„ç†çš„ä»£ç ...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç ä¸­çš„ <code>OnFileReadComplete</code> å‡½æ•°æ˜¯åœ¨æ–‡ä»¶è¯»å–å®Œæ¯•ä¹‹åè¢«è°ƒç”¨çš„ï¼Œå®ƒå‡†å¤‡å¥½è°ƒç”¨åœ¨ JavaScript ä¸­æä¾›çš„å›è°ƒå‡½æ•°ï¼Œå¹¶é€šè¿‡ <code>napi_make_callback</code> å®‰å…¨åœ°è°ƒç”¨è¯¥ JavaScript å‡½æ•°ã€‚<code>env</code> å‚æ•°æ˜¯ä¸€ä¸ªè¡¨ç¤º N-API ç¯å¢ƒçš„å¥æŸ„ï¼Œ<code>status</code> è¡¨ç¤ºä¹‹å‰çš„æ“ä½œçŠ¶æ€ï¼Œè€Œ <code>data</code> æŒ‡å‘é¢„å…ˆå­˜å‚¨çš„ç”¨æˆ·æ•°æ®ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘ JavaScript å›è°ƒå‡½æ•°å¼•ç”¨çš„æŒ‡é’ˆï¼‰ã€‚</p><p><code>napi_get_global</code> è·å– JavaScript å…¨å±€å¯¹è±¡çš„å¼•ç”¨ï¼Œ<code>napi_get_reference_value</code> æ ¹æ®ä¹‹å‰åˆ›å»ºçš„å¼•ç”¨è·å–å®é™…çš„ JavaScript å‡½æ•°å¯¹è±¡ã€‚ç„¶åä½¿ç”¨ <code>napi_create_string_utf8</code> åˆ›å»ºä¸€ä¸ª JavaScript å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ã€‚æœ€åï¼Œ<code>napi_make_callback</code> å®é™…è°ƒç”¨ JavaScript å‡½æ•°ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>napi_make_callback</code> åœ¨ Node.js çš„ N-API ä¸­æ˜¯ä¸€ä¸ªé«˜çº§å‡½æ•°ï¼Œç”¨äºåœ¨æœ¬åœ°ä»£ç ä¸­æŒ‰ç…§ Node.js çš„äº‹ä»¶å¾ªç¯è§„åˆ™è°ƒç”¨ JavaScript å‡½æ•°ã€‚é€šè¿‡ä½¿ç”¨è¿™ä¸ªå‡½æ•°ï¼Œå¼€å‘è€…èƒ½å¤Ÿç¼–å†™å‡ºæ›´å®‰å…¨ã€æ›´ç¨³å®šçš„æœ¬æœºæ’ä»¶ï¼Œç¡®ä¿ä¸ JavaScript ä»£ç çš„äº¤äº’ä¸ä¼šè¿èƒŒ Node.js çš„è®¾è®¡åŸåˆ™ã€‚</p><h3 id="napi-open-callback-scope" tabindex="-1"><a class="header-anchor" href="#napi-open-callback-scope"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_open_callback_scope" target="_blank" rel="noopener noreferrer">napi_open_callback_scope</a></span></a></h3><p>Node.js ä¸­çš„ <code>napi_open_callback_scope</code> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå±äº Node.js çš„ N-APIã€‚N-API æ˜¯ä¸€ç»„ç¨³å®šçš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼ˆAPIï¼‰ï¼Œå…è®¸ä½ åˆ›å»ºåŸç”Ÿæ’ä»¶ã€‚åŸç”Ÿæ’ä»¶æ˜¯ç”¨ C æˆ– C++ç­‰è¯­è¨€ç¼–å†™çš„åŠ¨æ€é“¾æ¥åº“ï¼ˆDLLï¼‰ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ Node.js è¿è¡Œæ—¶å’Œ V8 å¼•æ“çš„åŠŸèƒ½ï¼Œé€šå¸¸ç”¨äºæ‰§è¡Œç‰¹å®šç¡¬ä»¶æ“ä½œã€å¤„ç†å¤§é‡æ•°æ®æˆ–å…¶ä»–éœ€è¦é«˜æ€§èƒ½çš„åœºæ™¯ã€‚</p><p>åœ¨ä½¿ç”¨ N-API ç¼–å†™åŸç”Ÿä»£ç æ—¶ï¼Œæœ‰æ—¶ä½ éœ€è¦åœ¨ JavaScript ç¯å¢ƒå¤–éƒ¨åˆ›å»ºä¸€ä¸ªå›è°ƒï¼Œè¿™å°±æ˜¯<code>napi_open_callback_scope</code>å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚è¿™ä¸ªå‡½æ•°å¸®åŠ©ä½ å¼€å¯ä¸€ä¸ªæ–°çš„â€œå›è°ƒä½œç”¨åŸŸâ€ï¼ˆcallback scopeï¼‰ï¼Œå®ƒå…è®¸ä½ åœ¨é JavaScript çº¿ç¨‹ä¸­å®‰å…¨åœ°è°ƒç”¨ JavaScript å‡½æ•°ã€‚</p><p>å®é™…ä¸Šï¼Œå½“ä½ æƒ³è¦ä»ä¸€ä¸ªåŸç”Ÿçº¿ç¨‹è°ƒç”¨ä¸€ä¸ª JavaScript å‡½æ•°æ—¶ï¼Œä½ ä¸èƒ½ç›´æ¥è¿™æ ·åšï¼Œå› ä¸º JavaScript æ˜¯å•çº¿ç¨‹çš„ï¼Œä¸”è¿è¡Œåœ¨ V8 å¼•æ“çš„ä¸»çº¿ç¨‹ä¸­ã€‚å› æ­¤ï¼Œä½ éœ€è¦é€šè¿‡<code>napi_open_callback_scope</code>æ¥ç¡®ä¿ä½ çš„è°ƒç”¨åœ¨æ­£ç¡®çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹å‡ ä¸ªä¾‹å­ï¼š</p><ol><li><p><strong>å¼‚æ­¥æ“ä½œå®Œæˆåçš„å›è°ƒ</strong>ï¼šå‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªæ–‡ä»¶è¯»å–æ¨¡å—ã€‚ä½ å¯èƒ½ä¼šç”¨ C++è¿›è¡Œæ–‡ä»¶çš„è¯»å–æ“ä½œï¼Œå¹¶åˆ©ç”¨ N-API æš´éœ²è¿™ä¸ªåŠŸèƒ½ç»™ Node.jsã€‚ä¸€æ—¦æ–‡ä»¶è¯»å–å®Œæ¯•ï¼Œä½ æƒ³è¦è¿è¡Œä¸€ä¸ª JavaScript å›è°ƒå‡½æ•°æ¥å¤„ç†è¯»å–åˆ°çš„æ•°æ®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±éœ€è¦ç”¨åˆ°<code>napi_open_callback_scope</code>ã€‚</p></li><li><p><strong>è‡ªå®šä¹‰äº‹ä»¶å‘å°„å™¨</strong>ï¼šå¦‚æœä½ çš„åŸç”Ÿæ¨¡å—åƒç¡¬ä»¶è®¾å¤‡é‚£æ ·å·¥ä½œï¼Œå¯èƒ½éœ€è¦åœ¨æŸäº›äº‹ä»¶å‘ç”Ÿæ—¶è§¦å‘ JavaScript ä¾§çš„ç›‘å¬å™¨ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªæ¸©åº¦è®¡æ¨¡å—ä¸­ï¼Œæ¯å½“æ£€æµ‹åˆ°æ¸©åº¦å˜åŒ–æ—¶ï¼Œä½ å¯èƒ½ä¼šè°ƒç”¨ä¸€ä¸ª JavaScript å‡½æ•°æ¥å¤„ç†è¿™ä¸ªäº‹ä»¶ã€‚ä¸ºæ­¤ï¼Œä½ ä¹Ÿéœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„å›è°ƒä½œç”¨åŸŸã€‚</p></li><li><p><strong>å®šæ—¶å™¨å›è°ƒ</strong>ï¼šå¦‚æœä½ çš„åŸç”Ÿæ¨¡å—æš´éœ²äº†ä¸€ä¸ªå®šæ—¶å™¨åŠŸèƒ½ï¼ŒJavaScript ä»£ç å¯ä»¥æä¾›ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåœ¨å®šæ—¶å™¨è§¦å‘æ—¶æ‰§è¡Œã€‚åŸç”Ÿä»£ç éƒ¨åˆ†å°†ä½¿ç”¨<code>napi_open_callback_scope</code>æ¥ç¡®ä¿å½“å®šæ—¶å™¨åœ¨åŸç”Ÿçº¿ç¨‹è§¦å‘æ—¶ï¼Œå›è°ƒå‡½æ•°èƒ½å¤Ÿæ­£ç¡®åœ°åœ¨ JavaScript ç¯å¢ƒä¸­æ‰§è¡Œã€‚</p></li></ol><p>ç®€è€Œè¨€ä¹‹ï¼Œ<code>napi_open_callback_scope</code>æ˜¯ä¸<code>napi_close_callback_scope</code>ç»“åˆä½¿ç”¨çš„ï¼Œå®ƒä»¬åŒ…è£¹ä½ éœ€è¦åœ¨åŸç”Ÿçº¿ç¨‹ä¸­æ‰§è¡Œçš„ JavaScript å›è°ƒå‡½æ•°ï¼Œç¡®ä¿æ‰€æœ‰ä¸æ‰§è¡Œè¯¥å›è°ƒç›¸å…³çš„èµ„æºè¢«æ­£ç¡®ç®¡ç†ï¼Œå¹¶ä¸”è°ƒç”¨æ˜¯åœ¨åˆé€‚çš„ä¸Šä¸‹æ–‡ä¸­è¿›è¡Œçš„ã€‚è¿™å¯¹ç»´æŠ¤ Node.js åº”ç”¨ç¨‹åºçš„ç¨³å®šæ€§å’Œæ€§èƒ½è‡³å…³é‡è¦ã€‚</p><h3 id="napi-close-callback-scope" tabindex="-1"><a class="header-anchor" href="#napi-close-callback-scope"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_close_callback_scope" target="_blank" rel="noopener noreferrer">napi_close_callback_scope</a></span></a></h3><p>å¥½çš„ï¼Œæˆ‘ä¼šç›´æ¥è¿›å…¥ä¸»é¢˜ã€‚</p><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç†è§£ä¸€ä¸‹ N-API æ˜¯ä»€ä¹ˆã€‚N-API æ˜¯ä¸€ä¸ª Node.js çš„ API å±‚ï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨ C æˆ– C++ç¼–å†™å¯ä»¥ä¸ JavaScript ä»£ç äº¤äº’çš„åŸç”Ÿæ’ä»¶ã€‚é€šè¿‡ä½¿ç”¨ N-APIï¼Œä½ å¯ä»¥åˆ›å»ºæ€§èƒ½æ›´é«˜ä¸”ä¸ä¼šéš Node.js ç‰ˆæœ¬æ›´æ–°è€Œæ”¹å˜çš„æ‰©å±•ã€‚è¿™å¯¹äºæƒ³è¦åœ¨ Node.js ä¸­åˆ©ç”¨ç°æœ‰ C/C++åº“çš„å¼€å‘è€…æ¥è¯´éå¸¸æœ‰å¸®åŠ©ã€‚</p><p>å½“æˆ‘ä»¬æåˆ°<code>napi_close_callback_scope</code>ï¼Œæˆ‘ä»¬æ­£åœ¨è®¨è®º N-API çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒæ¶‰åŠåˆ°æ‰€è°“çš„â€œå›è°ƒä½œç”¨åŸŸâ€ã€‚å½“ä½ åœ¨åŸç”Ÿæ’ä»¶ä¸­è°ƒç”¨ JavaScript å‡½æ•°æˆ–ä¼ é€’æ•°æ®æ—¶ï¼ŒNode.js ä½¿ç”¨â€œå›è°ƒä½œç”¨åŸŸâ€æ¥è·Ÿè¸ªå’Œå¤„ç†è¿™äº›è°ƒç”¨ã€‚æ¯æ¬¡ä»åŸç”Ÿä»£ç è°ƒç”¨ JavaScript ä»£ç æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å›è°ƒä½œç”¨åŸŸã€‚</p><p>ç°åœ¨ï¼Œæ¥è°ˆè°ˆ<code>napi_close_callback_scope</code>å‡½æ•°æœ¬èº«ã€‚è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ç»“æŸå½“å‰çš„å›è°ƒä½œç”¨åŸŸã€‚å½“ä½ æ‰“å¼€ä¸€ä¸ªä½œç”¨åŸŸæ¥æ‰§è¡Œä¸€äº›æ“ä½œï¼Œå¹¶åœ¨æ‰€æœ‰æ“ä½œå®Œæˆåï¼Œä½ éœ€è¦å…³é—­è¿™ä¸ªä½œç”¨åŸŸï¼Œä»¥ç¡®ä¿èµ„æºå¾—åˆ°æ­£ç¡®çš„é‡Šæ”¾ã€‚è¿™å°±åƒåœ¨ç¼–ç¨‹ä¸­æ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œï¼Œä¹‹åå¿…é¡»å…³é—­å®ƒï¼Œé˜²æ­¢èµ„æºæ³„éœ²æˆ–å…¶ä»–æ½œåœ¨é—®é¢˜ã€‚</p><p>åœ¨ N-API ä¸­ï¼Œå¼€å§‹ä¸€ä¸ªæ–°çš„å›è°ƒä½œç”¨åŸŸä½ ä¼šä½¿ç”¨<code>napi_open_callback_scope</code>ï¼Œå¹¶åœ¨æ‰€æœ‰æ“ä½œå®Œæˆåï¼Œä½¿ç”¨<code>napi_close_callback_scope</code>æ¥å…³é—­å®ƒã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ä½ æœ‰ä¸€ä¸ª C++å‡½æ•°ï¼Œå®ƒå°†åœ¨æŸäº›æ¡ä»¶ä¸‹è°ƒç”¨ä¸€ä¸ª JavaScript å›è°ƒå‡½æ•°ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œä½ å¯èƒ½ä¼šè¿™æ ·åšï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status status;</span></span>
<span class="line"><span>napi_callback_scope scope;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾envæ˜¯ä½ å½“å‰çš„napiç¯å¢ƒï¼Œcbä¸ºJavaScriptå›è°ƒå‡½æ•°</span></span>
<span class="line"><span>status = napi_open_callback_scope(env, cb, &amp;scope);</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è°ƒç”¨JavaScriptä¸­çš„å›è°ƒå‡½æ•°</span></span>
<span class="line"><span>// ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å®Œæˆæ‰€æœ‰çš„è°ƒç”¨åï¼Œä½ éœ€è¦å…³é—­è¿™ä¸ªä½œç”¨åŸŸ</span></span>
<span class="line"><span>status = napi_close_callback_scope(env, scope);</span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼Œè¿™æ®µä»£ç å¹¶æœªå±•ç¤ºå®Œæ•´çš„å®ç°ç»†èŠ‚ï¼Œæ¯”å¦‚å¦‚ä½•åˆ›å»º<code>napi_env</code>ã€<code>napi_value</code>ç­‰ï¼Œä½†å®ƒç»™å‡ºäº†å¦‚ä½•åœ¨ä¸€ä¸ªç®€å•æƒ…å†µä¸‹ä½¿ç”¨<code>napi_close_callback_scope</code>æ¥ç»“æŸå›è°ƒä½œç”¨åŸŸçš„æ¦‚å¿µã€‚</p><p>æ€»ç»“ï¼Œ<code>napi_close_callback_scope</code>æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºç¡®ä¿å½“ä½ å®Œæˆä¸ JavaScript çš„äº¤äº’åï¼Œä»»ä½•ç›¸å…³çš„èµ„æºéƒ½èƒ½è¢«å¦¥å–„ç®¡ç†å’Œé‡Šæ”¾ã€‚è¿™æœ‰åŠ©äºé¿å…å†…å­˜æ³„æ¼ï¼Œç¡®ä¿ Node.js åº”ç”¨ç¨‹åºçš„ç¨³å®šæ€§å’Œæ•ˆç‡ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä»»ä½•æ—¶å€™ä½ é€šè¿‡ N-API æ‰“å¼€å›è°ƒä½œç”¨åŸŸï¼Œæœ€ç»ˆéƒ½åº”å½“å…³é—­å®ƒï¼Œä»¥ä¿æŒè‰¯å¥½çš„èµ„æºç®¡ç†ã€‚</p><h2 id="version-management" tabindex="-1"><a class="header-anchor" href="#version-management"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#version-management" target="_blank" rel="noopener noreferrer">Version management</a></span></a></h2><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶ï¼ˆnative addonsï¼‰çš„ APIã€‚åŸç”Ÿæ’ä»¶æ˜¯ç›´æ¥ä¸ Node.js è¿è¡Œæ—¶è¿›è¡Œäº¤äº’çš„ï¼Œç”¨ C æˆ– C++ ç¼–å†™çš„æ¨¡å—ã€‚N-API çš„ç›®çš„æ˜¯ä¿è¯ä¸åŒç‰ˆæœ¬çš„ Node.js ä¹‹é—´åŸç”Ÿæ’ä»¶çš„å…¼å®¹æ€§ã€‚</p><p>åœ¨ Node.js v21.7.1 çš„æ–‡æ¡£ä¸­ï¼Œâ€œVersion managementâ€é€šå¸¸æŒ‡çš„æ˜¯ N-API ç‰ˆæœ¬ç®¡ç†ã€‚æ¯å½“ Node.js å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶ï¼ŒN-API éƒ½å¯èƒ½å¼•å…¥æ–°çš„åŠŸèƒ½æˆ–è€…å˜æ›´ï¼Œè¿™å°±äº§ç”Ÿäº†ä¸åŒçš„ N-API ç‰ˆæœ¬ã€‚ä¸ºäº†ä¿æŒå‘åå…¼å®¹æ€§ï¼Œå¹¶è®©æ’ä»¶å¼€å‘è€…å¯ä»¥é’ˆå¯¹ç‰¹å®šç‰ˆæœ¬ç¼–å†™ä»£ç ï¼ŒN-API æä¾›äº†ç‰ˆæœ¬ç®¡ç†æœºåˆ¶ã€‚</p><p>å®é™…è¿ç”¨ç¤ºä¾‹ï¼š</p><ol><li><p><strong>ç¼–å†™å…¼å®¹å¤šä¸ª Node.js ç‰ˆæœ¬çš„åŸç”Ÿæ’ä»¶ï¼š</strong><br> å‡è®¾ä½ å¸Œæœ›åˆ›å»ºä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œç”¨äºæé«˜å›¾åƒå¤„ç†çš„æ€§èƒ½ã€‚ä½ ä¼šç”¨ C++ ç¼–å†™å¤„ç†å›¾åƒçš„é€»è¾‘ï¼Œå¹¶é€šè¿‡ N-API å°†è¿™äº›åŠŸèƒ½æš´éœ²ç»™ Node.js ä»£ç ã€‚åœ¨ç¼–å†™æ’ä»¶æ—¶ï¼Œä½ å¯ä»¥æŒ‡å®šä½ çš„æ’ä»¶å…¼å®¹å“ªäº› N-API ç‰ˆæœ¬ã€‚ä¾‹å¦‚ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ...ä½ çš„ C++ ä»£ç ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span>  napi_create_string_utf8(env, &quot;Hello World!&quot;, NAPI_AUTO_LENGTH, &amp;result);</span></span>
<span class="line"><span>  return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ <code>package.json</code> æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥æŒ‡æ˜ N-API çš„ç‰ˆæœ¬ï¼š</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">name</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">awesome-native-addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">version</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">1.0.0</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">main</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">index.js</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">dependencies</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">node-addon-api</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">^3.2.1</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">gypfile</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> true</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">binary</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">napi_versions</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 4</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 5</span><span style="color:#ECEFF4;">]</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™è¡¨æ˜ä½ çš„åŸç”Ÿæ’ä»¶æ˜¯ä¸ N-API ç‰ˆæœ¬ 3ã€4 å’Œ 5 å…¼å®¹çš„ã€‚</p></li><li><p><strong>æ£€æŸ¥è¿è¡Œæ—¶çš„ N-API ç‰ˆæœ¬ï¼š</strong><br> å½“ä½ çš„ Node.js åº”ç”¨å¯åŠ¨å¹¶åŠ è½½åŸç”Ÿæ’ä»¶æ—¶ï¼Œè¯¥æ’ä»¶å¯ä»¥æ£€æŸ¥å½“å‰ç¯å¢ƒä¸‹çš„ N-API ç‰ˆæœ¬æ˜¯å¦ç¬¦åˆå…¶å…¼å®¹æ€§éœ€æ±‚ã€‚å¦‚æœä¸ç¬¦åˆï¼Œä½ å¯ä»¥é€‰æ‹©è¾“å‡ºé”™è¯¯æ¶ˆæ¯æˆ–è€…é‡‡å–å…¶ä»–æªæ–½ã€‚</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>  // æ£€æŸ¥å½“å‰ç¯å¢ƒä¸­æ”¯æŒçš„ N-API ç‰ˆæœ¬</span></span>
<span class="line"><span>  uint32_t napi_version = 0;</span></span>
<span class="line"><span>  napi_get_version(env, &amp;napi_version);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (napi_version `&lt;` 3) {</span></span>
<span class="line"><span>    // å¦‚æœ N-API ç‰ˆæœ¬å°äº3ï¼ŒæŠ›å‡ºé”™è¯¯</span></span>
<span class="line"><span>    napi_throw_error(env, NULL, &quot;N-API version 3 or higher is required for this addon&quot;);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ...åˆå§‹åŒ–æ’ä»¶...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>è¿™æ ·çš„ç‰ˆæœ¬ç®¡ç†ä½¿å¾—å³ä½¿ Node.js æ›´æ–°äº†ï¼Œåªè¦ä¸è¶…å‡ºä½ å£°æ˜çš„ N-API ç‰ˆæœ¬èŒƒå›´ï¼Œä½ çš„åŸç”Ÿæ’ä»¶ä»åº”è¯¥èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œæ— éœ€ä¿®æ”¹ä»£ç ã€‚è¿™å¤§å¤§é™ä½äº†ç»´æŠ¤æˆæœ¬ï¼Œå¹¶æé«˜äº†åŸç”Ÿæ’ä»¶çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼ŒN-API çš„ç‰ˆæœ¬ç®¡ç†æ˜¯ Node.js æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œå®ƒæ—¨åœ¨ç¡®ä¿åŸç”Ÿæ’ä»¶è·¨ä¸åŒ Node.js ç‰ˆæœ¬çš„å…¼å®¹æ€§ï¼Œè€Œæ— éœ€é¢‘ç¹åœ°å¯¹æ’ä»¶ä»£ç è¿›è¡Œæ›´æ–°ã€‚é€šè¿‡ä½¿ç”¨è¿™ç§æœºåˆ¶ï¼Œæ’ä»¶å¼€å‘è€…å¯ä»¥æ›´å®¹æ˜“åœ°ç»´æŠ¤å’Œåˆ†å‘ä»–ä»¬çš„ä»£ç ï¼Œå¹¶ç¡®ä¿æœ€ç»ˆç”¨æˆ·æœ‰æ›´åŠ å¹³æ»‘çš„ä½“éªŒã€‚</p><h3 id="napi-get-node-version" tabindex="-1"><a class="header-anchor" href="#napi-get-node-version"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_node_version" target="_blank" rel="noopener noreferrer">napi_get_node_version</a></span></a></h3><p>å¥½çš„ï¼Œæˆ‘ä¼šç›´æ¥å›ç­”ä½ çš„é—®é¢˜ã€‚</p><p>Node.js ä¸­çš„ <code>napi_get_node_version</code> å‡½æ•°æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼ŒN-API æ˜¯ä¸€ä¸ªç¨³å®šçš„ Node.js API å±‚ï¼Œå®ƒå…è®¸æœ¬åœ°æ’ä»¶çš„å¼€å‘è€…ç¼–å†™èƒ½å¤Ÿåœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸Šè¿è¡Œçš„ä»£ç ï¼Œè€Œä¸éœ€è¦å¯¹æ¯ä¸ªç‰ˆæœ¬é‡ç¼–è¯‘ã€‚</p><p>å½“ä½ ä½¿ç”¨ <code>napi_get_node_version</code> è¿™ä¸ªå‡½æ•°æ—¶ï¼Œå®ƒå¯ä»¥è®©ä½ è·å–å½“å‰æ­£åœ¨è¿è¡Œçš„ Node.js çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚è¿™åŒ…æ‹¬ä¸»ç‰ˆæœ¬å·ã€æ¬¡ç‰ˆæœ¬å·å’Œä¿®è®¢å·ã€‚è¿™å¯¹äºç¡®ä¿ä½ çš„æœ¬åœ°æ’ä»¶ä¸ç‰¹å®šç‰ˆæœ¬çš„ Node.js å…¼å®¹éå¸¸æœ‰ç”¨ã€‚</p><p>å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_get_node_version(napi_env env,</span></span>
<span class="line"><span>                                  const napi_node_version** version);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code> æ˜¯ä¸€ä¸ªè¡¨ç¤º N-API ç¯å¢ƒçš„å¥æŸ„ã€‚</li><li><code>version</code> æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>napi_node_version</code> ç»“æ„ä½“çš„æŒ‡é’ˆçš„æŒ‡é’ˆï¼Œè¿™ä¸ªç»“æ„ä½“å°†ä¼šè¢«å¡«å……ä¸ºå½“å‰ Node.js ç‰ˆæœ¬ä¿¡æ¯ã€‚</li></ul><p><code>napi_node_version</code> ç»“æ„ä½“é€šå¸¸å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>typedef struct {</span></span>
<span class="line"><span>  uint32_t major;</span></span>
<span class="line"><span>  uint32_t minor;</span></span>
<span class="line"><span>  uint32_t patch;</span></span>
<span class="line"><span>  const char* release;</span></span>
<span class="line"><span>} napi_node_version;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>major</code> è¡¨ç¤ºä¸»ç‰ˆæœ¬å·ã€‚</li><li><code>minor</code> è¡¨ç¤ºæ¬¡ç‰ˆæœ¬å·ã€‚</li><li><code>patch</code> è¡¨ç¤ºä¿®è®¢å·ã€‚</li><li><code>release</code> æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºé¢„å‘å¸ƒç‰ˆæœ¬æ ‡ç­¾æˆ–ç©ºå­—ç¬¦ä¸²ã€‚</li></ul><p>è°ƒç”¨ <code>napi_get_node_version</code> å¹¶å¤„ç†è¿”å›ç»“æœçš„ç®€å•ç¤ºä¾‹ä»£ç ç‰‡æ®µå¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼ˆC è¯­è¨€ï¼‰ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span>// ... å…¶ä»–å¿…è¦çš„å¤´æ–‡ä»¶ ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_env env; // å‡è®¾å·²ç»åˆå§‹åŒ–äº† N-API ç¯å¢ƒå˜é‡env</span></span>
<span class="line"><span>const napi_node_version* node_version;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_status status = napi_get_node_version(env, &amp;node_version);</span></span>
<span class="line"><span>if (status == napi_ok) {</span></span>
<span class="line"><span>  printf(&quot;Node.js version: %d.%d.%d\n&quot;,</span></span>
<span class="line"><span>    node_version-&gt;major,</span></span>
<span class="line"><span>    node_version-&gt;minor,</span></span>
<span class="line"><span>    node_version-&gt;patch);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  if (node_version-&gt;release[0]) {</span></span>
<span class="line"><span>    printf(&quot;Pre-release tag: %s\n&quot;, node_version-&gt;release);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>} else {</span></span>
<span class="line"><span>  // å¤„ç†é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ä½ è¿è¡Œè¿™æ®µä»£ç æ—¶ï¼Œå®ƒä¼šè¾“å‡ºç±»ä¼¼ &quot;Node.js version: 14.15.1&quot; çš„ä¿¡æ¯ï¼Œæ ¹æ®ä½ è¿è¡Œçš„ Node.js ç‰ˆæœ¬ä¸åŒï¼Œæ‰“å°å‡ºæ¥çš„ç‰ˆæœ¬å·ä¹Ÿä¼šä¸åŒã€‚</p><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥ç¡®å®šæ˜¯å¦æŸäº›ç‰¹å®šåŠŸèƒ½åœ¨å½“å‰è¿è¡Œçš„ Node.js ç‰ˆæœ¬ä¸­å¯ç”¨ï¼Œæˆ–è€…å¦‚æœä½ åœ¨å¼€å‘ä¸€ä¸ªéœ€è¦ä¸å¤šä¸ª Node.js ç‰ˆæœ¬å…¼å®¹çš„æœ¬åœ°æ¨¡å—ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥é€‚é…ä¸åŒçš„ç‰ˆæœ¬ã€‚</p><h3 id="napi-get-version" tabindex="-1"><a class="header-anchor" href="#napi-get-version"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_version" target="_blank" rel="noopener noreferrer">napi_get_version</a></span></a></h3><p><code>napi_get_version</code>æ˜¯ Node.js ä¸­ N-APIï¼ˆå³ Node APIï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚åŸç”Ÿæ’ä»¶é€šå¸¸æ˜¯ç”¨ C æˆ– C++ç¼–å†™çš„æ¨¡å—ï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿå±‚é¢ï¼Œå› æ­¤æ€§èƒ½é«˜æ•ˆã€‚</p><p>åœ¨äº†è§£<code>napi_get_version</code>ä¹‹å‰ï¼Œå…ˆç®€è¦ä»‹ç»ä¸€ä¸‹ N-APIï¼š</p><p><strong>ä»€ä¹ˆæ˜¯ N-API?</strong></p><p>N-API æ˜¯ Node.js çš„ä¸€ä¸ªç¨³å®šç‰¹æ€§ï¼Œå…è®¸å¼€å‘è€…ç”¨ C æˆ– C++ç¼–å†™ä¸ Node.js äº¤äº’çš„ä»£ç ï¼Œè€Œä¸å¿…æ‹…å¿ƒ Node.js å’Œ V8 å¼•æ“ä¹‹é—´çš„å˜åŠ¨ã€‚è¿™æä¾›äº†ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œä½¿å¾—ç¼–å†™çš„åŸç”Ÿæ’ä»¶å¯ä»¥è·¨ Node.js çš„ä¸åŒç‰ˆæœ¬è¿è¡Œï¼Œå‡å°‘äº†å› ç‰ˆæœ¬å˜æ›´è€Œå¯¼è‡´çš„ç»´æŠ¤è´Ÿæ‹…ã€‚</p><p><strong>é‚£ä¹ˆ<code>napi_get_version</code>æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</strong></p><p><code>napi_get_version</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå…è®¸å¼€å‘è€…åœ¨ä»–ä»¬çš„åŸç”Ÿæ¨¡å—ä¸­æŸ¥è¯¢æ­£åœ¨ä½¿ç”¨çš„ N-API çš„ç‰ˆæœ¬å·ã€‚ä½¿ç”¨è¿™ä¸ªå‡½æ•°å¯ä»¥ç¡®ä¿åŸç”Ÿæ¨¡å—èƒ½å¤Ÿæ£€æŸ¥å®ƒæ‰€æ”¯æŒçš„ N-API ç‰ˆæœ¬æ˜¯å¦ä¸å½“å‰ç¯å¢ƒå…¼å®¹ã€‚</p><p><strong>å¦‚ä½•ä½¿ç”¨<code>napi_get_version</code>?</strong></p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œå¹¶ä¸”æƒ³è¦ç¡®è®¤ä½ æ”¯æŒçš„æœ€ä½ N-API ç‰ˆæœ¬æ˜¯å¦è¢«å½“å‰çš„ Node.js ç¯å¢ƒæ”¯æŒã€‚ä½ å¯ä»¥è°ƒç”¨<code>napi_get_version</code>æ¥è·å–è¿™ä¸ªä¿¡æ¯ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åœ¨ C ä»£ç ä¸­è°ƒç”¨<code>napi_get_version</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>  // æ­¤å¤„å£°æ˜ç‰ˆæœ¬å·çš„å˜é‡</span></span>
<span class="line"><span>  uint32_t napi_version;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è°ƒç”¨napi_get_versionè·å–å½“å‰çš„N-APIç‰ˆæœ¬å·</span></span>
<span class="line"><span>  napi_status status = napi_get_version(env, &amp;napi_version);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ£€æŸ¥è°ƒç”¨æ˜¯å¦æˆåŠŸ</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ç°åœ¨å¯ä»¥æ ¹æ®å¾—åˆ°çš„ç‰ˆæœ¬å·napi_versionè¿›è¡Œé€»è¾‘å¤„ç†äº†</span></span>
<span class="line"><span>  // æ¯”å¦‚ï¼Œæ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦æ»¡è¶³ä½ çš„åŸç”Ÿæ¨¡å—æ‰€éœ€çš„æœ€å°ç‰ˆæœ¬</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º<code>Init</code>çš„åˆå§‹åŒ–å‡½æ•°ï¼Œå®ƒå°†åœ¨æ¨¡å—åŠ è½½æ—¶è¢«è°ƒç”¨ã€‚åœ¨è¿™ä¸ªå‡½æ•°é‡Œï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨<code>napi_get_version</code>è·å¾—äº†å½“å‰ç¯å¢ƒçš„ N-API ç‰ˆæœ¬å¹¶å­˜å‚¨åœ¨å˜é‡<code>napi_version</code>ä¸­ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™ä¸ªç‰ˆæœ¬å·æ¥å†³å®šæ˜¯å¦éœ€è¦æ‰§è¡ŒæŸäº›ç‰¹å®šçš„è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬çš„æ¨¡å—éœ€è¦è‡³å°‘ç¬¬ 3 ç‰ˆçš„ N-APIï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥æ¯”è¾ƒ<code>napi_version</code>å’Œæ•°å­— 3ï¼Œä»¥ç¡®å®šæ˜¯å¦ç»§ç»­æˆ–æä¾›é”™è¯¯æ¶ˆæ¯ã€‚</p><p>è¿™æ ·çš„ç‰ˆæœ¬æ£€æŸ¥æ˜¯å¾ˆé‡è¦çš„ï¼Œå› ä¸ºå®ƒæœ‰åŠ©äºç¡®ä¿ä½ çš„ä»£ç åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸Šéƒ½èƒ½æ­£å¸¸å·¥ä½œï¼Œä»è€Œæé«˜ä»£ç çš„å¯é æ€§å’Œç¨³å®šæ€§ã€‚</p><h2 id="memory-management" tabindex="-1"><a class="header-anchor" href="#memory-management"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#memory-management" target="_blank" rel="noopener noreferrer">Memory management</a></span></a></h2><p>åœ¨ Node.js ä¸­ï¼Œå†…å­˜ç®¡ç†æ˜¯æŒ‡å¦‚ä½•åˆ†é…ã€ä½¿ç”¨å’Œé‡Šæ”¾å†…å­˜èµ„æºã€‚Node.js v21.7.1 çš„æ–‡æ¡£ä¸­å…³äºâ€œå†…å­˜ç®¡ç†â€é€šå¸¸ä¼šæåˆ° N-APIï¼Œè¿™æ˜¯ Node.js æä¾›ç»™ C å’Œ C++æ‰©å±•çš„ä¸€ä¸ª API æ¥å£ï¼Œå®ƒå…è®¸è¿™äº›è¯­è¨€ç¼–å†™çš„ä»£ç ä¸ Node.js äº¤äº’ã€‚</p><p>ç†è§£å†…å­˜ç®¡ç†çš„é‡è¦æ€§ï¼Œåœ¨äºé˜²æ­¢å†…å­˜æ³„æ¼ï¼ˆç¨‹åºä¸éœ€è¦çš„å†…å­˜æ²¡æœ‰è¢«é‡Šæ”¾æ‰ï¼‰å’Œæœ‰æ•ˆåœ°ä½¿ç”¨å†…å­˜èµ„æºã€‚ä¸‹é¢æˆ‘ä¼šç”¨ä¸€äº›ä¾‹å­æ¥è§£é‡Šåœ¨ Node.js ä¸­å†…å­˜ç®¡ç†çš„ä¸€äº›æ¦‚å¿µå’Œå®è·µã€‚</p><h3 id="_1-buffer-å’Œ-typedarray" tabindex="-1"><a class="header-anchor" href="#_1-buffer-å’Œ-typedarray"><span>1. Buffer å’Œ TypedArray</span></a></h3><p>åœ¨ Node.js ä¸­å¤„ç†åŸå§‹äºŒè¿›åˆ¶æ•°æ®æ—¶ä¼šä½¿ç”¨<code>Buffer</code>ç±»æˆ–è€…<code>TypedArray</code>ã€‚<code>Buffer</code>æ˜¯ Node.js ç‰¹æœ‰çš„å…¨å±€å¯¹è±¡ï¼Œè€Œ<code>TypedArray</code>æ˜¯ JavaScript çš„ä¸€éƒ¨åˆ†ã€‚æ¯”å¦‚ï¼Œå½“ä½ ä»ç½‘ç»œæ¥æ”¶æ•°æ®æˆ–è€…è¯»å–æ–‡ä»¶æ—¶ï¼Œè¿™äº›æ•°æ®é€šå¸¸ä¼šè¢«å­˜å‚¨åœ¨<code>Buffer</code>å¯¹è±¡ä¸­ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å¼‚æ­¥è¯»å–æ–‡ä»¶å†…å®¹åˆ°Buffer</span></span>
<span class="line"><span style="color:#D8DEE9;">fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">readFile</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/path/to/file</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> data</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">throw</span><span style="color:#D8DEE9;"> err</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // dataæ˜¯ä¸€ä¸ªBufferå¯¹è±¡ï¼ŒåŒ…å«äº†æ–‡ä»¶çš„äºŒè¿›åˆ¶æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-åƒåœ¾å›æ”¶-garbage-collection" tabindex="-1"><a class="header-anchor" href="#_2-åƒåœ¾å›æ”¶-garbage-collection"><span>2. åƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼‰</span></a></h3><p>JavaScript å’Œ Node.js ä¸­çš„å†…å­˜å¤§å¤šæ˜¯è‡ªåŠ¨ç®¡ç†çš„ã€‚æ„å‘³ç€åˆ›å»ºçš„å˜é‡å’Œå¯¹è±¡åœ¨ä¸å†ä½¿ç”¨åï¼Œä¼šç”± JavaScript çš„åƒåœ¾å›æ”¶å™¨(GC)è‡ªåŠ¨æ¸…ç†ã€‚ä½†æ˜¯ï¼Œåœ¨ä½¿ç”¨ C/C++ç¼–å†™çš„åŸç”Ÿæ‰©å±•æ¨¡å—æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†å†…å­˜ã€‚</p><p>ä¾‹å¦‚ï¼Œå¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªåŸç”Ÿçš„å¯¹è±¡ï¼ŒNode.js å°±ä¸çŸ¥é“ä½•æ—¶è¯¥æ¸…ç†è¿™ä¸ªå¯¹è±¡å ç”¨çš„å†…å­˜ã€‚å› æ­¤ï¼ŒN-API æä¾›äº†ä¸€ç³»åˆ—çš„å‡½æ•°æ¥å¸®åŠ©å¼€å‘è€…ç¡®ä¿è¿™éƒ¨åˆ†å†…å­˜å¾—åˆ°åˆé€‚çš„å¤„ç†ã€‚</p><h3 id="_3-n-api-ä¸­çš„å†…å­˜ç®¡ç†å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_3-n-api-ä¸­çš„å†…å­˜ç®¡ç†å‡½æ•°"><span>3. N-API ä¸­çš„å†…å­˜ç®¡ç†å‡½æ•°</span></a></h3><p>å¯¹äºä½¿ç”¨ N-API çš„æ‰©å±•æ¨¡å—ï¼ŒNode.js æä¾›äº†ä¸€äº› API æ¥å¸®åŠ©å¼€å‘è€…ç®¡ç†å†…å­˜ï¼š</p><ul><li><code>napi_create_external()</code>: åˆ›å»ºä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«å¤–éƒ¨åˆ†é…çš„æ•°æ®ã€‚</li><li><code>napi_create_external_buffer()</code>: ä¸ºä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ•°æ®åˆ›å»ºä¸€ä¸ª Buffer å¯¹è±¡ã€‚</li><li><code>napi_create_external_arraybuffer()</code>: åˆ›å»ºä¸€ä¸ª ArrayBufferï¼Œå…¶æ•°æ®æ˜¯å¤–éƒ¨æä¾›çš„ã€‚</li><li><code>napi_ref</code>: åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ä»¥é¿å…å®ƒè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚</li><li><code>napi_unref</code>: åˆ é™¤ä¹‹å‰è®¾ç½®çš„å¼•ç”¨ã€‚</li></ul><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ C++æ‰©å±•ï¼Œå¹¶å¸Œæœ›å°†ä¸€äº› C++åˆ›å»ºçš„æ•°æ®ä¼ ç»™ JavaScriptï¼Œå¯ä»¥ä½¿ç”¨<code>napi_create_external()</code>ã€‚è¿™æ ·ï¼Œä½ å°±èƒ½åœ¨ JS ä¸­ä½¿ç”¨è¿™äº›æ•°æ®ï¼ŒåŒæ—¶ç¡®ä¿åœ¨æ•°æ®ä¸å†éœ€è¦æ—¶èƒ½å¤Ÿæ­£ç¡®åœ°é‡Šæ”¾å†…å­˜ã€‚</p><h3 id="å®é™…åº”ç”¨çš„ä¾‹å­-åˆ›å»ºä¸€ä¸ªå¤–éƒ¨-buffer" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨çš„ä¾‹å­-åˆ›å»ºä¸€ä¸ªå¤–éƒ¨-buffer"><span>å®é™…åº”ç”¨çš„ä¾‹å­ - åˆ›å»ºä¸€ä¸ªå¤–éƒ¨ Buffer</span></a></h3><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åœ¨ä¸€ä¸ª N-API æ¨¡å—ä¸­åˆ›å»ºå¤–éƒ¨ Bufferï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå¤–éƒ¨åˆ†é…çš„æ•°æ®æº</span></span>
<span class="line"><span>char* external_data = (char*)malloc(1024);</span></span>
<span class="line"><span>size_t external_data_length = 1024;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯ä¸€ä¸ªç”¨æ¥åˆ›å»ºå¤–éƒ¨Bufferçš„å‡½æ•°</span></span>
<span class="line"><span>napi_value CreateExternalBuffer(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  napi_value buffer;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ªBufferï¼Œå®ƒå¼•ç”¨äº†å¤–éƒ¨åˆ†é…çš„æ•°æ®</span></span>
<span class="line"><span>  napi_create_external_buffer(env,</span></span>
<span class="line"><span>                              external_data_length,</span></span>
<span class="line"><span>                              external_data,</span></span>
<span class="line"><span>                              NULL, // å¯é€‰çš„ï¼Œå½“Bufferè¢«GCæ—¶è°ƒç”¨çš„finalizeå›è°ƒ</span></span>
<span class="line"><span>                              NULL, // finalizeå›è°ƒçš„hintå‚æ•°</span></span>
<span class="line"><span>                              &amp;buffer);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return buffer;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åœ¨æ¨¡å—åˆå§‹åŒ–æ—¶æ³¨å†Œè¿™ä¸ªå‡½æ•°</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>  napi_value externalBufferFunction;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å°†CreateExternalBufferå‡½æ•°æš´éœ²ç»™JavaScript</span></span>
<span class="line"><span>  napi_create_function(env,</span></span>
<span class="line"><span>                       &quot;createExternalBuffer&quot;,</span></span>
<span class="line"><span>                       NAPI_AUTO_LENGTH,</span></span>
<span class="line"><span>                       CreateExternalBuffer,</span></span>
<span class="line"><span>                       NULL,</span></span>
<span class="line"><span>                       &amp;externalBufferFunction);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è®¾ç½®å¯¼å‡ºçš„å±æ€§</span></span>
<span class="line"><span>  napi_set_named_property(env, exports, &quot;createExternalBuffer&quot;, externalBufferFunction);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ C ä»£ç åˆ›å»ºäº†ä¸€ä¸ªå¤–éƒ¨æ•°æ®æºå’Œä¸€ä¸ªå‡½æ•°<code>CreateExternalBuffer</code>ï¼Œç„¶åå°†è¿™ä¸ªå‡½æ•°æš´éœ²ç»™äº† JavaScriptã€‚å½“ JavaScript ä»£ç è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª Node.js çš„<code>Buffer</code>å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å¼•ç”¨äº†é‚£å—å¤–éƒ¨åˆ†é…çš„å†…å­˜ã€‚è¿™æ ·å°±å¯ä»¥åœ¨ Node.js ä¸­ç›´æ¥æ“ä½œè¿™äº›æ•°æ®ï¼Œè€Œä¸éœ€è¦å¤åˆ¶å®ƒä»¬ã€‚æ³¨æ„ï¼Œå½“ä½ è¿™æ ·åšçš„æ—¶å€™ï¼Œå¿…é¡»ç¡®ä¿åœ¨ JavaScript å±‚é¢ä¸Šä¸å†éœ€è¦è¿™ä¸ª Buffer æ—¶ï¼Œç›¸åº”çš„å†…å­˜ä¹Ÿè¢«é‡Šæ”¾äº†ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œå†…å­˜ç®¡ç†æ˜¯ä¸€é¡¹ç¨‹åºå‘˜å¿…é¡»å…³å¿ƒçš„è¯é¢˜ï¼Œå°¤å…¶æ˜¯åœ¨æ¶‰åŠåˆ°æœ¬æœºæ‰©å±•çš„æ—¶å€™ã€‚æ­£ç¡®çš„å†…å­˜ç®¡ç†å¯ä»¥é¿å…å†…å­˜æ³„æ¼ï¼Œæé«˜ç¨‹åºç¨³å®šæ€§å’Œæ€§èƒ½ã€‚</p><h3 id="napi-adjust-external-memory" tabindex="-1"><a class="header-anchor" href="#napi-adjust-external-memory"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_adjust_external_memory" target="_blank" rel="noopener noreferrer">napi_adjust_external_memory</a></span></a></h3><p>Node.js ä¸­çš„<code>napi_adjust_external_memory</code>å‡½æ•°æ˜¯ä¸€ä¸ªç”¨äºé€šçŸ¥ V8 å¼•æ“è°ƒæ•´å…¶è·Ÿè¸ªçš„å¤–éƒ¨å†…å­˜ä½¿ç”¨æƒ…å†µçš„ APIã€‚è¿™ä¸ªå‡½æ•°å±äº Node.js çš„ N-APIï¼Œå®ƒæ˜¯ä¸€ä¸ªç¨³å®šçš„ API å±‚é¢ï¼Œå…è®¸åŸç”Ÿæ¨¡å—çš„ä½œè€…ç¼–å†™ä¸ Node.js ç‰ˆæœ¬æ— å…³çš„ä»£ç ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£å‡ ä¸ªæ¦‚å¿µï¼š</p><ol><li><strong>V8 å¼•æ“</strong>ï¼šè¿™æ˜¯ Node.js åº•å±‚ä½¿ç”¨çš„ JavaScript å¼•æ“ï¼Œè´Ÿè´£æ‰§è¡Œ JavaScript ä»£ç ã€‚</li><li><strong>N-API</strong>ï¼šè¿™æ˜¯ Node.js æä¾›çš„ä¸€ç»„ C è¯­è¨€çš„ APIï¼Œå…è®¸å¼€å‘è€…ç¼–å†™æœ¬åœ°æ’ä»¶ã€‚è¿™äº›æ’ä»¶å¯ä»¥ç›´æ¥ä¸ Node.js åº•å±‚è¿›è¡Œäº¤äº’ï¼Œæ€§èƒ½é«˜æ•ˆï¼Œå¹¶ä¸”ä¸ä¾èµ–äº Node.js ç‰ˆæœ¬ã€‚</li><li><strong>å¤–éƒ¨å†…å­˜</strong>ï¼šåœ¨åˆ›å»ºåŸç”Ÿæ’ä»¶æ—¶ï¼Œå¯èƒ½ä¼šä½¿ç”¨åˆ°é V8 ç®¡ç†çš„å†…å­˜èµ„æºï¼Œæ¯”å¦‚é€šè¿‡ C/C++åˆ†é…çš„å†…å­˜ã€‚è¿™éƒ¨åˆ†å†…å­˜å¯¹äº V8 æ¥è¯´æ˜¯â€œå¤–éƒ¨â€çš„ï¼Œå› ä¸º V8 çš„åƒåœ¾å›æ”¶å™¨æ— æ³•ç›´æ¥ç®¡ç†è¿™äº›å†…å­˜ã€‚</li></ol><p>ç°åœ¨ï¼Œæ¥å…·ä½“çœ‹<code>napi_adjust_external_memory</code>ï¼š</p><p>è¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨é€”æ˜¯æ‰‹åŠ¨å‘Šè¯‰ V8ï¼Œæœ‰å¤šå°‘å¤–éƒ¨å†…å­˜æ­£åœ¨è¢«ä½¿ç”¨ã€‚å› ä¸º V8 è‡ªå·±çš„åƒåœ¾å›æ”¶å™¨å¹¶ä¸çŸ¥é“è¿™äº›å¤–éƒ¨å†…å­˜çš„å­˜åœ¨ï¼Œæ²¡æœ‰è¿™ä¸ªä¿¡æ¯ï¼ŒV8 å¯èƒ½å°±ä¸ä¼šåŠæ—¶åœ°è¿›è¡Œåƒåœ¾æ”¶é›†ï¼Œä»è€Œå¯¼è‡´ Node.js è¿›ç¨‹ä½¿ç”¨çš„æ€»å†…å­˜è¿‡å¤§ã€‚</p><p><code>napi_adjust_external_memory</code>çš„ä½¿ç”¨æ–¹æ³•å¤§è‡´å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åœ¨æŸä¸ªå‡½æ•°å†…éƒ¨ï¼Œä½ å·²ç»åˆ†é…äº†ä¸€äº›å¤–éƒ¨å†…å­˜ï¼š</span></span>
<span class="line"><span>void* buffer = malloc(1024); // åˆ†é…äº†1024å­—èŠ‚çš„å†…å­˜</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ç„¶åä½ éœ€è¦é€šçŸ¥V8è¿™1024å­—èŠ‚çš„å¤–éƒ¨å†…å­˜å·²ç»è¢«ä½¿ç”¨</span></span>
<span class="line"><span>int64_t change_in_bytes = 1024;</span></span>
<span class="line"><span>int64_t adjusted_value;</span></span>
<span class="line"><span>napi_status status = napi_adjust_external_memory(env, change_in_bytes, &amp;adjusted_value);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (status != napi_ok) {</span></span>
<span class="line"><span>  // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼š</p><ul><li><code>buffer</code>æ˜¯é€šè¿‡ malloc åˆ†é…çš„å †å†…å­˜ï¼Œå®ƒåœ¨ C/C++çš„é¢†åŸŸï¼Œä½†å¯¹ V8 å¼•æ“æ¥è¯´æ˜¯å¤–éƒ¨çš„ã€‚</li><li>é€šè¿‡è°ƒç”¨<code>napi_adjust_external_memory</code>ï¼Œæˆ‘ä»¬å‘Šè¯‰ V8 æœ‰ 1024 å­—èŠ‚çš„å¤–éƒ¨å†…å­˜è¢«ä½¿ç”¨ã€‚</li><li><code>change_in_bytes</code>å‚æ•°æ˜¯æˆ‘ä»¬åˆšåˆšåˆ†é…æˆ–è€…é‡Šæ”¾çš„å†…å­˜é‡ã€‚</li><li><code>adjusted_value</code>ä¼šè¿”å›è°ƒæ•´å V8 å½“å‰è·Ÿè¸ªçš„å¤–éƒ¨å†…å­˜æ€»é‡ã€‚</li><li>æˆ‘ä»¬ä¹Ÿæ£€æŸ¥<code>status</code>å˜é‡ä»¥ç¡®ä¿è°ƒç”¨æˆåŠŸã€‚</li></ul><p><strong>å®é™…åº”ç”¨ç¤ºä¾‹ï¼š</strong></p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js çš„åŸç”Ÿæ‹“å±•ï¼Œè¯¥æ‹“å±•éœ€è¦å¤„ç†å›¾åƒã€‚åœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œä½ å¯èƒ½ä¼šåˆ†é…å¤§é‡å†…å­˜æ¥å­˜å‚¨å›¾åƒæ•°æ®ã€‚å¦‚æœå¤„ç†å¤šå¼ å›¾åƒï¼Œé‚£ä¹ˆåˆ†é…çš„å†…å­˜å°†ä¼šç›¸å½“å¯è§‚ã€‚ä½¿ç”¨<code>napi_adjust_external_memory</code>å°±å¯ä»¥å‘Šè¯‰ V8 å¼•æ“è¿™ä¸ªæƒ…å†µï¼Œä»¥ä¾¿ V8 å¯ä»¥åœ¨åˆé€‚çš„æ—¶å€™è¿è¡Œåƒåœ¾æ”¶é›†å™¨ï¼Œé¿å…åº”ç”¨ç¨‹åºæ¶ˆè€—è¿‡å¤šå†…å­˜ã€‚</p><p>æ­£ç¡®ä½¿ç”¨è¿™ä¸ª API æœ‰åŠ©äºæ”¹å–„ Node.js åº”ç”¨çš„æ€§èƒ½å’Œå†…å­˜ç®¡ç†ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§é‡æ•°æ®ä¸”ä¸å¸Œæœ›å½±å“ V8 åƒåœ¾å›æ”¶è¡Œä¸ºæ—¶ã€‚</p><h2 id="promises" tabindex="-1"><a class="header-anchor" href="#promises"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#promises" target="_blank" rel="noopener noreferrer">Promises</a></span></a></h2><p>Node.js æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨æœåŠ¡å™¨ç«¯çš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨ JavaScript æ¥ç¼–å†™å¯ä»¥å¤„ç†æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œé€šä¿¡ç­‰åç«¯ä»»åŠ¡çš„ç¨‹åºã€‚è€Œ Promises æ˜¯ Node.jsï¼ˆä»¥åŠç°ä»£ JavaScriptï¼‰ä¸­ç”¨äºå¤„ç†å¼‚æ­¥æ“ä½œçš„ä¸€ç§æœºåˆ¶ã€‚</p><p>åœ¨æ·±å…¥è§£é‡Š Promises ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£â€œå¼‚æ­¥â€è¿™ä¸ªæ¦‚å¿µã€‚åœ¨ç¼–ç¨‹ä¸­ï¼Œâ€œå¼‚æ­¥æ“ä½œâ€æŒ‡çš„æ˜¯ä¸ä¼šç«‹å³å®Œæˆçš„æ“ä½œï¼Œä¾‹å¦‚è¯»å–æ–‡ä»¶ã€æŸ¥è¯¢æ•°æ®åº“æˆ–å‘èµ·ç½‘ç»œè¯·æ±‚ã€‚å› ä¸ºè¿™äº›æ“ä½œå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´æ¥å®Œæˆï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬åŒæ­¥åœ°ï¼ˆæŒ‰é¡ºåºä¸€æ­¥æ¥ä¸€æ­¥åœ°ï¼‰ç­‰å¾…å®ƒä»¬å®Œæˆï¼Œé‚£ä¹ˆç¨‹åºçš„å…¶ä»–éƒ¨åˆ†å°±ä¼šè¢«é˜»å¡ï¼Œæ— æ³•æ‰§è¡Œã€‚ä¸ºäº†æé«˜æ•ˆç‡å’Œç”¨æˆ·ä½“éªŒï¼Œæˆ‘ä»¬éœ€è¦å¼‚æ­¥åœ°å¤„ç†è¿™äº›æ“ä½œã€‚</p><p>Promises å°±æ˜¯ä¸ºäº†ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹è€Œç”Ÿçš„ã€‚ä¸€ä¸ª Promise æ˜¯ä¸€ä¸ªä»£è¡¨æœªæ¥å°†è¦ç»“æŸçš„äº‹ä»¶çš„å¯¹è±¡ã€‚å®ƒæœ‰ä¸‰ç§çŠ¶æ€ï¼š</p><ol><li><strong>Pendingï¼ˆè¿›è¡Œä¸­ï¼‰</strong>ï¼šåˆå§‹çŠ¶æ€ï¼Œæ—¢æ²¡æœ‰è¢«å…‘ç°ï¼Œä¹Ÿæ²¡æœ‰è¢«æ‹’ç»ã€‚</li><li><strong>Fulfilledï¼ˆå·²å…‘ç°ï¼‰</strong>ï¼šæ„å‘³ç€æ“ä½œæˆåŠŸå®Œæˆã€‚</li><li><strong>Rejectedï¼ˆå·²æ‹’ç»ï¼‰</strong>ï¼šæ„å‘³ç€æ“ä½œå¤±è´¥ã€‚</li></ol><p>Promise å¯¹è±¡ç”¨ <code>.then()</code> å’Œ <code>.catch()</code> æ–¹æ³•æ¥å¤„ç†è¿™äº›çŠ¶æ€ã€‚<code>.then()</code> æ¥æ”¶ä¸¤ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯å½“ Promise çŠ¶æ€å˜ä¸º Fulfilled æ—¶è°ƒç”¨çš„ï¼Œç¬¬äºŒä¸ªæ˜¯å½“ Promise çŠ¶æ€å˜ä¸º Rejected æ—¶è°ƒç”¨çš„ã€‚<code>.catch()</code> åˆ™æ˜¯ä¸“é—¨ç”¨æ¥æ•è· Promise å¦‚æœå¤„äº Rejected çŠ¶æ€çš„æƒ…å†µã€‚</p><p>ä¸‹é¢æ˜¯ä¸€äº›å®é™…è¿ç”¨çš„ä¾‹å­ï¼š</p><h3 id="ä¾‹å­-1-è¯»å–æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-è¯»å–æ–‡ä»¶"><span>ä¾‹å­ 1ï¼šè¯»å–æ–‡ä»¶</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">promises</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // Node.js æ–‡ä»¶ç³»ç»Ÿæ¨¡å—çš„ Promise ç‰ˆæœ¬</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// å¼‚æ­¥è¯»å–ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹</span></span>
<span class="line"><span style="color:#D8DEE9;">fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">readFile</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">example.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">utf8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // æˆåŠŸè¯»å–åï¼Œè¾“å‡ºæ–‡ä»¶å†…å®¹</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å¦‚æœè¯»å–å¤±è´¥ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>fs.readFile</code> æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œå®ƒè¿”å›ä¸€ä¸ª Promiseã€‚å¦‚æœæ–‡ä»¶è¯»å–æˆåŠŸï¼ŒPromise å˜ä¸º Fulfilled çŠ¶æ€ï¼Œå¹¶ä¸” <code>.then()</code> ä¸­çš„å‡½æ•°å°†è¢«è°ƒç”¨æ¥è¾“å‡ºæ–‡ä»¶å†…å®¹ã€‚å¦‚æœè¯»å–å¤±è´¥ï¼ŒPromise å˜ä¸º Rejected çŠ¶æ€ï¼Œ<code>.catch()</code> ä¸­çš„å‡½æ•°å°†è¢«è°ƒç”¨æ¥å¤„ç†é”™è¯¯ã€‚</p><h3 id="ä¾‹å­-2-ç½‘ç»œè¯·æ±‚" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-ç½‘ç»œè¯·æ±‚"><span>ä¾‹å­ 2ï¼šç½‘ç»œè¯·æ±‚</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fetch</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">node-fetch</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // node-fetch æ˜¯ä¸€ä¸ªç”¨æ¥å‘èµ·ç½‘ç»œè¯·æ±‚çš„åº“</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88C0D0;">fetch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://api.example.com/data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">) </span><span style="color:#616E88;">// å‘èµ· GET è¯·æ±‚åˆ°æŒ‡å®šçš„ URL</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">response</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">ok</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">      throw</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Network response was not ok</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">json</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è§£æ JSON æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // å¤„ç†æ•°æ®</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">There has been a problem with your fetch operation:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>fetch</code> å‡½æ•°ç”¨æ¥å‘èµ·ä¸€ä¸ªç½‘ç»œè¯·æ±‚ã€‚å®ƒè¿”å›ä¸€ä¸ª Promiseï¼Œè¯¥ Promise åœ¨ç½‘ç»œå“åº”åè¢«è§£å†³ã€‚å¦‚æœå“åº”çŠ¶æ€è‰¯å¥½ï¼Œæˆ‘ä»¬ç»§ç»­è§£æ JSON æ•°æ®ï¼Œç„¶ååœ¨ä¸‹ä¸€ä¸ª <code>.then()</code> å—ä¸­å¤„ç†å®ƒã€‚å¦‚æœç½‘ç»œè¯·æ±‚å¤±è´¥æˆ–è€…å“åº”çŠ¶æ€ä¸æ˜¯ OK çš„ï¼Œæˆ‘ä»¬é€šè¿‡æŠ›å‡ºå¼‚å¸¸æ¥ç›´æ¥è§¦å‘ <code>.catch()</code> å—ï¼Œæ‰“å°å‡ºé”™ä¿¡æ¯ã€‚</p><h3 id="ä¾‹å­-3-é“¾å¼æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-3-é“¾å¼æ“ä½œ"><span>ä¾‹å­ 3ï¼šé“¾å¼æ“ä½œ</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#88C0D0;">doSomething</span><span style="color:#D8DEE9FF;">()</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">result</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#88C0D0;"> doSomethingElse</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">result</span><span style="color:#D8DEE9FF;">))</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">newResult</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#88C0D0;"> doThirdThing</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">newResult</span><span style="color:#D8DEE9FF;">))</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">finalResult</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">Got the final result: </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">finalResult</span><span style="color:#81A1C1;">}</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">failureCallback</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> doSomething</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  return</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> Promise</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">resolve</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> reject</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // å‡è®¾è¿™é‡Œæ˜¯ä¸€äº›å¼‚æ­¥æ“ä½œ...</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> result</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">first value</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#88C0D0;">    resolve</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">result</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // æ“ä½œæˆåŠŸï¼Œè°ƒç”¨ resolve å¹¶ä¼ å…¥ç»“æœ</span></span>
<span class="line"><span style="color:#616E88;">    // å¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œåº”è¯¥è°ƒç”¨ reject</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> doSomethingElse</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // è¿”å›æ–°çš„ Promiseï¼Œä¾èµ–äºå‰ä¸€ä¸ªæ“ä½œçš„ç»“æœ</span></span>
<span class="line"><span style="color:#81A1C1;">  return</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> Promise</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">resolve</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> reject</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // åˆæ˜¯ä¸€äº›å¼‚æ­¥æ“ä½œ...</span></span>
<span class="line"><span style="color:#81A1C1;">    const</span><span style="color:#D8DEE9;"> newResult</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> `</span><span style="color:#A3BE8C;">new result based on </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">value</span><span style="color:#81A1C1;">}</span><span style="color:#ECEFF4;">`</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#88C0D0;">    resolve</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">newResult</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> doThirdThing</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">newResult</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // ...åˆæ˜¯ä¾èµ–ä¸Šä¸€æ­¥ç»“æœçš„æ“ä½œ...</span></span>
<span class="line"><span style="color:#81A1C1;">  return</span><span style="color:#8FBCBB;"> Promise</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">resolve</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">third result based on </span><span style="color:#81A1C1;">${</span><span style="color:#D8DEE9;">newResult</span><span style="color:#81A1C1;">}</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ¼”ç¤ºäº†å¦‚ä½•ç”¨ <code>.then()</code> æ–¹æ³•æ¥ä¸²è”å¤šä¸ªå¼‚æ­¥æ“ä½œï¼Œæ¯ä¸€æ­¥éƒ½æ ¹æ®ä¸Šä¸€æ­¥çš„ç»“æœæ¥è¿›è¡Œæ“ä½œã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬æ‰“å°å‡ºæœ€åçš„ç»“æœï¼Œæˆ–è€…åœ¨ä»»ä½•åœ°æ–¹é‡åˆ°é”™è¯¯æ—¶æ•è·å¹¶å¤„ç†é”™è¯¯ã€‚</p><p>è¿™äº›ä¾‹å­å±•ç¤ºäº†åœ¨ Node.js ä¸­ä½¿ç”¨ Promises æ¥å¤„ç†å¼‚æ­¥æ“ä½œçš„åŸºæœ¬æ–¹å¼ã€‚ç”±äº Promises æ˜¯åŸç”Ÿæ”¯æŒçš„ï¼Œå› æ­¤å®ƒä»¬ä¸ Node.js ä¸­çš„è®¸å¤šåº“å’Œå·¥å…·ç›¸äº’é›†æˆï¼Œå¤§å¤§ç®€åŒ–äº†å¼‚æ­¥ç¼–ç¨‹çš„å¤æ‚æ€§ã€‚</p><h3 id="napi-create-promise" tabindex="-1"><a class="header-anchor" href="#napi-create-promise"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_promise" target="_blank" rel="noopener noreferrer">napi_create_promise</a></span></a></h3><p>Node.js ä¸­çš„ <code>napi_create_promise</code> æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼ŒN-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ C APIã€‚åŸç”Ÿæ’ä»¶æ˜¯ä½¿ç”¨ C æˆ– C++ ç¼–å†™çš„æ¨¡å—ï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥ä¸ Node.js è¿è¡Œæ—¶è¿›è¡Œäº¤äº’ã€‚<code>napi_create_promise</code> å…è®¸åŸç”Ÿä»£ç åˆ›å»ºä¸€ä¸ª Promise å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å¯ä»¥å’Œ JavaScript ä¸­çš„ Promise ä¸€æ ·ä½¿ç”¨ï¼Œä»¥æ”¯æŒå¼‚æ­¥æ“ä½œã€‚</p><p>åœ¨ JavaScript ä¸­ï¼ŒPromises æ˜¯å¤„ç†å¼‚æ­¥æ“ä½œçš„ä¸€ç§æ–¹å¼ã€‚å½“ä½ æœ‰ä¸€ä¸ªå¯èƒ½èŠ±è´¹äº›æ—¶é—´æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ¯”å¦‚ä»ç½‘ç»œè¯»å–æ•°æ®æˆ–è€…æŸ¥è¯¢æ•°æ®åº“ï¼Œä½ é€šå¸¸ä¼šç”¨åˆ° Promiseã€‚ä¸€ä¸ª Promise ä»£è¡¨äº†ä¸€ä¸ªå°šæœªå®Œæˆä½†é¢„è®¡å°†æ¥ä¼šå®Œæˆçš„åŠ¨ä½œï¼Œå¹¶ä¸”æä¾›äº†ä¸€ç§æ–¹æ³•æ¥å¤„ç†å…¶ç»“æœã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ <code>napi_create_promise</code> æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­è¯´æ˜äº†åœ¨åŸç”Ÿæ’ä»¶ä¸­å¦‚ä½•åˆ›å»ºä¸€ä¸ª Promiseï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value CreatePromise(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  napi_value promise;</span></span>
<span class="line"><span>  napi_deferred deferred;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ›å»ºä¸€ä¸ªPromiseå¯¹è±¡</span></span>
<span class="line"><span>  napi_status status = napi_create_promise(env, &amp;deferred, &amp;promise);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åœ¨æ­¤å¤„æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å‡è®¾å¼‚æ­¥ä»»åŠ¡å®Œæˆåï¼Œæˆ‘ä»¬è¦è§£å†³ï¼ˆresolveï¼‰è¿™ä¸ªPromise</span></span>
<span class="line"><span>  // é¦–å…ˆåˆ›å»ºä¸€ä¸ªè¡¨ç¤ºæˆåŠŸç»“æœçš„JavaScriptå€¼</span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span>  status = napi_create_string_utf8(env, &quot;Success&quot;, NAPI_AUTO_LENGTH, &amp;result);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è§£å†³è¿™ä¸ªPromise</span></span>
<span class="line"><span>  status = napi_resolve_deferred(env, deferred, result);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›åˆ›å»ºçš„Promiseå¯¹è±¡</span></span>
<span class="line"><span>  return promise;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œä¸Šé¢çš„å‡½æ•°ä¸ºä¸€ä¸ªæ¨¡å—å¯¼å‡º</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>  napi_value export_fn;</span></span>
<span class="line"><span>  napi_create_function(env, NULL, 0, CreatePromise, NULL, &amp;export_fn);</span></span>
<span class="line"><span>  napi_set_named_property(env, exports, &quot;createPromise&quot;, export_fn);</span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª <code>CreatePromise</code> å‡½æ•°ï¼Œå®ƒé¦–å…ˆè°ƒç”¨ <code>napi_create_promise</code> æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡å’Œä¸€ä¸ªä¸ä¹‹å…³è”çš„ <code>napi_deferred</code> å¯¹è±¡ã€‚<code>napi_deferred</code> å¯¹è±¡ç”¨äºç¨åè§£å†³ï¼ˆfulfillï¼‰æˆ–æ‹’ç»ï¼ˆrejectï¼‰è¿™ä¸ª Promiseã€‚</p><p>è¯¥å‡½æ•°è¿”å›åˆ›å»ºçš„ Promise å¯¹è±¡ï¼Œç„¶åä½ å¯ä»¥åœ¨ JavaScript ä»£ç ä¸­è°ƒç”¨è¿™ä¸ªåŸç”Ÿå‡½æ•°è·å– Promise å¯¹è±¡ï¼Œå¹¶æ·»åŠ  <code>.then()</code>ã€<code>.catch()</code> æˆ– <code>.finally()</code> å›è°ƒæ¥å¤„ç†å¼‚æ­¥ç»“æœã€‚</p><p>å‡è®¾åŸç”Ÿæ¨¡å—åä¸º <code>my_native_module</code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ JavaScript ä¸­è¿™æ ·ä½¿ç”¨å®ƒï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> myNativeModule</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my_native_module</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> promise</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> myNativeModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createPromise</span><span style="color:#D8DEE9FF;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">promise</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">result</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">result</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: &#39;Success&#39;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">  .</span><span style="color:#88C0D0;">catch</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">error</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œçš„ <code>myNativeModule.createPromise()</code> è°ƒç”¨åŸç”Ÿå‡½æ•° <code>CreatePromise</code>ï¼Œåè€…åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ª Promiseã€‚å½“å¼‚æ­¥æ“ä½œå®Œæˆåï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™ç”±åŸç”Ÿä»£ç é€šè¿‡ <code>napi_resolve_deferred</code> è§£å†³è¿™ä¸ª Promiseï¼›å¦‚æœå¤±è´¥ï¼Œåˆ™é€šè¿‡ <code>napi_reject_deferred</code> æ‹’ç»å®ƒã€‚</p><p>è®°ä½ï¼ŒçœŸæ­£çš„å¼‚æ­¥æ“ä½œåº”è¯¥åœ¨å…¶ä»–çº¿ç¨‹æˆ–è€…äº‹ä»¶å¾ªç¯ä¸­å‘ç”Ÿï¼Œä»¥é¿å…é˜»å¡ Node.js çš„ä¸»çº¿ç¨‹ã€‚è€Œæœ¬ä¾‹ä¸­çš„å¼‚æ­¥æ“ä½œè¢«ç®€åŒ–äº†ï¼Œåªæ˜¯ä¸ºäº†æ¼”ç¤ºå¦‚ä½•åˆ›å»ºå’Œä½¿ç”¨ <code>napi_create_promise</code>ã€‚</p><h3 id="napi-resolve-deferred" tabindex="-1"><a class="header-anchor" href="#napi-resolve-deferred"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_resolve_deferred" target="_blank" rel="noopener noreferrer">napi_resolve_deferred</a></span></a></h3><p><code>napi_resolve_deferred</code> æ˜¯ Node.js çš„ N-APIï¼ˆåŸç”Ÿ APIï¼‰ä¸­çš„ä¸€ä¸ªåŠŸèƒ½ã€‚åœ¨ Node.js ä¸­ï¼ŒN-API æä¾›äº†ä¸€ä¸ªä¸ JavaScript è¿è¡Œæ—¶äº¤äº’çš„ç¨³å®šå±‚ï¼Œå…è®¸åˆ›å»ºå¯ä»¥è·¨å¤šä¸ª Node.js ç‰ˆæœ¬è¿è¡Œçš„æœ¬åœ°æ’ä»¶ã€‚</p><p>é¦–å…ˆï¼Œè¦ç†è§£ <code>napi_resolve_deferred</code>ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä»€ä¹ˆæ˜¯ â€œdeferredâ€ å’Œ â€œpromiseâ€ã€‚åœ¨ JavaScript ä¸­ï¼ŒPromise æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§å¾ˆé‡è¦çš„æ¦‚å¿µï¼Œå®ƒä»£è¡¨äº†ä¸€ä¸ªå¯èƒ½ç°åœ¨ã€ä¹Ÿå¯èƒ½å°†æ¥æ‰ä¼šç»“æŸçš„æ“ä½œï¼Œå¹¶ä¸”è¿™ä¸ªæ“ä½œå¯ä»¥æœ‰ä¸¤ç§ç»“æœï¼šæˆåŠŸï¼ˆresolvedï¼‰æˆ–å¤±è´¥ï¼ˆrejectedï¼‰ã€‚</p><p>Deferred å¯¹è±¡æ˜¯ Promise çš„æ¥æºï¼Œé€šå¸¸ç”¨äºåº•å±‚çš„å®ç°ã€‚ä¸€ä¸ª deferred åŒ…å«äº†ä¸€ä¸ª promise ä»¥åŠæ”¹å˜è¿™ä¸ª promise çŠ¶æ€çš„æ–¹æ³•ï¼ˆresolve æ¥è¡¨ç¤ºæˆåŠŸï¼Œreject è¡¨ç¤ºå¤±è´¥ï¼‰ã€‚ä½ å¯ä»¥æŠŠ deferred æƒ³è±¡æˆå¸¦æœ‰æ§åˆ¶æŒ‰é’®çš„ promise å·¥å‚ã€‚</p><p>åœ¨ä½¿ç”¨ N-API åˆ›å»ºåŸç”Ÿæ’ä»¶æ—¶ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°è¿™æ ·çš„æƒ…å†µï¼šä½ æƒ³è¦æ‰§è¡Œä¸€äº›å¼‚æ­¥çš„æœ¬åœ°æ“ä½œï¼ˆæ¯”å¦‚è¯»å–æ–‡ä»¶ã€è®¿é—®æ•°æ®åº“ç­‰ï¼‰ï¼Œå¹¶ä¸”å¸Œæœ›æŠŠç»“æœä¼ é€’å› JavaScript å±‚é¢ã€‚æ­¤æ—¶ï¼Œä½ å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ª deferred å¯¹è±¡å’Œç›¸åº”çš„ promiseï¼Œç„¶åå½“æœ¬åœ°æ“ä½œå®Œæˆåï¼Œä½¿ç”¨ <code>napi_resolve_deferred</code> æ¥è§£å†³ï¼ˆresolveï¼‰è¯¥ deferred å¯¹è±¡ï¼Œä»è€Œä½¿å¾— JavaScript å±‚é¢çš„ promise å˜ä¸º fulfilled çŠ¶æ€ï¼Œå¹¶ä¸”å°†ç»“æœä¼ é€’ç»™ä»»ä½•ç­‰å¾…è¿™ä¸ª promise çš„å¤„ç†ç¨‹åºã€‚</p><p><strong>ä¾‹å­ï¼š</strong></p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼Œè¯¥æ’ä»¶æä¾›äº†ä¸€ä¸ªå¼‚æ­¥å‡½æ•° <code>doSomethingAsyncNative</code>ï¼Œè¯¥å‡½æ•°åœ¨æœ¬åœ°æ‰§è¡Œä¸€äº›æ“ä½œï¼Œå¹¶åœ¨ç»“æŸæ—¶è¿”å›ä¸€ä¸ªç»“æœã€‚è¿™é‡Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ <code>napi_resolve_deferred</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å¼‚æ­¥å·¥ä½œç»“æ„ä½“ï¼Œç”¨äºä¼ é€’æ•°æ®åˆ°å¼‚æ­¥æ‰§è¡Œå‡½æ•°å’Œå®Œæˆå›è°ƒ</span></span>
<span class="line"><span>typedef struct {</span></span>
<span class="line"><span>    napi_deferred deferred;</span></span>
<span class="line"><span>    napi_async_work work;</span></span>
<span class="line"><span>    // å…¶ä»–éœ€è¦ä¼ é€’åˆ°å¼‚æ­¥å·¥ä½œä¸­çš„æ•°æ®</span></span>
<span class="line"><span>} AsyncWorkData;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å¼‚æ­¥æ‰§è¡Œå‡½æ•°ï¼Œæ­¤å¤„ä¸ºå‡è®¾å‡½æ•°</span></span>
<span class="line"><span>void ExecuteAsyncWork(napi_env env, void* data) {</span></span>
<span class="line"><span>    // æ‰§è¡Œä¸€äº›è€—æ—¶çš„æ“ä½œ</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å‡è®¾å®Œæˆåçš„ç»“æœæ˜¯ä¸€ä¸ªæ•´æ•°</span></span>
<span class="line"><span>    int result = 42;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°†ç»“æœå­˜å‚¨åœ¨ AsyncWorkData ç»“æ„ä¸­ä»¥ä¾›å®Œæˆå›è°ƒä½¿ç”¨</span></span>
<span class="line"><span>    ((AsyncWorkData*)data)-&gt;result = result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å®Œæˆå›è°ƒå‡½æ•°</span></span>
<span class="line"><span>void CompleteAsyncWork(napi_env env, napi_status status, void* data) {</span></span>
<span class="line"><span>    AsyncWorkData* asyncWorkData = (AsyncWorkData*)data;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (status == napi_ok) {</span></span>
<span class="line"><span>        // åˆ›å»ºä¸€ä¸ªJavaScriptæ•°å­—ä»¥åŒ…è£…ç»“æœ</span></span>
<span class="line"><span>        napi_value jsResult;</span></span>
<span class="line"><span>        napi_create_int32(env, asyncWorkData-&gt;result, &amp;jsResult);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // è§£å†³ deferredï¼Œå³è§£å†³å…³è”çš„ promise å¹¶ä¼ é€’ç»“æœ</span></span>
<span class="line"><span>        napi_resolve_deferred(env, asyncWorkData-&gt;deferred, jsResult);</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // å¦‚æœæœ‰é”™è¯¯ï¼Œæ‹’ç» promise</span></span>
<span class="line"><span>        napi_reject_deferred(env, asyncWorkData-&gt;deferred, NULL);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ é™¤å¼‚æ­¥å·¥ä½œé¡¹</span></span>
<span class="line"><span>    napi_delete_async_work(env, asyncWorkData-&gt;work);</span></span>
<span class="line"><span>    free(asyncWorkData);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ç»‘å®šåˆ° JavaScript çš„è¡¨ç¤ºå¼‚æ­¥æ“ä½œçš„å‡½æ•°</span></span>
<span class="line"><span>napi_value DoSomethingAsyncNative(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ª deferred å’Œ promise</span></span>
<span class="line"><span>    napi_deferred deferred;</span></span>
<span class="line"><span>    napi_value promise;</span></span>
<span class="line"><span>    napi_create_promise(env, &amp;deferred, &amp;promise);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ†é… AsyncWorkData ç»“æ„å¹¶åˆå§‹åŒ–</span></span>
<span class="line"><span>    AsyncWorkData* asyncWorkData = malloc(sizeof(AsyncWorkData));</span></span>
<span class="line"><span>    asyncWorkData-&gt;deferred = deferred;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºå’Œé˜Ÿåˆ—å¼‚æ­¥å·¥ä½œ</span></span>
<span class="line"><span>    napi_create_async_work(env, NULL, NULL, ExecuteAsyncWork, CompleteAsyncWork, asyncWorkData, &amp;asyncWorkData-&gt;work);</span></span>
<span class="line"><span>    napi_queue_async_work(env, asyncWorkData-&gt;work);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å› promise ç»™ JavaScript</span></span>
<span class="line"><span>    return promise;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•åœ¨åŸç”Ÿæ¨¡å—ä¸­ä½¿ç”¨ <code>napi_resolve_deferred</code>ã€‚æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª <code>DoSomethingAsyncNative</code> å‡½æ•°ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡å¹¶ç«‹å³è¿”å›ä¸€ä¸ª promiseã€‚å½“è¿™ä¸ªå¼‚æ­¥ä»»åŠ¡å®Œæˆæ—¶ï¼Œå®ƒå°†è°ƒç”¨ <code>CompleteAsyncWork</code> å›è°ƒå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå›è°ƒä¸­ï¼Œæˆ‘ä»¬æœ€ç»ˆè°ƒç”¨äº† <code>napi_resolve_deferred</code> æ¥è§£å†³ promiseï¼Œå¦‚æœå¼‚æ­¥å·¥ä½œæˆåŠŸï¼Œåˆ™è¿”å›ç»“æœï¼›å¦‚æœå¤±è´¥ï¼Œåˆ™æ‹’ç» promiseã€‚</p><p>è¯·æ³¨æ„ï¼Œè¿™ä¸ªä¾‹å­æ˜¯å¯¹ N-API ä½¿ç”¨æ–¹å¼çš„ç®€åŒ–è¯´æ˜ï¼Œå®é™…ä½¿ç”¨æ—¶è¿˜éœ€è¦è€ƒè™‘é”™è¯¯å¤„ç†ã€å†…å­˜ç®¡ç†ç­‰æ›´å¤šå› ç´ ã€‚</p><h3 id="napi-reject-deferred" tabindex="-1"><a class="header-anchor" href="#napi-reject-deferred"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_reject_deferred" target="_blank" rel="noopener noreferrer">napi_reject_deferred</a></span></a></h3><p>Node.js ä¸­çš„ <code>napi_reject_deferred</code> æ˜¯ä¸€ä¸ªç”¨äº N-APIï¼ˆNative APIï¼‰çš„å‡½æ•°ï¼Œå®ƒå…è®¸ä½ åœ¨ç¼–å†™åŸç”Ÿæ’ä»¶æ—¶æ‹’ç»ä¸€ä¸ªä¹‹å‰åˆ›å»ºçš„å»¶è¿Ÿå¯¹è±¡ï¼ˆDeferredï¼‰ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬è¦ç†è§£å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š</p><ol><li><p><strong>N-API</strong>ï¼šè¿™æ˜¯ Node.js æä¾›çš„ä¸€å¥— C è¯­è¨€çš„ APIï¼Œå…è®¸ä½ ç¼–å†™å¯ä»¥ç›´æ¥ä¸ JavaScript äº¤äº’çš„åŸç”Ÿæ’ä»¶ã€‚åŸç”Ÿæ’ä»¶é€šå¸¸æ˜¯ä¸ºäº†æé«˜æ€§èƒ½æˆ–è€…åˆ©ç”¨ C/C++ åº“ã€‚</p></li><li><p><strong>Promise</strong>ï¼šè¿™æ˜¯ JavaScript ä¸­çš„ä¸€ä¸ªå¯¹è±¡ï¼Œä»£è¡¨ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„æœ€ç»ˆå®Œæˆï¼ˆæˆ–å¤±è´¥ï¼‰ï¼Œä»¥åŠå®ƒçš„ç»“æœå€¼ã€‚</p></li><li><p><strong>Deferred</strong>ï¼šè¿™æ˜¯å®ç° Promise åŠŸèƒ½çš„ä¸€ç§æ–¹å¼ã€‚å½“ä½ åˆ›å»ºä¸€ä¸ª Deferred å¯¹è±¡æ—¶ï¼Œå®é™…ä¸Šä½ è·å¾—äº†æ§åˆ¶ç›¸åº” Promise è§£å†³ï¼ˆresolveï¼‰æˆ–æ‹’ç»ï¼ˆrejectï¼‰çš„èƒ½åŠ›ã€‚ç®€å•æ¥è¯´ï¼ŒDeferred å…·æœ‰è§£å†³å’Œæ‹’ç»ä¸¤ä¸ªæ“ä½œï¼Œåˆ†åˆ«å¯¹åº” Promise çš„æˆåŠŸå’Œå¤±è´¥çŠ¶æ€ã€‚</p></li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬è°ˆè°ˆ <code>napi_reject_deferred</code> å‡½æ•°çš„ä½œç”¨ã€‚æ­¤å‡½æ•°ç”¨äºæ‹’ç»ä¸€ä¸ªå·²ç»åˆ›å»ºçš„ Deferred å¯¹è±¡ï¼Œè¿™æ„å‘³ç€ä¸è¯¥ Deferred ç›¸å…³è”çš„ Promise å°†ä¼šä»¥å¤±è´¥ç»“æŸï¼Œå¹¶ä¸”ä½ å¯ä»¥æŒ‡å®šé”™è¯¯åŸå› ã€‚</p><p>ä¸‹é¢æ˜¯ <code>napi_reject_deferred</code> å‡½æ•°çš„å®šä¹‰ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_reject_deferred(napi_env env,</span></span>
<span class="line"><span>                                 napi_deferred deferred,</span></span>
<span class="line"><span>                                 napi_value rejection);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>ï¼šç¯å¢ƒå¥æŸ„ï¼Œç”¨äºè¡¨ç¤º Node.js è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ã€‚</li><li><code>deferred</code>ï¼šDeferred å¯¹è±¡çš„å¥æŸ„ï¼Œä¹‹å‰ä½¿ç”¨ <code>napi_create_promise</code> åˆ›å»ºã€‚</li><li><code>rejection</code>ï¼šä¸€ä¸ª <code>napi_value</code>ï¼Œè¡¨ç¤ºæ‹’ç»çš„åŸå› ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ª Error å¯¹è±¡ã€‚</li></ul><h3 id="å®è·µç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#å®è·µç¤ºä¾‹"><span>å®è·µç¤ºä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œå®ƒéœ€è¦æ‰§è¡Œä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„æ“ä½œï¼Œä¾‹å¦‚ä»ç½‘ç»œä¸‹è½½æ–‡ä»¶ã€‚ä½ å¸Œæœ›æä¾›ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›ä¸€ä¸ª Promiseï¼Œåœ¨æ“ä½œå®Œæˆæ—¶è§£å†³ï¼Œå¦‚æœå‡ºç°é”™è¯¯åˆ™æ‹’ç»ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ¨¡æ‹Ÿçš„å¼‚æ­¥æ“ä½œå›è°ƒ</span></span>
<span class="line"><span>void download_complete_callback(bool is_success, napi_deferred deferred, napi_env env) {</span></span>
<span class="line"><span>    if (is_success) {</span></span>
<span class="line"><span>        // å‡è®¾ä¸‹è½½æˆåŠŸï¼Œæˆ‘ä»¬è§£å†³ Promise</span></span>
<span class="line"><span>        napi_value undefined;</span></span>
<span class="line"><span>        napi_get_undefined(env, &amp;undefined);</span></span>
<span class="line"><span>        napi_resolve_deferred(env, deferred, undefined);</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // å¦‚æœä¸‹è½½å¤±è´¥ï¼Œæˆ‘ä»¬æ‹’ç» Promise</span></span>
<span class="line"><span>        napi_value error;</span></span>
<span class="line"><span>        napi_create_string_utf8(env, &quot;Download failed&quot;, NAPI_AUTO_LENGTH, &amp;error);</span></span>
<span class="line"><span>        napi_reject_deferred(env, deferred, error);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä½ çš„åŸç”Ÿæ¨¡å—å¯¼å‡ºçš„å‡½æ•°</span></span>
<span class="line"><span>napi_value start_download(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    napi_value promise;</span></span>
<span class="line"><span>    napi_deferred deferred;</span></span>
<span class="line"><span>    napi_create_promise(env, &amp;deferred, &amp;promise);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ... æ‰§è¡Œå¼‚æ­¥ä¸‹è½½æ“ä½œ ...</span></span>
<span class="line"><span>    // å‡è®¾ä¸‹è½½å®Œæˆåä¼šè°ƒç”¨ `download_complete_callback`</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return promise; // è¿”å› Promise ç»™ JavaScript è°ƒç”¨è€…</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ N-API åˆ›å»ºäº†ä¸€ä¸ª Promise å’Œä¸€ä¸ªç›¸å…³è”çš„ Deferredã€‚ç„¶åæˆ‘ä»¬å¼€å§‹ä¸€ä¸ªå¼‚æ­¥çš„ä¸‹è½½æ“ä½œï¼Œå¹¶ä¸”åœ¨ä¸‹è½½å®Œæˆæ—¶è°ƒç”¨ <code>download_complete_callback</code>ã€‚æ ¹æ®æ“ä½œæˆåŠŸæˆ–è€…å¤±è´¥ï¼Œæˆ‘ä»¬è°ƒç”¨ <code>napi_resolve_deferred</code> æˆ–è€… <code>napi_reject_deferred</code> æ¥æ”¹å˜ Promise çš„çŠ¶æ€ã€‚</p><p>åœ¨ JavaScript ä¸­ä½¿ç”¨æ—¶å¯èƒ½åƒè¿™æ ·ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeModule</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">your-native-module</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">nativeModule</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">start_download</span><span style="color:#D8DEE9FF;">()</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">then</span><span style="color:#D8DEE9FF;">(</span></span>
<span class="line"><span style="color:#ECEFF4;">  ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#D8DEE9;"> console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ä¸‹è½½æˆåŠŸ</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  (</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#D8DEE9;"> console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">error</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ä¸‹è½½å¤±è´¥:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> error</span><span style="color:#D8DEE9FF;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šå°±æ˜¯ <code>napi_reject_deferred</code> çš„åŸºæœ¬æ¦‚å¿µã€ç”¨æ³•ï¼Œä»¥åŠåœ¨å®é™…æƒ…å†µä¸­å¦‚ä½•ä½¿ç”¨å®ƒæ¥ç®¡ç†åŸç”Ÿæ¨¡å—ä¸­çš„å¼‚æ­¥æ“ä½œã€‚</p><h3 id="napi-is-promise" tabindex="-1"><a class="header-anchor" href="#napi-is-promise"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_is_promise" target="_blank" rel="noopener noreferrer">napi_is_promise</a></span></a></h3><p><code>napi_is_promise</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ª API å‡½æ•°ï¼Œå±äº N-APIã€‚N-API æ˜¯ä¸€å¥—ç”¨ C æˆ– C++ ç¼–å†™çš„åŸç”Ÿæ’ä»¶çš„æ¥å£ï¼Œå…è®¸ä½ åˆ›å»ºå¯ä»¥åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸­ç¨³å®šè¿è¡Œçš„åŸç”Ÿæ¨¡å—ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œ<code>napi_is_promise</code> å‡½æ•°ç”¨æ¥æ£€æŸ¥ä¸€ä¸ªç»™å®šçš„ N-API å€¼æ˜¯å¦æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ã€‚åœ¨ JavaScript ä¸­ï¼ŒPromise æ˜¯å¤„ç†å¼‚æ­¥æ“ä½œçš„å¸¸ç”¨æ–¹å¼ã€‚å½“ä½ æœ‰ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œå¦‚ä»æ–‡ä»¶ç³»ç»Ÿè¯»å–æ–‡ä»¶æˆ–ä»ç½‘ç»œè¯·æ±‚æ•°æ®æ—¶ï¼Œä½ å¯èƒ½ä¼šä½¿ç”¨ Promise æ¥ç®¡ç†è¿™äº›å¼‚æ­¥æ“ä½œã€‚</p><p>ä¸‹é¢æ˜¯å¯¹ <code>napi_is_promise</code> å‡½æ•°çš„è§£é‡Šï¼š</p><ol><li><p><strong>å‡½æ•°ä½œç”¨</strong>ï¼šè¯¥å‡½æ•°ç”¨æ¥è¯†åˆ«ä¸€ä¸ª N-API å€¼æ˜¯å¦æ˜¯ä¸€ä¸ª Promiseã€‚å¦‚æœæ˜¯ï¼Œé‚£ä¹ˆä½ å¯ä»¥å¯¹å…¶è¿›è¡Œ Promise ç›¸å…³çš„æ“ä½œï¼Œæ¯”å¦‚ thenã€catch ç­‰ã€‚</p></li><li><p><strong>å‚æ•°</strong>ï¼š<code>napi_is_promise</code> æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š</p><ul><li><code>env</code>ï¼šå½“å‰æ‰§è¡Œç¯å¢ƒã€‚</li><li><code>value</code>ï¼šå¾…æ£€æŸ¥çš„ N-API å€¼ã€‚</li><li><code>is_promise</code>ï¼šè¾“å‡ºå‚æ•°ï¼ŒæŒ‡å‘å¸ƒå°”å€¼çš„æŒ‡é’ˆï¼Œå¦‚æœ <code>value</code> æ˜¯ Promiseï¼Œåˆ™è®¾ç½®ä¸º <code>true</code>ï¼Œå¦åˆ™è®¾ç½®ä¸º <code>false</code>ã€‚</li></ul></li><li><p><strong>è¿”å›å€¼</strong>ï¼šè¿”å›çŠ¶æ€ç ï¼Œé€šå¸¸è¿™äº›çŠ¶æ€ç è¡¨ç¤ºæ“ä½œæ˜¯å¦æˆåŠŸã€‚åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œä½ ä¼šå¾—åˆ° <code>napi_ok</code> è¡¨ç¤ºæ²¡æœ‰å‘ç”Ÿé”™è¯¯ã€‚</p></li></ol><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®é™…çš„ä¾‹å­æ¥è¯´æ˜æ€æ ·ä½¿ç”¨ <code>napi_is_promise</code>ã€‚å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œå¹¶ä¸”ä½ æƒ³æä¾›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œä½†æ˜¯ä½ éœ€è¦éªŒè¯è¿™ä¸ªå‚æ•°æ˜¯å¦ä¸º Promiseã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¸€ä¸ª N-API çš„åŸç”Ÿå‡½æ•°</span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value args[1];</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, args, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ£€æŸ¥æ˜¯å¦ä¼ å…¥äº†è‡³å°‘ä¸€ä¸ªå‚æ•°</span></span>
<span class="line"><span>    if (argc `&lt;` 1) {</span></span>
<span class="line"><span>        napi_throw_type_error(env, NULL, &quot;Function expects a parameter.&quot;);</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç¡®è®¤è¿™ä¸ªå‚æ•°æ˜¯å¦ä¸º Promise</span></span>
<span class="line"><span>    bool is_promise = false;</span></span>
<span class="line"><span>    napi_is_promise(env, args[0], &amp;is_promise);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (is_promise) {</span></span>
<span class="line"><span>        // å‚æ•°æ˜¯ Promiseï¼Œå¯ä»¥æ‰§è¡Œä¸€äº›ä¸ Promise ç›¸å…³çš„æ“ä½œ</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        // å‚æ•°ä¸æ˜¯ Promiseï¼ŒæŠ›å‡ºå¼‚å¸¸æˆ–è€…è¿›è¡Œå…¶ä»–å¤„ç†</span></span>
<span class="line"><span>        napi_throw_type_error(env, NULL, &quot;Expected a Promise.&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å› undefined</span></span>
<span class="line"><span>    napi_value undefined;</span></span>
<span class="line"><span>    napi_get_undefined(env, &amp;undefined);</span></span>
<span class="line"><span>    return undefined;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œæ³¨å†Œ MyFunction</span></span>
<span class="line"><span>NAPI_MODULE_INIT() {</span></span>
<span class="line"><span>    napi_value fn;</span></span>
<span class="line"><span>    napi_create_function(env, NULL, 0, MyFunction, NULL, &amp;fn);</span></span>
<span class="line"><span>    napi_set_named_property(env, exports, &quot;myFunction&quot;, fn);</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>MyFunction</code> çš„åŸç”Ÿå‡½æ•°ï¼Œå®ƒæ£€æŸ¥ä¼ é€’ç»™å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦ä¸º Promiseï¼Œå¹¶æ®æ­¤è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚</p><p>è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªä»£ç ç‰‡æ®µæ˜¯ç”¨ C è¯­è¨€ç¼–å†™çš„ï¼Œå¦‚æœä½ æ˜¯ Node.js å¼€å‘è€…è€Œä¸æ˜¯æ’ä»¶ä½œè€…ï¼Œä½ å¯èƒ½ä¸éœ€è¦ç›´æ¥ä¸è¿™ç±»åº•å±‚ä»£ç æ‰“äº¤é“ã€‚å¯¹äº JavaScript å¼€å‘è€…æ¥è¯´ï¼ŒNode.js å¼•æ“å·²ç»å†…ç½®äº†å¯¹ Promises çš„æ”¯æŒï¼Œæ‚¨é€šå¸¸ä¼šç›´æ¥ä½¿ç”¨ JavaScript çš„ <code>Promise</code> ç±»æ¥å¤„ç†å¼‚æ­¥æµç¨‹ã€‚</p><h2 id="script-execution" tabindex="-1"><a class="header-anchor" href="#script-execution"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#script-execution" target="_blank" rel="noopener noreferrer">Script execution</a></span></a></h2><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 JavaScript å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒã€‚å®ƒå…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥ç”¨ JavaScript å†™ç¨‹åºæ¥å¤„ç†ç½‘ç«™åå°é€»è¾‘ã€æ•°æ®åº“æ“ä½œï¼Œä»¥åŠæ„å»ºå¯æ‰©å±•çš„ç½‘ç»œåº”ç”¨ç­‰ã€‚</p><p>åœ¨ Node.js çš„æ–‡æ¡£ä¸­ï¼Œ&quot;Script execution&quot; æŒ‡çš„æ˜¯å¦‚ä½•åœ¨ Node.js ç¯å¢ƒä¸­æ‰§è¡Œ JavaScript è„šæœ¬ã€‚è¿™é‡Œç‰¹åˆ«æ¶‰åŠ N-APIï¼ˆNode.js APIï¼‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸ºäº†æ„å»ºåŸç”Ÿæ’ä»¶è€Œè®¾è®¡çš„ç¨³å®šçš„ API å±‚ã€‚N-API å…è®¸å¼€å‘è€…ä¸å¿…æ‹…å¿ƒåº•å±‚ JavaScript å¼•æ“çš„å˜åŒ–è€Œå½±å“ä»–ä»¬çš„æ¨¡å—ã€‚å¼€å‘è€…å¯ä»¥é€šè¿‡ä½¿ç”¨ N-API ç¼–å†™ä¸ Node.js ç‰ˆæœ¬æ— å…³çš„ä»£ç ï¼Œä»è€Œæå‡åŸç”Ÿæ¨¡å—çš„å…¼å®¹æ€§å’Œç¨³å®šæ€§ã€‚</p><p>ä¸‹é¢æˆ‘å°†ç”¨ä¸€äº›å®é™…çš„ä¾‹å­æ¥è§£é‡Š Node.js ä¸­çš„è„šæœ¬æ‰§è¡Œï¼š</p><h3 id="ç¤ºä¾‹-1-æ‰§è¡Œç®€å•è„šæœ¬" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-1-æ‰§è¡Œç®€å•è„šæœ¬"><span>ç¤ºä¾‹ 1: æ‰§è¡Œç®€å•è„šæœ¬</span></a></h3><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªç®€å•çš„ JavaScript æ–‡ä»¶ <code>hello.js</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello, World!</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>åœ¨ Node.js ä¸­æ‰§è¡Œè¿™ä¸ªè„šæœ¬å¾ˆç®€å•ã€‚ä½ åªéœ€åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#88C0D0;">node</span><span style="color:#A3BE8C;"> hello.js</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æ‰§è¡Œåï¼Œä½ å°†çœ‹åˆ°æ§åˆ¶å°è¾“å‡º &quot;Hello, World!&quot;ã€‚</p><h3 id="ç¤ºä¾‹-2-ä½¿ç”¨-n-api-æ‰§è¡Œè„šæœ¬" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-2-ä½¿ç”¨-n-api-æ‰§è¡Œè„šæœ¬"><span>ç¤ºä¾‹ 2: ä½¿ç”¨ N-API æ‰§è¡Œè„šæœ¬</span></a></h3><p>N-API ä¸»è¦ç”¨äºç¼–å†™ C æˆ– C++ çš„æ‰©å±•ï¼Œç„¶åé€šè¿‡ JavaScript è°ƒç”¨è¿™äº›æ‰©å±•ã€‚å½“ä½ éœ€è¦æ›´é«˜æ€§èƒ½æˆ–è€…éœ€è¦åœ¨ Node.js ä¸­ä½¿ç”¨ä¸€äº› JavaScript åŸç”Ÿä¸æ”¯æŒçš„åŠŸèƒ½æ—¶ï¼ŒN-API å°±æ´¾ä¸Šç”¨åœºã€‚</p><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª C++ å‡½æ•°ï¼Œç”¨äºè®¡ç®—ä¸¤ä¸ªæ•°å­—çš„å’Œï¼Œå¹¶å¸Œæœ›èƒ½åœ¨ Node.js ä¸­è°ƒç”¨å®ƒã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦ä½¿ç”¨ N-API æ¥åˆ›å»ºä¸€ä¸ªåŒ…è£…å‡½æ•°ï¼ˆbindingï¼‰ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>#include `&lt;`node.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void Add(const v8::FunctionCallbackInfo`&lt;`v8::Value&gt;&amp; args) {</span></span>
<span class="line"><span>  v8::Isolate* isolate = args.GetIsolate();</span></span>
<span class="line"><span>  int sum = args[0].As`&lt;`v8::Number&gt;()-&gt;Value() + args[1].As`&lt;`v8::Number&gt;()-&gt;Value();</span></span>
<span class="line"><span>  auto result = v8::Number::New(isolate, sum);</span></span>
<span class="line"><span>  args.GetReturnValue().Set(result);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void Initialize(v8::Local`&lt;`v8::Object&gt; exports) {</span></span>
<span class="line"><span>  NODE_SET_METHOD(exports, &quot;add&quot;, Add);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NODE_MODULE(NODE_GYP_MODULE_NAME, Initialize)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åï¼Œåœ¨ Node.js ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åŠ è½½å¹¶ä½¿ç”¨è¿™ä¸ªåŸç”Ÿæ¨¡å—ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> nativeAddon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">nativeAddon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 5</span><span style="color:#D8DEE9FF;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡ºï¼š8</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåœ¨ C++ ä»£ç ä¸­å®šä¹‰äº†ä¸€ä¸ª <code>Add</code> å‡½æ•°ï¼Œç„¶åé€šè¿‡ <code>NODE_MODULE</code> å®å°†å…¶æš´éœ²ç»™ Node.jsã€‚åœ¨ JavaScript ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>require</code> åŠ è½½ç¼–è¯‘åçš„æ¨¡å—æ–‡ä»¶ï¼Œå¹¶è°ƒç”¨ <code>add</code> æ–¹æ³•ã€‚</p><p>è¯·æ³¨æ„ï¼ŒN-API ç›¸å…³çš„ä»£ç ç¼–å†™æ¯”è¾ƒä½çº§ä¸”å¤æ‚ï¼Œé€šå¸¸åªæœ‰åœ¨æ€§èƒ½éå¸¸å…³é”®æˆ–éœ€è¦ä½¿ç”¨ Node.js ä¸ç›´æ¥æ”¯æŒçš„ç³»ç»Ÿçº§åŠŸèƒ½æ—¶ï¼Œæ‰ä¼šè€ƒè™‘ä½¿ç”¨ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯å¯¹ Node.js è„šæœ¬æ‰§è¡Œå’Œ N-API çš„ä¸€ä¸ªç®€ä»‹å’Œå®ä¾‹è¯´æ˜ã€‚å¸Œæœ›è¿™å¯¹ä½ ç†è§£ Node.js çš„è„šæœ¬æ‰§è¡Œæœ‰æ‰€å¸®åŠ©ï¼</p><h3 id="napi-run-script" tabindex="-1"><a class="header-anchor" href="#napi-run-script"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_run_script" target="_blank" rel="noopener noreferrer">napi_run_script</a></span></a></h3><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒï¼Œå®ƒè®©å¼€å‘è€…èƒ½å¤Ÿåœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚N-APIï¼ˆNode.js APIï¼‰æ˜¯ Node.js æä¾›çš„ä¸€ç»„ C è¯­è¨€æ¥å£ï¼Œå…è®¸åŸç”Ÿæ’ä»¶çš„ç¼–å†™è€…ä¸å— Node.js ç‰ˆæœ¬å˜åŒ–çš„å½±å“ï¼Œæé«˜å…¶ç¨³å®šæ€§å’Œç»´æŠ¤æ€§ã€‚</p><p><code>napi_run_script</code> æ˜¯ N-API çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä½¿å¾—åŸç”Ÿæ¨¡å—å¯ä»¥æ‰§è¡Œä¸€ä¸ªå­—ç¬¦ä¸²ä¸­åŒ…å«çš„ JavaScript ä»£ç ï¼Œå¹¶è·å–æ‰§è¡Œç»“æœã€‚è¿™ä¸ªåŠŸèƒ½ç±»ä¼¼äºåœ¨å…¨å±€ä½œç”¨åŸŸä¸­è°ƒç”¨ <code>eval()</code> å‡½æ•°ï¼Œä½†æ˜¯ <code>napi_run_script</code> æ˜¯ç”± N-API æä¾›çš„ï¼Œå› æ­¤å®ƒæ˜¯åœ¨ C æˆ– C++ ä»£ç ä¸­ä½¿ç”¨çš„ã€‚</p><p>ä¸‹é¢æˆ‘ä¼šè¯¦ç»†è§£é‡Š <code>napi_run_script</code> åŠŸèƒ½ï¼Œå¹¶ç»™å‡ºä¸€ä¸ªå¦‚ä½•åœ¨å®é™…ä¸­ä½¿ç”¨å®ƒçš„ä¾‹å­ã€‚</p><h3 id="å‡½æ•°åŸå‹-5" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°åŸå‹-5"><span>å‡½æ•°åŸå‹</span></a></h3><p>åœ¨ Node.js çš„ N-API æ–‡æ¡£ä¸­ï¼Œ<code>napi_run_script</code> çš„å‡½æ•°åŸå‹æ˜¯ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_status napi_run_script(napi_env env,</span></span>
<span class="line"><span>                            napi_value script,</span></span>
<span class="line"><span>                            napi_value* result);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>env</code>: è¿™æ˜¯ä¸€ä¸ªè¡¨ç¤º N-API è°ƒç”¨ç¯å¢ƒçš„å¥æŸ„ã€‚</li><li><code>script</code>: è¿™æ˜¯ä¸€ä¸ªåŒ…å«äº†è¦æ‰§è¡Œçš„ JavaScript ä»£ç çš„ N-API å€¼ã€‚</li><li><code>result</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘ N-API å€¼çš„æŒ‡é’ˆï¼Œåœ¨å‡½æ•°æ‰§è¡ŒæˆåŠŸåï¼Œå®ƒå°†æŒ‡å‘è„šæœ¬çš„è¿”å›å€¼ã€‚</li></ul><h3 id="å¦‚ä½•ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ä½¿ç”¨"><span>å¦‚ä½•ä½¿ç”¨</span></a></h3><p>ä¸ºäº†ä½¿ç”¨ <code>napi_run_script</code>ï¼Œä½ éœ€è¦å®Œæˆä¸‹é¢çš„æ­¥éª¤ï¼š</p><ol><li>ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œå…¶ä¸­åŒ…å« C/C++ ä»£ç ï¼Œè°ƒç”¨ <code>napi_run_script</code> å‡½æ•°ã€‚</li><li>åˆ›å»ºä¸€ä¸ª JavaScript å­—ç¬¦ä¸²ï¼ŒåŒ…å«ä½ æƒ³è¦æ‰§è¡Œçš„ä»£ç ã€‚</li><li>å°†è¿™ä¸ªå­—ç¬¦ä¸²è½¬æ¢ä¸º N-API å€¼ï¼ˆ<code>napi_value</code>ï¼‰ã€‚</li><li>è°ƒç”¨ <code>napi_run_script</code> å¹¶ä¼ å…¥è¯¥ N-API å€¼ã€‚</li><li>è·å–æ‰§è¡Œçš„ç»“æœï¼Œå¹¶å¤„ç†å®ƒã€‚</li></ol><h3 id="å®é™…ä¾‹å­-10" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-10"><span>å®é™…ä¾‹å­</span></a></h3><p>å‡è®¾æˆ‘ä»¬æƒ³åœ¨ä¸€ä¸ªåŸç”Ÿæ¨¡å—ä¸­æ‰§è¡Œä¸€æ®µ JavaScript ä»£ç æ¥è®¡ç®—ä¸¤æ•°ä¹‹å’Œå¹¶è¿”å›ç»“æœã€‚</p><p>é¦–å…ˆï¼Œä½ éœ€è¦åŒ…å« Node.js çš„ N-API å¤´æ–‡ä»¶ï¼Œç„¶åç¼–å†™ä¸€ä¸ªåŸç”Ÿå‡½æ•°ï¼Œæ¯”å¦‚ <code>ExecuteScript</code>ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾ &#39;env&#39; å’Œ &#39;exports&#39; å·²ç»é€šè¿‡åˆå§‹åŒ–å‡½æ•°è·å¾—</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value ExecuteScript(napi_env env, const char* code) {</span></span>
<span class="line"><span>    napi_value script, result;</span></span>
<span class="line"><span>    napi_status status;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å°† C å­—ç¬¦ä¸²è½¬æ¢ä¸º N-API çš„å­—ç¬¦ä¸²å€¼</span></span>
<span class="line"><span>    status = napi_create_string_utf8(env, code, NAPI_AUTO_LENGTH, &amp;script);</span></span>
<span class="line"><span>    if (status != napi_ok) return nullptr;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ‰§è¡Œ JavaScript ä»£ç </span></span>
<span class="line"><span>    status = napi_run_script(env, script, &amp;result);</span></span>
<span class="line"><span>    if (status != napi_ok) return nullptr;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è¿”å›æ‰§è¡Œç»“æœ</span></span>
<span class="line"><span>    return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥æ‰§è¡Œè„šæœ¬äº†ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä»£ç ç‰‡æ®µæ‰§è¡Œäº†ä¸€ä¸ªç®€å•çš„ç›¸åŠ æ“ä½œï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// åœ¨åŸç”Ÿæ¨¡å—ä¸­è°ƒç”¨ ExecuteScript</span></span>
<span class="line"><span>napi_value sum_result = ExecuteScript(env, &quot;1 + 2&quot;);</span></span>
<span class="line"><span>if (sum_result == nullptr) {</span></span>
<span class="line"><span>    // é”™è¯¯å¤„ç†</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼šåœ¨çœŸå®çš„åº”ç”¨ä¸­ï¼Œä½ éœ€è¦æ£€æŸ¥æ¯æ¬¡ N-API è°ƒç”¨çš„è¿”å›çŠ¶æ€ä»¥ç¡®ä¿æ²¡æœ‰é”™è¯¯å‘ç”Ÿã€‚å¦‚æœæœ‰é”™è¯¯å‘ç”Ÿï¼Œä½ åº”è¯¥é€‚å½“åœ°å¤„ç†å®ƒä»¬ã€‚</p><p>æ€»ç»“èµ·æ¥ï¼Œ<code>napi_run_script</code> è®©ä½ èƒ½å¤Ÿåœ¨ N-API æ’ä»¶ä¸­æ‰§è¡Œ JavaScript ä»£ç ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ C/C++ ä¸­å¤„ç†æ‰§è¡Œç»“æœã€‚å®ƒä¸»è¦ç”¨äºé‚£äº›éœ€è¦ä»æœ¬åœ°ä»£ç ä¸­åŠ¨æ€è¿è¡Œ JavaScript ä»£ç çš„åœºæ™¯ã€‚</p><h2 id="libuv-event-loop" tabindex="-1"><a class="header-anchor" href="#libuv-event-loop"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#libuv-event-loop" target="_blank" rel="noopener noreferrer">libuv event loop</a></span></a></h2><p>å¥½çš„ï¼Œè®©æˆ‘æ¥è§£é‡Šä¸€ä¸‹ Node.js ä¸­çš„ libuv event loopã€‚</p><p>åœ¨è®¡ç®—ä¸­ï¼Œäº‹ä»¶å¾ªç¯æ˜¯ä¸€ä¸ªç¼–ç¨‹æ„é€ ï¼Œå®ƒç­‰å¾…å¹¶å‘é€æ¶ˆæ¯æˆ–äº‹ä»¶ã€‚Node.js ä½¿ç”¨ libuv åº“ï¼Œè¿™æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„ C åº“ï¼Œç”¨äºå¤„ç†å¼‚æ­¥ I/Oï¼ˆè¾“å…¥/è¾“å‡ºï¼‰æ“ä½œå’Œå®ç°äº‹ä»¶å¾ªç¯ã€‚</p><p>åœ¨ Node.js ä¸­ï¼Œå½“ä½ å¯åŠ¨ä¸€ä¸ªåº”ç”¨æ—¶ï¼ŒNode.js å®ä¾‹ä¼šåˆ›å»ºä¸€ä¸ªäº‹ä»¶å¾ªç¯ã€‚è¿™ä¸ªäº‹ä»¶å¾ªç¯æ˜¯ç”¨æ¥å¤„ç†éé˜»å¡çš„å¼‚æ­¥æ“ä½œçš„ï¼Œæ¯”å¦‚ï¼š</p><ul><li>æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼ˆè¯»å†™æ–‡ä»¶ï¼‰</li><li>ç½‘ç»œè¯·æ±‚ï¼ˆHTTP, TCP, UDP ç­‰ï¼‰</li><li>å®šæ—¶å™¨ï¼ˆsetTimeout, setIntervalï¼‰</li><li>ç”¨æˆ·è‡ªå®šä¹‰äº‹ä»¶</li></ul><p>å®é™…ä¸Šï¼Œlibuv å°†è¿™äº›æ“ä½œè½¬åŒ–ä¸ºåº•å±‚çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶ä¸”åœ¨æ“ä½œå®Œæˆæ—¶ï¼Œå®ƒå°†ç»“æœè¿”å›ç»™ Node.js ï¼Œç„¶å Node.js èƒ½å¤Ÿç»§ç»­æ‰§è¡Œ JavaScript å›è°ƒå‡½æ•°ã€‚</p><p>äº‹ä»¶å¾ªç¯ä¸»è¦åˆ†ä¸ºå‡ ä¸ªé˜¶æ®µ:</p><ol><li><strong>å®šæ—¶å™¨é˜¶æ®µ</strong> - è¿™é‡Œæ£€æŸ¥ setTimeout å’Œ setInterval å›è°ƒã€‚</li><li><strong>I/O å›è°ƒé˜¶æ®µ</strong> - å¤„ç†æŸäº›ç³»ç»Ÿæ“ä½œçš„å›è°ƒï¼Œå¦‚ TCP é”™è¯¯ã€‚</li><li><strong>ç©ºé—²ã€å‡†å¤‡é˜¶æ®µ</strong> - åœ¨è¿™ä¸ªé˜¶æ®µå†…éƒ¨å‡†å¤‡å·¥ä½œã€‚</li><li><strong>è½®è¯¢é˜¶æ®µ</strong> - æ£€ç´¢æ–°çš„ I/O äº‹ä»¶; æ‰§è¡Œä¸ I/O ç›¸å…³çš„å›è°ƒï¼Œå‡ ä¹æ‰€æœ‰æƒ…å†µä¸‹éƒ½ä¼šå¤„ç†ã€‚</li><li><strong>æ£€æŸ¥é˜¶æ®µ</strong> - setImmediate() å›è°ƒåœ¨è¿™é‡Œæ‰§è¡Œã€‚</li><li><strong>å…³é—­å›è°ƒé˜¶æ®µ</strong> - æ¯”å¦‚ socket.on(&#39;close&#39;, ...)ã€‚</li></ol><p>äº†è§£è¿™äº›æ¦‚å¿µåï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€äº›å®é™…çš„ä¾‹å­ã€‚</p><h3 id="ä¾‹å­-1-æ–‡ä»¶è¯»å–" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-æ–‡ä»¶è¯»å–"><span>ä¾‹å­ 1ï¼šæ–‡ä»¶è¯»å–</span></a></h3><p>å‡è®¾ä½ è¦è¯»å–ä¸€ä¸ªå¤§æ–‡ä»¶ã€‚åœ¨åŒæ­¥æ“ä½œä¸­ï¼Œä½ çš„ç¨‹åºä¼šåœåœ¨é‚£é‡Œç›´åˆ°æ•´ä¸ªæ–‡ä»¶éƒ½è¢«è¯»å–ã€‚ä½†åœ¨ Node.js ä¸­ï¼Œä½ å¯ä»¥è¿™æ ·åšï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> fs</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">fs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">fs</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">readFile</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/path/to/a-large-file.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> data</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">  if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">err</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">throw</span><span style="color:#D8DEE9;"> err</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ <code>fs.readFile</code> è¢«è°ƒç”¨æ—¶ï¼ŒNode.js ä¼šå°†æ–‡ä»¶è¯»å–æ“ä½œäº¤ç»™ libuvï¼Œç„¶åç»§ç»­æ‰§è¡Œäº‹ä»¶å¾ªç¯çš„ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚ä¸€æ—¦æ–‡ä»¶è¯»å–å®Œæˆï¼Œè¯»å–æ–‡ä»¶çš„å›è°ƒå°±ä¼šè¢«åŠ å…¥åˆ°äº‹ä»¶å¾ªç¯ä¸­ä»¥ä¾›æ‰§è¡Œã€‚</p><h3 id="ä¾‹å­-2-ç½‘ç»œè¯·æ±‚-1" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-ç½‘ç»œè¯·æ±‚-1"><span>ä¾‹å­ 2ï¼šç½‘ç»œè¯·æ±‚</span></a></h3><p>è€ƒè™‘è¿™æ ·ä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> http</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">http</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> server</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> http</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createServer</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">req</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> res</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">writeHead</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">200</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> {</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Content-Type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">text/plain</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">  res</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">end</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Hello World</span><span style="color:#EBCB8B;">\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">server</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">listen</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">8080</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> ()</span><span style="color:#81A1C1;"> =&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Server running at http://127.0.0.1:8080/</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Node.js å¯åŠ¨ HTTP æœåŠ¡å™¨å¹¶ç›‘å¬ç«¯å£ 8080ã€‚æ¯å½“æœ‰ HTTP è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨æ—¶ï¼Œäº‹ä»¶å¾ªç¯å°±ä¼šè¿è¡Œå›è°ƒå‡½æ•°ï¼Œæ— è®ºä½•æ—¶ï¼Œåªè¦å‡†å¤‡å¥½äº†ï¼Œå°±ä¼šå‘å®¢æˆ·ç«¯å‘é€ &quot;Hello World&quot; å“åº”ã€‚</p><h3 id="ä¾‹å­-3-å®æ—¶èŠå¤©åº”ç”¨" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-3-å®æ—¶èŠå¤©åº”ç”¨"><span>ä¾‹å­ 3ï¼šå®æ—¶èŠå¤©åº”ç”¨</span></a></h3><p>å¦‚æœä½ åˆ›å»ºä¸€ä¸ªå®æ—¶èŠå¤©åº”ç”¨ï¼ŒæœåŠ¡å™¨éœ€è¦åŒæ—¶å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯çš„æ¶ˆæ¯ã€‚ä½¿ç”¨ Node.js å’Œ WebSocketï¼Œä½ å¯ä»¥è¿™æ ·åšï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> WebSocket</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ws</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> wss</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#D8DEE9;"> WebSocket</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Server</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span><span style="color:#88C0D0;"> port</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 8080</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">wss</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">connection</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> connection</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">ws</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  ws</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">on</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">message</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> function</span><span style="color:#88C0D0;"> incoming</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">message</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">received: %s</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> message</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">  ws</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">send</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">something</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯å½“ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯è¿æ¥åˆ° WebSocket æœåŠ¡å™¨æ—¶ï¼Œ&#39;connection&#39; äº‹ä»¶å°±ä¼šè¢«è§¦å‘ï¼Œå¹¶ä¼ é€’ä¸€ä¸ªä»£è¡¨è¯¥è¿æ¥çš„ <code>ws</code> å¯¹è±¡ã€‚ç„¶åï¼Œä½ å¯ä»¥åœ¨è¿™ä¸ªå¯¹è±¡ä¸Šç›‘å¬æ¶ˆæ¯äº‹ä»¶ã€‚ç”±äº Node.js æ˜¯éé˜»å¡çš„ï¼Œå› æ­¤å¯ä»¥åŒæ—¶æœåŠ¡äºè®¸å¤šå®¢æˆ·ç«¯ï¼Œè€Œä¸ä¼šå› ä¸ºå•ä¸ªæ“ä½œè€Œå¡ä½ã€‚</p><p>æ€»ä¹‹ï¼Œlibuv äº‹ä»¶å¾ªç¯è®© Node.js èƒ½å¤Ÿé«˜æ•ˆåœ°å¤„ç†å¼‚æ­¥æ“ä½œï¼Œå®ƒä½¿å¾— Node.js ç‰¹åˆ«é€‚åˆ I/O å¯†é›†å‹ä»»åŠ¡ï¼Œè€Œä¸å¿…æ‹…å¿ƒç¨‹åºæ€§èƒ½çš„é—®é¢˜ã€‚</p><h3 id="napi-get-uv-event-loop" tabindex="-1"><a class="header-anchor" href="#napi-get-uv-event-loop"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_uv_event_loop" target="_blank" rel="noopener noreferrer">napi_get_uv_event_loop</a></span></a></h3><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚N-API è®¾è®¡çš„ç›®æ ‡æ˜¯ä¸ä¾èµ–äº JavaScript å¼•æ“çš„ç‰ˆæœ¬ï¼Œè¿™æ„å‘³ç€ä½¿ç”¨ N-API ç¼–å†™çš„æ’ä»¶å¯ä»¥åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸Šè¿è¡Œï¼Œè€Œæ— éœ€é‡æ–°ç¼–è¯‘ã€‚</p><p>åœ¨ Node.js ä¸­ï¼Œ<code>napi_get_uv_event_loop</code> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå…è®¸ä½ ä» N-API æ’ä»¶ä¸­è®¿é—® Node.js çš„åº•å±‚äº‹ä»¶å¾ªç¯ã€‚äº‹ä»¶å¾ªç¯æ˜¯ Node.js å¼‚æ­¥æ“ä½œçš„æ ¸å¿ƒï¼Œå®ƒè´Ÿè´£è°ƒåº¦å¹¶ç®¡ç†æ‰€æœ‰å¼‚æ­¥äº‹ä»¶å’Œæ“ä½œï¼Œå¦‚æ–‡ä»¶ I/Oã€ç½‘ç»œè¯·æ±‚ç­‰ã€‚Node.js ä½¿ç”¨äº† libuv ä½œä¸ºå…¶äº‹ä»¶å¾ªç¯çš„å®ç°ï¼Œlibuv æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„å¼‚æ­¥ I/O åº“ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·±å…¥ç†è§£ <code>napi_get_uv_event_loop</code> å‡½æ•°ï¼š</p><h3 id="ç”¨é€”" tabindex="-1"><a class="header-anchor" href="#ç”¨é€”"><span>ç”¨é€”</span></a></h3><p>å½“ä½ åœ¨åˆ›å»ºä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼ˆä¹Ÿå°±æ˜¯ C æˆ– C++ ç¼–å†™çš„æ‰©å±•ï¼‰æ—¶ï¼Œå¯èƒ½éœ€è¦ä¸ Node.js çš„äº‹ä»¶å¾ªç¯è¿›è¡Œäº¤äº’ã€‚é€šè¿‡ <code>napi_get_uv_event_loop</code> å‡½æ•°ï¼Œä½ å¯ä»¥è·å–æŒ‡å‘äº‹ä»¶å¾ªç¯çš„æŒ‡é’ˆï¼Œç„¶ååœ¨ä½ çš„åŸç”Ÿä»£ç ä¸­ä½¿ç”¨ libuv æä¾›çš„å„ç§åŠŸèƒ½ã€‚</p><h3 id="ç¤ºä¾‹-3" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-3"><span>ç¤ºä¾‹</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œè¯¥æ¨¡å—éœ€è¦æ‰§è¡Œä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œä¾‹å¦‚è¯»å–æŸä¸ªç¡¬ä»¶è®¾å¤‡çš„çŠ¶æ€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>napi_get_uv_event_loop</code> æ¥è·å¾—äº‹ä»¶å¾ªç¯ï¼Œå¹¶ä½¿ç”¨ libuv æä¾›çš„ç›¸å…³å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªå¼‚æ­¥è¯·æ±‚ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span>#include `&lt;`uv.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä¸€ä¸ªå¼‚æ­¥å·¥ä½œç»“æ„ä½“ï¼Œç”¨äºä¿å­˜ä½ çš„æ•°æ®å’Œå›è°ƒ</span></span>
<span class="line"><span>typedef struct {</span></span>
<span class="line"><span>  uv_work_t request; // libuv</span></span>
<span class="line"><span>  napi_ref callback; // N-API</span></span>
<span class="line"><span>  // å…¶ä»–éœ€è¦çš„è‡ªå®šä¹‰æ•°æ®...</span></span>
<span class="line"><span>} my_async_work;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯ä½ çš„å¼‚æ­¥å·¥ä½œçš„æ‰§è¡Œå‡½æ•°</span></span>
<span class="line"><span>static void MyAsyncExecute(uv_work_t* req) {</span></span>
<span class="line"><span>  my_async_work* work = (my_async_work*)req-&gt;data;</span></span>
<span class="line"><span>  // æ‰§è¡Œä¸€äº›è€—æ—¶çš„ä»»åŠ¡ï¼Œæ¯”å¦‚è¯»å–ç¡¬ä»¶çŠ¶æ€...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯å®Œæˆè€—æ—¶ä»»åŠ¡ä¹‹åçš„å›è°ƒå‡½æ•°</span></span>
<span class="line"><span>static void MyAsyncComplete(napi_env env, napi_status status, void* data) {</span></span>
<span class="line"><span>  my_async_work* work = (my_async_work*)data;</span></span>
<span class="line"><span>  // è°ƒç”¨ JavaScript å›è°ƒå‡½æ•°ï¼Œä¼ é€’ç»“æœ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯ N-API æš´éœ²ç»™ JavaScript çš„å‡½æ•°</span></span>
<span class="line"><span>napi_value MyFunction(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>  // è·å–äº‹ä»¶å¾ªç¯</span></span>
<span class="line"><span>  uv_loop_t* loop;</span></span>
<span class="line"><span>  napi_get_uv_event_loop(env, &amp;loop);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // åˆ†é…å’Œåˆå§‹åŒ–ä½ çš„å¼‚æ­¥å·¥ä½œç»“æ„ä½“</span></span>
<span class="line"><span>  my_async_work* work = (my_async_work*)malloc(sizeof(my_async_work));</span></span>
<span class="line"><span>  work-&gt;request.data = work;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // çœç•¥ï¼šè§£æ JavaScript ä¼ é€’çš„å‚æ•°ï¼ŒåŒ…æ‹¬å›è°ƒå‡½æ•°</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æŠŠä½ çš„å¼‚æ­¥è¯·æ±‚æ’é˜Ÿåˆ°äº‹ä»¶å¾ªç¯</span></span>
<span class="line"><span>  uv_queue_work(loop, &amp;work-&gt;request, MyAsyncExecute, MyAsyncComplete);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è¿”å›ä¸€äº›å€¼ç»™ JavaScript</span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span>  napi_get_undefined(env, &amp;result);</span></span>
<span class="line"><span>  return result;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>MyFunction</code> è¢«æš´éœ²ä¸ºä¸€ä¸ªå¯ä»¥ä» JavaScript è°ƒç”¨çš„å‡½æ•°ã€‚å½“ JavaScript ä»£ç è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œå®ƒä¼šåˆå§‹åŒ–ä¸€ä¸ªå¼‚æ­¥å·¥ä½œè¯·æ±‚ï¼Œå¹¶å°†å…¶æ’é˜Ÿåˆ° Node.js çš„äº‹ä»¶å¾ªç¯ä¸­ã€‚å½“å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œ<code>MyAsyncComplete</code> å°†è¢«è°ƒç”¨ï¼Œä»¥ä¾¿ç»™ JavaScript ä¼ é€’ç»“æœã€‚</p><p>è¯·æ³¨æ„ï¼ŒçœŸå®æƒ…å†µä¸‹çš„é”™è¯¯å¤„ç†å’Œå†…å­˜ç®¡ç†ä¼šæ›´å¤æ‚ï¼Œè¿™é‡Œçš„ç¤ºä¾‹åªæ˜¯ä¸ºäº†è¯´æ˜å¦‚ä½•ä½¿ç”¨ <code>napi_get_uv_event_loop</code>ã€‚</p><p>æ€»ç»“èµ·æ¥ï¼Œ<code>napi_get_uv_event_loop</code> è®©ä½ çš„åŸç”Ÿæ¨¡å—èƒ½å¤Ÿåˆ©ç”¨ Node.js çš„äº‹ä»¶å¾ªç¯æœºåˆ¶æ¥æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œä½¿å¾—åŸç”Ÿæ¨¡å—å¯ä»¥åƒ Node.js ä¸­çš„ JavaScript ä»£ç é‚£æ ·éé˜»å¡åœ°è¿è¡Œã€‚</p><h2 id="asynchronous-thread-safe-function-calls" tabindex="-1"><a class="header-anchor" href="#asynchronous-thread-safe-function-calls"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#asynchronous-thread-safe-function-calls" target="_blank" rel="noopener noreferrer">Asynchronous thread-safe function calls</a></span></a></h2><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº JavaScript çš„åç«¯å¹³å°ï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨ JavaScript ç¼–å†™æœåŠ¡å™¨ç«¯ä»£ç ã€‚å®ƒçš„ä¼˜åŠ¿åœ¨äºéé˜»å¡æ€§ I/O æ¨¡å‹ï¼Œè¿™ä½¿å¾—å®ƒå¾ˆé€‚åˆå¤„ç†é«˜å¹¶å‘æƒ…å†µã€‚</p><p>åœ¨ Node.js ä¸­ï¼Œå¤§éƒ¨åˆ†æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œæ¯”å¦‚æ–‡ä»¶è¯»å–ã€ç½‘ç»œè¯·æ±‚ç­‰ï¼Œè¿™äº›æ“ä½œä¸ä¼šç«‹å³å®Œæˆï¼Œæ‰€ä»¥å®ƒä»¬ä¸ä¼šé˜»å¡ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†ã€‚ç„¶è€Œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦æ‰§è¡Œ CPU å¯†é›†å‹ä»»åŠ¡æˆ–ä¸€äº›é˜»å¡æ€§æ“ä½œï¼Œå¦‚æœè¿™äº›æ“ä½œåœ¨ Node.js çš„ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå°±ä¼šå½±å“æ•´ä¸ªåº”ç”¨çš„æ€§èƒ½ã€‚</p><p>ä¸ºæ­¤ï¼ŒNode.js æä¾›äº†<code>n-api</code>æ¥åˆ›å»ºæœ¬åœ°æ’ä»¶ï¼Œä»¥ä¾¿åˆ©ç”¨ C æˆ–è€… C++å¢å¼º Node.js çš„æ€§èƒ½ã€‚<code>n-api</code>è¿˜å…è®¸å¼€å‘è€…åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¿è¡Œä»£ç ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥è¿›è¡Œä¸€äº›å¤æ‚çš„è®¡ç®—è€Œä¸é˜»å¡ä¸»äº‹ä»¶å¾ªç¯ã€‚</p><p>&quot;å¼‚æ­¥çº¿ç¨‹å®‰å…¨å‡½æ•°è°ƒç”¨ï¼ˆAsynchronous Thread-safe Function Callsï¼‰&quot; æ˜¯<code>n-api</code>æä¾›çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå®ƒå…è®¸åŸç”Ÿä»£ç ï¼ˆä¾‹å¦‚ C/C++æ¨¡å—ï¼‰åœ¨ä»»ä½•çº¿ç¨‹ä¸Šå®‰å…¨åœ°è°ƒç”¨ JavaScript å‡½æ•°ã€‚è¿™æ˜¯é€šè¿‡<code>Thread-safe function</code>æ¥å®ç°çš„ã€‚</p><h3 id="thread-safe-function" tabindex="-1"><a class="header-anchor" href="#thread-safe-function"><span>Thread-safe function</span></a></h3><p>è¿™æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„å‡½æ•°ï¼Œå¯ä»¥è®©ä½ ä»ä»»ä½•çº¿ç¨‹å®‰å…¨åœ°è°ƒç”¨ JavaScript å›è°ƒå‡½æ•°ã€‚å³ä½¿ä½ çš„ä»£ç åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šè¿è¡Œï¼Œå¹¶ä¸”è¿™äº›çº¿ç¨‹å°è¯•å¹¶å‘åœ°è°ƒç”¨ JavaScript ä»£ç ï¼Œä½¿ç”¨ Thread-safe function ä¹Ÿå¯ä»¥ç¡®ä¿ä¸ä¼šå‘ç”Ÿå†²çªæˆ–ç«äº‰æ¡ä»¶ã€‚</p><h3 id="å®é™…åº”ç”¨ä¾‹å­-2" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ä¾‹å­-2"><span>å®é™…åº”ç”¨ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªå›¾åƒå¤„ç†åº”ç”¨ï¼Œç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ï¼Œä½ çš„æœåŠ¡éœ€è¦å¯¹å…¶è¿›è¡Œå‹ç¼©å’Œæ ¼å¼è½¬æ¢ã€‚è¿™ä¸ªå¤„ç†è¿‡ç¨‹æ˜¯ CPU å¯†é›†å‹çš„ï¼Œå¦‚æœåœ¨ Node.js çš„ä¸»çº¿ç¨‹ä¸Šè¿›è¡Œï¼Œå°†ä¼šé€ æˆæœåŠ¡å™¨å“åº”è¿Ÿç¼“ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½ å¯ä»¥ç¼–å†™ä¸€ä¸ª C++æ‰©å±•ï¼Œä½¿ç”¨ N-API åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å‡½æ•°ã€‚</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`napi.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å·¥ä½œå‡½æ•°ï¼Œå¯èƒ½åœ¨åå°çº¿ç¨‹ä¸Šè¿è¡Œ</span></span>
<span class="line"><span>void ProcessImage(const Napi::CallbackInfo&amp; info) {</span></span>
<span class="line"><span>    // ... å›¾åƒå¤„ç†é€»è¾‘ ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å½“å®Œæˆå·¥ä½œæ—¶ï¼Œè°ƒç”¨JavaScriptçš„å›è°ƒå‡½æ•°</span></span>
<span class="line"><span>    Napi::ThreadSafeFunction tsfn = info[0].As`&lt;`Napi::ThreadSafeFunction&gt;();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // é€šçŸ¥Node.jsçº¿ç¨‹è¦è°ƒç”¨çš„å›è°ƒå‡½æ•°</span></span>
<span class="line"><span>    napi_status status = tsfn.BlockingCall([](Napi::Env env, Napi::Function jsCallback) {</span></span>
<span class="line"><span>        // è°ƒç”¨JavaScriptå±‚é¢çš„å›è°ƒï¼Œå¹¶ä¼ é€’ç»“æœ</span></span>
<span class="line"><span>        jsCallback.Call({Napi::String::New(env, &quot;å¤„ç†å®Œæˆ&quot;)});</span></span>
<span class="line"><span>    });</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç¡®ä¿é‡Šæ”¾çº¿ç¨‹å®‰å…¨å‡½æ•°èµ„æº</span></span>
<span class="line"><span>    tsfn.Release();</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆå§‹åŒ–å‡½æ•°ï¼Œè®¾ç½®å¯¼å‡º</span></span>
<span class="line"><span>Napi::Object Init(Napi::Env env, Napi::Object exports) {</span></span>
<span class="line"><span>    exports.Set(</span></span>
<span class="line"><span>        Napi::String::New(env, &quot;processImage&quot;),</span></span>
<span class="line"><span>        Napi::Function::New(env, ProcessImage)</span></span>
<span class="line"><span>    );</span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NODE_API_MODULE(addon, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ JavaScript ä»£ç ä¸­ï¼Œä½ ä¼šåƒè¿™æ ·è°ƒç”¨è¿™ä¸ªæ‰©å±•ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9;"> addon</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> require</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">./build/Release/addon</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> callback</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">result</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">result</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // è¾“å‡º: &#39;å¤„ç†å®Œæˆ&#39;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">addon</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">processImage</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">callback</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>processImage</code>æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œå®ƒå¯åŠ¨äº†ä¸€ä¸ªåå°çº¿ç¨‹æ¥å¤„ç†å›¾åƒï¼Œå¹¶ä¸”ä¸ä¼šé˜»å¡ Node.js çš„ä¸»äº‹ä»¶å¾ªç¯ã€‚ä¸€æ—¦å›¾åƒå¤„ç†å®Œæˆï¼Œå®ƒå°†å®‰å…¨åœ°è°ƒç”¨ JavaScript å±‚é¢çš„<code>callback</code>å›è°ƒå‡½æ•°ï¼Œå³ä½¿è¿™ä¸ªè°ƒç”¨å‘ç”Ÿåœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸Šã€‚</p><h3 id="calling-a-thread-safe-function" tabindex="-1"><a class="header-anchor" href="#calling-a-thread-safe-function"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#calling-a-thread-safe-function" target="_blank" rel="noopener noreferrer">Calling a thread-safe function</a></span></a></h3><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬æ¥æ·±å…¥äº†è§£ Node.js ä¸­è°ƒç”¨çº¿ç¨‹å®‰å…¨å‡½æ•°çš„æ¦‚å¿µã€‚åœ¨ Node.js v21.7.1 æ–‡æ¡£ä¸­ï¼Œå…³äº&quot;Calling a thread-safe function&quot;æ˜¯æŒ‡ä½¿ç”¨ N-API ä¸­æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œæ¥ä»ä»»ä½•çº¿ç¨‹å®‰å…¨åœ°è°ƒç”¨ JavaScript å‡½æ•°ã€‚</p><p>é¦–å…ˆéœ€è¦æ˜ç™½å‡ ä¸ªå…³é”®ç‚¹ï¼š</p><ol><li><p><strong>JavaScript å•çº¿ç¨‹æ€§è´¨</strong>ï¼šJavaScript æ˜¯å•çº¿ç¨‹è¿è¡Œçš„ï¼Œè¿™æ„å‘³ç€å®ƒä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚ä½†åœ¨ç°å®ä¸–ç•Œçš„åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦æ‰§è¡Œåå°ä»»åŠ¡ï¼ˆå¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œè¯·æ±‚ç­‰ï¼‰ï¼Œè€Œä¸é˜»å¡ä¸»çº¿ç¨‹ã€‚</p></li><li><p><strong>Node.js çš„å¼‚æ­¥éé˜»å¡ I/O</strong>ï¼šNode.js é€šè¿‡äº‹ä»¶å¾ªç¯å’Œå›è°ƒå‡½æ•°ï¼Œä½¿å¾—å¯ä»¥éé˜»å¡åœ°å¤„ç†è¿™äº›è€—æ—¶æ“ä½œã€‚</p></li><li><p><strong>å¤šçº¿ç¨‹</strong>ï¼šå°½ç®¡ JavaScript æ˜¯å•çº¿ç¨‹çš„ï¼Œä½† Node.js å¯ä»¥é€šè¿‡ C++æ‰©å±•æˆ–è€…æ–°çš„ Worker Threads æ¨¡å—åˆ›å»ºå¤šçº¿ç¨‹ã€‚</p></li><li><p><strong>çº¿ç¨‹å®‰å…¨</strong>ï¼šå½“å¤šä¸ªçº¿ç¨‹å°è¯•åŒæ—¶è®¿é—®å’Œä¿®æ”¹åŒä¸€æ•°æ®æ—¶ï¼Œå¦‚æœæ²¡æœ‰é€‚å½“çš„åŒæ­¥ï¼Œå°±ä¼šå¯¼è‡´ç«æ€æ¡ä»¶ã€‚çº¿ç¨‹å®‰å…¨æ˜¯æŒ‡ä»£ç åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ‰§è¡Œæ—¶ï¼Œèƒ½å¤Ÿæ­£ç¡®å¤„ç†è®¿é—®å…±äº«èµ„æºçš„é€»è¾‘ï¼Œä»¥é¿å…é”™è¯¯å’Œæ•°æ®æŸåã€‚</p></li></ol><p>ç°åœ¨ï¼Œå½“æˆ‘ä»¬éœ€è¦åœ¨ä¸€ä¸ª Node.js çš„åŸç”Ÿæ¨¡å—ï¼ˆé€šå¸¸æ˜¯ç”¨ C++ç¼–å†™ï¼‰ä¸­çš„ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ä¸Šè¿è¡Œä»£ç ï¼Œå¹¶ä¸”æƒ³è¦åœ¨æŸä¸ªæ—¶åˆ»å›åˆ° JavaScript ç¯å¢ƒä¸­æ‰§è¡Œä¸€äº› JavaScript ä»£ç æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°çº¿ç¨‹å®‰å…¨å‡½æ•°ã€‚N-API æä¾›äº†<code>napi_create_threadsafe_function</code>å’Œç›¸å…³ APIs æ¥åˆ›å»ºè¿™æ ·ä¸€ç§å‡½æ•°ã€‚</p><p>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜è¿™ä¸€ç‚¹ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åŸç”Ÿæ¨¡å—ï¼Œè¯¥æ¨¡å—éœ€è¦æ‰§è¡Œ CPU å¯†é›†å‹çš„å›¾åƒå¤„ç†ä»»åŠ¡ã€‚å› ä¸ºè¿™ä¸ªä»»åŠ¡å¯èƒ½éœ€è¦å‡ ç§’é’Ÿï¼Œæ‰€ä»¥ä½ å†³å®šå°†å…¶æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„å·¥ä½œçº¿ç¨‹ä¸­è¿›è¡Œï¼Œä»¥å…é˜»å¡ Node.js çš„ä¸»çº¿ç¨‹ã€‚å½“å›¾åƒå¤„ç†å®Œæˆåï¼Œä½ æƒ³é€šçŸ¥ JavaScript ä»£ç å¹¶å‘é€ç»“æœå›å»ã€‚è¿™é‡Œå°±å¯ä»¥ä½¿ç”¨çº¿ç¨‹å®‰å…¨å‡½æ•°äº†ã€‚</p><p>ä»¥ä¸‹æ˜¯è¯¥è¿‡ç¨‹çš„ç®€åŒ–æ­¥éª¤ï¼š</p><ol><li><p>åœ¨ä½ çš„åŸç”Ÿæ¨¡å—ä¸­ï¼Œä½¿ç”¨<code>napi_create_threadsafe_function</code>åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°ã€‚ä½ å°†æä¾›ä¸€ä¸ª JavaScript å›è°ƒå‡½æ•°ï¼Œåœ¨é€‚å½“çš„æ—¶å€™ï¼Œè¿™ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°å°†è¢«è°ƒç”¨ã€‚</p></li><li><p>ä»å·¥ä½œçº¿ç¨‹ä¸­ï¼Œå½“ä½ å®Œæˆäº†å›¾åƒå¤„ç†ä»»åŠ¡ï¼Œä½¿ç”¨<code>napi_call_threadsafe_function</code>è°ƒç”¨è¿™ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°ï¼Œå¹¶ä¼ é€’å¤„ç†åçš„å›¾åƒæ•°æ®ã€‚</p></li><li><p>è¿™ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°å°†æŒ‰ç…§ Node.js çš„è§„åˆ™å®‰å…¨åœ°æŠŠæ§åˆ¶æƒäº¤è¿˜ç»™ JavaScript ç¯å¢ƒï¼Œå¹¶è°ƒç”¨ Step 1 ä¸­æä¾›çš„ JavaScript å›è°ƒå‡½æ•°ï¼Œå°†å›¾åƒå¤„ç†ç»“æœä¼ é€’ç»™å®ƒã€‚</p></li></ol><p>å…·ä½“ä»£ç å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value MyNativeModuleInit(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    // æ‰§è¡Œä¸€äº›åˆå§‹åŒ–å·¥ä½œ</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºçº¿ç¨‹å®‰å…¨å‡½æ•°</span></span>
<span class="line"><span>    napi_value my_js_cb;</span></span>
<span class="line"><span>    // å‡è®¾my_js_callback_refæ˜¯å·²ç»‘å®šçš„JavaScriptå›è°ƒå‡½æ•°çš„å¼•ç”¨</span></span>
<span class="line"><span>    napi_get_reference_value(env, my_js_callback_ref, &amp;my_js_cb);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_threadsafe_function tsfn;</span></span>
<span class="line"><span>    napi_create_threadsafe_function(env, my_js_cb, NULL, &quot;MyThreadsafeFunction&quot;, 0, 1, NULL, NULL, NULL, MyCallJs, &amp;tsfn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¯åŠ¨å·¥ä½œçº¿ç¨‹ï¼Œä¼ é€’çº¿ç¨‹å®‰å…¨å‡½æ•°ç»™å®ƒ</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void MyImageProcessingThread(void* data) {</span></span>
<span class="line"><span>    // ...æ‰§è¡Œå›¾åƒå¤„ç†...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¤„ç†å®Œæ¯•ï¼Œç°åœ¨è°ƒç”¨çº¿ç¨‹å®‰å…¨å‡½æ•°</span></span>
<span class="line"><span>    napi_call_threadsafe_function(tsfn, processed_image_data, napi_tsfn_blocking);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¢«çº¿ç¨‹å®‰å…¨å‡½æ•°å†…éƒ¨è°ƒç”¨ä»¥è§¦å‘JavaScriptç«¯çš„å›è°ƒ</span></span>
<span class="line"><span>void MyCallJs(napi_env env, napi_value js_cb, void* context, void* data) {</span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªnapi_valueæ¥åŒ…è£…dataï¼Œç„¶åä½œä¸ºå‚æ•°ä¼ é€’ç»™å›è°ƒå‡½æ•°js_cb</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šä»£ç æ˜¯ä¸€ä¸ªé«˜çº§æ¦‚è¿°ï¼ŒçœŸæ­£çš„å®ç°å°†æ¶‰åŠæ›´å¤šç»†èŠ‚ï¼Œæ¯”å¦‚é”™è¯¯å¤„ç†ã€èµ„æºæ¸…ç†ç­‰ã€‚é€šè¿‡ä½¿ç”¨çº¿ç¨‹å®‰å…¨å‡½æ•°ï¼ŒåŸç”Ÿæ¨¡å—å¯ä»¥åœ¨ä¸é˜»å¡ Node.js ä¸»çº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œå®‰å…¨åœ°åè°ƒ JavaScript å’Œ C++ä»£ç ä¹‹é—´çš„äº¤äº’ã€‚</p><h3 id="reference-counting-of-thread-safe-functions" tabindex="-1"><a class="header-anchor" href="#reference-counting-of-thread-safe-functions"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#reference-counting-of-thread-safe-functions" target="_blank" rel="noopener noreferrer">Reference counting of thread-safe functions</a></span></a></h3><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€å¥—ç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚è¿™äº›åŸç”Ÿæ’ä»¶å…è®¸ä½ ç”¨ C æˆ– C++ç¼–å†™ä»£ç ï¼Œç„¶ååœ¨ Node.js ç¯å¢ƒä¸­è¿è¡Œã€‚è¿™é€šå¸¸ç”¨äºæ‰§è¡Œæ€§èƒ½å¯†é›†å‹ä»»åŠ¡ï¼Œå¦‚æ•°å­¦è®¡ç®—ã€å›¾åƒå¤„ç†æˆ–ä¸ç³»ç»Ÿåº•å±‚ç¡¬ä»¶äº¤äº’ã€‚</p><h3 id="reference-counting-of-thread-safe-functions-1" tabindex="-1"><a class="header-anchor" href="#reference-counting-of-thread-safe-functions-1"><span>Reference Counting of Thread-Safe Functions</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œå½“æˆ‘ä»¬è°ˆè®ºçº¿ç¨‹å®‰å…¨å‡½æ•°ï¼ˆThread-safe functionsï¼‰æ—¶ï¼Œæˆ‘ä»¬æŒ‡çš„æ˜¯ä¸€ç±»ç‰¹æ®Šçš„å‡½æ•°ï¼Œå®ƒä»¬å¯ä»¥å®‰å…¨åœ°ä»å¤šä¸ªçº¿ç¨‹è°ƒç”¨ï¼Œå¹¶ä¸”èƒ½åœ¨ Node.js çš„äº‹ä»¶å¾ªç¯ä¸­æ­£ç¡®åœ°æ‰§è¡Œå›è°ƒã€‚</p><p>&quot;Reference counting&quot; æ˜¯ä¸€ç§èµ„æºç®¡ç†æŠ€æœ¯ï¼Œç¡®ä¿åªè¦æœ‰ä»»ä½•åœ°æ–¹éœ€è¦ä½¿ç”¨ä¸€ä¸ªèµ„æºï¼ˆæ¯”å¦‚ä¸€ä¸ªå¯¹è±¡æˆ–è€…å†…å­˜ç©ºé—´ï¼‰ï¼Œè¯¥èµ„æºå°±ä¸ä¼šè¢«é”€æ¯ã€‚åœ¨èµ„æºä¸å†è¢«éœ€è¦æ—¶ï¼Œé€šè¿‡å‡å°‘å¼•ç”¨è®¡æ•°ï¼Œæœ€ç»ˆå¯ä»¥é‡Šæ”¾å®ƒã€‚</p><p>å¯¹äºçº¿ç¨‹å®‰å…¨å‡½æ•°è€Œè¨€ï¼Œä½¿ç”¨å¼•ç”¨è®¡æ•°æ„å‘³ç€ä½ å¯ä»¥è·Ÿè¸ªæœ‰å¤šå°‘æ´»åŠ¨çš„å¼‚æ­¥æ“ä½œæ­£åœ¨ä½¿ç”¨è¯¥å‡½æ•°ã€‚æ¯å½“å¼€å§‹ä¸€ä¸ªæ–°çš„æ“ä½œæ—¶ï¼Œå¢åŠ å¼•ç”¨è®¡æ•°ï¼›æ¯å½“æ“ä½œå®Œæˆæ—¶ï¼Œå‡å°‘å¼•ç”¨è®¡æ•°ã€‚å½“å¼•ç”¨è®¡æ•°é™è‡³é›¶æ—¶ï¼Œè¡¨ç¤ºæ²¡æœ‰ä»»ä½•å¼‚æ­¥æ“ä½œæ­£åœ¨ä½¿ç”¨è¯¥å‡½æ•°ï¼Œå®ƒå¯ä»¥è¢«å®‰å…¨é”€æ¯ã€‚</p><h4 id="å®é™…åº”ç”¨ä¾‹å­-3" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ä¾‹å­-3"><span>å®é™…åº”ç”¨ä¾‹å­ï¼š</span></a></h4><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª Node.js åº”ç”¨ç¨‹åºï¼Œéœ€è¦åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œä¸€äº› CPU å¯†é›†å‹çš„å›¾åƒå¤„ç†ä»»åŠ¡ã€‚ä¸ºäº†ä¸é˜»å¡ä¸»äº‹ä»¶å¾ªç¯ï¼Œä½ å†³å®šä½¿ç”¨çº¿ç¨‹å®‰å…¨å‡½æ•°æ¥ä»ä¸åŒçº¿ç¨‹å‘é€å¤„ç†ç»“æœå›åˆ° Node.js çš„ä¸»çº¿ç¨‹ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–çš„ç¤ºä¾‹ï¼š</p><ol><li><strong>åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°</strong>ï¼š<br> ä½ é¦–å…ˆåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°ï¼Œå®ƒå¯ä»¥ä»å…¶ä»–çº¿ç¨‹è°ƒç”¨ï¼Œå¹¶å°†å¤„ç†ç»“æœä¼ å›ä¸»çº¿ç¨‹ã€‚</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_threadsafe_function tsfn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void CallJs(napi_env env, napi_value js_callback, void* context, void* data) {</span></span>
<span class="line"><span>  // è¿™é‡Œå¯ä»¥è°ƒç”¨JavaScriptçš„å›è°ƒå‡½æ•°ï¼Œå¤„ç†ä»å…¶ä»–çº¿ç¨‹ä¼ å›çš„æ•°æ®</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ›å»ºçº¿ç¨‹å®‰å…¨å‡½æ•°</span></span>
<span class="line"><span>napi_create_threadsafe_function(env, js_callback, async_resource, async_resource_name, 0, 1, nullptr, nullptr, nullptr, CallJs, &amp;tsfn);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ<code>napi_create_threadsafe_function</code> å°±æ˜¯ç”¨æ¥åˆ›å»ºçº¿ç¨‹å®‰å…¨å‡½æ•°çš„ API è°ƒç”¨ï¼Œå…¶ä¸­ <code>CallJs</code> æ˜¯å½“å…¶ä»–çº¿ç¨‹å‡†å¤‡å¥½æ•°æ®æ—¶å°†è¢«è°ƒç”¨çš„ C++å‡½æ•°ã€‚</p><ol start="2"><li><strong>å¢åŠ å¼•ç”¨è®¡æ•°</strong>ï¼š<br> å½“ä½ å¼€å§‹ä¸€ä¸ªæ–°çš„å›¾åƒå¤„ç†æ“ä½œæ—¶ï¼Œä½ ä¼šå¢åŠ çº¿ç¨‹å®‰å…¨å‡½æ•°çš„å¼•ç”¨è®¡æ•°ã€‚</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_acquire_threadsafe_function(tsfn);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="3"><li><strong>åœ¨å…¶ä»–çº¿ç¨‹ä¸Šå¤„ç†å›¾åƒå¹¶å°†ç»“æœä¼ å›</strong>ï¼š<br> åœ¨åå°çº¿ç¨‹ä¸­è¿›è¡Œå›¾åƒå¤„ç†ï¼Œå¤„ç†å®Œåä½¿ç”¨çº¿ç¨‹å®‰å…¨å‡½æ•°å°†ç»“æœä¼ å›ä¸»çº¿ç¨‹ã€‚</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>void ProcessImageInBackground(std::string imagePath) {</span></span>
<span class="line"><span>  // æ‰§è¡Œå›¾åƒå¤„ç†...</span></span>
<span class="line"><span>  // å¤„ç†å®Œæˆåï¼Œå°†ç»“æœé€šè¿‡çº¿ç¨‹å®‰å…¨å‡½æ•°å‘é€å›ä¸»çº¿ç¨‹</span></span>
<span class="line"><span>  napi_call_threadsafe_function(tsfn, resultData, napi_tsfn_blocking);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>std::thread worker(ProcessImageInBackground, &quot;path/to/image.png&quot;);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li><strong>å‡å°‘å¼•ç”¨è®¡æ•°</strong>ï¼š<br> å½“åå°ä»»åŠ¡å®Œæˆå¹¶ä¸”ç»“æœå·²ç»è¢«ä¼ é€’å›ä¸»çº¿ç¨‹åï¼Œä½ å‡å°‘çº¿ç¨‹å®‰å…¨å‡½æ•°çš„å¼•ç”¨è®¡æ•°ã€‚å¦‚æœå‡å°‘åè®¡æ•°ä¸ºé›¶ï¼Œå‡½æ•°èµ„æºå°†è¢«æ¸…ç†ã€‚</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_release_threadsafe_function(tsfn, napi_tsfn_release);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="5"><li><strong>åœ¨ JavaScript ä¸­æ¥æ”¶ç»“æœ</strong>ï¼š<br> åœ¨ Node.js çš„ JavaScript éƒ¨åˆ†ï¼Œä½ å®šä¹‰äº†ä¸€ä¸ªå›è°ƒå‡½æ•°æ¥æ¥æ”¶å¤„ç†ç»“æœã€‚</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> onImageProcessed</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">result</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Image processed:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> result</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šæ­¥éª¤æ¼”ç¤ºäº†ä¸€ä¸ªä½¿ç”¨çº¿ç¨‹å®‰å…¨å‡½æ•°å’Œå¼•ç”¨è®¡æ•°æœºåˆ¶çš„ç®€å•æµç¨‹ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨å¼‚æ­¥æ“ä½œå®Œæˆå‰ï¼Œå‡½æ•°èµ„æºä¸ä¼šè¢«é”™è¯¯åœ°é”€æ¯ã€‚</p><h3 id="deciding-whether-to-keep-the-process-running" tabindex="-1"><a class="header-anchor" href="#deciding-whether-to-keep-the-process-running"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#deciding-whether-to-keep-the-process-running" target="_blank" rel="noopener noreferrer">Deciding whether to keep the process running</a></span></a></h3><p>Node.js ä¸­çš„ N-API æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ¬åœ°æ’ä»¶çš„ APIã€‚å®ƒå…è®¸ä½ ç”¨ C æˆ– C++ ç¼–å†™ä¸ Node.js äº¤äº’çš„ä»£ç ï¼Œè¿™äº›ä»£ç å¯ä»¥ç›´æ¥è°ƒç”¨ JavaScript å¼•æ“æä¾›çš„åŠŸèƒ½ï¼Œå¹¶ä¸”å¯ä»¥åˆ›å»ºæˆ–æ“ä½œ JavaScript å€¼ã€‚</p><p>åœ¨ä½¿ç”¨ N-API æ„å»ºæœ¬åœ°æ’ä»¶æ—¶ï¼Œæœ‰æ—¶å€™éœ€è¦å†³å®šæ˜¯å¦è®© Node.js è¿›ç¨‹ç»§ç»­è¿è¡Œï¼Œå³ä½¿ JavaScript æ²¡æœ‰æ´»åŠ¨ä»»åŠ¡è¦æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ çš„æœ¬åœ°æ’ä»¶å¯åŠ¨äº†ä¸€ä¸ªåå°çº¿ç¨‹æˆ–è€…å…¶ä»–å¼‚æ­¥æ“ä½œï¼Œå¯èƒ½å¸Œæœ›ä¿æŒ Node.js è¿›ç¨‹è¿è¡Œç›´åˆ°è¿™äº›æ“ä½œå®Œæˆã€‚</p><p>ä¸ºäº†æ§åˆ¶è¿™ä¸€è¡Œä¸ºï¼ŒN-API æä¾›äº†ä¸¤ä¸ªé‡è¦çš„å‡½æ•°ï¼š</p><ol><li><code>napi_ref_threadsafe_function</code></li><li><code>napi_unref_threadsafe_function</code></li></ol><p>é€šè¿‡è¿™äº›å‡½æ•°ï¼Œä½ å¯ä»¥å‘ Node.js å¼•æ“è¡¨æ˜ï¼Œå°½ç®¡å½“å‰æ²¡æœ‰ JavaScript ä»£ç åœ¨è¿è¡Œï¼Œä½†æ˜¯åå°ä»æœ‰æ´»åŠ¨æ­£åœ¨è¿›è¡Œï¼Œå› æ­¤ä¸åº”è¯¥é€€å‡ºè¿›ç¨‹ã€‚</p><p>ä¸‹é¢é€šè¿‡å‡ ä¸ªä¾‹å­æ¥è¯´æ˜è¿™äº›å‡½æ•°çš„å®é™…ä½¿ç”¨æƒ…å†µï¼š</p><h3 id="ä¾‹å­-1-å¯åŠ¨åå°ä»»åŠ¡" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-1-å¯åŠ¨åå°ä»»åŠ¡"><span>ä¾‹å­ 1ï¼šå¯åŠ¨åå°ä»»åŠ¡</span></a></h3><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªæ‰§è¡Œé•¿æ—¶é—´è®¡ç®—çš„ C å‡½æ•°ï¼Œä½ ä¸æƒ³é˜»å¡ Node.js çš„äº‹ä»¶å¾ªç¯ã€‚ä½ å¯èƒ½ä¼šåœ¨æœ¬åœ°æ’ä»¶ä¸­åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†è¿™ä¸ªè®¡ç®—ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span>#include `&lt;`stdlib.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªå‡½æ•°å°†åœ¨æ–°çº¿ç¨‹ä¸Šæ‰§è¡Œçš„é•¿æ—¶é—´è®¡ç®—ä»»åŠ¡</span></span>
<span class="line"><span>void LongComputationTask(void* data) {</span></span>
<span class="line"><span>    // ... é•¿æ—¶é—´è®¡ç®— ...</span></span>
<span class="line"><span>    // å®Œæˆåé€šçŸ¥ Node.js ä¸»çº¿ç¨‹</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯æš´éœ²ç»™ Node.js ä½¿ç”¨çš„å‡½æ•°</span></span>
<span class="line"><span>napi_value StartLongComputation(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¹¶å¼€å§‹é•¿æ—¶é—´è®¡ç®—ä»»åŠ¡</span></span>
<span class="line"><span>    pthread_t thread_id;</span></span>
<span class="line"><span>    pthread_create(&amp;thread_id, NULL, LongComputationTask, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // é€šçŸ¥ Node.js ä¸è¦é€€å‡ºï¼Œå³ä½¿äº‹ä»¶å¾ªç¯ä¸ºç©º</span></span>
<span class="line"><span>    napi_ref_threadsafe_function(env, ...);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰è¯¦ç»†å±•ç¤ºå¦‚ä½•ä½¿ç”¨ <code>napi_ref_threadsafe_function</code> æ¥å¼•ç”¨çº¿ç¨‹å®‰å…¨å‡½æ•°ï¼Œå› ä¸ºè¿™æ¶‰åŠåˆ°æ›´å¤æ‚çš„ N-API ç”¨æ³•ï¼ŒåŒ…æ‹¬åˆ›å»º <code>napi_threadsafe_function</code> å’Œæ­£ç¡®ç®¡ç†å¼•ç”¨è®¡æ•°ã€‚</p><h3 id="ä¾‹å­-2-åœæ­¢åå°ä»»åŠ¡" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­-2-åœæ­¢åå°ä»»åŠ¡"><span>ä¾‹å­ 2ï¼šåœæ­¢åå°ä»»åŠ¡</span></a></h3><p>å½“åå°ä»»åŠ¡å®Œæˆæ—¶ï¼Œä½ éœ€è¦å‘Šè¯‰ Node.js å®ƒå¯ä»¥é€€å‡ºäº†ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–ä»»åŠ¡åœ¨è¿è¡Œçš„è¯ã€‚è¿™æ˜¯é€šè¿‡ <code>napi_unref_threadsafe_function</code> æ¥å®ç°çš„ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å½“åå°ä»»åŠ¡å®Œæˆåè¢«è°ƒç”¨</span></span>
<span class="line"><span>void OnTaskComplete(napi_env env, void* data) {</span></span>
<span class="line"><span>    // å‘Šè¯‰ Node.js å®ƒå¯ä»¥é€€å‡ºäº†</span></span>
<span class="line"><span>    napi_unref_threadsafe_function(env, ...);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€æ—¦ <code>OnTaskComplete</code> è¢«è°ƒç”¨ï¼Œå°±ä¼šå‡å°‘ <code>napi_threadsafe_function</code> çš„å¼•ç”¨è®¡æ•°ã€‚å¦‚æœæ²¡æœ‰å…¶ä»–æ´»åŠ¨é˜»æ­¢ Node.js é€€å‡ºï¼Œé‚£ä¹ˆè¿›ç¨‹å¯èƒ½ä¼šåœ¨æ­¤ä¹‹åç»“æŸã€‚</p><p>æœ€å…³é”®çš„æ˜¯ç†è§£ï¼Œé€šè¿‡è¿™äº› APIï¼Œä½ å¯ä»¥ç²¾ç¡®åœ°æ§åˆ¶ Node.js è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»è€Œç¡®ä¿ä¸ä¼šè¿‡æ—©åœ°é€€å‡ºï¼Œä¹Ÿä¸ä¼šæ— å¿…è¦åœ°æŒ‚èµ·ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½¿ç”¨è¿™äº›åŠŸèƒ½é€šå¸¸æ¶‰åŠåˆ°å¼‚æ­¥ç¼–ç¨‹å’Œå¯¹ Node.js äº‹ä»¶å¾ªç¯çš„æ·±å…¥ç†è§£ã€‚</p><h3 id="napi-create-threadsafe-function" tabindex="-1"><a class="header-anchor" href="#napi-create-threadsafe-function"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_create_threadsafe_function" target="_blank" rel="noopener noreferrer">napi_create_threadsafe_function</a></span></a></h3><p>Node.js ä¸­çš„ <code>napi_create_threadsafe_function</code> æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„åŠŸèƒ½ï¼Œå®ƒå…è®¸ä½ åœ¨åŸç”Ÿæ‰©å±•ä¸­å®‰å…¨åœ°è°ƒç”¨ JavaScript å‡½æ•°ï¼Œå³ä½¿æ˜¯åœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ã€‚ç†è§£è¿™ä¸ªåŠŸèƒ½ä¹‹å‰ï¼Œå…ˆéœ€è¦äº†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µã€‚</p><h3 id="åŸºæœ¬æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ¦‚å¿µ"><span>åŸºæœ¬æ¦‚å¿µ</span></a></h3><ol><li><strong>N-API</strong>: Node.js çš„ä¸€ä¸ª API å±‚ï¼Œå…è®¸ä½ ä½¿ç”¨ C æˆ–è€… C++ ç¼–å†™æ‰©å±•æ¨¡å—ï¼Œè¿™äº›æ¨¡å—å¯ä»¥ç›´æ¥ä¸ Node.js çš„ V8 å¼•æ“äº¤äº’ã€‚</li><li><strong>Thread-safe</strong>: å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œä»£ç æ—¶ï¼Œå¦‚æœæ¯æ¬¡è¿è¡Œç»“æœå’Œå•çº¿ç¨‹è¿è¡Œç»“æœä¸€è‡´ï¼Œå¹¶ä¸”ä¸ä¼šå¼•å‘è¿è¡Œæ—¶é”™è¯¯ï¼Œåˆ™è®¤ä¸ºè¿™æ®µä»£ç æ˜¯â€œçº¿ç¨‹å®‰å…¨â€çš„ã€‚</li></ol><p>å½“ä½ ç¼–å†™ä¸€ä¸ªèƒ½å¤Ÿæ‰§è¡Œå¼‚æ­¥æ“ä½œï¼ˆä¾‹å¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œè¯·æ±‚ç­‰ï¼‰çš„ Node.js åŸç”Ÿæ‰©å±•æ—¶ï¼Œä½ å¯èƒ½éœ€è¦åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œä¸€äº›ä»»åŠ¡ï¼Œè€Œå®Œæˆè¿™äº›ä»»åŠ¡åï¼Œä½ åˆæƒ³å›åˆ°ä¸»çº¿ç¨‹ä¸­æ¥æ›´æ–° JavaScript ç¯å¢ƒæˆ–è°ƒç”¨ JavaScript å‡½æ•°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ ä¸èƒ½ç®€å•åœ°ä»åå°çº¿ç¨‹ç›´æ¥è°ƒç”¨ JavaScript å‡½æ•°ï¼Œå› ä¸º V8 ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æ‰€ä»¥ä½ éœ€è¦ä½¿ç”¨ <code>napi_create_threadsafe_function</code> æ¥åˆ›å»ºä¸€ä¸ªå¯ä»¥è·¨çº¿ç¨‹å®‰å…¨è°ƒç”¨çš„å‡½æ•°ã€‚</p><h3 id="å·¥ä½œæœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#å·¥ä½œæœºåˆ¶"><span>å·¥ä½œæœºåˆ¶</span></a></h3><p><code>napi_create_threadsafe_function</code> å…è®¸ä½ å°†ä¸€ä¸ª JavaScript å‡½æ•°å°è£…æˆä¸€ä¸ªå¯ä»¥ä»ä»»ä½•çº¿ç¨‹å®‰å…¨è°ƒç”¨çš„ <code>ThreadsafeFunction</code>ã€‚å†…éƒ¨æœºåˆ¶å¤§è‡´å¦‚ä¸‹ï¼š</p><ul><li>åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œä½ è°ƒç”¨ <code>napi_create_threadsafe_function</code> åˆ›å»ºä¸€ä¸ª <code>ThreadsafeFunction</code>ã€‚</li><li>åœ¨åå°çº¿ç¨‹ä¸­ï¼Œä½ é€šè¿‡è°ƒç”¨ <code>napi_call_threadsafe_function</code> æ¥è§¦å‘è¿™ä¸ª JavaScript å‡½æ•°çš„æ‰§è¡Œã€‚</li><li>Node.js ä¼šç¡®ä¿ä¸ç®¡åœ¨å“ªä¸ªçº¿ç¨‹è°ƒç”¨è¯¥å‡½æ•°ï¼Œæœ€ç»ˆéƒ½ä¼šåœ¨ä¸€ä¸ªå®‰å…¨çš„ä¸Šä¸‹æ–‡ï¼ˆæ¯”å¦‚ä¸»çº¿ç¨‹æˆ–äº‹ä»¶å¾ªç¯çš„æŸä¸ªé˜¶æ®µï¼‰ä¸­æ‰§è¡ŒåŸå§‹çš„ JavaScript å‡½æ•°ã€‚</li></ul><h3 id="å®é™…ä¾‹å­-11" tabindex="-1"><a class="header-anchor" href="#å®é™…ä¾‹å­-11"><span>å®é™…ä¾‹å­</span></a></h3><p>å‡è®¾ä½ æ­£åœ¨å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œéœ€è¦ä»ä¸€ä¸ª C/C++ çš„åå°çº¿ç¨‹è·å–æ•°æ®ç„¶ååœ¨ JavaScript ç«¯è¿›è¡Œå¤„ç†ã€‚</p><ol><li><strong>é¦–å…ˆï¼Œåœ¨ JavaScript å±‚é¢å®šä¹‰ä¸€ä¸ªå›è°ƒå‡½æ•°</strong>ï¼š</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" data-title="javascript" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">function</span><span style="color:#88C0D0;"> processData</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">  // è¿™é‡Œçš„ data å°†æ˜¯ä» C/C++ åå°çº¿ç¨‹ä¼ é€’è¿‡æ¥çš„æ•°æ®</span></span>
<span class="line"><span style="color:#D8DEE9;">  console</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">log</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">å¤„ç†æ•°æ®:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> data</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong>åœ¨åŸç”Ÿæ¨¡å—ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª ThreadsafeFunction</strong>ï¼š</li></ol><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª processData å‡½æ•°æŒ‡é’ˆå·²ç»ä¼ å…¥</span></span>
<span class="line"><span>napi_value processDataFn;</span></span>
<span class="line"><span>napi_value resourceName;</span></span>
<span class="line"><span>napi_threadsafe_function tsfn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_create_string_utf8(env, &quot;ResourceName&quot;, NAPI_AUTO_LENGTH, &amp;resourceName);</span></span>
<span class="line"><span>napi_create_threadsafe_function(env, processDataFn, NULL, resourceName, 0, 1,</span></span>
<span class="line"><span>                                NULL, NULL, NULL, CallJs, &amp;tsfn);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><strong>åœ¨åå°çº¿ç¨‹ä¸­ï¼Œä½ å¯ä»¥è°ƒç”¨ <code>napi_call_threadsafe_function</code> è§¦å‘è¿™ä¸ªå‡½æ•°</strong>ï¼š</li></ol><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>void* run_thread(void* arg) {</span></span>
<span class="line"><span>  // æ¨¡æ‹Ÿäº§ç”Ÿæ•°æ®</span></span>
<span class="line"><span>  int data = 100;</span></span>
<span class="line"><span>  napi_call_threadsafe_function(tsfn, &amp;data, napi_tsfn_blocking);</span></span>
<span class="line"><span>  return NULL;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// somewhere in your code to start a new thread</span></span>
<span class="line"><span>pthread_t thread;</span></span>
<span class="line"><span>pthread_create(&amp;thread, NULL, run_thread, NULL);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li><strong>æœ€åï¼Œæ¸…ç†èµ„æº</strong>ï¼š</li></ol><p>å½“ä½ å®Œæˆæ‰€æœ‰å·¥ä½œå¹¶ä¸”ä¸å†éœ€è¦ <code>ThreadsafeFunction</code>ï¼Œä½ åº”è¯¥é‡Šæ”¾å®ƒï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_release_threadsafe_function(tsfn, napi_tsfn_release);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ä»¥ä¸Šï¼Œæ˜¯å¯¹ <code>napi_create_threadsafe_function</code> çš„ä¸€ä¸ªç®€åŒ–çš„è§£é‡Šå’Œä¾‹å­ã€‚åœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œä½ å°†éœ€è¦ç®¡ç†æ›´å¤æ‚çš„æƒ…å†µï¼Œæ¯”å¦‚é”™è¯¯å¤„ç†ã€æ­£ç¡®çš„èµ„æºæ¸…ç†ç­‰ã€‚ä½†åŸºæœ¬åŸåˆ™æ˜¯ï¼šä½¿ç”¨ <code>napi_create_threadsafe_function</code> å¯ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å®‰å…¨åœ°è°ƒç”¨ JavaScript å‡½æ•°ã€‚</p><h3 id="napi-get-threadsafe-function-context" tabindex="-1"><a class="header-anchor" href="#napi-get-threadsafe-function-context"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_get_threadsafe_function_context" target="_blank" rel="noopener noreferrer">napi_get_threadsafe_function_context</a></span></a></h3><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬æ¥èŠä¸€èŠ Node.js ä¸­çš„ napi_get_threadsafe_function_context å‡½æ•°ã€‚</p><p>é¦–å…ˆï¼Œè¦äº†è§£è¿™ä¸ª APIï¼Œä½ éœ€è¦çŸ¥é“ N-API æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªç”¨ C ç¼–å†™çš„æ’ä»¶ APIï¼Œå®ƒç‹¬ç«‹äºåº•å±‚çš„ JavaScript è¿è¡Œæ—¶ï¼ˆæ¯”å¦‚ V8ï¼‰å¹¶ä¸”æ˜¯ç¨³å®šçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨ N-API ç¼–å†™çš„åŸç”Ÿæ¨¡å—ä¸ç”¨æ‹…å¿ƒ Node.js ç‰ˆæœ¬å‡çº§å¯¼è‡´çš„å…¼å®¹æ€§é—®é¢˜ã€‚</p><p>å†æ¥ï¼ŒThread-safe functionï¼ˆçº¿ç¨‹å®‰å…¨å‡½æ•°ï¼‰æ˜¯ N-API ä¸­ä¸€ä¸ªç‰¹æ®Šæ¦‚å¿µã€‚åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå½“ä½ å°è¯•ä»ä¸€ä¸ªéä¸»çº¿ç¨‹è®¿é—® Node.js çš„ç¯å¢ƒæ—¶ï¼Œé€šå¸¸ä¼šå‡ºç°é—®é¢˜ï¼Œå› ä¸º Node.js çš„å¤§éƒ¨åˆ†æ ¸å¿ƒéƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä¸ºäº†åœ¨èƒŒæ™¯å·¥ä½œçº¿ç¨‹ä¸ä¸»äº‹ä»¶å¾ªç¯ä¹‹é—´å®‰å…¨åœ°ä¼ é€’æ•°æ®ï¼ŒN-API æä¾›äº†çº¿ç¨‹å®‰å…¨å‡½æ•°ã€‚</p><p>ç°åœ¨ï¼Œå½“æˆ‘ä»¬è°ˆè®º<code>napi_get_threadsafe_function_context</code>ï¼Œæˆ‘ä»¬æŒ‡çš„æ˜¯ä»å·²ç»åˆ›å»ºçš„çº¿ç¨‹å®‰å…¨å‡½æ•°ä¸­æ£€ç´¢å…¶ä¸Šä¸‹æ–‡ã€‚æ¯ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°éƒ½æœ‰ä¸€ä¸ªå…³è”çš„ä¸Šä¸‹æ–‡ï¼Œä½ åœ¨åˆ›å»ºå®ƒçš„æ—¶å€™å¯ä»¥æŒ‡å®šã€‚è¿™ä¸ªä¸Šä¸‹æ–‡æ˜¯ä¸ªâ€œé»‘ç›’å­â€ï¼Œå¯ä»¥æ˜¯ä»»ä½•ä½ æƒ³è¦çš„æ•°æ®ç»“æ„ï¼Œä½ å¯èƒ½ä¼šåœ¨è°ƒç”¨è¯¥å‡½æ•°æ—¶ç”¨åˆ°è¿™ä¸ªä¸Šä¸‹æ–‡æ•°æ®ã€‚</p><p>ä¸‹é¢æˆ‘ä¼šç»™ä½ ä¸€ä¸ªä¾‹å­å¦‚ä½•å®é™…åº”ç”¨<code>napi_get_threadsafe_function_context</code>ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿ Node.js æ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—ä¼šåœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œä¸€äº›è€—æ—¶æ“ä½œï¼Œç„¶åéœ€è¦å°†ç»“æœå›ä¼ ç»™ Node.js çš„ä¸»çº¿ç¨‹ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œä½ å¯èƒ½ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°ï¼Œå¹¶ä¸”å¸¦æœ‰ä¸€äº›ä¸Šä¸‹æ–‡æ•°æ®ï¼Œä¾‹å¦‚æ“ä½œçš„ç±»å‹æˆ–è€…å…¶ä»–çŠ¶æ€ä¿¡æ¯ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>// å‡è®¾è¿™æ˜¯ä½ çš„ä¸Šä¸‹æ–‡ç»“æ„ä½“</span></span>
<span class="line"><span>typedef struct {</span></span>
<span class="line"><span>  int operationType;</span></span>
<span class="line"><span>  // ... å¯èƒ½è¿˜æœ‰å…¶ä»–çŠ¶æ€ä¿¡æ¯</span></span>
<span class="line"><span>} MyContext;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åˆ›å»ºçº¿ç¨‹å®‰å…¨å‡½æ•°æ—¶çš„æŸä¸ªå›è°ƒå‡½æ•°</span></span>
<span class="line"><span>void CallJs(napi_env env, napi_value js_callback, void* context, void* data) {</span></span>
<span class="line"><span>  // å°†contextè½¬åŒ–ä¸ºä½ è‡ªå·±çš„ä¸Šä¸‹æ–‡ç»“æ„ä½“</span></span>
<span class="line"><span>  MyContext* my_context = (MyContext*)context;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ä½ å¯ä»¥æ ¹æ®my_contextä¸­çš„ä¿¡æ¯æ¥å†³å®šæ€ä¹ˆå¤„ç†data</span></span>
<span class="line"><span>  // ç„¶åä½ å¯èƒ½ä¼šè°ƒç”¨js_callbackæ¥å°†ç»“æœä¼ é€’ç»™Node.jsçš„ä¸»çº¿ç¨‹</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... åœ¨æŸä¸ªåœ°æ–¹ä½ åˆ›å»ºäº†çº¿ç¨‹å®‰å…¨å‡½æ•°</span></span>
<span class="line"><span>napi_threadsafe_function tsfn;</span></span>
<span class="line"><span>napi_create_threadsafe_function(</span></span>
<span class="line"><span>  env,</span></span>
<span class="line"><span>  js_callback, // JavaScriptå›è°ƒå‡½æ•°ï¼Œå°†åœ¨ä¸»çº¿ç¨‹ä¸­è¢«è°ƒç”¨</span></span>
<span class="line"><span>  async_resource,</span></span>
<span class="line"><span>  async_resource_name,</span></span>
<span class="line"><span>  0, // æ— é™é˜Ÿåˆ—å¤§å°</span></span>
<span class="line"><span>  1, // åˆå§‹çº¿ç¨‹æ•°</span></span>
<span class="line"><span>  my_context, // è¿™é‡Œä½ ä¼ å…¥äº†ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span>
<span class="line"><span>  finalize_cb, // å½“æ¸…é™¤çº¿ç¨‹å®‰å…¨å‡½æ•°æ—¶è°ƒç”¨çš„å›è°ƒ</span></span>
<span class="line"><span>  NULL, // finalize_hint</span></span>
<span class="line"><span>  CallJs, // ä¸Šé¢å®šä¹‰çš„CallJsåŠŸèƒ½</span></span>
<span class="line"><span>  &amp;tsfn</span></span>
<span class="line"><span>);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ... ç°åœ¨åœ¨ä½ çš„åå°çº¿ç¨‹ä¸­ï¼Œä½ å¯èƒ½éœ€è¦è·å–ä¸Šä¸‹æ–‡åšä¸€äº›å¤„ç†</span></span>
<span class="line"><span>void BackgroundThreadWork(napi_threadsafe_function tsfn) {</span></span>
<span class="line"><span>  // ä»tsfnè·å¾—ä¸Šä¸‹æ–‡</span></span>
<span class="line"><span>  void* context;</span></span>
<span class="line"><span>  napi_status status = napi_get_threadsafe_function_context(tsfn, &amp;context);</span></span>
<span class="line"><span>  if (status == napi_ok) {</span></span>
<span class="line"><span>    MyContext* my_context = (MyContext*)context;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç°åœ¨ä½ æ‹¥æœ‰äº†ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥æ ¹æ®ä¸Šä¸‹æ–‡ä¸­ä¿å­˜çš„ä¿¡æ¯è¿›è¡Œç›¸åº”çš„å·¥ä½œ</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ...æ‰§è¡Œä½ çš„èƒŒæ™¯å·¥ä½œ</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // å®Œæˆåï¼Œä½ å¯èƒ½æƒ³è¦è°ƒç”¨çº¿ç¨‹å®‰å…¨å‡½æ•°æ¥é€šçŸ¥Node.jsçš„ä¸»çº¿ç¨‹</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šä»£ç å±•ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªå¸¦æœ‰ä¸Šä¸‹æ–‡çš„çº¿ç¨‹å®‰å…¨å‡½æ•°ï¼Œå¹¶åœ¨åå°çº¿ç¨‹ä¸­ä½¿ç”¨<code>napi_get_threadsafe_function_context</code>æ¥è·å–è¿™ä¸ªä¸Šä¸‹æ–‡ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å®‰å…¨åœ°ä¸ Node.js çš„ä¸»çº¿ç¨‹è¿›è¡Œé€šä¿¡äº†ã€‚</p><h3 id="napi-call-threadsafe-function" tabindex="-1"><a class="header-anchor" href="#napi-call-threadsafe-function"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_call_threadsafe_function" target="_blank" rel="noopener noreferrer">napi_call_threadsafe_function</a></span></a></h3><p>Node.js ä¸­çš„<code>napi_call_threadsafe_function</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåœ¨ N-APIï¼ˆNode.js çš„åŸç”Ÿ APIï¼‰ä¸­å®‰å…¨åœ°ä»ä»»ä½•çº¿ç¨‹è°ƒç”¨ JavaScript å‡½æ•°ã€‚è¿™ä¸ªåŠŸèƒ½ä¸»è¦ç”¨äºå½“ä½ æœ‰ä¸€ä¸ªåŸç”Ÿæ’ä»¶ï¼ˆé€šå¸¸ç”¨ C æˆ–è€… C++å†™çš„æ¨¡å—ï¼‰éœ€è¦æ‰§è¡Œå¼‚æ­¥æ“ä½œæˆ–è€…ä»ä¸åŒçš„çº¿ç¨‹è°ƒç”¨ Node.js ä»£ç æ—¶ã€‚</p><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç†è§£ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨ã€‚å½“å¤šä¸ªçº¿ç¨‹å°è¯•åŒæ—¶è®¿é—®ç›¸åŒçš„èµ„æºæ—¶ï¼Œå¦‚æœæ²¡æœ‰é€‚å½“çš„åŒæ­¥æœºåˆ¶ï¼Œå°±å¯èƒ½ä¼šå‘ç”Ÿå†²çªå’Œä¸å¯é¢„çŸ¥çš„è¡Œä¸ºã€‚å› æ­¤ï¼Œçº¿ç¨‹å®‰å…¨æ˜¯æŒ‡ä»£ç å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹å®‰å…¨åœ°è°ƒç”¨ï¼Œè€Œä¸ä¼šäº§ç”Ÿç«äº‰æ¡ä»¶æˆ–å…¶ä»–é—®é¢˜ã€‚</p><p>åœ¨ Node.js ä¸­ï¼ŒJavaScript è¿è¡Œåœ¨å•ä¸€çš„çº¿ç¨‹ä¸Šï¼Œç§°ä¸ºäº‹ä»¶å¾ªç¯çº¿ç¨‹ã€‚ä½†æ˜¯ï¼Œå½“ä½ ä½¿ç”¨åŸç”Ÿæ¨¡å—å’Œå¼‚æ­¥ I/O æ“ä½œæ—¶ï¼Œå¯èƒ½ä¼šæ¶‰åŠé¢å¤–çš„çº¿ç¨‹ã€‚è¿™æ—¶å€™å¦‚æœä½ æƒ³è¦ä»è¿™äº›é™„åŠ çº¿ç¨‹å®‰å…¨åœ°è°ƒç”¨ JavaScript å‡½æ•°ï¼Œå°±éœ€è¦ç”¨åˆ°<code>napi_call_threadsafe_function</code>ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨<code>napi_call_threadsafe_function</code>ï¼š</p><p>å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js æ‰©å±•ï¼Œè¯¥æ‰©å±•é€šè¿‡åŸç”Ÿä»£ç è¿æ¥åˆ°æŸä¸ªæœåŠ¡ï¼Œå¹¶ä¸”éœ€è¦åœ¨æ¥æ”¶åˆ°æ•°æ®æ—¶å›è°ƒ JavaScript å‡½æ•°ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™æ˜¯ä»æœåŠ¡æ”¶åˆ°æ•°æ®æ—¶è¦è°ƒç”¨çš„JavaScriptå›è°ƒå‡½æ•°</span></span>
<span class="line"><span>napi_value js_callback;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™ä¸ªç»“æ„ä½“ç”¨æ¥å­˜å‚¨çº¿ç¨‹å®‰å…¨å‡½æ•°ç›¸å…³ä¿¡æ¯</span></span>
<span class="line"><span>napi_threadsafe_function tsfn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ä»å…¶ä»–çº¿ç¨‹è°ƒç”¨è¿™ä¸ªå‡½æ•°ä»¥è§¦å‘JavaScriptå›è°ƒ</span></span>
<span class="line"><span>void service_callback(void* data) {</span></span>
<span class="line"><span>    // `data`æ˜¯ä½ ä»æœåŠ¡æ¥æ”¶åˆ°çš„æ•°æ®</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è°ƒç”¨JavaScriptå›è°ƒå‡½æ•°ï¼Œç¡®ä¿å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„</span></span>
<span class="line"><span>    napi_status status = napi_call_threadsafe_function(tsfn, data, napi_tsfn_blocking);</span></span>
<span class="line"><span>    if (status != napi_ok) {</span></span>
<span class="line"><span>        // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯åˆ›å»ºçº¿ç¨‹å®‰å…¨å‡½æ•°å¹¶å¯åŠ¨æœåŠ¡ç›‘å¬å™¨çš„åˆå§‹åŒ–ä»£ç </span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>    // ...åˆå§‹åŒ–ä»£ç ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–JavaScriptæä¾›çš„å›è°ƒå‡½æ•°ï¼Œå¹¶ä¿å­˜å¼•ç”¨</span></span>
<span class="line"><span>    napi_value js_callback;</span></span>
<span class="line"><span>    // å‡è®¾js_callbackå·²ç»è¢«æ­£ç¡®è·å–å¹¶èµ‹å€¼...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // åˆ›å»ºçº¿ç¨‹å®‰å…¨å‡½æ•°</span></span>
<span class="line"><span>    napi_create_threadsafe_function(env, js_callback, NULL, NAPI_AUTO_LENGTH, 0, 1, NULL, NULL, NULL, service_callback, &amp;tsfn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¯åŠ¨æœåŠ¡ç›‘å¬å™¨...</span></span>
<span class="line"><span>    // å½“æœåŠ¡æœ‰æ•°æ®æ—¶ï¼Œservice_callbackå°†è¢«è°ƒç”¨</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// æ³¨å†Œæ¨¡å—</span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ<code>napi_threadsafe_function</code>ç±»å‹çš„å˜é‡<code>tsfn</code>è¢«ç”¨æ¥å­˜å‚¨çº¿ç¨‹å®‰å…¨å‡½æ•°çš„ä¿¡æ¯ã€‚é€šè¿‡è°ƒç”¨<code>napi_create_threadsafe_function</code>åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å‡½æ•°ï¼Œç„¶åå¯ä»¥ä»ä»»ä½•çº¿ç¨‹é€šè¿‡<code>napi_call_threadsafe_function</code>è°ƒç”¨è¯¥ JavaScript å‡½æ•°ã€‚</p><p>æ³¨æ„ï¼šä»¥ä¸Šä»£ç åªæ˜¯æ¦‚å¿µæ€§çš„ç¤ºä¾‹ï¼Œå®é™…ä½¿ç”¨æ—¶è¿˜éœ€è¦è€ƒè™‘é”™è¯¯å¤„ç†ã€èµ„æºé‡Šæ”¾å’Œçº¿ç¨‹åŒæ­¥ç­‰é—®é¢˜ã€‚</p><p>é‡è¦çš„ç‚¹æ˜¯ï¼Œå½“ä½ ä»éäº‹ä»¶å¾ªç¯çº¿ç¨‹è°ƒç”¨ JavaScript ä»£ç æ—¶ï¼Œå¿…é¡»é‡‡å–çº¿ç¨‹å®‰å…¨çš„æªæ–½ï¼Œå¦åˆ™å¯èƒ½ä¼šç ´å Node.js çš„å•çº¿ç¨‹æ¨¡å‹ï¼Œå¯¼è‡´ä¸å¯é¢„æœŸçš„ç»“æœã€‚<code>napi_call_threadsafe_function</code>æ­£æ˜¯æä¾›äº†ä¸€ç§å®‰å…¨çš„æ–¹å¼æ¥å®Œæˆè¿™æ ·çš„ä»»åŠ¡ã€‚</p><h3 id="napi-acquire-threadsafe-function" tabindex="-1"><a class="header-anchor" href="#napi-acquire-threadsafe-function"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_acquire_threadsafe_function" target="_blank" rel="noopener noreferrer">napi_acquire_threadsafe_function</a></span></a></h3><p>Node.js çš„ N-APIï¼ˆåŸç”Ÿ APIï¼‰æä¾›äº†ä¸€å¥—åœ¨ Node.js ä¸­ä½¿ç”¨ C æˆ– C++ç¼–å†™æ‰©å±•çš„æ¥å£ã€‚è¿™äº›æ¥å£å…è®¸æœ¬åœ°ä»£ç å®‰å…¨åœ°ä¸ Node.js çš„ JavaScript è¿è¡Œæ—¶å’Œå¯¹è±¡è¿›è¡Œäº¤äº’ã€‚</p><p><code>napi_acquire_threadsafe_function</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒä¸­å®‰å…¨åœ°è°ƒç”¨ JavaScript å‡½æ•°ã€‚å› ä¸º Node.js æ˜¯å•çº¿ç¨‹è¿è¡Œ JavaScript çš„ï¼Œåœ¨å¤šçº¿ç¨‹ C/C++æ‰©å±•ä¸­ç›´æ¥è°ƒç”¨ JavaScript ä»£ç é€šå¸¸æ˜¯ä¸å®‰å…¨çš„ã€‚æ‰€ä»¥è¿™ä¸ª API å‡½æ•°å¯ä»¥å¸®åŠ©æˆ‘ä»¬ä»å…¶ä»–çº¿ç¨‹å®‰å…¨åœ°è°ƒç”¨ JavaScript ä»£ç ã€‚</p><p>ä¸‹é¢æˆ‘å°†ç®€è¦è§£é‡Š <code>napi_acquire_threadsafe_function</code> çš„ç”¨æ³•ï¼Œå¹¶ç»™å‡ºä¸€äº›å®é™…ä¾‹å­æ¥è¯´æ˜å®ƒçš„è¿ç”¨åœºæ™¯ã€‚</p><h3 id="è§£é‡Š" tabindex="-1"><a class="header-anchor" href="#è§£é‡Š"><span>è§£é‡Š</span></a></h3><p><code>napi_acquire_threadsafe_function</code> ç”¨äºâ€œè·å–â€ä¸€ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°ï¼Œä½¿å¾—å…¶ä»–çº¿ç¨‹å¯ä»¥å®‰å…¨åœ°è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚è·å–æ“ä½œé€šå¸¸ä¼šå¢åŠ å†…éƒ¨å¼•ç”¨è®¡æ•°ï¼Œè¿™æ ·å°±å¯ä»¥ç¡®ä¿åœ¨æ‰€æœ‰çº¿ç¨‹å®Œæˆå¯¹è¯¥å‡½æ•°çš„ä½¿ç”¨å‰ï¼Œå‡½æ•°ä¸ä¼šè¢«åƒåœ¾å›æ”¶ã€‚</p><p>å½“ä½ æƒ³åœ¨åŸç”Ÿçº¿ç¨‹ä¸­è°ƒç”¨ä¸€ä¸ª JavaScript å‡½æ•°æ—¶ï¼Œä½ é¦–å…ˆéœ€è¦é€šè¿‡ <code>napi_create_threadsafe_function</code> åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°ï¼Œç„¶ååœ¨æ¯ä¸ªçº¿ç¨‹å¼€å§‹è°ƒç”¨ä¹‹å‰ä½¿ç”¨ <code>napi_acquire_threadsafe_function</code>ï¼Œå¹¶åœ¨è°ƒç”¨ç»“æŸåä½¿ç”¨ <code>napi_release_threadsafe_function</code> æ¥é‡Šæ”¾å®ƒã€‚</p><h3 id="ä½¿ç”¨æ­¥éª¤-1" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨æ­¥éª¤-1"><span>ä½¿ç”¨æ­¥éª¤</span></a></h3><ol><li><strong>åˆ›å»ºçº¿ç¨‹å®‰å…¨å‡½æ•°</strong>ï¼šä½¿ç”¨ <code>napi_create_threadsafe_function</code> åˆ›å»ºä¸€ä¸ªå¯ä»ä»»ä½•çº¿ç¨‹è°ƒç”¨çš„ JavaScript å‡½æ•°ã€‚</li><li><strong>è·å–çº¿ç¨‹å®‰å…¨å‡½æ•°</strong>ï¼šåœ¨å‡†å¤‡è°ƒç”¨è¯¥å‡½æ•°çš„çº¿ç¨‹ä¸­ï¼Œä½¿ç”¨ <code>napi_acquire_threadsafe_function</code> æ¥è·å–æƒåˆ©è°ƒç”¨å®ƒã€‚</li><li><strong>è°ƒç”¨å‡½æ•°</strong>ï¼šé€šè¿‡ <code>napi_call_threadsafe_function</code> åœ¨ä»»ä½•çº¿ç¨‹é‡Œé¢è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</li><li><strong>é‡Šæ”¾çº¿ç¨‹å®‰å…¨å‡½æ•°</strong>ï¼šè°ƒç”¨å®Œæˆåï¼Œä½¿ç”¨ <code>napi_release_threadsafe_function</code> é‡Šæ”¾ä½ ä¹‹å‰è·å¾—çš„æƒåˆ©ã€‚</li></ol><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-10" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-10"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h3><p>å‡è®¾æ‚¨æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js æ‰©å±•ï¼Œè¯¥æ‰©å±•éœ€è¦æ‰§è¡Œä¸€äº›è€—æ—¶çš„è®¡ç®—ï¼Œè€Œè¿™ä¸ªè®¡ç®—è¿‡ç¨‹æ˜¯åœ¨åŸç”Ÿçš„ C/C++çº¿ç¨‹ä¸­å®Œæˆçš„ã€‚ä½ å¸Œæœ›åœ¨è®¡ç®—å®Œæˆåï¼Œèƒ½å¤Ÿå®‰å…¨åœ°æ›´æ–° Node.js çš„æŸä¸ª JavaScript å¯¹è±¡æˆ–è°ƒç”¨æŸä¸ª JavaScript å‡½æ•°ã€‚</p><p>ä¾‹å¦‚ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// å‡è®¾è¿™æ˜¯æ‚¨æƒ³åœ¨JavaScriptä¸­è°ƒç”¨çš„å‡½æ•°</span></span>
<span class="line"><span>void JSFunctionCall(napi_env env, napi_value js_callback, void* context) {</span></span>
<span class="line"><span>    // ... è¿™é‡Œå¯èƒ½æ˜¯è°ƒç”¨ JavaScript å‡½æ•°çš„ä»£ç  ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// åŸç”Ÿçº¿ç¨‹çš„å·¥ä½œå‡½æ•°</span></span>
<span class="line"><span>void* NativeThreadWork(void* arg) {</span></span>
<span class="line"><span>    napi_threadsafe_function ts_fn = (napi_threadsafe_function)arg;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è·å–æƒé™</span></span>
<span class="line"><span>    napi_acquire_threadsafe_function(ts_fn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // æ‰§è¡Œä¸€äº›å·¥ä½œ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // è°ƒç”¨JavaScriptå‡½æ•°</span></span>
<span class="line"><span>    napi_call_threadsafe_function(ts_fn, nullptr, napi_tsfn_blocking);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // é‡Šæ”¾æƒé™</span></span>
<span class="line"><span>    napi_release_threadsafe_function(ts_fn, napi_tsfn_release);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return nullptr;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šè¿°ä¼ªä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•° <code>ts_fn</code>ï¼Œç„¶åä¼ é€’ç»™äº†åŸç”Ÿçº¿ç¨‹ <code>NativeThreadWork</code>ã€‚åœ¨åŸç”Ÿçº¿ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>napi_acquire_threadsafe_function</code> è·å–äº†è°ƒç”¨ JavaScript å‡½æ•°çš„æƒé™ï¼Œå¹¶åœ¨å®Œæˆè°ƒç”¨åé€šè¿‡ <code>napi_release_threadsafe_function</code> é‡Šæ”¾äº†è¯¥æƒé™ã€‚è¿™æ ·å°±å¯ä»¥ç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬çš„ JavaScript å‡½æ•°è°ƒç”¨æ˜¯å®‰å…¨çš„ã€‚</p><p>æ€»ç»“æ¥è¯´ï¼Œ<code>napi_acquire_threadsafe_function</code> æ˜¯ä¸€ä¸ªå…³é”®çš„å‡½æ•°ï¼Œå®ƒåœ¨ Node.js çš„ N-API ä¸­ä½¿å¾—å¤šçº¿ç¨‹åŸç”Ÿæ‰©å±•èƒ½å¤Ÿå®‰å…¨åœ°ä¸ JavaScript ä»£ç äº¤äº’ã€‚é€šè¿‡ä½¿ç”¨å®ƒï¼Œå¼€å‘è€…å¯ä»¥ç¡®ä¿å³ä½¿åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œä¹Ÿèƒ½å®‰å…¨åœ°è°ƒç”¨ JavaScript å‡½æ•°ï¼Œè€Œä¸ä¼šå¯¼è‡´ç«æ€æ¡ä»¶æˆ–å´©æºƒç­‰é—®é¢˜ã€‚</p><h3 id="napi-release-threadsafe-function" tabindex="-1"><a class="header-anchor" href="#napi-release-threadsafe-function"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_release_threadsafe_function" target="_blank" rel="noopener noreferrer">napi_release_threadsafe_function</a></span></a></h3><p>åœ¨ Node.js ä¸­ï¼ŒN-API æ˜¯ä¸€ç§ç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚å®ƒå…è®¸ä½ ä½¿ç”¨ C æˆ– C++ç­‰è¯­è¨€ç¼–å†™å¯ä»¥è¢« Node.js ç›´æ¥è°ƒç”¨çš„ä»£ç å—ã€‚è¿™äº›åŸç”Ÿæ’ä»¶é€šå¸¸ç”¨äºæ‰§è¡Œæ€§èƒ½æ•æ„Ÿçš„ä»»åŠ¡ï¼Œä¾‹å¦‚å›¾åƒå¤„ç†ã€æ•°æ®åº“è®¿é—®æˆ–å…¶ä»–éœ€è¦é«˜æ€§èƒ½è®¡ç®—çš„æ“ä½œã€‚</p><p><code>napi_release_threadsafe_function</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºç®¡ç†æ‰€è°“çš„â€œçº¿ç¨‹å®‰å…¨å‡½æ•°â€ï¼ˆthread-safe functionï¼‰ã€‚è¿™ä¸ªæ¦‚å¿µå¯èƒ½å¯¹äºåˆå­¦è€…æ¥è¯´æœ‰äº›å¤æ‚ï¼Œæ‰€ä»¥æˆ‘ä¼šå°½é‡ç”¨ç®€å•çš„ä¾‹å­æ¥è§£é‡Šã€‚</p><p>åœ¨ JavaScript ä¸­ï¼Œé€šå¸¸æˆ‘ä»¬åªåœ¨ä¸€ä¸ªä¸»çº¿ç¨‹ä¸Šè¿è¡Œä»£ç ï¼Œè€Œ Node.js ä¹Ÿæ˜¯åŸºäºè¿™æ ·çš„äº‹ä»¶é©±åŠ¨å’Œéé˜»å¡ I/O æ¨¡å‹ã€‚ç„¶è€Œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½éœ€è¦åœ¨åå°çº¿ç¨‹ä¸Šæ‰§è¡Œä¸€äº›ä»»åŠ¡ï¼Œä»¥é¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚æ¯”å¦‚å½“ä½ åœ¨å¤„ç†å¤§é‡æ•°æ®è®¡ç®—æ—¶ï¼Œä½ ä¸å¸Œæœ›å®ƒå½±å“åˆ°å…¶ä»–æœåŠ¡å™¨è¯·æ±‚çš„å¤„ç†ã€‚</p><p>åœ¨è¿™äº›åå°çº¿ç¨‹ä¸Šå®Œæˆå·¥ä½œåï¼Œä½ å¯èƒ½éœ€è¦å°†ä¸€äº›ç»“æœä¼ å›ç»™ä¸»çº¿ç¨‹ã€‚è¿™å°±æ˜¯çº¿ç¨‹å®‰å…¨å‡½æ•°çš„ç”¨é€”ï¼šå®ƒå…è®¸ä»ä»»ä½•çº¿ç¨‹å®‰å…¨åœ°è°ƒç”¨ JavaScript å‡½æ•°ã€‚</p><p>ç°åœ¨ï¼Œå‡è®¾ä½ å»ºç«‹äº†ä¸€ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°ï¼Œä½ çš„åå°çº¿ç¨‹æ­£åœ¨ä½¿ç”¨å®ƒæ¥å®šæœŸå°†æ•°æ®å‘é€å›ä¸»çº¿ç¨‹ã€‚å½“ä½ çš„åº”ç”¨ç¨‹åºç»“æŸæˆ–è€…ä½ ä¸å†éœ€è¦è¿™ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°æ—¶ï¼Œä½ å¿…é¡»å‘Šè¯‰ Node.jsï¼Œå®ƒå¯ä»¥æ¸…ç†ä¸è¯¥å‡½æ•°ç›¸å…³çš„èµ„æºã€‚è¿™æ­£æ˜¯<code>napi_release_threadsafe_function</code>çš„ä½œç”¨ã€‚è°ƒç”¨è¿™ä¸ªå‡½æ•°ä¼šå‡å°‘çº¿ç¨‹å®‰å…¨å‡½æ•°çš„å¼•ç”¨è®¡æ•°ï¼Œå½“å¼•ç”¨è®¡æ•°é™åˆ°é›¶æ—¶ï¼ŒNode.js å°±ä¼šé‡Šæ”¾å®ƒå ç”¨çš„èµ„æºã€‚</p><p>å®é™…åº”ç”¨çš„ä¾‹å­ï¼š</p><ol><li><p><strong>å¼‚æ­¥æ—¥å¿—è®°å½•</strong>ï¼šä½ å¯èƒ½æƒ³è¦åœ¨åå°çº¿ç¨‹ä¸Šè¿›è¡Œæ—¥å¿—è®°å½•ï¼Œä»¥å…å½±å“ä¸»çº¿ç¨‹çš„æ€§èƒ½ã€‚æ¯å½“åå°çº¿ç¨‹éœ€è¦è®°å½•ä¿¡æ¯æ—¶ï¼Œå®ƒå¯ä»¥é€šè¿‡çº¿ç¨‹å®‰å…¨å‡½æ•°æ¥å®Œæˆã€‚å®Œæˆæ—¥å¿—è®°å½•ä»»åŠ¡åï¼Œä½¿ç”¨<code>napi_release_threadsafe_function</code>æ¥é‡Šæ”¾èµ„æºã€‚</p></li><li><p><strong>æ•°æ®å¤„ç†</strong>ï¼šå¦‚æœä½ çš„åº”ç”¨ç¨‹åºæ¥æ”¶åˆ°å¤§é‡çš„æ•°æ®éœ€è¦å¤„ç†ï¼Œæ¯”å¦‚å¤„ç†å›¾åƒæˆ–åˆ†ææ–‡ä»¶ï¼Œä½ å¯ä»¥åœ¨åå°çº¿ç¨‹ä¸­å¤„ç†è¿™äº›æ•°æ®ï¼Œç„¶åé€šè¿‡çº¿ç¨‹å®‰å…¨å‡½æ•°å‘é€å¤„ç†ç»“æœå›ä¸»çº¿ç¨‹ã€‚æœ€åï¼Œç”¨<code>napi_release_threadsafe_function</code>æ¥å‘ŠçŸ¥ Node.js è¯¥çº¿ç¨‹å®‰å…¨å‡½æ•°ä¸å†éœ€è¦ã€‚</p></li><li><p><strong>å®æ—¶æ•°æ®æ›´æ–°</strong>ï¼šè€ƒè™‘ä¸€ä¸ªè‚¡ç¥¨å¸‚åœºåº”ç”¨ç¨‹åºï¼Œä½ å¯èƒ½åœ¨åå°çº¿ç¨‹ä¸­å®æ—¶è·å–è‚¡ä»·å¹¶æ›´æ–°æ•°æ®åº“ã€‚åŒæ—¶ï¼Œä½ å¯èƒ½è¿˜éœ€è¦åŠæ—¶å°†æ›´æ–°æ¨é€ç»™å‰ç«¯æ˜¾ç¤ºã€‚çº¿ç¨‹å®‰å…¨å‡½æ•°å¯ä»¥ç”¨äºå°†è¿™äº›æ›´æ–°å‘é€å›ä¸»çº¿ç¨‹ï¼Œä»¥ä¾¿è¿›ä¸€æ­¥å¤„ç†ã€‚å½“è¿™ä¸ªåŠŸèƒ½ä¸å†éœ€è¦æ—¶ï¼Œå†æ¬¡è°ƒç”¨<code>napi_release_threadsafe_function</code>ã€‚</p></li></ol><p>åœ¨ä½¿ç”¨<code>napi_release_threadsafe_function</code>æ—¶ï¼Œä½ éœ€è¦è€ƒè™‘åŒæ­¥é—®é¢˜ï¼Œç¡®ä¿æ²¡æœ‰å…¶ä»–çº¿ç¨‹è¯•å›¾åœ¨ä½ é‡Šæ”¾èµ„æºåè¿˜ä½¿ç”¨è¯¥å‡½æ•°ã€‚æ­£ç¡®åœ°ç®¡ç†çº¿ç¨‹å®‰å…¨å‡½æ•°çš„åˆ›å»ºå’Œé‡Šæ”¾æ˜¯å¼€å‘ç¨³å®šåŸç”Ÿæ’ä»¶çš„é‡è¦æ–¹é¢ã€‚</p><h3 id="napi-ref-threadsafe-function" tabindex="-1"><a class="header-anchor" href="#napi-ref-threadsafe-function"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_ref_threadsafe_function" target="_blank" rel="noopener noreferrer">napi_ref_threadsafe_function</a></span></a></h3><p>Node.js ä¸­çš„ N-APIï¼ˆåŸç”Ÿ APIï¼‰æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸç”Ÿæ’ä»¶ï¼ˆé€šå¸¸æ˜¯ç”¨ C æˆ– C++ç¼–å†™çš„æ¨¡å—ï¼‰çš„åº•å±‚ APIã€‚å®ƒæä¾›äº†ä¸€ç»„ç¨³å®šçš„å‡½æ•°ï¼Œå…è®¸åŸç”Ÿä»£ç ä¸ JavaScript ä»£ç äº¤äº’ã€‚</p><p>åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œ<code>napi_ref_threadsafe_function</code> æ˜¯ä¸€ä¸ªéå¸¸ç‰¹æ®Šçš„å‡½æ•°ï¼Œå®ƒæ¶‰åŠåˆ°å¤šçº¿ç¨‹å’Œå¼‚æ­¥ç¼–ç¨‹ã€‚æˆ‘å°†é¦–å…ˆè§£é‡Šä»€ä¹ˆæ˜¯ threadsafe functionï¼Œç„¶åä¸¾ä¾‹è¯´æ˜å®ƒå¦‚ä½•è¢«ä½¿ç”¨ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯-threadsafe-function" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯-threadsafe-function"><span>ä»€ä¹ˆæ˜¯ Threadsafe Functionï¼Ÿ</span></a></h3><p>åœ¨ Node.js ä¸­ï¼Œç”±äº JavaScript è¿è¡Œåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸­ï¼ˆä¸»è¦æ˜¯äº‹ä»¶å¾ªç¯ï¼‰ï¼Œæ‰€ä»¥åœ¨å¤„ç†é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡æ—¶é€šå¸¸ä¼šä½¿ç”¨å¼‚æ­¥æ“ä½œæ¥é¿å…é˜»å¡è¯¥çº¿ç¨‹ã€‚ä½†æ˜¯ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½éœ€è¦ä»ä¸€ä¸ªä¸åŒçš„çº¿ç¨‹ï¼ˆå¯èƒ½æ˜¯ä¸€ä¸ªåŸç”Ÿæ‰©å±•åˆ›å»ºçš„çº¿ç¨‹ï¼‰ä¸­æ‰§è¡Œä»£ç ï¼Œå¹¶æœ€ç»ˆè¦å°†ç»“æœä¼ é€’å› JavaScript çš„ä¸»çº¿ç¨‹ã€‚ä¸ºæ­¤ï¼ŒNode.js æä¾›äº† <code>ThreadsafeFunction</code> ç±»å‹çš„å¯¹è±¡ï¼Œå³å¯ä»¥å®‰å…¨åœ°ä»ä»»ä½•çº¿ç¨‹è°ƒç”¨çš„å‡½æ•°ã€‚</p><h3 id="napi-ref-threadsafe-function-åŠŸèƒ½" tabindex="-1"><a class="header-anchor" href="#napi-ref-threadsafe-function-åŠŸèƒ½"><span><code>napi_ref_threadsafe_function</code> åŠŸèƒ½</span></a></h3><p><code>napi_ref_threadsafe_function</code> å‡½æ•°çš„ä½œç”¨æ˜¯å¢åŠ å¯¹å·²å­˜åœ¨çš„ <code>ThreadsafeFunction</code> å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚å½“ä½ åˆ›å»ºä¸€ä¸ª threadsafe function æ—¶ï¼Œå®ƒçš„å¼•ç”¨è®¡æ•°é»˜è®¤ä¸º 1ã€‚æ¯æ¬¡è°ƒç”¨ <code>napi_ref_threadsafe_function</code>ï¼Œå¼•ç”¨è®¡æ•°ä¼šå¢åŠ ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†é˜²æ­¢è¯¥å‡½æ•°å¯¹è±¡è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶ï¼Œåªæœ‰å½“å¼•ç”¨è®¡æ•°é™åˆ° 0 æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨æ‰ä¼šè€ƒè™‘å›æ”¶è¯¥å¯¹è±¡ã€‚</p><h3 id="ä¸ºä»€ä¹ˆéœ€è¦å¼•ç”¨-threadsafe-function" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆéœ€è¦å¼•ç”¨-threadsafe-function"><span>ä¸ºä»€ä¹ˆéœ€è¦å¼•ç”¨ threadsafe functionï¼Ÿ</span></a></h3><p>å½“ä½ çš„ç¨‹åºåˆ›å»ºäº†ä¸€ä¸ª threadsafe function å¹¶ä¸”åœ¨å¤šä¸ªåœ°æ–¹ä½¿ç”¨æ—¶ï¼Œä½ éœ€è¦ç¡®ä¿å½“å®ƒä»è¢«éœ€è¦æ—¶ä¸ä¼šè¢«å›æ”¶ã€‚é€šè¿‡å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œä½ å¯ä»¥æ§åˆ¶å¯¹è±¡ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶ç¡®ä¿åªæœ‰åœ¨æ‰€æœ‰åœ°æ–¹éƒ½å®Œæˆä½¿ç”¨åï¼Œå¯¹è±¡æ‰èƒ½è¢«æ¸…é™¤ã€‚</p><h3 id="å®é™…è¿ç”¨çš„ä¾‹å­-11" tabindex="-1"><a class="header-anchor" href="#å®é™…è¿ç”¨çš„ä¾‹å­-11"><span>å®é™…è¿ç”¨çš„ä¾‹å­</span></a></h3><p>æƒ³è±¡ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åº”ç”¨ç¨‹åºï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºéœ€è¦æ‰§è¡Œ CPU å¯†é›†å‹çš„å›¾åƒå¤„ç†æ“ä½œã€‚ä¸ºäº†ä¸é˜»å¡äº‹ä»¶å¾ªç¯ï¼Œä½ å†³å®šä½¿ç”¨ C++ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—æ¥åœ¨èƒŒæ™¯çº¿ç¨‹è¿›è¡Œå›¾åƒå¤„ç†ã€‚å½“å¤„ç†å®Œæˆæ—¶ï¼Œä½ éœ€è¦å°†å¤„ç†ç»“æœè¿”å›åˆ° JavaScript ä¸»çº¿ç¨‹ä¸­æ›´æ–° UI æˆ–è¿›ä¸€æ­¥å¤„ç†ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€åŒ–çš„ç¤ºä¾‹æµç¨‹ï¼š</p><ol><li>åœ¨ JavaScript ä»£ç ä¸­ï¼Œä½ å¼•å…¥äº†è‡ªå·±çš„åŸç”Ÿæ¨¡å—å¹¶åˆ›å»ºäº†ä¸€ä¸ª threadsafe functionã€‚</li><li>ä½ æŠŠè¿™ä¸ª threadsafe function ä¼ é€’ç»™åŸç”Ÿæ¨¡å—ã€‚</li><li>åŸç”Ÿæ¨¡å—å¼€å§‹åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸Šå¤„ç†å›¾åƒã€‚</li><li>å¤„ç†å®Œæ¯•åï¼ŒåŸç”Ÿæ¨¡å—ä½¿ç”¨ threadsafe function å°†ç»“æœä¼ å› JavaScript ä¸»çº¿ç¨‹ã€‚</li><li>ä¸ºç¡®ä¿ threadsafe function åœ¨å®Œæˆå·¥ä½œå‰ä¸è¢«å›æ”¶ï¼ŒåŸç”Ÿæ¨¡å—åœ¨å¼€å§‹å·¥ä½œå‰è°ƒç”¨äº† <code>napi_ref_threadsafe_function</code> æ¥å¢åŠ å¼•ç”¨è®¡æ•°ã€‚</li><li>å½“ç»“æœè¿”å›ç»™ JavaScript æµ‹å¹¶ä¸”ä¸å†éœ€è¦ threadsafe function æ—¶ï¼ŒåŸç”Ÿæ¨¡å—è°ƒç”¨ <code>napi_unref_threadsafe_function</code> æ¥å‡å°‘å¼•ç”¨è®¡æ•°ã€‚</li></ol><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å°±èƒ½å¤Ÿå®‰å…¨åœ°åœ¨å¤šä¸ªçº¿ç¨‹é—´ä¼ é€’ä¿¡æ¯è€Œä¸ä¼šç ´å Node.js çš„å•çº¿ç¨‹æ¨¡å‹ï¼Œå¹¶ä¸”ä¸å¿…æ‹…å¿ƒå¯¹è±¡åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­è¢«æ„å¤–å›æ”¶ã€‚</p><h3 id="napi-unref-threadsafe-function" tabindex="-1"><a class="header-anchor" href="#napi-unref-threadsafe-function"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#napi_unref_threadsafe_function" target="_blank" rel="noopener noreferrer">napi_unref_threadsafe_function</a></span></a></h3><p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œæ—¶ï¼Œå®ƒå…è®¸ä½ åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ JavaScript ä»£ç ã€‚N-API æ˜¯ Node.js æä¾›çš„ä¸€ç»„ C è¯­è¨€ APIï¼Œå®ƒä½¿å¾—åˆ›å»ºåŸç”Ÿæ’ä»¶å˜å¾—ç®€å•ï¼Œè€Œä¸”ä¿è¯äº†ä¸ Node.js ä¸åŒç‰ˆæœ¬çš„å…¼å®¹æ€§ã€‚</p><p><code>napi_unref_threadsafe_function</code> æ˜¯ N-API ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒç”¨äºç®¡ç†ä¸€ä¸ªå«åšã€Œçº¿ç¨‹å®‰å…¨å‡½æ•°ã€ï¼ˆthread-safe functionï¼‰çš„å¼•ç”¨è®¡æ•°ã€‚åœ¨è§£é‡Šè¿™ä¸ªå‡½æ•°ä¹‹å‰ï¼Œå…ˆè¯´æ˜å‡ ä¸ªèƒŒæ™¯çŸ¥è¯†ç‚¹ï¼š</p><ol><li><p><strong>çº¿ç¨‹å®‰å…¨å‡½æ•°</strong>: åœ¨ Node.js ä¸­ï¼ŒJavaScript é€šå¸¸åœ¨å•ä¸€çš„ä¸»çº¿ç¨‹ä¸Šè¿è¡Œï¼Œè¿™æ ·é¿å…äº†å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„å¤æ‚æ€§ã€‚ä½†æ˜¯ï¼Œå½“éœ€è¦æ‰§è¡Œè€—æ—¶çš„æ“ä½œæ—¶ï¼ˆä¾‹å¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œè¯·æ±‚ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨å…¶ä»–çº¿ç¨‹æ¥é¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚çº¿ç¨‹å®‰å…¨å‡½æ•°å°±æ˜¯ä¸ºäº†åœ¨è¿™äº›å·¥ä½œçº¿ç¨‹å’Œä¸»çº¿ç¨‹ä¹‹é—´å®‰å…¨åœ°ä¼ é€’è°ƒç”¨è€Œè®¾è®¡çš„ã€‚</p></li><li><p><strong>å¼•ç”¨è®¡æ•°</strong>: å¼•ç”¨è®¡æ•°æ˜¯ä¸€ç§å†…å­˜ç®¡ç†æŠ€æœ¯ï¼Œç”¨äºè·Ÿè¸ªä¸€ä¸ªå¯¹è±¡è¢«å¼•ç”¨çš„æ¬¡æ•°ã€‚å½“ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°é™åˆ°é›¶æ—¶ï¼Œæ„å‘³ç€æ²¡æœ‰ä»»ä½•åœ°æ–¹æ­£åœ¨ä½¿ç”¨è¿™ä¸ªå¯¹è±¡ï¼Œå› æ­¤å®ƒå¯ä»¥è¢«åƒåœ¾å›æ”¶ã€‚</p></li></ol><p>ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹ <code>napi_unref_threadsafe_function</code> æœ¬èº«ï¼š</p><ul><li><p><strong>ä½œç”¨</strong>ï¼š<code>napi_unref_threadsafe_function</code> å‡½æ•°ç”¨äºå‡å°‘çº¿ç¨‹å®‰å…¨å‡½æ•°çš„å¼•ç”¨è®¡æ•°ã€‚å½“ä¸€ä¸ªçº¿ç¨‹ä¸å†éœ€è¦è°ƒç”¨è¯¥çº¿ç¨‹å®‰å…¨å‡½æ•°æ—¶ï¼Œåº”è¯¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</p></li><li><p><strong>ä¸ºä»€ä¹ˆè¦å‡å°‘å¼•ç”¨è®¡æ•°</strong>ï¼šå¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°ï¼Œä½†æ˜¯æ°¸è¿œä¸å»å‡å°‘å®ƒçš„å¼•ç”¨è®¡æ•°ï¼Œå³ä½¿ä½ çš„ä»£ç ä¸å†éœ€è¦å®ƒï¼Œå®ƒä¹Ÿä¸ä¼šè¢«åƒåœ¾å›æ”¶ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p></li><li><p><strong>å¦‚ä½•ä½¿ç”¨</strong>ï¼šåªæœ‰å½“ä½ ä¹‹å‰é€šè¿‡ <code>napi_ref_threadsafe_function</code> å¢åŠ äº†å¼•ç”¨è®¡æ•°æ—¶ï¼Œæ‰éœ€è¦è°ƒç”¨ <code>napi_unref_threadsafe_function</code> æ¥å‡å°‘å¼•ç”¨è®¡æ•°ã€‚</p></li></ul><p><strong>å®é™…è¿ç”¨çš„ä¾‹å­</strong>ï¼š</p><p>å‡è®¾ä½ æœ‰ä¸€ä¸ª Node.js æ’ä»¶ï¼Œè¯¥æ’ä»¶å¯åŠ¨äº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥å¤„ç†æ•°æ®ï¼Œå¤„ç†å®Œåéœ€è¦å°†ç»“æœä¼ å›ç»™ JavaScript çš„ä¸»çº¿ç¨‹ã€‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// çº¿ç¨‹å®‰å…¨å‡½æ•°çš„å¥æŸ„</span></span>
<span class="line"><span>napi_threadsafe_function tsfn;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿™æ˜¯åœ¨å·¥ä½œçº¿ç¨‹ä¸­è°ƒç”¨çš„å‡½æ•°</span></span>
<span class="line"><span>void worker_thread_function(void* data) {</span></span>
<span class="line"><span>    // ... æ‰§è¡Œä¸€äº›æ“ä½œ ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // é€šçŸ¥ Node.js ä¸»çº¿ç¨‹æ‰§è¡Œå›è°ƒ</span></span>
<span class="line"><span>    napi_call_threadsafe_function(tsfn, data, napi_tsfn_blocking);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void some_init_function(napi_env env) {</span></span>
<span class="line"><span>    // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°</span></span>
<span class="line"><span>    napi_create_threadsafe_function(</span></span>
<span class="line"><span>        env,</span></span>
<span class="line"><span>        ...,</span></span>
<span class="line"><span>        &amp;tsfn</span></span>
<span class="line"><span>    );</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå› ä¸ºæˆ‘ä»¬æ‰“ç®—åœ¨å·¥ä½œçº¿ç¨‹ä¸­ä½¿ç”¨å®ƒ</span></span>
<span class="line"><span>    napi_ref_threadsafe_function(env, tsfn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ... å¯åŠ¨å·¥ä½œçº¿ç¨‹ ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void some_cleanup_function(napi_env env) {</span></span>
<span class="line"><span>    // å‡å°‘å¼•ç”¨è®¡æ•°ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†éœ€è¦åœ¨å·¥ä½œçº¿ç¨‹ä¸­ä½¿ç”¨å®ƒ</span></span>
<span class="line"><span>    napi_unref_threadsafe_function(env, tsfn);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // é‡Šæ”¾çº¿ç¨‹å®‰å…¨å‡½æ•°</span></span>
<span class="line"><span>    napi_release_threadsafe_function(tsfn, napi_tsfn_release);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç ç‰‡æ®µå±•ç¤ºäº†å¦‚ä½•åœ¨ä¸€ä¸ªåŸç”Ÿæ¨¡å—ä¸­åˆ›å»ºå¹¶ä½¿ç”¨çº¿ç¨‹å®‰å…¨å‡½æ•°ã€‚æ³¨æ„ï¼Œåœ¨ <code>some_cleanup_function</code> å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨äº† <code>napi_unref_threadsafe_function</code> æ¥å‡å°‘ç”± <code>napi_ref_threadsafe_function</code> å¢åŠ çš„å¼•ç”¨è®¡æ•°ã€‚è¿™æ ·ç¡®ä¿äº†å½“è¿™ä¸ªçº¿ç¨‹å®‰å…¨å‡½æ•°ä¸å†éœ€è¦æ—¶ï¼Œå®ƒèƒ½å¤Ÿè¢«æ­£ç¡®åœ°æ¸…ç†å’Œåƒåœ¾å›æ”¶ã€‚</p><h2 id="miscellaneous-utilities" tabindex="-1"><a class="header-anchor" href="#miscellaneous-utilities"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#miscellaneous-utilities" target="_blank" rel="noopener noreferrer">Miscellaneous utilities</a></span></a></h2><p>åœ¨ Node.js ä¸­ï¼Œ<code>Miscellaneous utilities</code>é€šå¸¸æŒ‡çš„æ˜¯ä¸€ç³»åˆ—çš„è¾…åŠ©å‡½æ•°æˆ–å·¥å…·ï¼Œå®ƒä»¬å¯ä»¥å¸®åŠ©å¼€å‘è€…å®Œæˆä¸åŒçš„ä»»åŠ¡ã€‚åœ¨ N-APIï¼ˆå³ Node-APIï¼‰çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œ<code>Miscellaneous utilities</code>æŒ‡çš„æ˜¯é‚£äº›å’Œç›´æ¥ API åŠŸèƒ½ä¸å¤ªç›¸å…³ï¼Œä½†ä»ç„¶å¾ˆæœ‰ç”¨çš„ä¸€äº›å‡½æ•°ã€‚</p><p>ç”±äºä½ æåˆ°çš„æ˜¯ Node.js v21.7.1 ä¸­çš„å†…å®¹ï¼Œæˆ‘ä»¬å°†èšç„¦äº N-API ä¸­çš„<code>Miscellaneous utilities</code>ã€‚N-API æ˜¯ä¸€ä¸ª C è¯­è¨€å†™çš„ APIï¼Œå®ƒå¯¹åŸç”Ÿæ’ä»¶ï¼ˆnative addonsï¼‰ä½œè€…æ¥è¯´æ˜¯ç¨³å®šçš„ï¼Œå¹¶ä¸”å…¼å®¹ä¸åŒç‰ˆæœ¬çš„ Node.jsã€‚åŸç”Ÿæ’ä»¶æ˜¯ä½¿ç”¨ C æˆ– C++ç¼–å†™çš„æ¨¡å—ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨åº•å±‚ç³»ç»Ÿ APIï¼Œè¿™åœ¨æ€§èƒ½ä¸Šæœ‰ä¸€å®šçš„ä¼˜åŠ¿ï¼Œå› ä¸ºå®ƒä»¬è¿è¡Œåœ¨æ›´ä½çº§åˆ«ï¼Œæ›´é è¿‘ç¡¬ä»¶ã€‚</p><p>åœ¨<code>Miscellaneous utilities</code>éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šçœ‹åˆ°ä»¥ä¸‹å‡ ç§ç±»å‹çš„å·¥å…·ï¼š</p><ol><li><p><strong>ç±»å‹æ£€æŸ¥å·¥å…·</strong> - è¿™åŒ…æ‹¬äº†å‡½æ•°ï¼Œæ¯”å¦‚<code>napi_is_array()</code>ï¼Œå®ƒå¯ä»¥è®©ä½ æ£€æŸ¥ JavaScript å€¼æ˜¯å¦æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚</p></li><li><p><strong>é”™è¯¯å¤„ç†å·¥å…·</strong> - å¦‚<code>napi_throw_error()</code>ï¼Œå®ƒç”¨äºç”Ÿæˆå¹¶æŠ›å‡ºä¸€ä¸ª JavaScript é”™è¯¯ã€‚</p></li><li><p><strong>å¼•ç”¨ç®¡ç†å·¥å…·</strong> - æ¯”å¦‚<code>napi_ref</code>å’Œ<code>napi_unref</code>ï¼Œå®ƒä»¬ç”¨äºç®¡ç†å¯¹ JavaScript å¯¹è±¡çš„å¼•ç”¨ï¼Œåœ¨åŸç”Ÿä»£ç ä¸­ä¿æŒå¯¹è±¡æ´»åŠ¨çŠ¶æ€ï¼Œé˜²æ­¢è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚</p></li><li><p><strong>çº¿ç¨‹å®‰å…¨åŠŸèƒ½</strong> - æ¯”å¦‚<code>napi_acquire_threadsafe_function()</code>å’Œ<code>napi_release_threadsafe_function()</code>ï¼Œå®ƒä»¬ç”¨äºåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å®‰å…¨åœ°è°ƒç”¨ JavaScript å‡½æ•°ã€‚</p></li></ol><p>å®é™…åº”ç”¨çš„ä¾‹å­ï¼š</p><p><strong>ç±»å‹æ£€æŸ¥</strong>:<br> å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåŸç”Ÿæ¨¡å—ï¼Œéœ€è¦éªŒè¯ä¼ å…¥çš„å‚æ•°æ˜¯å¦ä¸ºæ•°ç»„ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value my_function(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    size_t argc = 1;</span></span>
<span class="line"><span>    napi_value argv[1];</span></span>
<span class="line"><span>    napi_get_cb_info(env, info, &amp;argc, argv, NULL, NULL);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    napi_valuetype valuetype;</span></span>
<span class="line"><span>    napi_typeof(env, argv[0], &amp;valuetype);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (valuetype != napi_object) {</span></span>
<span class="line"><span>        napi_throw_type_error(env, NULL, &quot;Argument is not an object&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    bool is_array;</span></span>
<span class="line"><span>    napi_is_array(env, argv[0], &amp;is_array);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (!is_array) {</span></span>
<span class="line"><span>        napi_throw_type_error(env, NULL, &quot;Object is not an array&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ç»§ç»­å¤„ç†æ•°ç»„...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>é”™è¯¯å¤„ç†</strong>:<br> å¦‚æœä½ åœ¨åŸç”Ÿæ¨¡å—çš„æŸä¸ªæ“ä½œä¸­é‡åˆ°äº†é”™è¯¯ï¼Œä½ å¯èƒ½æƒ³è¦æŠ›å‡ºä¸€ä¸ªé”™è¯¯ç»™ JavaScript:</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_value my_function_that_may_fail(napi_env env, napi_callback_info info) {</span></span>
<span class="line"><span>    // å‡è®¾do_something_riskyæ˜¯ä¸€ä¸ªå¯èƒ½å¤±è´¥çš„æ“ä½œ</span></span>
<span class="line"><span>    bool success = do_something_risky();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (!success) {</span></span>
<span class="line"><span>        napi_throw_error(env, NULL, &quot;Something risky failed!&quot;);</span></span>
<span class="line"><span>        return NULL;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // å¦‚æœæˆåŠŸï¼Œåˆ™ç»§ç»­æ‰§è¡Œ...</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å¼•ç”¨ç®¡ç†</strong>:<br> å½“ä½ éœ€è¦åœ¨åŸç”Ÿæ¨¡å—ä¸­å­˜å‚¨ä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œå¹¶ç¡®ä¿å®ƒä¸ä¼šåœ¨åŸç”Ÿä»£ç è¿˜åœ¨ä½¿ç”¨å®ƒæ—¶è¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨å¼•ç”¨ç®¡ç†:</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>napi_ref my_ref;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void store_js_object(napi_env env, napi_value obj) {</span></span>
<span class="line"><span>    napi_create_reference(env, obj, 1, &amp;my_ref);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void use_stored_js_object(napi_env env) {</span></span>
<span class="line"><span>    napi_value obj;</span></span>
<span class="line"><span>    napi_get_reference_value(env, my_ref, &amp;obj);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // ä½¿ç”¨è¿™ä¸ªå¯¹è±¡...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void cleanup(napi_env env) {</span></span>
<span class="line"><span>    napi_delete_reference(env, my_ref);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šå°±æ˜¯ Node.js ä¸­ N-API <code>Miscellaneous utilities</code>çš„æ¦‚è§ˆå’Œä¸€äº›ç®€å•çš„åº”ç”¨ç¤ºä¾‹ã€‚è¿™äº›å·¥å…·ä¸ºåŸç”Ÿæ¨¡å—çš„å¼€å‘æä¾›äº†å¿…è¦çš„è¾…åŠ©åŠŸèƒ½ï¼Œä½¿å¾—ä¸ JavaScript äº¤äº’æ›´åŠ å®‰å…¨å’Œæœ‰æ•ˆç‡ã€‚</p><h3 id="node-api-get-module-file-name" tabindex="-1"><a class="header-anchor" href="#node-api-get-module-file-name"><span><a href="https://nodejs.org/docs/latest/api/n-api.html#node_api_get_module_file_name" target="_blank" rel="noopener noreferrer">node_api_get_module_file_name</a></span></a></h3><p>Node.js ä¸­çš„ <code>node_api_get_module_file_name</code> æ˜¯ N-API çš„ä¸€éƒ¨åˆ†ï¼ŒN-API æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºåŸç”Ÿæ’ä»¶çš„ APIã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœä½ æƒ³è¦åœ¨ Node.js ä¸­ä½¿ç”¨ C æˆ– C++ å†™ä¸€äº›ä»£ç æ¥æå‡æ€§èƒ½æˆ–è€…è®¿é—®æ“ä½œç³»ç»Ÿåº•å±‚åŠŸèƒ½ï¼Œé‚£ä¹ˆè¿™ä¸ª API å°±æ˜¯ä¸ºæ­¤è€Œè®¾è®¡çš„ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯-node-api-get-module-file-name" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯-node-api-get-module-file-name"><span>ä»€ä¹ˆæ˜¯ <code>node_api_get_module_file_name</code>?</span></a></h3><p><code>node_api_get_module_file_name</code> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¸®åŠ©ä½ è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„åŸç”Ÿæ¨¡å—çš„æ–‡ä»¶åã€‚åŸç”Ÿæ¨¡å—æ˜¯ç”¨ C æˆ– C++ ç¼–å†™çš„ï¼Œå¹¶ä¸”è¢«ç¼–è¯‘æˆ <code>.node</code> æ–‡ä»¶ï¼Œé€šè¿‡ Node.js åŠ è½½å’Œè¿è¡Œçš„ã€‚</p><h3 id="å¦‚ä½•ä½¿ç”¨å®ƒ" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ä½¿ç”¨å®ƒ"><span>å¦‚ä½•ä½¿ç”¨å®ƒï¼Ÿ</span></a></h3><p>è¿™ä¸ªå‡½æ•°éœ€è¦åœ¨ C æˆ– C++ çš„ä»£ç ä¸­ä½¿ç”¨ï¼Œé€šå¸¸åœ¨ä¸€ä¸ªç§°ä¸ºâ€œåˆå§‹åŒ–å‡½æ•°â€çš„åœ°æ–¹ã€‚åˆå§‹åŒ–å‡½æ•°æ˜¯å½“ Node.js åŠ è½½åŸç”Ÿæ¨¡å—æ—¶ä¼šè°ƒç”¨çš„ã€‚åœ¨åˆå§‹åŒ–å‡½æ•°å†…ï¼Œä½ å¯ä»¥è°ƒç”¨ <code>node_api_get_module_file_name</code> æ¥è·å–åŒ…å«è¯¥æ¨¡å—çš„å®Œæ•´è·¯å¾„ã€‚</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value Init(napi_env env, napi_value exports) {</span></span>
<span class="line"><span>  // è·å–æ¨¡å—æ–‡ä»¶å</span></span>
<span class="line"><span>  const char* module_file_name;</span></span>
<span class="line"><span>  napi_status status = node_api_get_module_file_name(env, &amp;module_file_name);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // ç°åœ¨ module_file_name åŒ…å«äº†æ¨¡å—çš„å®Œæ•´æ–‡ä»¶è·¯å¾„</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return exports;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>Init</code> å‡½æ•°å°±æ˜¯æˆ‘ä»¬æåˆ°çš„åˆå§‹åŒ–å‡½æ•°ã€‚å½“ Node.js åŠ è½½åŸç”Ÿæ¨¡å—æ—¶ï¼Œå®ƒä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚åœ¨è¿™ä¸ªå‡½æ•°é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>node_api_get_module_file_name</code> æ¥è·å–æ¨¡å—çš„æ–‡ä»¶åã€‚</p><h3 id="å®é™…åº”ç”¨ä¾‹å­-4" tabindex="-1"><a class="header-anchor" href="#å®é™…åº”ç”¨ä¾‹å­-4"><span>å®é™…åº”ç”¨ä¾‹å­</span></a></h3><p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå®é™…çš„åœºæ™¯ï¼Œå‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª Node.js åŸç”Ÿæ¨¡å—ï¼Œè¯¥æ¨¡å—éœ€è¦è¯»å–è‡ªèº«çš„æºç æˆ–è€…ç›¸å…³æ•°æ®æ–‡ä»¶ã€‚</p><p>ä¾‹å¦‚ï¼Œä½ å¯ä»¥æœ‰å¦‚ä¸‹çš„ C++ ä»£ç ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" data-title="cpp" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>#include `&lt;`fstream&gt;</span></span>
<span class="line"><span>#include `&lt;`string&gt;</span></span>
<span class="line"><span>##include `&lt;`node_api.h&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>napi_value ReadOwnSource(napi_env env, napi_callback_info args) {</span></span>
<span class="line"><span>  const char* module_file_name;</span></span>
<span class="line"><span>  napi_status status = node_api_get_module_file_name(env, &amp;module_file_name);</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // æ‰“å¼€æ¨¡å—æ–‡ä»¶è¿›è¡Œè¯»å–</span></span>
<span class="line"><span>  std::ifstream file(module_file_name);</span></span>
<span class="line"><span>  std::string file_contents((std::istreambuf_iterator`&lt;`char&gt;(file)),</span></span>
<span class="line"><span>                             std::istreambuf_iterator`&lt;`char&gt;());</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // è½¬æ¢ä¸º JavaScript å­—ç¬¦ä¸²è¿”å›ç»™ JS</span></span>
<span class="line"><span>  napi_value result;</span></span>
<span class="line"><span>  status = napi_create_string_utf8(</span></span>
<span class="line"><span>    env,</span></span>
<span class="line"><span>    file_contents.c_str(),</span></span>
<span class="line"><span>    file_contents.length(),</span></span>
<span class="line"><span>    &amp;result</span></span>
<span class="line"><span>  );</span></span>
<span class="line"><span>  if (status != napi_ok) {</span></span>
<span class="line"><span>    // å¤„ç†é”™è¯¯...</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return result;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// è¿˜éœ€è¦æ³¨å†Œå‡½æ•°ç­‰æ“ä½œ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šçš„ C++ ä»£ç å®šä¹‰äº†ä¸€ä¸ªå‡½æ•° <code>ReadOwnSource</code>ï¼Œè¿™ä¸ªå‡½æ•°ä½¿ç”¨ <code>node_api_get_module_file_name</code> æ¥è·å–å½“å‰æ¨¡å—çš„æ–‡ä»¶åï¼Œç„¶åæ‰“å¼€è¿™ä¸ªæ–‡ä»¶å¹¶è¯»å–å†…å®¹ï¼Œæœ€åæŠŠå†…å®¹ä½œä¸ºå­—ç¬¦ä¸²è¿”å›ç»™ Node.js ç«¯ã€‚</p><p>è¿™åªæ˜¯ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­ï¼Œå®é™…ä½¿ç”¨ä¸­ï¼Œä½ å¯èƒ½è¿˜éœ€è¦å¤„ç†å„ç§é”™è¯¯æƒ…å†µä»¥åŠå®‰å…¨é—®é¢˜ï¼Œä½†å®ƒå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>node_api_get_module_file_name</code> å‡½æ•°ä»¥åŠå®ƒçš„å®é™…ç”¨é€”ã€‚</p></div><!----><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="vp-meta-label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="vp-meta-info" title="email: kamiacgxu@gmail.com">kamishima-kaede</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/document/node-doc/Net.html" aria-label="Net"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->Net</div></a><a class="route-link auto-link next" href="/document/node-doc/OS.html" aria-label="OS"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">OS<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><!----><div class="vp-copyright">Copyright Â© 2018-present hanekawa-shiki</div></footer></div><!--]--><!--]--><!--[--><!----><!----><!--]--><!--]--></div>
    <script src="/assets/js/runtime~app.80796dd3.js" defer></script><script src="/assets/js/4485.e6fe7c7b.js" defer></script><script src="/assets/js/app.2fd0ad37.js" defer></script>
  </body>
</html>
